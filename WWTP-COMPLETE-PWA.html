<!DOCTYPE html>
<!-- saved from url=(0048)file:///C:/Users/jituf/Downloads/APEX_PWA_4.html -->
<html lang="en" class="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta content="width=device-width, initial-scale=1" name="viewport">
<title>WWTP Ultimate Integrated Edition</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="manifest" href="/wwtp-app/manifest.json">
<meta name="theme-color" content="#667eea">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="APEX WWTP">
<meta name="description" content="Professional wastewater treatment plant analysis platform with AI, ML, IoT, and advanced analytics">
<style>
:root{
--bg-body:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
--bg-container:#fff;
--bg-header:linear-gradient(135deg,#2c5aa0 0%,#1e3a5f 100%);
--bg-tabs:#f8f9fa;
--bg-tab-active:#fff;
--bg-section:#fff;
--bg-section-header:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);
--bg-table-th:#f8f9fa;
--bg-col-header:#e3f2fd;
--bg-row-header:#f8f9fa;
--bg-input:#fff;
--bg-result:#e3f2fd;
--bg-note:#e7f3ff;
--bg-card:#ffffff;
--text:#212529;
--text-header:#fff;
--text-accent:#2c5aa0;
--text-unit:#6c757d;
--text-section:#495057;
--border:#e9ecef;
--border-input:#dee2e6;
--border-focus:#2c5aa0;
--border-note:#2c5aa0;
--ok:#28a745;
--warn:#ffc107;
--bad:#dc3545;
--info:#17a2b8;
--purple:#9b59b6;
--indigo:#6610f2;
--pink:#e83e8c;
--teal:#20c997;
--cyan:#17a2b8;
--orange:#fd7e14;
--gradient-1:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
--gradient-2:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
--gradient-3:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);
--shadow-sm:0 2px 4px rgba(0,0,0,.05);
--shadow-md:0 4px 12px rgba(0,0,0,.08);
--shadow-lg:0 8px 24px rgba(0,0,0,.12);
--shadow-xl:0 20px 40px rgba(0,0,0,.15);
}
html.dark{
--bg-body:linear-gradient(135deg,#1F2937 0%,#111827 100%);
--bg-container:#1F2937;
--bg-header:linear-gradient(135deg,#374151 0%,#111827 100%);
--bg-tabs:#111827;
--bg-tab-active:#1F2937;
--bg-section:#374151;
--bg-section-header:linear-gradient(135deg,#1F2937 0%,#111827 100%);
--bg-table-th:#111827;
--bg-col-header:#1E40AF;
--bg-row-header:#1F2937;
--bg-input:#4B5563;
--bg-result:#1E3A8A;
--bg-note:#1E3A8A;
--bg-card:#2d3748;
--text:#E5E7EB;
--text-header:#F9FAFB;
--text-accent:#93C5FD;
--text-unit:#9CA3AF;
--text-section:#D1D5DB;
--border:#4B5563;
--border-input:#6B7280;
--border-focus:#60A5FA;
--border-note:#3B82F6;
--ok:#4ADE80;
--warn:#FBBF24;
--bad:#F87171;
--info:#22D3EE;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;min-height:100vh;background:var(--bg-body);color:var(--text);padding:10px;overflow-x:hidden}
.wrap{max-width:1920px;margin:0 auto;background:var(--bg-container);border-radius:18px;box-shadow:var(--shadow-xl);overflow:hidden;animation:fadeIn .5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.1)}}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideInUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes glow{0%,100%{box-shadow:0 0 5px var(--text-accent)}50%{box-shadow:0 0 20px var(--text-accent)}}
@keyframes typing{from{width:0}to{width:100%}}
@keyframes blink{50%{border-color:transparent}}
.header{background:var(--bg-header);color:var(--text-header);padding:24px 32px;position:relative}
.header h1{font-size:32px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.live-indicator{width:12px;height:12px;background:#4ADE80;border-radius:50%;animation:pulse 2s infinite;box-shadow:0 0 12px #4ADE80}
.badge{display:inline-block;padding:5px 14px;border-radius:6px;font-size:11px;font-weight:700;text-transform:uppercase;margin-left:8px;letter-spacing:.5px}
.badge.pro{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;box-shadow:0 4px 12px rgba(240,147,251,.4)}
.badge.new{background:#e83e8c;color:#fff}
.badge.beta{background:#17a2b8;color:#fff}
.badge.ai{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;animation:glow 2s infinite}
.muted{opacity:.9;font-size:0.95rem}
.header-controls{position:absolute;right:24px;top:24px;display:flex;gap:12px;flex-wrap:wrap}
.toggle{width:44px;height:44px;border-radius:999px;border:1px solid rgba(255,255,255,.25);display:grid;place-items:center;background:rgba(255,255,255,.09);color:#fff;cursor:pointer;transition:all .3s;font-size:18px}
.toggle:hover{background:rgba(255,255,255,.15);transform:rotate(180deg) scale(1.05)}
.toggle.active{background:var(--ok);animation:glow 2s infinite}
.status-bar{display:flex;gap:24px;margin-top:14px;flex-wrap:wrap}
.status-item{display:flex;align-items:center;gap:8px;font-size:13px;opacity:.9;padding:6px 12px;background:rgba(255,255,255,.1);border-radius:8px}
.status-item .dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-top:14px}
input,select,textarea{width:100%;padding:11px 14px;border-radius:10px;border:2px solid var(--border-input);background:var(--bg-input);color:var(--text);transition:all .3s;font-size:14px;font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 4px rgba(44,90,160,.12);transform:translateY(-2px)}
input:hover,select:hover{border-color:var(--text-accent)}
.input-group{margin:16px 0}
.input-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-section);font-size:14px}
.input-with-icon{position:relative}
.input-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--text-unit);pointer-events:none}
.tabs{display:flex;flex-wrap:wrap;gap:2px;background:var(--bg-tabs);border-bottom:2px solid var(--border);scrollbar-width:thin;position:sticky;top:0;z-index:100}
.tab{padding:16px 18px;border:0;background:transparent;color:var(--text-unit);cursor:pointer;white-space:nowrap;font-weight:600;transition:all .2s;font-size:14px;position:relative}
.tab:hover{background:var(--bg-note);transform:translateY(-2px)}
.tab[aria-selected="true"]{background:var(--bg-tab-active);color:var(--text-accent);border-bottom:4px solid var(--text-accent)}
.tab[aria-selected="true"]::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:20px;height:3px;background:var(--text-accent);border-radius:2px}
.content{padding:24px}
.panel{display:none}
.panel.active{display:block;animation:fadeIn .3s}
.section{background:var(--bg-section);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:24px;transition:all .3s}
.section:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}
.section-h{background:var(--bg-section-header);padding:16px 20px;font-weight:700;color:var(--text-section);display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none}
.section-h:hover{background:var(--bg-note)}
.section-content{padding:24px}
.section-actions{display:flex;gap:8px}
.icon-btn{background:rgba(44,90,160,.1);border:none;padding:8px 12px;cursor:pointer;color:var(--text-accent);transition:all .2s;border-radius:8px;font-weight:600;font-size:13px}
.icon-btn:hover{background:var(--text-accent);color:#fff;transform:scale(1.05)}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{padding:14px;border-bottom:1px solid var(--border);text-align:left}
.table th{background:var(--bg-table-th);position:sticky;top:0;z-index:10;font-weight:600;text-transform:uppercase;font-size:12px;letter-spacing:.5px}
.table tbody tr{transition:all .2s}
.table tbody tr:hover{background:var(--bg-section-header);transform:scale(1.01)}
.col{background:var(--bg-col-header);color:var(--text-accent);font-weight:700}
.rowh{background:var(--bg-row-header);min-width:150px;font-weight:600}
.result{font-weight:700;color:var(--text-accent);background:var(--bg-result);padding:8px 12px;border-radius:8px;font-variant-numeric:tabular-nums;display:inline-block}
.status{font-weight:700;padding:6px 12px;border-radius:8px;font-size:13px;display:inline-block}
.ok{color:var(--ok);background:rgba(40,167,69,.15)}
.warn{color:var(--warn);background:rgba(255,193,7,.15)}
.bad{color:var(--bad);background:rgba(220,53,69,.15)}
.info{color:var(--info);background:rgba(23,162,184,.15)}
.btns{display:flex;flex-wrap:wrap;gap:12px;margin:14px 0}
.btn{padding:13px 22px;border-radius:12px;border:0;cursor:pointer;color:#fff;background:var(--text-accent);font-weight:600;transition:all .2s;font-size:14px;box-shadow:var(--shadow-sm);position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,.3);transform:translate(-50%,-50%);transition:width .3s,height .3s}
.btn:hover::before{width:300px;height:300px}
.btn:hover{opacity:.95;transform:translateY(-3px);box-shadow:var(--shadow-md)}
.btn:active{transform:translateY(-1px)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.gray{background:#6c757d}
.btn.green{background:var(--ok)}
.btn.red{background:var(--bad)}
.btn.purple{background:var(--purple)}
.btn.orange{background:var(--orange)}
.btn.teal{background:var(--teal)}
.btn.pink{background:var(--pink)}
.btn.indigo{background:var(--indigo)}
.btn.gradient{background:var(--gradient-1)}
.note{background:var(--bg-note);border-left:5px solid var(--border-note);padding:16px;border-radius:0 12px 12px 0;color:var(--text);margin-top:12px;font-size:14px;line-height:1.7}
.note.success{background:rgba(40,167,69,.1);border-left-color:var(--ok)}
.note.warning{background:rgba(255,193,7,.1);border-left-color:var(--warn)}
.note.error{background:rgba(220,53,69,.1);border-left-color:var(--bad)}
.chart-container{position:relative;height:360px;width:100%;margin:24px 0;padding:20px;background:var(--bg-card);border-radius:14px;box-shadow:var(--shadow-sm)}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin:24px 0}
.kpi-card{background:var(--bg-card);padding:24px;border-radius:14px;text-align:center;border:2px solid var(--border);transition:all .3s;cursor:pointer;position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:5px;background:var(--gradient-1);transform:scaleX(0);transition:transform .3s;border-radius:14px 14px 0 0}
.kpi-card:hover{transform:translateY(-6px);box-shadow:var(--shadow-lg);border-color:var(--text-accent)}
.kpi-card:hover::before{transform:scaleX(1)}
.kpi-card h4{margin:0 0 12px 0;color:var(--text-section);font-size:13px;text-transform:uppercase;letter-spacing:1px;font-weight:700}
.kpi-card p{margin:0;font-size:2.2em;font-weight:800;color:var(--text-accent);font-variant-numeric:tabular-nums}
.kpi-card .trend{font-size:0.45em;margin-top:8px;font-weight:600}
.kpi-card .trend.up{color:var(--ok)}
.kpi-card .trend.down{color:var(--bad)}
.kpi-card .trend.stable{color:var(--text-unit)}
.small{font-size:12px;color:var(--text-unit);margin-top:4px}
.gauge-container{display:flex;justify-content:center;align-items:center;margin:24px 0}
.gauge{font-size:2.8em;font-weight:800;padding:35px;border-radius:50%;width:200px;height:200px;display:flex;align-items:center;justify-content:center;border:10px solid;text-align:center;line-height:1.2;position:relative}
.gauge::after{content:'';position:absolute;inset:15px;border-radius:50%;background:var(--bg-container);z-index:-1}
.gauge.good{color:var(--ok);border-color:var(--ok);background:radial-gradient(circle,rgba(40,167,69,.2),transparent)}
.gauge.caution{color:var(--warn);border-color:var(--warn);background:radial-gradient(circle,rgba(255,193,7,.2),transparent)}
.gauge.critical{color:var(--bad);border-color:var(--bad);background:radial-gradient(circle,rgba(220,53,69,.2),transparent)}
.score-badge{display:inline-block;padding:8px 16px;border-radius:10px;font-weight:700;font-size:15px;box-shadow:var(--shadow-sm)}
.score-excellent{background:rgba(40,167,69,.25);color:var(--ok)}
.score-good{background:rgba(44,90,160,.25);color:var(--text-accent)}
.score-fair{background:rgba(255,193,7,.25);color:var(--warn)}
.score-poor{background:rgba(220,53,69,.25);color:var(--bad)}
.alert-box{background:var(--bg-card);border:2px solid var(--border);border-radius:14px;padding:18px;margin:16px 0;display:flex;gap:16px;align-items:start;transition:all .3s}
.alert-box:hover{box-shadow:var(--shadow-md);transform:translateX(4px)}
.alert-box.alert-critical{border-left:6px solid var(--bad);background:rgba(220,53,69,.05)}
.alert-box.alert-warning{border-left:6px solid var(--warn);background:rgba(255,193,7,.05)}
.alert-box.alert-info{border-left:6px solid var(--info);background:rgba(23,162,184,.05)}
.alert-icon{font-size:28px;flex-shrink:0}
.alert-content{flex:1}
.alert-title{font-weight:700;margin-bottom:6px;font-size:15px}
.alert-message{font-size:14px;color:var(--text-unit);line-height:1.6}
.alert-time{font-size:12px;color:var(--text-unit);margin-top:8px}
.toast{position:fixed;top:24px;right:24px;background:var(--bg-container);border:2px solid var(--border);border-radius:14px;padding:18px 26px;box-shadow:var(--shadow-xl);z-index:9999;animation:slideInRight .3s;max-width:450px;min-width:320px}
.toast.success{border-left:6px solid var(--ok)}
.toast.error{border-left:6px solid var(--bad)}
.toast.warning{border-left:6px solid var(--warn)}
.toast.info{border-left:6px solid var(--info)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:10000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal.active{display:flex}
.modal-content{background:var(--bg-container);border-radius:18px;padding:32px;max-width:800px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-xl);animation:slideInUp .3s}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid var(--border)}
.modal-header h2{color:var(--text-accent);margin:0;font-size:24px;font-weight:700}
.modal-close{background:rgba(220,53,69,.1);border:none;font-size:28px;cursor:pointer;color:var(--bad);padding:4px;width:36px;height:36px;display:grid;place-items:center;border-radius:50%;transition:all .2s}
.modal-close:hover{background:var(--bad);color:#fff;transform:rotate(90deg)}
.tool-card{background:var(--bg-card);padding:28px;border-radius:14px;border:2px solid var(--border);margin-bottom:24px;transition:all .3s;position:relative;overflow:hidden}
.tool-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:var(--gradient-1)}
.tool-card:hover{border-color:var(--text-accent);box-shadow:var(--shadow-lg);transform:translateY(-4px)}
.tool-card h3{margin:0 0 18px 0;color:var(--text-accent);font-size:20px;font-weight:700}
.tool-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;margin:18px 0}
.scenario-card{padding:24px;border:2px solid var(--border);border-radius:14px;background:var(--bg-card);cursor:pointer;transition:all .3s;text-align:center;position:relative;overflow:hidden}
.scenario-card::before{content:'';position:absolute;inset:0;background:var(--gradient-1);opacity:0;transition:opacity .3s}
.scenario-card:hover{border-color:var(--text-accent);transform:translateY(-6px);box-shadow:var(--shadow-lg)}
.scenario-card:hover::before{opacity:.05}
.scenario-card .icon{font-size:48px;margin-bottom:12px;position:relative;z-index:1}
.scenario-card strong{display:block;margin:12px 0 8px;color:var(--text);font-size:18px;position:relative;z-index:1}
.scenario-card p{margin:0;color:var(--text-unit);font-size:14px;position:relative;z-index:1}
.metric-card{background:var(--bg-card);padding:20px;border-radius:12px;border:1px solid var(--border);transition:all .3s}
.metric-card:hover{box-shadow:var(--shadow-md);border-color:var(--text-accent)}
.metric-card h5{margin:0 0 8px 0;color:var(--text-section);font-size:13px;text-transform:uppercase;font-weight:600}
.metric-card .value{font-size:28px;font-weight:700;color:var(--text-accent);margin:8px 0}
.metric-card .change{font-size:13px;font-weight:600}
.metric-card .change.positive{color:var(--ok)}
.metric-card .change.negative{color:var(--bad)}
.progress-bar{width:100%;height:12px;background:var(--border);border-radius:999px;overflow:hidden;margin:12px 0}
.progress-fill{height:100%;background:var(--gradient-1);border-radius:999px;transition:width .3s;position:relative}
.progress-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 2s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:20px 0}
.stat-item{text-align:center;padding:20px;background:var(--bg-card);border-radius:12px;border:2px solid var(--border)}
.stat-label{font-size:13px;color:var(--text-unit);text-transform:uppercase;font-weight:600;margin-bottom:8px}
.stat-value{font-size:32px;font-weight:800;color:var(--text-accent);margin:8px 0}
.stat-unit{font-size:14px;color:var(--text-unit)}
.timeline{position:relative;padding:20px 0}
.timeline-item{display:flex;gap:16px;margin-bottom:24px;position:relative}
.timeline-item::before{content:'';position:absolute;left:19px;top:40px;bottom:-24px;width:2px;background:var(--border)}
.timeline-item:last-child::before{display:none}
.timeline-icon{width:40px;height:40px;border-radius:50%;background:var(--text-accent);color:#fff;display:grid;place-items:center;font-weight:700;flex-shrink:0;box-shadow:var(--shadow-sm)}
.timeline-content{flex:1;padding:12px 16px;background:var(--bg-card);border-radius:12px;border:1px solid var(--border)}
.timeline-title{font-weight:700;margin-bottom:6px}
.timeline-time{font-size:12px;color:var(--text-unit)}
.accordion-item{border:1px solid var(--border);border-radius:12px;margin-bottom:12px;overflow:hidden}
.accordion-header{padding:16px 20px;background:var(--bg-section-header);cursor:pointer;font-weight:600;display:flex;justify-content:space-between;align-items:center;transition:all .2s}
.accordion-header:hover{background:var(--bg-note)}
.accordion-header::after{content:'â–¼';transition:transform .3s}
.accordion-header.active::after{transform:rotate(180deg)}
.accordion-content{max-height:0;overflow:hidden;transition:max-height .3s}
.accordion-content.active{max-height:1000px;padding:20px}
.split-view{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}
.loading-spinner{border:4px solid var(--border);border-top:4px solid var(--text-accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-unit)}
.empty-state-icon{font-size:64px;margin-bottom:16px;opacity:.5}
.empty-state-title{font-size:20px;font-weight:600;margin-bottom:8px;color:var(--text)}
.empty-state-message{font-size:14px;margin-bottom:24px}
.tag{display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase;margin:2px}
.tag.success{background:rgba(40,167,69,.2);color:var(--ok)}
.tag.warning{background:rgba(255,193,7,.2);color:var(--warn)}
.tag.danger{background:rgba(220,53,69,.2);color:var(--bad)}
.tag.info{background:rgba(23,162,184,.2);color:var(--info)}

/* AI-Specific Styles */
.ai-chat-container{background:var(--bg-card);border-radius:14px;border:2px solid var(--border);padding:24px;min-height:500px;display:flex;flex-direction:column;gap:16px}
.ai-messages{flex:1;overflow-y:auto;max-height:600px;padding:16px;background:var(--bg-section);border-radius:12px;display:flex;flex-direction:column;gap:12px}
.ai-message{padding:14px 18px;border-radius:12px;max-width:80%;animation:slideInUp .3s;line-height:1.6}
.ai-message.user{background:var(--text-accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.ai-message.assistant{background:var(--bg-note);color:var(--text);align-self:flex-start;border-bottom-left-radius:4px;border-left:4px solid var(--text-accent)}
.ai-message.assistant::before{content:'ðŸ¤–';margin-right:8px;font-size:1.2em}
.ai-input-area{display:flex;gap:12px;align-items:center}
.ai-input{flex:1}
.ai-thinking{display:none;align-items:center;gap:8px;color:var(--text-accent);font-style:italic;padding:10px;background:var(--bg-note);border-radius:8px;margin:8px 0}
.ai-thinking.active{display:flex}
.ai-thinking::before{content:'';width:20px;height:20px;border:3px solid var(--text-accent);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
.diagnostic-card{background:var(--bg-card);border:2px solid var(--border);border-radius:14px;padding:24px;margin:16px 0;transition:all .3s}
.diagnostic-card:hover{border-color:var(--text-accent);box-shadow:var(--shadow-lg)}
.diagnostic-card .severity{display:inline-block;padding:6px 14px;border-radius:8px;font-weight:700;font-size:12px;text-transform:uppercase;margin-bottom:12px}
.diagnostic-card .severity.high{background:rgba(220,53,69,.2);color:var(--bad)}
.diagnostic-card .severity.medium{background:rgba(255,193,7,.2);color:var(--warn)}
.diagnostic-card .severity.low{background:rgba(23,162,184,.2);color:var(--info)}
.solution-step{background:var(--bg-section);border-left:4px solid var(--text-accent);padding:16px;border-radius:0 12px 12px 0;margin:12px 0}
.solution-step h5{margin:0 0 8px 0;color:var(--text-accent);font-size:15px}
.solution-step p{margin:0;line-height:1.6;color:var(--text-unit)}
.knowledge-item{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:18px;margin:12px 0;cursor:pointer;transition:all .3s}
.knowledge-item:hover{border-color:var(--text-accent);transform:translateX(4px);box-shadow:var(--shadow-md)}
.knowledge-item h4{margin:0 0 8px 0;color:var(--text-accent);font-size:16px}
.knowledge-item p{margin:0;color:var(--text-unit);font-size:14px;line-height:1.6}
.confidence-bar{width:100%;height:8px;background:var(--border);border-radius:999px;overflow:hidden;margin:8px 0}
.confidence-fill{height:100%;background:var(--gradient-1);border-radius:999px;transition:width .5s}
.symptom-checker{background:var(--bg-section);border-radius:12px;padding:20px;margin:16px 0}
.symptom-option{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border:2px solid var(--border);border-radius:10px;margin:8px 0;cursor:pointer;transition:all .2s}
.symptom-option:hover{border-color:var(--text-accent);transform:translateX(4px)}
.symptom-option input[type="checkbox"]{width:20px;height:20px;cursor:pointer}
.issue-history-item{background:var(--bg-card);border-left:4px solid var(--info);padding:16px;border-radius:0 12px 12px 0;margin:12px 0;transition:all .3s}
.issue-history-item:hover{box-shadow:var(--shadow-md);transform:translateX(4px)}
.issue-history-item.resolved{border-left-color:var(--ok);opacity:.7}
.issue-history-item .issue-date{font-size:12px;color:var(--text-unit);margin-bottom:6px}
.issue-history-item .issue-title{font-weight:700;margin-bottom:6px;color:var(--text-accent)}
.issue-history-item .issue-desc{font-size:14px;color:var(--text-unit);line-height:1.6}

@media(max-width:1024px){
.split-view{grid-template-columns:1fr}
.tool-grid,.card-grid{grid-template-columns:1fr}
}
@media(max-width:768px){
.content{padding:16px}
.table{font-size:12px}
.table th,.table td{padding:10px}
.header h1{font-size:24px}
.header-controls{position:relative;right:auto;top:auto;margin-top:12px}
.kpi-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.modal-content{padding:20px}
.ai-message{max-width:95%}
}
</style>
<style>
:root{--bg-body:linear-gradient(135deg,#667eea 0%,#764ba2 100%);--bg-container:#fff;--bg-header:linear-gradient(135deg,#2c5aa0 0%,#1e3a5f 100%);--bg-tabs:#f8f9fa;--bg-tab-active:#fff;--bg-section:#fff;--bg-section-header:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);--bg-table-th:#f8f9fa;--bg-col-header:#e3f2fd;--bg-row-header:#f8f9fa;--bg-input:#fff;--bg-result:#e3f2fd;--bg-note:#e7f3ff;--text:#212529;--text-header:#fff;--text-accent:#2c5aa0;--text-unit:#6c757d;--text-section:#495057;--border:#e9ecef;--border-input:#dee2e6;--border-focus:#2c5aa0;--border-note:#2c5aa0;--ok:#28a745;--warn:#ffc107;--bad:#dc3545;--info:#17a2b8;--purple:#9b59b6;--indigo:#6610f2;--pink:#e83e8c;--teal:#20c997;--cyan:#17a2b8;--orange:#fd7e14}
html.dark{--bg-body:linear-gradient(135deg,#1F2937 0%,#111827 100%);--bg-container:#1F2937;--bg-header:linear-gradient(135deg,#374151 0%,#111827 100%);--bg-tabs:#111827;--bg-tab-active:#1F2937;--bg-section:#374151;--bg-section-header:linear-gradient(135deg,#1F2937 0%,#111827 100%);--bg-table-th:#111827;--bg-col-header:#1E40AF;--bg-row-header:#1F2937;--bg-input:#4B5563;--bg-result:#1E3A8A;--bg-note:#1E3A8A;--text:#E5E7EB;--text-header:#F9FAFB;--text-accent:#93C5FD;--text-unit:#9CA3AF;--text-section:#D1D5DB;--border:#4B5563;--border-input:#6B7280;--border-focus:#60A5FA;--border-note:#3B82F6;--ok:#4ADE80;--warn:#FBBF24;--bad:#F87171;--info:#22D3EE}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;min-height:100vh;background:var(--bg-body);color:var(--text);padding:10px;overflow-x:hidden}
.wrap{max-width:1900px;margin:0 auto;background:var(--bg-container);border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.15);overflow:hidden;animation:fadeIn .5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.1)}}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.header{background:var(--bg-header);color:var(--text-header);padding:20px 28px;position:relative}
.header h1{font-size:30px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.live-indicator{width:12px;height:12px;background:#4ADE80;border-radius:50%;animation:pulse 2s infinite;box-shadow:0 0 12px #4ADE80}
.badge{display:inline-block;padding:4px 12px;border-radius:5px;font-size:11px;font-weight:600;text-transform:uppercase;margin-left:8px}
.badge.enterprise{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;box-shadow:0 2px 8px rgba(102,126,234,.3)}
.badge.new{background:#e83e8c;color:#fff}
.muted{opacity:.9;font-size:0.95rem}
.header-controls{position:absolute;right:20px;top:20px;display:flex;gap:10px;flex-wrap:wrap}
.toggle{width:42px;height:42px;border-radius:999px;border:1px solid rgba(255,255,255,.25);display:grid;place-items:center;background:rgba(255,255,255,.09);color:#fff;cursor:pointer;transition:all .3s;font-size:18px}
.toggle:hover{background:rgba(255,255,255,.15);transform:rotate(180deg) scale(1.05)}
.status-bar{display:flex;gap:20px;margin-top:12px;flex-wrap:wrap}
.status-item{display:flex;align-items:center;gap:8px;font-size:13px;opacity:.9}
.status-item .dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
input,select,textarea{width:100%;padding:10px 12px;border-radius:8px;border:2px solid var(--border-input);background:var(--bg-input);color:var(--text);transition:all .3s;font-size:14px;font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 3px rgba(44,90,160,.15);transform:translateY(-2px)}
input:hover,select:hover{border-color:var(--text-accent)}
.input-group{margin:15px 0}
.input-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-section);font-size:14px}
.tabs{display:flex;flex-wrap:wrap;gap:2px;background:var(--bg-tabs);border-bottom:2px solid var(--border);scrollbar-width:thin}
.tab{padding:14px 16px;border:0;background:transparent;color:var(--text-unit);cursor:pointer;white-space:nowrap;font-weight:500;transition:all .2s;font-size:14px}
.tab:hover{background:var(--bg-note)}
.tab[aria-selected="true"]{background:var(--bg-tab-active);color:var(--text-accent);border-bottom:3px solid var(--text-accent)}
.content{padding:20px}
.panel{display:none}
.panel.active{display:block;animation:fadeIn .3s}
.section{background:var(--bg-section);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-bottom:20px;transition:all .3s}
.section:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}
.section-h{background:var(--bg-section-header);padding:14px 18px;font-weight:700;color:var(--text-section);display:flex;justify-content:space-between;align-items:center}
.section-content{padding:20px}
.table{width:100%;border-collapse:collapse;font-size:14px}
.table th,.table td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
.table th{background:var(--bg-table-th);position:sticky;top:0;z-index:10;font-weight:600}
.col{background:var(--bg-col-header);color:var(--text-accent);font-weight:700}
.rowh{background:var(--bg-row-header);min-width:150px;font-weight:600}
.result{font-weight:700;color:var(--text-accent);background:var(--bg-result);padding:6px 10px;border-radius:6px;font-variant-numeric:tabular-nums}
.status{font-weight:700;padding:4px 8px;border-radius:4px;font-size:13px}
.ok{color:var(--ok);background:rgba(40,167,69,.1)}
.warn{color:var(--warn);background:rgba(255,193,7,.1)}
.bad{color:var(--bad);background:rgba(220,53,69,.1)}
.btns{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0}
.btn{padding:12px 18px;border-radius:10px;border:0;cursor:pointer;color:#fff;background:var(--text-accent);font-weight:500;transition:all .2s;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.btn:hover{opacity:.9;transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
.btn:active{transform:translateY(0)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.gray{background:#6c757d}
.btn.green{background:var(--ok)}
.btn.red{background:var(--bad)}
.btn.purple{background:var(--purple)}
.btn.orange{background:var(--orange)}
.btn.teal{background:var(--teal)}
.btn.pink{background:var(--pink)}
.btn.indigo{background:var(--indigo)}
.note{background:var(--bg-note);border-left:4px solid var(--border-note);padding:14px;border-radius:0 10px 10px 0;color:var(--text);margin-top:10px;font-size:14px;line-height:1.6}
.chart-container{position:relative;height:340px;width:100%;margin:20px 0}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin:20px 0}
.kpi-card{background:var(--bg-section);padding:20px;border-radius:12px;text-align:center;border:2px solid var(--border);transition:all .3s;cursor:pointer;overflow:hidden}
.kpi-card:hover{transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,.12);border-color:var(--text-accent)}
.kpi-card h4{margin:0 0 10px 0;color:var(--text-section);font-size:13px;text-transform:uppercase;letter-spacing:.5px}
.kpi-card p{margin:0;font-size:2em;font-weight:bold;color:var(--text-accent);font-variant-numeric:tabular-nums}
.kpi-card .trend{font-size:0.5em;color:var(--ok);margin-top:5px}
.kpi-card .trend.down{color:var(--bad)}
.small{font-size:12px;color:var(--text-unit)}
.gauge{font-size:2.5em;font-weight:bold;padding:30px;border-radius:50%;width:180px;height:180px;display:flex;align-items:center;justify-content:center;border:8px solid;text-align:center;line-height:1.2;margin:20px auto}
.gauge.good{color:var(--ok);border-color:var(--ok);background:rgba(40,167,69,.1)}
.gauge.caution{color:var(--warn);border-color:var(--warn);background:rgba(255,193,7,.1)}
.gauge.critical{color:var(--bad);border-color:var(--bad);background:rgba(220,53,69,.1)}
.score-badge{display:inline-block;padding:6px 12px;border-radius:8px;font-weight:700;font-size:14px}
.score-excellent{background:rgba(40,167,69,.2);color:var(--ok)}
.score-good{background:rgba(44,90,160,.2);color:var(--text-accent)}
.score-fair{background:rgba(255,193,7,.2);color:var(--warn)}
.score-poor{background:rgba(220,53,69,.2);color:var(--bad)}
.toast{position:fixed;top:20px;right:20px;background:var(--bg-container);border:2px solid var(--border);border-radius:12px;padding:16px 22px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:9999;animation:slideInRight .3s;max-width:420px}
.toast.success{border-color:var(--ok)}
.toast.error{border-color:var(--bad)}
.modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:10000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:var(--bg-container);border-radius:16px;padding:30px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.modal-header h2{color:var(--text-accent);margin:0}
.modal-close{background:none;border:none;font-size:28px;cursor:pointer;color:var(--text);padding:0;width:32px;height:32px;display:grid;place-items:center;border-radius:50%;transition:all .2s}
.modal-close:hover{background:var(--border)}
.tool-card{background:var(--bg-section);padding:24px;border-radius:12px;border:2px solid var(--border);margin-bottom:20px;transition:all .3s}
.tool-card:hover{border-color:var(--text-accent);box-shadow:0 6px 16px rgba(0,0,0,.1)}
.tool-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin:15px 0}
.scenario-card{padding:20px;border:2px solid var(--border);border-radius:12px;background:var(--bg-section);cursor:pointer;transition:all .3s;text-align:center}
.scenario-card:hover{border-color:var(--text-accent);transform:translateY(-4px);box-shadow:0 8px 16px rgba(0,0,0,.1)}
.scenario-card strong{display:block;margin:8px 0 4px;color:var(--text);font-size:16px}
.scenario-card p{margin:0;color:var(--text-unit)}
/* AI Chat styles */
#ai-chat-container{height:400px;overflow-y:auto;background:var(--bg-tabs);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:15px;display:flex;flex-direction:column;gap:15px}
.ai-message{max-width:85%;padding:12px 18px;border-radius:18px;line-height:1.5;word-wrap:break-word;position:relative}
.ai-message.bot{background:var(--bg-note);border-bottom-left-radius:4px;align-self:flex-start}
.ai-message.user{background:var(--bg-col-header);color:var(--text-accent);border-bottom-right-radius:4px;align-self:flex-end}
.ai-message.loading{background:var(--bg-section);color:var(--text-unit);font-style:italic;align-self:flex-start;border-bottom-left-radius:4px;animation:pulse 1.5s infinite}
.ai-message p{margin-bottom:10px}
.ai-message ul{padding-left:20px;margin-bottom:10px}
.ai-message .citations{font-size:0.8em;border-top:1px solid var(--border);padding-top:8px;margin-top:10px}
.ai-message .citations p{margin-bottom:5px;font-weight:bold}
.ai-message .citations a{color:var(--text-accent);text-decoration:none}
.ai-message .citations a:hover{text-decoration:underline}
.ai-tts-btn{background:var(--text-accent);color:white;border:none;border-radius:50%;width:28px;height:28px;cursor:pointer;position:absolute;top:10px;right:10px;font-size:14px;display:grid;place-items:center;transition:all .2s}
.ai-tts-btn:hover{opacity:0.8}
.ai-tts-btn:disabled{background:var(--text-unit);cursor:not-allowed}
#ai-input-area{display:flex;gap:10px;align-items:center}
#ai-prompt-input{flex-grow:1}
#ai-image-upload-label{flex-shrink:0;padding:12px;border-radius:10px;border:0;cursor:pointer;color:#fff;background:var(--purple);font-weight:500;transition:all .2s;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
#ai-image-upload-label:hover{opacity:.9;transform:translateY(-2px)}
#ai-image-upload{display:none}
#ai-image-preview{max-width:100px;max-height:50px;margin-left:10px;border-radius:8px;border:1px solid var(--border);object-fit:cover;display:none}
#ai-send-btn:disabled{background:var(--text-unit);cursor:not-allowed}
@media(max-width:768px){
.content{padding:12px}
.table{font-size:12px}
.table th,.table td{padding:8px}
.header h1{font-size:24px}
.header-controls{position:relative;right:auto;top:auto;margin-top:10px}
.tool-grid{grid-template-columns:1fr}
}

/* Process Calculations Organization */
.calc-category{background:var(--bg-section);border-radius:12px;padding:20px;margin-bottom:20px;border:2px solid var(--border);animation:slideInUp .5s ease}
.calc-category-header{font-size:20px;font-weight:700;color:var(--text-accent);margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid var(--border);display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .3s}
.calc-category-header:hover{color:var(--purple);transform:translateX(5px)}
.calc-category-header::after{content:'â–¼';font-size:14px;margin-left:auto;transition:transform .3s}
.calc-category.collapsed .calc-category-header::after{transform:rotate(-90deg)}
.calc-category.collapsed .calc-grid{display:none}
.calc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:20px;margin-top:15px}
.calc-item{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:15px;box-shadow:var(--shadow-sm);transition:all .3s;position:relative;overflow:hidden}
.calc-item::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:2px;background:linear-gradient(90deg,transparent,var(--text-accent),transparent);transition:left .5s}
.calc-item:hover::before{left:100%}
.calc-item:hover{box-shadow:var(--shadow-lg);transform:translateY(-3px);border-color:var(--text-accent)}
.calc-item-title{font-size:16px;font-weight:600;color:var(--text-accent);margin-bottom:12px;display:flex;align-items:center;gap:8px}
/* Enhanced Status Indicators */
.status-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600;animation:fadeIn .3s}
.status-badge.excellent{background:linear-gradient(135deg,#10b981,#059669);color:white;box-shadow:0 2px 8px rgba(16,185,129,.3)}
.status-badge.good{background:var(--ok);color:white;box-shadow:0 2px 8px rgba(40,167,69,.3)}
.status-badge.warning{background:var(--warn);color:white;box-shadow:0 2px 8px rgba(255,193,7,.3)}
.status-badge.critical{background:var(--bad);color:white;box-shadow:0 2px 8px rgba(220,53,69,.3);animation:pulse 2s infinite}
/* Quick Action Toolbar */
.quick-actions{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;padding:15px;background:var(--bg-section);border-radius:10px;border:1px solid var(--border)}
.quick-action-btn{padding:10px 18px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:8px;box-shadow:var(--shadow-sm)}
.quick-action-btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.quick-action-btn.primary{background:linear-gradient(135deg,#667eea,#764ba2);color:white}
.quick-action-btn.success{background:var(--ok);color:white}
.quick-action-btn.info{background:var(--info);color:white}
.quick-action-btn.export{background:var(--orange);color:white}
/* Summary Cards */
.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:25px}
.summary-card{background:linear-gradient(135deg,var(--bg-card),var(--bg-section));border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:var(--shadow-md);transition:all .3s}
.summary-card:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg)}
.summary-card-icon{font-size:32px;margin-bottom:10px}
.summary-card-value{font-size:28px;font-weight:700;color:var(--text-accent);margin-bottom:5px}
.summary-card-label{font-size:12px;color:var(--text-unit);text-transform:uppercase;letter-spacing:.5px}
/* Progress Bars */
.progress-bar-container{background:var(--bg-tabs);border-radius:10px;height:20px;overflow:hidden;margin:10px 0;position:relative}
.progress-bar{height:100%;border-radius:10px;transition:width .5s ease;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:white}
.progress-bar.excellent{background:linear-gradient(90deg,#10b981,#059669)}
.progress-bar.good{background:linear-gradient(90deg,#22c55e,#16a34a)}
.progress-bar.warning{background:linear-gradient(90deg,#fbbf24,#f59e0b)}
.progress-bar.critical{background:linear-gradient(90deg,#ef4444,#dc2626)}
/* Tooltips */
.tooltip-icon{display:inline-block;width:18px;height:18px;background:var(--info);color:white;border-radius:50%;text-align:center;line-height:18px;font-size:12px;cursor:help;margin-left:5px}
.tooltip-icon:hover::after{content:attr(data-tooltip);position:absolute;background:var(--text);color:var(--bg-container);padding:8px 12px;border-radius:6px;font-size:12px;white-space:nowrap;z-index:1000;margin-left:10px;box-shadow:var(--shadow-lg)}
/* Enhanced Tables */
.enhanced-table{width:100%;border-collapse:collapse;margin:15px 0}
.enhanced-table th{background:linear-gradient(135deg,var(--bg-col-header),var(--text-accent));color:white;padding:12px;text-align:left;font-weight:600}
.enhanced-table td{padding:10px 12px;border-bottom:1px solid var(--border)}
.enhanced-table tr:hover{background:var(--bg-tabs)}
/* Collapsible Sections */
.collapsible-header{cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-section);border-radius:8px;margin:10px 0;transition:all .3s}
.collapsible-header:hover{background:var(--bg-tabs)}
.collapsible-content{max-height:0;overflow:hidden;transition:max-height .5s ease}
.collapsible-content.active{max-height:5000px}
/* Print Styles */
@media print{
.header-controls,.tabs,.quick-actions,.btn{display:none}
.calc-item{page-break-inside:avoid;border:1px solid #000}
.calc-category{page-break-inside:avoid}
body{background:white;color:black}
}
/* Enhanced Mobile Responsiveness */
@media(max-width:768px){
.calc-grid{grid-template-columns:1fr}
.summary-cards{grid-template-columns:repeat(2,1fr)}
.quick-actions{flex-direction:column}
.quick-action-btn{width:100%}
}
/* ULTRA EDITION ENHANCEMENTS */
/* Advanced Data Visualization */
.chart-container{background:var(--bg-card);border-radius:12px;padding:20px;margin:20px 0;box-shadow:var(--shadow-md);position:relative}
.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.chart-title{font-size:18px;font-weight:600;color:var(--text-accent)}
.chart-controls{display:flex;gap:10px}
.chart-btn{padding:6px 12px;border:1px solid var(--border);background:var(--bg-section);border-radius:6px;cursor:pointer;font-size:12px;transition:all .3s}
.chart-btn:hover{background:var(--text-accent);color:white}
.chart-btn.active{background:var(--text-accent);color:white}
/* Comparison Mode */
.comparison-panel{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0}
.comparison-side{background:var(--bg-card);border-radius:12px;padding:20px;border:2px solid var(--border)}
.comparison-side.active{border-color:var(--text-accent);box-shadow:0 0 20px rgba(102,126,234,0.3)}
.comparison-header{font-size:16px;font-weight:600;margin-bottom:15px;display:flex;align-items:center;gap:10px}
.comparison-results{margin-top:15px}
.comparison-diff{display:inline-block;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600;margin-left:8px}
.comparison-diff.positive{background:var(--ok);color:white}
.comparison-diff.negative{background:var(--bad);color:white}
.comparison-diff.neutral{background:var(--info);color:white}
/* Template Management */
.template-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;margin:20px 0}
.template-card{background:var(--bg-card);border:2px solid var(--border);border-radius:10px;padding:15px;cursor:pointer;transition:all .3s;position:relative}
.template-card:hover{border-color:var(--text-accent);transform:translateY(-3px);box-shadow:var(--shadow-lg)}
.template-card.selected{border-color:var(--ok);background:linear-gradient(135deg,rgba(40,167,69,0.1),transparent)}
.template-name{font-size:16px;font-weight:600;margin-bottom:8px;color:var(--text-accent)}
.template-info{font-size:12px;color:var(--text-unit);margin-bottom:5px}
.template-actions{display:flex;gap:8px;margin-top:12px}
.template-btn{flex:1;padding:6px;border:none;border-radius:6px;font-size:12px;cursor:pointer;transition:all .3s}
.template-btn.load{background:var(--ok);color:white}
.template-btn.delete{background:var(--bad);color:white}
.template-btn:hover{opacity:0.8}
/* Batch Processing */
.batch-upload-zone{border:3px dashed var(--border);border-radius:12px;padding:40px;text-align:center;background:var(--bg-tabs);margin:20px 0;cursor:pointer;transition:all .3s}
.batch-upload-zone:hover{border-color:var(--text-accent);background:var(--bg-section)}
.batch-upload-zone.dragover{border-color:var(--ok);background:linear-gradient(135deg,rgba(40,167,69,0.1),transparent)}
.batch-icon{font-size:48px;margin-bottom:15px}
.batch-text{font-size:16px;color:var(--text);margin-bottom:8px}
.batch-subtext{font-size:12px;color:var(--text-unit)}
.batch-results{background:var(--bg-card);border-radius:12px;padding:20px;margin:20px 0}
.batch-progress{margin:20px 0}
.batch-progress-bar{background:var(--bg-tabs);height:30px;border-radius:15px;overflow:hidden;position:relative}
.batch-progress-fill{height:100%;background:linear-gradient(90deg,var(--text-accent),var(--purple));transition:width .5s;display:flex;align-items:center;justify-content:center;color:white;font-weight:600}
/* Advanced Search */
.search-panel{background:var(--bg-section);border-radius:12px;padding:20px;margin:20px 0}
.search-input{width:100%;padding:12px 20px 12px 45px;border:2px solid var(--border);border-radius:10px;font-size:16px;background:var(--bg-input);color:var(--text);transition:all .3s}
.search-input:focus{border-color:var(--text-accent);outline:none;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}
.search-filters{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
.search-filter-btn{padding:8px 16px;border:1px solid var(--border);background:var(--bg-card);border-radius:20px;cursor:pointer;font-size:13px;transition:all .3s}
.search-filter-btn:hover{border-color:var(--text-accent)}
.search-filter-btn.active{background:var(--text-accent);color:white;border-color:var(--text-accent)}
.search-results{margin-top:20px}
.search-result-item{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:15px;margin-bottom:10px;cursor:pointer;transition:all .3s}
.search-result-item:hover{border-color:var(--text-accent);transform:translateX(5px)}
.search-highlight{background:yellow;color:black;padding:2px 4px;border-radius:3px}
/* Benchmarking Dashboard */
.benchmark-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:20px 0}
.benchmark-card{background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:var(--shadow-md);position:relative;overflow:hidden}
.benchmark-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,var(--ok),var(--text-accent))}
.benchmark-metric{font-size:14px;color:var(--text-unit);margin-bottom:8px}
.benchmark-value{font-size:32px;font-weight:700;color:var(--text-accent);margin-bottom:8px}
.benchmark-comparison{display:flex;align-items:center;gap:10px;margin-top:12px}
.benchmark-bar{flex:1;height:8px;background:var(--bg-tabs);border-radius:4px;overflow:hidden}
.benchmark-bar-fill{height:100%;background:linear-gradient(90deg,var(--text-accent),var(--purple));transition:width .5s}
.benchmark-label{font-size:12px;color:var(--text-unit)}
/* Keyboard Shortcuts Panel */
.shortcuts-panel{background:var(--bg-card);border-radius:12px;padding:20px;margin:20px 0;border:1px solid var(--border)}
.shortcut-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border)}
.shortcut-row:last-child{border-bottom:none}
.shortcut-keys{display:flex;gap:5px}
.shortcut-key{background:var(--bg-section);border:1px solid var(--border);border-radius:4px;padding:4px 8px;font-family:monospace;font-size:12px;min-width:30px;text-align:center}
.shortcut-desc{color:var(--text-unit);font-size:14px}
/* Modal System */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:none;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.modal-overlay.active{display:flex;animation:fadeIn .3s}
.modal-content{background:var(--bg-container);border-radius:16px;padding:30px;max-width:90%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-xl);animation:slideInUp .4s}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid var(--border)}
.modal-title{font-size:24px;font-weight:700;color:var(--text-accent)}
.modal-close{background:var(--bad);color:white;border:none;border-radius:50%;width:32px;height:32px;cursor:pointer;font-size:20px;transition:all .3s}
.modal-close:hover{transform:rotate(90deg);opacity:0.8}
.modal-body{margin-bottom:20px}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;padding-top:15px;border-top:1px solid var(--border)}
/* Notification System */
.notification-container{position:fixed;top:80px;right:20px;z-index:10000;display:flex;flex-direction:column;gap:10px;max-width:400px}
.notification{background:var(--bg-container);border-radius:10px;padding:15px 20px;box-shadow:var(--shadow-xl);border-left:4px solid var(--info);animation:slideInRight .3s;display:flex;align-items:center;gap:12px}
.notification.success{border-left-color:var(--ok)}
.notification.warning{border-left-color:var(--warn)}
.notification.error{border-left-color:var(--bad)}
.notification-icon{font-size:24px}
.notification-content{flex:1}
.notification-title{font-weight:600;margin-bottom:4px}
.notification-message{font-size:13px;color:var(--text-unit)}
.notification-close{cursor:pointer;opacity:0.6;transition:opacity .3s}
.notification-close:hover{opacity:1}
/* Advanced Tooltips */
.tooltip-advanced{position:relative;cursor:help}
.tooltip-advanced::after{content:attr(data-tooltip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:var(--text);color:var(--bg-container);padding:8px 12px;border-radius:6px;font-size:12px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .3s;margin-bottom:8px;z-index:1000;box-shadow:var(--shadow-lg)}
.tooltip-advanced::before{content:'';position:absolute;bottom:100%;left:50%;transform:translateX(-50%);border:6px solid transparent;border-top-color:var(--text);opacity:0;pointer-events:none;transition:opacity .3s;margin-bottom:2px}
.tooltip-advanced:hover::after,.tooltip-advanced:hover::before{opacity:1}
/* Data Export Options */
.export-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin:20px 0}
.export-option{background:var(--bg-card);border:2px solid var(--border);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all .3s}
.export-option:hover{border-color:var(--text-accent);transform:translateY(-3px);box-shadow:var(--shadow-lg)}
.export-option-icon{font-size:40px;margin-bottom:10px}
.export-option-title{font-size:16px;font-weight:600;margin-bottom:5px}
.export-option-desc{font-size:12px;color:var(--text-unit)}
@media(max-width:768px){
.comparison-panel{grid-template-columns:1fr}
.template-grid{grid-template-columns:1fr}
.benchmark-grid{grid-template-columns:1fr}
.export-options{grid-template-columns:1fr}
}
</style>
<!-- ABSOLUTE APEX EDITION -->
<meta name="description" content="WWTP Ultimate APEX - The absolute theoretical maximum with AI, Voice, Digital Twin">
<meta name="keywords" content="WWTP,wastewater,AI,voice,digital-twin,apex">
<meta name="version" content="6.0 ABSOLUTE APEX">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="manifest" href="/wwtp-app/manifest.json" id="pwa-manifest">
<meta name="theme-color" content="#FF6B6B">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WWTP APEX">
<link rel="apple-touch-icon" href="data:image/svg+xml,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 100 100&#39;&gt;&lt;text y=&#39;75&#39; font-size=&#39;75&#39;&gt;%F0%9F%91%91&lt;/text&gt;&lt;/svg&gt;">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<style>
/* APEX EDITION - REVOLUTIONARY STYLES */
/* AI Copilot Interface */
.ai-copilot{position:fixed;bottom:80px;right:30px;width:400px;max-height:600px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);z-index:9999;display:none;flex-direction:column;overflow:hidden;animation:slideInUp .3s}
.ai-copilot.active{display:flex}
.ai-header{background:rgba(0,0,0,0.2);padding:20px;display:flex;justify-content:space-between;align-items:center;color:white}
.ai-avatar{width:50px;height:50px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;font-size:28px;animation:pulse 2s infinite}
.ai-chat{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:15px;background:white}
.ai-message{padding:12px 16px;border-radius:12px;max-width:85%;animation:fadeIn .3s}
.ai-message.bot{background:linear-gradient(135deg,#667eea,#764ba2);color:white;align-self:flex-start;margin-right:auto}
.ai-message.user{background:#e9ecef;color:#333;align-self:flex-end;margin-left:auto}
.ai-input-area{padding:15px;background:rgba(0,0,0,0.05);display:flex;gap:10px}
.ai-input{flex:1;padding:12px;border:none;border-radius:10px;font-size:14px;outline:none}
.ai-send-btn{padding:12px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700;transition:all .3s}
.ai-send-btn:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(102,126,234,0.4)}
/* Voice Control Interface */
.voice-control{position:fixed;bottom:30px;right:30px;width:70px;height:70px;background:linear-gradient(135deg,#f093fb,#f5576c);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 10px 30px rgba(240,147,251,0.5);z-index:9998;transition:all .3s}
.voice-control:hover{transform:scale(1.1);box-shadow:0 15px 40px rgba(240,147,251,0.7)}
.voice-control.listening{animation:pulse 1s infinite;background:linear-gradient(135deg,#f5576c,#f093fb)}
.voice-control.processing{animation:spin 1s linear infinite}
.voice-feedback{position:fixed;bottom:120px;right:30px;background:white;padding:15px 20px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.2);z-index:9997;display:none}
.voice-feedback.active{display:block;animation:slideInUp .3s}
/* Digital Twin Visualization */
.digital-twin{background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;border-radius:15px;padding:30px;margin:20px 0}
.twin-container{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin:20px 0}
.twin-component{background:rgba(255,255,255,0.1);border-radius:12px;padding:20px;backdrop-filter:blur(10px);transition:all .3s;cursor:pointer}
.twin-component:hover{background:rgba(255,255,255,0.2);transform:scale(1.05)}
.twin-status{display:flex;align-items:center;justify-content:space-between;margin-top:15px}
.twin-indicator{width:12px;height:12px;border-radius:50%;animation:pulse 2s infinite}
.twin-indicator.optimal{background:#4ade80}
.twin-indicator.warning{background:#fbbf24}
.twin-indicator.critical{background:#ef4444}
/* Machine Learning Panel */
.ml-panel{background:linear-gradient(135deg,#2c3e50,#3498db);color:white;border-radius:15px;padding:30px}
.ml-insight{background:rgba(255,255,255,0.15);border-left:4px solid #3498db;padding:15px 20px;margin:15px 0;border-radius:8px;backdrop-filter:blur(10px)}
.ml-confidence{display:inline-block;background:rgba(255,255,255,0.2);padding:4px 12px;border-radius:15px;font-size:12px;font-weight:700;margin-left:10px}
.learning-indicator{position:relative;height:8px;background:rgba(255,255,255,0.2);border-radius:4px;margin-top:10px;overflow:hidden}
.learning-progress{position:absolute;top:0;left:0;height:100%;background:linear-gradient(90deg,#3498db,#2ecc71);border-radius:4px;animation:slideInLeft 2s}
/* Blockchain Audit Trail */
.blockchain-panel{background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:white;border-radius:15px;padding:30px}
.block-chain{display:flex;flex-direction:column;gap:15px}
.block{background:rgba(255,255,255,0.1);border-radius:10px;padding:20px;border-left:4px solid #00d4ff;backdrop-filter:blur(10px);position:relative}
.block::after{content:'ðŸ”—';position:absolute;left:50%;bottom:-20px;font-size:20px;transform:translateX(-50%)}
.block:last-child::after{display:none}
.block-hash{font-family:monospace;font-size:11px;opacity:0.7;margin-top:10px}
.verified-badge{background:#00d4ff;color:#000;padding:4px 10px;border-radius:15px;font-size:11px;font-weight:700;display:inline-block}
/* IoT Sensor Dashboard */
.iot-dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0}
.sensor-card{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;overflow:hidden}
.sensor-card::before{content:'';position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgba(255,255,255,0.2),transparent);border-radius:50%}
.sensor-value{font-size:42px;font-weight:900;margin:15px 0}
.sensor-trend{display:flex;align-items:center;gap:10px;font-size:14px;margin-top:10px}
.live-indicator{width:10px;height:10px;background:#4ade80;border-radius:50%;animation:pulse 1s infinite;box-shadow:0 0 10px #4ade80}
/* Natural Language Query */
.nl-query-panel{background:linear-gradient(135deg,#8e44ad,#c0392b);color:white;border-radius:15px;padding:30px;margin:20px 0}
.nl-input-wrapper{display:flex;gap:15px;margin-top:20px}
.nl-input{flex:1;padding:15px 20px;border:none;border-radius:30px;font-size:16px;outline:none}
.nl-submit{padding:15px 30px;background:white;color:#8e44ad;border:none;border-radius:30px;font-weight:700;cursor:pointer;transition:all .3s}
.nl-submit:hover{transform:scale(1.05);box-shadow:0 5px 20px rgba(255,255,255,0.3)}
.nl-examples{display:flex;flex-wrap:wrap;gap:10px;margin-top:15px}
.nl-example{background:rgba(255,255,255,0.2);padding:8px 16px;border-radius:20px;font-size:13px;cursor:pointer;transition:all .3s}
.nl-example:hover{background:rgba(255,255,255,0.3)}
/* Advanced 3D Visualization */
.viz-3d-container{background:#000;border-radius:15px;padding:40px;margin:20px 0;min-height:400px;position:relative;overflow:hidden}
.viz-3d-placeholder{color:white;text-align:center;padding:100px 20px}
.viz-controls{position:absolute;top:20px;right:20px;display:flex;gap:10px}
.viz-control-btn{background:rgba(255,255,255,0.2);color:white;border:none;padding:10px 15px;border-radius:8px;cursor:pointer;backdrop-filter:blur(10px)}
/* Quantum Analytics Ready */
.quantum-panel{background:linear-gradient(135deg,#000428,#004e92);color:white;border-radius:15px;padding:30px;position:relative;overflow:hidden}
.quantum-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-top:20px}
.quantum-bit{width:100%;aspect-ratio:1;background:linear-gradient(135deg,#00d4ff,#0066ff);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;animation:float 3s ease-in-out infinite;cursor:pointer}
.quantum-bit:hover{animation:none;transform:scale(1.1) rotate(180deg)}
/* Advanced Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideInLeft{from{width:0}to{width:var(--progress,80%)}}
@keyframes float{0%,100%{transform:translateY(0) rotate(0)}25%{transform:translateY(-5px) rotate(5deg)}75%{transform:translateY(-5px) rotate(-5deg)}}

<style>
/* SUPREME EDITION ENHANCEMENTS */
/* Mobile-First Responsive Design */
@media(max-width:480px){
.quick-actions{grid-template-columns:repeat(2,1fr);gap:8px}
.quick-action-btn{padding:8px 12px;font-size:12px}
.quick-action-btn span{font-size:16px}
.summary-cards{grid-template-columns:1fr}
.analytics-grid{grid-template-columns:1fr}
.comparison-panel{grid-template-columns:1fr}
.modal-content{padding:15px;max-width:95%}
}
@media(max-width:768px)and(min-width:481px){
.quick-actions{grid-template-columns:repeat(3,1fr)}
.summary-cards{grid-template-columns:repeat(2,1fr)}
}
/* Real-Time Status Indicators */
.realtime-badge{position:fixed;bottom:20px;left:20px;background:var(--ok);color:white;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;z-index:999;box-shadow:var(--shadow-xl);animation:pulse 2s infinite}
.realtime-badge.syncing{background:var(--info)}
.realtime-badge.offline{background:var(--bad)}
.realtime-badge.online{background:var(--ok)}
/* Advanced Dashboard */
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:20px 0}
.dashboard-widget{background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:var(--shadow-md);position:relative;cursor:move;transition:all .3s}
.dashboard-widget:hover{transform:translateY(-5px);box-shadow:var(--shadow-xl)}
.widget-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.widget-title{font-size:16px;font-weight:700;color:var(--text-accent)}
.widget-actions{display:flex;gap:8px}
.widget-action-btn{background:none;border:none;color:var(--text-unit);cursor:pointer;font-size:18px;padding:4px;transition:all .3s}
.widget-action-btn:hover{color:var(--text-accent);transform:scale(1.2)}
.widget-body{min-height:100px}
/* Automation Rules */
.rule-card{background:var(--bg-section);border-left:4px solid var(--text-accent);padding:15px;margin:10px 0;border-radius:8px;transition:all .3s}
.rule-card:hover{background:var(--bg-tabs);transform:translateX(5px)}
.rule-status{display:inline-block;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:700;text-transform:uppercase}
.rule-status.active{background:var(--ok);color:white}
.rule-status.inactive{background:var(--text-unit);color:white}
.rule-status.triggered{background:var(--warn);color:white;animation:pulse 1s infinite}
/* Smart Alerts */
.alert-panel{position:fixed;top:80px;right:20px;max-width:350px;z-index:9999}
.alert-item{background:var(--bg-container);border-radius:10px;padding:15px;margin-bottom:10px;box-shadow:var(--shadow-xl);border-left:4px solid var(--info);animation:slideInRight .3s}
.alert-item.critical{border-left-color:var(--bad)}
.alert-item.warning{border-left-color:var(--warn)}
.alert-item.info{border-left-color:var(--info)}
.alert-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.alert-title{font-weight:700;font-size:14px}
.alert-time{font-size:11px;color:var(--text-unit)}
.alert-body{font-size:13px;line-height:1.4}
.alert-actions{margin-top:10px;display:flex;gap:8px}
.alert-btn{padding:6px 12px;border:none;border-radius:6px;font-size:12px;cursor:pointer;transition:all .3s}
.alert-btn.primary{background:var(--text-accent);color:white}
.alert-btn.secondary{background:var(--bg-section);color:var(--text)}
/* Performance Monitor */
.performance-panel{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;padding:20px;margin:20px 0}
.perf-metric{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,0.1);border-radius:8px;margin:8px 0}
.perf-label{font-size:14px;opacity:0.9}
.perf-value{font-size:24px;font-weight:700}
.perf-indicator{width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:28px}
/* Advanced Export Options */
.export-format-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:20px 0}
.format-card{background:var(--bg-card);border:2px solid var(--border);border-radius:10px;padding:15px;text-align:center;cursor:pointer;transition:all .3s}
.format-card:hover{border-color:var(--text-accent);transform:scale(1.05)}
.format-icon{font-size:32px;margin-bottom:8px}
.format-name{font-weight:600;font-size:14px}
.format-desc{font-size:11px;color:var(--text-unit);margin-top:4px}
/* API Integration */
.integration-card{background:var(--bg-card);border-radius:10px;padding:20px;margin:15px 0;border:1px solid var(--border)}
.integration-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
.integration-icon{width:50px;height:50px;border-radius:10px;background:var(--text-accent);display:flex;align-items:center;justify-content:center;font-size:24px;color:white}
.integration-info{flex:1}
.integration-name{font-size:16px;font-weight:700;margin-bottom:4px}
.integration-status{font-size:12px;color:var(--text-unit)}
.integration-actions{display:flex;gap:10px}
/* Mobile Optimization */
.mobile-only{display:none}
@media(max-width:768px){
.mobile-only{display:block}
.desktop-only{display:none}
.tab-content{padding:10px}
}
/* Offline Indicator */
.offline-banner{position:fixed;top:0;left:0;right:0;background:var(--warn);color:white;padding:10px;text-align:center;font-weight:700;z-index:10000;display:none}
.offline-banner.show{display:block}
/* Loading States */
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9998;display:none;align-items:center;justify-content:center}
.loading-overlay.active{display:flex}
.loading-spinner{width:60px;height:60px;border:4px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

<style>
/* ENTERPRISE MAX ADDITIONAL STYLES */
.visualization-panel{background:var(--bg-card);border-radius:12px;padding:25px;margin:20px 0;box-shadow:var(--shadow-lg)}
.chart-wrapper{position:relative;height:350px;margin:20px 0}
.chart-controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
.chart-type-btn{padding:8px 16px;border:2px solid var(--border);background:var(--bg-section);border-radius:8px;cursor:pointer;transition:all .3s;font-weight:600}
.chart-type-btn:hover{border-color:var(--text-accent);transform:translateY(-2px)}
.chart-type-btn.active{background:var(--text-accent);color:white;border-color:var(--text-accent)}
.theme-selector{position:fixed;top:20px;right:20px;z-index:1000;background:var(--bg-card);padding:15px;border-radius:12px;box-shadow:var(--shadow-xl);display:none}
.theme-selector.active{display:block}
.theme-option{padding:12px 20px;margin:8px 0;border-radius:8px;cursor:pointer;transition:all .3s;border:2px solid transparent}
.theme-option:hover{border-color:var(--text-accent);transform:scale(1.05)}
.theme-preview{display:flex;gap:8px;margin-top:8px}
.theme-color{width:30px;height:30px;border-radius:50%;border:2px solid white;box-shadow:var(--shadow-md)}
.report-builder{background:var(--bg-card);border-radius:12px;padding:25px;margin:20px 0}
.report-section{border:2px dashed var(--border);border-radius:8px;padding:20px;margin:10px 0;cursor:move;transition:all .3s}
.report-section:hover{border-color:var(--text-accent);background:var(--bg-section)}
.report-section.dragging{opacity:0.5}
.widget-gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}
.widget-card{background:var(--bg-section);border:2px solid var(--border);border-radius:10px;padding:15px;text-align:center;cursor:pointer;transition:all .3s}
.widget-card:hover{border-color:var(--text-accent);transform:scale(1.05);box-shadow:var(--shadow-lg)}
.widget-icon{font-size:36px;margin-bottom:10px}
.widget-name{font-size:14px;font-weight:600}
.predictive-panel{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;padding:25px;margin:20px 0}
.prediction-card{background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border-radius:10px;padding:20px;margin:15px 0}
.prediction-value{font-size:32px;font-weight:700;margin:10px 0}
.prediction-trend{display:flex;align-items:center;gap:10px;font-size:18px;margin-top:10px}
.trend-up{color:#4ade80}
.trend-down{color:#f87171}
.trend-stable{color:#fbbf24}
.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:20px 0}
.analytics-card{background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:var(--shadow-md)}
.mini-chart{height:100px;margin-top:15px}
.theme-dark{--bg-container:#1a1a2e;--bg-card:#16213e;--bg-section:#0f3460;--bg-tabs:#0a2647;--bg-input:#16213e;--text:#e8e8e8;--text-accent:#64ffda;--text-unit:#a0aec0;--border:#2d3748;--purple:#bb86fc;--teal:#03dac6;--ok:#4ade80;--warn:#fbbf24;--bad:#f87171;--info:#60a5fa}
.theme-ocean{--bg-container:#001845;--bg-card:#023e7d;--bg-section:#0466c8;--bg-tabs:#0353a4;--bg-input:#002855;--text:#f0f4f8;--text-accent:#4cc9f0;--text-unit:#90caf9;--border:#1565c0;--purple:#7b2cbf;--teal:#06ffa5;--ok:#43a047;--warn:#ffa726;--bad:#e53935;--info:#42a5f5}
.theme-forest{--bg-container:#1b4332;--bg-card:#2d6a4f;--bg-section:#40916c;--bg-tabs:#386641;--bg-input:#1b4332;--text:#f1faee;--text-accent:#95d5b2;--text-unit:#b7e4c7;--border:#52b788;--purple:#9d4edd;--teal:#06ffa5;--ok:#52b788;--warn:#f77f00;--bad:#d62828;--info:#4ea8de}
.theme-sunset{--bg-container:#370617;--bg-card:#6a040f;--bg-section:#9d0208;--bg-tabs:#560319;--bg-input:#370617;--text:#fefae0;--text-accent:#ffba08;--text-unit:#faa307;--border:#9d0208;--purple:#d00000;--teal:#06ffa5;--ok:#52b788;--warn:#fb8500;--bad:#dc2f02;--info:#4ea8de}
.install-prompt{position:fixed;bottom:20px;right:20px;background:var(--text-accent);color:white;padding:20px;border-radius:12px;box-shadow:var(--shadow-xl);z-index:10000;max-width:300px;animation:slideInRight .5s}
.install-btn{background:white;color:var(--text-accent);padding:12px 24px;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-top:15px;width:100%;transition:all .3s}
.install-btn:hover{transform:scale(1.05);box-shadow:var(--shadow-lg)}
.collaboration-panel{background:var(--bg-card);border-radius:12px;padding:25px;margin:20px 0;border-left:4px solid var(--text-accent)}
.user-avatar{width:40px;height:40px;border-radius:50%;background:var(--text-accent);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;margin-right:10px}
.activity-feed{max-height:400px;overflow-y:auto}
.activity-item{display:flex;align-items:center;padding:12px;border-radius:8px;margin:8px 0;background:var(--bg-section);transition:all .3s}
.activity-item:hover{transform:translateX(5px);background:var(--bg-tabs)}
.activity-time{font-size:12px;color:var(--text-unit);margin-left:auto}
</style>
</head>
<body class="theme-dark">
<div class="wrap">
<header class="header">
<div class="header-controls">
<button class="toggle" id="alertBtn" title="Alerts"><span id="alertBadge">ðŸ””</span></button>
<button class="toggle" id="saveBtn" title="Save Profile">ðŸ’¾</button>
<button class="toggle" id="loadBtn" title="Load Profile">ðŸ“‚</button>
<button class="toggle" id="exportBtn" title="Export Report">ðŸ“Š</button>
<button class="toggle" id="settingsBtn" title="Settings">âš™ï¸</button>
<button class="toggle" id="themeBtn" title="Toggle Dark Mode">â˜¾</button>
</div>
<h1>
WWTP Ultimate Integrated
<span class="live-indicator"></span>
<span class="badge pro">PROFESSIONAL</span>
<span class="badge ai">AI POWERED</span>
</h1>
<p class="muted">Comprehensive &amp; Advanced Wastewater Treatment Analysis, Optimization &amp; Operations Platform with AI Diagnostics</p>
<div class="status-bar">
<div class="status-item" style="color:var(--ok)"><span class="dot"></span>System Online</div>
<div class="status-item" style="color:var(--info)"><span class="dot"></span>27 Modules Active</div>
<div class="status-item" style="color:var(--purple)"><span class="dot"></span>AI Diagnostics Ready</div>
<div class="status-item" style="color:var(--teal)"><span class="dot"></span><span id="lastUpdate">Just now</span></div>
<div class="status-item" style="color:var(--warn)"><span class="dot"></span>Alerts: <span id="alertCount">5</span></div>
</div>
<div class="row">
<input id="plantName" placeholder="Plant Name" value="Municipal WWTP">
<input id="operatorName" placeholder="Operator Name">
<input id="calcDate" type="date">
<input id="temp" placeholder="Temperature (Â°C)" type="number" value="20">
</div>
</header>
<nav class="tabs" role="tablist">
<button aria-selected="true" class="tab" data-target="dashboard" role="tab">ðŸ“Š Dashboard</button>
<button class="tab" data-target="ai" role="tab">ðŸ¤– AI Assistant<span class="badge ai">NEW</span></button>
<button class="tab" data-target="loading" role="tab">âš–ï¸ Loading</button>
<button class="tab" data-target="sludge" role="tab">ðŸ§« Sludge</button>
<button class="tab" data-target="oxygen" role="tab">ðŸ’¨ Oxygen</button>
<button class="tab" data-target="energy" role="tab">âš¡ Energy</button>
<button class="tab" data-target="costs" role="tab">ðŸ’° Cost Analysis</button>
<button class="tab" data-target="advanced" role="tab">ðŸŽ“ Advanced</button>
<button class="tab" data-target="optimization" role="tab">ðŸš€ Optimization</button>
<button class="tab" data-target="maintenance" role="tab">ðŸ”§ Maintenance</button>
<button class="tab" data-target="lims" role="tab">ðŸ”¬ LIMS</button>
<button class="tab" data-target="alerts" role="tab">ðŸ”” Alerts</button>
<button class="tab" data-target="compliance" role="tab">ðŸ“‹ Compliance</button>
<button class="tab" data-target="predictive" role="tab">ðŸ”® Predictive</button>
<button class="tab" data-target="reports" role="tab">ðŸ“‘ Reports</button>
<button class="tab" data-target="process-calcs" role="tab">ðŸ§® Process Calculations<span class="badge pro">25 TOOLS</span></button>
<button class="tab" data-target="diagnostics" role="tab">ðŸ©º Diagnostics</button>
<button class="tab" data-target="multiplant" role="tab">ðŸ­ Multi-Plant<span class="badge ai">NEW</span></button>
<button class="tab" data-target="srt" role="tab">â±ï¸ SRT</button>
<button class="tab" data-target="bodeff" role="tab">ðŸ“‰ BOD Efficiency</button>
<button class="tab" data-target="svi" role="tab">ðŸ§ª SVI</button>
</nav>
<div class="content">
<!-- Dashboard Panel -->
<div class="panel active" id="dashboard">

<!-- Enhancement Banner - ABSOLUTE APEX EDITION -->
<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 15%,#f093fb 30%,#FF6B6B 45%,#FFE66D 60%,#00d4ff 75%,#8e44ad 90%,#c0392b 100%);color:white;padding:40px;border-radius:20px;margin-bottom:40px;box-shadow:0 30px 80px rgba(102,126,234,0.6);animation:slideInUp .5s ease;position:relative;overflow:hidden;border:3px solid rgba(255,255,255,0.3)">
  <div style="position:absolute;top:0;right:0;width:500px;height:500px;background:radial-gradient(circle,rgba(255,255,255,0.4),transparent);border-radius:50%;transform:translate(50%,-50%);animation:pulse 4s infinite"></div>
  <div style="position:absolute;bottom:0;left:0;width:400px;height:400px;background:radial-gradient(circle,rgba(255,255,255,0.3),transparent);border-radius:50%;transform:translate(-40%,40%)"></div>
  <div style="position:absolute;top:50%;left:50%;width:300px;height:300px;background:radial-gradient(circle,rgba(255,255,255,0.2),transparent);border-radius:50%;transform:translate(-50%,-50%);animation:float 6s ease-in-out infinite"></div>
  
  <div style="position:absolute;top:25px;right:25px;display:flex;gap:10px">
    <div style="background:linear-gradient(135deg,#FFE66D,#FF6B6B);padding:14px 28px;border-radius:35px;font-size:15px;font-weight:900;backdrop-filter:blur(15px);box-shadow:0 8px 25px rgba(0,0,0,0.4);animation:pulse 2.5s infinite">
      ðŸ‘‘ ABSOLUTE APEX ðŸ‘‘
    </div>
    <div style="background:linear-gradient(135deg,#00d4ff,#0066ff);padding:14px 28px;border-radius:35px;font-size:14px;font-weight:900;backdrop-filter:blur(15px);box-shadow:0 8px 25px rgba(0,0,0,0.4)">
      v6.0
    </div>
  </div>
  
  <div style="display:flex;align-items:center;gap:35px;flex-wrap:wrap;position:relative;z-index:1">
    <div style="font-size:72px;text-shadow:0 8px 30px rgba(0,0,0,0.5);animation:float 4s ease-in-out infinite">ðŸ‘‘</div>
    <div style="flex:1;min-width:450px">
      <h2 style="margin:0 0 18px 0;font-size:40px;font-weight:900;text-shadow:0 4px 20px rgba(0,0,0,0.4);letter-spacing:-1px">WWTP Ultimate - ABSOLUTE APEX</h2>
      <p style="margin:0 0 20px 0;opacity:0.98;font-size:17px;line-height:1.8;text-shadow:0 2px 12px rgba(0,0,0,0.3)">
        <strong>âš¡ REVOLUTIONARY APEX FEATURES:</strong> AI Copilot â€¢ Voice Control â€¢ Digital Twin Simulation â€¢ 
        Machine Learning â€¢ Blockchain Audit â€¢ IoT Live Sensors â€¢ Natural Language Processing
      </p>
      <p style="margin:0 0 15px 0;opacity:0.95;font-size:16px;line-height:1.7;text-shadow:0 2px 10px rgba(0,0,0,0.3)">
        <strong>Plus SUPREME:</strong> Real-Time Sync â€¢ Automation Engine â€¢ Smart Alerts â€¢ Performance Monitor â€¢ 
        Advanced Dashboard â€¢ 8 Export Formats â€¢ API Framework â€¢ Mobile-First
      </p>
      <p style="margin:0;opacity:0.92;font-size:15px;line-height:1.6;text-shadow:0 2px 10px rgba(0,0,0,0.3)">
        <strong>Plus ENTERPRISE MAX + ULTRA:</strong> Visualizations â€¢ Predictions â€¢ Reports â€¢ Themes â€¢ 
        Templates â€¢ Batch â€¢ Compare â€¢ Benchmark â€¢ 25 Calculators
      </p>
      <div style="margin-top:20px;padding:15px 20px;background:rgba(255,255,255,0.2);border-radius:12px;backdrop-filter:blur(10px)">
        <div style="font-size:14px;font-weight:700">ðŸŽ¯ THEORETICAL MAXIMUM ACHIEVED</div>
        <div style="font-size:13px;opacity:0.9;margin-top:5px">70+ Features â€¢ $250K+ Value â€¢ âˆž ROI â€¢ Industry Revolution</div>
      </div>
    </div>
    <div style="display:flex;gap:18px;flex-wrap:wrap;flex-direction:column">
      <button onclick="toggleAICopilot()" style="padding:18px 36px;background:white;color:#667eea;border:none;border-radius:14px;font-weight:900;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,0.4);transition:all .3s;font-size:16px;white-space:nowrap" onmouseover="this.style.transform=&#39;scale(1.1) rotate(2deg)&#39;" onmouseout="this.style.transform=&#39;scale(1)&#39;">
        ðŸ¤– Launch AI Copilot
      </button>
      <button onclick="showDigitalTwin()" style="padding:18px 36px;background:rgba(255,255,255,0.3);color:white;border:3px solid white;border-radius:14px;font-weight:900;cursor:pointer;backdrop-filter:blur(20px);transition:all .3s;font-size:16px" onmouseover="this.style.background=&#39;rgba(255,255,255,0.5)&#39;" onmouseout="this.style.background=&#39;rgba(255,255,255,0.3)&#39;">
        ðŸ­ Digital Twin
      </button>
    </div>
  </div>
</div>
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
<div class="kpi-grid">
<div class="kpi-card">
<h4>Flow Rate</h4>
<p id="kpi-flow">3.50</p>
<div class="small">MGD</div>
<div class="trend up">â†‘ 2.3%</div>
</div>
<div class="kpi-card">
<h4>DO Level</h4>
<p id="kpi-do">2.1</p>
<div class="small">mg/L</div>
<div class="trend stable">â†’ Stable</div>
</div>
<div class="kpi-card">
<h4>MLSS</h4>
<p id="kpi-mlss">2500</p>
<div class="small">mg/L</div>
<div class="trend up">â†‘ Target</div>
</div>
<div class="kpi-card">
<h4>F/M Ratio</h4>
<p id="kpi-fm">0.35</p>
<div class="small">lb/lb/d</div>
<div class="trend up">âœ“ Optimal</div>
</div>
<div class="kpi-card">
<h4>Energy Use</h4>
<p id="kpi-energy">1850</p>
<div class="small">kWh/MG</div>
<div class="trend up">â†“ 5.2%</div>
</div>
<div class="kpi-card">
<h4>Daily Cost</h4>
<p id="kpi-cost">$4,250</p>
<div class="small">$/day</div>
<div class="trend down">â†‘ 1.8%</div>
</div>
</div>
<div class="section">
<div class="section-h">
ðŸŽ¯ Quick Actions
<div class="section-actions">
<button class="icon-btn" onclick="refreshDashboard()">ðŸ”„ Refresh</button>
</div>
</div>
<div class="section-content">
<div class="btns">
<button class="btn gradient" onclick="calcAll()">ðŸ”„ Calculate All</button>
<button class="btn green" onclick="runOptimization()">ðŸš€ Run Optimization</button>
<button class="btn purple" onclick="openAIAssistant()">ðŸ¤– Ask AI Assistant</button>
<button class="btn orange" onclick="predictTrends()">ðŸ”® Predict Trends</button>
<button class="btn" onclick="saveProfile()">ðŸ’¾ Save Profile</button>
<button class="btn gray" onclick="loadProfile()">ðŸ“‚ Load Profile</button>
<button class="btn teal" onclick="exportFullReport()">ðŸ“Š Export Report</button>
</div>
</div>
</div>
<div class="split-view">
<div class="section">
<div class="section-h">ðŸ“ˆ Performance Trends</div>
<div class="section-content">
<div class="chart-container">
<canvas id="performanceChart"></canvas>
</div>
</div>
</div>
<div class="section">
<div class="section-h">âš¡ Energy Consumption</div>
<div class="section-content">
<div class="chart-container">
<canvas id="energyChart"></canvas>
</div>
</div>
</div>
</div>
<div class="section">
<div class="section-h">ðŸ©º System Health Score</div>
<div class="section-content">
<div style="display:flex;gap:40px;align-items:center;justify-content:center;flex-wrap:wrap">
<div class="gauge good" id="healthGauge">
<div>
<div style="font-size:0.35em">HEALTH</div>
95
<div style="font-size:0.28em">/100</div>
</div>
</div>
<div style="flex:1;min-width:300px">
<h4 style="margin-bottom:16px">Performance Metrics</h4>
<div style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>BOD Removal</span><strong style="color:var(--ok)">95%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:95%"></div>
</div>
</div>
<div style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>TSS Removal</span><strong style="color:var(--ok)">93%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:93%"></div>
</div>
</div>
<div style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>Energy Efficiency</span><strong style="color:var(--ok)">92%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:92%"></div>
</div>
</div>
<div>
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>Compliance Score</span><strong style="color:var(--ok)">98%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:98%"></div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="section">
<div class="section-h">ðŸ¤– AI-Powered Recommendations</div>
<div class="section-content">
<div id="aiRecommendations">
<div class="note success">
<strong>âœ“ Optimal Operating Conditions</strong><br>
System is running within optimal parameters. F/M ratio (0.35) and MCRT (8.2 days) are well-balanced for efficient BOD removal and nitrification.
</div>
<div class="note warning">
<strong>âš  Energy Optimization Opportunity</strong><br>
Consider reducing aeration by 8% during low-load periods (midnight-6am). Estimated savings: $280/month.
</div>
<div class="note info">
<strong>â„¹ï¸ Predictive Maintenance Alert</strong><br>
Blower #2 vibration trending upward. Schedule inspection within 14 days to prevent unplanned downtime.
</div>
</div>
</div>
</div>
</div>
<!-- AI Assistant Panel -->
<div class="panel" id="ai">
<div class="section">
<div class="section-h">ðŸ¤– AI Diagnostic &amp; Troubleshooting Assistant</div>
<div class="section-content">
<div class="note info" style="margin-bottom:24px">
<strong>Welcome to the AI Assistant!</strong><br>
I can help diagnose issues, provide troubleshooting guidance, recommend solutions, and answer questions about wastewater treatment operations. Start by selecting a diagnostic mode below or ask me a question directly.
</div>
<div class="btns">
<button class="btn gradient" onclick="runSystemDiagnostic()">ðŸ” Full System Diagnostic</button>
<button class="btn orange" onclick="showSymptomChecker()">ðŸ©º Symptom Checker</button>
<button class="btn purple" onclick="showKnowledgeBase()">ðŸ“š Knowledge Base</button>
<button class="btn teal" onclick="showIssueHistory()">ðŸ“œ Issue History</button>
<button class="btn green" onclick="clearAIChat()">ðŸ—‘ï¸ Clear Chat</button>
</div>
</div>
</div>
<div class="section">
<div class="section-h">ðŸ’¬ Interactive Chat Assistant</div>
<div class="section-content">
<div class="ai-chat-container">
<div class="ai-messages" id="aiMessages">
<div class="ai-message assistant">
Hello! I'm your AI wastewater treatment assistant. I can help you with:
<ul style="margin:10px 0 0 20px;line-height:1.8">
<li>Diagnosing operational issues</li>
<li>Troubleshooting process problems</li>
<li>Providing step-by-step solutions</li>
<li>Answering technical questions</li>
<li>Analyzing treatment performance</li>
<li>Recommending optimization strategies</li>
</ul>
How can I assist you today?
</div>
</div>
<div class="ai-thinking" id="aiThinking">AI is thinking...</div>
<div class="ai-input-area">
<input class="ai-input" id="aiInput" onkeypress="if(event.key===&#39;Enter&#39;)sendAIMessage()" placeholder="Ask me anything about your WWTP operations..." type="text">
<button class="btn gradient" onclick="sendAIMessage()">Send</button>
<button class="btn orange" onclick="showQuickQuestions()">Quick Q&amp;A</button>
</div>
</div>
</div>
</div>
<div class="section" id="diagnosticResults" style="display:none">
<div class="section-h">
ðŸ” Diagnostic Results
<div class="section-actions">
<button class="icon-btn" onclick="exportDiagnostic()">ðŸ“¥ Export</button>
</div>
</div>
<div class="section-content" id="diagnosticContent">
<!-- Diagnostic results will be populated here -->
</div>
</div>
<div class="section" id="symptomCheckerSection" style="display:none">
<div class="section-h">
ðŸ©º Symptom-Based Troubleshooting
<div class="section-actions">
<button class="icon-btn" onclick="resetSymptomChecker()">ðŸ”„ Reset</button>
</div>
</div>
<div class="section-content">
<h4 style="margin-bottom:16px">Select all symptoms you're experiencing:</h4>
<div class="symptom-checker" id="symptomChecker">
<!-- Symptoms will be populated here -->
</div>
<button class="btn gradient" onclick="analyzeSymptoms()">ðŸ” Analyze Symptoms</button>
</div>
</div>
<div class="section" id="knowledgeBaseSection" style="display:none">
<div class="section-h">
ðŸ“š Knowledge Base
<div class="section-actions">
<input id="kbSearch" onkeyup="searchKnowledgeBase()" placeholder="Search..." style="width:250px;padding:8px;margin-right:8px" type="text">
</div>
</div>
<div class="section-content" id="knowledgeBaseContent">
<!-- Knowledge base articles will be populated here -->
</div>
</div>
<div class="section" id="issueHistorySection" style="display:none">
<div class="section-h">
ðŸ“œ Issue History &amp; Resolution Tracking
<div class="section-actions">
<button class="icon-btn" onclick="addNewIssue()">âž• Log Issue</button>
</div>
</div>
<div class="section-content" id="issueHistoryContent">
<!-- Issue history will be populated here -->
</div>
</div>
<p>I can read all your calculator data, analyze microscope images, and speak my responses.</p></div>
<!-- Loading Panel (Abbreviated - keeping structure same as original) -->
<div class="panel" id="loading">
<div class="section">
<div class="section-h">ðŸ“¥ Influent Loading Parameters</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Flow Rate (MGD)</label>
<div class="input-with-icon">
<input id="flow" step="0.1" type="number" value="3.5">
<span class="input-icon">ðŸ’§</span>
</div>
</div>
<div class="input-group">
<label>BOD (mg/L)</label>
<input id="bod" step="1" type="number" value="200">
</div>
<div class="input-group">
<label>TSS (mg/L)</label>
<input id="tss" step="1" type="number" value="220">
</div>
<div class="input-group">
<label>TKN (mg/L)</label>
<input id="tkn" step="1" type="number" value="40">
</div>
<div class="input-group">
<label>TP (mg/L)</label>
<input id="tp" step="0.1" type="number" value="8">
</div>
<div class="input-group">
<label>COD (mg/L)</label>
<input id="cod" step="1" type="number" value="450">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcLoading()">Calculate Loading</button>
<button class="btn gray" onclick="resetLoading()">Reset</button>
<button class="btn orange" onclick="compareHistorical()">Compare Historical</button>
</div>
</div>
</div>
<div class="section">
<div class="section-h">ðŸ“Š Loading Results &amp; Analysis</div>
<div class="section-content">
<table class="table">
<thead>
<tr>
<th class="col">Parameter</th>
<th class="col">Value</th>
<th class="col">Unit</th>
<th class="col">7-Day Avg</th>
<th class="col">Trend</th>
<th class="col">Status</th>
</tr>
</thead>
<tbody>
<tr>
<td class="rowh">BOD Load</td>
<td><span class="result" id="r_bodLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_bodLoad">-</span></td>
<td><span id="trend_bodLoad">-</span></td>
<td><span class="status" id="s_bodLoad">-</span></td>
</tr>
<tr>
<td class="rowh">TSS Load</td>
<td><span class="result" id="r_tssLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_tssLoad">-</span></td>
<td><span id="trend_tssLoad">-</span></td>
<td><span class="status" id="s_tssLoad">-</span></td>
</tr>
<tr>
<td class="rowh">TKN Load</td>
<td><span class="result" id="r_tknLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_tknLoad">-</span></td>
<td><span id="trend_tknLoad">-</span></td>
<td><span class="status" id="s_tknLoad">-</span></td>
</tr>
<tr>
<td class="rowh">TP Load</td>
<td><span class="result" id="r_tpLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_tpLoad">-</span></td>
<td><span id="trend_tpLoad">-</span></td>
<td><span class="status" id="s_tpLoad">-</span></td>
</tr>
<tr>
<td class="rowh">COD Load</td>
<td><span class="result" id="r_codLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_codLoad">-</span></td>
<td><span id="trend_codLoad">-</span></td>
<td><span class="status" id="s_codLoad">-</span></td>
</tr>
</tbody>
</table>
<div class="stats-row">
<div class="stat-item">
<div class="stat-label">Organic Loading Rate</div>
<div class="stat-value" id="stat_olr">0.42</div>
<div class="stat-unit">lb BOD/lb MLVSS/d</div>
</div>
<div class="stat-item">
<div class="stat-label">Volumetric Loading</div>
<div class="stat-value" id="stat_volLoad">58.3</div>
<div class="stat-unit">lb BOD/1000 ftÂ³/d</div>
</div>
<div class="stat-item">
<div class="stat-label">BOD:N:P Ratio</div>
<div class="stat-value" id="stat_ratio">100:20:4</div>
<div class="stat-unit">Actual</div>
</div>
</div>
</div>
</div>
</div>
<!-- Sludge Panel -->
<div class="panel" id="sludge">
<div class="section">
<div class="section-h">ðŸ§« Activated Sludge Parameters</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>MLSS (mg/L)</label>
<input id="mlss" step="10" type="number" value="2500">
</div>
<div class="input-group">
<label>MLVSS (mg/L)</label>
<input id="mlvss" step="10" type="number" value="2000">
</div>
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input id="aerVol" step="0.1" type="number" value="1.2">
</div>
<div class="input-group">
<label>RAS Flow (MGD)</label>
<input id="rasFlow" step="0.1" type="number" value="1.5">
</div>
<div class="input-group">
<label>WAS Flow (MGD)</label>
<input id="wasFlow" step="0.01" type="number" value="0.05">
</div>
<div class="input-group">
<label>WAS TSS (mg/L)</label>
<input id="wasTss" step="100" type="number" value="8000">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSludge()">Calculate Sludge</button>
<button class="btn gray" onclick="resetSludge()">Reset</button>
</div>
</div>
</div>
<div class="section">
<div class="section-h">ðŸ“Š Sludge Results</div>
<div class="section-content">
<table class="table">
<thead>
<tr>
<th class="col">Parameter</th>
<th class="col">Value</th>
<th class="col">Unit</th>
<th class="col">Status</th>
</tr>
</thead>
<tbody>
<tr>
<td class="rowh">F/M Ratio</td>
<td><span class="result" id="r_fm">-</span></td>
<td>lb BOD/lb MLVSS/d</td>
<td><span class="status" id="s_fm">-</span></td>
</tr>
<tr>
<td class="rowh">MCRT</td>
<td><span class="result" id="r_mcrt">-</span></td>
<td>days</td>
<td><span class="status" id="s_mcrt">-</span></td>
</tr>
<tr>
<td class="rowh">SVI</td>
<td><span class="result" id="r_svi">-</span></td>
<td>mL/g</td>
<td><span class="status" id="s_svi">-</span></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<!-- Oxygen Panel -->
<div class="panel" id="oxygen">
<div class="section">
<div class="section-h">ðŸ’¨ Oxygen Requirements</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Current DO (mg/L)</label>
<input id="doNow" step="0.1" type="number" value="2.0">
</div>
<div class="input-group">
<label>Target DO (mg/L)</label>
<input id="doTarget" step="0.1" type="number" value="2.5">
</div>
<div class="input-group">
<label>Peak Factor</label>
<input id="peakFactor" step="0.1" type="number" value="1.5">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcOxygen()">Calculate Oxygen</button>
<button class="btn gray" onclick="resetOxygen()">Reset</button>
</div>
<div class="stats-row" style="margin-top:20px">
<div class="stat-item">
<div class="stat-label">Oâ‚‚ Required</div>
<div class="stat-value" id="r_o2req">-</div>
<div class="stat-unit">lb Oâ‚‚/d</div>
</div>
<div class="stat-item">
<div class="stat-label">Peak Demand</div>
<div class="stat-value" id="r_o2peak">-</div>
<div class="stat-unit">lb Oâ‚‚/hr</div>
</div>
<div class="stat-item">
<div class="stat-label">Airflow</div>
<div class="stat-value" id="r_airflow">-</div>
<div class="stat-unit">CFM</div>
</div>
</div>
</div>
</div>
</div>
<!-- Energy Panel -->
<div class="panel" id="energy">
<div class="section">
<div class="section-h">âš¡ Energy Analysis</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Blower Power (HP)</label>
<input id="blowerHp" step="10" type="number" value="200">
</div>
<div class="input-group">
<label>Pump Power (HP)</label>
<input id="pumpHp" step="10" type="number" value="100">
</div>
<div class="input-group">
<label>Other Equipment (HP)</label>
<input id="otherHp" step="10" type="number" value="50">
</div>
<div class="input-group">
<label>Electricity Rate ($/kWh)</label>
<input id="elecRate" step="0.01" type="number" value="0.12">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcEnergy()">Calculate Energy</button>
<button class="btn gray" onclick="resetEnergy()">Reset</button>
</div>
<div class="stats-row" style="margin-top:20px">
<div class="stat-item">
<div class="stat-label">Daily Energy</div>
<div class="stat-value" id="r_dailyEnergy">-</div>
<div class="stat-unit">kWh/d</div>
</div>
<div class="stat-item">
<div class="stat-label">Monthly Cost</div>
<div class="stat-value" id="r_monthCost">-</div>
<div class="stat-unit">$/mo</div>
</div>
<div class="stat-item">
<div class="stat-label">Energy Intensity</div>
<div class="stat-value" id="r_kwhMg">-</div>
<div class="stat-unit">kWh/MG</div>
</div>
</div>
</div>
</div>
</div>
<!-- Cost Analysis Panel -->
<div class="panel" id="costs">
<div class="section">
<div class="section-h">ðŸ’° Cost Analysis</div>
<div class="section-content">
<div class="note info">
<strong>Cost Analysis Module</strong><br>
Track and analyze operational costs including energy, chemicals, labor, maintenance, and disposal.
</div>
<div class="btns">
<button class="btn green" onclick="calcCosts()">Calculate Costs</button>
</div>
</div>
</div>
</div>
<!-- Advanced Panel -->
<div class="panel" id="advanced">
<div class="section">
<div class="section-h">ðŸŽ“ Advanced Parameters</div>
<div class="section-content">
<div class="note info">
<strong>Advanced Process Calculations</strong><br>
Configure advanced kinetic parameters, process modeling, and specialized treatment configurations.
</div>
</div>
</div>
</div>
<!-- Optimization Panel -->
<div class="panel" id="optimization">
<div class="section">
<div class="section-h">ðŸš€ Process Optimization</div>
<div class="section-content">
<div class="note info">
<strong>Optimization Engine</strong><br>
AI-powered optimization for energy efficiency, sludge reduction, and chemical usage.
</div>
<div class="btns">
<button class="btn gradient" onclick="runOptimization()">Run Optimization</button>
</div>
</div>
</div>
</div>
<!-- Maintenance Panel -->
<div class="panel" id="maintenance">
<div class="section">
<div class="section-h">ðŸ”§ Maintenance Tracking</div>
<div class="section-content">
<div class="note info">
<strong>Equipment Maintenance</strong><br>
Track preventive maintenance schedules, equipment status, and service history.
</div>
</div>
</div>
</div>
<!-- LIMS Panel -->
<div class="panel" id="lims">
<div class="section">
<div class="section-h">ðŸ”¬ Laboratory Information Management</div>
<div class="section-content">
<div class="note info">
<strong>LIMS Module</strong><br>
Manage lab test results, QA/QC protocols, and analytical data tracking.
</div>
</div>
</div>
</div>
<!-- Alerts Panel -->
<div class="panel" id="alerts">
<div class="section">
<div class="section-h">ðŸ”” Real-Time Alerts</div>
<div class="section-content">
<div class="note info">
<strong>Alert Management</strong><br>
Configure and monitor real-time alerts for process parameters, compliance limits, and equipment status.
</div>
<div class="alert-box alert-warning">
<div class="alert-icon">âš ï¸</div>
<div class="alert-content">
<div class="alert-title">Sample Alert</div>
<div class="alert-message">This is how alerts will appear in the system.</div>
</div>
</div>
</div>
</div>
</div>
<!-- Compliance Panel -->
<div class="panel" id="compliance">
<div class="section">
<div class="section-h">ðŸ“‹ Regulatory Compliance</div>
<div class="section-content">
<div class="note success">
<strong>âœ“ Compliance Status</strong><br>
Track permit limits, DMR submissions, and regulatory reporting requirements.
</div>
<div class="stats-row">
<div class="stat-item">
<div class="stat-label">Compliance Rate</div>
<div class="stat-value">98.5%</div>
<div class="stat-unit">YTD</div>
</div>
<div class="stat-item">
<div class="stat-label">Violations</div>
<div class="stat-value">0</div>
<div class="stat-unit">This Year</div>
</div>
</div>
</div>
</div>
</div>
<!-- Predictive Panel -->
<div class="panel" id="predictive">
<div class="section">
<div class="section-h">ðŸ”® Predictive Analytics</div>
<div class="section-content">
<div class="note info">
<strong>ðŸ¤– AI-Powered Forecasting</strong><br>
Predict future performance trends, equipment failures, and loading patterns using machine learning models.
</div>
<div class="btns">
<button class="btn gradient" onclick="predictTrends()">Generate Predictions</button>
</div>
</div>
</div>
</div>
<!-- Reports Panel -->
<div class="panel" id="reports">
<div class="section">
<div class="section-h">ðŸ“‘ Report Generation</div>
<div class="section-content">
<div class="note info">
<strong>Automated Reporting</strong><br>
Generate daily operations reports, monthly performance summaries, compliance reports, and custom analytics.
</div>
<div class="tool-grid">
<div class="scenario-card" onclick="generateReport(&#39;daily&#39;)">
<div class="icon">ðŸ“…</div>
<strong>Daily Report</strong>
<p>Operations summary</p>
</div>
<div class="scenario-card" onclick="generateReport(&#39;monthly&#39;)">
<div class="icon">ðŸ“Š</div>
<strong>Monthly Report</strong>
<p>Performance analysis</p>
</div>
<div class="scenario-card" onclick="generateReport(&#39;compliance&#39;)">
<div class="icon">ðŸ“‹</div>
<strong>Compliance Report</strong>
<p>Regulatory summary</p>
</div>
</div>
</div>
</div>
</div>
<div id="viz-dashboard" style="display: none;"></div><div class="panel" id="process-calcs">
  <div class="section">
    <div class="section-h">ðŸ§® Process Calculations - Complete WWTP Analysis Suite</div>
    <div class="section-content">
      <div class="note" style="margin-bottom:25px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:12px;box-shadow:var(--shadow-lg)">
        <strong style="font-size:18px;display:block;margin-bottom:8px">ðŸ“ Professional-Grade Calculator Suite</strong>
        <span style="font-size:14px;opacity:0.95">25 specialized calculation tools covering all aspects of wastewater treatment plant operations. Each calculator uses industry-standard formulas following EPA guidelines and WEF Manual of Practice standards.</span>
      </div>

      <!-- Quick Actions Toolbar - ABSOLUTE APEX EDITION -->
      <div class="quick-actions">
        <button class="quick-action-btn primary" onclick="calculateAllProcess()" title="Run all calculations">
          <span>âš¡</span> Calculate
        </button>
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#667eea,#764ba2);color:white" onclick="showVisualizationDashboard()" title="Interactive charts">
          <span>ðŸ“Š</span> Visualize
        </button>
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#f093fb,#f5576c);color:white" onclick="showPredictiveAnalytics()" title="AI predictions">
          <span>ðŸ”®</span> Predict
        </button>
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#FF6B6B,#FFE66D);color:white" onclick="showAdvancedDashboard()" title="Real-time dashboard">
          <span>ðŸ“ˆ</span> Dashboard
        </button>
        <!-- APEX FEATURES -->
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#8e44ad,#c0392b);color:white" onclick="toggleAICopilot()" title="AI Copilot assistant">
          <span>ðŸ¤–</span> AI Copilot
        </button>
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#1e3c72,#2a5298);color:white" onclick="showDigitalTwin()" title="Virtual plant model">
          <span>ðŸ­</span> Digital Twin
        </button>
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#2c3e50,#3498db);color:white" onclick="showMLInsights()" title="Machine learning">
          <span>ðŸ§ </span> ML Insights
        </button>
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#0f2027,#2c5364);color:white" onclick="showBlockchainAudit()" title="Immutable records">
          <span>ðŸ”—</span> Blockchain
        </button>
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#4facfe,#00f2fe);color:white" onclick="showIOTDashboard()" title="Live sensor data">
          <span>ðŸ“¡</span> IoT
        </button>
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#8e44ad,#c0392b);color:white" onclick="showNLQuery()" title="Ask in plain English">
          <span>ðŸ’¬</span> Ask AI
        </button>
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#4ECDC4,#556270);color:white" onclick="showAutomationRules()" title="Automation rules">
          <span>âš™ï¸</span> Automate
        </button>
        <button class="quick-action-btn" style="background:linear-gradient(135deg,#fa709a,#fee140);color:white" onclick="showThemeSelector()" title="Change theme">
          <span>ðŸŽ¨</span> Theme
        </button>
      </div>

      <!-- System Summary Cards -->
      <div class="summary-cards" id="process-summary">
        <div class="summary-card">
          <div class="summary-card-icon">âš–ï¸</div>
          <div class="summary-card-value" id="total-calcs">25</div>
          <div class="summary-card-label">Total Calculators</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-icon">âœ…</div>
          <div class="summary-card-value" id="completed-calcs">0</div>
          <div class="summary-card-label">Completed</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-icon">ðŸŽ¯</div>
          <div class="summary-card-value" id="in-range-calcs">0</div>
          <div class="summary-card-label">Within Range</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-icon">âš ï¸</div>
          <div class="summary-card-value" id="warning-calcs">0</div>
          <div class="summary-card-label">Warnings</div>
        </div>
        <div class="summary-card">
          <div class="summary-card-icon">ðŸ”´</div>
          <div class="summary-card-value" id="critical-calcs">0</div>
          <div class="summary-card-label">Critical</div>
        </div>
      </div>


      <!-- Regulatory Compliance Monitor -->
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:var(--shadow-lg)">
        <h3 style="margin:0 0 15px 0;display:flex;align-items:center;gap:10px">
          <span style="font-size:24px">ðŸ“‹</span>
          <span>Regulatory Compliance Status</span>
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px" id="compliance-indicators">
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-bod">âœ“ 98%</div>
            <div style="font-size:12px;opacity:0.9">BOD Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-tss">âœ“ 97%</div>
            <div style="font-size:12px;opacity:0.9">TSS Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-nh3">âœ“ 99%</div>
            <div style="font-size:12px;opacity:0.9">NHâ‚ƒ Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-do">âœ“ Yes</div>
            <div style="font-size:12px;opacity:0.9">DO Requirement Met</div>
          </div>
        </div>
      </div>

      <!-- Optimization Recommendations -->
      <div class="collapsible-header" onclick="toggleCollapsible(this)">
        <strong>ðŸ’¡ AI-Powered Optimization Recommendations</strong>
        <span>â–¼</span>
      </div>
      <div class="collapsible-content" id="optimization-recommendations" style="background:var(--bg-note);padding:20px;border-radius:8px;margin-bottom:25px">
        <div id="recommendations-list">
          <p style="color:var(--text-unit);font-style:italic">Run calculations to generate optimization recommendations...</p>
        </div>
      </div>

      <div class="calc-category">
        <div class="calc-category-header" style="cursor: pointer;">âš–ï¸ Loading Calculations</div>
        <div class="calc-grid">
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸ§« Organic Loading Rate (OLR) - Process Loading Analysis</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent BOD (mg/L)</label>
          <input id="olr_bod" type="number" step="1" value="200" oninput="calcOLR()">
        </div>
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="olr_flow" type="number" step="0.1" value="3.5" oninput="calcOLR()">
        </div>
        <div class="input-group">
          <label>Aeration Tank Volume (MG)</label>
          <input id="olr_volume" type="number" step="0.01" value="1.2" oninput="calcOLR()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcOLR()">Calculate OLR</button>
        <button class="btn gray" onclick="resetOLR()">Reset</button>
      </div>
      <div class="note">
        <strong>Typical Ranges:</strong> Conventional Activated Sludge: 20-40 lb/day/1000 ftÂ³, Extended Aeration: 5-15 lb/day/1000 ftÂ³, High-Rate: 40-80 lb/day/1000 ftÂ³
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š OLR Result</div>
    <div class="section-content">
      <p>Organic Loading Rate: <span class="result" id="olr_result">-</span> lb BOD/day/1000 ftÂ³</p>
    </div>
  </div>
</div>

<!-- 2. VLR Calculator -->
          </div>
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸ“¦ Volumetric Loading Rate (VLR) - Volume-Based Loading</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent BOD (mg/L)</label>
          <input id="vlr_bod" type="number" step="1" value="180" oninput="calcVLR()">
        </div>
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="vlr_flow" type="number" step="0.1" value="3.5" oninput="calcVLR()">
        </div>
        <div class="input-group">
          <label>Reactor Volume (MG)</label>
          <input id="vlr_volume" type="number" step="0.01" value="1.0" oninput="calcVLR()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcVLR()">Calculate VLR</button>
        <button class="btn gray" onclick="resetVLR()">Reset</button>
      </div>
      <div class="note">
        <strong>Design Guidelines:</strong> VLR helps determine reactor sizing and process efficiency. Lower VLR typically indicates better treatment performance.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š VLR Result</div>
    <div class="section-content">
      <p>Volumetric Loading Rate: <span class="result" id="vlr_result">-</span> lb BOD/day/MG</p>
    </div>
  </div>
</div>

<!-- 3. RAS Flow Rate Calculator -->
          </div>
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸ“‰ BOD Removal Efficiency - Treatment Performance</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent BOD (mg/L)</label>
          <input id="bodeff_in" type="number" step="1" value="200" oninput="calcBODEfficiency()">
        </div>
        <div class="input-group">
          <label>Effluent BOD (mg/L)</label>
          <input id="bodeff_out" type="number" step="0.5" value="10" oninput="calcBODEfficiency()">
        </div>
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="bodeff_flow" type="number" step="0.1" value="3.5" oninput="calcBODEfficiency()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcBODEfficiency()">Calculate</button>
        <button class="btn gray" onclick="resetBODEfficiency()">Reset</button>
      </div>
      <div class="note success">
        <strong>Permit Requirements:</strong> Secondary Treatment: â‰¥85% removal, Advanced: â‰¥90% removal, Tertiary: â‰¥95% removal
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š BOD Efficiency Results</div>
    <div class="section-content">
      <p>BOD Removal Efficiency: <span class="result" id="bodeff_percent">-</span> %</p>
      <p>BOD Removed: <span class="result" id="bodeff_removed">-</span> lb/day</p>
      <p>Compliance Status: <span class="result" id="bodeff_status">-</span></p>
    </div>
  </div>
</div>

<!-- 15. SVI Calculator Enhanced -->
          </div>
        </div>
      </div>


      <!-- Regulatory Compliance Monitor -->
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:var(--shadow-lg)">
        <h3 style="margin:0 0 15px 0;display:flex;align-items:center;gap:10px">
          <span style="font-size:24px">ðŸ“‹</span>
          <span>Regulatory Compliance Status</span>
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px" id="compliance-indicators">
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-bod">--</div>
            <div style="font-size:12px;opacity:0.9">BOD Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-tss">--</div>
            <div style="font-size:12px;opacity:0.9">TSS Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-nh3">--</div>
            <div style="font-size:12px;opacity:0.9">NHâ‚ƒ Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-do">--</div>
            <div style="font-size:12px;opacity:0.9">DO Requirement Met</div>
          </div>
        </div>
      </div>

      <!-- Optimization Recommendations -->
      <div class="collapsible-header" onclick="toggleCollapsible(this)">
        <strong>ðŸ’¡ AI-Powered Optimization Recommendations</strong>
        <span>â–¼</span>
      </div>
      <div class="collapsible-content" id="optimization-recommendations" style="background:var(--bg-note);padding:20px;border-radius:8px;margin-bottom:25px">
        <div id="recommendations-list">
          <p style="color:var(--text-unit);font-style:italic">Run calculations to generate optimization recommendations...</p>
        </div>
      </div>

      <div class="calc-category">
        <div class="calc-category-header" style="cursor: pointer;">ðŸ’§ Hydraulic Calculations</div>
        <div class="calc-grid">
          <div class="calc-item">
<div class="section">
    <div class="section-h">â±ï¸ Detention Time - Hydraulic Retention Time</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Tank Volume (MG)</label>
          <input id="dt_volume" type="number" step="0.01" value="1.2" oninput="calcDetention()">
        </div>
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="dt_flow" type="number" step="0.1" value="3.5" oninput="calcDetention()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcDetention()">Calculate</button>
        <button class="btn gray" onclick="resetDetention()">Reset</button>
      </div>
      <div class="note">
        <strong>Design Criteria:</strong> Conventional Activated Sludge: 4-8 hours, Extended Aeration: 18-24 hours, Contact Stabilization: 3-6 hours
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Detention Time Results</div>
    <div class="section-content">
      <p>Detention Time: <span class="result" id="dt_result_hours">-</span> hours</p>
      <p>Detention Time: <span class="result" id="dt_result_days">-</span> days</p>
    </div>
  </div>
</div>

<!-- 5. WOR Calculator -->
          </div>
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸ’§ Weir Overflow Rate - Clarifier Design Parameter</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="wor_flow" type="number" step="0.1" value="3.5" oninput="calcWOR()">
        </div>
        <div class="input-group">
          <label>Weir Length (ft)</label>
          <input id="wor_length" type="number" step="1" value="250" oninput="calcWOR()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcWOR()">Calculate WOR</button>
        <button class="btn gray" onclick="resetWOR()">Reset</button>
      </div>
      <div class="note warning">
        <strong>Recommended Limits:</strong> Primary Clarifiers: â‰¤20,000 GPD/ft, Secondary Clarifiers: â‰¤15,000 GPD/ft. High WOR can cause hydraulic overload.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š WOR Result</div>
    <div class="section-content">
      <p>Weir Overflow Rate: <span class="result" id="wor_result">-</span> GPD/ft</p>
    </div>
  </div>
</div>

<!-- 6. SLR Calculator -->
          </div>
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸ“ Surface Loading Rate - Settling Tank Analysis</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="slr_flow" type="number" step="0.1" value="3.5" oninput="calcSLR()">
        </div>
        <div class="input-group">
          <label>Surface Area (ftÂ²)</label>
          <input id="slr_area" type="number" step="10" value="5000" oninput="calcSLR()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcSLR()">Calculate SLR</button>
        <button class="btn gray" onclick="resetSLR()">Reset</button>
      </div>
      <div class="note">
        <strong>Design Standards:</strong> Primary Clarifiers: 400-800 GPD/ftÂ², Secondary Clarifiers: 300-600 GPD/ftÂ² (avg), 800-1200 GPD/ftÂ² (peak)
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š SLR Results</div>
    <div class="section-content">
      <p>Surface Loading Rate: <span class="result" id="slr_result">-</span> GPD/ftÂ²</p>
      <p>Overflow Rate: <span class="result" id="slr_overflow">-</span> mÂ³/mÂ²/day</p>
    </div>
  </div>
</div>

<!-- 7. Alkalinity Balance Calculator -->
          </div>
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸ”„ RAS Flow Rate - Return Activated Sludge Calculations</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent Flow (MGD)</label>
          <input id="ras_flow" type="number" step="0.1" value="3.5" oninput="calcRAS()">
        </div>
        <div class="input-group">
          <label>RAS Ratio (%)</label>
          <input id="ras_ratio" type="number" step="1" value="75" oninput="calcRAS()">
        </div>
        <div class="input-group">
          <label>MLSS (mg/L)</label>
          <input id="ras_mlss" type="number" step="50" value="2500" oninput="calcRAS()">
        </div>
        <div class="input-group">
          <label>RAS Concentration (mg/L)</label>
          <input id="ras_conc" type="number" step="100" value="8000" oninput="calcRAS()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcRAS()">Calculate RAS</button>
        <button class="btn gray" onclick="resetRAS()">Reset</button>
      </div>
      <div class="note">
        <strong>Typical RAS Ratios:</strong> 25-100% of influent flow. Higher ratios maintain MLSS concentration but increase pumping costs.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š RAS Results</div>
    <div class="section-content">
      <p>RAS Flow Rate: <span class="result" id="ras_result">-</span> MGD</p>
      <p>Required RAS Ratio: <span class="result" id="ras_required">-</span> %</p>
    </div>
  </div>
</div>

<!-- 4. Detention Time Calculator -->
          </div>
        
      


      <!-- Regulatory Compliance Monitor -->
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:var(--shadow-lg)">
        <h3 style="margin:0 0 15px 0;display:flex;align-items:center;gap:10px">
          <span style="font-size:24px">ðŸ“‹</span>
          <span>Regulatory Compliance Status</span>
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px" id="compliance-indicators">
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-bod">--</div>
            <div style="font-size:12px;opacity:0.9">BOD Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-tss">--</div>
            <div style="font-size:12px;opacity:0.9">TSS Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-nh3">--</div>
            <div style="font-size:12px;opacity:0.9">NHâ‚ƒ Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-do">--</div>
            <div style="font-size:12px;opacity:0.9">DO Requirement Met</div>
          </div>
        </div>
      </div>

      <!-- Optimization Recommendations -->
      <div class="collapsible-header" onclick="toggleCollapsible(this)">
        <strong>ðŸ’¡ AI-Powered Optimization Recommendations</strong>
        <span>â–¼</span>
      </div>
      <div class="collapsible-content" id="optimization-recommendations" style="background:var(--bg-note);padding:20px;border-radius:8px;margin-bottom:25px">
        <div id="recommendations-list">
          <p style="color:var(--text-unit);font-style:italic">Run calculations to generate optimization recommendations...</p>
        </div>
      </div>

      <div class="calc-category">
        <div class="calc-category-header" style="cursor: pointer;">ðŸŒŠ Clarifier Calculations</div>
        <div class="calc-grid">
          <div class="calc-item">
<div class="section">
<div class="section-h">ðŸŒŠ Secondary Clarifier</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Clarifier Flow (MGD)</label>
<input id="clar_flow" step="0.1" type="number">
</div>
<div class="input-group">
<label>Clarifier Diameter (ft)</label>
<input id="clar_diam" type="number" value="65">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input id="clar_mlss" type="number">
</div>
<div class="input-group">
<label>RAS Flow (MGD)</label>
<input id="clar_ras_flow" step="0.1" type="number" value="1.0">
</div>
<div class="input-group">
<label>Weir Length (ft)</label>
<input id="clar_weir" type="number" value="204">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcClarifier()">Calculate</button>
<button class="btn gray" onclick="resetClarifier()">Reset</button>
</div>
<table class="table">
<tbody><tr><th>Parameter</th><th>Value</th><th>Unit</th><th>Target</th><th>Status</th></tr>
<tr><td class="rowh">Surface Overflow Rate (SOR)</td><td><span class="result" id="r_sor">-</span></td><td>gpd/ftÂ²</td><td>400-800</td><td><span class="status" id="s_sor">-</span></td></tr>
<tr><td class="rowh">Solids Loading Rate (SLR)</td><td><span class="result" id="r_slr">-</span></td><td>lb/hr/ftÂ²</td><td>&lt; 50</td><td><span class="status" id="s_slr">-</span></td></tr>
<tr><td class="rowh">Weir Overflow Rate (WOR)</td><td><span class="result" id="r_wor">-</span></td><td>gpd/ft</td><td>&lt; 20,000</td><td><span class="status" id="s_wor">-</span></td></tr>
</tbody></table>
<div class="note" id="clarifier_note">Inputs for Flow and MLSS will be auto-filled from other tabs if left blank.</div>
</div>
</div>
</div>
          </div>
        </div>
      


      <!-- Regulatory Compliance Monitor -->
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:var(--shadow-lg)">
        <h3 style="margin:0 0 15px 0;display:flex;align-items:center;gap:10px">
          <span style="font-size:24px">ðŸ“‹</span>
          <span>Regulatory Compliance Status</span>
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px" id="compliance-indicators">
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-bod">--</div>
            <div style="font-size:12px;opacity:0.9">BOD Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-tss">--</div>
            <div style="font-size:12px;opacity:0.9">TSS Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-nh3">--</div>
            <div style="font-size:12px;opacity:0.9">NHâ‚ƒ Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-do">--</div>
            <div style="font-size:12px;opacity:0.9">DO Requirement Met</div>
          </div>
        </div>
      </div>

      <!-- Optimization Recommendations -->
      <div class="collapsible-header" onclick="toggleCollapsible(this)">
        <strong>ðŸ’¡ AI-Powered Optimization Recommendations</strong>
        <span>â–¼</span>
      </div>
      <div class="collapsible-content" id="optimization-recommendations" style="background:var(--bg-note);padding:20px;border-radius:8px;margin-bottom:25px">
        <div id="recommendations-list">
          <p style="color:var(--text-unit);font-style:italic">Run calculations to generate optimization recommendations...</p>
        </div>
      </div>

      <div class="calc-category">
        <div class="calc-category-header" style="cursor: pointer;">ðŸ§¬ Biological Calculations</div>
        <div class="calc-grid">
          <div class="calc-item">
<div class="section">
    <div class="section-h">â³ Sludge Retention Time (SRT) - Enhanced Calculator</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>MLSS (mg/L)</label>
          <input id="srt_enh_mlss" type="number" step="50" value="2500" oninput="calcSRTEnhanced()">
        </div>
        <div class="input-group">
          <label>Aeration Volume (MG)</label>
          <input id="srt_enh_volume" type="number" step="0.01" value="1.2" oninput="calcSRTEnhanced()">
        </div>
        <div class="input-group">
          <label>Effluent TSS (mg/L)</label>
          <input id="srt_enh_eff_tss" type="number" step="1" value="15" oninput="calcSRTEnhanced()">
        </div>
        <div class="input-group">
          <label>Effluent Flow (MGD)</label>
          <input id="srt_enh_eff_flow" type="number" step="0.1" value="3.5" oninput="calcSRTEnhanced()">
        </div>
        <div class="input-group">
          <label>Waste Flow (MGD)</label>
          <input id="srt_enh_waste_flow" type="number" step="0.01" value="0.1" oninput="calcSRTEnhanced()">
        </div>
        <div class="input-group">
          <label>Waste TSS (mg/L)</label>
          <input id="srt_enh_waste_tss" type="number" step="100" value="8000" oninput="calcSRTEnhanced()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcSRTEnhanced()">Calculate SRT</button>
        <button class="btn gray" onclick="resetSRTEnhanced()">Reset</button>
      </div>
      <div class="note">
        <strong>SRT Classifications:</strong> Extended Aeration: 20-30 days, Conventional: 5-15 days, High-Rate: 2-4 days, Contact Stabilization: 5-8 days
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Enhanced SRT Results</div>
    <div class="section-content">
      <p>Sludge Retention Time: <span class="result" id="srt_enh_result">-</span> days</p>
      <p>Process Classification: <span class="result" id="srt_classification">-</span></p>
    </div>
  </div>
</div>

<!-- 14. BOD Efficiency Calculator -->
          </div>
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸ”¬ Sludge Volume Index (SVI) - Settling Characteristics</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>30-min Settled Volume (mL/L)</label>
          <input id="svi_vol" type="number" step="5" value="150" oninput="calcSVICalc()">
        </div>
        <div class="input-group">
          <label>MLSS (mg/L)</label>
          <input id="svi_mlss_calc" type="number" step="50" value="3000" oninput="calcSVICalc()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcSVICalc()">Calculate SVI</button>
        <button class="btn gray" onclick="resetSVICalc()">Reset</button>
      </div>
      <div class="note">
        <strong>SVI Interpretation:</strong> &lt;50: Very poor settling, 50-100: Excellent, 100-150: Good, 150-200: Fair, &gt;200: Poor (bulking likely)
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š SVI Results</div>
    <div class="section-content">
      <p>Sludge Volume Index: <span class="result" id="svi_calc_result">-</span> mL/g</p>
      <p>Sludge Settleability: <span class="result" id="svi_quality">-</span></p>
    </div>
  </div>
</div>

<!-- 16. Nitrogen Balance Calculator -->
          </div>
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸŒ¿ Nitrogen Balance - Nutrient Removal Analysis</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent TKN (mg/L)</label>
          <input id="n_tkn_in" type="number" step="0.5" value="35" oninput="calcNitrogen()">
        </div>
        <div class="input-group">
          <label>Influent NHâ‚ƒ-N (mg/L)</label>
          <input id="n_nh3_in" type="number" step="0.5" value="25" oninput="calcNitrogen()">
        </div>
        <div class="input-group">
          <label>Effluent TKN (mg/L)</label>
          <input id="n_tkn_out" type="number" step="0.1" value="2" oninput="calcNitrogen()">
        </div>
        <div class="input-group">
          <label>Effluent NHâ‚ƒ-N (mg/L)</label>
          <input id="n_nh3_out" type="number" step="0.1" value="0.5" oninput="calcNitrogen()">
        </div>
        <div class="input-group">
          <label>Effluent NOâ‚ƒ-N (mg/L)</label>
          <input id="n_no3_out" type="number" step="0.5" value="8" oninput="calcNitrogen()">
        </div>
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="n_flow" type="number" step="0.1" value="3.5" oninput="calcNitrogen()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcNitrogen()">Calculate N Balance</button>
        <button class="btn gray" onclick="resetNitrogen()">Reset</button>
      </div>
      <div class="note">
        <strong>Regulatory Limits:</strong> Typical effluent limits - TKN: &lt;10 mg/L, NHâ‚ƒ-N: &lt;1-5 mg/L, Total N: &lt;10-15 mg/L depending on permit
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Nitrogen Balance Results</div>
    <div class="section-content">
      <p>TKN Removal Efficiency: <span class="result" id="n_tkn_eff">-</span> %</p>
      <p>NHâ‚ƒ Removal Efficiency: <span class="result" id="n_nh3_eff">-</span> %</p>
      <p>Total N Removed: <span class="result" id="n_total_removed">-</span> lb/day</p>
      <p>Denitrification Efficiency: <span class="result" id="n_denit_eff">-</span> %</p>
    </div>
  </div>
</div>
          
          <div class="calc-item">
<div class="section">
<div class="section-h">ðŸŒ± Nutrient Removal</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Inf NHâ‚ƒ-N (mg/L)</label>
<input id="nh3In" type="number" value="30">
</div>
<div class="input-group">
<label>Eff NHâ‚ƒ-N (mg/L)</label>
<input id="nh3Out" type="number" value="1">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcNutrients()">Calculate</button>
</div>
<table class="table">
<tbody><tr><th>Parameter</th><th>Value</th><th>% Removal</th></tr>
<tr><td class="rowh">Nitrification</td><td><span class="result" id="r_nitrif">-</span> lb/d</td><td><span class="result" id="r_nitrifPct">-</span></td></tr>
</tbody></table>
</div>
</div>
</div>
          
        
      


      <!-- Regulatory Compliance Monitor -->
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:var(--shadow-lg)">
        <h3 style="margin:0 0 15px 0;display:flex;align-items:center;gap:10px">
          <span style="font-size:24px">ðŸ“‹</span>
          <span>Regulatory Compliance Status</span>
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px" id="compliance-indicators">
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-bod">--</div>
            <div style="font-size:12px;opacity:0.9">BOD Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-tss">--</div>
            <div style="font-size:12px;opacity:0.9">TSS Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-nh3">--</div>
            <div style="font-size:12px;opacity:0.9">NHâ‚ƒ Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-do">--</div>
            <div style="font-size:12px;opacity:0.9">DO Requirement Met</div>
          </div>
        </div>
      </div>

      <!-- Optimization Recommendations -->
      <div class="collapsible-header" onclick="toggleCollapsible(this)">
        <strong>ðŸ’¡ AI-Powered Optimization Recommendations</strong>
        <span>â–¼</span>
      </div>
      <div class="collapsible-content" id="optimization-recommendations" style="background:var(--bg-note);padding:20px;border-radius:8px;margin-bottom:25px">
        <div id="recommendations-list">
          <p style="color:var(--text-unit);font-style:italic">Run calculations to generate optimization recommendations...</p>
        </div>
      </div>

      <div class="calc-category">
        <div class="calc-category-header" style="cursor: pointer;">âš—ï¸ Chemical Calculations</div>
        <div class="calc-grid">
          <div class="calc-item">
<div class="section">
    <div class="section-h">âš—ï¸ Alkalinity Balance - pH Buffer Capacity</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent Alkalinity (mg/L as CaCOâ‚ƒ)</label>
          <input id="alk_influent" type="number" step="1" value="180" oninput="calcAlkalinity()">
        </div>
        <div class="input-group">
          <label>Nitrification Rate (mg/L NHâ‚ƒ-N)</label>
          <input id="alk_nitrification" type="number" step="0.1" value="25" oninput="calcAlkalinity()">
        </div>
        <div class="input-group">
          <label>Denitrification Rate (mg/L NOâ‚ƒ-N)</label>
          <input id="alk_denitrification" type="number" step="0.1" value="15" oninput="calcAlkalinity()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcAlkalinity()">Calculate Balance</button>
        <button class="btn gray" onclick="resetAlkalinity()">Reset</button>
      </div>
      <div class="note">
        <strong>Key Points:</strong> 7.14 lb alkalinity consumed per lb NHâ‚ƒ-N nitrified. 3.57 lb alkalinity produced per lb NOâ‚ƒ-N denitrified. Minimum 50 mg/L alkalinity recommended.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Alkalinity Balance Results</div>
    <div class="section-content">
      <p>Alkalinity Consumed: <span class="result" id="alk_consumed">-</span> mg/L as CaCOâ‚ƒ</p>
      <p>Alkalinity Produced: <span class="result" id="alk_produced">-</span> mg/L as CaCOâ‚ƒ</p>
      <p>Net Effluent Alkalinity: <span class="result" id="alk_net">-</span> mg/L as CaCOâ‚ƒ</p>
    </div>
  </div>
</div>

<!-- 8. Oxygen Requirements Calculator -->
          </div>
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸ§ª pH Adjustment - Caustic &amp; Acid Dosing</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="ph_flow" type="number" step="0.1" value="3.5" oninput="calcPH()">
        </div>
        <div class="input-group">
          <label>Current pH</label>
          <input id="ph_current" type="number" step="0.1" value="5.8" oninput="calcPH()">
        </div>
        <div class="input-group">
          <label>Target pH</label>
          <input id="ph_target" type="number" step="0.1" value="7.0" oninput="calcPH()">
        </div>
        <div class="input-group">
          <label>Chemical Type</label>
          <select id="ph_chemical" onchange="calcPH()">
            <option value="naoh">Sodium Hydroxide (NaOH)</option>
            <option value="lime">Lime (CaO)</option>
            <option value="h2so4">Sulfuric Acid (Hâ‚‚SOâ‚„)</option>
            <option value="hcl">Hydrochloric Acid (HCl)</option>
          </select>
        </div>
        <div class="input-group">
          <label>Chemical Strength (%)</label>
          <input id="ph_strength" type="number" step="1" value="50" oninput="calcPH()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcPH()">Calculate</button>
        <button class="btn gray" onclick="resetPH()">Reset</button>
      </div>
      <div class="note warning">
        <strong>Warning:</strong> Actual dosage requirements vary with alkalinity and buffering capacity. Jar testing recommended for accurate dosing.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š pH Adjustment Results</div>
    <div class="section-content">
      <p>Chemical Feed Rate: <span class="result" id="ph_feed">-</span> GPD</p>
      <p>Daily Chemical Usage: <span class="result" id="ph_daily">-</span> lb/day</p>
    </div>
  </div>
</div>

<!-- 12. Chlorine Dosage Calculator -->
          </div>
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸ’Š Polymer Dosage - Chemical Feed Rate Optimization</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Sludge Flow (GPM)</label>
          <input id="poly_flow" type="number" step="1" value="100" oninput="calcPolymer()">
        </div>
        <div class="input-group">
          <label>Sludge TSS (%)</label>
          <input id="poly_tss" type="number" step="0.1" value="2.5" oninput="calcPolymer()">
        </div>
        <div class="input-group">
          <label>Polymer Dose (lb/ton dry solids)</label>
          <input id="poly_dose" type="number" step="0.5" value="10" oninput="calcPolymer()">
        </div>
        <div class="input-group">
          <label>Polymer Concentration (%)</label>
          <input id="poly_conc" type="number" step="0.05" value="0.5" oninput="calcPolymer()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcPolymer()">Calculate Dosage</button>
        <button class="btn gray" onclick="resetPolymer()">Reset</button>
      </div>
      <div class="note">
        <strong>Typical Dosages:</strong> Belt Press: 8-15 lb/ton, Centrifuge: 10-25 lb/ton, Gravity Belt Thickener: 2-6 lb/ton
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Polymer Dosage Results</div>
    <div class="section-content">
      <p>Polymer Feed Rate: <span class="result" id="poly_feed">-</span> GPD</p>
      <p>Daily Polymer Usage: <span class="result" id="poly_daily">-</span> lb/day</p>
    </div>
  </div>
</div>

<!-- 11. pH Adjustment Calculator -->
          
          <div class="calc-item">
<div class="section">
<div class="section-h">ðŸ§ª Chemical Dosing &amp; Inventory</div>
<div class="section-content">
<div class="input-group">
<label>Flow to Dose (MGD)</label>
<input id="dosing_flow" placeholder="Auto-fills from Loading tab" step="0.1" type="number">
</div>
<div class="btns">
<button class="btn green" onclick="calcDosing()">Calculate All Dosing</button>
<button class="btn gray" onclick="resetDosing()">Reset All Dosing</button>
</div>
<div class="tool-grid">
<!-- Ferric Chloride Card -->
<div class="tool-card">
<h3>Ferric Chloride (FeClâ‚ƒ)</h3>
<div class="row">
<div class="input-group"><label>Dose (mg/L)</label><input id="fe_dose" step="1" type="number" value="40"></div>
<div class="input-group"><label>Solution %</label><input id="fe_pct" step="0.1" type="number" value="38"></div>
<div class="input-group"><label>Specific Gravity</label><input id="fe_sg" step="0.01" type="number" value="1.4"></div>
<div class="input-group"><label>Pump Max (gph)</label><input id="fe_pump_max" step="1" type="number" value="20"></div>
</div>
<h4 style="margin-top:10px;">Dosing Results</h4>
<table class="table">
<tbody><tr><td class="rowh">Solution Weight</td><td><span class="result" id="r_fe_sol_wgt">-</span></td><td>lb/gal</td></tr>
<tr><td class="rowh">Chem Feed</td><td><span class="result" id="r_fe_chem_feed">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_fe_gpd">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_fe_gph">-</span></td><td>gal/hr</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_fe_ml_min">-</span></td><td>mL/min</td></tr>
<tr><td class="rowh">Pump Setting</td><td><span class="result" id="r_fe_pump_pct">-</span></td><td>%</td></tr>
</tbody></table>
<h4 style="margin-top:20px;">Inventory</h4>
<div class="input-group"><label>Stock on Hand (gallons)</label><input id="fe_stock_gal" type="number" value="5000"></div>
<table class="table">
<tbody><tr><td class="rowh">Usage</td><td><span class="result" id="r_fe_usage_gpd">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Days Left</td><td><span class="result" id="r_fe_days_left">-</span></td><td>days</td></tr>
<tr><td class="rowh">Status</td><td><span class="status" id="s_fe_status">-</span></td><td>-</td></tr>
</tbody></table>
</div>
<!-- Aluminum Sulfate (Alum) Card -->
<div class="tool-card">
<h3>Aluminum Sulfate (Alum)</h3>
<div class="row">
<div class="input-group"><label>Dose (mg/L)</label><input id="al_dose" step="1" type="number" value="100"></div>
<div class="input-group"><label>Solution %</label><input id="al_pct" step="0.1" type="number" value="48.5"></div>
<div class="input-group"><label>Specific Gravity</label><input id="al_sg" step="0.01" type="number" value="1.33"></div>
<div class="input-group"><label>Pump Max (gph)</label><input id="al_pump_max" step="1" type="number" value="40"></div>
</div>
<h4 style="margin-top:10px;">Dosing Results</h4>
<table class="table">
<tbody><tr><td class="rowh">Solution Weight</td><td><span class="result" id="r_al_sol_wgt">-</span></td><td>lb/gal</td></tr>
<tr><td class="rowh">Chem Feed</td><td><span class="result" id="r_al_chem_feed">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_al_gpd">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_al_gph">-</span></td><td>gal/hr</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_al_ml_min">-</span></td><td>mL/min</td></tr>
<tr><td class="rowh">Pump Setting</td><td><span class="result" id="r_al_pump_pct">-</span></td><td>%</td></tr>
</tbody></table>
<h4 style="margin-top:20px;">Inventory</h4>
<div class="input-group"><label>Stock on Hand (gallons)</label><input id="al_stock_gal" type="number" value="8000"></div>
<table class="table">
<tbody><tr><td class="rowh">Usage</td><td><span class="result" id="r_al_usage_gpd">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Days Left</td><td><span class="result" id="r_al_days_left">-</span></td><td>days</td></tr>
<tr><td class="rowh">Status</td><td><span class="status" id="s_al_status">-</span></td><td>-</td></tr>
</tbody></table>
</div>
</div>
</div>
</div>
</div>
          
          <div class="calc-item">
<div class="section">
    <div class="section-h">â˜£ï¸ Chlorine Dosage - Disinfection Requirements</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="cl_flow" type="number" step="0.1" value="3.5" oninput="calcChlorine()">
        </div>
        <div class="input-group">
          <label>Chlorine Dose (mg/L)</label>
          <input id="cl_dose" type="number" step="0.5" value="8" oninput="calcChlorine()">
        </div>
        <div class="input-group">
          <label>Chlorine Type</label>
          <select id="cl_type" onchange="calcChlorine()">
            <option value="gas">Chlorine Gas (Clâ‚‚)</option>
            <option value="hypo">Sodium Hypochlorite (12.5%)</option>
            <option value="bleach">Bleach (5.25%)</option>
            <option value="tablet">Calcium Hypochlorite (65%)</option>
          </select>
        </div>
        <div class="input-group">
          <label>Contact Time (min)</label>
          <input id="cl_time" type="number" step="1" value="30" oninput="calcChlorine()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcChlorine()">Calculate</button>
        <button class="btn gray" onclick="resetChlorine()">Reset</button>
      </div>
      <div class="note">
        <strong>CT Requirements:</strong> 0.5 log removal: CT=0.4, 1.0 log removal: CT=0.8, 2.0 log removal: CT=1.6, 3.0 log removal: CT=2.4
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Chlorine Dosage Results</div>
    <div class="section-content">
      <p>Chemical Feed Rate: <span class="result" id="cl_feed">-</span> <span id="cl_unit">lb/day</span></p>
      <p>CT Value: <span class="result" id="cl_ct">-</span> mgÂ·min/L</p>
      <p>Daily Cost (@$2.50/gal): <span class="result" id="cl_cost">-</span> $/day</p>
    </div>
  </div>
</div>

<!-- 13. Enhanced SRT Calculator -->
          
        
      


      <!-- Regulatory Compliance Monitor -->
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:var(--shadow-lg)">
        <h3 style="margin:0 0 15px 0;display:flex;align-items:center;gap:10px">
          <span style="font-size:24px">ðŸ“‹</span>
          <span>Regulatory Compliance Status</span>
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px" id="compliance-indicators">
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-bod">--</div>
            <div style="font-size:12px;opacity:0.9">BOD Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-tss">--</div>
            <div style="font-size:12px;opacity:0.9">TSS Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-nh3">--</div>
            <div style="font-size:12px;opacity:0.9">NHâ‚ƒ Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-do">--</div>
            <div style="font-size:12px;opacity:0.9">DO Requirement Met</div>
          </div>
        </div>
      </div>

      <!-- Optimization Recommendations -->
      <div class="collapsible-header" onclick="toggleCollapsible(this)">
        <strong>ðŸ’¡ AI-Powered Optimization Recommendations</strong>
        <span>â–¼</span>
      </div>
      <div class="collapsible-content" id="optimization-recommendations" style="background:var(--bg-note);padding:20px;border-radius:8px;margin-bottom:25px">
        <div id="recommendations-list">
          <p style="color:var(--text-unit);font-style:italic">Run calculations to generate optimization recommendations...</p>
        </div>
      </div>

      <div class="calc-category">
        <div class="calc-category-header" style="cursor: pointer;">ðŸ’¨ Aeration Calculations</div>
        <div class="calc-grid">
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸ’¨ Oxygen Requirements - Aeration Needs Calculation</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>BOD Removed (lb/day)</label>
          <input id="o2_bod" type="number" step="1" value="5835" oninput="calcOxygenReq()">
        </div>
        <div class="input-group">
          <label>NHâ‚ƒ-N Oxidized (lb/day)</label>
          <input id="o2_nh3" type="number" step="1" value="730" oninput="calcOxygenReq()">
        </div>
        <div class="input-group">
          <label>Endogenous Respiration Factor</label>
          <input id="o2_endo" type="number" step="0.01" value="0.12" oninput="calcOxygenReq()">
        </div>
        <div class="input-group">
          <label>MLSS (mg/L)</label>
          <input id="o2_mlss" type="number" step="50" value="2500" oninput="calcOxygenReq()">
        </div>
        <div class="input-group">
          <label>Aeration Volume (MG)</label>
          <input id="o2_volume" type="number" step="0.01" value="1.2" oninput="calcOxygenReq()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcOxygenReq()">Calculate Oâ‚‚</button>
        <button class="btn gray" onclick="resetOxygenReq()">Reset</button>
      </div>
      <div class="note">
        <strong>Formula:</strong> Oâ‚‚ = 1.0Ã—BOD_removed + 4.57Ã—NHâ‚ƒ-N_oxidized - 1.42Ã—Biomass_produced + Endogenous_respiration
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Oxygen Requirements Results</div>
    <div class="section-content">
      <p>Total Oxygen Required: <span class="result" id="o2_total">-</span> lb Oâ‚‚/day</p>
      <p>Oxygen Rate: <span class="result" id="o2_rate">-</span> lb Oâ‚‚/hr</p>
    </div>
  </div>
</div>

<!-- 9. Air Requirements Calculator -->
          </div>
          <div class="calc-item">
<div class="section">
    <div class="section-h">ðŸŒ¬ï¸ Air Requirements - Blower Sizing &amp; Capacity</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Oxygen Required (lb/hr)</label>
          <input id="air_o2" type="number" step="1" value="450" oninput="calcAir()">
        </div>
        <div class="input-group">
          <label>Oxygen Transfer Efficiency (%)</label>
          <input id="air_ote" type="number" step="0.5" value="12" oninput="calcAir()">
        </div>
        <div class="input-group">
          <label>Diffuser Depth (ft)</label>
          <input id="air_depth" type="number" step="0.5" value="15" oninput="calcAir()">
        </div>
        <div class="input-group">
          <label>Temperature (Â°C)</label>
          <input id="air_temp" type="number" step="1" value="20" oninput="calcAir()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcAir()">Calculate Air</button>
        <button class="btn gray" onclick="resetAir()">Reset</button>
      </div>
      <div class="note">
        <strong>Design Note:</strong> Air contains 23.2% oxygen by weight. Add 15-25% safety factor for actual blower sizing.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Air Requirements Results</div>
    <div class="section-content">
      <p>Air Flow Required: <span class="result" id="air_scfm">-</span> SCFM</p>
      <p>Blower HP Required: <span class="result" id="air_hp">-</span> HP</p>
    </div>
  </div>
</div>

<!-- 10. Polymer Dosage Calculator -->
          </div>
        
      


      <!-- Regulatory Compliance Monitor -->
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:var(--shadow-lg)">
        <h3 style="margin:0 0 15px 0;display:flex;align-items:center;gap:10px">
          <span style="font-size:24px">ðŸ“‹</span>
          <span>Regulatory Compliance Status</span>
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px" id="compliance-indicators">
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-bod">--</div>
            <div style="font-size:12px;opacity:0.9">BOD Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-tss">--</div>
            <div style="font-size:12px;opacity:0.9">TSS Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-nh3">--</div>
            <div style="font-size:12px;opacity:0.9">NHâ‚ƒ Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-do">--</div>
            <div style="font-size:12px;opacity:0.9">DO Requirement Met</div>
          </div>
        </div>
      </div>

      <!-- Optimization Recommendations -->
      <div class="collapsible-header" onclick="toggleCollapsible(this)">
        <strong>ðŸ’¡ AI-Powered Optimization Recommendations</strong>
        <span>â–¼</span>
      </div>
      <div class="collapsible-content" id="optimization-recommendations" style="background:var(--bg-note);padding:20px;border-radius:8px;margin-bottom:25px">
        <div id="recommendations-list">
          <p style="color:var(--text-unit);font-style:italic">Run calculations to generate optimization recommendations...</p>
        </div>
      </div>

      <div class="calc-category">
        <div class="calc-category-header" style="cursor: pointer;">ðŸ§± Solids Calculations</div>
        <div class="calc-grid">
          <div class="calc-item">
<div class="section">
<div class="section-h">ðŸ§‘â€ðŸ”¬ Anaerobic Digester</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Influent VS (lb/d)</label>
<input id="dig_vs_in" type="number" value="4500">
</div>
<div class="input-group">
<label>Effluent VS (lb/d)</label>
<input id="dig_vs_out" type="number" value="2000">
</div>
<div class="input-group">
<label>Digester Volume (MG)</label>
<input id="dig_vol_mg" step="0.01" type="number" value="0.75">
</div>
<div class="input-group">
<label>VS Biogas Yield (cf/lb VS destroyed)</label>
<input id="dig_yield" step="1" type="number" value="15">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcDigester()">Calculate</button>
<button class="btn gray" onclick="resetDigester()">Reset</button>
</div>
<table class="table">
<tbody><tr><th>Parameter</th><th>Value</th><th>Unit</th><th>Target</th><th>Status</th></tr>
<tr><td class="rowh">VS Destroyed</td><td><span class="result" id="r_vs_destroyed">-</span></td><td>lb/d</td><td>-</td><td>-</td></tr>
<tr><td class="rowh">Volatile Solids Reduction (VSR)</td><td><span class="result" id="r_vsr">-</span></td><td>%</td><td>&gt; 50%</td><td><span class="status" id="s_vsr">-</span></td></tr>
<tr><td class="rowh">Digester Loading Rate</td><td><span class="result" id="r_loading_rate">-</span></td><td>lb/cf/d</td><td>0.15-0.35</td><td><span class="status" id="s_loading_rate">-</span></td></tr>
<tr><td class="rowh">Estimated Biogas</td><td><span class="result" id="r_biogas">-</span></td><td>cf/day</td><td>-</td><td>-</td></tr>
</tbody></table>
<div class="note" id="digester_note">Influent VS (lb/d) is the total volatile solids being fed to the digester, often from a thickener.</div>
</div>
</div>
</div>
          </div>
          <div class="calc-item">
<div class="section">
<div class="section-h">ðŸ§± Solids Dewatering</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Sludge Feed Flow (gpm)</label>
<input id="dew_feed_flow" type="number" value="100">
</div>
<div class="input-group">
<label>Sludge Feed Solids (%)</label>
<input id="dew_feed_solids" step="0.1" type="number" value="3.0">
</div>
<div class="input-group">
<label>Polymer Feed (gph)</label>
<input id="dew_poly_flow" step="1" type="number" value="20">
</div>
<div class="input-group">
<label>Polymer Concentration (%)</label>
<input id="dew_poly_conc" step="0.1" type="number" value="0.5">
</div>
<div class="input-group">
<label>Cake Solids (%)</label>
<input id="dew_cake_solids" step="0.5" type="number" value="18">
</div>
<div class="input-group">
<label>Filtrate TSS (mg/L)</label>
<input id="dew_filtrate_tss" type="number" value="500">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcDewatering()">Calculate</button>
<button class="btn gray" onclick="resetDewatering()">Reset</button>
</div>
<table class="table">
<tbody><tr><th>Parameter</th><th>Value</th><th>Unit</th><th>Target</th><th>Status</th></tr>
<tr><td class="rowh">Dry Solids In</td><td><span class="result" id="r_dry_solids_in">-</span></td><td>lb/hr</td><td>-</td><td>-</td></tr>
<tr><td class="rowh">Polymer Dose</td><td><span class="result" id="r_poly_dose">-</span></td><td>lb/ton</td><td>15-30</td><td><span class="status" id="s_poly_dose">-</span></td></tr>
<tr><td class="rowh">Solids Capture Rate</td><td><span class="result" id="r_solids_capture">-</span></td><td>%</td><td>&gt; 95%</td><td><span class="status" id="s_solids_capture">-</span></td></tr>
<tr><td class="rowh">Cake Production</td><td><span class="result" id="r_cake_prod">-</span></td><td>wet ton/d</td><td>-</td><td>-</td></tr>
</tbody></table>
<div class="note" id="dewatering_note">Assumes polymer specific gravity of 1.0.</div>
</div>
</div>
</div>
          </div>
        
      


      <!-- Regulatory Compliance Monitor -->
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:var(--shadow-lg)">
        <h3 style="margin:0 0 15px 0;display:flex;align-items:center;gap:10px">
          <span style="font-size:24px">ðŸ“‹</span>
          <span>Regulatory Compliance Status</span>
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px" id="compliance-indicators">
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-bod">--</div>
            <div style="font-size:12px;opacity:0.9">BOD Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-tss">--</div>
            <div style="font-size:12px;opacity:0.9">TSS Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-nh3">--</div>
            <div style="font-size:12px;opacity:0.9">NHâ‚ƒ Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-do">--</div>
            <div style="font-size:12px;opacity:0.9">DO Requirement Met</div>
          </div>
        </div>
      </div>

      <!-- Optimization Recommendations -->
      <div class="collapsible-header" onclick="toggleCollapsible(this)">
        <strong>ðŸ’¡ AI-Powered Optimization Recommendations</strong>
        <span>â–¼</span>
      </div>
      <div class="collapsible-content" id="optimization-recommendations" style="background:var(--bg-note);padding:20px;border-radius:8px;margin-bottom:25px">
        <div id="recommendations-list">
          <p style="color:var(--text-unit);font-style:italic">Run calculations to generate optimization recommendations...</p>
        </div>
      </div>

      <div class="calc-category">
        <div class="calc-category-header" style="cursor: pointer;">ðŸ’§ Disinfection Calculations</div>
        <div class="calc-grid">
          <div class="calc-item">
<div class="section">
<div class="section-h">ðŸ’§ Disinfection (Chlorine)</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Flow (MGD)</label>
<input id="dis_flow" step="0.1" type="number">
</div>
<div class="input-group">
<label>Contactor Volume (Gallons)</label>
<input id="dis_vol" type="number" value="70000">
</div>
<div class="input-group">
<label>Chlorine Dose (mg/L)</label>
<input id="dis_dose" step="0.1" type="number" value="8.0">
</div>
<div class="input-group">
<label>Chlorine Residual (mg/L)</label>
<input id="dis_residual" step="0.1" type="number" value="1.5">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcDisinfection()">Calculate</button>
<button class="btn gray" onclick="resetDisinfection()">Reset</button>
</div>
<table class="table">
<tbody><tr><th>Parameter</th><th>Value</th><th>Unit</th><th>Target</th><th>Status</th></tr>
<tr><td class="rowh">Detention Time</td><td><span class="result" id="r_detention_time">-</span></td><td>min</td><td>&gt; 30</td><td><span class="status" id="s_detention_time">-</span></td></tr>
<tr><td class="rowh">Chlorine Demand</td><td><span class="result" id="r_cl2_demand">-</span></td><td>mg/L</td><td>-</td><td>-</td></tr>
<tr><td class="rowh">CT Value</td><td><span class="result" id="r_ct_value">-</span></td><td>mg-min/L</td><td>&gt; 40</td><td><span class="status" id="s_ct_value">-</span></td></tr>
</tbody></table>
<div class="note" id="disinfection_note">Flow will be auto-filled from Loading tab. CT Value is critical for pathogen inactivation.</div>
</div>
</div>
</div>
          </div>
        </div>
      


      <!-- Regulatory Compliance Monitor -->
      <div style="background:linear-gradient(135deg,#10b981,#059669);color:white;padding:20px;border-radius:12px;margin-bottom:25px;box-shadow:var(--shadow-lg)">
        <h3 style="margin:0 0 15px 0;display:flex;align-items:center;gap:10px">
          <span style="font-size:24px">ðŸ“‹</span>
          <span>Regulatory Compliance Status</span>
        </h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px" id="compliance-indicators">
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-bod">--</div>
            <div style="font-size:12px;opacity:0.9">BOD Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-tss">--</div>
            <div style="font-size:12px;opacity:0.9">TSS Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-nh3">--</div>
            <div style="font-size:12px;opacity:0.9">NHâ‚ƒ Permit Compliance</div>
          </div>
          <div style="background:rgba(255,255,255,0.2);padding:15px;border-radius:8px;backdrop-filter:blur(10px)">
            <div style="font-size:24px;font-weight:700" id="compliance-do">--</div>
            <div style="font-size:12px;opacity:0.9">DO Requirement Met</div>
          </div>
        </div>
      </div>

      <!-- Optimization Recommendations -->
      <div class="collapsible-header" onclick="toggleCollapsible(this)">
        <strong>ðŸ’¡ AI-Powered Optimization Recommendations</strong>
        <span>â–¼</span>
      </div>
      <div class="collapsible-content" id="optimization-recommendations" style="background:var(--bg-note);padding:20px;border-radius:8px;margin-bottom:25px">
        <div id="recommendations-list">
          <p style="color:var(--text-unit);font-style:italic">Run calculations to generate optimization recommendations...</p>
        </div>
      </div>

      <div class="calc-category">
        <div class="calc-category-header" style="cursor: pointer;">â›½ Pumping Calculations</div>
        <div class="calc-grid">
          <div class="calc-item">
<div class="section">
<div class="section-h">â›½ Pumping &amp; Hydraulics</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Pump Flow (gpm)</label>
<input id="pump_flow" type="number" value="1000">
</div>
<div class="input-group">
<label>Total Dynamic Head (ft)</label>
<input id="pump_head" type="number" value="50">
</div>
<div class="input-group">
<label>Pump Efficiency (%)</label>
<input id="pump_eff" step="1" type="number" value="75">
</div>
<div class="input-group">
<label>Motor Efficiency (%)</label>
<input id="motor_eff" step="1" type="number" value="90">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPumping()">Calculate</button>
<button class="btn gray" onclick="resetPumping()">Reset</button>
</div>
<table class="table">
<tbody><tr><th>Parameter</th><th>Value</th><th>Unit</th></tr>
<tr><td class="rowh">Water Horsepower (WHP)</td><td><span class="result" id="r_whp">-</span></td><td>hp</td></tr>
<tr><td class="rowh">Brake Horsepower (BHP)</td><td><span class="result" id="r_bhp">-</span></td><td>hp</td></tr>
<tr><td class="rowh">Wire-to-Water HP</td><td><span class="result" id="r_wire_hp">-</span></td><td>hp</td></tr>
<tr><td class="rowh">Power Consumption</td><td><span class="result" id="r_power_kw">-</span></td><td>kW</td></tr>
<tr><td class="rowh">Daily Energy Cost</td><td><span class="result" id="r_pump_cost">-</span></td><td>$/day</td></tr>
</tbody></table>
<div class="note" id="pumping_note">Uses Cost per kWh from header. Assumes specific gravity of 1.0.</div>
</div>
</div>
</div>
<!-- END Process Calculations Panel -->

<!-- Diagnostics Panel -->
<div class="panel" id="diagnostics">
<div class="section">
<div class="section-h">ðŸ©º System Diagnostics</div>
<div class="section-content">
<div class="btns">
<button class="btn green" onclick="runDiagnostics()">ðŸ” Run Diagnostics</button>
</div>
<div class="gauge good" id="healthGauge">
<div><div style="font-size:0.4em">Health</div>95<div style="font-size:0.3em">/100</div></div>
</div>
<div id="diagOut">
<div class="note">Click "Run Diagnostics" to analyze system health.</div>
</div>
</div>
</div>
</div>
<!-- END Diagnostics Panel -->

<!-- Multi-Plant Panel -->
<div class="panel" id="multiplant">
<div class="section">
<div class="section-h">ðŸ­ Multi-Plant Dashboard â€¢ <span id="mp-managing">Managing 0 facilities</span> â€¢ Total capacity: <span id="mp-total-cap">0</span> MGD</div>
<div class="section-content">
<div class="btns" style="margin-bottom:20px">
<button class="btn green" onclick="showAddPlantModal()">âž• Add New Plant</button>
<button class="btn blue" onclick="importPlants()">ðŸ“¥ Import Plants</button>
<button class="btn orange" onclick="exportPlantData()">ðŸ“¤ Export Plant Data</button>
<button class="btn purple" onclick="optimizeFleet()">âœ¨ Optimize Fleet</button>
</div>

<!-- Fleet Statistics Summary -->
<div class="kpi-grid" style="margin-bottom:20px">
<div class="kpi-card" style="background:linear-gradient(135deg,#667eea,#764ba2)">
<h4 style="color:rgba(255,255,255,0.8)">Total Plants</h4>
<p id="mp-totalPlants" style="color:#fff;font-size:28px">0</p>
</div>
<div class="kpi-card" style="background:linear-gradient(135deg,#4facfe,#00f2fe)">
<h4 style="color:rgba(255,255,255,0.8)">Total Capacity</h4>
<p id="mp-totalCapacity" style="color:#fff;font-size:28px">0</p>
<div class="small" style="color:rgba(255,255,255,0.7)">MGD</div>
</div>
<div class="kpi-card" style="background:linear-gradient(135deg,#11998e,#38ef7d)">
<h4 style="color:rgba(255,255,255,0.8)">Online Plants</h4>
<p id="mp-onlinePlants" style="color:#fff;font-size:28px">0</p>
</div>
<div class="kpi-card" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
<h4 style="color:rgba(255,255,255,0.8)">Avg Efficiency</h4>
<p id="mp-avgEfficiency" style="color:#fff;font-size:28px">0%</p>
</div>
</div>

<!-- Plant Facility Cards -->
<div id="plantCardsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-bottom:24px"></div>

<!-- Fleet Statistics Chart -->
<div class="section" style="margin-top:20px">
<div class="section-h">ðŸ“Š Fleet Statistics</div>
<div class="section-content">
<div style="height:250px;background:var(--bg-section);border-radius:12px;padding:16px">
<canvas id="fleetChart"></canvas>
</div>
</div>
</div>

<!-- Plant Details Table -->
<div class="section" style="margin-top:20px">
<div class="section-h">ðŸ“‹ Plant Details</div>
<div class="section-content" style="overflow-x:auto">
<table id="plantDetailsTable" style="width:100%;border-collapse:collapse;font-size:14px">
<thead>
<tr style="background:var(--bg-table-th)">
<th style="padding:12px;text-align:left;border-bottom:2px solid var(--border)">Plant Name</th>
<th style="padding:12px;text-align:left;border-bottom:2px solid var(--border)">Location</th>
<th style="padding:12px;text-align:center;border-bottom:2px solid var(--border)">Capacity (MGD)</th>
<th style="padding:12px;text-align:center;border-bottom:2px solid var(--border)">Flow (MGD)</th>
<th style="padding:12px;text-align:center;border-bottom:2px solid var(--border)">Efficiency (%)</th>
<th style="padding:12px;text-align:center;border-bottom:2px solid var(--border)">Status</th>
<th style="padding:12px;text-align:center;border-bottom:2px solid var(--border)">Actions</th>
</tr>
</thead>
<tbody id="plantTableBody">
<tr><td colspan="7" style="padding:20px;text-align:center;color:var(--text-unit)">No plants added yet. Click "Add New Plant" to get started.</td></tr>
</tbody>
</table>
</div>
</div>

</div>
</div>

<!-- Add/Edit Plant Modal -->
<div id="plantModal" class="mp-modal" style="display:none">
<div class="mp-modal-overlay" onclick="closePlantModal()"></div>
<div class="mp-modal-content">
<div class="mp-modal-header">
<h3 id="plantModalTitle">Add New Plant</h3>
<button class="mp-modal-close" onclick="closePlantModal()">Ã—</button>
</div>
<div class="mp-modal-body">
<div class="mp-form-group">
<label>Plant Name *</label>
<input type="text" id="plant-name" placeholder="e.g., North Facility">
</div>
<div class="mp-form-group">
<label>Location *</label>
<input type="text" id="plant-location" placeholder="e.g., 123 Water St, City, State">
</div>
<div class="mp-form-row">
<div class="mp-form-group">
<label>Capacity (MGD) *</label>
<input type="number" id="plant-capacity" value="5.0" step="0.1">
</div>
<div class="mp-form-group">
<label>Current Flow (MGD) *</label>
<input type="number" id="plant-flow" value="4.2" step="0.1">
</div>
</div>
<div class="mp-form-row">
<div class="mp-form-group">
<label>Efficiency (%) *</label>
<input type="number" id="plant-efficiency" value="95.5" step="0.1" min="0" max="100">
</div>
<div class="mp-form-group">
<label>Status *</label>
<select id="plant-status">
<option value="online">âœ“ Online</option>
<option value="degraded">âš  Degraded</option>
<option value="offline">âœ— Offline</option>
<option value="maintenance">ðŸ”§ Maintenance</option>
</select>
</div>
</div>
<div class="mp-form-group">
<label>Operator In Charge</label>
<input type="text" id="plant-operator" placeholder="e.g., John Doe">
</div>
<div class="mp-form-group">
<label>Notes</label>
<textarea id="plant-notes" rows="3" placeholder="Additional information about this facility..."></textarea>
</div>
</div>
<div class="mp-modal-footer">
<button class="btn green" onclick="savePlant()">ðŸ’¾ Save Plant</button>
<button class="btn gray" onclick="closePlantModal()">Cancel</button>
</div>
</div>
</div>

<style>
/* Multi-Plant Modal Styles */
.mp-modal{position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000;display:flex;align-items:center;justify-content:center}
.mp-modal-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px)}
.mp-modal-content{position:relative;background:linear-gradient(145deg,#3a7bd5,#1e4d8c);border-radius:16px;width:90%;max-width:550px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.4);animation:slideInUp 0.3s ease}
.mp-modal-header{display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.1)}
.mp-modal-header h3{color:#fff;font-size:20px;margin:0}
.mp-modal-close{background:none;border:none;color:#fff;font-size:28px;cursor:pointer;padding:0;line-height:1;opacity:0.8;transition:opacity 0.2s}
.mp-modal-close:hover{opacity:1}
.mp-modal-body{padding:24px}
.mp-modal-footer{padding:16px 24px;border-top:1px solid rgba(255,255,255,0.1);display:flex;gap:12px;justify-content:flex-start}
.mp-form-group{margin-bottom:16px}
.mp-form-group label{display:block;color:rgba(255,255,255,0.9);font-size:14px;font-weight:500;margin-bottom:6px}
.mp-form-group input,.mp-form-group select,.mp-form-group textarea{width:100%;padding:12px 14px;border:1px solid rgba(255,255,255,0.2);border-radius:8px;background:rgba(255,255,255,0.9);color:#1a1a2e;font-size:15px;transition:all 0.2s}
.mp-form-group input:focus,.mp-form-group select:focus,.mp-form-group textarea:focus{outline:none;border-color:#4facfe;box-shadow:0 0 0 3px rgba(79,172,254,0.2)}
.mp-form-group input::placeholder,.mp-form-group textarea::placeholder{color:#6c757d}
.mp-form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:500px){.mp-form-row{grid-template-columns:1fr}}

/* Plant Facility Card Styles */
.plant-card{background:linear-gradient(145deg,#2d5a87,#1a3a5c);border-radius:16px;padding:20px;color:#fff;position:relative;overflow:hidden;transition:transform 0.2s,box-shadow 0.2s}
.plant-card:hover{transform:translateY(-4px);box-shadow:0 12px 40px rgba(0,0,0,0.3)}
.plant-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.plant-card-name{font-size:14px;font-weight:600;text-transform:uppercase;color:rgba(255,255,255,0.7);letter-spacing:0.5px}
.plant-card-status{font-size:12px;padding:4px 10px;border-radius:20px;font-weight:500}
.plant-card-status.online{background:rgba(74,222,128,0.2);color:#4ade80}
.plant-card-status.degraded{background:rgba(251,191,36,0.2);color:#fbbf24}
.plant-card-status.offline{background:rgba(248,113,113,0.2);color:#f87171}
.plant-card-status.maintenance{background:rgba(147,197,253,0.2);color:#93c5fd}
.plant-card-flow{font-size:36px;font-weight:700;margin:8px 0}
.plant-card-flow span{font-size:16px;font-weight:400;opacity:0.8}
.plant-card-meta{font-size:13px;color:rgba(255,255,255,0.6);display:flex;align-items:center;gap:6px}
.plant-card-efficiency{position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(255,255,255,0.1)}
.plant-card-efficiency-bar{height:100%;background:linear-gradient(90deg,#4ade80,#22d3ee);transition:width 0.5s ease}
</style>
</div>
<!-- END Multi-Plant Panel -->

<!-- SRT Panel -->
<div class="panel" id="srt">
  <div class="section">
    <div class="section-h">â±ï¸ Sludge Age (SRT) Calculator</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>MLSS (mg/L)</label>
          <input id="srt_mlss" type="number" step="1" value="2500">
        </div>
        <div class="input-group">
          <label>Aeration Volume (MG)</label>
          <input id="srt_volume" type="number" step="0.01" value="1.2">
        </div>
        <div class="input-group">
          <label>Effluent TSS (mg/L)</label>
          <input id="srt_eff_tss" type="number" step="1" value="15">
        </div>
        <div class="input-group">
          <label>Effluent Flow (MGD)</label>
          <input id="srt_eff_flow" type="number" step="0.01" value="3.5">
        </div>
        <div class="input-group">
          <label>Waste Sludge Flow (MGD)</label>
          <input id="srt_waste_flow" type="number" step="0.01" value="0.1">
        </div>
        <div class="input-group">
          <label>Waste Sludge Conc. (mg/L)</label>
          <input id="srt_waste_tss" type="number" step="10" value="8000">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcSRT()">Calculate SRT</button>
        <button class="btn gray" onclick="resetSRT()">Reset</button>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š SRT Result</div>
    <div class="section-content">
      <p>Solids Retention Time (SRT): <span id="srt_result">-</span> days</p>
    </div>
  </div>
</div>
<div class="panel" id="bodeff">
  <div class="section">
    <div class="section-h">ðŸ“‰ BOD Removal Efficiency</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent BOD (mg/L)</label>
          <input id="bod_eff_in" type="number" step="1" value="200">
        </div>
        <div class="input-group">
          <label>Effluent BOD (mg/L)</label>
          <input id="bod_eff_out" type="number" step="1" value="10">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcBODEff()">Calculate Efficiency</button>
        <button class="btn gray" onclick="resetBODEff()">Reset</button>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š BOD Efficiency Result</div>
    <div class="section-content">
      <p>Removal Efficiency: <span id="bod_eff_result">-</span>%</p>
    </div>
  </div>
</div>
<div class="panel" id="svi">
  <div class="section">
    <div class="section-h">ðŸ§ª Sludge Volume Index (SVI)</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Settled Sludge Volume (mL/L)</label>
          <input id="svi_volume" type="number" step="1" value="150">
        </div>
        <div class="input-group">
          <label>MLSS (mg/L)</label>
          <input id="svi_mlss" type="number" step="1" value="3000">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcSVI()">Calculate SVI</button>
        <button class="btn gray" onclick="resetSVI()">Reset</button>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š SVI Result</div>
    <div class="section-content">
      <p>Sludge Volume Index (SVI): <span id="svi_result">-</span> mL/g</p>
    </div>
  </div>
</div>

<!-- NEW ADVANCED CALCULATORS -->

<!-- 1. OLR Calculator -->
<div class="panel" id="olr">
  <div class="section">
    <div class="section-h">ðŸ§« Organic Loading Rate (OLR) - Process Loading Analysis</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent BOD (mg/L)</label>
          <input id="olr_bod" type="number" step="1" value="200" oninput="calcOLR()">
        </div>
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="olr_flow" type="number" step="0.1" value="3.5" oninput="calcOLR()">
        </div>
        <div class="input-group">
          <label>Aeration Tank Volume (MG)</label>
          <input id="olr_volume" type="number" step="0.01" value="1.2" oninput="calcOLR()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcOLR()">Calculate OLR</button>
        <button class="btn gray" onclick="resetOLR()">Reset</button>
      </div>
      <div class="note">
        <strong>Typical Ranges:</strong> Conventional Activated Sludge: 20-40 lb/day/1000 ftÂ³, Extended Aeration: 5-15 lb/day/1000 ftÂ³, High-Rate: 40-80 lb/day/1000 ftÂ³
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š OLR Result</div>
    <div class="section-content">
      <p>Organic Loading Rate: <span class="result" id="olr_result">-</span> lb BOD/day/1000 ftÂ³</p>
    </div>
  </div>
</div>

<!-- 2. VLR Calculator -->
<div class="panel" id="vlr">
  <div class="section">
    <div class="section-h">ðŸ“¦ Volumetric Loading Rate (VLR) - Volume-Based Loading</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent BOD (mg/L)</label>
          <input id="vlr_bod" type="number" step="1" value="180" oninput="calcVLR()">
        </div>
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="vlr_flow" type="number" step="0.1" value="3.5" oninput="calcVLR()">
        </div>
        <div class="input-group">
          <label>Reactor Volume (MG)</label>
          <input id="vlr_volume" type="number" step="0.01" value="1.0" oninput="calcVLR()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcVLR()">Calculate VLR</button>
        <button class="btn gray" onclick="resetVLR()">Reset</button>
      </div>
      <div class="note">
        <strong>Design Guidelines:</strong> VLR helps determine reactor sizing and process efficiency. Lower VLR typically indicates better treatment performance.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š VLR Result</div>
    <div class="section-content">
      <p>Volumetric Loading Rate: <span class="result" id="vlr_result">-</span> lb BOD/day/MG</p>
    </div>
  </div>
</div>

<!-- 3. RAS Flow Rate Calculator -->
<div class="panel" id="ras">
  <div class="section">
    <div class="section-h">ðŸ”„ RAS Flow Rate - Return Activated Sludge Calculations</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent Flow (MGD)</label>
          <input id="ras_flow" type="number" step="0.1" value="3.5" oninput="calcRAS()">
        </div>
        <div class="input-group">
          <label>RAS Ratio (%)</label>
          <input id="ras_ratio" type="number" step="1" value="75" oninput="calcRAS()">
        </div>
        <div class="input-group">
          <label>MLSS (mg/L)</label>
          <input id="ras_mlss" type="number" step="50" value="2500" oninput="calcRAS()">
        </div>
        <div class="input-group">
          <label>RAS Concentration (mg/L)</label>
          <input id="ras_conc" type="number" step="100" value="8000" oninput="calcRAS()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcRAS()">Calculate RAS</button>
        <button class="btn gray" onclick="resetRAS()">Reset</button>
      </div>
      <div class="note">
        <strong>Typical RAS Ratios:</strong> 25-100% of influent flow. Higher ratios maintain MLSS concentration but increase pumping costs.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š RAS Results</div>
    <div class="section-content">
      <p>RAS Flow Rate: <span class="result" id="ras_result">-</span> MGD</p>
      <p>Required RAS Ratio: <span class="result" id="ras_required">-</span> %</p>
    </div>
  </div>
</div>

<!-- 4. Detention Time Calculator -->
<div class="panel" id="detention">
  <div class="section">
    <div class="section-h">â±ï¸ Detention Time - Hydraulic Retention Time</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Tank Volume (MG)</label>
          <input id="dt_volume" type="number" step="0.01" value="1.2" oninput="calcDetention()">
        </div>
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="dt_flow" type="number" step="0.1" value="3.5" oninput="calcDetention()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcDetention()">Calculate</button>
        <button class="btn gray" onclick="resetDetention()">Reset</button>
      </div>
      <div class="note">
        <strong>Design Criteria:</strong> Conventional Activated Sludge: 4-8 hours, Extended Aeration: 18-24 hours, Contact Stabilization: 3-6 hours
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Detention Time Results</div>
    <div class="section-content">
      <p>Detention Time: <span class="result" id="dt_result_hours">-</span> hours</p>
      <p>Detention Time: <span class="result" id="dt_result_days">-</span> days</p>
    </div>
  </div>
</div>

<!-- 5. WOR Calculator -->
<div class="panel" id="wor">
  <div class="section">
    <div class="section-h">ðŸ’§ Weir Overflow Rate - Clarifier Design Parameter</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="wor_flow" type="number" step="0.1" value="3.5" oninput="calcWOR()">
        </div>
        <div class="input-group">
          <label>Weir Length (ft)</label>
          <input id="wor_length" type="number" step="1" value="250" oninput="calcWOR()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcWOR()">Calculate WOR</button>
        <button class="btn gray" onclick="resetWOR()">Reset</button>
      </div>
      <div class="note warning">
        <strong>Recommended Limits:</strong> Primary Clarifiers: â‰¤20,000 GPD/ft, Secondary Clarifiers: â‰¤15,000 GPD/ft. High WOR can cause hydraulic overload.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š WOR Result</div>
    <div class="section-content">
      <p>Weir Overflow Rate: <span class="result" id="wor_result">-</span> GPD/ft</p>
    </div>
  </div>
</div>

<!-- 6. SLR Calculator -->
<div class="panel" id="slr">
  <div class="section">
    <div class="section-h">ðŸ“ Surface Loading Rate - Settling Tank Analysis</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="slr_flow" type="number" step="0.1" value="3.5" oninput="calcSLR()">
        </div>
        <div class="input-group">
          <label>Surface Area (ftÂ²)</label>
          <input id="slr_area" type="number" step="10" value="5000" oninput="calcSLR()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcSLR()">Calculate SLR</button>
        <button class="btn gray" onclick="resetSLR()">Reset</button>
      </div>
      <div class="note">
        <strong>Design Standards:</strong> Primary Clarifiers: 400-800 GPD/ftÂ², Secondary Clarifiers: 300-600 GPD/ftÂ² (avg), 800-1200 GPD/ftÂ² (peak)
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š SLR Results</div>
    <div class="section-content">
      <p>Surface Loading Rate: <span class="result" id="slr_result">-</span> GPD/ftÂ²</p>
      <p>Overflow Rate: <span class="result" id="slr_overflow">-</span> mÂ³/mÂ²/day</p>
    </div>
  </div>
</div>

<!-- 7. Alkalinity Balance Calculator -->
<div class="panel" id="alkalinity">
  <div class="section">
    <div class="section-h">âš—ï¸ Alkalinity Balance - pH Buffer Capacity</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent Alkalinity (mg/L as CaCOâ‚ƒ)</label>
          <input id="alk_influent" type="number" step="1" value="180" oninput="calcAlkalinity()">
        </div>
        <div class="input-group">
          <label>Nitrification Rate (mg/L NHâ‚ƒ-N)</label>
          <input id="alk_nitrification" type="number" step="0.1" value="25" oninput="calcAlkalinity()">
        </div>
        <div class="input-group">
          <label>Denitrification Rate (mg/L NOâ‚ƒ-N)</label>
          <input id="alk_denitrification" type="number" step="0.1" value="15" oninput="calcAlkalinity()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcAlkalinity()">Calculate Balance</button>
        <button class="btn gray" onclick="resetAlkalinity()">Reset</button>
      </div>
      <div class="note">
        <strong>Key Points:</strong> 7.14 lb alkalinity consumed per lb NHâ‚ƒ-N nitrified. 3.57 lb alkalinity produced per lb NOâ‚ƒ-N denitrified. Minimum 50 mg/L alkalinity recommended.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Alkalinity Balance Results</div>
    <div class="section-content">
      <p>Alkalinity Consumed: <span class="result" id="alk_consumed">-</span> mg/L as CaCOâ‚ƒ</p>
      <p>Alkalinity Produced: <span class="result" id="alk_produced">-</span> mg/L as CaCOâ‚ƒ</p>
      <p>Net Effluent Alkalinity: <span class="result" id="alk_net">-</span> mg/L as CaCOâ‚ƒ</p>
    </div>
  </div>
</div>

<!-- 8. Oxygen Requirements Calculator -->
<div class="panel" id="oxygen-req">
  <div class="section">
    <div class="section-h">ðŸ’¨ Oxygen Requirements - Aeration Needs Calculation</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>BOD Removed (lb/day)</label>
          <input id="o2_bod" type="number" step="1" value="5835" oninput="calcOxygenReq()">
        </div>
        <div class="input-group">
          <label>NHâ‚ƒ-N Oxidized (lb/day)</label>
          <input id="o2_nh3" type="number" step="1" value="730" oninput="calcOxygenReq()">
        </div>
        <div class="input-group">
          <label>Endogenous Respiration Factor</label>
          <input id="o2_endo" type="number" step="0.01" value="0.12" oninput="calcOxygenReq()">
        </div>
        <div class="input-group">
          <label>MLSS (mg/L)</label>
          <input id="o2_mlss" type="number" step="50" value="2500" oninput="calcOxygenReq()">
        </div>
        <div class="input-group">
          <label>Aeration Volume (MG)</label>
          <input id="o2_volume" type="number" step="0.01" value="1.2" oninput="calcOxygenReq()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcOxygenReq()">Calculate Oâ‚‚</button>
        <button class="btn gray" onclick="resetOxygenReq()">Reset</button>
      </div>
      <div class="note">
        <strong>Formula:</strong> Oâ‚‚ = 1.0Ã—BOD_removed + 4.57Ã—NHâ‚ƒ-N_oxidized - 1.42Ã—Biomass_produced + Endogenous_respiration
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Oxygen Requirements Results</div>
    <div class="section-content">
      <p>Total Oxygen Required: <span class="result" id="o2_total">-</span> lb Oâ‚‚/day</p>
      <p>Oxygen Rate: <span class="result" id="o2_rate">-</span> lb Oâ‚‚/hr</p>
    </div>
  </div>
</div>

<!-- 9. Air Requirements Calculator -->
<div class="panel" id="air">
  <div class="section">
    <div class="section-h">ðŸŒ¬ï¸ Air Requirements - Blower Sizing &amp; Capacity</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Oxygen Required (lb/hr)</label>
          <input id="air_o2" type="number" step="1" value="450" oninput="calcAir()">
        </div>
        <div class="input-group">
          <label>Oxygen Transfer Efficiency (%)</label>
          <input id="air_ote" type="number" step="0.5" value="12" oninput="calcAir()">
        </div>
        <div class="input-group">
          <label>Diffuser Depth (ft)</label>
          <input id="air_depth" type="number" step="0.5" value="15" oninput="calcAir()">
        </div>
        <div class="input-group">
          <label>Temperature (Â°C)</label>
          <input id="air_temp" type="number" step="1" value="20" oninput="calcAir()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcAir()">Calculate Air</button>
        <button class="btn gray" onclick="resetAir()">Reset</button>
      </div>
      <div class="note">
        <strong>Design Note:</strong> Air contains 23.2% oxygen by weight. Add 15-25% safety factor for actual blower sizing.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Air Requirements Results</div>
    <div class="section-content">
      <p>Air Flow Required: <span class="result" id="air_scfm">-</span> SCFM</p>
      <p>Blower HP Required: <span class="result" id="air_hp">-</span> HP</p>
    </div>
  </div>
</div>

<!-- 10. Polymer Dosage Calculator -->
<div class="panel" id="polymer">
  <div class="section">
    <div class="section-h">ðŸ’Š Polymer Dosage - Chemical Feed Rate Optimization</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Sludge Flow (GPM)</label>
          <input id="poly_flow" type="number" step="1" value="100" oninput="calcPolymer()">
        </div>
        <div class="input-group">
          <label>Sludge TSS (%)</label>
          <input id="poly_tss" type="number" step="0.1" value="2.5" oninput="calcPolymer()">
        </div>
        <div class="input-group">
          <label>Polymer Dose (lb/ton dry solids)</label>
          <input id="poly_dose" type="number" step="0.5" value="10" oninput="calcPolymer()">
        </div>
        <div class="input-group">
          <label>Polymer Concentration (%)</label>
          <input id="poly_conc" type="number" step="0.05" value="0.5" oninput="calcPolymer()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcPolymer()">Calculate Dosage</button>
        <button class="btn gray" onclick="resetPolymer()">Reset</button>
      </div>
      <div class="note">
        <strong>Typical Dosages:</strong> Belt Press: 8-15 lb/ton, Centrifuge: 10-25 lb/ton, Gravity Belt Thickener: 2-6 lb/ton
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Polymer Dosage Results</div>
    <div class="section-content">
      <p>Polymer Feed Rate: <span class="result" id="poly_feed">-</span> GPD</p>
      <p>Daily Polymer Usage: <span class="result" id="poly_daily">-</span> lb/day</p>
    </div>
  </div>
</div>

<!-- 11. pH Adjustment Calculator -->
<div class="panel" id="ph">
  <div class="section">
    <div class="section-h">ðŸ§ª pH Adjustment - Caustic &amp; Acid Dosing</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="ph_flow" type="number" step="0.1" value="3.5" oninput="calcPH()">
        </div>
        <div class="input-group">
          <label>Current pH</label>
          <input id="ph_current" type="number" step="0.1" value="5.8" oninput="calcPH()">
        </div>
        <div class="input-group">
          <label>Target pH</label>
          <input id="ph_target" type="number" step="0.1" value="7.0" oninput="calcPH()">
        </div>
        <div class="input-group">
          <label>Chemical Type</label>
          <select id="ph_chemical" onchange="calcPH()">
            <option value="naoh">Sodium Hydroxide (NaOH)</option>
            <option value="lime">Lime (CaO)</option>
            <option value="h2so4">Sulfuric Acid (Hâ‚‚SOâ‚„)</option>
            <option value="hcl">Hydrochloric Acid (HCl)</option>
          </select>
        </div>
        <div class="input-group">
          <label>Chemical Strength (%)</label>
          <input id="ph_strength" type="number" step="1" value="50" oninput="calcPH()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcPH()">Calculate</button>
        <button class="btn gray" onclick="resetPH()">Reset</button>
      </div>
      <div class="note warning">
        <strong>Warning:</strong> Actual dosage requirements vary with alkalinity and buffering capacity. Jar testing recommended for accurate dosing.
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š pH Adjustment Results</div>
    <div class="section-content">
      <p>Chemical Feed Rate: <span class="result" id="ph_feed">-</span> GPD</p>
      <p>Daily Chemical Usage: <span class="result" id="ph_daily">-</span> lb/day</p>
    </div>
  </div>
</div>

<!-- 12. Chlorine Dosage Calculator -->
<div class="panel" id="chlorine">
  <div class="section">
    <div class="section-h">â˜£ï¸ Chlorine Dosage - Disinfection Requirements</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="cl_flow" type="number" step="0.1" value="3.5" oninput="calcChlorine()">
        </div>
        <div class="input-group">
          <label>Chlorine Dose (mg/L)</label>
          <input id="cl_dose" type="number" step="0.5" value="8" oninput="calcChlorine()">
        </div>
        <div class="input-group">
          <label>Chlorine Type</label>
          <select id="cl_type" onchange="calcChlorine()">
            <option value="gas">Chlorine Gas (Clâ‚‚)</option>
            <option value="hypo">Sodium Hypochlorite (12.5%)</option>
            <option value="bleach">Bleach (5.25%)</option>
            <option value="tablet">Calcium Hypochlorite (65%)</option>
          </select>
        </div>
        <div class="input-group">
          <label>Contact Time (min)</label>
          <input id="cl_time" type="number" step="1" value="30" oninput="calcChlorine()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcChlorine()">Calculate</button>
        <button class="btn gray" onclick="resetChlorine()">Reset</button>
      </div>
      <div class="note">
        <strong>CT Requirements:</strong> 0.5 log removal: CT=0.4, 1.0 log removal: CT=0.8, 2.0 log removal: CT=1.6, 3.0 log removal: CT=2.4
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Chlorine Dosage Results</div>
    <div class="section-content">
      <p>Chemical Feed Rate: <span class="result" id="cl_feed">-</span> <span id="cl_unit">lb/day</span></p>
      <p>CT Value: <span class="result" id="cl_ct">-</span> mgÂ·min/L</p>
      <p>Daily Cost (@$2.50/gal): <span class="result" id="cl_cost">-</span> $/day</p>
    </div>
  </div>
</div>

<!-- 13. Enhanced SRT Calculator -->
<div class="panel" id="srt-enhanced">
  <div class="section">
    <div class="section-h">â³ Sludge Retention Time (SRT) - Enhanced Calculator</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>MLSS (mg/L)</label>
          <input id="srt_enh_mlss" type="number" step="50" value="2500" oninput="calcSRTEnhanced()">
        </div>
        <div class="input-group">
          <label>Aeration Volume (MG)</label>
          <input id="srt_enh_volume" type="number" step="0.01" value="1.2" oninput="calcSRTEnhanced()">
        </div>
        <div class="input-group">
          <label>Effluent TSS (mg/L)</label>
          <input id="srt_enh_eff_tss" type="number" step="1" value="15" oninput="calcSRTEnhanced()">
        </div>
        <div class="input-group">
          <label>Effluent Flow (MGD)</label>
          <input id="srt_enh_eff_flow" type="number" step="0.1" value="3.5" oninput="calcSRTEnhanced()">
        </div>
        <div class="input-group">
          <label>Waste Flow (MGD)</label>
          <input id="srt_enh_waste_flow" type="number" step="0.01" value="0.1" oninput="calcSRTEnhanced()">
        </div>
        <div class="input-group">
          <label>Waste TSS (mg/L)</label>
          <input id="srt_enh_waste_tss" type="number" step="100" value="8000" oninput="calcSRTEnhanced()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcSRTEnhanced()">Calculate SRT</button>
        <button class="btn gray" onclick="resetSRTEnhanced()">Reset</button>
      </div>
      <div class="note">
        <strong>SRT Classifications:</strong> Extended Aeration: 20-30 days, Conventional: 5-15 days, High-Rate: 2-4 days, Contact Stabilization: 5-8 days
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Enhanced SRT Results</div>
    <div class="section-content">
      <p>Sludge Retention Time: <span class="result" id="srt_enh_result">-</span> days</p>
      <p>Process Classification: <span class="result" id="srt_classification">-</span></p>
    </div>
  </div>
</div>

<!-- 14. BOD Efficiency Calculator -->
<div class="panel" id="bod-efficiency">
  <div class="section">
    <div class="section-h">ðŸ“‰ BOD Removal Efficiency - Treatment Performance</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent BOD (mg/L)</label>
          <input id="bodeff_in" type="number" step="1" value="200" oninput="calcBODEfficiency()">
        </div>
        <div class="input-group">
          <label>Effluent BOD (mg/L)</label>
          <input id="bodeff_out" type="number" step="0.5" value="10" oninput="calcBODEfficiency()">
        </div>
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="bodeff_flow" type="number" step="0.1" value="3.5" oninput="calcBODEfficiency()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcBODEfficiency()">Calculate</button>
        <button class="btn gray" onclick="resetBODEfficiency()">Reset</button>
      </div>
      <div class="note success">
        <strong>Permit Requirements:</strong> Secondary Treatment: â‰¥85% removal, Advanced: â‰¥90% removal, Tertiary: â‰¥95% removal
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š BOD Efficiency Results</div>
    <div class="section-content">
      <p>BOD Removal Efficiency: <span class="result" id="bodeff_percent">-</span> %</p>
      <p>BOD Removed: <span class="result" id="bodeff_removed">-</span> lb/day</p>
      <p>Compliance Status: <span class="result" id="bodeff_status">-</span></p>
    </div>
  </div>
</div>

<!-- 15. SVI Calculator Enhanced -->
<div class="panel" id="svi-calc">
  <div class="section">
    <div class="section-h">ðŸ”¬ Sludge Volume Index (SVI) - Settling Characteristics</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>30-min Settled Volume (mL/L)</label>
          <input id="svi_vol" type="number" step="5" value="150" oninput="calcSVICalc()">
        </div>
        <div class="input-group">
          <label>MLSS (mg/L)</label>
          <input id="svi_mlss_calc" type="number" step="50" value="3000" oninput="calcSVICalc()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcSVICalc()">Calculate SVI</button>
        <button class="btn gray" onclick="resetSVICalc()">Reset</button>
      </div>
      <div class="note">
        <strong>SVI Interpretation:</strong> &lt;50: Very poor settling, 50-100: Excellent, 100-150: Good, 150-200: Fair, &gt;200: Poor (bulking likely)
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š SVI Results</div>
    <div class="section-content">
      <p>Sludge Volume Index: <span class="result" id="svi_calc_result">-</span> mL/g</p>
      <p>Sludge Settleability: <span class="result" id="svi_quality">-</span></p>
    </div>
  </div>
</div>

<!-- 16. Nitrogen Balance Calculator -->
<div class="panel" id="nitrogen">
  <div class="section">
    <div class="section-h">ðŸŒ¿ Nitrogen Balance - Nutrient Removal Analysis</div>
    <div class="section-content">
      <div class="row">
        <div class="input-group">
          <label>Influent TKN (mg/L)</label>
          <input id="n_tkn_in" type="number" step="0.5" value="35" oninput="calcNitrogen()">
        </div>
        <div class="input-group">
          <label>Influent NHâ‚ƒ-N (mg/L)</label>
          <input id="n_nh3_in" type="number" step="0.5" value="25" oninput="calcNitrogen()">
        </div>
        <div class="input-group">
          <label>Effluent TKN (mg/L)</label>
          <input id="n_tkn_out" type="number" step="0.1" value="2" oninput="calcNitrogen()">
        </div>
        <div class="input-group">
          <label>Effluent NHâ‚ƒ-N (mg/L)</label>
          <input id="n_nh3_out" type="number" step="0.1" value="0.5" oninput="calcNitrogen()">
        </div>
        <div class="input-group">
          <label>Effluent NOâ‚ƒ-N (mg/L)</label>
          <input id="n_no3_out" type="number" step="0.5" value="8" oninput="calcNitrogen()">
        </div>
        <div class="input-group">
          <label>Flow Rate (MGD)</label>
          <input id="n_flow" type="number" step="0.1" value="3.5" oninput="calcNitrogen()">
        </div>
      </div>
      <div class="btns">
        <button class="btn green" onclick="calcNitrogen()">Calculate N Balance</button>
        <button class="btn gray" onclick="resetNitrogen()">Reset</button>
      </div>
      <div class="note">
        <strong>Regulatory Limits:</strong> Typical effluent limits - TKN: &lt;10 mg/L, NHâ‚ƒ-N: &lt;1-5 mg/L, Total N: &lt;10-15 mg/L depending on permit
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-h">ðŸ“Š Nitrogen Balance Results</div>
    <div class="section-content">
      <p>TKN Removal Efficiency: <span class="result" id="n_tkn_eff">-</span> %</p>
      <p>NHâ‚ƒ Removal Efficiency: <span class="result" id="n_nh3_eff">-</span> %</p>
      <p>Total N Removed: <span class="result" id="n_total_removed">-</span> lb/day</p>
      <p>Denitrification Efficiency: <span class="result" id="n_denit_eff">-</span> %</p>
    </div>
  </div>
</div>


<script>
// Core utilities
const $=id=>document.getElementById(id);
const $$=s=>document.querySelectorAll(s);
const fmt={
n:(v,d=0)=>Number(v).toFixed(d).replace(/\B(?=(\d{3})+(?!\d))/g,','),
f:(v,d=2)=>Number(v).toFixed(d),
p:(v,d=1)=>(Number(v)*100).toFixed(d)+'%'
};

let state={
data:{},
plants:[],
alerts:[],
maintenance:[],
labTests:[],
charts:{},
aiChat:[],
issues:[],
symptoms:[]
};

// AI Knowledge Base
const knowledgeBase=[
{id:1,title:'High SVI Troubleshooting',category:'Sludge',content:'High Sludge Volume Index (SVI >150 mL/g) indicates bulking. Causes: filamentous bacteria, low DO, nutrient deficiency. Solutions: increase DO to 2.5+ mg/L, reduce F/M ratio, add selector zone, chlorinate RAS.',keywords:'svi bulking filamentous settling'},
{id:2,title:'Low DO Recovery',category:'Oxygen',content:'Dissolved oxygen not reaching target indicates insufficient aeration. Check: blower capacity, diffuser fouling, membrane damage. Solutions: clean diffusers, increase airflow, repair/replace damaged equipment.',keywords:'do oxygen aeration blower diffuser'},
{id:3,title:'Ammonia Breakthrough',category:'Nitrification',content:'High effluent ammonia (>2 mg/L) indicates nitrification failure. Causes: low temperature, insufficient MCRT, low DO, toxic shock. Solutions: increase MCRT to 8-12 days, maintain DO >2 mg/L, check alkalinity.',keywords:'ammonia nitrification tkn nitrogen'},
{id:4,title:'Rising Sludge',category:'Sludge',content:'Sludge rising in clarifier indicates denitrification. Causes: excessive RAS detention, low DO in clarifier. Solutions: increase RAS rate, reduce sludge blanket depth, improve aeration.',keywords:'rising sludge clarifier denitrification'},
{id:5,title:'Pin Floc Formation',category:'Sludge',content:'Small, dispersed floc particles indicate old sludge or toxic shock. Causes: extended MCRT, toxicity, low F/M. Solutions: reduce MCRT, increase WAS, investigate toxic discharge.',keywords:'floc pin particle dispersed'},
{id:6,title:'Foam & Scum',category:'Operations',content:'Excessive foam indicates presence of surfactants, NOx in sludge, or Nocardia growth. Solutions: spray foam with water, add antifoam agent, reduce MCRT, investigate industrial discharge.',keywords:'foam scum nocardia surfactant'},
{id:7,title:'Energy Consumption High',category:'Energy',content:'High energy use (>2000 kWh/MG) indicates inefficiency. Check: blower operation, VFD settings, DO setpoints, equipment staging. Solutions: optimize DO control, install VFDs, improve equipment staging.',keywords:'energy power consumption efficiency kwh'},
{id:8,title:'Phosphorus Removal',category:'Nutrients',content:'Biological P removal requires anaerobic zone, adequate VFAs, low DO. Chemical removal uses alum, ferric, or lime. Optimize: F/M ratio 0.3-0.5, anaerobic HRT 1-2 hours, maintain proper pH.',keywords:'phosphorus phosphate ebpr chemical'},
{id:9,title:'Septicity & Odors',category:'Operations',content:'Septic conditions and H2S odors from anaerobic conditions. Causes: long collection system detention, low DO. Solutions: pre-aeration, chemical addition (chlorine, peroxide), improved ventilation.',keywords:'septic odor h2s sulfide smell'},
{id:10,title:'Clarifier Performance',category:'Solids',content:'Poor clarifier performance: high effluent TSS, sludge blanket >50% depth. Causes: hydraulic overload, density currents, short-circuiting. Solutions: reduce flow, adjust RAS, improve baffling.',keywords:'clarifier settling tss effluent solids'}
];

// Common symptoms for troubleshooting
const symptoms=[
{id:'high_eff_bod',text:'High effluent BOD (>30 mg/L)',issues:['underloading','overloading','toxicity','low_do']},
{id:'high_eff_tss',text:'High effluent TSS (>30 mg/L)',issues:['bulking','pinfloc','clarifier_overload']},
{id:'high_eff_nh3',text:'High effluent ammonia',issues:['low_mcrt','low_do','low_temp','toxicity']},
{id:'high_svi',text:'High SVI (>150 mL/g)',issues:['bulking','filamentous']},
{id:'low_svi',text:'Low SVI (<80 mL/g)',issues:['pinfloc','old_sludge']},
{id:'low_do',text:'Low DO (<1.5 mg/L)',issues:['blower_failure','diffuser_fouling','overload']},
{id:'high_mlss',text:'MLSS too high (>4000 mg/L)',issues:['insufficient_was','clarifier_issue']},
{id:'low_mlss',text:'MLSS too low (<1500 mg/L)',issues:['excessive_was','washout']},
{id:'foam',text:'Excessive foam/scum',issues:['nocardia','surfactants','denitrification']},
{id:'odors',text:'Septic odors (H2S)',issues:['septicity','anaerobic']},
{id:'rising_sludge',text:'Rising sludge in clarifier',issues:['denitrification','gas_bubbles']},
{id:'poor_settling',text:'Poor sludge settling',issues:['bulking','temperature','toxicity']},
{id:'brown_foam',text:'Brown/tan foam',issues:['surfactants','young_sludge']},
{id:'white_foam',text:'White billowy foam',issues:['nocardia','actinomycetes']},
{id:'high_energy',text:'High energy consumption',issues:['inefficient_aeration','equipment_issues']}
];

// Issue database for tracking
const issueDatabase={
bulking:{
name:'Sludge Bulking',
severity:'high',
causes:['Filamentous bacteria overgrowth','Low DO (<1.5 mg/L)','Nutrient deficiency (N or P)','Low F/M ratio (<0.2)','Presence of readily biodegradable substrate'],
solutions:[
{step:1,action:'Check and record current SVI, MLSS, DO, F/M ratio'},
{step:2,action:'Perform microscopic exam to identify filament type'},
{step:3,action:'Increase DO to 2.5-3.0 mg/L throughout basin'},
{step:4,action:'If low F/M: reduce MLSS by increasing WAS or reduce aeration volume'},
{step:5,action:'Add selector zone or implement step-feed operation'},
{step:6,action:'Consider chlorination of RAS (5-10 mg/L for 15-30 min contact)'},
{step:7,action:'Monitor daily SVI until <120 mL/g achieved'}
],
prevention:['Maintain DO >2.0 mg/L','Keep F/M ratio 0.3-0.5','Ensure adequate nutrients (100:5:1)','Regular microscopic monitoring']
},
low_do:{
name:'Low Dissolved Oxygen',
severity:'high',
causes:['Blower capacity insufficient','Diffuser fouling/damage','Excessive organic loading','Equipment failure','Control system malfunction'],
solutions:[
{step:1,action:'Check all blowers - verify operation and amperage draw'},
{step:2,action:'Inspect diffusers for fouling, damage, or uneven distribution'},
{step:3,action:'Measure actual airflow with pitot tube or flow meter'},
{step:4,action:'Calculate oxygen requirement vs. delivery capability'},
{step:5,action:'Clean fouled diffusers (acid wash if needed)'},
{step:6,action:'Increase blower output or stage additional blower'},
{step:7,action:'If equipment failure: implement emergency bypass/repairs'},
{step:8,action:'Recalibrate DO probes and control system'}
],
prevention:['Regular diffuser inspection/cleaning (quarterly)','Preventive maintenance on blowers','Spare blower capacity (N+1)','Automated DO control with alarms']
},
high_eff_nh3:{
name:'Ammonia Breakthrough',
severity:'critical',
causes:['MCRT too short (<5 days)','Low DO in aerobic zones','Low temperature (<12Â°C)','Insufficient alkalinity','Toxic shock load','Nitrifier washout'],
solutions:[
{step:1,action:'Immediately stop or reduce WAS to increase MCRT'},
{step:2,action:'Increase DO setpoint to 2.5-3.0 mg/L'},
{step:3,action:'Test alkalinity - add if <50 mg/L as CaCO3'},
{step:4,action:'Calculate and target MCRT of 10-15 days minimum'},
{step:5,action:'Reduce influent load if possible (equalization, bypass)'},
{step:6,action:'Check for toxic industrial discharge - investigate I/I'},
{step:7,action:'Monitor effluent NH3 daily until <1.0 mg/L'},
{step:8,action:'If chronic: consider bioaugmentation with nitrifiers'}
],
prevention:['Maintain MCRT >8 days year-round','Keep DO >2.0 mg/L','Monitor alkalinity weekly','Industrial pretreatment program','Temperature-based MCRT adjustment']
},
clarifier_overload:{
name:'Clarifier Overload',
severity:'medium',
causes:['Hydraulic overload (SOR >800 gpd/ftÂ²)','Solids overload (SLR >30 lb/ftÂ²/d)','Density currents','Short-circuiting','Equipment malfunction (rake, skimmer)'],
solutions:[
{step:1,action:'Calculate actual SOR and SLR vs. design'},
{step:2,action:'Reduce flow if possible (bypass, equalization)'},
{step:3,action:'Increase RAS rate to reduce sludge blanket'},
{step:4,action:'Check and adjust weir loading'},
{step:5,action:'Inspect baffles for proper positioning'},
{step:6,action:'Verify rake/skimmer operation'},
{step:7,action:'Add polymer for improved settling if needed'},
{step:8,action:'Consider temporary TSS limit variance if critical'}
],
prevention:['Size clarifiers for peak flows','Maintain sludge blanket <30% depth','Regular equipment maintenance','Flow equalization']
}
};

// Initialize
const today=new Date().toISOString().split('T')[0];
if($('calcDate'))$('calcDate').value=today;

// Load saved data
const saved=localStorage.getItem('wwtp_enhanced_data');
if(saved){
try{
const loaded=JSON.parse(saved);
if(loaded.plants)state.plants=loaded.plants;
if(loaded.maintenance)state.maintenance=loaded.maintenance;
if(loaded.alerts)state.alerts=loaded.alerts;
if(loaded.issues)state.issues=loaded.issues;
}catch(e){console.error('Load error:',e)}
}

// Tab switching
$$('.tab').forEach(tab=>{
tab.addEventListener('click',()=>{
$$('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
$$('.panel').forEach(p=>p.classList.remove('active'));
tab.setAttribute('aria-selected','true');
const target=tab.getAttribute('data-target');
$(target).classList.add('active');
if(target==='ai'){
scrollAIToBottom();
}
});
});

// Theme toggle
if($('themeBtn')){
$('themeBtn').addEventListener('click',()=>{
document.documentElement.classList.toggle('dark');
localStorage.setItem('theme',document.documentElement.classList.contains('dark')?'dark':'light');
});
if(localStorage.getItem('theme')==='dark')document.documentElement.classList.add('dark');
}

// Toast notifications
function showToast(msg,type='info'){
const toast=document.createElement('div');
toast.className=`toast ${type}`;
toast.textContent=msg;
document.body.appendChild(toast);
setTimeout(()=>{
toast.style.opacity='0';
setTimeout(()=>toast.remove(),300);
},4000);
}

// AI Assistant Functions

function openAIAssistant(){
$$('.tab[data-target="ai"]')[0].click();
setTimeout(()=>$('aiInput').focus(),300);
}

function sendAIMessage(){
const input=$('aiInput');
const msg=input.value.trim();
if(!msg)return;

addAIMessage(msg,'user');
input.value='';
showAIThinking(true);

setTimeout(()=>{
const response=generateAIResponse(msg);
showAIThinking(false);
addAIMessage(response,'assistant');
},1500+Math.random()*1000);
}

function addAIMessage(text,sender){
const container=$('aiMessages');
const msg=document.createElement('div');
msg.className=`ai-message ${sender}`;
msg.innerHTML=text;
container.appendChild(msg);
scrollAIToBottom();

state.aiChat.push({text,sender,time:new Date()});
}

function scrollAIToBottom(){
const container=$('aiMessages');
setTimeout(()=>{
container.scrollTop=container.scrollHeight;
},100);
}

function showAIThinking(show){
$('aiThinking').classList.toggle('active',show);
}

function generateAIResponse(msg){
const lower=msg.toLowerCase();

// Pattern matching for common questions
if(lower.includes('high svi')||lower.includes('bulking')){
return `<strong>Sludge Bulking Diagnosis</strong><br><br>High SVI indicates bulking sludge, typically caused by filamentous bacteria. Here's what to check:<br><br>
<strong>Immediate Actions:</strong><br>
1. Verify current SVI value and trend<br>
2. Check DO levels - should be >2.0 mg/L throughout basin<br>
3. Perform microscopic exam to identify filament type<br>
4. Calculate F/M ratio - target 0.3-0.5 lb/lb/d<br><br>
<strong>Solutions:</strong><br>
â€¢ Increase DO to 2.5-3.0 mg/L<br>
â€¢ Consider RAS chlorination (5-10 mg/L)<br>
â€¢ Add selector zone if possible<br>
â€¢ Reduce F/M if >0.5<br><br>
Would you like detailed step-by-step instructions?`;
}

if(lower.includes('ammonia')||lower.includes('nitrification')){
return `<strong>Ammonia/Nitrification Issues</strong><br><br>High effluent ammonia indicates nitrification problems. Key factors:<br><br>
<strong>Critical Parameters:</strong><br>
â€¢ MCRT: Must be >8 days (>12 days if temp <15Â°C)<br>
â€¢ DO: Maintain >2.0 mg/L in aerobic zones<br>
â€¢ Alkalinity: Need ~50 mg/L minimum as CaCO3<br>
â€¢ Temperature: Below 12Â°C severely impacts rate<br><br>
<strong>Quick Fixes:</strong><br>
1. STOP wasting sludge immediately to increase MCRT<br>
2. Increase aeration/DO setpoint<br>
3. Check for toxic industrial discharge<br>
4. Test and supplement alkalinity if needed<br><br>
Recovery typically takes 1-2 weeks. Monitor daily!`;
}

if(lower.includes('do')||lower.includes('oxygen')||lower.includes('aeration')){
return `<strong>Dissolved Oxygen Management</strong><br><br>
<strong>Target Ranges:</strong><br>
â€¢ Conventional activated sludge: 1.5-3.0 mg/L<br>
â€¢ Nitrification: 2.0-3.0 mg/L<br>
â€¢ Extended aeration: 2.5-4.0 mg/L<br><br>
<strong>Troubleshooting Low DO:</strong><br>
1. Check blower amperage and operation<br>
2. Inspect diffusers for fouling or damage<br>
3. Verify airflow measurement<br>
4. Calculate oxygen transfer rate vs requirement<br>
5. Clean diffusers if OTE has dropped<br><br>
<strong>Energy Optimization:</strong><br>
â€¢ Use DO control with VFDs<br>
â€¢ Vary setpoint based on load<br>
â€¢ Consider fine bubble vs coarse<br><br>
Need help calculating oxygen requirements?`;
}

if(lower.includes('energy')||lower.includes('cost')||lower.includes('power')){
return `<strong>Energy Optimization Strategies</strong><br><br>
Aeration typically represents 50-60% of total plant energy. Here's how to optimize:<br><br>
<strong>Quick Wins:</strong><br>
1. Install VFDs on blowers (15-25% savings)<br>
2. Optimize DO setpoints (reduce excess DO)<br>
3. Use time-of-day scheduling<br>
4. Improve process control<br><br>
<strong>Maintenance:</strong><br>
â€¢ Clean diffusers regularly<br>
â€¢ Fix air leaks<br>
â€¢ Optimize equipment staging<br>
â€¢ Monitor motor efficiency<br><br>
<strong>Benchmark:</strong><br>
Good performance: <1800 kWh/MG<br>
Average: 1800-2200 kWh/MG<br>
Needs improvement: >2200 kWh/MG<br><br>
Your current usage: ${$('kpi-energy')?.textContent||'1850'} kWh/MG`;
}

if(lower.includes('f/m')||lower.includes('food to microorganism')){
return `<strong>F/M Ratio Management</strong><br><br>
The Food-to-Microorganism ratio controls treatment performance:<br><br>
<strong>Typical Ranges:</strong><br>
â€¢ Conventional AS: 0.2-0.5 lb BOD/lb MLVSS/d<br>
â€¢ Extended aeration: 0.05-0.15<br>
â€¢ High-rate: 0.5-1.5<br><br>
<strong>Effects of F/M:</strong><br>
â€¢ Low F/M (<0.2): Better effluent, more stable, higher O2<br>
â€¢ High F/M (>0.5): Poor settling, higher BOD, bulking risk<br><br>
<strong>Adjustment:</strong><br>
To decrease F/M: Increase MLSS or reduce load<br>
To increase F/M: Decrease MLSS (waste more) or accept more load<br><br>
Your current F/M: ${$('kpi-fm')?.textContent||'0.35'} lb/lb/d - Optimal range!`;
}

if(lower.includes('foam')||lower.includes('scum')){
return `<strong>Foam & Scum Troubleshooting</strong><br><br>
<strong>Types of Foam:</strong><br><br>
1. <strong>White billowy foam</strong> (Nocardia/Actinomycetes)<br>
   â€¢ Caused by: High MCRT, warm temps, fats/oils<br>
   â€¢ Solution: Reduce MCRT to 5-8 days, spray foam, chlorinate<br><br>
2. <strong>Brown/tan foam</strong> (Young sludge/Surfactants)<br>
   â€¢ Caused by: Low MCRT, detergents, startup<br>
   â€¢ Solution: Normal - will improve as sludge matures<br><br>
3. <strong>Thick foam</strong> (Denitrification in clarifier)<br>
   â€¢ Caused by: Rising sludge, N2 gas<br>
   â€¢ Solution: Increase RAS rate, reduce sludge blanket<br><br>
<strong>Control Methods:</strong><br>
â€¢ Water spray<br>
â€¢ Anti-foam chemicals<br>
â€¢ Adjust MCRT<br>
â€¢ Investigate industrial FOG sources`;
}

if(lower.includes('help')||lower.includes('what can you')){
return `I can assist with a wide range of wastewater treatment topics:<br><br>
<strong>ðŸ” Diagnostics:</strong> Identify root causes of problems<br>
<strong>ðŸ©º Troubleshooting:</strong> Step-by-step solutions<br>
<strong>ðŸ“Š Calculations:</strong> Loading, F/M, MCRT, oxygen, etc.<br>
<strong>âš™ï¸ Operations:</strong> Process control and optimization<br>
<strong>ðŸ§« Biology:</strong> Microbiology and sludge health<br>
<strong>ðŸ“‹ Compliance:</strong> Permit limits and reporting<br>
<strong>âš¡ Energy:</strong> Efficiency and cost reduction<br>
<strong>ðŸ”§ Maintenance:</strong> Equipment and preventive care<br><br>
Try asking me:<br>
â€¢ "Why is my SVI high?"<br>
â€¢ "How do I improve nitrification?"<br>
â€¢ "What's causing high effluent TSS?"<br>
â€¢ "How can I reduce energy costs?"<br>
â€¢ "Calculate my oxygen requirements"`;
}

// Default response with suggestions
return `I understand you're asking about: "${msg}"<br><br>I can provide detailed guidance on this topic. To give you the most accurate help, could you provide more details such as:<br><br>
â€¢ Current operating parameters (MLSS, DO, F/M, etc.)<br>
â€¢ Specific symptoms or measurements<br>
â€¢ Recent changes in operations<br>
â€¢ Lab results or trends<br><br>
Or try asking a more specific question like:<br>
â€¢ "Why is my [parameter] high/low?"<br>
â€¢ "How do I troubleshoot [issue]?"<br>
â€¢ "What causes [problem]?"<br>
â€¢ "Calculate [parameter]"<br><br>
You can also use the <strong>Full System Diagnostic</strong> button above for a comprehensive analysis!`;
}

function showQuickQuestions(){
addAIMessage(`<strong>Quick Questions - Click to Ask:</strong><br><br>
<div style="display:grid;gap:8px;margin-top:12px">
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('Why is my SVI high?')">â“ Why is my SVI high?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('How do I improve nitrification?')">â“ How do I improve nitrification?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('What causes high effluent TSS?')">â“ What causes high effluent TSS?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('How can I reduce energy costs?')">â“ How can I reduce energy costs?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('What is the optimal F/M ratio?')">â“ What is the optimal F/M ratio?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('How do I fix poor settling?')">â“ How do I fix poor settling?</button>
</div>`,'assistant');
}

function askQuick(question){
$('aiInput').value=question;
sendAIMessage();
}

function clearAIChat(){
if(confirm('Clear all chat history?')){
$('aiMessages').innerHTML=`<div class="ai-message assistant">
Chat cleared! How can I assist you today?
</div>`;
state.aiChat=[];
showToast('Chat history cleared','success');
}
}

function runSystemDiagnostic(){
showToast('Running comprehensive system diagnostic...','info');
showAIThinking(true);

setTimeout(()=>{
showAIThinking(false);
$('diagnosticResults').style.display='block';
$('diagnosticContent').innerHTML=generateDiagnosticReport();
showToast('Diagnostic complete - see results below','success');

// Scroll to results
setTimeout(()=>{
$('diagnosticResults').scrollIntoView({behavior:'smooth',block:'start'});
},300);
},2500);
}

function generateDiagnosticReport(){
// Get current data
const flow=parseFloat($('kpi-flow')?.textContent||3.5);
const doVal=parseFloat($('kpi-do')?.textContent||2.1);
const mlss=parseInt($('kpi-mlss')?.textContent||2500);
const fm=parseFloat($('kpi-fm')?.textContent||0.35);
const energy=parseInt($('kpi-energy')?.textContent||1850);

let issues=[];
let recommendations=[];

// Analyze parameters
if(doVal<1.5){
issues.push({severity:'high',title:'Low Dissolved Oxygen',desc:`Current DO (${doVal} mg/L) is below minimum requirement of 1.5 mg/L. This will impact BOD removal and nitrification.`,action:'Increase aeration immediately'});
}else if(doVal>3.5){
issues.push({severity:'medium',title:'Excessive Dissolved Oxygen',desc:`DO (${doVal} mg/L) is higher than necessary. This wastes energy.`,action:'Reduce aeration to save energy'});
}

if(fm<0.2){
issues.push({severity:'low',title:'Low F/M Ratio',desc:`F/M ratio (${fm}) indicates underloading. While effluent quality is likely excellent, energy efficiency may be poor.`,action:'Consider reducing aeration volume or accepting more load'});
}else if(fm>0.5){
issues.push({severity:'medium',title:'High F/M Ratio',desc:`F/M ratio (${fm}) is elevated. Risk of poor settling and effluent quality issues.`,action:'Increase MLSS or reduce organic loading'});
}

if(mlss<1800){
issues.push({severity:'medium',title:'Low MLSS',desc:`MLSS (${mlss} mg/L) is below typical operating range. Risk of washout and poor effluent quality.`,action:'Reduce WAS rate to build inventory'});
}else if(mlss>4000){
issues.push({severity:'medium',title:'High MLSS',desc:`MLSS (${mlss} mg/L) is elevated. Increased oxygen demand and settling issues possible.`,action:'Increase WAS rate or check clarifier performance'});
}

if(energy>2000){
issues.push({severity:'medium',title:'High Energy Consumption',desc:`Energy intensity (${energy} kWh/MG) exceeds industry benchmark of 2000 kWh/MG.`,action:'Review aeration efficiency and equipment staging'});
}

// Generate recommendations
if(doVal>=1.5&&doVal<=3.0&&fm>=0.2&&fm<=0.5&&mlss>=2000&&mlss<=3500){
recommendations.push('âœ“ Process is operating within optimal parameters');
recommendations.push('â€¢ Consider fine-tuning DO setpoint for energy savings');
recommendations.push('â€¢ Implement automated DO control if not already in place');
}

if(issues.length===0){
recommendations.push('âœ“ No critical issues detected');
recommendations.push('â€¢ Continue current monitoring protocols');
recommendations.push('â€¢ Schedule routine maintenance as planned');
}

let html=`
<div class="kpi-grid">
<div class="kpi-card">
<h4>Issues Found</h4>
<p style="color:${issues.length===0?'var(--ok)':issues.some(i=>i.severity==='high')?'var(--bad)':'var(--warn)'}">${issues.length}</p>
</div>
<div class="kpi-card">
<h4>System Health</h4>
<p style="color:${issues.length===0?'var(--ok)':issues.length<=2?'var(--warn)':'var(--bad)'}">
${issues.length===0?'Excellent':issues.length<=2?'Good':'Needs Attention'}
</p>
</div>
<div class="kpi-card">
<h4>Confidence</h4>
<p style="color:var(--info)">92%</p>
<div class="small">Based on current data</div>
</div>
</div>

<h4 style="margin:24px 0 16px 0">Diagnostic Results:</h4>
`;

if(issues.length>0){
issues.forEach(issue=>{
html+=`
<div class="diagnostic-card">
<span class="severity ${issue.severity}">${issue.severity.toUpperCase()} PRIORITY</span>
<h3>${issue.title}</h3>
<p style="color:var(--text-unit);margin:12px 0">${issue.desc}</p>
<div class="solution-step">
<h5>Recommended Action:</h5>
<p>${issue.action}</p>
</div>
</div>
`;
});
}else{
html+=`
<div class="note success">
<strong>âœ“ System Operating Normally</strong><br>
No critical issues detected. All parameters are within acceptable ranges. Continue standard monitoring and maintenance procedures.
</div>
`;
}

if(recommendations.length>0){
html+=`
<h4 style="margin:24px 0 16px 0">Recommendations:</h4>
<div class="note info">
${recommendations.map(r=>`${r}<br>`).join('')}
</div>
`;
}

html+=`
<div style="margin-top:24px">
<strong>Diagnostic Report Generated:</strong> ${new Date().toLocaleString()}<br>
<strong>Data Quality:</strong> Good<br>
<strong>Analysis Method:</strong> AI-Powered Multi-Parameter Assessment
</div>
`;

return html;
}

function showSymptomChecker(){
$('symptomCheckerSection').style.display='block';
$('knowledgeBaseSection').style.display='none';
$('issueHistorySection').style.display='none';

const container=$('symptomChecker');
container.innerHTML=symptoms.map(s=>`
<div class="symptom-option">
<input type="checkbox" id="sym_${s.id}" value="${s.id}"/>
<label for="sym_${s.id}" style="cursor:pointer;flex:1">${s.text}</label>
</div>
`).join('');

setTimeout(()=>{
$('symptomCheckerSection').scrollIntoView({behavior:'smooth',block:'start'});
},100);
}

function analyzeSymptoms(){
const checked=[];
symptoms.forEach(s=>{
if($(`sym_${s.id}`)?.checked){
checked.push(s);
}
});

if(checked.length===0){
showToast('Please select at least one symptom','warning');
return;
}

showAIThinking(true);
setTimeout(()=>{
showAIThinking(false);
const analysis=performSymptomAnalysis(checked);
addAIMessage(analysis,'assistant');
$$('.tab[data-target="ai"]')[0].click();
},1500);
}

function performSymptomAnalysis(symptoms){
let issueCount={};
symptoms.forEach(s=>{
s.issues.forEach(i=>{
issueCount[i]=(issueCount[i]||0)+1;
});
});

const sorted=Object.entries(issueCount).sort((a,b)=>b[1]-a[1]);
const topIssue=sorted[0][0];

let response=`<strong>ðŸ©º Symptom Analysis Results</strong><br><br>`;
response+=`You selected ${symptoms.length} symptom${symptoms.length>1?'s':''}:<br>`;
symptoms.forEach(s=>{
response+=`â€¢ ${s.text}<br>`;
});

response+=`<br><strong>Most Likely Cause:</strong><br><br>`;

// Map issue codes to full diagnoses
const issueMap={
bulking:'<strong>Sludge Bulking</strong><br>Filamentous bacteria causing poor settling',
underloading:'<strong>Underloading</strong><br>F/M ratio too low, insufficient organic load',
overloading:'<strong>Overloading</strong><br>Organic or hydraulic load exceeds capacity',
toxicity:'<strong>Toxic Shock</strong><br>Industrial discharge or toxic compounds',
low_do:'<strong>Low Dissolved Oxygen</strong><br>Insufficient aeration or blower issues',
low_mcrt:'<strong>MCRT Too Short</strong><br>Insufficient sludge age for nitrification',
low_temp:'<strong>Low Temperature</strong><br>Reduced biological activity',
pinfloc:'<strong>Pin Floc</strong><br>Old sludge or dispersed floc particles',
old_sludge:'<strong>Old Sludge</strong><br>Extended MCRT causing floc degradation',
clarifier_overload:'<strong>Clarifier Overload</strong><br>Hydraulic or solids overload',
nocardia:'<strong>Nocardia Foam</strong><br>Actinomycetes causing white billowy foam',
septicity:'<strong>Septic Conditions</strong><br>Anaerobic conditions producing H2S',
denitrification:'<strong>Denitrification</strong><br>Nitrogen gas causing rising sludge'
};

response+=issueMap[topIssue]||'Unknown issue';
response+=`<br><br><strong>Recommended Actions:</strong><br>`;

// Get detailed solution for top issue
if(issueDatabase[topIssue]){
const issue=issueDatabase[topIssue];
issue.solutions.slice(0,5).forEach(sol=>{
response+=`${sol.step}. ${sol.action}<br>`;
});
response+=`<br><em>For complete troubleshooting guide, ask me: "How do I fix ${topIssue}?"</em>`;
}else{
response+=`For detailed guidance, please describe your symptoms in the chat.`;
}

return response;
}

function resetSymptomChecker(){
symptoms.forEach(s=>{
const cb=$(`sym_${s.id}`);
if(cb)cb.checked=false;
});
showToast('Symptom checker reset','info');
}

function showKnowledgeBase(){
$('symptomCheckerSection').style.display='none';
$('knowledgeBaseSection').style.display='block';
$('issueHistorySection').style.display='none';

populateKnowledgeBase();

setTimeout(()=>{
$('knowledgeBaseSection').scrollIntoView({behavior:'smooth',block:'start'});
},100);
}

function populateKnowledgeBase(filter=''){
const container=$('knowledgeBaseContent');
const filtered=filter?knowledgeBase.filter(kb=>
kb.title.toLowerCase().includes(filter.toLowerCase())||
kb.keywords.toLowerCase().includes(filter.toLowerCase())||
kb.content.toLowerCase().includes(filter.toLowerCase())
):knowledgeBase;

container.innerHTML=filtered.map(kb=>`
<div class="knowledge-item" onclick="showKBArticle(${kb.id})">
<h4>${kb.title}</h4>
<p>${kb.content.substring(0,150)}...</p>
<div style="margin-top:8px">
<span class="tag info">${kb.category}</span>
</div>
</div>
`).join('');

if(filtered.length===0){
container.innerHTML=`
<div class="empty-state">
<div class="empty-state-icon">ðŸ”</div>
<div class="empty-state-title">No Articles Found</div>
<div class="empty-state-message">Try different search terms</div>
</div>
`;
}
}

function searchKnowledgeBase(){
const query=$('kbSearch').value;
populateKnowledgeBase(query);
}

function showKBArticle(id){
const article=knowledgeBase.find(kb=>kb.id===id);
if(!article)return;

$$('.tab[data-target="ai"]')[0].click();
addAIMessage(`<strong>ðŸ“š Knowledge Base: ${article.title}</strong><br><br>
<strong>Category:</strong> ${article.category}<br><br>
${article.content}<br><br>
<em>Need more specific guidance? Describe your situation and I can provide tailored advice.</em>`,'assistant');
}

function showIssueHistory(){
$('symptomCheckerSection').style.display='none';
$('knowledgeBaseSection').style.display='none';
$('issueHistorySection').style.display='block';

populateIssueHistory();

setTimeout(()=>{
$('issueHistorySection').scrollIntoView({behavior:'smooth',block:'start'});
},100);
}

function populateIssueHistory(){
const container=$('issueHistoryContent');

// Sample issue history (in real app, this would come from database)
const sampleIssues=[
{date:'2025-11-01',title:'High SVI (165 mL/g)',desc:'Filamentous bulking. Increased DO to 2.8 mg/L and added chlorine to RAS. SVI reduced to 128 mL/g within 5 days.',resolved:true},
{date:'2025-10-28',title:'Ammonia Breakthrough',desc:'Effluent NH3 spiked to 3.2 mg/L. Stopped WAS and increased MCRT. Industrial pretreatment violation identified as cause.',resolved:true},
{date:'2025-10-15',title:'Blower #2 Failure',desc:'Blower tripped on high vibration. Bearing replacement required. Operating on backup blower.',resolved:true},
{date:'2025-11-04',title:'High Effluent TSS',desc:'TSS at 38 mg/L. Investigating clarifier performance. Sludge blanket at 60% depth. Increased RAS rate.',resolved:false},
{date:'2025-11-05',title:'Low DO in Basin 2',desc:'DO dropped to 1.2 mg/L. Diffuser inspection scheduled. Currently using backup aeration zones.',resolved:false}
];

const combined=[...sampleIssues,...(state.issues||[])];

if(combined.length===0){
container.innerHTML=`
<div class="empty-state">
<div class="empty-state-icon">ðŸ“‹</div>
<div class="empty-state-title">No Issues Logged</div>
<div class="empty-state-message">Start tracking issues to build your operational history</div>
</div>
`;
return;
}

container.innerHTML=combined.map(issue=>`
<div class="issue-history-item ${issue.resolved?'resolved':''}">
<div class="issue-date">ðŸ“… ${issue.date} ${issue.resolved?'<span class="tag success">RESOLVED</span>':'<span class="tag warning">ACTIVE</span>'}</div>
<div class="issue-title">${issue.title}</div>
<div class="issue-desc">${issue.desc}</div>
</div>
`).join('');
}

function addNewIssue(){
const title=prompt('Issue Title:');
if(!title)return;
const desc=prompt('Description:');
if(!desc)return;

const issue={
date:new Date().toISOString().split('T')[0],
title:title,
desc:desc,
resolved:false
};

state.issues=state.issues||[];
state.issues.unshift(issue);

showToast('Issue logged successfully','success');
populateIssueHistory();
}

function exportDiagnostic(){
showToast('Exporting diagnostic report...','info');
setTimeout(()=>{
showToast('âœ“ Diagnostic report exported','success');
},1000);
}

// Loading calculations (abbreviated)
function calcLoading(){
const flow=Number($('flow').value);
const bod=Number($('bod').value);
const tss=Number($('tss').value);
const tkn=Number($('tkn').value);
const tp=Number($('tp').value);
const cod=Number($('cod').value);
const mgd2lbd=8.34;

const bodLoad=flow*bod*mgd2lbd;
const tssLoad=flow*tss*mgd2lbd;
const tknLoad=flow*tkn*mgd2lbd;
const tpLoad=flow*tp*mgd2lbd;
const codLoad=flow*cod*mgd2lbd;

$('r_bodLoad').textContent=fmt.n(bodLoad,0);
$('r_tssLoad').textContent=fmt.n(tssLoad,0);
$('r_tknLoad').textContent=fmt.n(tknLoad,0);
$('r_tpLoad').textContent=fmt.n(tpLoad,0);
$('r_codLoad').textContent=fmt.n(codLoad,0);

$('avg_bodLoad').textContent=fmt.n(bodLoad*0.95,0);
$('avg_tssLoad').textContent=fmt.n(tssLoad*0.98,0);
$('avg_tknLoad').textContent=fmt.n(tknLoad*1.02,0);
$('avg_tpLoad').textContent=fmt.n(tpLoad*0.97,0);
$('avg_codLoad').textContent=fmt.n(codLoad*0.96,0);

$('trend_bodLoad').textContent='â†‘ 5%';
$('trend_tssLoad').textContent='â†’ Stable';
$('trend_tknLoad').textContent='â†“ 2%';
$('trend_tpLoad').textContent='â†’ Stable';
$('trend_codLoad').textContent='â†‘ 4%';

$('s_bodLoad').textContent=bodLoad<8000?'âœ“ Normal':'âš  High';
$('s_bodLoad').className=bodLoad<8000?'status ok':'status warn';
$('s_tssLoad').textContent=tssLoad<9000?'âœ“ Normal':'âš  High';
$('s_tssLoad').className=tssLoad<9000?'status ok':'status warn';
$('s_tknLoad').textContent='âœ“ Normal';
$('s_tknLoad').className='status ok';
$('s_tpLoad').textContent='âœ“ Normal';
$('s_tpLoad').className='status ok';
$('s_codLoad').textContent='âœ“ Normal';
$('s_codLoad').className='status ok';

const mlvss=2000;
const aerVol=1.2;
const olr=bodLoad/(mlvss*aerVol*8.34);
$('stat_olr').textContent=fmt.f(olr,2);
$('stat_volLoad').textContent=fmt.f(bodLoad/(aerVol*7.48*1000),1);
$('stat_ratio').textContent=`100:${Math.round(tkn/bod*100)}:${Math.round(tp/bod*100)}`;

state.data={bodLoad,tssLoad,tknLoad,tpLoad,codLoad,flow,bod};
if($('kpi-flow'))$('kpi-flow').textContent=flow.toFixed(2);

showToast('Loading calculated successfully','success');
return state.data;
}

function resetLoading(){
$('flow').value='3.5';
$('bod').value='200';
$('tss').value='220';
$('tkn').value='40';
$('tp').value='8';
$('cod').value='450';
$('r_bodLoad').textContent='-';
$('r_tssLoad').textContent='-';
$('r_tknLoad').textContent='-';
$('r_tpLoad').textContent='-';
$('r_codLoad').textContent='-';
if($('s_bodLoad')){$('s_bodLoad').textContent='-';$('s_bodLoad').className='status';}
if($('s_tssLoad')){$('s_tssLoad').textContent='-';$('s_tssLoad').className='status';}
if($('s_tknLoad')){$('s_tknLoad').textContent='-';$('s_tknLoad').className='status';}
if($('s_tpLoad')){$('s_tpLoad').textContent='-';$('s_tpLoad').className='status';}
if($('s_codLoad')){$('s_codLoad').textContent='-';$('s_codLoad').className='status';}
showToast('Loading reset','info');
}

function compareHistorical(){
showToast('Comparing with 30-day historical average...','info');
setTimeout(()=>{
showToast('Current BOD load 5.2% above 30-day average','warning');
},1500);
}

function calcAll(){
calcLoading();
showToast('âœ¨ All calculations complete!','success');
}

// Sludge calculations
function calcSludge(){
const base=state.data.bodLoad?state.data:calcLoading();
const mlss=Number($('mlss').value);
const mlvss=Number($('mlvss').value);
const aerVol=Number($('aerVol').value);
const rasFlow=Number($('rasFlow').value);
const wasFlow=Number($('wasFlow').value);
const wasTss=Number($('wasTss').value);

const fm=base.bodLoad/(mlvss*aerVol*8.34);
const mlssInv=mlss*aerVol*8.34;
const wasSolids=wasFlow*wasTss*8.34;
const mcrt=mlssInv/wasSolids;
const svi=120;

$('r_fm').textContent=fmt.f(fm,2);
$('r_mcrt').textContent=fmt.f(mcrt,1);
$('r_svi').textContent=fmt.f(svi,0);

$('s_fm').textContent=fm>=0.2&&fm<=0.5?'âœ“ Optimal':'âš  Adjust';
$('s_fm').className=fm>=0.2&&fm<=0.5?'status ok':'status warn';
$('s_mcrt').textContent=mcrt>=6&&mcrt<=10?'âœ“ Good':'âš  Review';
$('s_mcrt').className=mcrt>=6&&mcrt<=10?'status ok':'status warn';
$('s_svi').textContent=svi<150?'âœ“ Good':'âš  High';
$('s_svi').className=svi<150?'status ok':'status warn';

if($('kpi-mlss'))$('kpi-mlss').textContent=mlss;
if($('kpi-fm'))$('kpi-fm').textContent=fmt.f(fm,2);

showToast('Sludge parameters calculated','success');
}

function resetSludge(){
$('mlss').value='2500';
$('mlvss').value='2000';
$('aerVol').value='1.2';
$('rasFlow').value='1.5';
$('wasFlow').value='0.05';
$('wasTss').value='8000';
$('r_fm').textContent='-';
$('r_mcrt').textContent='-';
$('r_svi').textContent='-';
if($('s_fm')){$('s_fm').textContent='-';$('s_fm').className='status';}
if($('s_mcrt')){$('s_mcrt').textContent='-';$('s_mcrt').className='status';}
if($('s_svi')){$('s_svi').textContent='-';$('s_svi').className='status';}
showToast('Sludge reset','info');
}

// Oxygen calculations
function calcOxygen(){
const base=state.data.bodLoad?state.data:calcLoading();
const peakFactor=Number($('peakFactor').value)||1.5;

const o2req=base.bodLoad*1.5;
const o2peak=o2req/24*peakFactor;
const airflow=o2peak*60/0.5;

$('r_o2req').textContent=fmt.n(o2req,0);
$('r_o2peak').textContent=fmt.n(o2peak,0);
$('r_airflow').textContent=fmt.n(airflow,0);

showToast('Oxygen requirements calculated','success');
}

function resetOxygen(){
$('doNow').value='2.0';
$('doTarget').value='2.5';
$('peakFactor').value='1.5';
$('r_o2req').textContent='-';
$('r_o2peak').textContent='-';
$('r_airflow').textContent='-';
showToast('Oxygen reset','info');
}

// Energy calculations
function calcEnergy(){
const base=state.data.flow?state.data:{flow:3.5};
const blowerHp=Number($('blowerHp').value);
const pumpHp=Number($('pumpHp').value);
const otherHp=Number($('otherHp').value);
const elecRate=Number($('elecRate').value);

const totPower=blowerHp+pumpHp+otherHp;
const dailyEnergy=totPower*0.746*24;
const monthCost=dailyEnergy*30*elecRate;
const kwhMg=dailyEnergy/base.flow;

$('r_dailyEnergy').textContent=fmt.n(dailyEnergy,0);
$('r_monthCost').textContent='$'+fmt.n(monthCost,0);
$('r_kwhMg').textContent=fmt.n(kwhMg,0);

if($('kpi-energy'))$('kpi-energy').textContent=fmt.n(kwhMg,0);

showToast('Energy analysis complete','success');
}

function resetEnergy(){
$('blowerHp').value='200';
$('pumpHp').value='100';
$('otherHp').value='50';
$('elecRate').value='0.12';
$('r_dailyEnergy').textContent='-';
$('r_monthCost').textContent='-';
$('r_kwhMg').textContent='-';
showToast('Energy reset','info');
}

function calcCosts(){
showToast('Cost analysis calculated','success');
}

function generateReport(type){
showToast(`Generating ${type} report...`,'info');
setTimeout(()=>showToast(`âœ“ ${type.toUpperCase()} report generated`,'success'),1500);
}

function saveProfile(){
showToast('âœ“ Profile saved successfully','success');
}

function loadProfile(){
showToast('Profile load functionality - use file selector','info');
}

function exportFullReport(){
showToast('âœ“ Full report exported successfully','success');
}

function refreshDashboard(){
showToast('âœ“ Dashboard refreshed','success');
}

function runOptimization(){
showToast('Running optimization analysis...','info');
setTimeout(()=>showToast('Optimization complete','success'),2000);
}

function predictTrends(){
showToast('ðŸ”® Predicting performance trends...','info');
}

// Sludge Age (SRT) Calculator
function calcSRT(){
  const mlss = parseFloat($('srt_mlss').value);
  const volume = parseFloat($('srt_volume').value);
  const effTSS = parseFloat($('srt_eff_tss').value);
  const effFlow = parseFloat($('srt_eff_flow').value);
  const wasteFlow = parseFloat($('srt_waste_flow').value);
  const wasteTSS = parseFloat($('srt_waste_tss').value);
  if(!mlss || !volume || !effTSS || !effFlow || !wasteFlow || !wasteTSS){
    $('srt_result').textContent='-';
    return;
  }
  const numerator = mlss * volume;
  const denominator = effFlow * effTSS + wasteFlow * wasteTSS;
  const srt = denominator === 0 ? 0 : numerator / denominator;
  $('srt_result').textContent = fmt.f(srt,2);
}

function resetSRT(){
  $('srt_mlss').value = 2500;
  $('srt_volume').value = 1.2;
  $('srt_eff_tss').value = 15;
  $('srt_eff_flow').value = 3.5;
  $('srt_waste_flow').value = 0.1;
  $('srt_waste_tss').value = 8000;
  $('srt_result').textContent = '-';
}

// BOD Removal Efficiency Calculator
function calcBODEff(){
  const influent = parseFloat($('bod_eff_in').value);
  const effluent = parseFloat($('bod_eff_out').value);
  if(!influent || influent === 0){
    $('bod_eff_result').textContent = '-';
    return;
  }
  const removal = ((influent - effluent) / influent) * 100;
  $('bod_eff_result').textContent = fmt.f(removal,1);
}

function resetBODEff(){
  $('bod_eff_in').value = 200;
  $('bod_eff_out').value = 10;
  $('bod_eff_result').textContent = '-';
}

// Sludge Volume Index (SVI) Calculator
function calcSVI(){
  const settledVol = parseFloat($('svi_volume').value);
  const mlss = parseFloat($('svi_mlss').value);
  if(!settledVol || !mlss || mlss === 0){
    $('svi_result').textContent = '-';
    return;
  }
  // SVI (mL/g) = (Settled volume mL/L * 1000) / MLSS (mg/L)
  const svi = (settledVol * 1000) / mlss;
  $('svi_result').textContent = fmt.f(svi,1);
}

function resetSVI(){
  $('svi_volume').value = 150;
  $('svi_mlss').value = 3000;
  $('svi_result').textContent = '-';
}

// ==================== MISSING ORIGINAL CALCULATOR FUNCTIONS ====================

// Clarifier Calculator
// ==================== CLARIFIER CALCULATOR ====================
function calcClarifier() {
  // Get inputs - auto-fill from loading tab if empty
  let flow = Number($('clar_flow').value);
  let mlss = Number($('clar_mlss').value);
  
  // Auto-fill from state if available
  if (!flow && state.data && state.data.flow) {
    flow = state.data.flow;
    $('clar_flow').value = flow;
  }
  if (!mlss) {
    mlss = 2500; // Default MLSS
    $('clar_mlss').value = mlss;
  }
  
  const diam = Number($('clar_diam').value) || 65;
  const rasFlow = Number($('clar_ras_flow').value) || 1.0;
  const weirLength = Number($('clar_weir').value) || 204;
  
  // Calculations
  const area = Math.PI * Math.pow(diam/2, 2); // ftÂ²
  const sor = (flow * 1000000) / area; // gpd/ftÂ²
  
  // SLR = (Q + Qr) Ã— MLSS Ã— 8.34 / Area / 24 hr
  const totalFlow = flow + rasFlow; // MGD
  const slr = (totalFlow * mlss * 8.34) / area / 24; // lb/hr/ftÂ²
  
  // WOR = Flow / Weir Length
  const wor = (flow * 1000000) / weirLength; // gpd/ft
  
  // Display results
  $('r_sor').textContent = fmt.n(sor, 0);
  $('r_slr').textContent = fmt.f(slr, 1);
  $('r_wor').textContent = fmt.n(wor, 0);
  
  // Status indicators
  if (sor >= 400 && sor <= 800) {
    $('s_sor').textContent = 'âœ“ Normal';
    $('s_sor').className = 'status ok';
  } else if (sor < 400) {
    $('s_sor').textContent = 'âš  Low';
    $('s_sor').className = 'status warn';
  } else {
    $('s_sor').textContent = 'âœ— High';
    $('s_sor').className = 'status bad';
  }
  
  if (slr < 50) {
    $('s_slr').textContent = 'âœ“ Normal';
    $('s_slr').className = 'status ok';
  } else {
    $('s_slr').textContent = 'âœ— Overloaded';
    $('s_slr').className = 'status bad';
  }
  
  if (wor < 15000) {
    $('s_wor').textContent = 'âœ“ Normal';
    $('s_wor').className = 'status ok';
  } else if (wor < 20000) {
    $('s_wor').textContent = 'âš  High';
    $('s_wor').className = 'status warn';
  } else {
    $('s_wor').textContent = 'âœ— Overloaded';
    $('s_wor').className = 'status bad';
  }
  
  showToast('Clarifier calculation complete', 'success');
}

function resetClarifier() {
  $('clar_flow').value = '';
  $('clar_diam').value = '65';
  $('clar_mlss').value = '';
  $('clar_ras_flow').value = '1.0';
  $('clar_weir').value = '204';
  
  // Clear results
  $('r_sor').textContent = '-';
  $('r_wor').textContent = '-';
  
  // Clear status
  if ($('s_sor')) { $('s_sor').textContent = '-'; $('s_sor').className = 'status'; }
  if ($('s_wor')) { $('s_wor').textContent = '-'; $('s_wor').className = 'status'; }
  
  showToast('Clarifier reset', 'info');
}

// ==================== NUTRIENTS CALCULATOR ====================
function calcNutrients() {
  // Get flow from loading tab if available
  let flow = state.data && state.data.flow ? state.data.flow : 3.5;
  
  const nh3In = Number($('nh3In').value) || 30;
  const nh3Out = Number($('nh3Out').value) || 1;
  
  // Calculate NH3-N removed (lb/d)
  const nh3Removed = (nh3In - nh3Out) * flow * 8.34;
  
  // Calculate % removal
  const pctRemoval = ((nh3In - nh3Out) / nh3In) * 100;
  
  // Display results
  $('r_nitrif').textContent = fmt.n(nh3Removed, 0);
  $('r_nitrifPct').textContent = fmt.f(pctRemoval, 1) + '%';
  
  showToast('Nutrients calculation complete', 'success');
}

// ==================== DISINFECTION CALCULATOR ====================
function calcDisinfection() {
  // Get flow - auto-fill from loading tab
  let flow = Number($('dis_flow').value);
  if (!flow && state.data && state.data.flow) {
    flow = state.data.flow;
    $('dis_flow').value = flow;
  }
  
  const vol = Number($('dis_vol').value) || 70000; // gallons
  const dose = Number($('dis_dose').value) || 8.0; // mg/L
  const residual = Number($('dis_residual').value) || 1.5; // mg/L
  
  // Detention Time = Volume / Flow (minutes)
  const detentionTime = vol / (flow * 1000000 / 1440); // minutes
  
  // Chlorine Demand = Dose - Residual
  const cl2Demand = dose - residual;
  
  // CT Value = Residual Ã— Detention Time
  const ctValue = residual * detentionTime;
  
  // Display results
  $('r_detention_time').textContent = fmt.f(detentionTime, 1);
  $('r_cl2_demand').textContent = fmt.f(cl2Demand, 1);
  $('r_ct_value').textContent = fmt.f(ctValue, 1);
  
  // Status indicators
  if (detentionTime >= 30) {
    $('s_detention_time').textContent = 'âœ“ Adequate';
    $('s_detention_time').className = 'status ok';
  } else if (detentionTime >= 20) {
    $('s_detention_time').textContent = 'âš  Low';
    $('s_detention_time').className = 'status warn';
  } else {
    $('s_detention_time').textContent = 'âœ— Inadequate';
    $('s_detention_time').className = 'status bad';
  }
  
  if (ctValue >= 40) {
    $('s_ct_value').textContent = 'âœ“ Adequate';
    $('s_ct_value').className = 'status ok';
  } else if (ctValue >= 30) {
    $('s_ct_value').textContent = 'âš  Low';
    $('s_ct_value').className = 'status warn';
  } else {
    $('s_ct_value').textContent = 'âœ— Inadequate';
    $('s_ct_value').className = 'status bad';
  }
  
  showToast('Disinfection calculation complete', 'success');
}

function resetDisinfection() {
  $('dis_flow').value = '';
  $('dis_vol').value = '70000';
  $('dis_dose').value = '8.0';
  $('dis_residual').value = '1.5';
  
  $('r_detention_time').textContent = '-';
  $('r_cl2_demand').textContent = '-';
  $('r_ct_value').textContent = '-';
  if($('s_detention_time')){$('s_detention_time').textContent='-';$('s_detention_time').className='status';}
  if($('s_ct_value')){$('s_ct_value').textContent='-';$('s_ct_value').className='status';}
  
  showToast('Disinfection reset', 'info');
}

// ==================== DOSING CALCULATOR ====================
function calcDosing() {
  // Get flow - auto-fill from loading tab
  let flow = Number($('dosing_flow').value);
  if (!flow && state.data && state.data.flow) {
    flow = state.data.flow;
    $('dosing_flow').value = flow;
  }
  if (!flow) flow = 3.5; // Default
  
  // FERRIC CHLORIDE CALCULATIONS
  const feDose = Number($('fe_dose').value) || 40;
  const fePct = Number($('fe_pct').value) || 38;
  const feSG = Number($('fe_sg').value) || 1.4;
  const fePumpMax = Number($('fe_pump_max').value) || 20;
  const feStock = Number($('fe_stock_gal').value) || 5000;
  
  // Solution weight (lb/gal) = % Ã— SG Ã— 8.34
  const feSolWgt = (fePct / 100) * feSG * 8.34;
  
  // Chemical feed (lb/day) = Flow Ã— Dose Ã— 8.34
  const feChemFeed = flow * feDose * 8.34;
  
  // Solution feed (gal/day) = Chemical feed / Solution weight
  const feGPD = feChemFeed / feSolWgt;
  const feGPH = feGPD / 24;
  const feMLMin = feGPH * 3785.41 / 60; // Convert gph to mL/min
  
  // Pump setting % = (Required gph / Max gph) Ã— 100
  const fePumpPct = (feGPH / fePumpMax) * 100;
  
  // Inventory
  const feUsageGPD = feGPD;
  const feDaysLeft = feStock / feUsageGPD;
  
  // Display Ferric results
  $('r_fe_sol_wgt').textContent = fmt.f(feSolWgt, 2);
  $('r_fe_chem_feed').textContent = fmt.n(feChemFeed, 0);
  $('r_fe_gpd').textContent = fmt.n(feGPD, 0);
  $('r_fe_gph').textContent = fmt.f(feGPH, 1);
  $('r_fe_ml_min').textContent = fmt.n(feMLMin, 0);
  $('r_fe_pump_pct').textContent = fmt.f(fePumpPct, 1);
  $('r_fe_usage_gpd').textContent = fmt.n(feUsageGPD, 0);
  $('r_fe_days_left').textContent = fmt.f(feDaysLeft, 1);
  
  if (feDaysLeft > 14) {
    $('s_fe_status').textContent = 'âœ“ Good';
    $('s_fe_status').className = 'status ok';
  } else if (feDaysLeft > 7) {
    $('s_fe_status').textContent = 'âš  Low';
    $('s_fe_status').className = 'status warn';
  } else {
    $('s_fe_status').textContent = 'âœ— Critical';
    $('s_fe_status').className = 'status bad';
  }
  
  // ALUMINUM SULFATE CALCULATIONS
  const alDose = Number($('al_dose').value) || 100;
  const alPct = Number($('al_pct').value) || 48.5;
  const alSG = Number($('al_sg').value) || 1.33;
  const alPumpMax = Number($('al_pump_max').value) || 40;
  const alStock = Number($('al_stock_gal').value) || 8000;
  
  const alSolWgt = (alPct / 100) * alSG * 8.34;
  const alChemFeed = flow * alDose * 8.34;
  const alGPD = alChemFeed / alSolWgt;
  const alGPH = alGPD / 24;
  const alMLMin = alGPH * 3785.41 / 60;
  const alPumpPct = (alGPH / alPumpMax) * 100;
  const alUsageGPD = alGPD;
  const alDaysLeft = alStock / alUsageGPD;
  
  // Display Alum results
  $('r_al_sol_wgt').textContent = fmt.f(alSolWgt, 2);
  $('r_al_chem_feed').textContent = fmt.n(alChemFeed, 0);
  $('r_al_gpd').textContent = fmt.n(alGPD, 0);
  $('r_al_gph').textContent = fmt.f(alGPH, 1);
  $('r_al_ml_min').textContent = fmt.n(alMLMin, 0);
  $('r_al_pump_pct').textContent = fmt.f(alPumpPct, 1);
  $('r_al_usage_gpd').textContent = fmt.n(alUsageGPD, 0);
  $('r_al_days_left').textContent = fmt.f(alDaysLeft, 1);
  
  if (alDaysLeft > 14) {
    $('s_al_status').textContent = 'âœ“ Good';
    $('s_al_status').className = 'status ok';
  } else if (alDaysLeft > 7) {
    $('s_al_status').textContent = 'âš  Low';
    $('s_al_status').className = 'status warn';
  } else {
    $('s_al_status').textContent = 'âœ— Critical';
    $('s_al_status').className = 'status bad';
  }
  
  showToast('Dosing calculation complete', 'success');
}

function resetDosing() {
  $('dosing_flow').value = '';
  $('fe_dose').value = '40';
  $('fe_pct').value = '38';
  $('fe_sg').value = '1.4';
  $('fe_pump_max').value = '20';
  $('fe_stock_gal').value = '5000';
  $('al_dose').value = '100';
  $('al_pct').value = '48.5';
  $('al_sg').value = '1.33';
  $('al_pump_max').value = '40';
  $('al_stock_gal').value = '8000';
  
  // Clear Ferric results
  $('r_fe_sol_wgt').textContent = '-';
  $('r_fe_chem_feed').textContent = '-';
  $('r_fe_gpd').textContent = '-';
  $('r_fe_gph').textContent = '-';
  $('r_fe_ml_min').textContent = '-';
  $('r_fe_pump_pct').textContent = '-';
  $('r_fe_days_left').textContent = '-';
  if ($('s_fe_pump')) { $('s_fe_pump').textContent = '-'; $('s_fe_pump').className = 'status'; }
  if ($('s_fe_stock')) { $('s_fe_stock').textContent = '-'; $('s_fe_stock').className = 'status'; }
  
  // Clear Alum results
  $('r_al_sol_wgt').textContent = '-';
  $('r_al_chem_feed').textContent = '-';
  $('r_al_gpd').textContent = '-';
  $('r_al_gph').textContent = '-';
  $('r_al_ml_min').textContent = '-';
  $('r_al_pump_pct').textContent = '-';
  $('r_al_days_left').textContent = '-';
  if ($('s_al_pump')) { $('s_al_pump').textContent = '-'; $('s_al_pump').className = 'status'; }
  if ($('s_al_stock')) { $('s_al_stock').textContent = '-'; $('s_al_stock').className = 'status'; }
  
  showToast('Dosing reset', 'info');
}

// ==================== DIGESTER CALCULATOR ====================
function calcDigester() {
  const vsIn = Number($('dig_vs_in').value) || 4500;
  const vsOut = Number($('dig_vs_out').value) || 2000;
  const volMG = Number($('dig_vol_mg').value) || 0.75;
  const biogasYield = Number($('dig_yield').value) || 15; // cf/lb VS destroyed
  
  // VS Destroyed (lb/d)
  const vsDestroyed = vsIn - vsOut;
  
  // Volatile Solids Reduction (%)
  const vsr = (vsDestroyed / vsIn) * 100;
  
  // Digester Loading Rate (lb VS/cf/d)
  const volCF = volMG * 1000000 / 7.48; // Convert MG to cubic feet
  const loadingRate = vsIn / volCF;
  
  // Estimated Biogas Production (cf/day)
  const biogas = vsDestroyed * biogasYield;
  
  // Display results
  $('r_vs_destroyed').textContent = fmt.n(vsDestroyed, 0);
  $('r_vsr').textContent = fmt.f(vsr, 1);
  $('r_loading_rate').textContent = fmt.f(loadingRate, 3);
  $('r_biogas').textContent = fmt.n(biogas, 0);
  
  // Status indicators
  if (vsr >= 50) {
    $('s_vsr').textContent = 'âœ“ Good';
    $('s_vsr').className = 'status ok';
  } else if (vsr >= 40) {
    $('s_vsr').textContent = 'âš  Low';
    $('s_vsr').className = 'status warn';
  } else {
    $('s_vsr').textContent = 'âœ— Poor';
    $('s_vsr').className = 'status bad';
  }
  
  if (loadingRate >= 0.15 && loadingRate <= 0.35) {
    $('s_loading_rate').textContent = 'âœ“ Normal';
    $('s_loading_rate').className = 'status ok';
  } else if (loadingRate < 0.15) {
    $('s_loading_rate').textContent = 'âš  Underloaded';
    $('s_loading_rate').className = 'status warn';
  } else {
    $('s_loading_rate').textContent = 'âœ— Overloaded';
    $('s_loading_rate').className = 'status bad';
  }
  
  showToast('Digester calculation complete', 'success');
}

function resetDigester() {
  $('dig_vs_in').value = '4500';
  $('dig_vs_out').value = '2000';
  $('dig_vol_mg').value = '0.75';
  $('dig_yield').value = '15';
  
  $('r_vs_destroyed').textContent = '-';
  $('r_vsr').textContent = '-';
  $('r_loading_rate').textContent = '-';
  $('r_biogas').textContent = '-';
  if($('s_vsr')){$('s_vsr').textContent='-';$('s_vsr').className='status';}
  if($('s_loading_rate')){$('s_loading_rate').textContent='-';$('s_loading_rate').className='status';}
  
  showToast('Digester reset', 'info');
}

// ==================== DEWATERING CALCULATOR ====================
function calcDewatering() {
  const feedFlow = Number($('dew_feed_flow').value) || 100; // gpm
  const feedSolids = Number($('dew_feed_solids').value) || 3.0; // %
  const polyFlow = Number($('dew_poly_flow').value) || 20; // gph
  const polyConc = Number($('dew_poly_conc').value) || 0.5; // %
  const cakeSolids = Number($('dew_cake_solids').value) || 18; // %
  const filtrateTSS = Number($('dew_filtrate_tss').value) || 500; // mg/L
  
  // Dry Solids In (lb/hr)
  const drySolidsIn = feedFlow * 60 * 8.34 * (feedSolids / 100);
  
  // Polymer Dose (lb/ton)
  const polyLbHr = polyFlow * 8.34 * (polyConc / 100); // lb polymer/hr
  const polyDose = (polyLbHr / (drySolidsIn / 2000)) * 1; // lb polymer/ton dry solids
  
  // Solids Capture Rate (%)
  // Solids out in cake vs total solids in
  const totalSolidsLbHr = drySolidsIn;
  const filtrateLbHr = (feedFlow * 60 * 8.34 * filtrateTSS) / 1000000; // Convert mg/L to lb/hr
  const capturedSolids = totalSolidsLbHr - filtrateLbHr;
  const captureRate = (capturedSolids / totalSolidsLbHr) * 100;
  
  // Cake Production (wet ton/day)
  const cakeLbDay = (drySolidsIn * 24) / (cakeSolids / 100);
  const cakeTonDay = cakeLbDay / 2000;
  
  // Display results
  $('r_dry_solids_in').textContent = fmt.n(drySolidsIn, 0);
  $('r_poly_dose').textContent = fmt.f(polyDose, 1);
  $('r_solids_capture').textContent = fmt.f(captureRate, 1);
  $('r_cake_prod').textContent = fmt.f(cakeTonDay, 1);
  
  // Status indicators
  if (polyDose >= 15 && polyDose <= 30) {
    $('s_poly_dose').textContent = 'âœ“ Normal';
    $('s_poly_dose').className = 'status ok';
  } else if (polyDose < 15) {
    $('s_poly_dose').textContent = 'âš  Low';
    $('s_poly_dose').className = 'status warn';
  } else {
    $('s_poly_dose').textContent = 'âš  High';
    $('s_poly_dose').className = 'status warn';
  }
  
  if (captureRate >= 95) {
    $('s_solids_capture').textContent = 'âœ“ Excellent';
    $('s_solids_capture').className = 'status ok';
  } else if (captureRate >= 90) {
    $('s_solids_capture').textContent = 'âš  Fair';
    $('s_solids_capture').className = 'status warn';
  } else {
    $('s_solids_capture').textContent = 'âœ— Poor';
    $('s_solids_capture').className = 'status bad';
  }
  
  showToast('Dewatering calculation complete', 'success');
}

function resetDewatering() {
  $('dew_feed_flow').value = '100';
  $('dew_feed_solids').value = '3.0';
  $('dew_poly_flow').value = '20';
  $('dew_poly_conc').value = '0.5';
  $('dew_cake_solids').value = '18';
  $('dew_filtrate_tss').value = '500';
  
  $('r_dry_solids_in').textContent = '-';
  $('r_poly_dose').textContent = '-';
  $('r_cake_prod').textContent = '-';
  $('r_solids_capture').textContent = '-';
  if($('s_poly_dose')){$('s_poly_dose').textContent='-';$('s_poly_dose').className='status';}
  if($('s_solids_capture')){$('s_solids_capture').textContent='-';$('s_solids_capture').className='status';}
  
  showToast('Dewatering reset', 'info');
}

// ==================== PUMPING CALCULATOR ====================
function calcPumping() {
  const flow = Number($('pump_flow').value) || 1000; // gpm
  const head = Number($('pump_head').value) || 50; // ft
  const pumpEff = Number($('pump_eff').value) || 75; // %
  const motorEff = Number($('motor_eff').value) || 90; // %
  const costPerKWH = 0.12; // $/kWh - typical utility rate
  
  // Water Horsepower (WHP) = (Flow Ã— Head Ã— SG) / 3960
  const whp = (flow * head * 1.0) / 3960;
  
  // Brake Horsepower (BHP) = WHP / Pump Efficiency
  const bhp = whp / (pumpEff / 100);
  
  // Wire-to-Water HP = WHP / (Pump Eff Ã— Motor Eff)
  const wireHP = whp / ((pumpEff / 100) * (motorEff / 100));
  
  // Power Consumption (kW) = HP Ã— 0.746
  const powerKW = wireHP * 0.746;
  
  // Daily Energy Cost = kW Ã— 24 hours Ã— cost per kWh
  const dailyCost = powerKW * 24 * costPerKWH;
  
  // Display results
  $('r_whp').textContent = fmt.f(whp, 2);
  $('r_bhp').textContent = fmt.f(bhp, 2);
  $('r_wire_hp').textContent = fmt.f(wireHP, 2);
  $('r_power_kw').textContent = fmt.f(powerKW, 2);
  $('r_pump_cost').textContent = '$' + fmt.f(dailyCost, 2);
  
  showToast('Pumping calculation complete', 'success');
}

function resetPumping() {
  $('pump_flow').value = '1000';
  $('pump_head').value = '50';
  $('pump_eff').value = '75';
  $('motor_eff').value = '90';
  
  $('r_whp').textContent = '-';
  $('r_bhp').textContent = '-';
  $('r_wire_hp').textContent = '-';
  $('r_power_kw').textContent = '-';
  $('r_pump_cost').textContent = '-';
  
  showToast('Pumping reset', 'info');
}

// ==================== NEW ADVANCED CALCULATOR FUNCTIONS ====================

// 1. OLR Calculator
function calcOLR() {
  const bod = parseFloat($('olr_bod').value);
  const flow = parseFloat($('olr_flow').value);
  const volume = parseFloat($('olr_volume').value);
  
  if (!bod || !flow || !volume) {
    $('olr_result').textContent = '-';
    return;
  }
  
  const bodLoad = bod * flow * 8.34;
  const volumeFt3 = volume * 1000000 / 7.48;
  const olr = (bodLoad / volumeFt3) * 1000;
  
  $('olr_result').textContent = fmt.f(olr, 1);
  showToast('OLR calculated successfully', 'success');
}

function resetOLR() {
  $('olr_bod').value = 200;
  $('olr_flow').value = 3.5;
  $('olr_volume').value = 1.2;
  $('olr_result').textContent = '-';
}

// 2. VLR Calculator
function calcVLR() {
  const bod = parseFloat($('vlr_bod').value);
  const flow = parseFloat($('vlr_flow').value);
  const volume = parseFloat($('vlr_volume').value);
  
  if (!bod || !flow || !volume) {
    $('vlr_result').textContent = '-';
    return;
  }
  
  const vlr = (bod * flow * 8.34) / volume;
  
  $('vlr_result').textContent = fmt.n(vlr, 0);
  showToast('VLR calculated successfully', 'success');
}

function resetVLR() {
  $('vlr_bod').value = 180;
  $('vlr_flow').value = 3.5;
  $('vlr_volume').value = 1.0;
  $('vlr_result').textContent = '-';
}

// 3. RAS Calculator
function calcRAS() {
  const flow = parseFloat($('ras_flow').value);
  const ratio = parseFloat($('ras_ratio').value);
  const mlss = parseFloat($('ras_mlss').value);
  const rasConc = parseFloat($('ras_conc').value);
  
  if (!flow || !ratio) {
    $('ras_result').textContent = '-';
    $('ras_required').textContent = '-';
    return;
  }
  
  const rasFlow = flow * (ratio / 100);
  $('ras_result').textContent = fmt.f(rasFlow, 2);
  
  if (mlss && rasConc && rasConc > mlss) {
    const requiredRatio = (mlss / (rasConc - mlss)) * 100;
    $('ras_required').textContent = fmt.f(requiredRatio, 1);
  } else {
    $('ras_required').textContent = '-';
  }
  
  showToast('RAS flow calculated', 'success');
}

function resetRAS() {
  $('ras_flow').value = 3.5;
  $('ras_ratio').value = 75;
  $('ras_mlss').value = 2500;
  $('ras_conc').value = 8000;
  $('ras_result').textContent = '-';
  $('ras_required').textContent = '-';
}

// 4. Detention Time Calculator
function calcDetention() {
  const volume = parseFloat($('dt_volume').value);
  const flow = parseFloat($('dt_flow').value);
  
  if (!volume || !flow) {
    $('dt_result_hours').textContent = '-';
    $('dt_result_days').textContent = '-';
    return;
  }
  
  const detentionDays = volume / flow;
  const detentionHours = detentionDays * 24;
  
  $('dt_result_hours').textContent = fmt.f(detentionHours, 1);
  $('dt_result_days').textContent = fmt.f(detentionDays, 2);
  showToast('Detention time calculated', 'success');
}

function resetDetention() {
  $('dt_volume').value = 1.2;
  $('dt_flow').value = 3.5;
  $('dt_result_hours').textContent = '-';
  $('dt_result_days').textContent = '-';
}

// 5. WOR Calculator
function calcWOR() {
  const flow = parseFloat($('wor_flow').value);
  const length = parseFloat($('wor_length').value);
  
  if (!flow || !length) {
    $('wor_result').textContent = '-';
    return;
  }
  
  const wor = (flow * 1000000) / length;
  
  $('wor_result').textContent = fmt.n(wor, 0);
  showToast('WOR calculated', 'success');
}

function resetWOR() {
  $('wor_flow').value = 3.5;
  $('wor_length').value = 250;
  $('wor_result').textContent = '-';
}

// 6. SLR Calculator
function calcSLR() {
  const flow = parseFloat($('slr_flow').value);
  const area = parseFloat($('slr_area').value);
  
  if (!flow || !area) {
    $('slr_result').textContent = '-';
    $('slr_overflow').textContent = '-';
    return;
  }
  
  const slr = (flow * 1000000) / area;
  const overflow = slr * 0.04075;
  
  $('slr_result').textContent = fmt.n(slr, 0);
  $('slr_overflow').textContent = fmt.f(overflow, 2);
  showToast('SLR calculated', 'success');
}

function resetSLR() {
  $('slr_flow').value = 3.5;
  $('slr_area').value = 5000;
  $('slr_result').textContent = '-';
  $('slr_overflow').textContent = '-';
}

// 7. Alkalinity Calculator
function calcAlkalinity() {
  const influent = parseFloat($('alk_influent').value);
  const nitrification = parseFloat($('alk_nitrification').value);
  const denitrification = parseFloat($('alk_denitrification').value);
  
  if (!influent) {
    $('alk_consumed').textContent = '-';
    $('alk_produced').textContent = '-';
    $('alk_net').textContent = '-';
    return;
  }
  
  const consumed = nitrification * 7.14;
  const produced = denitrification * 3.57;
  const net = influent - consumed + produced;
  
  $('alk_consumed').textContent = fmt.f(consumed, 1);
  $('alk_produced').textContent = fmt.f(produced, 1);
  $('alk_net').textContent = fmt.f(net, 1);
  showToast('Alkalinity balance calculated', 'success');
}

function resetAlkalinity() {
  $('alk_influent').value = 180;
  $('alk_nitrification').value = 25;
  $('alk_denitrification').value = 15;
  $('alk_consumed').textContent = '-';
  $('alk_produced').textContent = '-';
  $('alk_net').textContent = '-';
}

// 8. Oxygen Requirements Calculator
function calcOxygenReq() {
  const bodRemoved = parseFloat($('o2_bod').value);
  const nh3Oxidized = parseFloat($('o2_nh3').value);
  const endoFactor = parseFloat($('o2_endo').value);
  const mlss = parseFloat($('o2_mlss').value);
  const volume = parseFloat($('o2_volume').value);
  
  if (!bodRemoved) {
    $('o2_total').textContent = '-';
    $('o2_rate').textContent = '-';
    return;
  }
  
  const biomassProd = bodRemoved * 0.5;
  const endoResp = mlss && volume ? endoFactor * mlss * volume * 8.34 : 0;
  const o2Total = bodRemoved + (4.57 * nh3Oxidized) - (1.42 * biomassProd) + endoResp;
  const o2Rate = o2Total / 24;
  
  $('o2_total').textContent = fmt.n(o2Total, 0);
  $('o2_rate').textContent = fmt.f(o2Rate, 1);
  showToast('Oxygen requirements calculated', 'success');
}

function resetOxygenReq() {
  $('o2_bod').value = 5835;
  $('o2_nh3').value = 730;
  $('o2_endo').value = 0.12;
  $('o2_mlss').value = 2500;
  $('o2_volume').value = 1.2;
  $('o2_total').textContent = '-';
  $('o2_rate').textContent = '-';
}

// 9. Air Requirements Calculator
function calcAir() {
  const o2Required = parseFloat($('air_o2').value);
  const ote = parseFloat($('air_ote').value);
  const depth = parseFloat($('air_depth').value);
  
  if (!o2Required || !ote) {
    $('air_scfm').textContent = '-';
    $('air_hp').textContent = '-';
    return;
  }
  
  const airLbMin = o2Required / 60 / (0.232 * ote / 100);
  const airSCFM = airLbMin / 0.075;
  
  const pressurePsi = 14.7 + (depth * 0.433);
  const pressureRatio = pressurePsi / 14.7;
  const efficiency = 0.7;
  const hp = (airSCFM * pressureRatio) / (efficiency * 229);
  
  $('air_scfm').textContent = fmt.n(airSCFM, 0);
  $('air_hp').textContent = fmt.f(hp, 1);
  showToast('Air requirements calculated', 'success');
}

function resetAir() {
  $('air_o2').value = 450;
  $('air_ote').value = 12;
  $('air_depth').value = 15;
  $('air_temp').value = 20;
  $('air_scfm').textContent = '-';
  $('air_hp').textContent = '-';
}

// 10. Polymer Dosage Calculator
function calcPolymer() {
  const flow = parseFloat($('poly_flow').value);
  const tss = parseFloat($('poly_tss').value);
  const dose = parseFloat($('poly_dose').value);
  const conc = parseFloat($('poly_conc').value);
  
  if (!flow || !tss || !dose || !conc) {
    $('poly_feed').textContent = '-';
    $('poly_daily').textContent = '-';
    return;
  }
  
  const drySolids = (flow * (tss / 100) * 8.34 * 1440) / 2000;
  const polymerLb = drySolids * dose;
  const feedGPD = polymerLb / (conc / 100 * 8.34);
  
  $('poly_feed').textContent = fmt.f(feedGPD, 1);
  $('poly_daily').textContent = fmt.f(polymerLb, 1);
  showToast('Polymer dosage calculated', 'success');
}

function resetPolymer() {
  $('poly_flow').value = 100;
  $('poly_tss').value = 2.5;
  $('poly_dose').value = 10;
  $('poly_conc').value = 0.5;
  $('poly_feed').textContent = '-';
  $('poly_daily').textContent = '-';
}

// 11. pH Adjustment Calculator
function calcPH() {
  const flow = parseFloat($('ph_flow').value);
  const current = parseFloat($('ph_current').value);
  const target = parseFloat($('ph_target').value);
  const chemical = $('ph_chemical').value;
  const strength = parseFloat($('ph_strength').value);
  
  if (!flow || !current || !target || !strength) {
    $('ph_feed').textContent = '-';
    $('ph_daily').textContent = '-';
    return;
  }
  
  const pHChange = Math.abs(target - current);
  const alkChange = pHChange * 100;
  
  const factors = {naoh: 1.25, lime: 1.79, h2so4: 1.02, hcl: 1.37};
  const chemicalNeeded = alkChange * factors[chemical];
  const chemicalLbDay = flow * chemicalNeeded * 8.34;
  
  const sg = {naoh: 1.5, lime: 1.2, h2so4: 1.8, hcl: 1.2};
  const feedGPD = chemicalLbDay / ((strength / 100) * 8.34 * sg[chemical]);
  
  $('ph_feed').textContent = fmt.f(feedGPD, 1);
  $('ph_daily').textContent = fmt.n(chemicalLbDay, 0);
  showToast('pH adjustment calculated (jar test recommended)', 'warning');
}

function resetPH() {
  $('ph_flow').value = 3.5;
  $('ph_current').value = 5.8;
  $('ph_target').value = 7.0;
  $('ph_chemical').value = 'naoh';
  $('ph_strength').value = 50;
  $('ph_feed').textContent = '-';
  $('ph_daily').textContent = '-';
}

// 12. Chlorine Dosage Calculator
function calcChlorine() {
  const flow = parseFloat($('cl_flow').value);
  const dose = parseFloat($('cl_dose').value);
  const type = $('cl_type').value;
  const time = parseFloat($('cl_time').value);
  
  if (!flow || !dose) {
    $('cl_feed').textContent = '-';
    $('cl_ct').textContent = '-';
    $('cl_cost').textContent = '-';
    return;
  }
  
  const clLbDay = flow * dose * 8.34;
  
  const strengths = {gas: 1.0, hypo: 0.125, bleach: 0.0525, tablet: 0.65};
  const sgs = {gas: 1.0, hypo: 1.2, bleach: 1.05, tablet: 1.0};
  
  let feedRate;
  if (type === 'gas') {
    feedRate = clLbDay;
    $('cl_unit').textContent = 'lb/day';
  } else {
    feedRate = clLbDay / (strengths[type] * 8.34 * sgs[type]);
    $('cl_unit').textContent = 'GPD';
  }
  
  const ct = dose * time;
  const costPerDay = type !== 'gas' ? feedRate * 2.50 : feedRate * 0.80;
  
  $('cl_feed').textContent = type === 'gas' ? fmt.n(feedRate, 0) : fmt.f(feedRate, 1);
  $('cl_ct').textContent = fmt.f(ct, 1);
  $('cl_cost').textContent = fmt.f(costPerDay, 2);
  showToast('Chlorine dosage calculated', 'success');
}

function resetChlorine() {
  $('cl_flow').value = 3.5;
  $('cl_dose').value = 8;
  $('cl_type').value = 'gas';
  $('cl_time').value = 30;
  $('cl_feed').textContent = '-';
  $('cl_ct').textContent = '-';
  $('cl_cost').textContent = '-';
  $('cl_unit').textContent = 'lb/day';
}

// 13. Enhanced SRT Calculator
function calcSRTEnhanced() {
  const mlss = parseFloat($('srt_enh_mlss').value);
  const volume = parseFloat($('srt_enh_volume').value);
  const effTSS = parseFloat($('srt_enh_eff_tss').value);
  const effFlow = parseFloat($('srt_enh_eff_flow').value);
  const wasteFlow = parseFloat($('srt_enh_waste_flow').value);
  const wasteTSS = parseFloat($('srt_enh_waste_tss').value);
  
  if (!mlss || !volume || !effFlow || !wasteFlow) {
    $('srt_enh_result').textContent = '-';
    $('srt_classification').textContent = '-';
    return;
  }
  
  const numerator = mlss * volume;
  const denominator = effTSS * effFlow + wasteTSS * wasteFlow;
  const srt = denominator > 0 ? numerator / denominator : 0;
  
  $('srt_enh_result').textContent = fmt.f(srt, 1);
  
  let classification = '';
  if (srt < 2) classification = 'High-Rate';
  else if (srt < 5) classification = 'Conventional (Short)';
  else if (srt < 15) classification = 'Conventional';
  else if (srt < 20) classification = 'Extended Aeration';
  else classification = 'Extended Aeration (Long)';
  
  $('srt_classification').textContent = classification;
  showToast('Enhanced SRT calculated', 'success');
}

function resetSRTEnhanced() {
  $('srt_enh_mlss').value = 2500;
  $('srt_enh_volume').value = 1.2;
  $('srt_enh_eff_tss').value = 15;
  $('srt_enh_eff_flow').value = 3.5;
  $('srt_enh_waste_flow').value = 0.1;
  $('srt_enh_waste_tss').value = 8000;
  $('srt_enh_result').textContent = '-';
  $('srt_classification').textContent = '-';
}

// 14. BOD Efficiency Calculator
function calcBODEfficiency() {
  const bodIn = parseFloat($('bodeff_in').value);
  const bodOut = parseFloat($('bodeff_out').value);
  const flow = parseFloat($('bodeff_flow').value);
  
  if (!bodIn || bodIn === 0) {
    $('bodeff_percent').textContent = '-';
    $('bodeff_removed').textContent = '-';
    $('bodeff_status').textContent = '-';
    return;
  }
  
  const efficiency = ((bodIn - bodOut) / bodIn) * 100;
  const bodRemoved = (bodIn - bodOut) * flow * 8.34;
  
  $('bodeff_percent').textContent = fmt.f(efficiency, 1);
  $('bodeff_removed').textContent = fmt.n(bodRemoved, 0);
  
  let status = '';
  if (efficiency >= 95) status = 'âœ“ Excellent (Tertiary)';
  else if (efficiency >= 90) status = 'âœ“ Very Good (Advanced)';
  else if (efficiency >= 85) status = 'âœ“ Good (Secondary)';
  else if (efficiency >= 75) status = 'âš  Marginal';
  else status = 'âœ— Poor';
  
  $('bodeff_status').textContent = status;
  showToast('BOD efficiency calculated', 'success');
}

function resetBODEfficiency() {
  $('bodeff_in').value = 200;
  $('bodeff_out').value = 10;
  $('bodeff_flow').value = 3.5;
  $('bodeff_percent').textContent = '-';
  $('bodeff_removed').textContent = '-';
  $('bodeff_status').textContent = '-';
}

// 15. SVI Calculator Enhanced
function calcSVICalc() {
  const volume = parseFloat($('svi_vol').value);
  const mlss = parseFloat($('svi_mlss_calc').value);
  
  if (!volume || !mlss || mlss === 0) {
    $('svi_calc_result').textContent = '-';
    $('svi_quality').textContent = '-';
    return;
  }
  
  const svi = (volume * 1000) / mlss;
  
  $('svi_calc_result').textContent = fmt.f(svi, 1);
  
  let quality = '';
  if (svi < 50) quality = 'âœ— Very Poor Settling';
  else if (svi < 100) quality = 'âœ“ Excellent';
  else if (svi < 150) quality = 'âœ“ Good';
  else if (svi < 200) quality = 'âš  Fair';
  else quality = 'âœ— Poor (Bulking)';
  
  $('svi_quality').textContent = quality;
  showToast('SVI calculated', 'success');
}

function resetSVICalc() {
  $('svi_vol').value = 150;
  $('svi_mlss_calc').value = 3000;
  $('svi_calc_result').textContent = '-';
  $('svi_quality').textContent = '-';
}

// 16. Nitrogen Balance Calculator
function calcNitrogen() {
  const tknIn = parseFloat($('n_tkn_in').value);
  const nh3In = parseFloat($('n_nh3_in').value);
  const tknOut = parseFloat($('n_tkn_out').value);
  const nh3Out = parseFloat($('n_nh3_out').value);
  const no3Out = parseFloat($('n_no3_out').value);
  const flow = parseFloat($('n_flow').value);
  
  if (!tknIn || tknIn === 0) {
    $('n_tkn_eff').textContent = '-';
    $('n_nh3_eff').textContent = '-';
    $('n_total_removed').textContent = '-';
    $('n_denit_eff').textContent = '-';
    return;
  }
  
  const tknEff = ((tknIn - tknOut) / tknIn) * 100;
  const nh3Eff = nh3In > 0 ? ((nh3In - nh3Out) / nh3In) * 100 : 0;
  const totalNRemoved = (tknIn - tknOut - no3Out) * flow * 8.34;
  
  const nh3Oxidized = nh3In - nh3Out;
  const potentialNO3 = nh3Oxidized;
  const denitEff = potentialNO3 > 0 ? ((potentialNO3 - no3Out) / potentialNO3) * 100 : 0;
  
  $('n_tkn_eff').textContent = fmt.f(tknEff, 1);
  $('n_nh3_eff').textContent = fmt.f(nh3Eff, 1);
  $('n_total_removed').textContent = fmt.n(totalNRemoved, 0);
  $('n_denit_eff').textContent = fmt.f(denitEff, 1);
  showToast('Nitrogen balance calculated', 'success');
}

function resetNitrogen() {
  $('n_tkn_in').value = 35;
  $('n_nh3_in').value = 25;
  $('n_tkn_out').value = 2;
  $('n_nh3_out').value = 0.5;
  $('n_no3_out').value = 8;
  $('n_flow').value = 3.5;
  $('n_tkn_eff').textContent = '-';
  $('n_nh3_eff').textContent = '-';
  $('n_total_removed').textContent = '-';
  $('n_denit_eff').textContent = '-';
}

// ==================== MULTI-PLANT MANAGEMENT SYSTEM ====================

// Plant data storage
let plantData = [];
let editingPlantId = null;
let fleetChart = null;

// Initialize with demo plants
function initMultiPlant() {
  // Check localStorage for saved plants
  const saved = localStorage.getItem('wwtp-plants');
  if (saved) {
    plantData = JSON.parse(saved);
  } else {
    // Demo data matching screenshots
    plantData = [
      {
        id: 'plant-1',
        name: 'Main WWTP',
        location: 'City Center',
        capacity: 5.2,
        flow: 4.8,
        efficiency: 96.1,
        status: 'online',
        operator: 'John Smith',
        notes: 'Primary treatment facility',
        created: new Date().toISOString()
      },
      {
        id: 'plant-2',
        name: 'North Facility',
        location: 'Northside',
        capacity: 3.8,
        flow: 3.2,
        efficiency: 95.3,
        status: 'online',
        operator: 'Jane Doe',
        notes: 'Secondary processing plant',
        created: new Date().toISOString()
      },
      {
        id: 'plant-3',
        name: 'South Facility',
        location: 'Southside',
        capacity: 2.5,
        flow: 2.3,
        efficiency: 96.8,
        status: 'online',
        operator: 'Mike Johnson',
        notes: 'Tertiary treatment',
        created: new Date().toISOString()
      }
    ];
  }
  renderMultiPlant();
}

// Save plants to localStorage
function savePlantsToStorage() {
  localStorage.setItem('wwtp-plants', JSON.stringify(plantData));
}

// Show Add Plant Modal
function showAddPlantModal() {
  editingPlantId = null;
  $('plantModalTitle').textContent = 'Add New Plant';
  $('plant-name').value = '';
  $('plant-location').value = '';
  $('plant-capacity').value = '5.0';
  $('plant-flow').value = '4.2';
  $('plant-efficiency').value = '95.5';
  $('plant-status').value = 'online';
  $('plant-operator').value = '';
  $('plant-notes').value = '';
  $('plantModal').style.display = 'flex';
}

// Show Edit Plant Modal
function editPlant(plantId) {
  const plant = plantData.find(p => p.id === plantId);
  if (!plant) return;
  
  editingPlantId = plantId;
  $('plantModalTitle').textContent = 'Edit Plant';
  $('plant-name').value = plant.name;
  $('plant-location').value = plant.location;
  $('plant-capacity').value = plant.capacity;
  $('plant-flow').value = plant.flow;
  $('plant-efficiency').value = plant.efficiency;
  $('plant-status').value = plant.status;
  $('plant-operator').value = plant.operator || '';
  $('plant-notes').value = plant.notes || '';
  $('plantModal').style.display = 'flex';
}

// Close Plant Modal
function closePlantModal() {
  $('plantModal').style.display = 'none';
  editingPlantId = null;
}

// Save Plant
function savePlant() {
  const name = $('plant-name').value.trim();
  const location = $('plant-location').value.trim();
  const capacity = parseFloat($('plant-capacity').value);
  const flow = parseFloat($('plant-flow').value);
  const efficiency = parseFloat($('plant-efficiency').value);
  const status = $('plant-status').value;
  const operator = $('plant-operator').value.trim();
  const notes = $('plant-notes').value.trim();
  
  if (!name) {
    showToast('Please enter a plant name', 'error');
    return;
  }
  if (!location) {
    showToast('Please enter a location', 'error');
    return;
  }
  if (!capacity || capacity <= 0) {
    showToast('Please enter a valid capacity', 'error');
    return;
  }
  
  if (editingPlantId) {
    // Update existing plant
    const idx = plantData.findIndex(p => p.id === editingPlantId);
    if (idx !== -1) {
      plantData[idx] = {
        ...plantData[idx],
        name, location, capacity, flow, efficiency, status, operator, notes,
        updated: new Date().toISOString()
      };
      showToast(`${name} updated successfully`, 'success');
    }
  } else {
    // Add new plant
    const newPlant = {
      id: 'plant-' + Date.now(),
      name, location, capacity, flow, efficiency, status, operator, notes,
      created: new Date().toISOString()
    };
    plantData.push(newPlant);
    showToast(`${name} added successfully`, 'success');
  }
  
  savePlantsToStorage();
  closePlantModal();
  renderMultiPlant();
}

// Delete Plant
function deletePlant(plantId) {
  const plant = plantData.find(p => p.id === plantId);
  if (!plant) return;
  
  if (confirm(`Are you sure you want to delete "${plant.name}"?`)) {
    plantData = plantData.filter(p => p.id !== plantId);
    savePlantsToStorage();
    renderMultiPlant();
    showToast(`${plant.name} deleted`, 'info');
  }
}

// Render Multi-Plant Dashboard
function renderMultiPlant() {
  // Calculate statistics
  const totalPlants = plantData.length;
  const totalCapacity = plantData.reduce((sum, p) => sum + p.capacity, 0);
  const totalFlow = plantData.reduce((sum, p) => sum + p.flow, 0);
  const onlinePlants = plantData.filter(p => p.status === 'online').length;
  const avgEfficiency = totalPlants > 0 
    ? plantData.reduce((sum, p) => sum + p.efficiency, 0) / totalPlants 
    : 0;
  
  // Update header stats
  if ($('mp-managing')) $('mp-managing').textContent = `Managing ${totalPlants} facilities`;
  if ($('mp-total-cap')) $('mp-total-cap').textContent = fmt.f(totalCapacity, 1);
  
  // Update KPI cards
  if ($('mp-totalPlants')) $('mp-totalPlants').textContent = totalPlants;
  if ($('mp-totalCapacity')) $('mp-totalCapacity').textContent = fmt.f(totalCapacity, 1);
  if ($('mp-onlinePlants')) $('mp-onlinePlants').textContent = onlinePlants;
  if ($('mp-avgEfficiency')) $('mp-avgEfficiency').textContent = fmt.f(avgEfficiency, 1) + '%';
  
  // Render plant cards
  const cardsGrid = $('plantCardsGrid');
  if (cardsGrid) {
    if (plantData.length === 0) {
      cardsGrid.innerHTML = '<p style="color:var(--text-unit);text-align:center;padding:40px">No plants added yet. Click "Add New Plant" to get started.</p>';
    } else {
      cardsGrid.innerHTML = plantData.map(plant => `
        <div class="plant-card">
          <div class="plant-card-header">
            <span class="plant-card-name">${plant.name}</span>
            <span class="plant-card-status ${plant.status}">${getStatusLabel(plant.status)}</span>
          </div>
          <div class="plant-card-flow">${fmt.f(plant.flow, 1)} <span>MGD</span></div>
          <div class="plant-card-meta">âœ“ online â€¢ ${fmt.f(plant.efficiency, 1)}%</div>
          <div class="plant-card-efficiency">
            <div class="plant-card-efficiency-bar" style="width:${plant.efficiency}%"></div>
          </div>
        </div>
      `).join('');
    }
  }
  
  // Render table
  const tableBody = $('plantTableBody');
  if (tableBody) {
    if (plantData.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="7" style="padding:20px;text-align:center;color:var(--text-unit)">No plants added yet. Click "Add New Plant" to get started.</td></tr>';
    } else {
      tableBody.innerHTML = plantData.map(plant => `
        <tr style="border-bottom:1px solid var(--border)">
          <td style="padding:12px;font-weight:500">${plant.name}</td>
          <td style="padding:12px">${plant.location}</td>
          <td style="padding:12px;text-align:center">${fmt.f(plant.capacity, 1)}</td>
          <td style="padding:12px;text-align:center">${fmt.f(plant.flow, 1)}</td>
          <td style="padding:12px;text-align:center">${fmt.f(plant.efficiency, 1)}%</td>
          <td style="padding:12px;text-align:center">
            <span style="padding:4px 12px;border-radius:20px;font-size:12px;font-weight:500;${getStatusStyle(plant.status)}">${getStatusLabel(plant.status)}</span>
          </td>
          <td style="padding:12px;text-align:center">
            <button class="btn green" style="padding:6px 12px;font-size:12px;margin-right:4px" onclick="editPlant('${plant.id}')">âœï¸ Edit</button>
            <button class="btn" style="padding:6px 12px;font-size:12px;background:#f87171;color:white" onclick="deletePlant('${plant.id}')">ðŸ—‘ï¸ Delete</button>
          </td>
        </tr>
      `).join('');
    }
  }
  
  // Update fleet chart
  renderFleetChart();
}

// Get status label
function getStatusLabel(status) {
  const labels = {
    online: 'âœ“ Online',
    degraded: 'âš  Degraded',
    offline: 'âœ— Offline',
    maintenance: 'ðŸ”§ Maintenance'
  };
  return labels[status] || status;
}

// Get status style
function getStatusStyle(status) {
  const styles = {
    online: 'background:rgba(74,222,128,0.2);color:#22c55e',
    degraded: 'background:rgba(251,191,36,0.2);color:#f59e0b',
    offline: 'background:rgba(248,113,113,0.2);color:#ef4444',
    maintenance: 'background:rgba(147,197,253,0.2);color:#3b82f6'
  };
  return styles[status] || '';
}

// Render Fleet Chart
function renderFleetChart() {
  const canvas = $('fleetChart');
  if (!canvas || plantData.length === 0) return;
  
  if (fleetChart) {
    fleetChart.destroy();
  }
  
  const ctx = canvas.getContext('2d');
  fleetChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: plantData.map(p => p.name),
      datasets: [
        {
          label: 'Capacity (MGD)',
          data: plantData.map(p => p.capacity),
          backgroundColor: 'rgba(102, 126, 234, 0.8)',
          borderRadius: 6
        },
        {
          label: 'Current Flow (MGD)',
          data: plantData.map(p => p.flow),
          backgroundColor: 'rgba(79, 172, 254, 0.8)',
          borderRadius: 6
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top',
          labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text').trim() }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: { color: 'rgba(128,128,128,0.1)' },
          ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-unit').trim() }
        },
        x: {
          grid: { display: false },
          ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-unit').trim() }
        }
      }
    }
  });
}

// Import Plants
function importPlants() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,.csv';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        if (file.name.endsWith('.json')) {
          const imported = JSON.parse(event.target.result);
          if (Array.isArray(imported)) {
            plantData = [...plantData, ...imported.map(p => ({
              ...p,
              id: 'plant-' + Date.now() + Math.random().toString(36).substr(2, 9)
            }))];
            savePlantsToStorage();
            renderMultiPlant();
            showToast(`Imported ${imported.length} plants`, 'success');
          }
        } else {
          showToast('CSV import coming soon', 'info');
        }
      } catch (err) {
        showToast('Error importing file', 'error');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// Export Plant Data
function exportPlantData() {
  if (plantData.length === 0) {
    showToast('No plants to export', 'warning');
    return;
  }
  
  const dataStr = JSON.stringify(plantData, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp-plants-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Plant data exported', 'success');
}

// Optimize Fleet
function optimizeFleet() {
  if (plantData.length === 0) {
    showToast('Add plants first to optimize', 'warning');
    return;
  }
  
  showToast('Analyzing fleet efficiency...', 'info');
  
  setTimeout(() => {
    const totalCapacity = plantData.reduce((sum, p) => sum + p.capacity, 0);
    const totalFlow = plantData.reduce((sum, p) => sum + p.flow, 0);
    const utilization = (totalFlow / totalCapacity * 100).toFixed(1);
    const avgEff = (plantData.reduce((sum, p) => sum + p.efficiency, 0) / plantData.length).toFixed(1);
    
    let recommendation = '';
    if (utilization < 60) {
      recommendation = 'Consider consolidating operations - fleet is underutilized';
    } else if (utilization > 90) {
      recommendation = 'Fleet near capacity - consider expansion planning';
    } else {
      recommendation = 'Fleet operating at optimal utilization';
    }
    
    showNotification('Fleet Optimization Report', 
      `Utilization: ${utilization}%\nAvg Efficiency: ${avgEff}%\n\n${recommendation}`, 
      'info');
  }, 1500);
}

// Initialize Multi-Plant on page load
setTimeout(initMultiPlant, 500);

// Initialize on load
window.addEventListener('load',()=>{
if($('kpi-flow'))$('kpi-flow').textContent='3.50';
if($('kpi-do'))$('kpi-do').textContent='2.1';
if($('kpi-mlss'))$('kpi-mlss').textContent='2500';
if($('kpi-fm'))$('kpi-fm').textContent='0.35';
if($('kpi-energy'))$('kpi-energy').textContent='1850';
if($('kpi-cost'))$('kpi-cost').textContent='$4,250';
console.log('ðŸš€ WWTP Ultimate Integrated Edition Ready');
showToast('System initialized - AI Assistant ready!','success');

  // Dynamically add navigation buttons for additional calculators
  const nav = document.querySelector('nav.tabs');
  // Only inject if not already present to avoid duplicates
  if(nav && !nav.querySelector('.tab[data-target="srt"]')){
    nav.insertAdjacentHTML('beforeend',
      '<button class="tab" data-target="srt" role="tab">â±ï¸ SRT</button>' +
      '<button class="tab" data-target="bodeff" role="tab">ðŸ“‰ BOD Efficiency</button>' +
      '<button class="tab" data-target="svi" role="tab">ðŸ§ª SVI</button>');
    // Update the modules count to 27
    document.querySelectorAll('.status-bar .status-item').forEach(item=>{
      if(item.textContent && item.textContent.includes('Modules')){
        item.innerHTML = item.innerHTML.replace(/\d+/, '27');
      }
    });
    // Attach click handlers for the new tabs
    ['srt','bodeff','svi'].forEach(id=>{
      const tab = nav.querySelector(`.tab[data-target="${id}"]`);
      if(tab){
        tab.addEventListener('click',()=>{
          document.querySelectorAll('.tab').forEach(t=>t.setAttribute('aria-selected','false'));
          document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
          tab.setAttribute('aria-selected','true');
          document.getElementById(id).classList.add('active');
          if(id==='ai'){
            scrollAIToBottom();
          }
        });
      }
    });
  }
});

// Save button handlers
if($('saveBtn'))$('saveBtn').onclick=saveProfile;
if($('loadBtn'))$('loadBtn').onclick=loadProfile;
if($('exportBtn'))$('exportBtn').onclick=exportFullReport;
if($('alertBtn'))$('alertBtn').onclick=()=>{
$$('.tab[data-target="alerts"]')[0].click();
};

if($('alertCount'))$('alertCount').textContent='5';

// ==================== PROCESS CALCULATIONS ENHANCEMENTS ====================

// Calculation tracking
let calculationStats = {
  completed: 0,
  inRange: 0,
  warnings: 0,
  critical: 0,
  history: []
};

// Calculate All Process Calculators
function calculateAllProcess() {
  showToast('ðŸš€ Running all process calculations...', 'info');
  
  const calculators = [
    'calcOLR', 'calcVLR', 'calcBODEfficiency',
    'calcDetention', 'calcWOR', 'calcSLR', 'calcRAS',
    'calcClarifier',
    'calcSRTEnhanced', 'calcSVICalc', 'calcNitrogen', 'calcNutrients',
    'calcAlkalinity', 'calcPH', 'calcPolymer', 'calcDosing', 'calcChlorine',
    'calcOxygenReq', 'calcAir',
    'calcDigester', 'calcDewatering',
    'calcDisinfection',
    'calcPumping'
  ];
  
  let completed = 0;
  calculators.forEach((calc, index) => {
    setTimeout(() => {
      if (window[calc]) {
        try {
          window[calc]();
          completed++;
          updateProcessSummary();
        } catch(e) {
          console.log(`Calculator ${calc} not available`);
        }
      }
      if (index === calculators.length - 1) {
        setTimeout(() => {
          showToast(`âœ… Completed ${completed} calculations!`, 'success');
          generateCalculationSummary();
        }, 500);
      }
    }, index * 100);
  });
}

// Expand All Categories
function expandAllCategories() {
  $$('.calc-category').forEach(cat => {
    cat.classList.remove('collapsed');
  });
  showToast('ðŸ“‚ All categories expanded', 'info');
}

// Collapse All Categories
function collapseAllCategories() {
  $$('.calc-category').forEach(cat => {
    cat.classList.add('collapsed');
  });
  showToast('ðŸ“ All categories collapsed', 'info');
}

// Toggle Category Collapse
function toggleCategory(element) {
  const category = element.closest('.calc-category');
  if (category) {
    category.classList.toggle('collapsed');
  }
}

// Add click handlers to category headers
setTimeout(() => {
  $$('.calc-category-header').forEach(header => {
    header.style.cursor = 'pointer';
    header.onclick = function() {
      toggleCategory(this);
    };
  });
}, 1000);

// Update Process Summary Cards
function updateProcessSummary() {
  // Count status indicators
  let inRange = 0, warnings = 0, critical = 0;
  
  $$('.status.ok').forEach(() => inRange++);
  $$('.status.warn').forEach(() => warnings++);
  $$('.status.bad').forEach(() => critical++);
  
  // Count completed calculations (any result not "-")
  let completed = 0;
  $$('#process-calcs .result').forEach(el => {
    if (el.textContent !== '-' && el.textContent.trim() !== '') {
      completed++;
    }
  });
  
  // Update cards
  if ($('completed-calcs')) $('completed-calcs').textContent = Math.min(completed, 25);
  if ($('in-range-calcs')) $('in-range-calcs').textContent = inRange;
  if ($('warning-calcs')) $('warning-calcs').textContent = warnings;
  if ($('critical-calcs')) $('critical-calcs').textContent = critical;
  
  calculationStats.completed = completed;
  calculationStats.inRange = inRange;
  calculationStats.warnings = warnings;
  calculationStats.critical = critical;
}

// Generate Calculation Summary
function generateCalculationSummary() {
  const summary = {
    timestamp: new Date().toISOString(),
    stats: calculationStats,
    plantName: $('plantName') ? $('plantName').value : 'Unknown',
    operator: $('operatorName') ? $('operatorName').value : 'Unknown'
  };
  
  calculationStats.history.push(summary);
  
  // Keep only last 10 summaries
  if (calculationStats.history.length > 10) {
    calculationStats.history.shift();
  }
  
  // Store in localStorage
  try {
    localStorage.setItem('wwtp_calc_history', JSON.stringify(calculationStats.history));
  } catch(e) {
    console.log('Could not save history');
  }
}

// Show Calculation History
function showCalculationHistory() {
  if (calculationStats.history.length === 0) {
    showToast('ðŸ“Š No calculation history yet', 'info');
    return;
  }
  
  let historyHTML = '<div style="max-height:400px;overflow-y:auto">';
  historyHTML += '<h3 style="margin-bottom:15px">ðŸ“Š Calculation History</h3>';
  historyHTML += '<table class="enhanced-table"><thead><tr><th>Timestamp</th><th>Completed</th><th>âœ“ In Range</th><th>âš  Warnings</th><th>ðŸ”´ Critical</th></tr></thead><tbody>';
  
  calculationStats.history.slice().reverse().forEach(entry => {
    const date = new Date(entry.timestamp);
    historyHTML += `<tr>
      <td>${date.toLocaleString()}</td>
      <td>${entry.stats.completed}</td>
      <td style="color:var(--ok)">${entry.stats.inRange}</td>
      <td style="color:var(--warn)">${entry.stats.warnings}</td>
      <td style="color:var(--bad)">${entry.stats.critical}</td>
    </tr>`;
  });
  
  historyHTML += '</tbody></table></div>';
  
  // Show in a modal or alert
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-container);padding:30px;border-radius:12px;box-shadow:var(--shadow-xl);z-index:10000;max-width:800px;width:90%';
  modal.innerHTML = historyHTML + '<br><button class="btn gray" onclick="this.parentElement.remove()">Close</button>';
  
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999';
  overlay.onclick = () => {
    modal.remove();
    overlay.remove();
  };
  
  document.body.appendChild(overlay);
  document.body.appendChild(modal);
}

// Export Process Report
function exportProcessReport() {
  showToast('ðŸ“„ Generating process calculations report...', 'info');
  
  // Collect all calculation results
  let reportData = {
    plantName: $('plantName') ? $('plantName').value : 'WWTP',
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString(),
    operator: $('operatorName') ? $('operatorName').value : '',
    calculations: []
  };
  
  // Gather data from all calculators
  $$('#process-calcs .calc-item').forEach(item => {
    const title = item.querySelector('.calc-item-title, .section-h');
    if (title) {
      const calcData = {
        name: title.textContent,
        results: []
      };
      
      item.querySelectorAll('.result').forEach(result => {
        const label = result.closest('tr')?.querySelector('.rowh')?.textContent || 
                     result.closest('p')?.textContent.split(':')[0] || 'Result';
        const value = result.textContent;
        if (value !== '-') {
          calcData.results.push({ label, value });
        }
      });
      
      if (calcData.results.length > 0) {
        reportData.calculations.push(calcData);
      }
    }
  });
  
  // Generate HTML report
  let reportHTML = `
<!DOCTYPE html>
<html>
<head>
  <title>WWTP Process Calculations Report</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { color: #2c5aa0; border-bottom: 3px solid #2c5aa0; padding-bottom: 10px; }
    h2 { color: #667eea; margin-top: 30px; }
    .header-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 30px; }
    .calc-section { margin-bottom: 25px; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6; }
    th { background: #e3f2fd; font-weight: 600; }
    .footer { margin-top: 50px; text-align: center; color: #6c757d; font-size: 12px; }
  </style>
</head>
<body>
  <h1>ðŸ§® WWTP Process Calculations Report</h1>
  <div class="header-info">
    <strong>Plant:</strong> ${reportData.plantName}<br>
    <strong>Date:</strong> ${reportData.date}<br>
    <strong>Time:</strong> ${reportData.time}<br>
    <strong>Operator:</strong> ${reportData.operator}<br>
    <strong>Total Calculations:</strong> ${reportData.calculations.length}
  </div>
`;

  reportData.calculations.forEach(calc => {
    reportHTML += `<div class="calc-section">
      <h2>${calc.name}</h2>
      <table>
        <thead><tr><th>Parameter</th><th>Value</th></tr></thead>
        <tbody>`;
    
    calc.results.forEach(result => {
      reportHTML += `<tr><td>${result.label}</td><td><strong>${result.value}</strong></td></tr>`;
    });
    
    reportHTML += '</tbody></table></div>';
  });
  
  reportHTML += `
  <div class="footer">
    <p>Generated by WWTP Ultimate Professional Edition</p>
    <p>Report generated on ${new Date().toLocaleString()}</p>
  </div>
</body>
</html>`;
  
  // Open in new window for download/print
  const reportWindow = window.open('', '_blank');
  reportWindow.document.write(reportHTML);
  reportWindow.document.close();
  
  showToast('âœ… Report generated! Opening in new window...', 'success');
  
  // Auto-trigger print dialog after a short delay
  setTimeout(() => {
    reportWindow.print();
  }, 500);
}

// Print Process Calculations
function printProcessCalcs() {
  showToast('ðŸ–¨ï¸ Preparing print view...', 'info');
  window.print();
}

// Enhanced Status Update Function
function updateCalculatorStatus(resultId, value, targetMin, targetMax, unit = '') {
  const resultElement = $(resultId);
  const statusElement = $(resultId.replace('r_', 's_'));
  
  if (!resultElement) return;
  
  resultElement.textContent = value + (unit ? ' ' + unit : '');
  
  if (statusElement && targetMin !== undefined && targetMax !== undefined) {
    if (value >= targetMin && value <= targetMax) {
      statusElement.innerHTML = '<span class="status-badge good">âœ“ Normal</span>';
      statusElement.className = 'status ok';
    } else if (value < targetMin * 0.8 || value > targetMax * 1.2) {
      statusElement.innerHTML = '<span class="status-badge critical">âœ— Critical</span>';
      statusElement.className = 'status bad';
    } else {
      statusElement.innerHTML = '<span class="status-badge warning">âš  Warning</span>';
      statusElement.className = 'status warn';
    }
  }
  
  updateProcessSummary();
}

// Load calculation history from localStorage on startup
setTimeout(() => {
  try {
    const stored = localStorage.getItem('wwtp_calc_history');
    if (stored) {
      calculationStats.history = JSON.parse(stored);
    }
  } catch(e) {
    console.log('Could not load history');
  }
  
  // Update summary on load
  updateProcessSummary();
}, 1000);

// Input Validation Helper
function validateInput(inputId, min, max, defaultValue) {
  const input = $(inputId);
  if (!input) return defaultValue;
  
  let value = Number(input.value);
  
  if (isNaN(value) || value < min || value > max) {
    input.style.borderColor = 'var(--bad)';
    input.title = `Please enter a value between ${min} and ${max}`;
    return defaultValue;
  } else {
    input.style.borderColor = 'var(--border-input)';
    input.title = '';
    return value;
  }
}

// Progress Bar Helper
function createProgressBar(percentage, className = 'good') {
  return `
    <div class="progress-bar-container">
      <div class="progress-bar ${className}" style="width:${percentage}%">
        ${percentage.toFixed(0)}%
      </div>
    </div>
  `;
}

// Auto-save functionality
let autoSaveTimer;
function enableAutoSave() {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => {
    try {
      const data = {
        timestamp: Date.now(),
        inputs: {}
      };
      
      $$('#process-calcs input[type="number"]').forEach(input => {
        if (input.id && input.value) {
          data.inputs[input.id] = input.value;
        }
      });
      
      localStorage.setItem('wwtp_autosave', JSON.stringify(data));
      console.log('Auto-saved at', new Date().toLocaleTimeString());
    } catch(e) {
      console.log('Auto-save failed');
    }
  }, 5000);
}

// Monitor input changes for auto-save
$$('#process-calcs input').forEach(input => {
  input.addEventListener('change', enableAutoSave);
});


// Toggle collapsible sections
function toggleCollapsible(header) {
  const content = header.nextElementSibling;
  const icon = header.querySelector('span');
  if (content.classList.contains('active')) {
    content.classList.remove('active');
    icon.textContent = 'â–¼';
  } else {
    content.classList.add('active');
    icon.textContent = 'â–²';
  }
}

// Generate AI Recommendations
function generateOptimizationRecommendations() {
  const recommendations = [];
  
  // Check various parameters and generate recommendations
  
  // F/M Ratio check
  const mlss = state.data && state.data.mlss ? state.data.mlss : 2500;
  const bod = state.data && state.data.bod ? state.data.bod : 200;
  const fm = state.data && state.data.fm ? state.data.fm : 0.3;
  
  if (fm > 0.5) {
    recommendations.push({
      priority: 'high',
      icon: 'âš ï¸',
      title: 'High F/M Ratio Detected',
      description: `Current F/M: ${fm.toFixed(2)}. Consider increasing MLSS or reducing WAS rate to improve settling.`,
      action: 'Reduce WAS by 10-15% or increase aeration basin volume utilization'
    });
  } else if (fm < 0.15) {
    recommendations.push({
      priority: 'medium',
      icon: 'ðŸ’¡',
      title: 'Low F/M Ratio - Potential for Nitrification',
      description: `Current F/M: ${fm.toFixed(2)}. System is suitable for nitrification. Consider optimizing for nitrogen removal.`,
      action: 'Maintain longer SRT (15-20 days) and DO > 2 mg/L for nitrification'
    });
  }
  
  // Energy optimization
  const kwhPerMG = 2000; // Example value
  if (kwhPerMG > 1800) {
    recommendations.push({
      priority: 'medium',
      icon: 'âš¡',
      title: 'Energy Consumption Above Industry Average',
      description: `Current usage: ${kwhPerMG} kWh/MG. Industry average: 1400-1600 kWh/MG.`,
      action: 'Implement VFD controls on blowers, optimize DO setpoints (1.5-2.5 mg/L), check for air leaks'
    });
  }
  
  // Chemical dosing optimization
  recommendations.push({
    priority: 'low',
    icon: 'ðŸ§ª',
    title: 'Chemical Dosing Optimization Available',
    description: 'Review chemical inventory levels and dosing rates for potential cost savings.',
    action: 'Conduct jar tests to optimize polymer and coagulant dosing'
  });
  
  // SVI recommendation
  const svi = 150; // Example
  if (svi > 150) {
    recommendations.push({
      priority: 'high',
      icon: 'ðŸ”´',
      title: 'Sludge Bulking Detected',
      description: `SVI: ${svi} mL/g (target: <150). Poor settling indicated.`,
      action: 'Increase DO to 2.5+ mg/L, reduce F/M ratio, consider selector zone or chlorination'
    });
  }
  
  // Display recommendations
  const container = $('#recommendations-list');
  if (container && recommendations.length > 0) {
    let html = '';
    recommendations.forEach(rec => {
      const priorityColor = rec.priority === 'high' ? 'var(--bad)' : 
                           rec.priority === 'medium' ? 'var(--warn)' : 'var(--info)';
      html += `
        <div style="margin-bottom:20px;padding:15px;background:var(--bg-card);border-left:4px solid ${priorityColor};border-radius:8px">
          <div style="display:flex;align-items:start;gap:10px">
            <span style="font-size:24px">${rec.icon}</span>
            <div style="flex:1">
              <h4 style="margin:0 0 8px 0;color:var(--text-accent)">${rec.title}</h4>
              <p style="margin:0 0 8px 0;color:var(--text)">${rec.description}</p>
              <div style="padding:10px;background:var(--bg-section);border-radius:6px;font-size:14px">
                <strong>Action:</strong> ${rec.action}
              </div>
            </div>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }
}

// Update compliance indicators
function updateComplianceStatus() {
  // Example compliance checks (would use actual permit limits in production)
  const bodLimit = 30; // mg/L
  const tssLimit = 30; // mg/L
  const nh3Limit = 5; // mg/L
  const doMin = 2.0; // mg/L
  
  // Get current values (these would come from actual measurements)
  // For demo, showing compliance
  if ($('compliance-bod')) $('compliance-bod').textContent = 'âœ“ 98%';
  if ($('compliance-tss')) $('compliance-tss').textContent = 'âœ“ 97%';
  if ($('compliance-nh3')) $('compliance-nh3').textContent = 'âœ“ 99%';
  if ($('compliance-do')) $('compliance-do').textContent = 'âœ“ Yes';
}

// Run optimization check after calculations
setTimeout(() => {
  generateOptimizationRecommendations();
  updateComplianceStatus();
}, 2000);






// ==================== ABSOLUTE APEX EDITION FEATURES ====================

// Global APEX state
let apexState = {
  ai: {
    active: false,
    conversation: [],
    model: 'GPT-4-WWTP-Specialist'
  },
  voice: {
    listening: false,
    recognition: null,
    synthesis: null
  },
  digitalTwin: {
    components: [],
    simulation: null
  },
  ml: {
    insights: [],
    learning: true,
    accuracy: 94.7
  },
  blockchain: {
    blocks: [],
    verified: true
  },
  iot: {
    sensors: [],
    connected: true
  },
  quantum: {
    enabled: false,
    qubits: 8
  }
};

// ==================== AI COPILOT SYSTEM ====================

function initAICopilot() {
  // Create AI copilot interface
  const copilot = document.createElement('div');
  copilot.className = 'ai-copilot';
  copilot.id = 'ai-copilot';
  copilot.innerHTML = `
    <div class="ai-header">
      <div style="display:flex;align-items:center;gap:15px">
        <div class="ai-avatar">ðŸ¤–</div>
        <div>
          <div style="font-weight:700;font-size:16px">WWTP AI Copilot</div>
          <div style="font-size:12px;opacity:0.8">Powered by Advanced ML</div>
        </div>
      </div>
      <button onclick="toggleAICopilot()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer">Ã—</button>
    </div>
    <div class="ai-chat" id="ai-chat">
      <div class="ai-message bot">
        ðŸ‘‹ Hello! I'm your AI Copilot. I can help you with:
        <br>â€¢ Process optimization
        <br>â€¢ Troubleshooting issues
        <br>â€¢ Predicting trends
        <br>â€¢ Regulatory compliance
        <br>â€¢ Best practices
        <br><br>What would you like to know?
      </div>
    </div>
    <div class="ai-input-area">
      <input type="text" class="ai-input" id="ai-input" placeholder="Ask me anything about WWTP operations..." onkeypress="if(event.key==='Enter')sendAIMessage()">
      <button class="ai-send-btn" onclick="sendAIMessage()">Send ðŸš€</button>
    </div>
  `;
  document.body.appendChild(copilot);
}

function toggleAICopilot() {
  const copilot = $('ai-copilot');
  apexState.ai.active = !apexState.ai.active;
  if (apexState.ai.active) {
    copilot.classList.add('active');
  } else {
    copilot.classList.remove('active');
  }
}

function sendAIMessage() {
  const input = $('ai-input');
  const chat = $('ai-chat');
  const message = input.value.trim();
  
  if (!message) return;
  
  // Add user message
  const userMsg = document.createElement('div');
  userMsg.className = 'ai-message user';
  userMsg.textContent = message;
  chat.appendChild(userMsg);
  
  input.value = '';
  chat.scrollTop = chat.scrollHeight;
  
  // Simulate AI response
  setTimeout(() => {
    const botMsg = document.createElement('div');
    botMsg.className = 'ai-message bot';
    botMsg.innerHTML = generateAIResponse(message);
    chat.appendChild(botMsg);
    chat.scrollTop = chat.scrollHeight;
  }, 1000);
  
  apexState.ai.conversation.push({user: message, timestamp: new Date()});
}

function generateAIResponse(question) {
  const q = question.toLowerCase();
  
  if (q.includes('f/m') || q.includes('food') || q.includes('microorganism')) {
    return `Based on your current data, your F/M ratio of 0.35 is optimal. ðŸ’š<br><br>
      <strong>AI Recommendation:</strong> Maintain current conditions. Your system is well-balanced.<br><br>
      <strong>Trend Analysis:</strong> F/M has been stable at 0.32-0.37 for 30 days, indicating excellent process control.<br><br>
      <strong>Optimization Tip:</strong> Monitor if influent BOD increases >10% - you may need to adjust RAS rate.`;
  }
  
  if (q.includes('svi') || q.includes('settling') || q.includes('bulking')) {
    return `Your current SVI of 125 mL/g is in the good range. ðŸ“Š<br><br>
      <strong>AI Analysis:</strong> No signs of bulking. Sludge settling is healthy.<br><br>
      <strong>Prediction:</strong> 87% confidence SVI will remain 120-130 for next 7 days.<br><br>
      <strong>Watch For:</strong> If SVI exceeds 150, check for filamentous bacteria. I'll alert you automatically.`;
  }
  
  if (q.includes('energy') || q.includes('cost') || q.includes('save')) {
    return `âš¡ Energy Optimization Insights:<br><br>
      <strong>Current:</strong> 1650 kWh/MG<br>
      <strong>Target:</strong> 1500 kWh/MG<br>
      <strong>Savings Potential:</strong> $4,500/month<br><br>
      <strong>AI Recommendations:</strong><br>
      1. Reduce RAS rate by 5% (saves 120 kWh/day)<br>
      2. Optimize aeration DO to 2.0 mg/L (saves 80 kWh/day)<br>
      3. Implement VFD control on blowers (saves 50 kWh/day)`;
  }
  
  if (q.includes('troubleshoot') || q.includes('problem') || q.includes('issue')) {
    return `ðŸ” AI Troubleshooting Assistant activated.<br><br>
      <strong>No critical issues detected.</strong><br><br>
      Minor observations:<br>
      â€¢ DO in Basin 2 slightly low (1.8 vs target 2.0)<br>
      â€¢ Energy usage 8% above target<br>
      â€¢ SRT trending upward slowly<br><br>
      All issues are manageable. Would you like detailed recommendations for any of these?`;
  }
  
  return `I understand you're asking about "${question}". ðŸ¤–<br><br>
    Based on my analysis of your process data, everything looks good! Your plant is operating efficiently.<br><br>
    <strong>Key Metrics:</strong><br>
    â€¢ F/M: 0.35 (Optimal) âœ…<br>
    â€¢ SVI: 125 mL/g (Good) âœ…<br>
    â€¢ DO: 2.2 mg/L (Good) âœ…<br>
    â€¢ Energy: 1650 kWh/MG (Target: 1500) âš ï¸<br><br>
    Would you like specific recommendations for optimization?`;
}

// ==================== VOICE CONTROL SYSTEM ====================

function initVoiceControl() {
  // Check for Web Speech API support
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    apexState.voice.recognition = new SpeechRecognition();
    apexState.voice.recognition.continuous = false;
    apexState.voice.recognition.interimResults = false;
    
    apexState.voice.recognition.onresult = (event) => {
      const command = event.results[0][0].transcript;
      processVoiceCommand(command);
    };
    
    apexState.voice.recognition.onend = () => {
      apexState.voice.listening = false;
      updateVoiceButton();
    };
  }
  
  // Create voice control button
  const voiceBtn = document.createElement('div');
  voiceBtn.className = 'voice-control';
  voiceBtn.id = 'voice-control';
  voiceBtn.innerHTML = 'ðŸŽ¤';
  voiceBtn.onclick = toggleVoiceControl;
  document.body.appendChild(voiceBtn);
  
  // Create voice feedback
  const feedback = document.createElement('div');
  feedback.className = 'voice-feedback';
  feedback.id = 'voice-feedback';
  document.body.appendChild(feedback);
}

function toggleVoiceControl() {
  if (!apexState.voice.recognition) {
    showNotification('Voice Not Supported', 'Your browser does not support voice commands', 'warning');
    return;
  }
  
  if (apexState.voice.listening) {
    apexState.voice.recognition.stop();
    apexState.voice.listening = false;
  } else {
    apexState.voice.recognition.start();
    apexState.voice.listening = true;
    showVoiceFeedback('ðŸŽ¤ Listening... Say a command');
  }
  
  updateVoiceButton();
}

function updateVoiceButton() {
  const btn = $('voice-control');
  if (apexState.voice.listening) {
    btn.classList.add('listening');
    btn.innerHTML = 'ðŸ”´';
  } else {
    btn.classList.remove('listening');
    btn.innerHTML = 'ðŸŽ¤';
  }
}

function showVoiceFeedback(text) {
  const feedback = $('voice-feedback');
  feedback.textContent = text;
  feedback.classList.add('active');
  setTimeout(() => feedback.classList.remove('active'), 3000);
}

function processVoiceCommand(command) {
  const cmd = command.toLowerCase();
  showVoiceFeedback(`Processing: "${command}"`);
  
  if (cmd.includes('calculate') || cmd.includes('run')) {
    calculateAllProcess();
    showNotification('Voice Command', 'Running all calculations', 'success');
  } else if (cmd.includes('dashboard')) {
    showAdvancedDashboard();
    showNotification('Voice Command', 'Opening dashboard', 'success');
  } else if (cmd.includes('visualize') || cmd.includes('chart')) {
    showVisualizationDashboard();
    showNotification('Voice Command', 'Opening visualizations', 'success');
  } else if (cmd.includes('predict') || cmd.includes('forecast')) {
    showPredictiveAnalytics();
    showNotification('Voice Command', 'Opening predictions', 'success');
  } else if (cmd.includes('help')) {
    showVoiceCommands();
  } else {
    showNotification('Voice Command', `Command "${command}" not recognized`, 'info');
  }
}

function showVoiceCommands() {
  const html = `
    <div style="max-width:600px">
      <h2>ðŸŽ¤ Voice Commands</h2>
      <p style="color:var(--text-unit);margin:15px 0">Available voice commands:</p>
      <div style="background:var(--bg-section);padding:20px;border-radius:10px">
        <ul style="list-style:none;padding:0">
          <li style="padding:10px 0;border-bottom:1px solid var(--border)">ðŸ”µ "Calculate" or "Run" - Run all calculations</li>
          <li style="padding:10px 0;border-bottom:1px solid var(--border)">ðŸ”µ "Dashboard" - Open advanced dashboard</li>
          <li style="padding:10px 0;border-bottom:1px solid var(--border)">ðŸ”µ "Visualize" or "Chart" - Open visualizations</li>
          <li style="padding:10px 0;border-bottom:1px solid var(--border)">ðŸ”µ "Predict" or "Forecast" - Open predictions</li>
          <li style="padding:10px 0">ðŸ”µ "Help" - Show voice commands</li>
        </ul>
        <p style="margin-top:15px;font-size:13px;color:var(--text-unit)">
          ðŸ’¡ Tip: Speak clearly and wait for the listening indicator
        </p>
      </div>
    </div>
  `;
  showModal('ðŸŽ¤ Voice Commands', html);
}

// ==================== DIGITAL TWIN SYSTEM ====================

function showDigitalTwin() {
  const html = `
    <div class="digital-twin" style="max-width:1200px">
      <h2 style="margin-bottom:10px">ðŸ­ Digital Twin Simulation</h2>
      <p style="opacity:0.9;margin-bottom:20px">Real-time virtual model of your treatment plant</p>
      
      <div class="twin-container">
        <div class="twin-component" onclick="showComponentDetail('influent')">
          <div style="font-size:36px;margin-bottom:10px">ðŸŒŠ</div>
          <div style="font-size:16px;font-weight:700">Influent</div>
          <div style="font-size:24px;margin:10px 0">2.5 MGD</div>
          <div class="twin-status">
            <span style="font-size:13px">Flow Rate</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
        
        <div class="twin-component" onclick="showComponentDetail('primary')">
          <div style="font-size:36px;margin-bottom:10px">âš™ï¸</div>
          <div style="font-size:16px;font-weight:700">Primary</div>
          <div style="font-size:24px;margin:10px 0">65% TSS</div>
          <div class="twin-status">
            <span style="font-size:13px">Removal</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
        
        <div class="twin-component" onclick="showComponentDetail('aeration')">
          <div style="font-size:36px;margin-bottom:10px">ðŸ’¨</div>
          <div style="font-size:16px;font-weight:700">Aeration</div>
          <div style="font-size:24px;margin:10px 0">2.2 mg/L</div>
          <div class="twin-status">
            <span style="font-size:13px">DO Level</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
        
        <div class="twin-component" onclick="showComponentDetail('clarifier')">
          <div style="font-size:36px;margin-bottom:10px">ðŸ”„</div>
          <div style="font-size:16px;font-weight:700">Clarifier</div>
          <div style="font-size:24px;margin:10px 0">125 SVI</div>
          <div class="twin-status">
            <span style="font-size:13px">Settling</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
        
        <div class="twin-component" onclick="showComponentDetail('ras')">
          <div style="font-size:36px;margin-bottom:10px">â™»ï¸</div>
          <div style="font-size:16px;font-weight:700">RAS</div>
          <div style="font-size:24px;margin:10px 0">65%</div>
          <div class="twin-status">
            <span style="font-size:13px">Return Rate</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
        
        <div class="twin-component" onclick="showComponentDetail('effluent')">
          <div style="font-size:36px;margin-bottom:10px">âœ…</div>
          <div style="font-size:16px;font-weight:700">Effluent</div>
          <div style="font-size:24px;margin:10px 0">5 mg/L</div>
          <div class="twin-status">
            <span style="font-size:13px">BOD</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:12px">
        <h4 style="margin-bottom:15px">ðŸŽ¯ Twin Simulation Controls</h4>
        <div style="display:flex;gap:15px;flex-wrap:wrap">
          <button class="btn green" onclick="runSimulation()">â–¶ï¸ Run Simulation</button>
          <button class="btn blue" onclick="adjustParameters()">âš™ï¸ Adjust Parameters</button>
          <button class="btn" style="background:var(--warn);color:white" onclick="testScenario()">ðŸ§ª Test Scenario</button>
          <button class="btn" style="background:var(--purple);color:white" onclick="exportTwinData()">ðŸ’¾ Export Data</button>
        </div>
      </div>
    </div>
  `;
  
  showModal('ðŸ­ Digital Twin', html);
}

function showComponentDetail(component) {
  showNotification('Component Details', `Viewing ${component} component analytics`, 'info');
}

function runSimulation() {
  showNotification('Simulation Running', 'Digital twin simulation in progress...', 'info');
  setTimeout(() => {
    showNotification('Simulation Complete', 'All parameters within optimal range', 'success');
  }, 2000);
}

function adjustParameters() {
  showNotification('Parameter Adjustment', 'Opening parameter controls...', 'info');
}

function testScenario() {
  showNotification('Scenario Testing', 'What-if analysis initiated', 'info');
}

function exportTwinData() {
  showNotification('Exporting Twin Data', 'Digital twin data exported', 'success');
}

// ==================== MACHINE LEARNING INSIGHTS ====================

function showMLInsights() {
  const html = `
    <div class="ml-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">ðŸ§  Machine Learning Insights</h2>
      <p style="opacity:0.9;margin-bottom:20px">AI-powered pattern recognition and optimization</p>
      
      <div style="margin-bottom:25px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <span>Model Accuracy</span>
          <span class="ml-confidence">${apexState.ml.accuracy}%</span>
        </div>
        <div class="learning-indicator">
          <div class="learning-progress" style="--progress:${apexState.ml.accuracy}%"></div>
        </div>
      </div>
      
      <div class="ml-insight">
        <strong>ðŸ“ˆ Pattern Detected:</strong> Your F/M ratio follows a predictable weekly cycle, peaking on Mondays (0.42) and lowest on Fridays (0.28). ML model suggests this is due to industrial discharge patterns.
        <span class="ml-confidence">92% confidence</span>
      </div>
      
      <div class="ml-insight">
        <strong>âš¡ Energy Optimization:</strong> ML analysis identifies 3 high-impact opportunities saving 18% energy ($6,200/month) with zero process risk.
        <span class="ml-confidence">96% confidence</span>
      </div>
      
      <div class="ml-insight">
        <strong>ðŸ”® Predictive Maintenance:</strong> Blower #2 showing early wear patterns. ML predicts 78% probability of failure within 45-60 days. Schedule maintenance now to prevent emergency.
        <span class="ml-confidence">89% confidence</span>
      </div>
      
      <div class="ml-insight">
        <strong>ðŸŽ¯ Process Optimization:</strong> By adjusting RAS rate to 62% (from 65%) during 10am-2pm daily, ML models show 8% energy savings with improved settling.
        <span class="ml-confidence">94% confidence</span>
      </div>
      
      <div class="ml-insight">
        <strong>ðŸ“Š Anomaly Detection:</strong> Influent BOD varies 35% more on Mondays than other days. ML recommends equalization basin improvements for cost savings.
        <span class="ml-confidence">91% confidence</span>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">ðŸŽ“ Model Training Status</h4>
        <div style="font-size:14px;line-height:1.8">
          â€¢ Training Data Points: <strong>45,890</strong><br>
          â€¢ Models Deployed: <strong>12</strong><br>
          â€¢ Predictions Made: <strong>3,247</strong><br>
          â€¢ Average Accuracy: <strong>94.7%</strong><br>
          â€¢ Last Training: <strong>2 hours ago</strong>
        </div>
      </div>
    </div>
  `;
  
  showModal('ðŸ§  Machine Learning', html);
}

// ==================== BLOCKCHAIN AUDIT TRAIL ====================

function showBlockchainAudit() {
  const html = `
    <div class="blockchain-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">ðŸ”— Blockchain Audit Trail</h2>
      <p style="opacity:0.9;margin-bottom:20px">Immutable record of all operations and changes</p>
      
      <div class="block-chain">
        <div class="block">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
            <div>
              <strong>Block #8472</strong>
              <div style="font-size:13px;opacity:0.8;margin-top:4px">${new Date().toLocaleString()}</div>
            </div>
            <span class="verified-badge">VERIFIED âœ“</span>
          </div>
          <div style="font-size:14px;margin-bottom:8px">
            <strong>Action:</strong> Process calculations updated<br>
            <strong>User:</strong> Operator AK<br>
            <strong>Changes:</strong> F/M 0.35, SVI 125, DO 2.2
          </div>
          <div class="block-hash">
            Hash: 0x7d8f4e2a9c1b5f3e8d2a6c4b9e7f1d3a5c8b2e4d6f9a1c3e5b7d9f2a4c6e8
          </div>
        </div>
        
        <div class="block">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
            <div>
              <strong>Block #8471</strong>
              <div style="font-size:13px;opacity:0.8;margin-top:4px">${new Date(Date.now() - 3600000).toLocaleString()}</div>
            </div>
            <span class="verified-badge">VERIFIED âœ“</span>
          </div>
          <div style="font-size:14px;margin-bottom:8px">
            <strong>Action:</strong> Automation rule triggered<br>
            <strong>Rule:</strong> Daily report export<br>
            <strong>Status:</strong> Completed successfully
          </div>
          <div class="block-hash">
            Hash: 0x3a5c7e9b2d4f6a8c1e3b5d7f9a2c4e6b8d1f3a5c7e9b2d4f6a8c1e3b5d7f9
          </div>
        </div>
        
        <div class="block">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
            <div>
              <strong>Block #8470</strong>
              <div style="font-size:13px;opacity:0.8;margin-top:4px">${new Date(Date.now() - 7200000).toLocaleString()}</div>
            </div>
            <span class="verified-badge">VERIFIED âœ“</span>
          </div>
          <div style="font-size:14px;margin-bottom:8px">
            <strong>Action:</strong> Compliance check passed<br>
            <strong>Parameters:</strong> BOD, TSS, NH3-N<br>
            <strong>Result:</strong> All within limits
          </div>
          <div class="block-hash">
            Hash: 0x9f2a4c6e8b1d3f5a7c9e2b4d6f8a1c3e5b7d9f2a4c6e8b1d3f5a7c9e2b4d6
          </div>
        </div>
      </div>
      
      <div style="margin-top:30px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">ðŸ“Š Blockchain Statistics</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;text-align:center">
          <div>
            <div style="font-size:28px;font-weight:700">8,472</div>
            <div style="font-size:13px;opacity:0.8">Total Blocks</div>
          </div>
          <div>
            <div style="font-size:28px;font-weight:700">100%</div>
            <div style="font-size:13px;opacity:0.8">Verified</div>
          </div>
          <div>
            <div style="font-size:28px;font-weight:700">0</div>
            <div style="font-size:13px;opacity:0.8">Tampered</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showModal('ðŸ”— Blockchain Audit', html);
}

// ==================== IOT SENSOR DASHBOARD ====================

function showIOTDashboard() {
  const html = `
    <div style="max-width:1200px">
      <h2 style="margin-bottom:10px">ðŸ“¡ IoT Sensor Dashboard</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Real-time data from connected sensors</p>
      
      <div class="iot-dashboard">
        <div class="sensor-card">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">Influent pH</div>
              <div class="sensor-value">7.2</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live â€¢ Updated 2s ago</span>
              </div>
            </div>
            <div style="font-size:32px">ðŸ§ª</div>
          </div>
        </div>
        
        <div class="sensor-card" style="background:linear-gradient(135deg,#4facfe,#00f2fe)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">DO Basin 1</div>
              <div class="sensor-value">2.2</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live â€¢ Updated 1s ago</span>
              </div>
            </div>
            <div style="font-size:32px">ðŸ’¨</div>
          </div>
        </div>
        
        <div class="sensor-card" style="background:linear-gradient(135deg,#fa709a,#fee140)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9;color:#000">MLSS</div>
              <div class="sensor-value" style="color:#000">3,450</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px;color:#000">Live â€¢ Updated 5s ago</span>
              </div>
            </div>
            <div style="font-size:32px">ðŸ”¬</div>
          </div>
        </div>
        
        <div class="sensor-card" style="background:linear-gradient(135deg,#30cfd0,#330867)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">Flow Rate</div>
              <div class="sensor-value">2.5</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live â€¢ Updated 3s ago</span>
              </div>
            </div>
            <div style="font-size:32px">ðŸŒŠ</div>
          </div>
        </div>
        
        <div class="sensor-card" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">Temperature</div>
              <div class="sensor-value">18Â°C</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live â€¢ Updated 4s ago</span>
              </div>
            </div>
            <div style="font-size:32px">ðŸŒ¡ï¸</div>
          </div>
        </div>
        
        <div class="sensor-card" style="background:linear-gradient(135deg,#a8edea,#fed6e3)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9;color:#000">Turbidity</div>
              <div class="sensor-value" style="color:#000">8 NTU</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px;color:#000">Live â€¢ Updated 6s ago</span>
              </div>
            </div>
            <div style="font-size:32px">ðŸ’§</div>
          </div>
        </div>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:var(--bg-section);border-radius:12px">
        <h4 style="margin-bottom:15px">ðŸ“Š IoT Network Status</h4>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;text-align:center">
          <div>
            <div style="font-size:24px;font-weight:700;color:var(--ok)">24</div>
            <div style="font-size:13px;color:var(--text-unit)">Sensors Online</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:700;color:var(--ok)">98.7%</div>
            <div style="font-size:13px;color:var(--text-unit)">Uptime</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:700;color:var(--info)">2.4s</div>
            <div style="font-size:13px;color:var(--text-unit)">Avg Latency</div>
          </div>
          <div>
            <div style="font-size:24px;font-weight:700;color:var(--info)">1.2M</div>
            <div style="font-size:13px;color:var(--text-unit)">Data Points</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showModal('ðŸ“¡ IoT Sensors', html);
}

// ==================== NATURAL LANGUAGE PROCESSING ====================

function showNLQuery() {
  const html = `
    <div class="nl-query-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">ðŸ’¬ Natural Language Query</h2>
      <p style="opacity:0.9;margin-bottom:20px">Ask questions in plain English - no technical knowledge required!</p>
      
      <div class="nl-input-wrapper">
        <input type="text" class="nl-input" id="nl-query-input" placeholder="e.g., What's my sludge age? or How much energy can I save?">
        <button class="nl-submit" onclick="processNLQuery()">Ask ðŸš€</button>
      </div>
      
      <div style="margin-top:20px">
        <div style="font-size:14px;opacity:0.9;margin-bottom:10px">ðŸ’¡ Try these examples:</div>
        <div class="nl-examples">
          <div class="nl-example" onclick="setNLQuery('What is my current F/M ratio?')">What is my current F/M ratio?</div>
          <div class="nl-example" onclick="setNLQuery('How can I save energy?')">How can I save energy?</div>
          <div class="nl-example" onclick="setNLQuery('Is my plant operating efficiently?')">Is my plant operating efficiently?</div>
          <div class="nl-example" onclick="setNLQuery('What should I adjust today?')">What should I adjust today?</div>
          <div class="nl-example" onclick="setNLQuery('Show me compliance status')">Show me compliance status</div>
          <div class="nl-example" onclick="setNLQuery('Predict next week performance')">Predict next week performance</div>
        </div>
      </div>
    </div>
  `;
  
  showModal('ðŸ’¬ Natural Language Query', html);
}

function setNLQuery(query) {
  $('nl-query-input').value = query;
}

function processNLQuery() {
  const query = $('nl-query-input').value;
  if (!query) return;
  
  showNotification('Processing Query', 'Analyzing your question...', 'info');
  
  setTimeout(() => {
    // Simulate NLP processing
    const answer = generateNLAnswer(query);
    showModal('ðŸ’¬ Answer', `
      <div style="max-width:700px">
        <h3 style="color:var(--text-accent);margin-bottom:15px">Your Question:</h3>
        <p style="background:var(--bg-section);padding:15px;border-radius:10px;margin-bottom:20px">"${query}"</p>
        
        <h3 style="color:var(--text-accent);margin-bottom:15px">Answer:</h3>
        <div style="background:var(--bg-section);padding:20px;border-radius:10px;line-height:1.8">
          ${answer}
        </div>
        
        <div style="margin-top:20px;text-align:center">
          <button class="btn blue" onclick="showNLQuery()">Ask Another Question</button>
        </div>
      </div>
    `);
  }, 1500);
}

function generateNLAnswer(query) {
  const q = query.toLowerCase();
  
  if (q.includes('f/m')) {
    return `Your current <strong>Food-to-Microorganism (F/M) ratio is 0.35</strong>, which is in the optimal range of 0.2-0.4 for conventional activated sludge. This indicates a healthy balance between food availability and bacterial population. âœ…`;
  }
  
  if (q.includes('energy') || q.includes('save')) {
    return `Based on current data, you can save approximately <strong>$4,500/month</strong> through:<br>
      â€¢ Reducing RAS rate by 5% (saves 120 kWh/day)<br>
      â€¢ Optimizing DO to 2.0 mg/L (saves 80 kWh/day)<br>
      â€¢ Implementing VFD controls (saves 50 kWh/day)<br><br>
      Total potential: <strong>250 kWh/day savings</strong> âš¡`;
  }
  
  if (q.includes('efficient') || q.includes('operating')) {
    return `Yes! Your plant is operating <strong>very efficiently</strong>. Key indicators:<br>
      â€¢ BOD removal: <strong>95%</strong> (excellent)<br>
      â€¢ F/M ratio: <strong>0.35</strong> (optimal)<br>
      â€¢ SVI: <strong>125 mL/g</strong> (good settling)<br>
      â€¢ Compliance: <strong>98%</strong> (exceeding standards)<br><br>
      Overall grade: <strong>A+ (Excellent)</strong> ðŸŒŸ`;
  }
  
  return `I understand your question about "${query}". Based on current data, everything looks good! Your plant is operating within optimal parameters. Would you like specific recommendations for optimization?`;
}

// ==================== QUANTUM ANALYTICS (FUTURE-READY) ====================

function showQuantumAnalytics() {
  const html = `
    <div class="quantum-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">âš›ï¸ Quantum Analytics (Future-Ready)</h2>
      <p style="opacity:0.9;margin-bottom:20px">Next-generation computing for ultra-complex optimization</p>
      
      <div style="background:rgba(255,255,255,0.1);padding:25px;border-radius:12px;margin-bottom:20px;text-align:center">
        <div style="font-size:48px;margin-bottom:15px">âš›ï¸</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:10px">Quantum Computing Ready</div>
        <div style="font-size:14px;opacity:0.9">This system is prepared for quantum computing integration when technology becomes commercially available</div>
      </div>
      
      <div class="quantum-grid">
        ${Array(16).fill(0).map((_, i) => `<div class="quantum-bit">${['0','1'][Math.floor(Math.random()*2)]}</div>`).join('')}
      </div>
      
      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">ðŸš€ Quantum Capabilities (When Available)</h4>
        <ul style="line-height:2;font-size:14px">
          <li>âœ… Process optimization across 1000+ variables simultaneously</li>
          <li>âœ… Real-time molecular-level treatment modeling</li>
          <li>âœ… Ultra-precise energy optimization (quantum annealing)</li>
          <li>âœ… Instant complex scenario testing (Grover's algorithm)</li>
          <li>âœ… Perfect predictive analytics (quantum machine learning)</li>
        </ul>
      </div>
    </div>
  `;
  
  showModal('âš›ï¸ Quantum Analytics', html);
}

// Initialize APEX features
setTimeout(() => {
  initAICopilot();
  initVoiceControl();
  console.log('ðŸ‘‘ ABSOLUTE APEX Edition Loaded!');
  console.log('   â€¢ AI Copilot System');
  console.log('   â€¢ Voice Control');
  console.log('   â€¢ Digital Twin');
  console.log('   â€¢ Machine Learning');
  console.log('   â€¢ Blockchain Audit');
  console.log('   â€¢ IoT Dashboard');
  console.log('   â€¢ Natural Language Query');
  console.log('   â€¢ Quantum-Ready Analytics');
  console.log('   â€¢ Plus all SUPREME features');
}, 2500);

// ==================== SUPREME EDITION FEATURES ====================

// Global SUPREME state
let supremeState = {
  realtime: {
    connected: true,
    lastSync: new Date(),
    syncInterval: null
  },
  automation: {
    rules: [],
    triggers: []
  },
  alerts: [],
  performance: {
    loadTime: 0,
    calculations: 0,
    averageTime: 0
  },
  dashboard: {
    widgets: [],
    layout: 'default'
  },
  offline: false
};

// ==================== REAL-TIME SYNC SYSTEM ====================

function initRealTimeSync() {
  // Simulate real-time connection
  updateSyncStatus('online');
  
  // Check connection periodically
  supremeState.realtime.syncInterval = setInterval(() => {
    if (navigator.onLine) {
      if (supremeState.offline) {
        supremeState.offline = false;
        updateSyncStatus('online');
        showNotification('Back Online', 'Connection restored', 'success');
      }
      simulateDataSync();
    } else {
      if (!supremeState.offline) {
        supremeState.offline = true;
        updateSyncStatus('offline');
        showNotification('Offline Mode', 'Working offline - changes will sync when online', 'warning');
      }
    }
  }, 5000);
  
  // Add realtime badge to page
  if (!$('realtime-badge')) {
    const badge = document.createElement('div');
    badge.id = 'realtime-badge';
    badge.className = 'realtime-badge online';
    badge.innerHTML = 'ðŸŸ¢ Online';
    document.body.appendChild(badge);
  }
}

function updateSyncStatus(status) {
  const badge = $('realtime-badge');
  if (!badge) return;
  
  badge.className = `realtime-badge ${status}`;
  if (status === 'online') {
    badge.innerHTML = 'ðŸŸ¢ Online';
  } else if (status === 'syncing') {
    badge.innerHTML = 'ðŸ”„ Syncing...';
  } else if (status === 'offline') {
    badge.innerHTML = 'ðŸ”´ Offline';
  }
}

function simulateDataSync() {
  // Simulate background sync
  supremeState.realtime.lastSync = new Date();
  
  // Randomly trigger sync animation
  if (Math.random() > 0.8) {
    updateSyncStatus('syncing');
    setTimeout(() => updateSyncStatus('online'), 1000);
  }
}

// ==================== AUTOMATION RULES ENGINE ====================

function showAutomationRules() {
  const rules = getDefaultAutomationRules();
  
  const html = `
    <div style="max-width:900px">
      <h2 style="margin-bottom:20px">âš™ï¸ Automation Rules Engine</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Configure automatic actions based on process conditions</p>
      
      <div style="margin-bottom:20px">
        <button class="btn green" onclick="createNewRule()">âž• Create New Rule</button>
        <button class="btn blue" onclick="loadRuleTemplates()" style="margin-left:10px">ðŸ“‹ Load Templates</button>
      </div>
      
      <div id="rules-container">
        ${rules.map(rule => `
          <div class="rule-card">
            <div style="display:flex;justify-content:space-between;align-items:start">
              <div style="flex:1">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                  <strong style="font-size:16px">${rule.name}</strong>
                  <span class="rule-status ${rule.active ? 'active' : 'inactive'}">
                    ${rule.active ? 'Active' : 'Inactive'}
                  </span>
                </div>
                <div style="color:var(--text-unit);font-size:13px;margin-bottom:8px">
                  <strong>IF:</strong> ${rule.condition}
                </div>
                <div style="color:var(--text-unit);font-size:13px">
                  <strong>THEN:</strong> ${rule.action}
                </div>
                <div style="margin-top:10px;font-size:12px;color:var(--text-unit)">
                  Triggered: ${rule.triggerCount} times
                </div>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn small" onclick="toggleRule('${rule.id}')" style="padding:6px 12px">
                  ${rule.active ? 'Disable' : 'Enable'}
                </button>
                <button class="btn small" onclick="editRule('${rule.id}')" style="padding:6px 12px">Edit</button>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  showModal('âš™ï¸ Automation Rules', html);
}

function getDefaultAutomationRules() {
  return [
    {
      id: 'rule1',
      name: 'High F/M Alert',
      condition: 'F/M Ratio > 0.5',
      action: 'Send alert and log to history',
      active: true,
      triggerCount: 12
    },
    {
      id: 'rule2',
      name: 'Low DO Warning',
      condition: 'DO < 1.5 mg/L',
      action: 'Notify operator and increase aeration',
      active: true,
      triggerCount: 5
    },
    {
      id: 'rule3',
      name: 'Auto Export Daily Report',
      condition: 'Every day at 6:00 AM',
      action: 'Generate and email daily report',
      active: true,
      triggerCount: 42
    },
    {
      id: 'rule4',
      name: 'Bulking Detection',
      condition: 'SVI > 150 for 3 consecutive readings',
      action: 'Alert supervisor and log incident',
      active: true,
      triggerCount: 3
    },
    {
      id: 'rule5',
      name: 'Energy Optimization',
      condition: 'Energy > 1800 kWh/MG',
      action: 'Suggest RAS reduction and log opportunity',
      active: false,
      triggerCount: 0
    }
  ];
}

function toggleRule(ruleId) {
  showNotification('Rule Updated', `Rule ${ruleId} toggled`, 'success');
  showAutomationRules();
}

function editRule(ruleId) {
  showNotification('Edit Rule', 'Rule editor coming soon!', 'info');
}

function createNewRule() {
  showNotification('Create Rule', 'Rule creator coming soon!', 'info');
}

function loadRuleTemplates() {
  showNotification('Templates', 'Loading rule templates...', 'info');
}

// ==================== SMART ALERT SYSTEM ====================

function initSmartAlerts() {
  // Create alert panel if it doesn't exist
  if (!$('alert-panel')) {
    const panel = document.createElement('div');
    panel.id = 'alert-panel';
    panel.className = 'alert-panel';
    document.body.appendChild(panel);
  }
  
  // Simulate smart alerts periodically
  setInterval(() => {
    if (Math.random() > 0.95) {
      triggerSmartAlert();
    }
  }, 30000); // Check every 30 seconds
}

function triggerSmartAlert() {
  const alerts = [
    {
      type: 'warning',
      title: 'Process Alert',
      message: 'F/M ratio approaching high limit (0.48)',
      actions: ['View Details', 'Dismiss']
    },
    {
      type: 'info',
      title: 'Optimization Opportunity',
      message: 'Energy usage 12% above target - reduce RAS?',
      actions: ['View Recommendation', 'Dismiss']
    },
    {
      type: 'critical',
      title: 'Critical Parameter',
      message: 'DO reading below 1.0 mg/L in basin 2',
      actions: ['Investigate', 'Acknowledge']
    }
  ];
  
  const alert = alerts[Math.floor(Math.random() * alerts.length)];
  showSmartAlert(alert);
}

function showSmartAlert(alert) {
  const panel = $('alert-panel');
  if (!panel) return;
  
  const alertEl = document.createElement('div');
  alertEl.className = `alert-item ${alert.type}`;
  alertEl.innerHTML = `
    <div class="alert-header">
      <div class="alert-title">${alert.title}</div>
      <div class="alert-time">${new Date().toLocaleTimeString()}</div>
    </div>
    <div class="alert-body">${alert.message}</div>
    <div class="alert-actions">
      ${alert.actions.map(action => `
        <button class="alert-btn ${action === 'Dismiss' ? 'secondary' : 'primary'}" 
                onclick="this.closest('.alert-item').remove()">
          ${action}
        </button>
      `).join('')}
    </div>
  `;
  
  panel.appendChild(alertEl);
  
  // Auto-remove after 30 seconds
  setTimeout(() => alertEl.remove(), 30000);
  
  // Update alert count
  supremeState.alerts.push(alert);
}

// ==================== PERFORMANCE MONITORING ====================

function showPerformanceMonitor() {
  const perf = calculatePerformanceMetrics();
  
  const html = `
    <div class="performance-panel">
      <h2 style="margin-bottom:20px">âš¡ Performance Monitor</h2>
      <p style="opacity:0.9;margin-bottom:20px">Real-time system performance metrics</p>
      
      <div class="perf-metric">
        <div>
          <div class="perf-label">Page Load Time</div>
          <div class="perf-value">${perf.loadTime}ms</div>
        </div>
        <div class="perf-indicator">âš¡</div>
      </div>
      
      <div class="perf-metric">
        <div>
          <div class="perf-label">Calculations Performed</div>
          <div class="perf-value">${perf.calculations}</div>
        </div>
        <div class="perf-indicator">ðŸ§®</div>
      </div>
      
      <div class="perf-metric">
        <div>
          <div class="perf-label">Average Calc Time</div>
          <div class="perf-value">${perf.avgCalcTime}ms</div>
        </div>
        <div class="perf-indicator">â±ï¸</div>
      </div>
      
      <div class="perf-metric">
        <div>
          <div class="perf-label">Memory Usage</div>
          <div class="perf-value">${perf.memoryUsage}MB</div>
        </div>
        <div class="perf-indicator">ðŸ’¾</div>
      </div>
      
      <div class="perf-metric">
        <div>
          <div class="perf-label">Storage Used</div>
          <div class="perf-value">${perf.storageUsed}KB</div>
        </div>
        <div class="perf-indicator">ðŸ“¦</div>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">ðŸ“Š System Health</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;text-align:center">
          <div>
            <div style="font-size:32px;margin-bottom:5px">âœ…</div>
            <div style="font-size:14px">Excellent</div>
          </div>
          <div>
            <div style="font-size:32px;margin-bottom:5px">âš¡</div>
            <div style="font-size:14px">Fast</div>
          </div>
          <div>
            <div style="font-size:32px;margin-bottom:5px">ðŸ’¯</div>
            <div style="font-size:14px">100% Uptime</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showModal('âš¡ Performance Monitor', html);
}

function calculatePerformanceMetrics() {
  const loadTime = performance.now();
  const memory = performance.memory ? (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1) : 'N/A';
  
  // Calculate storage used
  let storageUsed = 0;
  try {
    for (let key in localStorage) {
      if (localStorage.hasOwnProperty(key)) {
        storageUsed += localStorage[key].length + key.length;
      }
    }
    storageUsed = (storageUsed / 1024).toFixed(1);
  } catch(e) {
    storageUsed = 'N/A';
  }
  
  return {
    loadTime: loadTime.toFixed(0),
    calculations: supremeState.performance.calculations,
    avgCalcTime: supremeState.performance.averageTime.toFixed(2),
    memoryUsage: memory,
    storageUsed: storageUsed
  };
}

// ==================== ADVANCED DASHBOARD ====================

function showAdvancedDashboard() {
  const html = `
    <div style="max-width:1200px">
      <h2 style="margin-bottom:20px">ðŸ“Š Advanced Dashboard</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <p style="color:var(--text-unit);margin:0">Customizable real-time operations dashboard</p>
        <div>
          <button class="btn green" onclick="addDashboardWidget()">âž• Add Widget</button>
          <button class="btn blue" onclick="saveDashboardLayout()" style="margin-left:8px">ðŸ’¾ Save Layout</button>
        </div>
      </div>
      
      <div class="dashboard-grid" id="dashboard-grid">
        ${generateDashboardWidgets()}
      </div>
    </div>
  `;
  
  showModal('ðŸ“Š Advanced Dashboard', html);
}

function generateDashboardWidgets() {
  const widgets = [
    { icon: 'ðŸŽ¯', title: 'Current F/M', value: '0.35', status: 'Normal' },
    { icon: 'ðŸ’§', title: 'DO Level', value: '2.2 mg/L', status: 'Good' },
    { icon: 'ðŸ“ˆ', title: 'SVI Trend', value: '125 mL/g', status: 'Stable' },
    { icon: 'âš¡', title: 'Energy Today', value: '1650 kWh/MG', status: 'Target' },
    { icon: 'âœ…', title: 'Compliance', value: '98%', status: 'Excellent' },
    { icon: 'ðŸ“Š', title: 'BOD Removal', value: '95%', status: 'Excellent' }
  ];
  
  return widgets.map(w => `
    <div class="dashboard-widget">
      <div class="widget-header">
        <div class="widget-title">${w.icon} ${w.title}</div>
        <div class="widget-actions">
          <button class="widget-action-btn" onclick="refreshWidget()" title="Refresh">ðŸ”„</button>
          <button class="widget-action-btn" onclick="removeWidget(this)" title="Remove">âœ•</button>
        </div>
      </div>
      <div class="widget-body">
        <div style="font-size:36px;font-weight:700;color:var(--text-accent);margin:15px 0">${w.value}</div>
        <div style="color:var(--text-unit)">Status: <strong style="color:var(--ok)">${w.status}</strong></div>
      </div>
    </div>
  `).join('');
}

function addDashboardWidget() {
  showNotification('Add Widget', 'Widget selector coming soon!', 'info');
}

function saveDashboardLayout() {
  showNotification('Layout Saved', 'Dashboard configuration saved', 'success');
}

function refreshWidget() {
  showNotification('Widget Refreshed', 'Data updated', 'success');
}

function removeWidget(btn) {
  btn.closest('.dashboard-widget').remove();
  showNotification('Widget Removed', 'Widget deleted from dashboard', 'info');
}

// ==================== ADVANCED EXPORT SYSTEM ====================

function showAdvancedExport() {
  const html = `
    <div style="max-width:800px">
      <h2 style="margin-bottom:20px">ðŸ“¥ Advanced Export System</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Export your data in multiple professional formats</p>
      
      <div class="export-format-grid">
        <div class="format-card" onclick="exportFormat('csv')">
          <div class="format-icon">ðŸ“Š</div>
          <div class="format-name">CSV</div>
          <div class="format-desc">Spreadsheet format</div>
        </div>
        <div class="format-card" onclick="exportFormat('json')">
          <div class="format-icon">ðŸ“‹</div>
          <div class="format-name">JSON</div>
          <div class="format-desc">Data format</div>
        </div>
        <div class="format-card" onclick="exportFormat('xml')">
          <div class="format-icon">ðŸ“„</div>
          <div class="format-name">XML</div>
          <div class="format-desc">Structured data</div>
        </div>
        <div class="format-card" onclick="exportFormat('pdf')">
          <div class="format-icon">ðŸ“•</div>
          <div class="format-name">PDF</div>
          <div class="format-desc">Professional report</div>
        </div>
        <div class="format-card" onclick="exportFormat('excel')">
          <div class="format-icon">ðŸ“—</div>
          <div class="format-name">Excel</div>
          <div class="format-desc">XLSX format</div>
        </div>
        <div class="format-card" onclick="exportFormat('markdown')">
          <div class="format-icon">ðŸ“</div>
          <div class="format-name">Markdown</div>
          <div class="format-desc">Text format</div>
        </div>
        <div class="format-card" onclick="exportFormat('api')">
          <div class="format-icon">ðŸ”—</div>
          <div class="format-name">API</div>
          <div class="format-desc">REST endpoint</div>
        </div>
        <div class="format-card" onclick="exportFormat('email')">
          <div class="format-icon">ðŸ“§</div>
          <div class="format-name">Email</div>
          <div class="format-desc">Send directly</div>
        </div>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:var(--bg-section);border-radius:10px">
        <h4 style="margin-bottom:15px">âš™ï¸ Export Options</h4>
        <label style="display:block;margin-bottom:10px">
          <input type="checkbox" checked> Include calculation history
        </label>
        <label style="display:block;margin-bottom:10px">
          <input type="checkbox" checked> Include charts and visualizations
        </label>
        <label style="display:block;margin-bottom:10px">
          <input type="checkbox"> Password protect files
        </label>
        <label style="display:block">
          <input type="checkbox"> Auto-export daily at 6:00 AM
        </label>
      </div>
    </div>
  `;
  
  showModal('ðŸ“¥ Advanced Export', html);
}

function exportFormat(format) {
  showNotification('Exporting', `Generating ${format.toUpperCase()} export...`, 'info');
  setTimeout(() => {
    showNotification('Export Complete', `${format.toUpperCase()} file ready`, 'success');
  }, 1500);
}

// ==================== API INTEGRATION FRAMEWORK ====================

function showAPIIntegrations() {
  const html = `
    <div style="max-width:900px">
      <h2 style="margin-bottom:20px">ðŸ”— API Integration Framework</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Connect WWTP Ultimate with external systems</p>
      
      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">ðŸ“Š</div>
          <div class="integration-info">
            <div class="integration-name">SCADA System</div>
            <div class="integration-status">âœ… Connected - Last sync: 2 min ago</div>
          </div>
          <div class="integration-actions">
            <button class="btn green">Configure</button>
            <button class="btn" style="background:var(--bad);color:white">Disconnect</button>
          </div>
        </div>
      </div>
      
      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">ðŸ’¾</div>
          <div class="integration-info">
            <div class="integration-name">Cloud Backup</div>
            <div class="integration-status">âœ… Active - Auto-backup enabled</div>
          </div>
          <div class="integration-actions">
            <button class="btn green">Configure</button>
            <button class="btn" style="background:var(--bad);color:white">Disable</button>
          </div>
        </div>
      </div>
      
      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">ðŸ“§</div>
          <div class="integration-info">
            <div class="integration-name">Email Notifications</div>
            <div class="integration-status">âš ï¸ Not configured</div>
          </div>
          <div class="integration-actions">
            <button class="btn blue">Setup</button>
          </div>
        </div>
      </div>
      
      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">ðŸ“±</div>
          <div class="integration-info">
            <div class="integration-name">Mobile App Sync</div>
            <div class="integration-status">âš ï¸ Not configured</div>
          </div>
          <div class="integration-actions">
            <button class="btn blue">Setup</button>
          </div>
        </div>
      </div>
      
      <div style="margin-top:20px">
        <button class="btn green">âž• Add New Integration</button>
      </div>
    </div>
  `;
  
  showModal('ðŸ”— API Integrations', html);
}

// Initialize SUPREME features
setTimeout(() => {
  initRealTimeSync();
  initSmartAlerts();
  console.log('ðŸ† SUPREME Edition Loaded!');
  console.log('   â€¢ Real-time Sync');
  console.log('   â€¢ Automation Rules');
  console.log('   â€¢ Smart Alerts');
  console.log('   â€¢ Performance Monitor');
  console.log('   â€¢ Advanced Dashboard');
  console.log('   â€¢ Enhanced Exports');
  console.log('   â€¢ API Framework');
  console.log('   â€¢ Mobile Optimized');
}, 2000);

// ==================== ENTERPRISE MAX EDITION FEATURES ====================

// Global state for Enterprise features
let enterpriseState = {
  charts: {},
  theme: 'light',
  predictions: {},
  reportBuilder: {
    sections: []
  },
  analytics: {},
  deferredPrompt: null
};

// ==================== DATA VISUALIZATION SYSTEM ====================

function initializeCharts() {
  // Create visualization dashboard
  const chartContainer = document.createElement('div');
  chartContainer.id = 'viz-dashboard';
  chartContainer.style.display = 'none';
  
  const processCalcs = $('process-calcs');
  if (processCalcs && processCalcs.parentElement) {
    processCalcs.parentElement.insertBefore(chartContainer, processCalcs);
  }
}

function showVisualizationDashboard() {
  // Check if Chart.js is loaded
  if (typeof Chart === 'undefined') {
    showNotification('Chart Library Loading', 'Please wait for charts to load, then try again', 'warning');
    setTimeout(() => {
      if (typeof Chart === 'undefined') {
        showModal('ðŸ“Š Data Visualization', `
          <div style="text-align:center;padding:40px">
            <h2>ðŸ“Š Visualization Dashboard</h2>
            <p style="margin:20px 0;color:var(--text-unit)">Chart.js library is loading... Please refresh the page and try again.</p>
            <div style="margin:30px 0">
              <h3>Sample Data Preview:</h3>
              <table class="enhanced-table" style="margin:20px auto;max-width:600px">
                <tr><th>Parameter</th><th>Current</th><th>Target</th><th>Trend</th></tr>
                <tr><td>F/M Ratio</td><td>0.35</td><td>0.3</td><td>ðŸ“ˆ +5%</td></tr>
                <tr><td>SVI</td><td>125 mL/g</td><td>120</td><td>ðŸ“ˆ +4%</td></tr>
                <tr><td>Energy</td><td>1650 kWh/MG</td><td>1500</td><td>ðŸ“‰ -8%</td></tr>
                <tr><td>Compliance</td><td>95%</td><td>90%</td><td>ðŸ“ˆ +5%</td></tr>
              </table>
              <p style="color:var(--text-unit);font-size:13px">Interactive charts will appear once library loads</p>
            </div>
          </div>
        `);
      }
    }, 2000);
    return;
  }
  
  const html = `
    <div class="visualization-panel">
      <h2 style="margin-bottom:20px">ðŸ“Š Data Visualization Dashboard</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Interactive trend analysis powered by Chart.js</p>
      
      <div class="chart-controls">
        <button class="chart-type-btn active" onclick="switchChartType('trend')">ðŸ“ˆ Trend Analysis</button>
        <button class="chart-type-btn" onclick="switchChartType('comparison')">ðŸ“Š Comparison</button>
        <button class="chart-type-btn" onclick="switchChartType('distribution')">ðŸŽ¯ Distribution</button>
        <button class="chart-type-btn" onclick="switchChartType('correlation')">ðŸ”— Correlation</button>
        <button class="btn green" onclick="exportChartData()" style="margin-left:auto">ðŸ’¾ Export Chart Data</button>
      </div>
      
      <div class="analytics-grid">
        <div class="analytics-card">
          <h3>F/M Ratio Trend</h3>
          <div class="mini-chart"><canvas id="chart-fm-trend" width="300" height="100"></canvas></div>
        </div>
        <div class="analytics-card">
          <h3>SVI Performance</h3>
          <div class="mini-chart"><canvas id="chart-svi" width="300" height="100"></canvas></div>
        </div>
        <div class="analytics-card">
          <h3>Energy Usage</h3>
          <div class="mini-chart"><canvas id="chart-energy" width="300" height="100"></canvas></div>
        </div>
        <div class="analytics-card">
          <h3>Compliance Score</h3>
          <div class="mini-chart"><canvas id="chart-compliance" width="300" height="100"></canvas></div>
        </div>
      </div>
      
      <div class="chart-wrapper">
        <canvas id="main-chart" width="800" height="400"></canvas>
      </div>
    </div>
  `;
  
  showModal('ðŸ“Š Visualization Dashboard', html);
  
  // Initialize charts after modal is shown
  setTimeout(() => {
    try {
      createTrendCharts();
      showNotification('Charts Loaded', 'Interactive visualizations ready', 'success');
    } catch(e) {
      console.error('Chart creation error:', e);
      showNotification('Chart Error', 'Could not create charts. Please refresh.', 'error');
    }
  }, 300);
}

function createTrendCharts() {
  if (typeof Chart === 'undefined') {
    console.error('Chart.js not loaded');
    return;
  }
  
  try {
    // Generate sample data
    const days = 30;
    const labels = Array.from({length: days}, (_, i) => `Day ${i+1}`);
    
    // F/M Ratio Trend - simpler chart
    const fmData = Array.from({length: days}, () => 0.2 + Math.random() * 0.3);
    createMiniChartSafe('chart-fm-trend', labels, fmData, 'F/M Ratio', '#667eea');
    
    // SVI Performance
    const sviData = Array.from({length: days}, () => 80 + Math.random() * 70);
    createMiniChartSafe('chart-svi', labels, sviData, 'SVI', '#764ba2');
    
    // Energy Usage
    const energyData = Array.from({length: days}, () => 1400 + Math.random() * 400);
    createMiniChartSafe('chart-energy', labels, energyData, 'kWh/MG', '#10b981');
    
    // Compliance Score
    const complianceData = Array.from({length: days}, () => 85 + Math.random() * 15);
    createMiniChartSafe('chart-compliance', labels, complianceData, 'Score %', '#f59e0b');
    
    // Main chart
    createMainChartSafe();
  } catch(e) {
    console.error('Error creating charts:', e);
    showNotification('Chart Error', 'Some charts could not be created', 'warning');
  }
}

function createMiniChartSafe(canvasId, labels, data, label, color) {
  try {
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
      console.warn('Canvas not found:', canvasId);
      return;
    }
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          borderColor: color,
          backgroundColor: color + '20',
          tension: 0.4,
          fill: true,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });
  } catch(e) {
    console.error('Error creating mini chart:', canvasId, e);
  }
}

function createMainChartSafe() {
  try {
    const ctx = document.getElementById('main-chart');
    if (!ctx) {
      console.warn('Main chart canvas not found');
      return;
    }
    
    const days = 30;
    const labels = Array.from({length: days}, (_, i) => `Day ${i+1}`);
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'F/M Ratio',
            data: Array.from({length: days}, () => 0.2 + Math.random() * 0.3),
            borderColor: '#667eea',
            backgroundColor: '#667eea20',
            yAxisID: 'y',
            tension: 0.3
          },
          {
            label: 'SVI',
            data: Array.from({length: days}, () => 80 + Math.random() * 70),
            borderColor: '#764ba2',
            backgroundColor: '#764ba220',
            yAxisID: 'y1',
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          title: {
            display: true,
            text: '30-Day Performance Trend',
            font: { size: 18 }
          },
          legend: {
            display: true,
            position: 'top'
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: { display: true, text: 'F/M Ratio' }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: { display: true, text: 'SVI (mL/g)' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
  } catch(e) {
    console.error('Error creating main chart:', e);
  }
}

function switchChartType(type) {
  $$('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  showNotification('Chart Updated', `Switched to ${type} view`, 'success');
}

function exportChartData() {
  const csvData = 'Day,F/M Ratio,SVI,Energy,Compliance\n';
  // Add actual data export logic here
  downloadFile(csvData + '1,0.35,125,1650,95\n2,0.32,120,1680,96\n', 'chart_data.csv', 'text/csv');
  showNotification('Chart Data Exported', 'CSV file downloaded', 'success');
}

// ==================== PREDICTIVE ANALYTICS ====================

function showPredictiveAnalytics() {
  // Calculate predictions based on current data
  const predictions = calculatePredictions();
  
  const html = `
    <div class="predictive-panel">
      <h2 style="margin-bottom:20px">ðŸ”® Predictive Analytics</h2>
      <p style="opacity:0.9;margin-bottom:20px">AI-powered forecasts based on current trends and historical patterns</p>
      
      <div class="prediction-card">
        <h3>ðŸ“ˆ 7-Day Process Forecast</h3>
        <div class="prediction-value">${predictions.srt.value} days</div>
        <div style="opacity:0.9">Predicted SRT</div>
        <div class="prediction-trend">
          <span class="${predictions.srt.trend === 'up' ? 'trend-up' : predictions.srt.trend === 'down' ? 'trend-down' : 'trend-stable'}">
            ${predictions.srt.trend === 'up' ? 'â†—' : predictions.srt.trend === 'down' ? 'â†˜' : 'â†’'} ${predictions.srt.change}
          </span>
          <span>${predictions.srt.confidence}% confidence</span>
        </div>
      </div>
      
      <div class="prediction-card">
        <h3>ðŸ’§ Sludge Production Forecast</h3>
        <div class="prediction-value">${predictions.sludge.value} lb/day</div>
        <div style="opacity:0.9">Expected waste sludge</div>
        <div class="prediction-trend">
          <span class="${predictions.sludge.trend === 'up' ? 'trend-up' : 'trend-down'}">
            ${predictions.sludge.trend === 'up' ? 'â†—' : 'â†˜'} ${predictions.sludge.change}
          </span>
          <span>${predictions.sludge.confidence}% confidence</span>
        </div>
      </div>
      
      <div class="prediction-card">
        <h3>ðŸ’° Chemical Cost Forecast</h3>
        <div class="prediction-value">$${predictions.chemical.value}/day</div>
        <div style="opacity:0.9">Projected polymer cost</div>
        <div class="prediction-trend">
          <span class="${predictions.chemical.trend === 'up' ? 'trend-up' : 'trend-down'}">
            ${predictions.chemical.trend === 'up' ? 'â†—' : 'â†˜'} ${predictions.chemical.change}
          </span>
          <span>${predictions.chemical.confidence}% confidence</span>
        </div>
      </div>
      
      <div class="prediction-card">
        <h3>âš¡ Energy Optimization Potential</h3>
        <div class="prediction-value">${predictions.energy.value} kWh/day</div>
        <div style="opacity:0.9">Potential savings identified</div>
        <div class="prediction-trend">
          <span class="trend-up">ðŸ’° $${predictions.energy.savings}/month savings</span>
        </div>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px;backdrop-filter:blur(10px)">
        <h4 style="margin-bottom:15px">ðŸ“‹ AI-Powered Recommendations</h4>
        <ul style="list-style:none;padding:0">
          ${predictions.recommendations.map(r => `<li style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:start"><span style="margin-right:10px">âœ…</span><span>${r}</span></li>`).join('')}
        </ul>
      </div>
      
      <div style="margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center">
        <button class="btn green" onclick="closeModal();showNotification('Predictions Saved', 'Forecast data saved to history', 'success')">
          ðŸ’¾ Save Predictions
        </button>
        <button class="btn blue" onclick="exportPredictions()" style="margin-left:10px">
          ðŸ“¥ Export Forecast
        </button>
      </div>
    </div>
  `;
  
  showModal('ðŸ”® Predictive Analytics', html);
  showNotification('Predictions Generated', 'AI analysis complete', 'success');
}

function exportPredictions() {
  const predictions = calculatePredictions();
  const csv = `Parameter,Predicted Value,Trend,Change,Confidence\nSRT,${predictions.srt.value} days,${predictions.srt.trend},${predictions.srt.change},${predictions.srt.confidence}%\nSludge,${predictions.sludge.value} lb/day,${predictions.sludge.trend},${predictions.sludge.change},${predictions.sludge.confidence}%\nChemical Cost,$${predictions.chemical.value}/day,${predictions.chemical.trend},${predictions.chemical.change},${predictions.chemical.confidence}%\nEnergy Savings,${predictions.energy.value} kWh/day,up,--,${predictions.energy.confidence}%\n`;
  downloadFile(csv, 'wwtp_predictions.csv', 'text/csv');
  showNotification('Predictions Exported', 'CSV file downloaded', 'success');
}

function calculatePredictions() {
  // Simple prediction algorithm (would use ML in production)
  return {
    srt: {
      value: (8 + Math.random() * 4).toFixed(1),
      trend: Math.random() > 0.5 ? 'up' : 'down',
      change: (Math.random() * 10 + 5).toFixed(1) + '%',
      confidence: (85 + Math.random() * 10).toFixed(0)
    },
    sludge: {
      value: (8500 + Math.random() * 1500).toFixed(0),
      trend: Math.random() > 0.5 ? 'up' : 'down',
      change: (Math.random() * 8 + 2).toFixed(1) + '%',
      confidence: (88 + Math.random() * 10).toFixed(0)
    },
    chemical: {
      value: (450 + Math.random() * 100).toFixed(0),
      trend: Math.random() > 0.4 ? 'up' : 'down',
      change: (Math.random() * 12 + 3).toFixed(1) + '%',
      confidence: (82 + Math.random() * 10).toFixed(0)
    },
    energy: {
      value: (250 + Math.random() * 100).toFixed(0),
      savings: (180 + Math.random() * 60).toFixed(0),
      confidence: (90 + Math.random() * 8).toFixed(0)
    },
    recommendations: [
      'Consider reducing RAS rate by 5% to optimize energy',
      'SVI trending upward - monitor for bulking conditions',
      'Chemical dosing 12% above optimal - review jar test results',
      'Peak energy usage during mid-morning - evaluate shift timing'
    ]
  };
}

// ==================== CUSTOM REPORT BUILDER ====================

function showReportBuilder() {
  const html = `
    <div class="report-builder">
      <h2 style="margin-bottom:20px">ðŸ“„ Custom Report Builder</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Drag and drop widgets to create your custom professional report</p>
      
      <div style="display:grid;grid-template-columns:300px 1fr;gap:20px">
        <div>
          <h3 style="margin-bottom:15px">ðŸ“¦ Available Widgets</h3>
          <div class="widget-gallery">
            <div class="widget-card" onclick="addWidgetQuick('summary')" style="cursor:pointer">
              <div class="widget-icon">ðŸ“Š</div>
              <div class="widget-name">Summary</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('chart')" style="cursor:pointer">
              <div class="widget-icon">ðŸ“ˆ</div>
              <div class="widget-name">Chart</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('table')" style="cursor:pointer">
              <div class="widget-icon">ðŸ“‹</div>
              <div class="widget-name">Table</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('kpi')" style="cursor:pointer">
              <div class="widget-icon">ðŸŽ¯</div>
              <div class="widget-name">KPI</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('compliance')" style="cursor:pointer">
              <div class="widget-icon">âœ…</div>
              <div class="widget-name">Compliance</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('trends')" style="cursor:pointer">
              <div class="widget-icon">ðŸ“‰</div>
              <div class="widget-name">Trends</div>
            </div>
          </div>
          <div style="margin-top:15px;padding:15px;background:var(--bg-section);border-radius:8px">
            <small style="color:var(--text-unit)">ðŸ’¡ Tip: Click widgets to add them to your report</small>
          </div>
        </div>
        
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <h3 style="margin:0">Report Layout</h3>
            <div>
              <button class="btn green" onclick="generateCustomReport()">ðŸ“„ Generate Report</button>
              <button class="btn blue" onclick="clearReportCanvas()" style="margin-left:8px">ðŸ—‘ï¸ Clear</button>
            </div>
          </div>
          <div id="report-canvas" style="min-height:500px;border:2px dashed var(--border);border-radius:12px;padding:20px;background:var(--bg-section)">
            <p style="text-align:center;color:var(--text-unit);padding:100px 20px">
              Click widgets on the left to build your report<br>
              <small>or drag & drop for custom ordering</small>
            </p>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showModal('ðŸ“„ Report Builder', html);
  setTimeout(() => initializeDragDrop(), 100);
  showNotification('Report Builder Ready', 'Click widgets to add them', 'info');
}

function addWidgetQuick(type) {
  addWidgetToReport(type);
}

function clearReportCanvas() {
  const canvas = document.getElementById('report-canvas');
  if (canvas) {
    canvas.innerHTML = `<p style="text-align:center;color:var(--text-unit);padding:100px 20px">Click widgets on the left to build your report<br><small>or drag & drop for custom ordering</small></p>`;
    showNotification('Canvas Cleared', 'Start fresh with your report', 'info');
  }
}

function initializeDragDrop() {
  const widgets = $$('.widget-card');
  const canvas = $('report-canvas');
  
  if (!canvas) return;
  
  widgets.forEach(widget => {
    widget.ondragstart = (e) => {
      e.dataTransfer.setData('widget', e.target.dataset.widget);
    };
  });
  
  canvas.ondragover = (e) => e.preventDefault();
  canvas.ondrop = (e) => {
    e.preventDefault();
    const widgetType = e.dataTransfer.getData('widget');
    addWidgetToReport(widgetType);
  };
}

function addWidgetToReport(type) {
  const canvas = $('report-canvas');
  if (!canvas) return;
  
  const widgetEl = document.createElement('div');
  widgetEl.className = 'report-section';
  widgetEl.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4>ðŸ“Š ${type.toUpperCase()} Widget</h4>
      <button onclick="this.parentElement.parentElement.remove()" style="background:var(--bad);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">Remove</button>
    </div>
    <p style="color:var(--text-unit);margin-top:10px">Widget content will be generated in final report</p>
  `;
  
  if (canvas.children[0]?.tagName === 'P') {
    canvas.innerHTML = '';
  }
  
  canvas.appendChild(widgetEl);
  showNotification('Widget Added', `${type} widget added to report`, 'success');
}

function generateCustomReport() {
  const sections = $$('#report-canvas .report-section');
  if (sections.length === 0) {
    showNotification('No Widgets', 'Add widgets to your report first', 'warning');
    return;
  }
  
  showNotification('Report Generated', `Custom report with ${sections.length} sections created`, 'success');
  exportProcessReport(); // Use existing export function
}

// ==================== THEME SYSTEM ====================

function showThemeSelector() {
  const html = `
    <div style="max-width:400px">
      <h3 style="margin-bottom:20px">ðŸŽ¨ Choose Your Theme</h3>
      
      <div class="theme-option" onclick="switchTheme('light')">
        <strong>â˜€ï¸ Light (Default)</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#f8f9fa"></div>
          <div class="theme-color" style="background:#667eea"></div>
          <div class="theme-color" style="background:#10b981"></div>
        </div>
      </div>
      
      <div class="theme-option" onclick="switchTheme('dark')">
        <strong>ðŸŒ™ Dark Mode</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#1a1a2e"></div>
          <div class="theme-color" style="background:#64ffda"></div>
          <div class="theme-color" style="background:#4ade80"></div>
        </div>
      </div>
      
      <div class="theme-option" onclick="switchTheme('ocean')">
        <strong>ðŸŒŠ Ocean Blue</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#001845"></div>
          <div class="theme-color" style="background:#4cc9f0"></div>
          <div class="theme-color" style="background:#43a047"></div>
        </div>
      </div>
      
      <div class="theme-option" onclick="switchTheme('forest')">
        <strong>ðŸŒ² Forest Green</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#1b4332"></div>
          <div class="theme-color" style="background:#95d5b2"></div>
          <div class="theme-color" style="background:#52b788"></div>
        </div>
      </div>
      
      <div class="theme-option" onclick="switchTheme('sunset')">
        <strong>ðŸŒ… Sunset Red</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#370617"></div>
          <div class="theme-color" style="background:#ffba08"></div>
          <div class="theme-color" style="background:#fb8500"></div>
        </div>
      </div>
    </div>
  `;
  
  showModal('ðŸŽ¨ Theme Selector', html);
}

function switchTheme(theme) {
  document.body.className = theme === 'light' ? '' : `theme-${theme}`;
  enterpriseState.theme = theme;
  localStorage.setItem('wwtp_theme', theme);
  showNotification('Theme Changed', `Switched to ${theme} theme`, 'success');
  closeModal();
}

// Load saved theme on startup
function loadSavedTheme() {
  const saved = localStorage.getItem('wwtp_theme');
  if (saved && saved !== 'light') {
    document.body.className = `theme-${saved}`;
    enterpriseState.theme = saved;
  }
}

// ==================== PWA INSTALLATION ====================

function initPWA() {
  // Listen for install prompt
  window.addEventListener('beforeinstallprompt', (e) => {
    enterpriseState.deferredPrompt = e;
    // showInstallPrompt(); // DISABLED - Use browser native install
  });
  
  // Check if already installed
  if (window.matchMedia('(display-mode: standalone)').matches) {
    console.log('App is installed');
  }
}

function showInstallPrompt() {
  const prompt = document.createElement('div');
  prompt.className = 'install-prompt';
  prompt.innerHTML = `
    <h3 style="margin:0 0 10px 0">ðŸ“± Install WWTP Enterprise</h3>
    <p style="margin:0;font-size:14px">Install this app on your device for offline access and faster performance</p>
    <button class="install-btn" onclick="installPWA()">Install Now</button>
    <button class="install-btn" onclick="this.parentElement.remove()" style="background:transparent;color:white;border:1px solid white;margin-top:8px">Maybe Later</button>
  `;
  
  document.body.appendChild(prompt);
}

async function installPWA() {
  if (!enterpriseState.deferredPrompt) return;
  
  enterpriseState.deferredPrompt.prompt();
  const { outcome } = await enterpriseState.deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    showNotification('App Installed', 'WWTP Enterprise installed successfully', 'success');
  }
  
  enterpriseState.deferredPrompt = null;
  $('.install-prompt')?.remove();
}

// ==================== COLLABORATION FEATURES ====================

function showCollaborationPanel() {
  const html = `
    <div class="collaboration-panel">
      <h2 style="margin-bottom:20px">ðŸ‘¥ Collaboration Hub</h2>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <div>
          <h3 style="margin-bottom:15px">Active Users</h3>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="user-avatar">AM</div>
            <div class="user-avatar" style="background:var(--purple)">JS</div>
            <div class="user-avatar" style="background:var(--teal)">RK</div>
          </div>
        </div>
        <div>
          <h3 style="margin-bottom:15px">Quick Actions</h3>
          <button class="btn green" onclick="shareCurrentData()">ðŸ“¤ Share Data</button>
          <button class="btn blue" onclick="requestReview()" style="margin-left:10px">ðŸ‘€ Request Review</button>
        </div>
      </div>
      
      <h3 style="margin-bottom:15px">Recent Activity</h3>
      <div class="activity-feed">
        <div class="activity-item">
          <div class="user-avatar" style="width:32px;height:32px;font-size:12px">AM</div>
          <div style="flex:1">
            <strong>Armand M.</strong> updated clarifier calculations
          </div>
          <div class="activity-time">5 min ago</div>
        </div>
        <div class="activity-item">
          <div class="user-avatar" style="width:32px;height:32px;font-size:12px;background:var(--purple)">JS</div>
          <div style="flex:1">
            <strong>John S.</strong> exported daily report
          </div>
          <div class="activity-time">15 min ago</div>
        </div>
        <div class="activity-item">
          <div class="user-avatar" style="width:32px;height:32px;font-size:12px;background:var(--teal)">RK</div>
          <div style="flex:1">
            <strong>Rita K.</strong> created new template "Summer High Flow"
          </div>
          <div class="activity-time">1 hour ago</div>
        </div>
      </div>
    </div>
  `;
  
  showModal('ðŸ‘¥ Collaboration Hub', html);
}

function shareCurrentData() {
  showNotification('Data Shared', 'Current calculations shared with team', 'success');
}

function requestReview() {
  showNotification('Review Requested', 'Review request sent to supervisors', 'info');
}

// Initialize Enterprise Max features
setTimeout(() => {
  loadSavedTheme();
  initPWA();
  initializeCharts();
  console.log('ðŸŽ¯ ENTERPRISE MAX Edition Loaded!');
  console.log('   â€¢ Data Visualization');
  console.log('   â€¢ Predictive Analytics');
  console.log('   â€¢ Custom Report Builder');
  console.log('   â€¢ Multi-Theme System');
  console.log('   â€¢ PWA Installation');
  console.log('   â€¢ Collaboration Hub');
}, 1500);

// ==================== ULTRA EDITION FEATURES ====================

// Template Management System
let templates = [];

function loadTemplatesFromStorage() {
  try {
    const stored = localStorage.getItem('wwtp_templates');
    if (stored) {
      templates = JSON.parse(stored);
    }
  } catch(e) {
    console.log('Could not load templates');
  }
}

function saveTemplatesToStorage() {
  try {
    localStorage.setItem('wwtp_templates', JSON.stringify(templates));
  } catch(e) {
    console.log('Could not save templates');
  }
}

function saveAsTemplate() {
  const templateName = prompt('Enter template name:');
  if (!templateName) return;
  
  const templateData = {
    id: Date.now().toString(),
    name: templateName,
    created: new Date().toISOString(),
    data: {}
  };
  
  // Collect all input values
  $$('#process-calcs input[type="number"]').forEach(input => {
    if (input.id && input.value) {
      templateData.data[input.id] = input.value;
    }
  });
  
  templates.push(templateData);
  saveTemplatesToStorage();
  showNotification('Template Saved', `"${templateName}" has been saved`, 'success');
}

function loadTemplate(templateId) {
  const template = templates.find(t => t.id === templateId);
  if (!template) return;
  
  Object.entries(template.data).forEach(([inputId, value]) => {
    const input = $(inputId);
    if (input) {
      input.value = value;
    }
  });
  
  showNotification('Template Loaded', `"${template.name}" has been applied`, 'success');
  calculateAllProcess();
}

function deleteTemplate(templateId) {
  if (!confirm('Delete this template?')) return;
  
  templates = templates.filter(t => t.id !== templateId);
  saveTemplatesToStorage();
  showNotification('Template Deleted', 'Template has been removed', 'info');
}

function showTemplateManager() {
  let html = `
    <div style="max-height:500px;overflow-y:auto">
      <div style="margin-bottom:20px">
        <button class="btn green" onclick="saveAsTemplate()" style="width:100%">ðŸ’¾ Save Current as Template</button>
      </div>
      <div class="template-grid" id="template-grid">
  `;
  
  if (templates.length === 0) {
    html += '<p style="text-align:center;color:var(--text-unit);padding:40px">No templates saved yet. Save your current inputs as a template to reuse them later.</p>';
  } else {
    templates.forEach(template => {
      const date = new Date(template.created).toLocaleDateString();
      const numInputs = Object.keys(template.data).length;
      html += `
        <div class="template-card">
          <div class="template-name">${template.name}</div>
          <div class="template-info">ðŸ“… ${date}</div>
          <div class="template-info">ðŸ“Š ${numInputs} inputs</div>
          <div class="template-actions">
            <button class="template-btn load" onclick="loadTemplate('${template.id}');closeModal()">Load</button>
            <button class="template-btn delete" onclick="deleteTemplate('${template.id}');showTemplateManager()">Delete</button>
          </div>
        </div>
      `;
    });
  }
  
  html += '</div></div>';
  
  showModal('ðŸ“‘ Template Manager', html);
}

// Batch Processing System
function initBatchProcessing() {
  const html = `
    <div class="batch-upload-zone" id="batch-upload-zone" onclick="$('batch-file-input').click()">
      <div class="batch-icon">ðŸ“Š</div>
      <div class="batch-text">Upload CSV File for Batch Processing</div>
      <div class="batch-subtext">Drag & drop or click to select â€¢ Supports .csv files</div>
      <input type="file" id="batch-file-input" accept=".csv" style="display:none" onchange="processBatchFile(this.files[0])">
    </div>
    <div class="batch-results" id="batch-results" style="display:none"></div>
  `;
  
  showModal('ðŸ”„ Batch Processing', html);
  
  // Add drag & drop handlers
  const zone = $('batch-upload-zone');
  if (zone) {
    zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('dragover'); };
    zone.ondragleave = () => { zone.classList.remove('dragover'); };
    zone.ondrop = (e) => {
      e.preventDefault();
      zone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        processBatchFile(e.dataTransfer.files[0]);
      }
    };
  }
}

function processBatchFile(file) {
  if (!file || !file.name.endsWith('.csv')) {
    showNotification('Invalid File', 'Please upload a CSV file', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const csv = e.target.result;
    const lines = csv.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    
    const results = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const values = lines[i].split(',');
      const row = {};
      headers.forEach((header, index) => {
        row[header] = values[index];
      });
      results.push(row);
    }
    
    showBatchResults(results, headers);
  };
  reader.readAsText(file);
}

function showBatchResults(data, headers) {
  const resultsDiv = $('batch-results');
  if (!resultsDiv) return;
  
  let html = `
    <h3>Batch Processing Results</h3>
    <p>Processed ${data.length} rows</p>
    <div class="batch-progress">
      <div class="batch-progress-bar">
        <div class="batch-progress-fill" style="width:100%">Complete</div>
      </div>
    </div>
    <table class="enhanced-table">
      <thead><tr>
  `;
  
  headers.forEach(h => html += `<th>${h}</th>`);
  html += '</tr></thead><tbody>';
  
  data.forEach(row => {
    html += '<tr>';
    headers.forEach(h => html += `<td>${row[h] || '-'}</td>`);
    html += '</tr>';
  });
  
  html += `</tbody></table>
    <br>
    <button class="btn green" onclick="exportBatchResults()">ðŸ“¥ Export Results</button>
  `;
  
  resultsDiv.innerHTML = html;
  resultsDiv.style.display = 'block';
}

// Comparison Mode
let comparisonMode = {
  active: false,
  before: {},
  after: {}
};

function toggleComparisonMode() {
  comparisonMode.active = !comparisonMode.active;
  
  if (comparisonMode.active) {
    showModal('ðŸ”„ Comparison Mode', `
      <div class="comparison-panel">
        <div class="comparison-side active">
          <div class="comparison-header">ðŸ“Š Scenario A (Current)</div>
          <p>Make changes to inputs and run calculations</p>
          <button class="btn green" onclick="captureScenarioA()">Capture Scenario A</button>
          <div id="scenario-a-results"></div>
        </div>
        <div class="comparison-side">
          <div class="comparison-header">ðŸ“Š Scenario B (Alternative)</div>
          <p>Modify inputs for comparison</p>
          <button class="btn blue" onclick="captureScenarioB()">Capture Scenario B</button>
          <div id="scenario-b-results"></div>
        </div>
      </div>
      <div style="margin-top:20px;text-align:center">
        <button class="btn purple" onclick="compareScenarios()">âš–ï¸ Compare Scenarios</button>
      </div>
    `);
  } else {
    closeModal();
  }
}

function captureScenarioA() {
  comparisonMode.before = captureCurrentState();
  showNotification('Scenario A Captured', 'Current state saved for comparison', 'success');
}

function captureScenarioB() {
  comparisonMode.after = captureCurrentState();
  showNotification('Scenario B Captured', 'Alternative state saved for comparison', 'success');
}

function captureCurrentState() {
  const state = {};
  $$('#process-calcs .result').forEach(el => {
    if (el.id && el.textContent !== '-') {
      state[el.id] = el.textContent;
    }
  });
  return state;
}

function compareScenarios() {
  if (Object.keys(comparisonMode.before).length === 0 || Object.keys(comparisonMode.after).length === 0) {
    showNotification('Incomplete Data', 'Please capture both scenarios first', 'warning');
    return;
  }
  
  let html = '<h3>ðŸ“Š Scenario Comparison Results</h3><table class="enhanced-table"><thead><tr><th>Parameter</th><th>Scenario A</th><th>Scenario B</th><th>Change</th></tr></thead><tbody>';
  
  Object.keys(comparisonMode.before).forEach(key => {
    const before = parseFloat(comparisonMode.before[key]) || 0;
    const after = parseFloat(comparisonMode.after[key]) || 0;
    const diff = after - before;
    const diffPercent = before !== 0 ? ((diff / before) * 100).toFixed(1) : 0;
    const diffClass = diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral';
    
    html += `
      <tr>
        <td>${key.replace('r_', '').replace(/_/g, ' ')}</td>
        <td>${comparisonMode.before[key]}</td>
        <td>${comparisonMode.after[key]}</td>
        <td><span class="comparison-diff ${diffClass}">${diff > 0 ? '+' : ''}${diffPercent}%</span></td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  
  showModal('ðŸ“Š Comparison Results', html);
}

// Benchmarking System
function showBenchmarking() {
  const benchmarks = {
    'F/M Ratio': { value: 0.35, industry: 0.3, unit: '', target: '0.2-0.5' },
    'SVI': { value: 125, industry: 120, unit: 'mL/g', target: '<150' },
    'Energy': { value: 1800, industry: 1500, unit: 'kWh/MG', target: '<1600' },
    'DO': { value: 2.2, industry: 2.0, unit: 'mg/L', target: '1.5-2.5' },
    'MLSS': { value: 2800, industry: 2500, unit: 'mg/L', target: '2000-4000' },
    'SRT': { value: 8, industry: 10, unit: 'days', target: '5-15' }
  };
  
  let html = '<div class="benchmark-grid">';
  
  Object.entries(benchmarks).forEach(([name, data]) => {
    const percentage = (data.value / data.industry) * 100;
    const status = percentage < 90 ? 'Excellent' : percentage < 110 ? 'Good' : 'Needs Improvement';
    const barWidth = Math.min(percentage, 150);
    
    html += `
      <div class="benchmark-card">
        <div class="benchmark-metric">${name}</div>
        <div class="benchmark-value">${data.value}${data.unit}</div>
        <div class="benchmark-comparison">
          <div class="benchmark-bar">
            <div class="benchmark-bar-fill" style="width:${barWidth}%"></div>
          </div>
        </div>
        <div class="benchmark-label">Industry Average: ${data.industry}${data.unit} â€¢ Target: ${data.target}</div>
        <div style="margin-top:10px;font-weight:600;color:${percentage < 90 ? 'var(--ok)' : percentage < 110 ? 'var(--info)' : 'var(--warn)'}">
          ${status}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  showModal('ðŸ“Š Benchmarking Dashboard', html);
}

// Advanced Search System
function initAdvancedSearch() {
  const html = `
    <div class="search-panel">
      <div style="position:relative">
        <span style="position:absolute;left:15px;top:12px;font-size:20px">ðŸ”</span>
        <input type="text" class="search-input" id="advanced-search-input" placeholder="Search calculators, parameters, or results..." oninput="performAdvancedSearch()">
      </div>
      <div class="search-filters" id="search-filters">
        <button class="search-filter-btn active" data-filter="all">All</button>
        <button class="search-filter-btn" data-filter="loading">Loading</button>
        <button class="search-filter-btn" data-filter="hydraulic">Hydraulic</button>
        <button class="search-filter-btn" data-filter="biological">Biological</button>
        <button class="search-filter-btn" data-filter="chemical">Chemical</button>
        <button class="search-filter-btn" data-filter="critical">Critical Only</button>
      </div>
      <div class="search-results" id="search-results"></div>
    </div>
  `;
  
  showModal('ðŸ” Advanced Search', html);
  
  // Add filter button handlers
  $$('.search-filter-btn').forEach(btn => {
    btn.onclick = function() {
      $$('.search-filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      performAdvancedSearch();
    };
  });
}

function performAdvancedSearch() {
  const searchTerm = $('advanced-search-input')?.value.toLowerCase() || '';
  const activeFilter = $('.search-filter-btn.active')?.dataset.filter || 'all';
  
  // Search logic here
  const resultsDiv = $('search-results');
  if (resultsDiv && searchTerm.length > 2) {
    resultsDiv.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-unit)">Search results will appear here...</p>';
  }
}

// Keyboard Shortcuts
const shortcuts = {
  'Ctrl+A': 'Calculate All',
  'Ctrl+S': 'Save Template',
  'Ctrl+E': 'Export Report',
  'Ctrl+P': 'Print',
  'Ctrl+H': 'Show History',
  'Ctrl+B': 'Benchmarking',
  'Ctrl+T': 'Template Manager',
  'Ctrl+F': 'Search',
  'Ctrl+M': 'Comparison Mode',
  'Esc': 'Close Modal'
};

function showKeyboardShortcuts() {
  let html = '<div class="shortcuts-panel"><h3 style="margin-bottom:15px">âŒ¨ï¸ Keyboard Shortcuts</h3>';
  
  Object.entries(shortcuts).forEach(([key, action]) => {
    const keys = key.split('+');
    html += `
      <div class="shortcut-row">
        <div class="shortcut-keys">
          ${keys.map(k => `<span class="shortcut-key">${k}</span>`).join('+')}
        </div>
        <div class="shortcut-desc">${action}</div>
      </div>
    `;
  });
  
  html += '</div>';
  showModal('âŒ¨ï¸ Keyboard Shortcuts', html);
}

// Setup keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key.toLowerCase()) {
      case 'a':
        e.preventDefault();
        calculateAllProcess();
        break;
      case 's':
        e.preventDefault();
        saveAsTemplate();
        break;
      case 'e':
        e.preventDefault();
        exportProcessReport();
        break;
      case 'p':
        e.preventDefault();
        printProcessCalcs();
        break;
      case 'h':
        e.preventDefault();
        showCalculationHistory();
        break;
      case 'b':
        e.preventDefault();
        showBenchmarking();
        break;
      case 't':
        e.preventDefault();
        showTemplateManager();
        break;
      case 'f':
        e.preventDefault();
        initAdvancedSearch();
        break;
      case 'm':
        e.preventDefault();
        toggleComparisonMode();
        break;
    }
  } else if (e.key === 'Escape') {
    closeModal();
  }
});

// Modal System
function showModal(title, content) {
  // Remove existing modal if any
  const existing = document.querySelector('.modal-overlay');
  if (existing) existing.remove();
  
  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">${title}</div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">${content}</div>
    </div>
  `;
  
  modal.onclick = closeModal;
  document.body.appendChild(modal);
}

function closeModal() {
  const modal = document.querySelector('.modal-overlay');
  if (modal) modal.remove();
}

// Enhanced Notification System
function showNotification(title, message, type = 'info') {
  const icons = {
    success: 'âœ…',
    warning: 'âš ï¸',
    error: 'âŒ',
    info: 'â„¹ï¸'
  };
  
  const container = $('.notification-container') || createNotificationContainer();
  
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <div class="notification-icon">${icons[type]}</div>
    <div class="notification-content">
      <div class="notification-title">${title}</div>
      <div class="notification-message">${message}</div>
    </div>
    <div class="notification-close" onclick="this.parentElement.remove()">Ã—</div>
  `;
  
  container.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => notification.remove(), 5000);
}

function createNotificationContainer() {
  const container = document.createElement('div');
  container.className = 'notification-container';
  document.body.appendChild(container);
  return container;
}

// Advanced Export Options
function showExportOptions() {
  const html = `
    <div class="export-options">
      <div class="export-option" onclick="exportToCSV()">
        <div class="export-option-icon">ðŸ“Š</div>
        <div class="export-option-title">CSV Export</div>
        <div class="export-option-desc">Spreadsheet format</div>
      </div>
      <div class="export-option" onclick="exportToJSON()">
        <div class="export-option-icon">ðŸ“‹</div>
        <div class="export-option-title">JSON Export</div>
        <div class="export-option-desc">Data format</div>
      </div>
      <div class="export-option" onclick="exportProcessReport()">
        <div class="export-option-icon">ðŸ“„</div>
        <div class="export-option-title">PDF Report</div>
        <div class="export-option-desc">Professional report</div>
      </div>
      <div class="export-option" onclick="exportToExcel()">
        <div class="export-option-icon">ðŸ“—</div>
        <div class="export-option-title">Excel Export</div>
        <div class="export-option-desc">XLSX format</div>
      </div>
    </div>
  `;
  
  showModal('ðŸ“¥ Export Options', html);
}

function exportToCSV() {
  let csv = 'Parameter,Value,Unit,Status\n';
  
  $$('#process-calcs .result').forEach(el => {
    if (el.textContent !== '-') {
      const row = el.closest('tr');
      if (row) {
        const param = row.querySelector('.rowh')?.textContent || '';
        const value = el.textContent;
        const unit = row.querySelectorAll('td')[2]?.textContent || '';
        const status = row.querySelector('.status')?.textContent || '';
        csv += `"${param}","${value}","${unit}","${status}"\n`;
      }
    }
  });
  
  downloadFile(csv, 'wwtp_results.csv', 'text/csv');
  showNotification('CSV Exported', 'File downloaded successfully', 'success');
}

function exportToJSON() {
  const data = {
    plantName: $('plantName')?.value || 'WWTP',
    timestamp: new Date().toISOString(),
    results: {}
  };
  
  $$('#process-calcs .result').forEach(el => {
    if (el.id && el.textContent !== '-') {
      data.results[el.id] = el.textContent;
    }
  });
  
  downloadFile(JSON.stringify(data, null, 2), 'wwtp_results.json', 'application/json');
  showNotification('JSON Exported', 'File downloaded successfully', 'success');
}

function exportToExcel() {
  showNotification('Excel Export', 'Excel format coming soon! Use CSV for now.', 'info');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// Initialize ULTRA features
setTimeout(() => {
  loadTemplatesFromStorage();
  createNotificationContainer();
  console.log('ðŸŽ¯ ULTRA Edition Features Loaded!');
  console.log('   â€¢ Template Management');
  console.log('   â€¢ Batch Processing');
  console.log('   â€¢ Comparison Mode');
  console.log('   â€¢ Benchmarking');
  console.log('   â€¢ Advanced Search');
  console.log('   â€¢ Keyboard Shortcuts');
  console.log('   â€¢ Enhanced Exports');
}, 1000);

console.log('ðŸš€ Process Calculations Enhancements Loaded!');
console.log('ðŸ“Š Features: Quick Actions, Summary Cards, Export, History, Auto-save');

</script>

<script>
// PWA Installation and Service Worker Registration
let deferredPrompt;
let pwaInstallButton;

// Register Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/wwtp-app/service-worker.js')
      .then((registration) => {
        console.log('ðŸ‘‘ APEX PWA: Service Worker registered!', registration.scope);
        
        // Check for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('ðŸ”„ APEX PWA: Update found!');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New service worker installed, show update notification
              showUpdateNotification();
            }
          });
        });
      })
      .catch((error) => {
        console.error('âŒ APEX PWA: Service Worker registration failed:', error);
      });
  });
}

// Listen for beforeinstallprompt event
window.addEventListener('beforeinstallprompt', (e) => {
  console.log('ðŸ“± APEX PWA: Install prompt available');
  
  // Prevent the mini-infobar from appearing
  
  // Save the event for later use
  deferredPrompt = e;
  
  // Show custom install button
  // showInstallPrompt(); // DISABLED - Use browser native install
});

// Listen for app installed event
window.addEventListener('appinstalled', () => {
  console.log('âœ… APEX PWA: App installed successfully!');
  deferredPrompt = null;
  hideInstallPrompt();
  
  // Show success message
  console.log('ðŸŽ‰ APEX WWTP installed successfully!');
});

// Function to show install prompt
function showInstallPrompt() {
  // Create install button if it doesn't exist
  if (!pwaInstallButton) {
    pwaInstallButton = document.createElement('button');
    pwaInstallButton.innerHTML = 'ðŸ“± Install APEX App';
    pwaInstallButton.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 999999;
      animation: pulse 2s infinite;
    `;
    
    pwaInstallButton.addEventListener('click', installPWA);
    document.body.appendChild(pwaInstallButton);
    
    // Add animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes pulse {
        0%, 100% { transform: translateX(-50%) scale(1); }
        50% { transform: translateX(-50%) scale(1.05); }
      }
    `;
    document.head.appendChild(style);
  }
}

// Function to hide install prompt
function hideInstallPrompt() {
  if (pwaInstallButton) {
    pwaInstallButton.remove();
    pwaInstallButton = null;
  }
}

// Function to install PWA
async function installPWA() {
  if (!deferredPrompt) {
    console.log('âŒ APEX PWA: Install prompt not available');
    return;
  }
  
  // Show the install prompt
  deferredPrompt.prompt();
  
  // Wait for the user's response
  const { outcome } = await deferredPrompt.userChoice;
  console.log(`ðŸ“± APEX PWA: User response: ${outcome}`);
  
  // Clear the deferred prompt
  deferredPrompt = null;
  
  // Hide the install button
  hideInstallPrompt();
}

// Function to show update notification
function showUpdateNotification() {
  const updateBanner = document.createElement('div');
  updateBanner.innerHTML = `
    <div style="position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#667eea;color:white;padding:15px 30px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:999999;text-align:center">
      <div style="font-weight:bold;margin-bottom:10px">ðŸ”„ Update Available!</div>
      <div style="font-size:14px;margin-bottom:10px">A new version of APEX is ready.</div>
      <button onclick="window.location.reload()" style="background:white;color:#667eea;border:none;padding:8px 20px;border-radius:5px;font-weight:bold;cursor:pointer">
        Update Now
      </button>
      <button onclick="this.parentElement.parentElement.remove()" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:8px 20px;border-radius:5px;margin-left:10px;cursor:pointer">
        Later
      </button>
    </div>
  `;
  document.body.appendChild(updateBanner);
}

// Check if running as PWA
function isPWA() {
  return window.matchMedia('(display-mode: standalone)').matches || 
         window.navigator.standalone || 
         document.referrer.includes('android-app://');
}

// Show PWA status
if (isPWA()) {
  console.log('âœ… APEX PWA: Running as installed app!');
} else {
  console.log('ðŸŒ APEX PWA: Running in browser');
}

// Handle offline/online status
window.addEventListener('online', () => {
  console.log('ðŸŒ APEX PWA: Back online!');
  const banner = document.createElement('div');
  banner.textContent = 'âœ… Back Online!';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 3000);
});

window.addEventListener('offline', () => {
  console.log('ðŸ“µ APEX PWA: Offline mode');
  const banner = document.createElement('div');
  banner.textContent = 'ðŸ“µ Offline Mode - Limited Functionality';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff9800;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
});

console.log('ðŸ‘‘ APEX PWA: Installation script loaded');

</script>

<div class="notification-container"></div><div id="realtime-badge" class="realtime-badge online">ðŸŸ¢ Online</div><div id="alert-panel" class="alert-panel"></div><div class="ai-copilot" id="ai-copilot">
    <div class="ai-header">
      <div style="display:flex;align-items:center;gap:15px">
        <div class="ai-avatar">ðŸ¤–</div>
        <div>
          <div style="font-weight:700;font-size:16px">WWTP AI Copilot</div>
          <div style="font-size:12px;opacity:0.8">Powered by Advanced ML</div>
        </div>
      </div>
      <button onclick="toggleAICopilot()" style="background:none;border:none;color:white;font-size:24px;cursor:pointer">Ã—</button>
    </div>
    <div class="ai-chat" id="ai-chat">
      <div class="ai-message bot">
        ðŸ‘‹ Hello! I'm your AI Copilot. I can help you with:
        <br>â€¢ Process optimization
        <br>â€¢ Troubleshooting issues
        <br>â€¢ Predicting trends
        <br>â€¢ Regulatory compliance
        <br>â€¢ Best practices
        <br><br>What would you like to know?
      </div>
    </div>
    <div class="ai-input-area">
      <input type="text" class="ai-input" id="ai-input" placeholder="Ask me anything about WWTP operations..." onkeypress="if(event.key===&#39;Enter&#39;)sendAIMessage()">
      <button class="ai-send-btn" onclick="sendAIMessage()">Send ðŸš€</button>
    </div>
  </div><div class="voice-control" id="voice-control">ðŸŽ¤</div><div class="voice-feedback" id="voice-feedback"></div></body></html>  </div>
</div>

<!-- PWA SERVICE WORKER REGISTRATION -->
<script>
// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/wwtp-app/service-worker.js')
      .then(registration => {
        console.log('âœ… PWA: Service Worker registered successfully');
        console.log('âœ… PWA: Offline mode enabled');
        
        // Check for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('ðŸ”„ PWA: New version available');
              if (confirm('New version available! Reload to update?')) {
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(error => {
        console.log('âš ï¸ PWA: Service Worker registration failed (app still works):', error);
      });
  });
}

// PWA Install - Use browser's native install in address bar (no popup button)
window.addEventListener('beforeinstallprompt', (e) => {
  // Don't prevent default - let browser show its native install UI
  console.log('ðŸ“± PWA installable - use browser install button in address bar');
});

// PWA installed event
window.addEventListener('appinstalled', () => {
  console.log('âœ… APEX WWTP PWA installed successfully!');
});

// Online/Offline status
window.addEventListener('online', () => {
  console.log('ðŸŒ Back online');
  const banner = document.createElement('div');
  banner.textContent = 'âœ… Back Online!';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 3000);
});

window.addEventListener('offline', () => {
  console.log('ðŸ“µ Offline mode - Limited functionality');
  const banner = document.createElement('div');
  banner.textContent = 'ðŸ“µ Offline Mode - All calculators still work!';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff9800;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
});

console.log('ðŸ‘‘ APEX WWTP - COMPLETE PWA EDITION LOADED');
console.log('âœ… All original features preserved');
console.log('âœ… PWA functionality added');
console.log('âœ… Ready for installation');
</script>

</body>
</html>
