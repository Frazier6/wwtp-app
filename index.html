<!DOCTYPE html>
<!-- WWTP Command Center v9.9.27 - GENIUS/EXPERT/EXECUTIVE Enhancement: Advanced Analytics Dashboard, Predictive ML Engine, Executive KPI Suite, Real-Time Process Optimization, Intelligent Benchmarking, Scenario Planning, Compliance AI, Energy Optimization Matrix, Advanced Calculator Suite II, Interactive Troubleshooting Wizard, Safety Module, Video Training Library -->
<html lang="en" class="dark"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="referrer" content="strict-origin-when-cross-origin">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<title>WWTP Command Center v9.9.27</title>

<!-- DISABLE PULL TO REFRESH -->
<style>
html, body {
  overscroll-behavior-y: contain !important;
  overscroll-behavior: contain !important;
}
</style>

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#023e8a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WWTP Command">
<meta name="description" content="Professional wastewater treatment plant analysis platform - Works Offline">
<meta name="application-name" content="WWTP Command Center">

<!-- Inline PWA Manifest -->
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIldXVFAgQ29tbWFuZCBDZW50ZXIiLAogICJzaG9ydF9uYW1lIjogIldXVFAiLAogICJkZXNjcmlwdGlvbiI6ICJQcm9mZXNzaW9uYWwgd2FzdGV3YXRlciB0cmVhdG1lbnQgcGxhbnQgYW5hbHlzaXMgcGxhdGZvcm0iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAyM2U4YSIsCiAgInRoZW1lX2NvbG9yIjogIiMwMjNlOGEiLAogICJvcmllbnRhdGlvbiI6ICJhbnkiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDcmVjdCBmaWxsPSclMjMwMjNlOGEnIHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyByeD0nMjAnLyUzRSUzQ3RleHQgeD0nNTAnIHk9JzY1JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSclM0Xwn4ytJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0KfQ==">

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23023e8a' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üè≠</text></svg>">

<!-- External Resources (cached by service worker) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* MASTER PANEL CONTROL - TABLET FIX v9.9.19 */
.panel { 
  display: none !important; 
  visibility: hidden !important;
  height: 0 !important;
  overflow: hidden !important;
  opacity: 0 !important;
  position: absolute !important;
  left: -99999px !important;
}
.panel.active { 
  display: block !important; 
  visibility: visible !important;
  height: auto !important;
  overflow: visible !important;
  opacity: 1 !important;
  position: static !important;
  left: auto !important;
}

/* DISABLE PULL-TO-REFRESH AND SWIPE GESTURES */
html {
  overscroll-behavior: none;
  overscroll-behavior-y: none;
}
body {
  overscroll-behavior: none;
  overscroll-behavior-y: contain;
}
.content {
  touch-action: pan-y pinch-zoom;
  overscroll-behavior: contain;
}
.tabs {
  touch-action: pan-x;
  overscroll-behavior-x: contain;
}

/* PWA Offline/Online Indicator */
.pwa-status { position: fixed; bottom: 20px; left: 20px; padding: 10px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; z-index: 99999; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.3s; }
.pwa-status.online { background: linear-gradient(135deg, #10b981, #059669); color: white; }
.pwa-status.offline { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; animation: pulse-offline 2s infinite; }
.pwa-status .status-dot { width: 10px; height: 10px; border-radius: 50%; background: currentColor; }
.pwa-status.online .status-dot { animation: pulse-online 2s infinite; }
@keyframes pulse-online { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes pulse-offline { 0%, 100% { background: #ef4444; } 50% { background: #b91c1c; } }

/* PWA Install Button - Top Right */
/* PWA Install Button - REMOVED v9.6.0 */

/* Install Modal */
.install-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100001; padding:20px; align-items:center; justify-content:center; }
.install-modal.show { display:flex; }
.install-modal-content { background:var(--bg-container); border-radius:16px; max-width:400px; width:100%; padding:24px; text-align:center; }
.install-modal h3 { margin:0 0 16px 0; font-size:22px; }
.install-modal .install-steps { text-align:left; margin:20px 0; padding:16px; background:var(--bg-section); border-radius:8px; }
.install-modal .install-steps li { margin:10px 0; line-height:1.5; }
.install-modal .close-btn { margin-top:16px; padding:12px 24px; background:var(--bg-tabs); border:none; border-radius:8px; cursor:pointer; font-weight:600; color:var(--text-primary); }

/* Offline Data Sync Indicator */
.sync-pending { position: relative; }
.sync-pending::after { content: '‚è≥'; position: absolute; top: -5px; right: -5px; font-size: 12px; }

/* PWA Update Available Banner */
.pwa-update-banner { position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px 20px; text-align: center; z-index: 100000; display: none; align-items: center; justify-content: center; gap: 15px; }
.pwa-update-banner.show { display: flex; }
.pwa-update-banner button { background: white; color: #d97706; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; }

/* Unit Toggle Styles */
.unit-toggle { background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important; color: white !important; font-weight: bold !important; min-width: 75px; }
.unit-toggle.metric { background: linear-gradient(135deg, #10b981, #059669) !important; }
[data-unit-imperial] { display: inline; }
[data-unit-metric] { display: none; }
.metric-mode [data-unit-imperial] { display: none; }
.metric-mode [data-unit-metric] { display: inline; }

/* Quick Reference Modal Styles */
.qref-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100000; overflow-y:auto; padding:20px; }
.qref-modal.active { display:flex; align-items:flex-start; justify-content:center; }
.qref-content { background:var(--bg-container); border-radius:16px; max-width:900px; width:100%; margin:20px auto; box-shadow:0 25px 50px rgba(0,0,0,0.5); max-height:90vh; overflow:hidden; display:flex; flex-direction:column; }
.qref-header { background:linear-gradient(135deg,#7c3aed,#9333ea); color:white; padding:20px 24px; display:flex; justify-content:space-between; align-items:center; }
.qref-header h2 { margin:0; font-size:18px; }
.qref-close { background:rgba(255,255,255,0.2); border:none; color:white; font-size:18px; width:40px; height:40px; border-radius:50%; cursor:pointer; }
.qref-close:hover { background:rgba(255,255,255,0.3); }
.qref-search { padding:16px 24px; border-bottom:1px solid var(--border); }
.qref-search input { width:100%; padding:12px 16px; border:2px solid var(--border); border-radius:8px; font-size:16px; background:var(--bg-section); color:var(--text-primary); }
.qref-tabs { display:flex; gap:4px; padding:12px 24px; border-bottom:1px solid var(--border); flex-wrap:wrap; }
.qref-tab { padding:8px 16px; border:none; background:var(--bg-section); color:var(--text-primary); border-radius:8px; cursor:pointer; font-weight:500; }
.qref-tab:hover { background:var(--bg-tabs); }
.qref-tab.active { background:linear-gradient(135deg,#7c3aed,#9333ea); color:white; }
.qref-body { padding:24px; overflow-y:auto; flex:1; }
.qref-section { margin-bottom:24px; }
.qref-section h3 { color:var(--text-accent); margin:0 0 12px 0; font-size:18px; border-bottom:2px solid var(--border); padding-bottom:8px; }
.qref-table { width:100%; border-collapse:collapse; font-size:14px; }
.qref-table th { background:var(--bg-section-header); padding:10px 12px; text-align:left; font-weight:600; }
.qref-table td { padding:10px 12px; border-bottom:1px solid var(--border); }
.qref-table tr:hover { background:var(--bg-note); }
.qref-range { display:inline-block; padding:2px 8px; border-radius:4px; font-weight:600; font-size:12px; }
.qref-range.optimal { background:#d1fae5; color:#065f46; }
.qref-range.warning { background:#fef3c7; color:#92400e; }
.qref-range.critical { background:#fee2e2; color:#991b1b; }
.qref-trouble { background:var(--bg-section); border-radius:8px; padding:16px; margin-bottom:12px; }
.qref-trouble h4 { margin:0 0 8px 0; color:var(--text-section); }
.qref-trouble ul { margin:8px 0 0 20px; padding:0; }
.qref-trouble li { margin:4px 0; color:var(--text-primary); }
.qref-hidden { display:none !important; }

:root{
--bg-body:linear-gradient(135deg,#0077b6 0%,#00b4d8 100%);
--bg-container:#fff;
--bg-header:linear-gradient(135deg,#0077b6 0%,#023e8a 100%);
--bg-tabs:#f0f9ff;
--bg-tab-active:#fff;
--bg-section:#fff;
--bg-section-header:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);
--bg-table-th:#f0f9ff;
--bg-col-header:#bae6fd;
--bg-row-header:#f0f9ff;
--bg-input:#fff;
--bg-result:#bae6fd;
--bg-note:#e0f2fe;
--bg-card:#ffffff;
--text:#0c1929;
--text-header:#fff;
--text-accent:#0077b6;
--text-unit:#64748b;
--text-section:#1e3a5f;
--border:#e0f2fe;
--border-input:#bae6fd;
--border-focus:#0077b6;
--border-note:#00b4d8;
--ok:#06d6a0;
--warn:#ffd166;
--bad:#ef476f;
--info:#00b4d8;
--purple:#5856d6;
--indigo:#0077b6;
--pink:#ef476f;
--teal:#06d6a0;
--cyan:#00b4d8;
--orange:#ffd166;
--gradient-1:linear-gradient(135deg,#0077b6 0%,#00b4d8 100%);
--gradient-2:linear-gradient(135deg,#00b4d8 0%,#48cae4 100%);
--gradient-3:linear-gradient(135deg,#023e8a 0%,#0077b6 100%);
--shadow-sm:0 2px 4px rgba(0,119,182,.08);
--shadow-md:0 4px 12px rgba(0,119,182,.12);
--shadow-lg:0 8px 24px rgba(0,119,182,.16);
--shadow-xl:0 20px 40px rgba(0,119,182,.20);
--font-xs:11px;
--font-sm:13px;
--font-base:15px;
--font-md:17px;
--font-lg:21px;
--font-xl:28px;
--font-2xl:34px;
--leading-tight:1.25;
--leading-normal:1.5;
--leading-relaxed:1.75;
--tracking-tight:-0.02em;
--tracking-normal:0;
--tracking-wide:0.02em;
}
html.dark{
--bg-body:linear-gradient(135deg,#0c1929 0%,#1a2744 100%);
--bg-container:#1a2744;
--bg-header:linear-gradient(135deg,#0077b6 0%,#023e8a 100%);
--bg-tabs:#0c1929;
--bg-tab-active:#1a2744;
--bg-section:#243b55;
--bg-section-header:linear-gradient(135deg,#1a2744 0%,#0c1929 100%);
--bg-table-th:#0c1929;
--bg-col-header:#0077b6;
--bg-row-header:#1a2744;
--bg-input:#1a2744;
--bg-result:#0077b6;
--bg-note:#023e8a;
--bg-card:#243b55;
--text:#e0e7ef;
--text-header:#f8fafc;
--text-accent:#48cae4;
--text-unit:#90cdf4;
--text-section:#90cdf4;
--border:#1e3a5f;
--border-input:#0077b6;
--border-focus:#00b4d8;
--border-note:#48cae4;
--ok:#06d6a0;
--warn:#ffd166;
--bad:#ef476f;
--info:#00b4d8;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;min-height:100vh;background:var(--bg-body);color:var(--text);padding:10px;overflow-x:hidden;font-size:15px;line-height:1.5;letter-spacing:-0.01em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.wrap{max-width:1920px;margin:0 auto;background:var(--bg-container);border-radius:18px;box-shadow:var(--shadow-xl);animation:fadeIn .5s ease;overflow:visible}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.1)}}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideInUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes glow{0%,100%{box-shadow:0 0 5px var(--text-accent)}50%{box-shadow:0 0 20px var(--text-accent)}}
@keyframes typing{from{width:0}to{width:100%}}
@keyframes blink{50%{border-color:transparent}}
.header{background:var(--bg-header);color:var(--text-header);padding:24px 32px;position:relative}

/* CRITICAL: Sticky header - works on ALL devices */
.sticky-header{
  position:sticky !important;
  position:-webkit-sticky !important;
  top:0 !important;
  z-index:9999 !important;
  background:linear-gradient(135deg,#0a1628 0%,#1a365d 50%,#0d2137 100%) !important;
  box-shadow:0 4px 20px rgba(0,0,0,0.5) !important;
}

.header h1{font-size:var(--font-xl);font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;letter-spacing:var(--tracking-tight);line-height:var(--leading-tight)}
.live-indicator{width:12px;height:12px;background:#4ADE80;border-radius:50%;animation:pulse 2s infinite;box-shadow:0 0 12px #4ADE80}
.badge{display:inline-block;padding:5px 14px;border-radius:6px;font-size:var(--font-xs);font-weight:600;text-transform:uppercase;margin-left:8px;letter-spacing:var(--tracking-wide)}
.badge.pro{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;box-shadow:0 4px 12px rgba(240,147,251,.4)}
.badge.new{background:#e83e8c;color:#fff}
.badge.beta{background:#17a2b8;color:#fff}
.badge.ai{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;animation:glow 2s infinite}
.muted{opacity:.9;font-size:0.95rem}
.header-controls{position:absolute;right:24px;top:24px;display:flex;gap:12px;flex-wrap:wrap}
.toggle{width:44px;height:44px;border-radius:999px;border:1px solid rgba(255,255,255,.25);display:grid;place-items:center;background:rgba(255,255,255,.09);color:#fff;cursor:pointer;transition:all .3s;font-size:18px}
.toggle:hover{background:rgba(255,255,255,.15);transform:rotate(180deg) scale(1.05)}
.toggle.active{background:var(--ok);animation:glow 2s infinite}
.status-bar{display:flex;gap:24px;margin-top:14px;flex-wrap:wrap}
.status-item{display:flex;align-items:center;gap:8px;font-size:13px;opacity:.9;padding:6px 12px;background:rgba(255,255,255,.1);border-radius:8px}
.status-item .dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-top:14px}
input,select,textarea{width:100%;padding:11px 14px;border-radius:10px;border:2px solid var(--border-input);background:var(--bg-input);color:var(--text);transition:all .3s;font-size:14px;font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 4px rgba(44,90,160,.12);transform:translateY(-2px)}
input:hover,select:hover{border-color:var(--text-accent)}
.input-group{margin:16px 0}
.input-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-section);font-size:14px}
.input-with-icon{position:relative}
.input-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--text-unit);pointer-events:none}
.tabs{display:flex;flex-wrap:wrap;gap:2px;background:var(--bg-tabs);border-bottom:2px solid var(--border);scrollbar-width:thin}
.tab{padding:16px 18px;border:0;background:transparent;color:var(--text-unit);cursor:pointer;white-space:nowrap;font-weight:600;transition:all .2s;font-size:14px;position:relative}
.tab:hover{background:var(--bg-note);transform:translateY(-2px)}
.tab[aria-selected="true"]{background:var(--bg-tab-active);color:var(--text-accent);border-bottom:4px solid var(--text-accent)}
.tab.active{background:var(--bg-tab-active);color:#48cae4;border-bottom:4px solid #48cae4 !important}

.tab[aria-selected="true"]::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:20px;height:3px;background:var(--text-accent);border-radius:2px}
/* Section Navigation Styles v9.9.27 - Premium */
.section-btn{transition:all 0.3s cubic-bezier(0.4,0,0.2,1)}
.section-btn:hover{transform:translateY(-3px) scale(1.02);filter:brightness(1.1)}
.section-btn:active{transform:translateY(-1px) scale(0.99)}
.section-tabs{scrollbar-width:thin;scrollbar-color:#374151 transparent;transition:all 0.3s ease}
.section-tabs::-webkit-scrollbar{height:6px}
.section-tabs::-webkit-scrollbar-track{background:transparent}
.section-tabs::-webkit-scrollbar-thumb{background:#374151;border-radius:3px}
.section-tabs .tab{transition:all 0.2s ease;border-radius:8px;padding:8px 12px;font-size:12px;font-weight:600;color:#9ca3af;background:#0f172a;border:1px solid #1e293b;cursor:pointer;flex-shrink:0}
.section-tabs .tab:hover{background:#1e293b;color:#e2e8f0;border-color:#334155;transform:translateY(-1px)}
.section-tabs .tab.active{background:linear-gradient(135deg,#059669,#10b981);color:white;border-color:#10b981;box-shadow:0 2px 8px rgba(16,185,129,0.4)}
#tabs-executive .tab.active{background:linear-gradient(135deg,#2563eb,#3b82f6);color:white;border-color:#3b82f6;box-shadow:0 2px 8px rgba(59,130,246,0.4)}
#tabs-business .tab.active{background:linear-gradient(135deg,#d97706,#f59e0b);color:white;border-color:#f59e0b;box-shadow:0 2px 8px rgba(245,158,11,0.4)}
#nav-breadcrumb{transition:all 0.3s ease}
.content{padding:24px;position:relative}
/* ULTRA-NUCLEAR PANEL FIX FOR TABLET */
.panel{display:none}
.panel.active{display:block}
.section{background:var(--bg-section);border:1px solid var(--border);border-radius:14px;overflow:visible;margin-bottom:24px;transition:all .3s}
.section:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}
.section-h{background:var(--bg-section-header);padding:16px 20px;font-weight:600;font-size:var(--font-md);color:var(--text-section);display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;letter-spacing:var(--tracking-tight)}
.section-h:hover{background:var(--bg-note)}
.section-content{padding:24px;display:block !important;max-height:none !important;overflow:visible !important}
.section-actions{display:flex;gap:8px}
.icon-btn{background:rgba(44,90,160,.1);border:none;padding:8px 12px;cursor:pointer;color:var(--text-accent);transition:all .2s;border-radius:8px;font-weight:500;font-size:var(--font-sm)}
.icon-btn:hover{background:var(--text-accent);color:#fff;transform:scale(1.05)}
.table{width:100%;border-collapse:collapse;font-size:var(--font-base)}
.table th,.table td{padding:14px;border-bottom:1px solid var(--border);text-align:left}
.table th{background:var(--bg-table-th);position:sticky;top:0;z-index:10;font-weight:600;text-transform:uppercase;font-size:var(--font-xs);letter-spacing:var(--tracking-wide)}
.table tbody tr{transition:all .2s}
.table tbody tr:hover{background:var(--bg-section-header);transform:scale(1.01)}
.col{background:var(--bg-col-header);color:var(--text-accent);font-weight:700}
.rowh{background:var(--bg-row-header);min-width:150px;font-weight:600}
.result{font-weight:700;color:var(--text-accent);background:var(--bg-result);padding:8px 12px;border-radius:8px;font-variant-numeric:tabular-nums;display:inline-block}
.status{font-weight:700;padding:6px 12px;border-radius:8px;font-size:13px;display:inline-block}
.ok{color:var(--ok);background:rgba(40,167,69,.15)}
.warn{color:var(--warn);background:rgba(255,193,7,.15)}
.bad{color:var(--bad);background:rgba(220,53,69,.15)}
.info{color:var(--info);background:rgba(23,162,184,.15)}
.btns{display:flex;flex-wrap:wrap;gap:12px;margin:14px 0}
.btn{padding:13px 22px;border-radius:12px;border:0;cursor:pointer;color:#fff;background:var(--text-accent);font-weight:500;transition:all .2s;font-size:var(--font-base);box-shadow:var(--shadow-sm);position:relative;overflow:hidden;letter-spacing:var(--tracking-wide)}
.btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,.3);transform:translate(-50%,-50%);transition:width .3s,height .3s}
.btn:hover::before{width:300px;height:300px}
.btn:hover{opacity:.95;transform:translateY(-3px);box-shadow:var(--shadow-md)}
.btn:active{transform:translateY(-1px)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.gray{background:#6c757d}
.btn.green{background:var(--ok)}
.btn.red{background:var(--bad)}
.btn.purple{background:var(--purple)}
.btn.orange{background:var(--orange)}
.btn.teal{background:var(--teal)}
.btn.pink{background:var(--pink)}
.btn.indigo{background:var(--indigo)}
.btn.gradient{background:var(--gradient-1)}
.btn.active{box-shadow:0 0 0 3px rgba(74,222,128,0.5);transform:translateY(-2px)}
.note{background:var(--bg-note);border-left:5px solid var(--border-note);padding:16px;border-radius:0 12px 12px 0;color:var(--text);margin-top:12px;font-size:14px;line-height:1.7}
.note.success{background:rgba(40,167,69,.1);border-left-color:var(--ok)}
.note.warning{background:rgba(255,193,7,.1);border-left-color:var(--warn)}
.note.error{background:rgba(220,53,69,.1);border-left-color:var(--bad)}
.chart-container{position:relative;height:360px;width:100%;margin:24px 0;padding:20px;background:var(--bg-card);border-radius:14px;box-shadow:var(--shadow-sm)}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin:24px 0}
.kpi-card{background:var(--bg-card);padding:24px;border-radius:14px;text-align:center;border:2px solid var(--border);transition:all .3s;cursor:pointer;position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:5px;background:var(--gradient-1);transform:scaleX(0);transition:transform .3s;border-radius:14px 14px 0 0}
.kpi-card:hover{transform:translateY(-6px);box-shadow:var(--shadow-lg);border-color:var(--text-accent)}
.kpi-card:hover::before{transform:scaleX(1)}
.kpi-card h4{margin:0 0 12px 0;color:var(--text-section);font-size:13px;text-transform:uppercase;letter-spacing:1px;font-weight:700}
.kpi-card p{margin:0;font-size:2.2em;font-weight:800;color:var(--text-accent);font-variant-numeric:tabular-nums}
.kpi-card .trend{font-size:0.45em;margin-top:8px;font-weight:600}
.kpi-card .trend.up{color:var(--ok)}
.kpi-card .trend.down{color:var(--bad)}
.kpi-card .trend.stable{color:var(--text-unit)}
.sparkline-container{height:30px;margin:8px 0 4px 0;display:flex;align-items:center;justify-content:center}
.sparkline-container svg{width:100%;height:100%}
.small{font-size:12px;color:var(--text-unit);margin-top:4px}
.gauge-container{display:flex;justify-content:center;align-items:center;margin:24px 0}
.gauge{font-size:2.8em;font-weight:800;padding:35px;border-radius:50%;width:200px;height:200px;display:flex;align-items:center;justify-content:center;border:10px solid;text-align:center;line-height:1.2;position:relative}
.gauge::after{content:'';position:absolute;inset:15px;border-radius:50%;background:var(--bg-container);z-index:-1}
.gauge.good{color:var(--ok);border-color:var(--ok);background:radial-gradient(circle,rgba(40,167,69,.2),transparent)}
.gauge.caution{color:var(--warn);border-color:var(--warn);background:radial-gradient(circle,rgba(255,193,7,.2),transparent)}
.gauge.critical{color:var(--bad);border-color:var(--bad);background:radial-gradient(circle,rgba(220,53,69,.2),transparent)}
.score-badge{display:inline-block;padding:8px 16px;border-radius:10px;font-weight:700;font-size:15px;box-shadow:var(--shadow-sm)}
.score-excellent{background:rgba(40,167,69,.25);color:var(--ok)}
.score-good{background:rgba(44,90,160,.25);color:var(--text-accent)}
.score-fair{background:rgba(255,193,7,.25);color:var(--warn)}
.score-poor{background:rgba(220,53,69,.25);color:var(--bad)}
.alert-box{background:var(--bg-card);border:2px solid var(--border);border-radius:14px;padding:18px;margin:16px 0;display:flex;gap:16px;align-items:start;transition:all .3s}
.alert-box:hover{box-shadow:var(--shadow-md);transform:translateX(4px)}
.alert-box.alert-critical{border-left:6px solid var(--bad);background:rgba(220,53,69,.05)}
.alert-box.alert-warning{border-left:6px solid var(--warn);background:rgba(255,193,7,.05)}
.alert-box.alert-info{border-left:6px solid var(--info);background:rgba(23,162,184,.05)}
.alert-icon{font-size:20px;flex-shrink:0}
.alert-content{flex:1}
.alert-title{font-weight:700;margin-bottom:6px;font-size:15px}
.alert-message{font-size:14px;color:var(--text-unit);line-height:1.6}
.alert-time{font-size:12px;color:var(--text-unit);margin-top:8px}
.toast{position:fixed;top:24px;right:24px;background:var(--bg-container);border:2px solid var(--border);border-radius:14px;padding:18px 26px;box-shadow:var(--shadow-xl);z-index:9999;animation:slideInRight .3s;max-width:450px;min-width:320px}
.toast.success{border-left:6px solid var(--ok)}
.toast.error{border-left:6px solid var(--bad)}
.toast.warning{border-left:6px solid var(--warn)}
.toast.info{border-left:6px solid var(--info)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:10000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal.active{display:flex}
.modal-content{background:var(--bg-container);border-radius:18px;padding:32px;max-width:800px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-xl);animation:slideInUp .3s}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid var(--border)}
.modal-header h2{color:var(--text-accent);margin:0;font-size:18px;font-weight:700}
.modal-close{background:rgba(220,53,69,.1);border:none;font-size:20px;cursor:pointer;color:var(--bad);padding:4px;width:36px;height:36px;display:grid;place-items:center;border-radius:50%;transition:all .2s}
.modal-close:hover{background:var(--bad);color:#fff;transform:rotate(90deg)}
.tool-card{background:var(--bg-card);padding:28px;border-radius:14px;border:2px solid var(--border);margin-bottom:24px;transition:all .3s;position:relative;overflow:hidden}
.tool-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:var(--gradient-1)}
.tool-card:hover{border-color:var(--text-accent);box-shadow:var(--shadow-lg);transform:translateY(-4px)}
.tool-card h3{margin:0 0 18px 0;color:var(--text-accent);font-size:20px;font-weight:700}
.tool-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;margin:18px 0}
.scenario-card{padding:24px;border:2px solid var(--border);border-radius:14px;background:var(--bg-card);cursor:pointer;transition:all .3s;text-align:center;position:relative;overflow:hidden}
.scenario-card::before{content:'';position:absolute;inset:0;background:var(--gradient-1);opacity:0;transition:opacity .3s}
.scenario-card:hover{border-color:var(--text-accent);transform:translateY(-6px);box-shadow:var(--shadow-lg)}
.scenario-card:hover::before{opacity:.05}
.scenario-card .icon{font-size:48px;margin-bottom:12px;position:relative;z-index:1}
.scenario-card strong{display:block;margin:12px 0 8px;color:var(--text);font-size:18px;position:relative;z-index:1}
.scenario-card p{margin:0;color:var(--text-unit);font-size:14px;position:relative;z-index:1}
.metric-card{background:var(--bg-card);padding:20px;border-radius:12px;border:1px solid var(--border);transition:all .3s}
.metric-card:hover{box-shadow:var(--shadow-md);border-color:var(--text-accent)}
.metric-card h5{margin:0 0 8px 0;color:var(--text-section);font-size:13px;text-transform:uppercase;font-weight:600}
.metric-card .value{font-size:20px;font-weight:700;color:var(--text-accent);margin:8px 0}
.metric-card .change{font-size:13px;font-weight:600}
.metric-card .change.positive{color:var(--ok)}
.metric-card .change.negative{color:var(--bad)}
.progress-bar{width:100%;height:12px;background:var(--border);border-radius:999px;overflow:hidden;margin:12px 0}
.progress-fill{height:100%;background:var(--gradient-1);border-radius:999px;transition:width .3s;position:relative}
.progress-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 2s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:20px 0}
.stat-item{text-align:center;padding:20px;background:var(--bg-card);border-radius:12px;border:2px solid var(--border)}
.stat-label{font-size:13px;color:var(--text-unit);text-transform:uppercase;font-weight:600;margin-bottom:8px}
.stat-value{font-size:32px;font-weight:800;color:var(--text-accent);margin:8px 0}
.stat-unit{font-size:14px;color:var(--text-unit)}
.timeline{position:relative;padding:20px 0}
.timeline-item{display:flex;gap:16px;margin-bottom:24px;position:relative}
.timeline-item::before{content:'';position:absolute;left:19px;top:40px;bottom:-24px;width:2px;background:var(--border)}
.timeline-item:last-child::before{display:none}
.timeline-icon{width:40px;height:40px;border-radius:50%;background:var(--text-accent);color:#fff;display:grid;place-items:center;font-weight:700;flex-shrink:0;box-shadow:var(--shadow-sm)}
.timeline-content{flex:1;padding:12px 16px;background:var(--bg-card);border-radius:12px;border:1px solid var(--border)}
.timeline-title{font-weight:700;margin-bottom:6px}
.timeline-time{font-size:12px;color:var(--text-unit)}
.accordion-item{border:1px solid var(--border);border-radius:12px;margin-bottom:12px;overflow:hidden}
.accordion-header{padding:16px 20px;background:var(--bg-section-header);cursor:pointer;font-weight:600;display:flex;justify-content:space-between;align-items:center;transition:all .2s}
.accordion-header:hover{background:var(--bg-note)}
.accordion-header::after{content:'‚ñº';transition:transform .3s}
.accordion-header.active::after{transform:rotate(180deg)}
.accordion-content{max-height:0;overflow:hidden;transition:max-height .3s}
.accordion-content.active{max-height:1000px;padding:20px}
.split-view{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}
.loading-spinner{border:4px solid var(--border);border-top:4px solid var(--text-accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-unit)}
.empty-state-icon{font-size:64px;margin-bottom:16px;opacity:.5}
.empty-state-title{font-size:20px;font-weight:600;margin-bottom:8px;color:var(--text)}
.empty-state-message{font-size:14px;margin-bottom:24px}
.tag{display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase;margin:2px}
.tag.success{background:rgba(40,167,69,.2);color:var(--ok)}
.tag.warning{background:rgba(255,193,7,.2);color:var(--warn)}
.tag.danger{background:rgba(220,53,69,.2);color:var(--bad)}
.tag.info{background:rgba(23,162,184,.2);color:var(--info)}

/* AI-Specific Styles */
.ai-chat-container{background:var(--bg-card);border-radius:14px;border:2px solid var(--border);padding:24px;min-height:500px;display:flex;flex-direction:column;gap:16px}
.ai-messages{flex:1;overflow-y:auto;max-height:600px;padding:16px;background:var(--bg-section);border-radius:12px;display:flex;flex-direction:column;gap:12px}
.ai-message{padding:14px 18px;border-radius:12px;max-width:80%;animation:slideInUp .3s;line-height:1.6}
.ai-message.user{background:var(--text-accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.ai-message.assistant{background:var(--bg-note);color:var(--text);align-self:flex-start;border-bottom-left-radius:4px;border-left:4px solid var(--text-accent)}
.ai-message.assistant::before{content:'ü§ñ';margin-right:8px;font-size:1.2em}
.ai-input-area{display:flex;gap:12px;align-items:center}
.ai-input{flex:1}
.ai-thinking{display:none;align-items:center;gap:8px;color:var(--text-accent);font-style:italic;padding:10px;background:var(--bg-note);border-radius:8px;margin:8px 0}
.ai-thinking.active{display:flex}
.ai-thinking::before{content:'';width:20px;height:20px;border:3px solid var(--text-accent);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
.diagnostic-card{background:var(--bg-card);border:2px solid var(--border);border-radius:14px;padding:24px;margin:16px 0;transition:all .3s}
.diagnostic-card:hover{border-color:var(--text-accent);box-shadow:var(--shadow-lg)}
.diagnostic-card .severity{display:inline-block;padding:6px 14px;border-radius:8px;font-weight:700;font-size:12px;text-transform:uppercase;margin-bottom:12px}
.diagnostic-card .severity.high{background:rgba(220,53,69,.2);color:var(--bad)}
.diagnostic-card .severity.medium{background:rgba(255,193,7,.2);color:var(--warn)}
.diagnostic-card .severity.low{background:rgba(23,162,184,.2);color:var(--info)}
.solution-step{background:var(--bg-section);border-left:4px solid var(--text-accent);padding:16px;border-radius:0 12px 12px 0;margin:12px 0}
.solution-step h5{margin:0 0 8px 0;color:var(--text-accent);font-size:15px}
.solution-step p{margin:0;line-height:1.6;color:var(--text-unit)}
.knowledge-item{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:18px;margin:12px 0;cursor:pointer;transition:all .3s}
.knowledge-item:hover{border-color:var(--text-accent);transform:translateX(4px);box-shadow:var(--shadow-md)}
.knowledge-item h4{margin:0 0 8px 0;color:var(--text-accent);font-size:16px}
.knowledge-item p{margin:0;color:var(--text-unit);font-size:14px;line-height:1.6}
.confidence-bar{width:100%;height:8px;background:var(--border);border-radius:999px;overflow:hidden;margin:8px 0}
.confidence-fill{height:100%;background:var(--gradient-1);border-radius:999px;transition:width .5s}
.symptom-checker{background:var(--bg-section);border-radius:12px;padding:20px;margin:16px 0}
.symptom-option{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border:2px solid var(--border);border-radius:10px;margin:8px 0;cursor:pointer;transition:all .2s}
.symptom-option:hover{border-color:var(--text-accent);transform:translateX(4px)}
.symptom-option input[type="checkbox"]{width:20px;height:20px;cursor:pointer}
.issue-history-item{background:var(--bg-card);border-left:4px solid var(--info);padding:16px;border-radius:0 12px 12px 0;margin:12px 0;transition:all .3s}
.issue-history-item:hover{box-shadow:var(--shadow-md);transform:translateX(4px)}
.issue-history-item.resolved{border-left-color:var(--ok);opacity:.7}
.issue-history-item .issue-date{font-size:12px;color:var(--text-unit);margin-bottom:6px}
.issue-history-item .issue-title{font-weight:700;margin-bottom:6px;color:var(--text-accent)}
.issue-history-item .issue-desc{font-size:14px;color:var(--text-unit);line-height:1.6}

@media(max-width:1024px){
.split-view{grid-template-columns:1fr}
.tool-grid,.card-grid{grid-template-columns:1fr}
}
@media(max-width:768px){
.content{padding:16px}
.table{font-size:12px}
.table th,.table td{padding:10px}
.header h1{font-size:18px}
.header-controls{position:relative;right:auto;top:auto;margin-top:12px}
.kpi-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.modal-content{padding:20px}
.ai-message{max-width:95%}
}

/* ==================== ENHANCED RESPONSIVE DESIGN v9.6.0 ==================== */

/* Mobile Menu Toggle */
.mobile-menu-toggle{display:none;position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:white;font-size:18px;cursor:pointer;z-index:1000;box-shadow:0 4px 20px rgba(102,126,234,0.4);transition:all 0.3s}
.mobile-menu-toggle:hover{transform:scale(1.1)}
.mobile-menu-toggle:active{transform:scale(0.95)}

/* Tab Navigation Improvements */
.tabs{overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}

/* ===== TABLET LANDSCAPE (1024px - 1280px) ===== */
@media(min-width:1024px) and (max-width:1280px){
  body{padding:15px}
  .wrap{max-width:100%;border-radius:16px}
  
  /* Header */
  .header{padding:20px 24px}
  .header h1{font-size:26px}
  
  /* Tabs - comfortable spacing */
  .tabs{padding:10px 12px;gap:6px;justify-content:center;flex-wrap:wrap}
  .tab{padding:12px 16px;font-size:13px;border-radius:8px}
  
  /* Content */
  .content{padding:20px}
  .section{margin-bottom:20px}
  .section-h{padding:14px 18px;font-size:15px}
  
  /* Grids - 3 columns */
  .row{grid-template-columns:repeat(3,1fr);gap:14px}
  .kpi-grid{grid-template-columns:repeat(3,1fr);gap:14px}
  .tool-grid{grid-template-columns:repeat(3,1fr)}
  
  /* Tables */
  .table{font-size:13px}
  .table th,.table td{padding:12px}
  
  /* Inputs - comfortable size */
  .input-group input,.input-group select{padding:12px;font-size:15px;min-height:46px}
}

/* ===== TABLET PORTRAIT (768px - 1024px) - ENHANCED v9.6.0 ===== */
@media(min-width:768px) and (max-width:1024px){
  body{padding:0;background:var(--bg-body)}
  .wrap{border-radius:0;min-height:100vh;overflow:visible !important}
  
  /* CRITICAL: Sticky header for tablet */
  .sticky-header{
    position:sticky !important;
    position:-webkit-sticky !important;
    top:0 !important;
    z-index:9999 !important;
    background:linear-gradient(135deg,#0a1628 0%,#1e3a5f 50%,#0d2137 100%) !important;
    box-shadow:0 4px 20px rgba(0,0,0,0.5) !important;
  }
  
  /* Header - Compact */
  .header{
    padding:12px 16px;
    text-align:left;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    gap:10px
  }
  .header h1{font-size:20px;margin:0;flex:1}
  .header h1 .badge{display:none}
  .header p{display:none}
  .header-controls{
    position:static;
    margin:0;
    display:flex;
    gap:8px;
    flex-wrap:nowrap
  }
  .header-controls .toggle{width:38px;height:38px;font-size:16px}
  .header-controls span:not(.toggle){display:none}
  
  /* Tabs - WRAPPED GRID like landscape mode */
  .tabs{
    padding:10px 16px;
    gap:6px;
    justify-content:center;
    flex-wrap:wrap;
    overflow-x:visible;
    background:var(--bg-tabs)
  }
  .tab{
    padding:10px 14px;
    font-size:12px;
    border-radius:8px;
    flex-shrink:0;
    white-space:nowrap;
    min-width:auto
  }
  .tab .badge{display:none}
  
  /* Content */
  .content{padding:14px;position:relative}
  
  /* CRITICAL: Panel isolation for tablet */
  .panel{display:none}
  .panel.active{display:block}
  
  .section{margin-bottom:14px;border-radius:12px}
  .section-h{padding:12px 14px;font-size:14px}
  .section-content{padding:14px}
  
  /* KPI Grid - 3 columns for better use of space */
  .kpi-grid{
    display:grid !important;
    grid-template-columns:repeat(3,1fr) !important;
    gap:10px !important
  }
  
  /* KPI Cards - Optimized for tablet */
  .kpi-card{
    padding:14px 10px;
    border-radius:10px;
    text-align:center
  }
  .kpi-card h4{
    font-size:10px;
    margin-bottom:4px;
    text-transform:uppercase;
    letter-spacing:0.5px
  }
  .kpi-card p{
    font-size:22px;
    font-weight:700;
    margin:4px 0
  }
  .kpi-card small{
    font-size:9px;
    opacity:0.8
  }
  
  /* Input grids - 2 columns */
  .row{grid-template-columns:repeat(2,1fr);gap:10px}
  .tool-grid{grid-template-columns:repeat(2,1fr)}
  .card-grid{grid-template-columns:repeat(2,1fr)}
  .stats-row{grid-template-columns:repeat(2,1fr)}
  
  /* Tables - Responsive */
  .table{font-size:11px;display:block;overflow-x:auto}
  .table th,.table td{padding:8px 6px;white-space:nowrap}
  .rowh{min-width:100px}
  
  /* Buttons - Touch friendly */
  .btn{padding:12px 16px;font-size:13px;min-height:44px;border-radius:10px}
  .btns{flex-wrap:wrap;gap:8px}
  .btns .btn{flex:1 1 45%}
  
  /* Inputs - Touch friendly */
  .input-group{margin:10px 0}
  .input-group label{font-size:13px;margin-bottom:6px}
  .input-group input,.input-group select{
    padding:12px;
    font-size:16px;
    min-height:48px;
    border-radius:10px;
    -webkit-appearance:none
  }
  
  /* Prevent zoom on focus (iOS) */
  input[type="text"],input[type="number"],input[type="email"],input[type="tel"],select,textarea{
    font-size:16px !important
  }
  
  /* Charts */
  .chart-container{height:240px;padding:12px}
  canvas{max-height:220px !important}
  
  /* Modals */
  .modal{padding:10px}
  .modal-content{width:95%;max-height:90vh;border-radius:14px}
  
  /* Notes */
  .note{padding:12px;font-size:13px;border-radius:10px}
  
  /* Quick Reference Modal */
  .qref-content{max-width:98%;max-height:95vh;margin:10px auto}
  .qref-header{padding:14px 16px}
  .qref-header h2{font-size:18px}
  .qref-tabs{flex-wrap:wrap;gap:4px;padding:10px 14px}
  .qref-tab{padding:8px 12px;font-size:12px}
  .qref-body{padding:14px}
  
  /* AI Recommendations section */
  .ai-recommendations,.note.info,.note.warning{
    font-size:13px;
    padding:12px
  }
  
  /* Floating widgets */
  #floatingUnitConverter{bottom:80px;right:12px}
  .cost-floating-widget{bottom:80px;left:12px}
  #fabMenu{bottom:12px;right:12px}
  #fabMenu button{width:44px;height:44px;font-size:18px}
  
  /* PWA Status */
  .pwa-status{bottom:12px;left:12px;padding:6px 10px;font-size:11px}
  
  /* Show mobile bottom nav on tablet portrait */
  .mobile-bottom-nav{
    display:flex !important;
    padding:8px 12px;
    padding-bottom:max(8px, env(safe-area-inset-bottom))
  }
  .mobile-nav-icon{font-size:20px}
  .mobile-nav-label{font-size:9px}
  
  /* Footer padding for bottom nav */
  .panel{padding-bottom:70px}
  
  /* Dashboard specific improvements */
  #dashboard .section:first-of-type .section-content{
    padding:10px
  }
}

/* ===== TABLET PORTRAIT ORIENTATION - WRAPPED TABS ===== */
@media(min-width:768px) and (max-width:1024px) and (orientation:portrait){
  .tabs{
    flex-wrap:wrap !important;
    overflow-x:visible !important;
    justify-content:center !important;
    padding:12px 16px !important;
    gap:8px !important
  }
  .tab{
    padding:10px 16px !important;
    font-size:12px !important
  }
}

/* ===== TABLET PORTRAIT DARK MODE FIXES ===== */
@media(min-width:768px) and (max-width:1024px){
  html.dark .tabs{
    background:linear-gradient(180deg, #0c1929 0%, #1a2744 100%);
    border-bottom:1px solid #334155
  }
  html.dark .tab{
    color:#94a3b8
  }
  html.dark .tab.active{
    background:linear-gradient(135deg, #1a2744, #243b55);
    color:#48cae4;
    border-bottom:2px solid #48cae4
  }
  html.dark .header{
    background:linear-gradient(135deg, #023e8a 0%, #0077b6 100%);
    box-shadow:0 2px 10px rgba(0,0,0,0.3)
  }
  html.dark .kpi-card{
    background:linear-gradient(135deg, #1a2744 0%, #243b55 100%);
    border:1px solid #334155
  }
}

/* ===== MOBILE STYLES (480px - 767px) ===== */
@media(min-width:480px) and (max-width:767px){
  body{padding:0;background:var(--bg-body)}
  .wrap{border-radius:0;min-height:100vh;overflow:visible !important}
  
  /* CRITICAL: Sticky header for mobile */
  .sticky-header{
    position:sticky !important;
    position:-webkit-sticky !important;
    top:0 !important;
    z-index:9999 !important;
    background:linear-gradient(135deg,#0a1628 0%,#1e3a5f 50%,#0d2137 100%) !important;
    box-shadow:0 4px 20px rgba(0,0,0,0.5) !important;
  }
  
  /* Header - Compact */
  .header{padding:12px 14px !important;text-align:center}
  .header h1{font-size:18px !important;margin-bottom:4px;justify-content:center}
  .header p{display:none}
  .header-controls{position:static;margin-top:8px;justify-content:center;flex-wrap:wrap;gap:8px}
  .toggle{width:40px;height:40px;font-size:16px}
  
  /* Hide tabs on mobile - use bottom nav instead */
  .sticky-header nav.tabs{display:none !important}
  .tabs{display:none !important}
  
  /* Show mobile menu toggle */
  .mobile-menu-toggle{display:flex;align-items:center;justify-content:center}
  
  /* Content - starts immediately after header */
  .content{padding:10px !important;padding-top:10px !important}
  
  /* Sections */
  .section{margin-bottom:14px;border-radius:12px}
  .section-h{padding:12px 14px;font-size:14px;border-radius:12px 12px 0 0}
  .section-content{padding:14px}
  
  /* Grids - 2 columns for larger phones */
  .row{grid-template-columns:repeat(2,1fr);gap:10px}
  .kpi-grid{grid-template-columns:repeat(2,1fr);gap:10px}
  .tool-grid{grid-template-columns:repeat(2,1fr)}
  .card-grid{grid-template-columns:1fr}
  
  /* Tables */
  .table{font-size:11px;display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .table th,.table td{padding:8px 6px;white-space:nowrap}
  .rowh{min-width:100px}
  
  /* Touch-friendly buttons */
  .btn{padding:14px 18px;font-size:14px;border-radius:10px;min-height:48px}
  .btns{flex-direction:row;flex-wrap:wrap;gap:8px}
  .btns .btn{flex:1 1 45%}
  
  /* Touch-friendly inputs */
  .input-group{margin:10px 0}
  .input-group label{font-size:13px;margin-bottom:6px}
  .input-group input,.input-group select,.input-group textarea{
    padding:14px 12px;
    font-size:16px;
    border-radius:10px;
    min-height:50px;
    -webkit-appearance:none;
    appearance:none
  }
  
  /* Select dropdown arrow */
  .input-group select{
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 14px center;
    padding-right:40px
  }
  
  /* KPI Cards */
  .kpi-card{padding:14px;border-radius:10px}
  .kpi-card h4{font-size:11px}
  .kpi-card p{font-size:22px}
  
  /* Charts */
  .chart-container{height:220px;padding:12px}
  canvas{max-height:200px !important}
  
  /* Modals - Nearly full screen */
  .modal{padding:10px}
  .modal-content{width:100%;max-height:90vh;border-radius:16px}
  
  /* Footer padding for FAB */
  .panel{padding-bottom:80px}
}

/* ===== SMALL MOBILE (< 480px) ===== */
@media(max-width:479px){
  body{padding:0;background:var(--bg-body)}
  .wrap{border-radius:0;min-height:100vh;overflow:visible !important}
  
  /* CRITICAL: Sticky header for small mobile */
  .sticky-header{
    position:sticky !important;
    position:-webkit-sticky !important;
    top:0 !important;
    z-index:9999 !important;
    background:linear-gradient(135deg,#0a1628 0%,#1e3a5f 50%,#0d2137 100%) !important;
    box-shadow:0 4px 20px rgba(0,0,0,0.5) !important;
  }
  
  /* Header - Very compact */
  .header{padding:10px 12px !important;text-align:center}
  .header h1{font-size:16px !important;margin-bottom:4px;justify-content:center;flex-wrap:wrap}
  .header p{display:none}
  .header-controls{position:static;margin-top:6px;justify-content:center;flex-wrap:wrap;gap:6px}
  .toggle{width:36px;height:36px;font-size:15px}
  .header-controls span{font-size:10px;padding:4px 8px}
  
  /* Hide tabs on mobile - use bottom nav instead */
  .sticky-header nav.tabs{display:none !important}
  .tabs{display:none !important}
  
  /* Mobile menu toggle */
  .mobile-menu-toggle{display:flex;width:56px;height:56px;font-size:22px}
  
  /* Content - starts immediately after header */
  .content{padding:8px !important;padding-top:8px !important}
  
  /* Sections */
  .section{margin-bottom:12px;border-radius:10px}
  .section-h{padding:10px 12px;font-size:13px}
  .section-content{padding:12px}
  
  /* Grids - Single column */
  .row{grid-template-columns:1fr !important;gap:8px}
  .kpi-grid{grid-template-columns:repeat(2,1fr);gap:8px}
  .tool-grid{grid-template-columns:1fr}
  .card-grid{grid-template-columns:1fr}
  .stats-row{grid-template-columns:1fr}
  .split-view{grid-template-columns:1fr !important}
  
  /* Force single column on inline styles */
  [style*="grid-template-columns: 1fr 1fr"],
  [style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr !important}
  [style*="grid-template-columns: repeat(2"],
  [style*="grid-template-columns:repeat(2"]{grid-template-columns:1fr !important}
  [style*="grid-template-columns: repeat(3"],
  [style*="grid-template-columns:repeat(3"]{grid-template-columns:1fr !important}
  [style*="grid-template-columns: repeat(4"],
  [style*="grid-template-columns:repeat(4"]{grid-template-columns:repeat(2,1fr) !important}
  
  /* Tables - Compact */
  .table{font-size:10px;display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .table th,.table td{padding:6px 4px;white-space:nowrap}
  .rowh{min-width:90px;font-size:10px}
  
  /* Buttons - Full width, touch optimized */
  .btns{flex-direction:column;gap:8px}
  .btns .btn{width:100%}
  .btn{padding:14px 16px;font-size:14px;border-radius:10px;min-height:48px;touch-action:manipulation}
  .btn.small{padding:12px 14px;min-height:44px}
  
  /* Touch-optimized inputs (min 44px touch target) */
  .input-group{margin:8px 0}
  .input-group label{font-size:12px;margin-bottom:5px}
  .input-group input,.input-group select,.input-group textarea{
    padding:14px 12px;
    font-size:16px;
    border-radius:10px;
    min-height:50px;
    -webkit-appearance:none;
    appearance:none;
    touch-action:manipulation
  }
  
  /* Select dropdown arrow */
  .input-group select{
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 12px center;
    padding-right:36px
  }
  
  /* KPI Cards - Compact */
  .kpi-card{padding:12px;border-radius:10px}
  .kpi-card h4{font-size:10px;margin-bottom:3px}
  .kpi-card p{font-size:20px}
  .kpi-card small{font-size:9px}
  
  /* Notes */
  .note{padding:10px;font-size:12px;border-radius:8px;line-height:1.5}
  
  /* Modals - Full screen */
  .modal{padding:0}
  .modal-content{width:100%;height:100%;max-height:100%;border-radius:0;margin:0}
  .modal-header{position:sticky;top:0;z-index:10;padding:12px 14px}
  .modal-body{padding:12px;padding-bottom:80px}
  
  /* Charts */
  .chart-container{height:200px;padding:10px}
  canvas{max-height:180px !important}
  
  /* AI Chat */
  .ai-chat-container{height:280px}
  .ai-message{max-width:90%;font-size:13px;padding:10px}
  .ai-input-area{padding:8px}
  .ai-input-area input{font-size:16px;padding:12px;min-height:48px}
  
  /* Gauge */
  .gauge{width:100px;height:100px;font-size:18px}
  
  /* Results display */
  .result{font-size:15px;padding:6px 10px}
  .status{padding:5px 8px;font-size:11px}
  
  /* Checklist items - large touch targets */
  .checklist-item{padding:12px;min-height:48px;display:flex;align-items:center}
  .checklist-item input[type="checkbox"]{width:24px;height:24px;min-width:24px;margin-right:12px}
  
  /* Quick Reference Modal */
  .qref-content{width:100%;max-width:100%;max-height:100%;border-radius:0;margin:0}
  .qref-header{padding:14px 16px}
  .qref-header h2{font-size:18px}
  .qref-search{padding:12px}
  .qref-search input{padding:12px;font-size:16px;min-height:48px}
  .qref-tabs{padding:10px 12px;gap:6px}
  .qref-tab{padding:8px 12px;font-size:12px}
  .qref-body{padding:14px}
  .qref-section h3{font-size:15px}
  .qref-table{font-size:11px}
  .qref-table th,.qref-table td{padding:8px 6px}
  
  /* Floating widgets - Bottom corners */
  #floatingUnitConverter{bottom:80px;right:10px;max-width:calc(100vw - 20px)}
  .cost-floating-widget{bottom:80px;left:10px;max-width:calc(100vw - 20px)}
  #fabMenu{bottom:12px;right:12px}
  #fabMenu button{width:48px;height:48px;font-size:18px}
  
  /* PWA Status - Smaller */
  .pwa-status{bottom:12px;left:12px;padding:8px 12px;font-size:11px;border-radius:20px}
  
  /* Footer padding for FAB */
  .panel{padding-bottom:90px}
  
  /* Hide desktop-only elements */
  .desktop-only{display:none !important}
}

/* ===== EXTRA SMALL MOBILE (< 360px) ===== */
@media(max-width:359px){
  .header h1{font-size:16px}
  .header-controls{gap:4px}
  .toggle{width:34px;height:34px;font-size:14px}
  .tab{padding:6px 8px;font-size:10px}
  .kpi-grid{grid-template-columns:1fr}
  .kpi-card p{font-size:18px}
  .btn{font-size:13px;padding:12px}
  .table{font-size:9px}
  .table th,.table td{padding:5px 3px}
  .section-h{font-size:12px;padding:8px 10px}
  .input-group label{font-size:11px}
  .input-group input,.input-group select{padding:12px 10px;font-size:16px;min-height:48px}
  .qref-header h2{font-size:16px}
  .qref-tab{padding:6px 10px;font-size:11px}
}

/* ===== LAPTOP/DESKTOP (> 1280px) ===== */
@media(min-width:1281px){
  body{padding:20px}
  .wrap{max-width:1800px}
  
  /* Tabs - all visible */
  .tabs{justify-content:center;flex-wrap:wrap;padding:12px}
  .tab{padding:14px 18px;font-size:14px}

/* ===== LANDSCAPE TABLET/PHONE - ENHANCED v9.6.0 ===== */
@media(max-width:1024px) and (orientation:landscape){
  body{padding:0}
  .wrap{border-radius:0;min-height:100vh}
  
  /* Header - Ultra compact, side controls */
  .header{
    padding:6px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:sticky;
    top:0;
    z-index:100
  }
  .header h1{
    font-size:16px;
    margin:0;
    white-space:nowrap
  }
  .header h1 .badge,.header h1 .live-indicator{display:none}
  .header p{display:none}
  .header-controls{
    position:static;
    margin:0;
    display:flex;
    gap:6px
  }
  .header-controls .toggle{width:32px;height:32px;font-size:14px}
  .header-controls span:not(.toggle){display:none}
  
  /* Tabs - Compact horizontal scroll */
  .tabs{
    padding:4px 10px;
    gap:3px;
    flex-wrap:nowrap;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
    position:sticky;
    top:44px;
    z-index:99
  }
  .tabs::-webkit-scrollbar{display:none}
  .tab{
    padding:6px 10px;
    font-size:10px;
    border-radius:6px;
    flex-shrink:0
  }
  .tab .badge{display:none}
  
  /* Content - Maximize space */
  .content{padding:8px 12px}
  .section{margin-bottom:10px;border-radius:10px}
  .section-h{padding:8px 12px;font-size:12px}
  .section-content{padding:10px}
  
  /* KPI Grid - 6 columns in landscape for all KPIs visible */
  .kpi-grid{
    display:grid !important;
    grid-template-columns:repeat(6,1fr) !important;
    gap:6px !important
  }
  
  /* KPI Cards - Ultra compact */
  .kpi-card{
    padding:8px 6px;
    border-radius:8px;
    text-align:center
  }
  .kpi-card h4{
    font-size:8px;
    margin-bottom:2px;
    text-transform:uppercase;
    letter-spacing:0.3px;
    line-height:1.2
  }
  .kpi-card p{
    font-size:16px;
    font-weight:700;
    margin:2px 0;
    line-height:1.1
  }
  .kpi-card small{
    font-size:8px;
    display:block;
    margin-top:2px
  }
  
  /* Input grids - 3-4 columns */
  .row{grid-template-columns:repeat(4,1fr) !important;gap:8px}
  .tool-grid{grid-template-columns:repeat(3,1fr)}
  .card-grid{grid-template-columns:repeat(3,1fr)}
  .stats-row{grid-template-columns:repeat(4,1fr)}
  
  /* Input groups - Compact */
  .input-group{margin:6px 0}
  .input-group label{font-size:11px;margin-bottom:4px}
  .input-group input,.input-group select{
    padding:8px 10px;
    font-size:14px;
    min-height:36px;
    border-radius:6px
  }
  
  /* Tables - Compact */
  .table{font-size:10px}
  .table th,.table td{padding:5px 4px}
  .rowh{min-width:80px;font-size:9px}
  
  /* Buttons - Compact row */
  .btn{padding:8px 12px;font-size:12px;min-height:36px;border-radius:8px}
  .btns{flex-direction:row;flex-wrap:wrap;gap:6px}
  .btns .btn{flex:0 0 auto}
  
  /* Charts - Short for landscape */
  .chart-container{height:150px;padding:8px}
  canvas{max-height:130px !important}
  
  /* Notes - Compact */
  .note{padding:8px 10px;font-size:11px;border-radius:6px}
  .note.info,.note.warning{padding:8px 10px;font-size:11px}
  
  /* AI Recommendations - Compact */
  .ai-recommendations{font-size:11px}
  .ai-recommendations h4{font-size:12px;margin-bottom:6px}
  
  /* Hide bottom nav in landscape - use tab bar */
  .mobile-bottom-nav{display:none !important}
  
  /* FAB Menu - Smaller */
  #fabMenu{bottom:8px;right:8px}
  #fabMenu button{width:36px;height:36px;font-size:14px}
  
  /* Floating widgets */
  #floatingUnitConverter{bottom:8px;right:50px;max-width:280px}
  .cost-floating-widget{bottom:8px;left:8px;max-width:280px}
  
  /* PWA Status - Minimal */
  .pwa-status{
    bottom:8px;
    left:8px;
    padding:4px 8px;
    font-size:9px;
    border-radius:12px
  }
  .pwa-status .status-dot{width:6px;height:6px}
  
  /* Modals - Landscape optimized */
  .modal{padding:8px}
  .modal-content{
    width:95%;
    max-width:none;
    max-height:90vh;
    border-radius:10px
  }
  .modal-header{padding:10px 14px}
  .modal-body{padding:10px 14px}
  
  /* Quick Reference Modal */
  .qref-content{
    max-width:98%;
    max-height:95vh;
    margin:5px auto
  }
  .qref-header{padding:10px 14px}
  .qref-header h2{font-size:16px}
  .qref-tabs{padding:6px 10px;gap:4px}
  .qref-tab{padding:6px 10px;font-size:10px}
  .qref-body{padding:10px}
  .qref-table{font-size:10px}
  .qref-table th,.qref-table td{padding:5px 4px}
  
  /* Results - Compact */
  .result{font-size:14px;padding:4px 8px}
  .status{font-size:10px;padding:3px 6px}
  
  /* Panel - No extra bottom padding */
  .panel{padding-bottom:10px}
  
  /* Two-column layout for main content when possible */
  .split-view{grid-template-columns:1fr 1fr !important;gap:10px}
}

/* ===== LANDSCAPE DARK MODE ===== */
@media(max-width:1024px) and (orientation:landscape){
  html.dark .header{
    background:linear-gradient(90deg, #023e8a 0%, #0077b6 100%);
    box-shadow:0 1px 8px rgba(0,0,0,0.3)
  }
  html.dark .tabs{
    background:linear-gradient(180deg, #0c1929 0%, #1a2744 100%);
    border-bottom:1px solid #334155
  }
  html.dark .kpi-card{
    background:linear-gradient(135deg, #1a2744 0%, #243b55 100%);
    border:1px solid #334155
  }
}

/* ===== SMALL LANDSCAPE (phones) ===== */
@media(max-height:500px) and (orientation:landscape){
  .header{padding:4px 12px}
  .header h1{font-size:14px}
  .header-controls .toggle{width:28px;height:28px;font-size:12px}
  
  .tabs{padding:3px 8px;top:36px}
  .tab{padding:4px 8px;font-size:9px}
  
  .content{padding:6px 10px}
  .section{margin-bottom:8px}
  .section-h{padding:6px 10px;font-size:11px}
  .section-content{padding:8px}
  
  .kpi-grid{gap:4px !important}
  .kpi-card{padding:6px 4px}
  .kpi-card h4{font-size:7px}
  .kpi-card p{font-size:14px}
  
  .chart-container{height:120px}
  canvas{max-height:100px !important}
  
  .input-group input,.input-group select{
    padding:6px 8px;
    min-height:32px;
    font-size:13px
  }
}

/* ===== SCROLLING OPTIMIZATION ===== */
.is-scrolling .section{
  will-change:transform;
}

.is-scrolling .chart-container canvas{
  will-change:auto;
}

/* ===== TOUCH DEVICE OPTIMIZATIONS ===== */
.is-touch .btn{
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
}

.is-touch .tab{
  -webkit-tap-highlight-color:transparent;
}

.is-touch input,.is-touch select,.is-touch textarea{
  -webkit-tap-highlight-color:transparent;
}

/* Larger hit areas for touch */
.is-touch .section-h{
  min-height:48px;
}

.is-touch .checklist-item{
  min-height:52px;
}

/* Active states for touch */
.is-touch .btn:active{
  transform:scale(0.97);
  opacity:0.9;
}

.is-touch .tab:active{
  transform:scale(0.98);
}

.is-touch .kpi-card:active{
  transform:scale(0.98);
}

/* ===== iOS SAFE AREA SUPPORT ===== */
@supports(padding: max(0px)){
  .header{
    padding-top:max(12px, env(safe-area-inset-top));
    padding-left:max(16px, env(safe-area-inset-left));
    padding-right:max(16px, env(safe-area-inset-right));
  }
  
  .mobile-bottom-nav{
    padding-bottom:max(12px, env(safe-area-inset-bottom));
    padding-left:max(16px, env(safe-area-inset-left));
    padding-right:max(16px, env(safe-area-inset-right));
  }
  
  .panel{
    padding-bottom:max(80px, calc(60px + env(safe-area-inset-bottom)));
  }
  
  .modal-content{
    padding-bottom:max(20px, env(safe-area-inset-bottom));
  }
}

/* ===== HIGH DPI / RETINA DISPLAYS ===== */
@media(-webkit-min-device-pixel-ratio:2),(min-resolution:192dpi){
  .section{
    border-width:0.5px;
  }
  
  .table th,.table td{
    border-bottom-width:0.5px;
  }
  
  input,select,textarea{
    border-width:1px;
  }
}

/* ===== HOVER ONLY FOR NON-TOUCH ===== */
@media(hover:hover) and (pointer:fine){
  .btn:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(0,0,0,0.15);
  }
  
  .tab:hover{
    background:var(--bg-note);
    transform:translateY(-2px);
  }
  
  .section:hover{
    box-shadow:0 8px 24px rgba(0,0,0,0.12);
  }
  
  .kpi-card:hover{
    transform:translateY(-4px);
    box-shadow:0 12px 30px rgba(0,0,0,0.15);
  }
}

/* ===== REDUCED MOTION PREFERENCE ===== */
@media(prefers-reduced-motion:reduce){
  *{
    animation:none !important;
    transition:none !important;
  }
  
  .is-touch .btn:active,
  .is-touch .tab:active,
  .is-touch .kpi-card:active{
    transform:none;
  }
}
  .content{padding:24px}
  
  /* Grids */
  .row{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
  .kpi-grid{grid-template-columns:repeat(4,1fr)}
  .tool-grid{grid-template-columns:repeat(3,1fr)}
  
  /* Tables */
  .table{font-size:14px}
  .table th,.table td{padding:14px}
  
  /* Hide mobile elements */
  .mobile-menu-toggle{display:none !important}
  .mobile-only{display:none !important}
}

/* ===== LARGE DESKTOP (> 1440px) ===== */
@media(min-width:1441px){
  .wrap{max-width:1900px}
  .kpi-grid{grid-template-columns:repeat(5,1fr)}
  .tool-grid{grid-template-columns:repeat(4,1fr)}
  .row{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
}

/* ===== TOUCH DEVICE IMPROVEMENTS ===== */
@media(hover:none) and (pointer:coarse){
  /* Larger touch targets */
  .btn{min-height:48px}
  .tab{min-height:44px}
  .input-group input,.input-group select{min-height:48px}
  .checklist-item{min-height:52px}
  
  /* Remove hover effects that don't work on touch */
  .btn:hover{transform:none}
  .tab:hover{transform:none;background:transparent}
  .table tbody tr:hover{transform:none}
  .section:hover{transform:none}
  
  /* Add active states instead */
  .btn:active{transform:scale(0.98);opacity:0.9}
  .tab:active{background:var(--bg-note)}
}

/* ===== PRINT STYLES ===== */
/* ===== ENHANCED PRINT STYLES v9.6.0 ===== */
@media print{
  /* Force light mode for printing */
  :root, html, html.dark {
    --bg-body: white !important;
    --bg-container: white !important;
    --bg-section: white !important;
    --bg-section-header: #f8fafc !important;
    --bg-tabs: white !important;
    --bg-tab-active: white !important;
    --bg-table-th: #f1f5f9 !important;
    --bg-col-header: #e2e8f0 !important;
    --bg-row-header: #f8fafc !important;
    --bg-input: white !important;
    --bg-result: #e0f2fe !important;
    --bg-note: #f0f9ff !important;
    --bg-card: white !important;
    --text: #1e293b !important;
    --text-header: #0f172a !important;
    --text-accent: #0077b6 !important;
    --text-unit: #475569 !important;
    --text-section: #1e3a5f !important;
    --border: #cbd5e1 !important;
    --border-input: #94a3b8 !important;
  }
  
  body {
    background: white !important;
    padding: 0 !important;
    color: #1e293b !important;
    font-size: 11px !important;
  }
  
  .wrap {
    box-shadow: none !important;
    border-radius: 0 !important;
    background: white !important;
  }
  
  .header {
    background: #0077b6 !important;
    color: white !important;
    padding: 15px 20px !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  /* Hide non-essential elements */
  .tabs, .header-controls, .btns, .mobile-menu-toggle,
  .mobile-nav, #fabMenu, .pwa-status, .pwa-install-btn,
  .pwa-update-banner, #floatingUnitConverter, .toast,
  .qref-modal, .install-modal, #aiChatWidget, .cost-floating-widget,
  #timeTrackerWidget, .portal-banner {
    display: none !important;
  }
  
  /* Show all panels for comprehensive print */
  .panel {
    display: block !important;
    visibility: visible !important;
    page-break-inside: avoid !important;
    margin-bottom: 20px !important;
  }
  
  .section {
    break-inside: avoid !important;
    page-break-inside: avoid !important;
    border: 1px solid #cbd5e1 !important;
    margin-bottom: 15px !important;
    background: white !important;
  }
  
  .section-h {
    background: #f1f5f9 !important;
    color: #1e3a5f !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  .table {
    font-size: 9px !important;
    width: 100% !important;
  }
  
  .table th {
    background: #f1f5f9 !important;
    color: #1e3a5f !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  .result {
    background: #e0f2fe !important;
    color: #0077b6 !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  .note {
    background: #f0f9ff !important;
    border-left-color: #0077b6 !important;
    color: #1e3a5f !important;
  }
  
  /* Status colors for print */
  .ok { background: #d1fae5 !important; color: #065f46 !important; }
  .warn { background: #fef3c7 !important; color: #92400e !important; }
  .bad { background: #fee2e2 !important; color: #991b1b !important; }
  
  /* Chart containers - show placeholder */
  .chart-container {
    border: 1px dashed #cbd5e1 !important;
    background: #f8fafc !important;
    height: auto !important;
    min-height: 100px !important;
  }
  
  /* Page breaks */
  h1, h2, h3, .section-h {
    page-break-after: avoid !important;
  }
  
  /* Print header/footer */
  @page {
    margin: 0.5in;
    @top-center { content: "WWTP Command Center Report"; }
    @bottom-center { content: "Page " counter(page) " of " counter(pages); }
  }
}

/* ===== DARK MODE MOBILE ADJUSTMENTS ===== */
@media(max-width:767px){
  html.dark .tabs{background:#111827;border-bottom:1px solid #374151}
  html.dark .tab{color:#9CA3AF}
  html.dark .tab.active{color:#4ade80;background:#1F2937}
  html.dark .section{background:#1F2937}
  html.dark .input-group input,html.dark .input-group select{background:#374151;border-color:#4B5563}
}

/* ===== ENHANCED THEME TRANSITIONS v9.6.0 ===== */
html {
  transition: background 0.3s ease;
}

body, .wrap, .header, .tabs, .tab, .section, .section-h, .section-content,
input, select, textarea, .btn, .note, .result, .table, .table th, .table td,
.kpi-card, .chart-container, .modal-content, .qref-content, .qref-modal,
.toast, .status-bar, .row, .input-group, .input-group label {
  transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
}

/* Light Mode Enhancements */
html:not(.dark) {
  --shadow-soft: 0 2px 8px rgba(0, 119, 182, 0.08);
  --shadow-card: 0 4px 12px rgba(0, 119, 182, 0.1);
}

html:not(.dark) .section {
  box-shadow: var(--shadow-soft);
}

html:not(.dark) .section:hover {
  box-shadow: var(--shadow-card);
}

html:not(.dark) .kpi-card {
  background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
  border-color: #bae6fd;
}

html:not(.dark) .section-h {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  color: #023e8a;
}

html:not(.dark) .tab.active {
  background: white;
  color: #0077b6;
  border-bottom: 3px solid #0077b6;
  box-shadow: 0 -2px 8px rgba(0, 119, 182, 0.1);
}

html:not(.dark) .result {
  background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
  color: #023e8a;
}

html:not(.dark) .note {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-left-color: #0077b6;
  color: #1e3a5f !important;
}

html:not(.dark) .note.info {
  background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
  border-left-color: #00b4d8;
  color: #0c4a6e !important;
}

html:not(.dark) .note.warning {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border-left-color: #f59e0b;
  color: #78350f !important;
}

html:not(.dark) .note.success {
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  border-left-color: #10b981;
  color: #064e3b !important;
}

/* LIGHT MODE - Comprehensive text color fixes */
html:not(.dark) .section-content {
  color: #1e3a5f !important;
}

html:not(.dark) .section-content p,
html:not(.dark) .section-content span,
html:not(.dark) .section-content div,
html:not(.dark) .section-content strong,
html:not(.dark) .section-content label {
  color: #1e3a5f;
}

html:not(.dark) .kpi-card {
  background: white;
  color: #1e3a5f;
}

html:not(.dark) .kpi-card h4 {
  color: #64748b;
}

html:not(.dark) .kpi-card p {
  color: #0077b6;
}

html:not(.dark) .table td,
html:not(.dark) .table th {
  color: #1e3a5f;
}

html:not(.dark) #aiRecommendations .note strong {
  color: inherit;
}

html:not(.dark) input, html:not(.dark) select, html:not(.dark) textarea {
  background: white;
  border-color: #bae6fd;
}

html:not(.dark) input:focus, html:not(.dark) select:focus {
  border-color: #0077b6;
  box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.15);
}

/* Dark Mode Enhancements */
html.dark {
  --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.3);
  --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.4);
}

html.dark body {
  background: linear-gradient(135deg, #0c1929 0%, #1a2744 100%);
}

html.dark .section {
  background: linear-gradient(135deg, #1a2744 0%, #243b55 100%);
  border-color: #334155;
  box-shadow: var(--shadow-soft);
}

html.dark .section:hover {
  box-shadow: var(--shadow-card);
  border-color: #475569;
}

html.dark .section-h {
  background: linear-gradient(135deg, #243b55 0%, #1a2744 100%);
  color: #90e0ef;
}

html.dark .kpi-card {
  background: linear-gradient(135deg, #243b55 0%, #1a2744 100%);
  border-color: #475569;
}

html.dark .kpi-card:hover {
  border-color: #48cae4;
  box-shadow: 0 0 20px rgba(72, 202, 228, 0.2);
}

html.dark .tab.active {
  background: linear-gradient(135deg, #1a2744 0%, #243b55 100%);
  color: #48cae4;
  border-bottom: 3px solid #48cae4;
}

html.dark .result {
  background: linear-gradient(135deg, #023e8a 0%, #0077b6 100%);
  color: #e0f2fe;
}

html.dark .note {
  background: linear-gradient(135deg, #1a2744 0%, #023e8a 100%);
  border-left-color: #48cae4;
  color: #e0f2fe;
}

html.dark .note.info {
  background: linear-gradient(135deg, #023e8a 0%, #0077b6 100%);
  border-left-color: #00b4d8;
}

html.dark .note.warning {
  background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
  border-left-color: #fbbf24;
  color: #fef3c7;
}

html.dark .note.success {
  background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
  border-left-color: #34d399;
  color: #d1fae5;
}

html.dark input, html.dark select, html.dark textarea {
  background: #1a2744;
  border-color: #475569;
  color: #e0f2fe;
}

html.dark input:focus, html.dark select:focus {
  border-color: #48cae4;
  box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
}

html.dark input::placeholder {
  color: #64748b;
}

html.dark .table th {
  background: linear-gradient(135deg, #0c1929 0%, #1a2744 100%);
  color: #90e0ef;
}

html.dark .table tbody tr:hover {
  background: rgba(72, 202, 228, 0.1);
}

html.dark .btn {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

html.dark .btn:hover {
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
}

/* Modal Consistency */
html.dark .qref-content,
html.dark .install-modal-content,
html.dark .modal-content {
  background: linear-gradient(135deg, #1a2744 0%, #243b55 100%);
  border: 1px solid #475569;
}

html.dark .qref-header {
  background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
}

html.dark .qref-tab {
  background: #1a2744;
  color: #94a3b8;
}

html.dark .qref-tab:hover {
  background: #243b55;
}

html.dark .qref-tab.active {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

html.dark .qref-table th {
  background: #0c1929;
  color: #90e0ef;
}

html.dark .qref-table tr:hover {
  background: rgba(72, 202, 228, 0.1);
}

html.dark .qref-trouble {
  background: #1a2744;
  border: 1px solid #334155;
}

/* Cost Calculator Widget Dark Mode */
html.dark .cost-floating-widget {
  background: linear-gradient(135deg, #1a2744 0%, #243b55 100%) !important;
  border-color: #475569 !important;
}

/* Time Tracker Widget Dark Mode */
html.dark #timeTrackerWidget {
  background: linear-gradient(135deg, #1a2744 0%, #243b55 100%) !important;
  border-color: #475569 !important;
}

/* Toast Notifications Consistency */
html.dark .toast {
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
}

/* Status Colors - Both Modes */
.ok, .status-ok { 
  color: #059669 !important; 
  background: rgba(16, 185, 129, 0.15) !important; 
}
.warn, .status-warn { 
  color: #d97706 !important; 
  background: rgba(245, 158, 11, 0.15) !important; 
}
.bad, .status-bad { 
  color: #dc2626 !important; 
  background: rgba(239, 68, 68, 0.15) !important; 
}

html.dark .ok, html.dark .status-ok { 
  color: #34d399 !important; 
  background: rgba(52, 211, 153, 0.2) !important; 
}
html.dark .warn, html.dark .status-warn { 
  color: #fbbf24 !important; 
  background: rgba(251, 191, 36, 0.2) !important; 
}
html.dark .bad, html.dark .status-bad { 
  color: #f87171 !important; 
  background: rgba(248, 113, 113, 0.2) !important; 
}

/* Floating Action Buttons Dark Mode */
html.dark #fabMenu button {
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
}

/* Header Theme Button Enhancement */
.toggle#themeBtn {
  background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
  border: none !important;
}

html.dark .toggle#themeBtn {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
}

.toggle#themeBtn:hover {
  transform: rotate(360deg) scale(1.1) !important;
}

/* ===== ACCESSIBILITY ===== */
@media(prefers-reduced-motion:reduce){
  *{animation:none !important;transition:none !important}
}

/* High contrast mode support */
@media(prefers-contrast:high){
  .btn{border:2px solid currentColor}
  .input-group input,.input-group select{border-width:2px}
  .section{border:2px solid var(--border)}
}

/* ========== ENHANCED CALCULATOR STYLES ========== */

/* Result Cards */
.calc-result-card {
  background: linear-gradient(135deg, #1e3a5f, #243b55);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  border: 2px solid transparent;
  transition: all 0.3s;
}
.calc-result-card.optimal {
  border-color: #10b981;
  box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
}
.calc-result-card.warning {
  border-color: #f59e0b;
  box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
}
.calc-result-card.critical {
  border-color: #ef4444;
  box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
}
.calc-result-card .value {
  font-size: 32px;
  font-weight: bold;
  color: white;
  margin: 8px 0;
}
.calc-result-card .label {
  font-size: 14px;
  color: #94a3b8;
  margin-bottom: 4px;
}
.calc-result-card .unit {
  font-size: 13px;
  color: #64748b;
}
.calc-result-card .status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
  margin-top: 8px;
}
.calc-result-card .status-badge.optimal { background: #10b981; color: white; }
.calc-result-card .status-badge.warning { background: #f59e0b; color: #1e3a5f; }
.calc-result-card .status-badge.critical { background: #ef4444; color: white; }

/* Gauge Chart */
.gauge-container {
  position: relative;
  width: 150px;
  height: 90px;
  margin: 0 auto;
}
.gauge-bg {
  fill: none;
  stroke: #1e3a5f;
  stroke-width: 12;
}
.gauge-fill {
  fill: none;
  stroke-width: 12;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.5s ease;
}
.gauge-value {
  font-size: 24px;
  font-weight: bold;
  fill: white;
  text-anchor: middle;
}
.gauge-label {
  font-size: 11px;
  fill: #94a3b8;
  text-anchor: middle;
}

/* Input Validation */
.input-group input.valid {
  border-color: #10b981 !important;
  box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
}
.input-group input.invalid {
  border-color: #ef4444 !important;
  box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
}
.input-group input.warning-range {
  border-color: #f59e0b !important;
  box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
}

/* Trend Arrows */
.trend-up { color: #ef4444; }
.trend-down { color: #10b981; }
.trend-stable { color: #64748b; }
.trend-arrow { font-size: 18px; margin-right: 4px; }

/* Unit Toggle */
.unit-toggle {
  display: inline-flex;
  background: #1e3a5f;
  border-radius: 8px;
  padding: 4px;
  gap: 4px;
}
.unit-toggle button {
  padding: 6px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: bold;
  background: transparent;
  color: #94a3b8;
  transition: all 0.2s;
}
.unit-toggle button.active {
  background: #3b82f6;
  color: white;
}

/* Formula Display */
.formula-box {
  background: #0c1929;
  border: 1px solid #3b82f6;
  border-radius: 8px;
  padding: 12px 16px;
  font-family: 'Courier New', monospace;
  font-size: 14px;
  color: #60a5fa;
  margin-top: 12px;
  display: none;
}
.formula-box.visible {
  display: block;
}

/* Calculator History */
.calc-history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  margin-bottom: 8px;
}
.calc-history-item .timestamp {
  font-size: 12px;
  color: #64748b;
}
.calc-history-item .values {
  font-size: 14px;
  color: white;
}

/* Compare Mode */
.compare-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}
.compare-column {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 16px;
}
.compare-column h4 {
  margin: 0 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

/* Auto-calculate indicator */
.auto-calc-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #10b981;
  color: white;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: bold;
}
.auto-calc-badge::before {
  content: '‚ö°';
}

/* ========== MOBILE/TABLET OPTIMIZATION v9.6.0 ========== */

/* Touch-friendly targets (48px minimum) */
.btn, .tab, .toggle, button, input[type="button"], input[type="submit"] {
  min-height: 44px;
  min-width: 44px;
}

/* Prevent zoom on input focus (16px minimum) */
input, select, textarea {
  font-size: 16px !important;
}

/* Smooth scrolling */
html {
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

/* Touch feedback */
.btn:active, .tab:active, .toggle:active {
  transform: scale(0.96);
  transition: transform 0.1s;
}

/* 11" Tablet Optimization (1024px and below) */
@media (max-width: 1024px) {
  /* Larger touch targets */
  .btn { padding: 12px 16px; font-size: 14px; }
  .tab { padding: 10px 12px; min-height: 44px; }
  .toggle { width: 44px; height: 44px; }
  
  /* Better input sizing */
  .input-group input, .input-group select {
    padding: 12px;
    font-size: 16px !important;
  }
  
  /* Readable labels */
  .input-group label {
    font-size: 13px;
    margin-bottom: 6px;
  }
  
  /* Section spacing */
  .section { margin-bottom: 16px; }
  .section-content { padding: 16px; }
  
  /* KPI cards - 2 column grid */
  .kpi-grid {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px;
  }
  .kpi-card { padding: 16px; }
  
  /* Row layouts - stack on smaller tablets */
  .row {
    flex-direction: column;
    gap: 12px;
  }
  .row .input-group {
    width: 100%;
    min-width: unset;
  }
}

/* Portrait tablet specific */
@media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
  /* Disable sticky header to prevent overlap */
  .sticky-header {
    position: relative !important;
  }
  
  /* Full width content */
  .content { padding: 12px; }
  
  /* Stack buttons */
  .btns {
    flex-direction: column;
    gap: 10px;
  }
  .btns .btn {
    width: 100%;
  }
}

/* Hide floating buttons on tablet to prevent overlap */
@media (min-width: 768px) and (max-width: 1024px) {
  #favoritesFloatingBtn,
  #favoritesPanel,
  .realtime-badge,
  .pwa-status,
  .mobile-menu-toggle {
    display: none !important;
  }
}

/* ========== END MOBILE/TABLET OPTIMIZATION ========== */

</style>
<!-- ABSOLUTE APEX EDITION -->
<meta name="description" content="WWTP Command Center APEX - The absolute theoretical maximum with AI, Voice, Digital Twin">
<meta name="keywords" content="WWTP,wastewater,AI,voice,digital-twin,apex">
<meta name="version" content="6.0 ABSOLUTE APEX">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="manifest" href="/wwtp-app/manifest.json" id="pwa-manifest">
<meta name="theme-color" content="#023e8a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WWTP APEX">
<link rel="apple-touch-icon" href="data:image/svg+xml,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 100 100&#39;&gt;&lt;text y=&#39;75&#39; font-size=&#39;75&#39;&gt;%F0%9F%91%91&lt;/text&gt;&lt;/svg&gt;">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<style>
/* APEX EDITION - REVOLUTIONARY STYLES */
/* AI Copilot Interface */
.ai-copilot{position:fixed;bottom:80px;right:30px;width:400px;max-height:600px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);z-index:9999;display:none;flex-direction:column;overflow:hidden;animation:slideInUp .3s}
.ai-copilot.active{display:flex}
.ai-header{background:rgba(0,0,0,0.2);padding:20px;display:flex;justify-content:space-between;align-items:center;color:white}
.ai-avatar{width:50px;height:50px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;font-size:20px;animation:pulse 2s infinite}
.ai-chat{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:15px;background:white}
.ai-message{padding:12px 16px;border-radius:12px;max-width:85%;animation:fadeIn .3s}
.ai-message.bot{background:linear-gradient(135deg,#667eea,#764ba2);color:white;align-self:flex-start;margin-right:auto}
.ai-message.user{background:#e9ecef;color:#333;align-self:flex-end;margin-left:auto}
.ai-input-area{padding:15px;background:rgba(0,0,0,0.05);display:flex;gap:10px}
.ai-input{flex:1;padding:12px;border:none;border-radius:10px;font-size:14px;outline:none}
.ai-send-btn{padding:12px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700;transition:all .3s}
.ai-send-btn:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(102,126,234,0.4)}
/* Digital Twin Visualization */
.digital-twin{background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;border-radius:15px;padding:30px;margin:20px 0}
.twin-container{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin:20px 0}
.twin-component{background:rgba(255,255,255,0.1);border-radius:12px;padding:20px;backdrop-filter:blur(10px);transition:all .3s;cursor:pointer}
.twin-component:hover{background:rgba(255,255,255,0.2);transform:scale(1.05)}
.twin-status{display:flex;align-items:center;justify-content:space-between;margin-top:15px}
.twin-indicator{width:12px;height:12px;border-radius:50%;animation:pulse 2s infinite}
.twin-indicator.optimal{background:#4ade80}
.twin-indicator.warning{background:#fbbf24}
.twin-indicator.critical{background:#ef4444}
/* Machine Learning Panel */
.ml-panel{background:linear-gradient(135deg,#2c3e50,#3498db);color:white;border-radius:15px;padding:30px}
.ml-insight{background:rgba(255,255,255,0.15);border-left:4px solid #3498db;padding:15px 20px;margin:15px 0;border-radius:8px;backdrop-filter:blur(10px)}
.ml-confidence{display:inline-block;background:rgba(255,255,255,0.2);padding:4px 12px;border-radius:15px;font-size:12px;font-weight:700;margin-left:10px}
.learning-indicator{position:relative;height:8px;background:rgba(255,255,255,0.2);border-radius:4px;margin-top:10px;overflow:hidden}
.learning-progress{position:absolute;top:0;left:0;height:100%;background:linear-gradient(90deg,#3498db,#2ecc71);border-radius:4px;animation:slideInLeft 2s}
/* Blockchain Audit Trail */
.blockchain-panel{background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:white;border-radius:15px;padding:30px}
.block-chain{display:flex;flex-direction:column;gap:15px}
.block{background:rgba(255,255,255,0.1);border-radius:10px;padding:20px;border-left:4px solid #00d4ff;backdrop-filter:blur(10px);position:relative}
.block::after{content:'üîó';position:absolute;left:50%;bottom:-20px;font-size:20px;transform:translateX(-50%)}
.block:last-child::after{display:none}
.block-hash{font-family:monospace;font-size:11px;opacity:0.7;margin-top:10px}
.verified-badge{background:#00d4ff;color:#000;padding:4px 10px;border-radius:15px;font-size:11px;font-weight:700;display:inline-block}
/* IoT Sensor Dashboard */
.iot-dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0}
.sensor-card{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;overflow:hidden}
.sensor-card::before{content:'';position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgba(255,255,255,0.2),transparent);border-radius:50%}
.sensor-value{font-size:42px;font-weight:900;margin:15px 0}
.sensor-trend{display:flex;align-items:center;gap:10px;font-size:14px;margin-top:10px}
.live-indicator{width:10px;height:10px;background:#4ade80;border-radius:50%;animation:pulse 1s infinite;box-shadow:0 0 10px #4ade80}
/* Natural Language Query */
.nl-query-panel{background:linear-gradient(135deg,#8e44ad,#c0392b);color:white;border-radius:15px;padding:30px;margin:20px 0}
.nl-input-wrapper{display:flex;gap:15px;margin-top:20px}
.nl-input{flex:1;padding:15px 20px;border:none;border-radius:30px;font-size:16px;outline:none}
.nl-submit{padding:15px 30px;background:white;color:#8e44ad;border:none;border-radius:30px;font-weight:700;cursor:pointer;transition:all .3s}
.nl-submit:hover{transform:scale(1.05);box-shadow:0 5px 20px rgba(255,255,255,0.3)}
.nl-examples{display:flex;flex-wrap:wrap;gap:10px;margin-top:15px}
.nl-example{background:rgba(255,255,255,0.2);padding:8px 16px;border-radius:20px;font-size:13px;cursor:pointer;transition:all .3s}
.nl-example:hover{background:rgba(255,255,255,0.3)}
/* Advanced 3D Visualization */
.viz-3d-container{background:#000;border-radius:15px;padding:40px;margin:20px 0;min-height:400px;position:relative;overflow:hidden}
.viz-3d-placeholder{color:white;text-align:center;padding:100px 20px}
.viz-controls{position:absolute;top:20px;right:20px;display:flex;gap:10px}
.viz-control-btn{background:rgba(255,255,255,0.2);color:white;border:none;padding:10px 15px;border-radius:8px;cursor:pointer;backdrop-filter:blur(10px)}
/* Quantum Analytics Ready */
.quantum-panel{background:linear-gradient(135deg,#000428,#004e92);color:white;border-radius:15px;padding:30px;position:relative;overflow:hidden}
.quantum-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-top:20px}
.quantum-bit{width:100%;aspect-ratio:1;background:linear-gradient(135deg,#00d4ff,#0066ff);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;animation:float 3s ease-in-out infinite;cursor:pointer}
.quantum-bit:hover{animation:none;transform:scale(1.1) rotate(180deg)}
/* Advanced Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideInLeft{from{width:0}to{width:var(--progress,80%)}}
@keyframes float{0%,100%{transform:translateY(0) rotate(0)}25%{transform:translateY(-5px) rotate(5deg)}75%{transform:translateY(-5px) rotate(-5deg)}}

/* SUPREME EDITION ENHANCEMENTS */
/* Mobile-First Responsive Design */
@media(max-width:480px){
.quick-actions{grid-template-columns:repeat(2,1fr);gap:8px}
.quick-action-btn{padding:8px 12px;font-size:12px}
.quick-action-btn span{font-size:16px}
.summary-cards{grid-template-columns:1fr}
.analytics-grid{grid-template-columns:1fr}
.comparison-panel{grid-template-columns:1fr}
.modal-content{padding:15px;max-width:95%}
}
@media(max-width:768px)and(min-width:481px){
.quick-actions{grid-template-columns:repeat(3,1fr)}
.summary-cards{grid-template-columns:repeat(2,1fr)}
}
/* Real-Time Status Indicators */
.realtime-badge{position:fixed;bottom:20px;left:20px;background:var(--ok);color:white;padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;z-index:999;box-shadow:var(--shadow-xl);animation:pulse 2s infinite}
.realtime-badge.syncing{background:var(--info)}
.realtime-badge.offline{background:var(--bad)}
.realtime-badge.online{background:var(--ok)}
/* Advanced Dashboard */
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:20px 0}
.dashboard-widget{background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:var(--shadow-md);position:relative;cursor:move;transition:all .3s}
.dashboard-widget:hover{transform:translateY(-5px);box-shadow:var(--shadow-xl)}
.widget-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.widget-title{font-size:16px;font-weight:700;color:var(--text-accent)}
.widget-actions{display:flex;gap:8px}
.widget-action-btn{background:none;border:none;color:var(--text-unit);cursor:pointer;font-size:18px;padding:4px;transition:all .3s}
.widget-action-btn:hover{color:var(--text-accent);transform:scale(1.2)}
.widget-body{min-height:100px}
/* Automation Rules */
.rule-card{background:var(--bg-section);border-left:4px solid var(--text-accent);padding:15px;margin:10px 0;border-radius:8px;transition:all .3s}
.rule-card:hover{background:var(--bg-tabs);transform:translateX(5px)}
.rule-status{display:inline-block;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:700;text-transform:uppercase}
.rule-status.active{background:var(--ok);color:white}
.rule-status.inactive{background:var(--text-unit);color:white}
.rule-status.triggered{background:var(--warn);color:white;animation:pulse 1s infinite}
/* Smart Alerts */
.alert-panel{position:fixed;top:80px;right:20px;max-width:350px;z-index:9999}
.alert-item{background:var(--bg-container);border-radius:10px;padding:15px;margin-bottom:10px;box-shadow:var(--shadow-xl);border-left:4px solid var(--info);animation:slideInRight .3s}
.alert-item.critical{border-left-color:var(--bad)}
.alert-item.warning{border-left-color:var(--warn)}
.alert-item.info{border-left-color:var(--info)}
.alert-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.alert-title{font-weight:700;font-size:14px}
.alert-time{font-size:11px;color:var(--text-unit)}
.alert-body{font-size:13px;line-height:1.4}
.alert-actions{margin-top:10px;display:flex;gap:8px}
.alert-btn{padding:6px 12px;border:none;border-radius:6px;font-size:12px;cursor:pointer;transition:all .3s}
.alert-btn.primary{background:var(--text-accent);color:white}
.alert-btn.secondary{background:var(--bg-section);color:var(--text)}
/* Performance Monitor */
.performance-panel{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;padding:20px;margin:20px 0}
.perf-metric{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,0.1);border-radius:8px;margin:8px 0}
.perf-label{font-size:14px;opacity:0.9}
.perf-value{font-size:18px;font-weight:700}
.perf-indicator{width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:20px}
/* Advanced Export Options */
.export-format-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:20px 0}
.format-card{background:var(--bg-card);border:2px solid var(--border);border-radius:10px;padding:15px;text-align:center;cursor:pointer;transition:all .3s}
.format-card:hover{border-color:var(--text-accent);transform:scale(1.05)}
.format-icon{font-size:32px;margin-bottom:8px}
.format-name{font-weight:600;font-size:14px}
.format-desc{font-size:11px;color:var(--text-unit);margin-top:4px}
/* API Integration */
.integration-card{background:var(--bg-card);border-radius:10px;padding:20px;margin:15px 0;border:1px solid var(--border)}
.integration-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
.integration-icon{width:50px;height:50px;border-radius:10px;background:var(--text-accent);display:flex;align-items:center;justify-content:center;font-size:18px;color:white}
.integration-info{flex:1}
.integration-name{font-size:16px;font-weight:700;margin-bottom:4px}
.integration-status{font-size:12px;color:var(--text-unit)}
.integration-actions{display:flex;gap:10px}
/* Mobile Optimization */
.mobile-only{display:none}
@media(max-width:768px){
.mobile-only{display:block}
.desktop-only{display:none}
.tab-content{padding:10px}
}
/* Offline Indicator */
.offline-banner{position:fixed;top:0;left:0;right:0;background:var(--warn);color:white;padding:10px;text-align:center;font-weight:700;z-index:10000;display:none}
.offline-banner.show{display:block}
/* Loading States */
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9998;display:none;align-items:center;justify-content:center}
.loading-overlay.active{display:flex}
.loading-spinner{width:60px;height:60px;border:4px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* ENTERPRISE MAX ADDITIONAL STYLES */
.visualization-panel{background:var(--bg-card);border-radius:12px;padding:25px;margin:20px 0;box-shadow:var(--shadow-lg)}
.chart-wrapper{position:relative;height:350px;margin:20px 0}
.chart-controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
.chart-type-btn{padding:8px 16px;border:2px solid var(--border);background:var(--bg-section);border-radius:8px;cursor:pointer;transition:all .3s;font-weight:600}
.chart-type-btn:hover{border-color:var(--text-accent);transform:translateY(-2px)}
.chart-type-btn.active{background:var(--text-accent);color:white;border-color:var(--text-accent)}
.theme-selector{position:fixed;top:20px;right:20px;z-index:1000;background:var(--bg-card);padding:15px;border-radius:12px;box-shadow:var(--shadow-xl);display:none}
.theme-selector.active{display:block}
.theme-option{padding:12px 20px;margin:8px 0;border-radius:8px;cursor:pointer;transition:all .3s;border:2px solid transparent}
.theme-option:hover{border-color:var(--text-accent);transform:scale(1.05)}
.theme-preview{display:flex;gap:8px;margin-top:8px}
.theme-color{width:30px;height:30px;border-radius:50%;border:2px solid white;box-shadow:var(--shadow-md)}
.report-builder{background:var(--bg-card);border-radius:12px;padding:25px;margin:20px 0}
.report-section{border:2px dashed var(--border);border-radius:8px;padding:20px;margin:10px 0;cursor:move;transition:all .3s}
.report-section:hover{border-color:var(--text-accent);background:var(--bg-section)}
.report-section.dragging{opacity:0.5}
.widget-gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}
.widget-card{background:var(--bg-section);border:2px solid var(--border);border-radius:10px;padding:15px;text-align:center;cursor:pointer;transition:all .3s}
.widget-card:hover{border-color:var(--text-accent);transform:scale(1.05);box-shadow:var(--shadow-lg)}
.widget-icon{font-size:36px;margin-bottom:10px}
.widget-name{font-size:14px;font-weight:600}
.predictive-panel{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;padding:25px;margin:20px 0}
.prediction-card{background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border-radius:10px;padding:20px;margin:15px 0}
.prediction-value{font-size:32px;font-weight:700;margin:10px 0}
.prediction-trend{display:flex;align-items:center;gap:10px;font-size:18px;margin-top:10px}
.trend-up{color:#4ade80}
.trend-down{color:#f87171}
.trend-stable{color:#fbbf24}
.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:20px 0}
.analytics-card{background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:var(--shadow-md)}
.mini-chart{height:100px;margin-top:15px}
.theme-dark{--bg-container:#1a1a2e;--bg-card:#16213e;--bg-section:#0f3460;--bg-tabs:#0a2647;--bg-input:#16213e;--text:#e8e8e8;--text-accent:#64ffda;--text-unit:#a0aec0;--border:#2d3748;--purple:#bb86fc;--teal:#03dac6;--ok:#4ade80;--warn:#fbbf24;--bad:#f87171;--info:#60a5fa}
.theme-ocean{--bg-container:#001845;--bg-card:#023e7d;--bg-section:#0466c8;--bg-tabs:#0353a4;--bg-input:#002855;--text:#f0f4f8;--text-accent:#4cc9f0;--text-unit:#90caf9;--border:#1565c0;--purple:#7b2cbf;--teal:#06ffa5;--ok:#43a047;--warn:#ffa726;--bad:#e53935;--info:#42a5f5}
.theme-forest{--bg-container:#1b4332;--bg-card:#2d6a4f;--bg-section:#40916c;--bg-tabs:#386641;--bg-input:#1b4332;--text:#f1faee;--text-accent:#95d5b2;--text-unit:#b7e4c7;--border:#52b788;--purple:#9d4edd;--teal:#06ffa5;--ok:#52b788;--warn:#f77f00;--bad:#d62828;--info:#4ea8de}
.theme-sunset{--bg-container:#370617;--bg-card:#6a040f;--bg-section:#9d0208;--bg-tabs:#560319;--bg-input:#370617;--text:#fefae0;--text-accent:#ffba08;--text-unit:#faa307;--border:#9d0208;--purple:#d00000;--teal:#06ffa5;--ok:#52b788;--warn:#fb8500;--bad:#dc2f02;--info:#4ea8de}
.install-prompt{position:fixed;bottom:20px;right:20px;background:var(--text-accent);color:white;padding:20px;border-radius:12px;box-shadow:var(--shadow-xl);z-index:10000;max-width:300px;animation:slideInRight .5s}
.install-btn{background:white;color:var(--text-accent);padding:12px 24px;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-top:15px;width:100%;transition:all .3s}
.install-btn:hover{transform:scale(1.05);box-shadow:var(--shadow-lg)}
.collaboration-panel{background:var(--bg-card);border-radius:12px;padding:25px;margin:20px 0;border-left:4px solid var(--text-accent)}
.user-avatar{width:40px;height:40px;border-radius:50%;background:var(--text-accent);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;margin-right:10px}
.activity-feed{max-height:400px;overflow-y:auto}
.activity-item{display:flex;align-items:center;padding:12px;border-radius:8px;margin:8px 0;background:var(--bg-section);transition:all .3s}
.activity-item:hover{transform:translateX(5px);background:var(--bg-tabs)}
.activity-time{font-size:12px;color:var(--text-unit);margin-left:auto}

/* ==================== v9.6.0 ENHANCEMENTS ==================== */

/* Client Portal Mode */
.portal-mode {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-body);
  z-index: 10000;
  overflow-y: auto;
}
.portal-header {
  background: linear-gradient(135deg, #2563eb, #7c3aed);
  padding: 30px;
  color: white;
  text-align: center;
}
.portal-logo {
  font-size: 48px;
  margin-bottom: 10px;
}
.portal-card {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 24px;
  margin: 20px;
  box-shadow: var(--shadow-lg);
}
.portal-stat {
  background: linear-gradient(135deg, var(--bg-section), var(--bg-card));
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  border: 2px solid var(--border);
}
.portal-stat-value {
  font-size: 32px;
  font-weight: 800;
  color: var(--text-accent);
}
.portal-stat-label {
  font-size: 12px;
  color: var(--text-unit);
  text-transform: uppercase;
}

/* Time Tracking */
.time-tracker {
  background: linear-gradient(135deg, #0f172a, #1e293b);
  border-radius: 16px;
  padding: 24px;
  margin: 20px 0;
}
.time-display {
  font-size: 48px;
  font-weight: 800;
  font-family: 'Courier New', monospace;
  text-align: center;
  color: #4ade80;
  text-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
  margin: 20px 0;
}
.time-entry {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  margin: 10px 0;
  border-left: 4px solid var(--text-accent);
}
.time-entry:hover {
  background: rgba(255,255,255,0.1);
  transform: translateX(5px);
}
.time-entry-hours {
  font-size: 24px;
  font-weight: 700;
  color: var(--ok);
  min-width: 80px;
}
.timer-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}
.timer-btn {
  padding: 15px 30px;
  border-radius: 50px;
  border: none;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
}
.timer-btn.start {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
}
.timer-btn.stop {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}
.timer-btn.pause {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
}
.timer-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}

/* ==================== v9.9.17 NEW FEATURE STYLES ==================== */

/* Shift Logbook Styles */
.shift-log-entry {
  background: linear-gradient(135deg, #1e293b, #0f172a);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  border-left: 4px solid #3b82f6;
  transition: all 0.3s;
}
.shift-log-entry:hover {
  transform: translateX(4px);
  box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
}
.shift-log-entry.urgent { border-left-color: #ef4444; }
.shift-log-entry.warning { border-left-color: #f59e0b; }
.shift-log-entry.normal { border-left-color: #22c55e; }
.shift-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
}
.shift-badge.day { background: #fbbf24; color: #1e293b; }
.shift-badge.evening { background: #f97316; color: white; }
.shift-badge.night { background: #6366f1; color: white; }
.handoff-summary {
  background: linear-gradient(135deg, #0d9488, #14b8a6);
  border-radius: 12px;
  padding: 20px;
  margin: 16px 0;
  color: white;
}

/* Alarm Manager Styles */
.alarm-card {
  background: #1e293b;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 16px;
  transition: all 0.2s;
}
.alarm-card:hover { background: #243b55; }
.alarm-card.critical { border-left: 4px solid #ef4444; animation: pulse-alarm 2s infinite; }
.alarm-card.warning { border-left: 4px solid #f59e0b; }
.alarm-card.info { border-left: 4px solid #3b82f6; }
.alarm-card.acknowledged { opacity: 0.6; }
@keyframes pulse-alarm {
  0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
  50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
}
.alarm-priority {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  flex-shrink: 0;
}
.alarm-priority.p1 { background: #dc2626; color: white; }
.alarm-priority.p2 { background: #ea580c; color: white; }
.alarm-priority.p3 { background: #ca8a04; color: white; }
.alarm-priority.p4 { background: #3b82f6; color: white; }
.alarm-stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}

/* Energy Dashboard Styles */
.energy-gauge {
  background: linear-gradient(135deg, #0f172a, #1e293b);
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  position: relative;
}
.energy-value {
  font-size: 48px;
  font-weight: 800;
  background: linear-gradient(135deg, #22c55e, #4ade80);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}
.energy-trend-up { color: #ef4444; }
.energy-trend-down { color: #22c55e; }
.energy-bar {
  height: 20px;
  background: #1e293b;
  border-radius: 10px;
  overflow: hidden;
  margin: 8px 0;
}
.energy-bar-fill {
  height: 100%;
  border-radius: 10px;
  transition: width 0.5s ease;
}
.energy-breakdown-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 0;
  border-bottom: 1px solid #1e3a5f;
}

/* Lab Results Tracker Styles */
.lab-result-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr 1fr auto;
  gap: 16px;
  padding: 14px;
  background: #1e293b;
  border-radius: 8px;
  margin-bottom: 8px;
  align-items: center;
}
.lab-result-row:hover { background: #243b55; }
.lab-trend-indicator {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}
.lab-trend-indicator.up { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.lab-trend-indicator.down { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
.lab-trend-indicator.stable { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
.lab-alert-banner {
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: white;
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

/* Work Order Styles */
.work-order-card {
  background: #1e293b;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 12px;
  border-left: 4px solid #8b5cf6;
  transition: all 0.2s;
}
.work-order-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(139, 92, 246, 0.2);
}
.work-order-card.emergency { border-left-color: #ef4444; background: linear-gradient(90deg, rgba(239,68,68,0.1), transparent); }
.work-order-card.urgent { border-left-color: #f59e0b; }
.work-order-card.routine { border-left-color: #22c55e; }
.work-order-card.completed { opacity: 0.6; border-left-color: #64748b; }
.wo-status-badge {
  padding: 5px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
}
.wo-status-badge.open { background: #3b82f6; color: white; }
.wo-status-badge.in-progress { background: #f59e0b; color: #1e293b; }
.wo-status-badge.completed { background: #22c55e; color: white; }
.wo-status-badge.on-hold { background: #6b7280; color: white; }

/* ==================== END v9.9.17 STYLES ==================== */

/* ==================== v9.9.19 NEW FEATURE STYLES ==================== */

/* Lab Sample Tracker */
.sample-card {
  background: linear-gradient(135deg, #1e293b, #0f172a);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 10px;
  border-left: 4px solid #06b6d4;
  transition: all 0.2s;
}
.sample-card:hover { transform: translateX(4px); }
.sample-card.pending { border-left-color: #f59e0b; }
.sample-card.analyzed { border-left-color: #22c55e; }
.sample-card.overdue { border-left-color: #ef4444; animation: pulse-border 2s infinite; }
@keyframes pulse-border { 0%,100% { border-left-color: #ef4444; } 50% { border-left-color: #f87171; } }
.sample-id { font-family: monospace; background: #0f172a; padding: 2px 8px; border-radius: 4px; font-size: 11px; color: #06b6d4; }

/* Compliance Calendar */
.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  background: #1e293b;
  border-radius: 12px;
  padding: 8px;
}
.calendar-header { 
  text-align: center; 
  padding: 8px 4px; 
  font-weight: 600; 
  font-size: 11px; 
  color: #64748b;
}
.calendar-day {
  min-height: 45px;
  background: #0f172a;
  border-radius: 6px;
  padding: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
  position: relative;
}
.calendar-day:hover { background: #1e3a5f; }
.calendar-day.today { border: 2px solid #3b82f6; }
.calendar-day.has-event::after {
  content: '';
  position: absolute;
  bottom: 4px;
  left: 50%;
  transform: translateX(-50%);
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #f59e0b;
}
.calendar-day.has-deadline::after { background: #ef4444; }
.calendar-day.has-sample::after { background: #06b6d4; }
.calendar-day .day-number { font-weight: 600; color: #e2e8f0; }
.calendar-day.other-month .day-number { color: #475569; }

/* Operator Certification Tracker */
.cert-card {
  background: linear-gradient(135deg, #1e293b, #0f172a);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid #334155;
  transition: all 0.2s;
}
.cert-card:hover { border-color: #3b82f6; }
.cert-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
}
.cert-badge.valid { background: #166534; color: #4ade80; }
.cert-badge.expiring { background: #854d0e; color: #fbbf24; }
.cert-badge.expired { background: #991b1b; color: #fca5a5; }
.cert-level { 
  display: inline-block; 
  width: 28px; 
  height: 28px; 
  line-height: 28px; 
  text-align: center;
  border-radius: 50%; 
  font-weight: 800; 
  font-size: 14px;
  background: linear-gradient(135deg, #3b82f6, #1d4ed8);
  color: white;
}
.cert-progress { height: 6px; background: #1e3a5f; border-radius: 3px; overflow: hidden; margin-top: 8px; }
.cert-progress-fill { height: 100%; transition: width 0.3s; }

/* Chemical Inventory */
.chem-card {
  background: linear-gradient(135deg, #1e293b, #0f172a);
  border-radius: 12px;
  padding: 14px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 14px;
}
.chem-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
}
.chem-level { height: 8px; background: #1e3a5f; border-radius: 4px; overflow: hidden; flex: 1; }
.chem-level-fill { height: 100%; transition: width 0.3s; }
.chem-level-fill.high { background: linear-gradient(90deg, #22c55e, #16a34a); }
.chem-level-fill.medium { background: linear-gradient(90deg, #f59e0b, #d97706); }
.chem-level-fill.low { background: linear-gradient(90deg, #ef4444, #dc2626); }
.reorder-alert {
  background: linear-gradient(135deg, #7f1d1d, #991b1b);
  border: 1px solid #ef4444;
  border-radius: 8px;
  padding: 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
  animation: pulse-bg 2s infinite;
}
@keyframes pulse-bg { 0%,100% { opacity: 1; } 50% { opacity: 0.8; } }

/* Weather Integration */
.weather-widget {
  background: linear-gradient(135deg, #1e40af, #3b82f6);
  border-radius: 16px;
  padding: 20px;
  color: white;
  margin-bottom: 16px;
}
.weather-main { display: flex; align-items: center; gap: 16px; }
.weather-temp { font-size: 48px; font-weight: 700; line-height: 1; }
.weather-icon { font-size: 56px; }
.weather-forecast {
  display: flex;
  gap: 8px;
  margin-top: 16px;
  overflow-x: auto;
  padding-bottom: 8px;
}
.forecast-day {
  flex: 0 0 60px;
  background: rgba(255,255,255,0.1);
  border-radius: 12px;
  padding: 10px 8px;
  text-align: center;
}
.forecast-day .day { font-size: 11px; opacity: 0.9; }
.forecast-day .temp { font-weight: 600; margin-top: 4px; }
.forecast-day .icon { font-size: 20px; margin: 4px 0; }
.weather-impact {
  background: rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 12px;
  margin-top: 12px;
  font-size: 13px;
}
.weather-impact.warning { background: rgba(245,158,11,0.2); border: 1px solid #f59e0b; }
.weather-impact.alert { background: rgba(239,68,68,0.2); border: 1px solid #ef4444; }

/* ==================== END v9.9.19 STYLES ==================== */

/* ==================== v9.9.19 GENIUS/EXPERT/EXECUTIVE STYLES ==================== */

/* Executive Dashboard Widgets */
.exec-widget {
  background: linear-gradient(145deg, #1a1f35 0%, #0f172a 100%);
  border: 1px solid rgba(99,102,241,0.2);
  border-radius: 16px;
  padding: 24px;
  position: relative;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.exec-widget:hover {
  border-color: rgba(99,102,241,0.5);
  box-shadow: 0 20px 40px rgba(99,102,241,0.15);
  transform: translateY(-4px);
}
.exec-widget::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #6366f1, #8b5cf6, #a855f7);
}
.exec-widget-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.exec-widget-title {
  font-size: 14px;
  font-weight: 600;
  color: #94a3b8;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.exec-widget-value {
  font-size: 42px;
  font-weight: 800;
  background: linear-gradient(135deg, #f8fafc, #cbd5e1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  line-height: 1;
}
.exec-widget-trend {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
}
.exec-widget-trend.up { background: rgba(34,197,94,0.15); color: #22c55e; }
.exec-widget-trend.down { background: rgba(239,68,68,0.15); color: #ef4444; }
.exec-widget-trend.stable { background: rgba(59,130,246,0.15); color: #3b82f6; }

/* Predictive Analytics Cards */
.prediction-card {
  background: linear-gradient(135deg, rgba(139,92,246,0.1), rgba(59,130,246,0.1));
  border: 1px solid rgba(139,92,246,0.3);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
}
.prediction-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.prediction-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 16px;
  font-weight: 600;
  color: #e2e8f0;
}
.prediction-confidence {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
}
.confidence-high { background: linear-gradient(135deg, #059669, #10b981); color: white; }
.confidence-medium { background: linear-gradient(135deg, #d97706, #f59e0b); color: white; }
.confidence-low { background: linear-gradient(135deg, #dc2626, #ef4444); color: white; }
.prediction-body {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 16px;
}
.prediction-metric {
  text-align: center;
  padding: 16px;
  background: rgba(0,0,0,0.2);
  border-radius: 12px;
}
.prediction-metric-value {
  font-size: 28px;
  font-weight: 700;
  color: #f8fafc;
}
.prediction-metric-label {
  font-size: 11px;
  color: #94a3b8;
  margin-top: 4px;
  text-transform: uppercase;
}
.prediction-timeline {
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 3px;
  margin-top: 16px;
  overflow: hidden;
}
.prediction-progress {
  height: 100%;
  border-radius: 3px;
  background: linear-gradient(90deg, #8b5cf6, #6366f1);
  transition: width 0.5s ease;
}

/* Benchmarking Gauge */
.benchmark-gauge {
  width: 180px;
  height: 90px;
  position: relative;
  margin: 0 auto;
}
.benchmark-gauge-arc {
  fill: none;
  stroke-width: 12;
  stroke-linecap: round;
}
.benchmark-gauge-bg { stroke: rgba(255,255,255,0.1); }
.benchmark-gauge-fill { stroke: url(#benchmarkGradient); transition: stroke-dashoffset 1s ease; }
.benchmark-gauge-value {
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  font-size: 24px;
  font-weight: 800;
  color: #f8fafc;
}
.benchmark-gauge-label {
  text-align: center;
  margin-top: 8px;
  font-size: 12px;
  color: #94a3b8;
}

/* Scenario Planning Cards */
.scenario-card {
  background: linear-gradient(145deg, #1e293b, #0f172a);
  border: 2px solid transparent;
  border-radius: 16px;
  padding: 24px;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}
.scenario-card:hover {
  border-color: #6366f1;
  transform: scale(1.02);
}
.scenario-card.active {
  border-color: #22c55e;
  box-shadow: 0 0 30px rgba(34,197,94,0.2);
}
.scenario-card.active::after {
  content: '‚úì SELECTED';
  position: absolute;
  top: 12px;
  right: 12px;
  background: #22c55e;
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 10px;
  font-weight: 700;
}
.scenario-impact {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  margin-top: 16px;
}
.scenario-impact-item {
  text-align: center;
  padding: 12px;
  background: rgba(0,0,0,0.3);
  border-radius: 10px;
}
.scenario-impact-value {
  font-size: 20px;
  font-weight: 700;
}
.scenario-impact-value.positive { color: #22c55e; }
.scenario-impact-value.negative { color: #ef4444; }
.scenario-impact-value.neutral { color: #f59e0b; }

/* Energy Optimization Matrix */
.energy-matrix {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
  margin: 20px 0;
}
.energy-matrix-cell {
  aspect-ratio: 1;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 600;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
}
.energy-matrix-cell:hover {
  transform: scale(1.2);
  z-index: 10;
}
.energy-low { background: linear-gradient(135deg, #059669, #10b981); }
.energy-medium { background: linear-gradient(135deg, #d97706, #f59e0b); }
.energy-high { background: linear-gradient(135deg, #dc2626, #ef4444); }
.energy-peak { background: linear-gradient(135deg, #7c2d12, #9a3412); }

/* AI Insights Panel */
.ai-insight {
  background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));
  border: 1px solid rgba(139,92,246,0.3);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  position: relative;
}
.ai-insight::before {
  content: 'ü§ñ';
  position: absolute;
  top: -12px;
  left: 20px;
  font-size: 24px;
  background: #1e293b;
  padding: 0 8px;
}
.ai-insight-priority {
  position: absolute;
  top: 12px;
  right: 12px;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
}
.priority-critical { background: #dc2626; color: white; }
.priority-high { background: #f59e0b; color: white; }
.priority-medium { background: #3b82f6; color: white; }
.priority-low { background: #6b7280; color: white; }
.ai-insight-action {
  margin-top: 16px;
  padding: 12px 16px;
  background: rgba(99,102,241,0.2);
  border-radius: 10px;
  border-left: 4px solid #6366f1;
}

/* Compliance Score Ring */
.compliance-ring {
  width: 160px;
  height: 160px;
  position: relative;
  margin: 0 auto;
}
.compliance-ring-svg {
  transform: rotate(-90deg);
}
.compliance-ring-bg {
  fill: none;
  stroke: rgba(255,255,255,0.1);
  stroke-width: 12;
}
.compliance-ring-fill {
  fill: none;
  stroke-width: 12;
  stroke-linecap: round;
  transition: stroke-dashoffset 1s ease;
}
.compliance-ring-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}
.compliance-ring-value {
  font-size: 36px;
  font-weight: 800;
  color: #f8fafc;
}
.compliance-ring-label {
  font-size: 11px;
  color: #94a3b8;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Process Optimization Dial */
.optimization-dial {
  width: 200px;
  height: 200px;
  border-radius: 50%;
  background: conic-gradient(from 180deg, #ef4444 0%, #f59e0b 25%, #22c55e 50%, #22c55e 75%, #f59e0b 90%, #ef4444 100%);
  position: relative;
  margin: 0 auto;
  padding: 8px;
}
.optimization-dial-inner {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: #0f172a;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
.optimization-dial-value {
  font-size: 48px;
  font-weight: 800;
  color: #f8fafc;
}
.optimization-dial-status {
  font-size: 14px;
  font-weight: 600;
  padding: 4px 16px;
  border-radius: 12px;
  margin-top: 8px;
}
.status-optimal { background: #22c55e; color: white; }
.status-acceptable { background: #f59e0b; color: white; }
.status-critical { background: #ef4444; color: white; }

/* Data Sparkline */
.sparkline-large {
  height: 60px;
  display: flex;
  align-items: flex-end;
  gap: 3px;
}
.sparkline-bar {
  flex: 1;
  background: linear-gradient(to top, #6366f1, #818cf8);
  border-radius: 2px 2px 0 0;
  transition: height 0.3s ease;
  min-height: 4px;
}
.sparkline-bar:hover {
  background: linear-gradient(to top, #8b5cf6, #a78bfa);
}

/* Executive Summary Cards */
.exec-summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}
.exec-summary-card {
  background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
  border-radius: 20px;
  padding: 28px;
  border: 1px solid rgba(255,255,255,0.05);
  transition: all 0.3s;
}
.exec-summary-card:hover {
  border-color: rgba(99,102,241,0.3);
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}
.exec-summary-icon {
  width: 56px;
  height: 56px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  margin-bottom: 16px;
}
.exec-summary-icon.blue { background: linear-gradient(135deg, #1d4ed8, #3b82f6); }
.exec-summary-icon.green { background: linear-gradient(135deg, #059669, #10b981); }
.exec-summary-icon.purple { background: linear-gradient(135deg, #7c3aed, #8b5cf6); }
.exec-summary-icon.orange { background: linear-gradient(135deg, #d97706, #f59e0b); }
.exec-summary-icon.red { background: linear-gradient(135deg, #dc2626, #ef4444); }
.exec-summary-icon.cyan { background: linear-gradient(135deg, #0891b2, #06b6d4); }

/* Animated Status Indicators */
.status-pulse {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  display: inline-block;
  position: relative;
}
.status-pulse::before {
  content: '';
  position: absolute;
  inset: -4px;
  border-radius: 50%;
  animation: statusPulseRing 2s ease-out infinite;
}
.status-pulse.green { background: #22c55e; }
.status-pulse.green::before { border: 2px solid rgba(34,197,94,0.4); }
.status-pulse.yellow { background: #eab308; }
.status-pulse.yellow::before { border: 2px solid rgba(234,179,8,0.4); }
.status-pulse.red { background: #ef4444; }
.status-pulse.red::before { border: 2px solid rgba(239,68,68,0.4); }
@keyframes statusPulseRing {
  0% { transform: scale(1); opacity: 1; }
  100% { transform: scale(2); opacity: 0; }
}

/* Genius-Level Data Table */
.genius-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 13px;
}
.genius-table thead th {
  background: linear-gradient(135deg, #1e293b, #0f172a);
  color: #94a3b8;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 11px;
  letter-spacing: 0.5px;
  padding: 14px 16px;
  text-align: left;
  border-bottom: 2px solid rgba(99,102,241,0.3);
  position: sticky;
  top: 0;
  z-index: 10;
}
.genius-table tbody tr {
  background: rgba(255,255,255,0.02);
  transition: all 0.2s;
}
.genius-table tbody tr:hover {
  background: rgba(99,102,241,0.1);
}
.genius-table tbody td {
  padding: 14px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.05);
  color: #e2e8f0;
}
.genius-table .cell-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

/* Loading Skeleton */
.skeleton {
  background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
  background-size: 200% 100%;
  animation: skeletonShimmer 1.5s infinite;
  border-radius: 8px;
}
@keyframes skeletonShimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* ==================== END v9.9.19 STYLES ==================== */

/* AI Enhancement Panel */
.ai-enhance-panel {
  background: linear-gradient(135deg, #1e1b4b, #312e81);
  border-radius: 16px;
  padding: 24px;
  position: relative;
  overflow: hidden;
}
.ai-enhance-panel::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(139,92,246,0.3) 0%, transparent 70%);
  animation: aiGlow 3s ease-in-out infinite;
}
@keyframes aiGlow {
  0%, 100% { opacity: 0.5; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.2); }
}
.ai-suggestion {
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 20px;
  margin: 15px 0;
  border-left: 4px solid #8b5cf6;
  position: relative;
  z-index: 1;
}
.ai-suggestion-title {
  color: #c4b5fd;
  font-weight: 700;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.ai-confidence {
  display: inline-block;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  color: white;
}
.ai-action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-top: 20px;
}
.ai-action-btn {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  border: none;
  padding: 15px 20px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  text-align: center;
}
.ai-action-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
}

/* Enhanced Proposal Generator */
.proposal-preview {
  background: white;
  color: #1a1a1a;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  max-width: 800px;
  margin: 20px auto;
}
.proposal-header-logo {
  border-bottom: 3px solid #0077b6;
  padding-bottom: 20px;
  margin-bottom: 20px;
}
.proposal-section-title {
  background: linear-gradient(135deg, #0077b6, #00b4d8);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  margin: 20px 0 15px;
}
.proposal-table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
}
.proposal-table th {
  background: #f8fafc;
  padding: 12px;
  text-align: left;
  border-bottom: 2px solid #e2e8f0;
}
.proposal-table td {
  padding: 12px;
  border-bottom: 1px solid #e2e8f0;
}
.proposal-total-row {
  background: linear-gradient(135deg, #059669, #06d6a0);
  color: white;
  font-weight: 700;
}

/* Offline Mode Enhancements */
.offline-indicator {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: white;
  padding: 10px 20px;
  text-align: center;
  font-weight: 600;
  z-index: 9999;
  display: none;
}
.offline-indicator.visible {
  display: block;
  animation: slideDown 0.3s ease;
}
.sync-status {
  position: fixed;
  bottom: 80px;
  left: 20px;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  box-shadow: var(--shadow-lg);
  z-index: 1000;
}
.sync-icon {
  width: 20px;
  height: 20px;
  border: 3px solid var(--text-accent);
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
.sync-icon.synced {
  border: none;
  animation: none;
  color: var(--ok);
}
</style>




<style>
.checklist-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: #0c1929;
  border-radius: 6px;
  margin-bottom: 8px;
  cursor: pointer;
  color: #e0f2fe;
  transition: all 0.2s;
}
.checklist-item:hover {
  background: #1e3a5f;
}
.checklist-item input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}
.checklist-item input[type="checkbox"]:checked + span,
.checklist-item:has(input:checked) {
  text-decoration: line-through;
  color: #06d6a0;
}
.wizard-card:hover, .formula-card:hover {
  border-color: #4ade80 !important;
  transform: translateY(-2px);
}
</style>

</head>
<body class="theme-dark">

<div class="wrap">

<div class="sticky-header">
<header class="header" style="background:linear-gradient(135deg,#0a1628 0%,#1e3a5f 50%,#0d2137 100%);padding:16px 24px;border-bottom:1px solid rgba(56,189,248,0.2)">

<!-- Main Header Row -->
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
  
  <!-- Logo & Title Section -->
  <div style="display:flex;align-items:center;gap:16px">
    <!-- Animated Logo Container -->
    <div style="position:relative;width:52px;height:52px">
      <div style="position:absolute;inset:0;background:linear-gradient(135deg,#0ea5e9,#06b6d4,#14b8a6);border-radius:14px;animation:logoGlow 3s ease-in-out infinite"></div>
      <div style="position:absolute;inset:2px;background:linear-gradient(135deg,#0c1929,#1e3a5f);border-radius:12px;display:flex;align-items:center;justify-content:center">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="url(#logoGradient)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <defs>
            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#22d3ee"/>
              <stop offset="50%" style="stop-color:#3b82f6"/>
              <stop offset="100%" style="stop-color:#8b5cf6"/>
            </linearGradient>
          </defs>
          <!-- Water treatment plant icon -->
          <path d="M3 21h18M5 21V7l7-4 7 4v14M9 21v-6h6v6M9 9h.01M15 9h.01M9 13h.01M15 13h.01"/>
          <circle cx="12" cy="5" r="1" fill="url(#logoGradient)"/>
        </svg>
      </div>
      <!-- Pulse ring -->
      <div style="position:absolute;inset:-4px;border:2px solid rgba(34,211,238,0.3);border-radius:18px;animation:pulseRing 2s ease-out infinite"></div>
    </div>
    
    <!-- Title & Badges -->
    <div>
      <h1 style="margin:0;font-size:22px;font-weight:800;display:flex;align-items:center;gap:10px;flex-wrap:wrap;color:#f0f9ff;text-shadow:0 2px 10px rgba(0,0,0,0.3)">
        <span style="background:linear-gradient(135deg,#f0f9ff,#bae6fd);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">WWTP Command Center</span>
        <span onclick="showWhatsNew()" style="background:linear-gradient(135deg,#dc2626,#f97316);padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700;color:white;box-shadow:0 2px 8px rgba(239,68,68,0.4);cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">v9.9.27</span>
        <span onclick="showWhatsNew()" style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:4px 10px;border-radius:8px;font-size:10px;font-weight:700;color:white;cursor:pointer;animation:pulse 2s infinite;display:flex;align-items:center;gap:4px" title="Click to see new features!">
          <span>üÜï</span> What's New
        </span>
      </h1>
      <div style="display:flex;align-items:center;gap:12px;margin-top:6px">
        <!-- Live Status Indicator -->
        <div id="headerOnlineStatus" style="display:flex;align-items:center;gap:6px;background:rgba(16,185,129,0.15);border:1px solid rgba(16,185,129,0.3);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;color:#34d399">
          <span style="width:8px;height:8px;background:#10b981;border-radius:50%;animation:statusPulse 2s infinite;box-shadow:0 0 8px #10b981"></span>
          <span>Online</span>
        </div>
        <!-- Tier Badge -->
        <div style="display:flex;align-items:center;gap:6px;background:linear-gradient(135deg,rgba(139,92,246,0.2),rgba(168,85,247,0.1));border:1px solid rgba(139,92,246,0.3);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;color:#c4b5fd">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
          TIER 3 AI
        </div>
        <!-- Plant Count -->
        <div style="display:none;align-items:center;gap:6px;background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;color:#93c5fd" id="plantCountBadge">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-4H8v-2h2V9h2v2h2v2h-2v4z"/></svg>
          <span id="activePlantCount">1</span> Plant
        </div>
      </div>
    </div>
  </div>
  
  <!-- Header Controls -->
  <div class="header-controls" style="position:static;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
    
    <!-- AI Assistant Button -->
    <button class="toggle" id="aiHeaderBtn" title="AI Assistant - TIER 3 Intelligence" onclick="toggleAICopilot()" style="background:linear-gradient(135deg,#059669,#10b981);border:none;box-shadow:0 4px 12px rgba(16,185,129,0.3);position:relative">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2a4 4 0 0 1 4 4v2a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/>
        <path d="M12 12c-4 0-8 2-8 6v2h16v-2c0-4-4-6-8-6z"/>
        <circle cx="12" cy="6" r="1" fill="white"/>
      </svg>
      <span style="position:absolute;top:-2px;right:-2px;width:10px;height:10px;background:#fbbf24;border-radius:50%;border:2px solid #0c1929;animation:statusPulse 1.5s infinite"></span>
    </button>
    
    <!-- Quick Reference Button -->
    <button class="toggle" id="quickRefBtn" title="Quick Reference Library" onclick="openQuickRef()" style="background:linear-gradient(135deg,#7c3aed,#9333ea);border:none;box-shadow:0 4px 12px rgba(139,92,246,0.3)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
        <line x1="8" y1="6" x2="16" y2="6"/>
        <line x1="8" y1="10" x2="16" y2="10"/>
        <line x1="8" y1="14" x2="12" y2="14"/>
      </svg>
    </button>
    
    <!-- Unit Toggle Button -->
    <button class="toggle unit-toggle" id="unitToggleBtn" title="Toggle Imperial/Metric Units" onclick="toggleUnits()" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);border:none;box-shadow:0 4px 12px rgba(59,130,246,0.3)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        <line x1="2" y1="12" x2="22" y2="12"/>
        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
      </svg>
    </button>
    
    <!-- Notifications Button -->
    <button class="toggle" id="notifyBtn" title="Alerts & Notifications" onclick="showNotifications()" style="background:linear-gradient(135deg,#f59e0b,#d97706);border:none;box-shadow:0 4px 12px rgba(245,158,11,0.3);position:relative">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
      </svg>
      <span id="notifyBadge" style="display:none;position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;background:#ef4444;border-radius:10px;font-size:10px;font-weight:700;color:white;display:flex;align-items:center;justify-content:center;border:2px solid #0c1929">0</span>
    </button>
    
    <!-- Settings Dropdown -->
    <div style="position:relative" id="settingsDropdown">
      <button class="toggle" id="settingsBtn" title="Settings & Tools" onclick="toggleSettingsMenu()" style="background:linear-gradient(135deg,#64748b,#475569);border:none;box-shadow:0 4px 12px rgba(100,116,139,0.3)">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="3"/>
          <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
        </svg>
      </button>
      <!-- Settings Menu -->
      <div id="settingsMenu" style="display:none;position:absolute;top:calc(100% + 8px);right:0;background:linear-gradient(135deg,#1e293b,#0f172a);border:1px solid rgba(148,163,184,0.2);border-radius:12px;padding:8px;min-width:200px;box-shadow:0 10px 40px rgba(0,0,0,0.5);z-index:1000">
        <button onclick="toggleTimeTracker();toggleSettingsMenu()" style="width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;background:transparent;border:none;color:#e2e8f0;font-size:13px;cursor:pointer;border-radius:8px;text-align:left" onmouseover="this.style.background='rgba(59,130,246,0.2)'" onmouseout="this.style.background='transparent'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Time Tracker
        </button>
        <button onclick="toggleClientPortal();toggleSettingsMenu()" style="width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;background:transparent;border:none;color:#e2e8f0;font-size:13px;cursor:pointer;border-radius:8px;text-align:left" onmouseover="this.style.background='rgba(59,130,246,0.2)'" onmouseout="this.style.background='transparent'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          Client Portal
        </button>
        <button onclick="clearCacheReload();toggleSettingsMenu()" style="width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;background:transparent;border:none;color:#e2e8f0;font-size:13px;cursor:pointer;border-radius:8px;text-align:left" onmouseover="this.style.background='rgba(59,130,246,0.2)'" onmouseout="this.style.background='transparent'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          Clear Cache
        </button>
        <div style="height:1px;background:rgba(148,163,184,0.2);margin:8px 0"></div>
        <button onclick="toggleThemeWithMemory();toggleSettingsMenu()" style="width:100%;display:flex;align-items:center;gap:10px;padding:10px 12px;background:transparent;border:none;color:#e2e8f0;font-size:13px;cursor:pointer;border-radius:8px;text-align:left" onmouseover="this.style.background='rgba(59,130,246,0.2)'" onmouseout="this.style.background='transparent'">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
          <span id="themeToggleText">Light Mode</span>
        </button>
      </div>
    </div>
    
    <!-- Theme Toggle (visible) -->
    <button class="toggle" id="themeBtn" title="Toggle Dark/Light Mode" onclick="toggleThemeWithMemory()" style="background:linear-gradient(135deg,#fbbf24,#f59e0b);border:none;box-shadow:0 4px 12px rgba(251,191,36,0.3)">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" id="themeSvg">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
    </button>
    
  </div>
</div>

</header>
<!-- ========== SECTION-BASED NAVIGATION v9.9.27 ========== -->

<!-- Main Section Selector - Premium Design -->
<div id="section-selector" style="background:linear-gradient(180deg,#050810,#0a1020);padding:16px 20px;border-bottom:1px solid rgba(56,189,248,0.1)">
<div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;max-width:700px;margin:0 auto">

<button id="section-btn-executive" onclick="switchSection('executive')" class="section-btn" style="flex:1;min-width:180px;padding:0;border-radius:16px;border:2px solid #3b82f6;background:linear-gradient(145deg,#1e3a5f,#172554);cursor:pointer;display:flex;align-items:stretch;overflow:hidden;transition:all 0.3s;box-shadow:0 4px 20px rgba(59,130,246,0.2)">
<div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);padding:14px 16px;display:flex;align-items:center;justify-content:center">
<span style="font-size:24px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))">üìä</span>
</div>
<div style="flex:1;padding:12px 16px;display:flex;flex-direction:column;justify-content:center;text-align:left">
<span style="font-size:14px;font-weight:800;color:#93c5fd;letter-spacing:0.5px">EXECUTIVE</span>
<span style="font-size:10px;color:#64748b;margin-top:2px">KPIs ‚Ä¢ Reports ‚Ä¢ Overview</span>
</div>
</button>

<button id="section-btn-operations" onclick="switchSection('operations')" class="section-btn active" style="flex:1;min-width:180px;padding:0;border-radius:16px;border:2px solid #10b981;background:linear-gradient(135deg,#10b981,#059669);cursor:pointer;display:flex;align-items:stretch;overflow:hidden;transition:all 0.3s;box-shadow:0 4px 25px rgba(16,185,129,0.4)">
<div style="background:linear-gradient(135deg,#059669,#047857);padding:14px 16px;display:flex;align-items:center;justify-content:center">
<span style="font-size:24px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))">‚öôÔ∏è</span>
</div>
<div style="flex:1;padding:12px 16px;display:flex;flex-direction:column;justify-content:center;text-align:left">
<span style="font-size:14px;font-weight:800;color:white;letter-spacing:0.5px">OPERATIONS</span>
<span style="font-size:10px;color:#d1fae5;margin-top:2px">Treatment Train ‚Ä¢ Process</span>
</div>
</button>

<button id="section-btn-business" onclick="switchSection('business')" class="section-btn" style="flex:1;min-width:180px;padding:0;border-radius:16px;border:2px solid #f59e0b;background:linear-gradient(145deg,#78350f,#451a03);cursor:pointer;display:flex;align-items:stretch;overflow:hidden;transition:all 0.3s;box-shadow:0 4px 20px rgba(245,158,11,0.2)">
<div style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:14px 16px;display:flex;align-items:center;justify-content:center">
<span style="font-size:24px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))">üíº</span>
</div>
<div style="flex:1;padding:12px 16px;display:flex;flex-direction:column;justify-content:center;text-align:left">
<span style="font-size:14px;font-weight:800;color:#fcd34d;letter-spacing:0.5px">BUSINESS</span>
<span style="font-size:10px;color:#a16207;margin-top:2px">Costs ‚Ä¢ Profiles ‚Ä¢ Analysis</span>
</div>
</button>

</div>
</div>

<!-- Breadcrumb -->
<div id="nav-breadcrumb" style="background:#0a0f1a;padding:6px 16px;border-bottom:1px solid rgba(56,189,248,0.05);font-size:11px;color:#64748b">
<span style="color:#10b981">‚öôÔ∏è Operations</span> <span style="margin:0 6px">‚Ä∫</span> <span id="breadcrumb-panel" style="color:#94a3b8">Dashboard</span>
</div>

<!-- EXECUTIVE Subsection Tabs -->
<nav id="tabs-executive" class="section-tabs" role="tablist" style="display:none;background:#030608;padding:12px 16px;gap:6px;border-bottom:2px solid #3b82f6;overflow-x:auto;white-space:nowrap">
<button class="tab" data-panel="dashboard" role="tab" onclick="switchPanel('dashboard')">üìä Dashboard</button>
<button class="tab" data-panel="reports" role="tab" onclick="switchPanel('reports')">üìë Reports</button>
<button class="tab" data-panel="multiplant" role="tab" onclick="switchPanel('multiplant')">üåê Multi-Plant</button>
</nav>

<!-- OPERATIONS Subsection Tabs (Hydraulic Flow Order) -->
<nav id="tabs-operations" class="section-tabs" role="tablist" style="display:flex;background:#030608;padding:12px 16px;gap:6px;border-bottom:2px solid #10b981;overflow-x:auto;white-space:nowrap;align-items:center">
<button class="tab active" data-panel="daily-ops" role="tab" onclick="switchPanel('daily-ops')">üë∑ Daily</button>
<button class="tab" data-panel="hydraulics" role="tab" onclick="switchPanel('hydraulics')">üíß Hydro</button>
<button class="tab" data-panel="process-control" role="tab" onclick="switchPanel('process-control')">‚öôÔ∏è Process</button>
<button class="tab" data-panel="aeration" role="tab" onclick="switchPanel('aeration')">üí® Aerate</button>
<button class="tab" data-panel="reactors" role="tab" onclick="switchPanel('reactors')">üîÑ React</button>
<button class="tab" data-panel="chemicals" role="tab" onclick="switchPanel('chemicals')">‚öóÔ∏è Chem</button>
<button class="tab" data-panel="solids" role="tab" onclick="switchPanel('solids')">üóëÔ∏è Solids</button>
<button class="tab" data-panel="compliance" role="tab" onclick="switchPanel('compliance')">üìã Comply</button>
<button class="tab" data-panel="maintenance" role="tab" onclick="switchPanel('maintenance')">üîß Maint</button>
<button class="tab" data-panel="troubleshoot" role="tab" onclick="switchPanel('troubleshoot')">üîç Trouble</button>
<button class="tab" data-panel="simulations" role="tab" onclick="switchPanel('simulations')">üîÆ Sim</button>
<button class="tab" data-panel="panel-training" role="tab" onclick="switchPanel('panel-training')">üéì Train</button>
<button class="tab" data-panel="certification" role="tab" onclick="switchPanel('certification')">üìú Cert</button>
</nav>

<!-- BUSINESS Subsection Tabs -->
<nav id="tabs-business" class="section-tabs" role="tablist" style="display:none;background:#030608;padding:12px 16px;gap:6px;border-bottom:2px solid #f59e0b;overflow-x:auto;white-space:nowrap">
<button class="tab" data-panel="business" role="tab" onclick="switchPanel('business')">üí∞ Costs</button>
<button class="tab" data-panel="profiles" role="tab" onclick="switchPanel('profiles')">üè≠ Profiles</button>
<button class="tab" data-panel="wizards" role="tab" onclick="switchPanel('wizards')">üßô Wizards</button>
</nav>


<!-- Header Animation Styles -->
<style>
@keyframes logoGlow {
  0%, 100% { opacity: 1; filter: brightness(1); }
  50% { opacity: 0.8; filter: brightness(1.2); }
}
@keyframes pulseRing {
  0% { transform: scale(1); opacity: 0.6; }
  100% { transform: scale(1.3); opacity: 0; }
}
@keyframes statusPulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.6; transform: scale(0.9); }
}
.header-controls .toggle:hover {
  transform: translateY(-3px) scale(1.05) !important;
  filter: brightness(1.15);
}
.tabs .tab {
  border-radius: 8px;
  margin: 2px;
  transition: all 0.2s ease;
}
.tabs .tab:hover {
  background: rgba(56, 189, 248, 0.15);
  transform: translateY(-2px);
}
.tabs .tab.active {
  background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.2));
  border-bottom: none;
  box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
}
.tabs .tab svg {
  opacity: 0.8;
}
.tabs .tab.active svg {
  opacity: 1;
  stroke: #38bdf8;
}
</style>
</div><!-- END sticky-header -->

<div class="content">
<!-- Dashboard Panel -->
<div class="panel active" id="dashboard">
<div id="DASHBOARD_HEADER_MARKER" style="background:linear-gradient(135deg,#059669 0%,#10b981 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìä DASHBOARD</h2>
</div>

<!-- QUICK NAV CARDS - v9.9.19 -->
<div id="dashboardQuickNav" style="margin-bottom:16px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section</span>
<button onclick="document.getElementById('dashboardQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(85px, 1fr));gap:8px">
<div onclick="scrollToSection('geniusDashboardSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üß†</div>
<div style="font-size:10px;color:white;margin-top:4px">GENIUS</div>
</div>
<div onclick="scrollToSection('predictiveChartsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üîÆ</div>
<div style="font-size:10px;color:white;margin-top:4px">Predictions</div>
</div>
<div onclick="scrollToSection('alarmLogSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#ef4444,#f87171);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üö®</div>
<div style="font-size:10px;color:white;margin-top:4px">Alarms</div>
</div>
<div onclick="scrollToSection('tier3AISection')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üéØ</div>
<div style="font-size:10px;color:white;margin-top:4px">TIER 3 AI</div>
</div>
<div onclick="scrollToSection('alertSystemSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚ö†Ô∏è</div>
<div style="font-size:10px;color:white;margin-top:4px">Alerts</div>
</div>
<div onclick="scrollToSection('performanceTrendsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìà</div>
<div style="font-size:10px;color:white;margin-top:4px">Trends</div>
</div>
</div>
</div>

<div class="kpi-grid">
<div class="kpi-card" onclick="KPISparklines.showDetail('flow')">
<h4>Flow Rate</h4>
<p id="kpi-flow">3.50</p>
<div class="small">MGD</div>
<div class="sparkline-container" id="spark-flow"></div>
<div class="trend up" id="trend-flow">‚Üë 2.3%</div>
</div>
<div class="kpi-card" onclick="KPISparklines.showDetail('do')">
<h4>DO Level</h4>
<p id="kpi-do">2.1</p>
<div class="small">mg/L</div>
<div class="sparkline-container" id="spark-do"></div>
<div class="trend stable" id="trend-do">‚Üí Stable</div>
</div>
<div class="kpi-card" onclick="KPISparklines.showDetail('mlss')">
<h4>MLSS</h4>
<p id="kpi-mlss">2500</p>
<div class="small">mg/L</div>
<div class="sparkline-container" id="spark-mlss"></div>
<div class="trend up" id="trend-mlss">‚Üë Target</div>
</div>
<div class="kpi-card" onclick="KPISparklines.showDetail('fm')">
<h4>F/M Ratio</h4>
<p id="kpi-fm">0.35</p>
<div class="small">lb/lb/d</div>
<div class="sparkline-container" id="spark-fm"></div>
<div class="trend up" id="trend-fm">‚úì Optimal</div>
</div>
<div class="kpi-card" onclick="KPISparklines.showDetail('energy')">
<h4>Energy Use</h4>
<p id="kpi-energy">1850</p>
<div class="small">kWh/MG</div>
<div class="sparkline-container" id="spark-energy"></div>
<div class="trend up" id="trend-energy">‚Üì 5.2%</div>
</div>
<div class="kpi-card" onclick="KPISparklines.showDetail('cost')">
<h4>Daily Cost</h4>
<p id="kpi-cost">$4,250</p>
<div class="small">$/day</div>
<div class="sparkline-container" id="spark-cost"></div>
<div class="trend down" id="trend-cost">‚Üë 1.8%</div>
</div>
</div>

<!-- QUICK ACTION BUTTONS -->
<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:12px">
<button onclick="QuickActions.logReading()" style="flex:1;min-width:80px;padding:12px 8px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border:none;border-radius:10px;color:white;font-size:11px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:20px">üìù</span>
Log Reading
</button>
<button onclick="QuickActions.logWAS()" style="flex:1;min-width:80px;padding:12px 8px;background:linear-gradient(135deg,#8b5cf6,#6d28d9);border:none;border-radius:10px;color:white;font-size:11px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:20px">üöø</span>
Log WAS
</button>
<button onclick="QuickActions.settleometer()" style="flex:1;min-width:80px;padding:12px 8px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:10px;color:white;font-size:11px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:20px">üî¨</span>
Settleometer
</button>
<button onclick="QuickActions.reportIssue()" style="flex:1;min-width:80px;padding:12px 8px;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;border-radius:10px;color:white;font-size:11px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:20px">‚ö†Ô∏è</span>
Report Issue
</button>
<button onclick="QuickActions.shiftHandoff()" style="flex:1;min-width:80px;padding:12px 8px;background:linear-gradient(135deg,#ec4899,#be185d);border:none;border-radius:10px;color:white;font-size:11px;font-weight:600;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px">
<span style="font-size:20px">üìã</span>
Shift Handoff
</button>
</div>

<!-- ==================== GENIUS EXECUTIVE DASHBOARD v9.9.19 ==================== -->
<div class="section" id="geniusDashboardSection" style="border:2px solid #6366f1;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;display:flex;justify-content:space-between;align-items:center">
<div style="display:flex;align-items:center;gap:10px">
<span>üß† GENIUS Executive Dashboard</span>
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700">v9.9.19</span>
</div>
<button onclick="refreshGeniusDashboard()" style="background:rgba(255,255,255,0.2);border:none;padding:6px 12px;border-radius:8px;color:white;font-size:11px;cursor:pointer;font-weight:600">üîÑ Refresh</button>
</div>
<div class="section-content" style="padding:16px">

<!-- Executive Summary Row -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px">

<!-- Overall Health Score Gauge -->
<div id="geniusHealthGauge" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;text-align:center;border:1px solid rgba(99,102,241,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600">PLANT HEALTH</div>
<div style="position:relative;width:100px;height:100px;margin:0 auto">
<svg viewBox="0 0 100 100" style="transform:rotate(-90deg)">
<circle cx="50" cy="50" r="40" fill="none" stroke="#1e293b" stroke-width="10"/>
<circle id="healthCircle" cx="50" cy="50" r="40" fill="none" stroke="url(#healthGradient)" stroke-width="10" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="50"/>
<defs>
<linearGradient id="healthGradient" x1="0%" y1="0%" x2="100%" y2="0%">
<stop offset="0%" style="stop-color:#22c55e"/>
<stop offset="100%" style="stop-color:#10b981"/>
</linearGradient>
</defs>
</svg>
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center">
<div id="healthScore" style="font-size:28px;font-weight:800;color:#4ade80">87</div>
<div style="font-size:9px;color:#94a3b8">/ 100</div>
</div>
</div>
<div id="healthStatus" style="margin-top:8px;font-size:12px;color:#4ade80;font-weight:600">EXCELLENT</div>
</div>

<!-- Risk Level Indicator -->
<div id="geniusRiskIndicator" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;text-align:center;border:1px solid rgba(99,102,241,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600">RISK LEVEL</div>
<div id="riskIconContainer" style="width:80px;height:80px;margin:0 auto;background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(34,197,94,0.1));border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid #22c55e">
<span id="riskIcon" style="font-size:36px">üõ°Ô∏è</span>
</div>
<div id="riskLevel" style="margin-top:12px;font-size:16px;font-weight:700;color:#4ade80">LOW</div>
<div id="riskDetail" style="font-size:10px;color:#94a3b8;margin-top:4px">All systems nominal</div>
</div>

<!-- Compliance Status -->
<div id="geniusComplianceStatus" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;text-align:center;border:1px solid rgba(99,102,241,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600">COMPLIANCE</div>
<div style="position:relative;width:80px;height:80px;margin:0 auto">
<svg viewBox="0 0 100 100" style="transform:rotate(-90deg)">
<circle cx="50" cy="50" r="40" fill="none" stroke="#1e293b" stroke-width="8"/>
<circle id="complianceCircle" cx="50" cy="50" r="40" fill="none" stroke="#22c55e" stroke-width="8" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="12.56"/>
</svg>
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)">
<span id="complianceIcon" style="font-size:28px">‚úÖ</span>
</div>
</div>
<div id="complianceScore" style="margin-top:8px;font-size:16px;font-weight:700;color:#4ade80">95%</div>
<div id="complianceDetail" style="font-size:10px;color:#94a3b8;margin-top:2px">0 violations</div>
</div>

<!-- Projected Savings -->
<div id="geniusSavings" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;text-align:center;border:1px solid rgba(99,102,241,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600">ANNUAL SAVINGS</div>
<div style="font-size:36px;margin:12px 0">üí∞</div>
<div id="savingsAmount" style="font-size:24px;font-weight:800;color:#4ade80">$45K</div>
<div id="savingsDetail" style="font-size:10px;color:#94a3b8;margin-top:4px">vs. baseline</div>
</div>

<!-- DMR Countdown -->
<div id="geniusDMR" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;text-align:center;border:1px solid rgba(99,102,241,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600">DMR DUE</div>
<div style="font-size:36px;margin:12px 0">üìã</div>
<div id="dmrDays" style="font-size:24px;font-weight:800;color:#fbbf24">4</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">days remaining</div>
</div>

</div>

<!-- Key Insights Row -->
<div style="margin-bottom:16px">
<div style="font-size:12px;color:#94a3b8;margin-bottom:10px;font-weight:600">üí° KEY INSIGHTS</div>
<div id="geniusInsights" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:10px">
<!-- Populated by JS -->
</div>
</div>

<!-- Quick Access Cards -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px">

<div onclick="showGeniusPanel('predictive')" style="background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(168,85,247,0.1));border:1px solid rgba(139,92,246,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s;text-align:center" onmouseover="this.style.transform='translateY(-2px)';this.style.borderColor='#8b5cf6'" onmouseout="this.style.transform='translateY(0)';this.style.borderColor='rgba(139,92,246,0.3)'">
<div style="font-size:24px;margin-bottom:6px">üîÆ</div>
<div style="font-size:12px;font-weight:600;color:#c4b5fd">Predictive Engine</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">7-day forecasts</div>
</div>

<div onclick="showGeniusPanel('benchmarking')" style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(5,150,105,0.1));border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s;text-align:center" onmouseover="this.style.transform='translateY(-2px)';this.style.borderColor='#10b981'" onmouseout="this.style.transform='translateY(0)';this.style.borderColor='rgba(16,185,129,0.3)'">
<div style="font-size:24px;margin-bottom:6px">üìà</div>
<div style="font-size:12px;font-weight:600;color:#6ee7b7">Benchmarking</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">Industry ranking</div>
</div>

<div onclick="showGeniusPanel('energy')" style="background:linear-gradient(135deg,rgba(14,165,233,0.15),rgba(2,132,199,0.1));border:1px solid rgba(14,165,233,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s;text-align:center" onmouseover="this.style.transform='translateY(-2px)';this.style.borderColor='#0ea5e9'" onmouseout="this.style.transform='translateY(0)';this.style.borderColor='rgba(14,165,233,0.3)'">
<div style="font-size:24px;margin-bottom:6px">‚ö°</div>
<div style="font-size:12px;font-weight:600;color:#7dd3fc">Energy Matrix</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">Load optimization</div>
</div>

<div onclick="showGeniusPanel('compliance')" style="background:linear-gradient(135deg,rgba(236,72,153,0.15),rgba(219,39,119,0.1));border:1px solid rgba(236,72,153,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s;text-align:center" onmouseover="this.style.transform='translateY(-2px)';this.style.borderColor='#ec4899'" onmouseout="this.style.transform='translateY(0)';this.style.borderColor='rgba(236,72,153,0.3)'">
<div style="font-size:24px;margin-bottom:6px">ü§ñ</div>
<div style="font-size:12px;font-weight:600;color:#f9a8d4">Compliance AI</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">Real-time alerts</div>
</div>

<div onclick="showGeniusPanel('optimizer')" style="background:linear-gradient(135deg,rgba(34,197,94,0.15),rgba(22,163,74,0.1));border:1px solid rgba(34,197,94,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s;text-align:center" onmouseover="this.style.transform='translateY(-2px)';this.style.borderColor='#22c55e'" onmouseout="this.style.transform='translateY(0)';this.style.borderColor='rgba(34,197,94,0.3)'">
<div style="font-size:24px;margin-bottom:6px">üéØ</div>
<div style="font-size:12px;font-weight:600;color:#86efac">Process Optimizer</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">Recommendations</div>
</div>

<div onclick="showGeniusPanel('report')" style="background:linear-gradient(135deg,rgba(239,68,68,0.15),rgba(220,38,38,0.1));border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s;text-align:center" onmouseover="this.style.transform='translateY(-2px)';this.style.borderColor='#ef4444'" onmouseout="this.style.transform='translateY(0)';this.style.borderColor='rgba(239,68,68,0.3)'">
<div style="font-size:24px;margin-bottom:6px">üìë</div>
<div style="font-size:12px;font-weight:600;color:#fca5a5">Executive Report</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">One-click export</div>
</div>

</div>

</div>
</div>
<!-- ==================== END GENIUS EXECUTIVE DASHBOARD ==================== -->

<!-- ==================== PREDICTIVE ANALYTICS CHARTS v9.9.19 ==================== -->
<div class="section" id="predictiveChartsSection" style="border:2px solid #8b5cf6;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);color:white;display:flex;justify-content:space-between;align-items:center">
<div style="display:flex;align-items:center;gap:10px">
<span>üîÆ Predictive Analytics</span>
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700">GENIUS v9.9.19</span>
</div>
<button onclick="refreshPredictiveCharts()" style="background:rgba(255,255,255,0.2);border:none;padding:6px 12px;border-radius:8px;color:white;font-size:11px;cursor:pointer;font-weight:600">üîÑ Refresh</button>
</div>
<div class="section-content" style="padding:16px">

<!-- Prediction Summary Cards -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px">

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(139,92,246,0.3)">
<div style="font-size:10px;color:#94a3b8;margin-bottom:6px;font-weight:600">7-DAY BOD FORECAST</div>
<div id="predBODValue" style="font-size:28px;font-weight:800;color:#4ade80">12.5</div>
<div style="font-size:10px;color:#94a3b8">mg/L predicted</div>
<div id="predBODTrend" style="font-size:11px;color:#4ade80;margin-top:4px">‚Üì Decreasing</div>
</div>

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(139,92,246,0.3)">
<div style="font-size:10px;color:#94a3b8;margin-bottom:6px;font-weight:600">30-DAY ENERGY</div>
<div id="predEnergyValue" style="font-size:28px;font-weight:800;color:#60a5fa">52.4K</div>
<div style="font-size:10px;color:#94a3b8">kWh projected</div>
<div id="predEnergyCost" style="font-size:11px;color:#fbbf24;margin-top:4px">$4,716 cost</div>
</div>

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(139,92,246,0.3)">
<div style="font-size:10px;color:#94a3b8;margin-bottom:6px;font-weight:600">COMPLIANCE RISK</div>
<div id="predComplianceRisk" style="font-size:28px;font-weight:800;color:#4ade80">8%</div>
<div style="font-size:10px;color:#94a3b8">violation probability</div>
<div id="predComplianceStatus" style="font-size:11px;color:#4ade80;margin-top:4px">‚úì Low Risk</div>
</div>

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(139,92,246,0.3)">
<div style="font-size:10px;color:#94a3b8;margin-bottom:6px;font-weight:600">EQUIPMENT ALERT</div>
<div id="predEquipmentName" style="font-size:16px;font-weight:700;color:#fbbf24">Blower #2</div>
<div id="predEquipmentRisk" style="font-size:24px;font-weight:800;color:#fbbf24">15%</div>
<div style="font-size:10px;color:#94a3b8">failure risk</div>
</div>

</div>

<!-- Chart Tabs -->
<div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
<button onclick="showPredictiveChart('effluent')" id="chartTabEffluent" class="pred-chart-tab active" style="background:linear-gradient(135deg,#22c55e,#16a34a);border:none;color:white;padding:8px 16px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600">üß™ Effluent Quality</button>
<button onclick="showPredictiveChart('energy')" id="chartTabEnergy" class="pred-chart-tab" style="background:rgba(59,130,246,0.2);border:none;color:#93c5fd;padding:8px 16px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600">‚ö° Energy</button>
<button onclick="showPredictiveChart('compliance')" id="chartTabCompliance" class="pred-chart-tab" style="background:rgba(236,72,153,0.2);border:none;color:#f9a8d4;padding:8px 16px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600">üìã Compliance</button>
<button onclick="showPredictiveChart('equipment')" id="chartTabEquipment" class="pred-chart-tab" style="background:rgba(245,158,11,0.2);border:none;color:#fcd34d;padding:8px 16px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600">üîß Equipment</button>
</div>

<!-- Chart Container -->
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;border:1px solid rgba(139,92,246,0.3);min-height:300px">
<div id="predictiveChartTitle" style="font-size:14px;font-weight:600;color:#c4b5fd;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center">
<span>üß™ 7-Day Effluent Quality Forecast</span>
<span id="predictiveChartConfidence" style="background:rgba(34,197,94,0.2);color:#4ade80;padding:4px 10px;border-radius:6px;font-size:11px">85% Confidence</span>
</div>
<canvas id="predictiveChart" style="width:100%;max-height:250px"></canvas>
</div>

<!-- Prediction Details -->
<div id="predictionDetails" style="margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">

<div style="background:rgba(34,197,94,0.1);border-radius:10px;padding:14px;border:1px solid rgba(34,197,94,0.3)">
<div style="font-size:12px;color:#86efac;font-weight:600;margin-bottom:8px">üìà Trend Analysis</div>
<div id="predTrendText" style="font-size:13px;color:#e2e8f0;line-height:1.5">Effluent BOD showing stable performance with slight downward trend. Current trajectory maintains comfortable buffer below permit limits.</div>
</div>

<div style="background:rgba(139,92,246,0.1);border-radius:10px;padding:14px;border:1px solid rgba(139,92,246,0.3)">
<div style="font-size:12px;color:#c4b5fd;font-weight:600;margin-bottom:8px">üí° Recommendation</div>
<div id="predRecommendation" style="font-size:13px;color:#e2e8f0;line-height:1.5">Maintain current WAS rates and DO setpoints. Monitor influent loading for any significant changes that could impact predictions.</div>
</div>

</div>

</div>
</div>
<!-- ==================== END PREDICTIVE ANALYTICS CHARTS ==================== -->

<!-- ALARM HISTORY LOG -->
<div class="section" id="alarmLogSection">
<div class="section-h" style="display:flex;justify-content:space-between;align-items:center">
<span>üö® Alarm & Activity Log</span>
<button onclick="AlarmLog.showFullLog()" style="background:rgba(255,255,255,0.1);border:none;padding:4px 10px;border-radius:6px;color:var(--text-unit);font-size:11px;cursor:pointer">View All</button>
</div>
<div class="section-content" style="padding:8px">
<div id="alarmLogList" style="max-height:180px;overflow-y:auto;display:flex;flex-direction:column;gap:6px">
<!-- Alarm entries populated by JS -->
<div style="text-align:center;padding:20px;color:#64748b;font-size:13px">
<span style="font-size:24px">‚úÖ</span><br>
No recent alarms
</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">ü§ñ AI-Powered Recommendations</div>
<div class="section-content">
<div id="aiRecommendations">
<div class="note success">
<strong>‚úì Optimal Operating Conditions</strong><br>
System is running within optimal parameters. F/M ratio (0.35) and MCRT (8.2 days) are well-balanced for efficient BOD removal and nitrification.
</div>
<div class="note warning">
<strong>‚ö† Energy Optimization Opportunity</strong><br>
Consider reducing aeration by 8% during low-load periods (2AM-6AM). Potential savings: $450/month based on current energy rates.
</div>
<div class="note info">
<strong>üí° Predictive Maintenance Alert</strong><br>
Blower #2 bearing temperature trending upward. Schedule inspection within 14 days to prevent unplanned downtime.
</div>
</div>
</div>
</div>

<!-- TIER 3 AI QUICK ACCESS -->
<div class="section" id="tier3AISection">
<div class="section-h" style="background:linear-gradient(135deg,#059669,#10b981);color:white">
üß† TIER 3 AI Intelligence
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:12px;font-size:11px;margin-left:10px">NEW</span>
</div>
<div class="section-content">
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px">

<!-- Optimization Coach Card -->
<div onclick="OptimizationCoach.showDashboard()" style="background:linear-gradient(135deg,rgba(5,150,105,0.2),rgba(16,185,129,0.1));border:2px solid #059669;border-radius:16px;padding:20px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 25px rgba(5,150,105,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<span style="font-size:32px">üéØ</span>
<div>
<div style="font-weight:700;color:var(--text-section);font-size:15px">Optimization Coach</div>
<div style="font-size:12px;color:var(--text-unit)">Improve efficiency</div>
</div>
</div>
<div style="font-size:13px;color:var(--text);line-height:1.5">Get actionable recommendations to optimize energy, process efficiency, and compliance margins.</div>
<div style="margin-top:12px;font-size:12px;color:#059669;font-weight:600">Click to analyze ‚Üí</div>
</div>

<!-- Predictive Ops Card -->
<div onclick="PredictiveOps.showDashboard()" style="background:linear-gradient(135deg,rgba(124,58,237,0.2),rgba(168,85,247,0.1));border:2px solid #7c3aed;border-radius:16px;padding:20px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 25px rgba(124,58,237,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<span style="font-size:32px">üîÆ</span>
<div>
<div style="font-weight:700;color:var(--text-section);font-size:15px">Predictive Operations</div>
<div style="font-size:12px;color:var(--text-unit)">7-day forecast</div>
</div>
</div>
<div style="font-size:13px;color:var(--text);line-height:1.5">Forecast issues before they occur with AI-powered trend analysis and early warning alerts.</div>
<div style="margin-top:12px;font-size:12px;color:#7c3aed;font-weight:600">Click to forecast ‚Üí</div>
</div>

<!-- Training Mode Card -->
<div onclick="TrainingMode.showDashboard()" style="background:linear-gradient(135deg,rgba(249,115,22,0.2),rgba(251,146,60,0.1));border:2px solid #f97316;border-radius:16px;padding:20px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 25px rgba(249,115,22,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<span style="font-size:32px">üéì</span>
<div>
<div style="font-weight:700;color:var(--text-section);font-size:15px">Training Academy</div>
<div style="font-size:12px;color:var(--text-unit)">Learn & certify</div>
</div>
</div>
<div style="font-size:13px;color:var(--text);line-height:1.5">Interactive courses and quizzes covering WWTP fundamentals, process control, and troubleshooting.</div>
<div style="margin-top:12px;font-size:12px;color:#f97316;font-weight:600">Click to learn ‚Üí</div>
</div>

<!-- SOP Library Card -->
<div onclick="SOPLibrary.showDashboard()" style="background:linear-gradient(135deg,rgba(5,150,105,0.2),rgba(16,185,129,0.1));border:2px solid #059669;border-radius:16px;padding:20px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 8px 25px rgba(5,150,105,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
<span style="font-size:32px">üìñ</span>
<div>
<div style="font-weight:700;color:var(--text-section);font-size:15px">SOP Library</div>
<div style="font-size:12px;color:var(--text-unit)">Step-by-step guides</div>
</div>
</div>
<div style="font-size:13px;color:var(--text);line-height:1.5">Standard Operating Procedures for daily tasks, emergencies, and chemical handling.</div>
<div style="margin-top:12px;font-size:12px;color:#10b981;font-weight:600">Click to browse ‚Üí</div>
</div>

</div>
</div>
</div>

<!-- ALARM/ALERT SYSTEM -->
<div class="section" id="alertSystemSection">
<div class="section-h" style="background:linear-gradient(135deg,#dc2626,#ef4444);color:white">
‚ö†Ô∏è Alarm & Alert System
<div class="section-actions">
<button class="icon-btn" onclick="toggleAlertSettings()" style="background:rgba(255,255,255,0.2);color:white">‚öôÔ∏è Settings</button>
<button class="icon-btn" onclick="viewAlertHistory()" style="background:rgba(255,255,255,0.2);color:white">üìú History</button>
</div>
</div>
<div class="section-content">

<!-- Active Alerts -->
<div id="activeAlerts" style="margin-bottom:15px">
<div class="note success" id="noAlertsMsg">
<strong>‚úì All Systems Normal</strong><br>
No active alerts. All parameters within limits.
</div>
</div>

<!-- Alert Settings (hidden by default) -->
<div id="alertSettings" style="display:none;background:#1e3a5f;padding:20px;border-radius:12px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#f87171">‚öôÔ∏è Alert Thresholds</h4>
<div class="row" style="gap:12px">
<div class="input-group">
<label style="color:#fca5a5">Effluent BOD Max (mg/L)</label>
<input type="number" id="alert_bod_max" value="30" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#fca5a5">Effluent TSS Max (mg/L)</label>
<input type="number" id="alert_tss_max" value="30" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#fca5a5">Effluent NH‚ÇÉ Max (mg/L)</label>
<input type="number" id="alert_nh3_max" value="5" onchange="saveAlertSettings()">
</div>
</div>
<div class="row" style="gap:12px;margin-top:10px">
<div class="input-group">
<label style="color:#fbbf24">MLSS Min (mg/L)</label>
<input type="number" id="alert_mlss_min" value="1500" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#fbbf24">MLSS Max (mg/L)</label>
<input type="number" id="alert_mlss_max" value="4500" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#fbbf24">DO Min (mg/L)</label>
<input type="number" id="alert_do_min" value="1.0" step="0.1" onchange="saveAlertSettings()">
</div>
</div>
<div class="row" style="gap:12px;margin-top:10px">
<div class="input-group">
<label style="color:#4ade80">SVI Max</label>
<input type="number" id="alert_svi_max" value="150" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#4ade80">Flow Max (MGD)</label>
<input type="number" id="alert_flow_max" value="10" step="0.1" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#60a5fa">pH Range</label>
<div style="display:flex;gap:5px">
<input type="number" id="alert_ph_min" value="6.0" step="0.1" style="width:50%" onchange="saveAlertSettings()">
<input type="number" id="alert_ph_max" value="9.0" step="0.1" style="width:50%" onchange="saveAlertSettings()">
</div>
</div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn green" onclick="saveAlertSettings()">üíæ Save Settings</button>
<button class="btn" onclick="loadDefaultAlerts()">üîÑ Reset Defaults</button>
<button class="btn red" onclick="testAlert()">üîî Test Alert</button>
</div>
</div>

<!-- Alert History (hidden by default) -->
<div id="alertHistory" style="display:none;background:#1e3a5f;padding:20px;border-radius:12px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">üìú Alert History (Last 7 Days)</h4>
<div id="alertHistoryList" style="max-height:200px;overflow-y:auto">
<div style="padding:10px;border-bottom:1px solid #374151;display:flex;justify-content:space-between">
<span><span style="color:#4ade80">‚óè</span> System started - All clear</span>
<span style="opacity:0.7;font-size:12px">Just now</span>
</div>
</div>
<div class="btns" style="margin-top:10px">
<button class="btn gray" onclick="clearAlertHistory()">üóëÔ∏è Clear History</button>
<button class="btn blue" onclick="exportAlertHistory()">üì§ Export</button>
</div>
</div>

<!-- Quick Status Indicators -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:15px">
<div class="alert-indicator" id="ind_bod" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">BOD</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
<div class="alert-indicator" id="ind_tss" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">TSS</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
<div class="alert-indicator" id="ind_nh3" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">NH‚ÇÉ</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
<div class="alert-indicator" id="ind_do" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">DO</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
<div class="alert-indicator" id="ind_mlss" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">MLSS</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
<div class="alert-indicator" id="ind_ph" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">pH</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
</div>

</div>
</div>


<div class="section">
<div class="section-h">
üéØ Quick Actions
<div class="section-actions">
<button class="icon-btn" onclick="refreshDashboard()">üîÑ Refresh</button>
</div>
</div>
<div class="section-content">
<div class="btns">
<button class="btn gradient" onclick="calcAll()">üîÑ Calculate All</button>
<button class="btn green" onclick="runOptimization()">üöÄ Run Optimization</button>
<button class="btn purple" onclick="openAIAssistant()">ü§ñ Ask AI Assistant</button>
<button class="btn orange" onclick="predictTrends()">üîÆ Predict Trends</button>
<button class="btn teal" onclick="showCalcChains()">üîó Calc Chains</button>
<button class="btn" onclick="saveProfile()">üíæ Save Profile</button>
<button class="btn gray" onclick="loadProfile()">üìÇ Load Profile</button>
<button class="btn green" onclick="exportToExcel()">üìä Export Excel</button>
<button class="btn blue" onclick="exportFullReport()">üìë Full Report</button>
</div>
</div>
</div>
<div class="split-view">
<div class="section" id="performanceTrendsSection">
<div class="section-h">üìà Performance Trends</div>
<div class="section-content">
<div class="chart-container">
<canvas id="performanceChart"></canvas>
</div>
</div>
</div>
<div class="section">
<div class="section-h">‚ö° Energy Consumption</div>
<div class="section-content">
<div class="chart-container">
<canvas id="energyChart"></canvas>
</div>
</div>
</div>
<div class="section" id="healthScoreSection">
<div class="section-h">ü©∫ System Health Score</div>
<div class="section-content">
<div style="display:flex;gap:40px;align-items:center;justify-content:center;flex-wrap:wrap">
<div class="gauge good" id="healthGauge">
<div>
<div style="font-size:0.35em">HEALTH</div>
95
<div style="font-size:0.28em">/100</div>
</div>
</div>
<div style="flex:1;min-width:300px">
<h4 style="margin-bottom:16px">Performance Metrics</h4>
<div style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>BOD Removal</span><strong style="color:var(--ok)">95%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:95%"></div>
</div>
</div>
<div style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>TSS Removal</span><strong style="color:var(--ok)">93%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:93%"></div>
</div>
</div>
<div style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>Energy Efficiency</span><strong style="color:var(--ok)">92%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:92%"></div>
</div>
</div>
<div>
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>Compliance Score</span><strong style="color:var(--ok)">98%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:98%"></div>
</div>
</div>
</div>
</div>
</div>

<div class="note info">
<strong>‚ÑπÔ∏è Predictive Maintenance Alert</strong><br>
Blower #2 vibration trending upward. Schedule inspection within 14 days to prevent unplanned downtime.
</div>
</div>
</div>
</div><!-- END dashboard panel -->
<!-- AI Assistant Panel -->

<!-- ==================== REACTORS COMBINED PANEL ==================== -->
<div class="panel" id="reactors">
<div id="REACTORS_HEADER_MARKER" style="background:linear-gradient(135deg,#0ea5e9 0%,#38bdf8 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üîÑ REACTORS</h2>
</div>

<!-- QUICK NAV CARDS - v9.9.19 -->
<div id="reactorsQuickNav" style="margin-bottom:16px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section (SBR ‚Ä¢ MBR ‚Ä¢ MBBR)</span>
<button onclick="document.getElementById('reactorsQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(80px, 1fr));gap:8px">
<div onclick="scrollToSection('reactorMasterSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚öôÔ∏è</div>
<div style="font-size:10px;color:white;margin-top:4px">Master</div>
</div>
<div onclick="scrollToSection('sbrCycleSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#0891b2,#06b6d4);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚è±Ô∏è</div>
<div style="font-size:10px;color:white;margin-top:4px">SBR Cycle</div>
</div>
<div onclick="scrollToSection('sbrAerationSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#2563eb,#3b82f6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üí®</div>
<div style="font-size:10px;color:white;margin-top:4px">SBR Air</div>
</div>
<div onclick="scrollToSection('sbrSettlingSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚¨áÔ∏è</div>
<div style="font-size:10px;color:white;margin-top:4px">Settling</div>
</div>
<div onclick="scrollToSection('mbrFluxSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üî¨</div>
<div style="font-size:10px;color:white;margin-top:4px">MBR Flux</div>
</div>
<div onclick="scrollToSection('mbrEnergySection')" class="quick-nav-card" style="background:linear-gradient(135deg,#d97706,#f59e0b);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚ö°</div>
<div style="font-size:10px;color:white;margin-top:4px">MBR Energy</div>
</div>
<div onclick="scrollToSection('mbbrMediaSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#ea580c,#f97316);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üß´</div>
<div style="font-size:10px;color:white;margin-top:4px">MBBR</div>
</div>
<div onclick="scrollToSection('ifasSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#65a30d,#84cc16);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üîó</div>
<div style="font-size:10px;color:white;margin-top:4px">IFAS</div>
</div>
</div>
</div>

<div style="background:linear-gradient(135deg,#023e8a 0%,#023e8a 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üîÑ Advanced Reactor Systems</h2>
<p style="margin:0;opacity:0.9">SBR, MBR, and MBBR calculators and troubleshooting guides</p>
</div>

<!-- REACTOR MASTER SETTINGS -->
<div class="section" id="reactorMasterSection" style="border:3px solid #0ea5e9;box-shadow:0 0 15px rgba(14,165,233,0.3)">
<div class="section-h" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:white">
‚öôÔ∏è Reactor Master Settings
<div class="section-actions">
<button class="icon-btn" onclick="syncReactorMaster()" style="background:rgba(255,255,255,0.2);color:white">üîÑ Sync All</button>
<button class="icon-btn" onclick="saveReactorSettings()" style="background:rgba(255,255,255,0.2);color:white">üíæ Save</button>
</div>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Set master parameters for each reactor type. Values auto-sync to all related calculators.</p>

<!-- Reactor Type Tabs -->
<div style="display:flex;gap:5px;margin-bottom:20px;border-bottom:2px solid #374151;padding-bottom:10px">
<button class="btn gradient" id="rmTab_sbr" onclick="showReactorMasterTab('sbr')" style="flex:1">üîÑ SBR</button>
<button class="btn gray" id="rmTab_mbr" onclick="showReactorMasterTab('mbr')" style="flex:1">üî¨ MBR</button>
<button class="btn gray" id="rmTab_mbbr" onclick="showReactorMasterTab('mbbr')" style="flex:1">üß´ MBBR</button>
</div>

<!-- SBR Master Settings -->
<div id="reactorMaster_sbr" style="display:block">
<h4 style="margin:0 0 15px 0;color:#38bdf8">üîÑ SBR Master Parameters</h4>
<div class="row">
<div class="input-group">
<label style="color:#38bdf8">Design Flow (MGD)</label>
<input type="number" id="rm_sbr_flow" value="2.0" step="0.1" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#38bdf8">Number of Basins</label>
<input type="number" id="rm_sbr_basins" value="2" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#38bdf8">Basin Volume (MG)</label>
<input type="number" id="rm_sbr_vol" value="0.5" step="0.1" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Fill Time (min)</label>
<input type="number" id="rm_sbr_fill" value="60" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>React Time (min)</label>
<input type="number" id="rm_sbr_react" value="120" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Settle Time (min)</label>
<input type="number" id="rm_sbr_settle" value="60" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Decant Time (min)</label>
<input type="number" id="rm_sbr_decant" value="30" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Idle Time (min)</label>
<input type="number" id="rm_sbr_idle" value="30" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="rm_sbr_bod" value="200" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>TKN (mg/L)</label>
<input type="number" id="rm_sbr_tkn" value="40" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Target Eff BOD (mg/L)</label>
<input type="number" id="rm_sbr_eff_bod" value="10" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Target Eff NH‚ÇÉ (mg/L)</label>
<input type="number" id="rm_sbr_eff_nh3" value="1" onchange="syncReactorMaster()">
</div>
</div>
</div>

<!-- MBR Master Settings -->
<div id="reactorMaster_mbr">
<h4 style="margin:0 0 15px 0;color:#a78bfa">üî¨ MBR Master Parameters</h4>
<div class="row">
<div class="input-group">
<label style="color:#a78bfa">Design Flow (MGD)</label>
<input type="number" id="rm_mbr_flow" value="1.5" step="0.1" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#a78bfa">Number of Trains</label>
<input type="number" id="rm_mbr_trains" value="2" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#a78bfa">Membrane Area (ft¬≤)</label>
<input type="number" id="rm_mbr_area" value="50000" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Design Flux (gfd)</label>
<input type="number" id="rm_mbr_flux" value="12" step="0.5" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>TMP Max (psi)</label>
<input type="number" id="rm_mbr_tmp" value="8" step="0.5" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="rm_mbr_mlss" value="10000" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Backwash Freq (min)</label>
<input type="number" id="rm_mbr_bw_freq" value="10" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Backwash Duration (sec)</label>
<input type="number" id="rm_mbr_bw_dur" value="30" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>CIP Interval (days)</label>
<input type="number" id="rm_mbr_cip" value="30" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="rm_mbr_bod" value="200" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Aeration Basin Vol (MG)</label>
<input type="number" id="rm_mbr_vol" value="0.8" step="0.1" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>SRT (days)</label>
<input type="number" id="rm_mbr_srt" value="15" onchange="syncReactorMaster()">
</div>
</div>
</div>

<!-- MBBR Master Settings -->
<div id="reactorMaster_mbbr">
<h4 style="margin:0 0 15px 0;color:#4ade80">üß´ MBBR Master Parameters</h4>
<div class="row">
<div class="input-group">
<label style="color:#4ade80">Design Flow (MGD)</label>
<input type="number" id="rm_mbbr_flow" value="2.0" step="0.1" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#4ade80">Reactor Volume (MG)</label>
<input type="number" id="rm_mbbr_vol" value="0.6" step="0.1" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#4ade80">Number of Stages</label>
<input type="number" id="rm_mbbr_stages" value="2" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Media Fill (%)</label>
<input type="number" id="rm_mbbr_fill" value="50" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Media SSA (m¬≤/m¬≥)</label>
<input type="number" id="rm_mbbr_ssa" value="500" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Protected Surface (%)</label>
<input type="number" id="rm_mbbr_protected" value="67" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="rm_mbbr_bod" value="200" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>BOD Loading Rate (g/m¬≤/d)</label>
<input type="number" id="rm_mbbr_bod_rate" value="10" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>NH‚ÇÉ Loading Rate (g/m¬≤/d)</label>
<input type="number" id="rm_mbbr_nh3_rate" value="1.5" step="0.1" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Target DO (mg/L)</label>
<input type="number" id="rm_mbbr_do" value="4.0" step="0.5" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Temperature (¬∞C)</label>
<input type="number" id="rm_mbbr_temp" value="20" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Target Eff BOD (mg/L)</label>
<input type="number" id="rm_mbbr_eff_bod" value="10" onchange="syncReactorMaster()">
</div>
</div>
</div>

<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="syncReactorMaster()">üîÑ Sync to Calculators</button>
<button class="btn green" onclick="saveReactorSettings()">üíæ Save Settings</button>
<button class="btn blue" onclick="loadReactorSettings()">üìÇ Load Saved</button>
</div>
</div>
</div>

<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn gradient active" onclick="showReactorSection('sbr')" id="btn-sbr">üîÑ SBR (Sequencing Batch)</button>
<button class="btn gray" onclick="showReactorSection('mbr')" id="btn-mbr">üî¨ MBR (Membrane)</button>
<button class="btn gray" onclick="showReactorSection('mbbr')" id="btn-mbbr">üß´ MBBR (Moving Bed)</button>
</div>

<div id="reactor-sbr" style="display:block">
<!-- SBR CONTENT START -->

<!-- ==================== SBR PANEL ==================== -->
<div id="sbr-content" style="display:block">
<h2 style="margin-bottom:20px;color:var(--text-accent)">üîÑ Sequencing Batch Reactor (SBR) Analysis</h2>

<!-- SBR Cycle Time Calculator -->
<div class="section">
<div class="section-h">‚è±Ô∏è SBR Cycle Time Optimization</div>
<div class="section-content">
<div class="note info">Optimize fill, react, settle, decant, and idle phases</div>
<div class="row">
<div class="input-group"><label>Design Flow (MGD)</label><input type="number" id="sbr_flow" value="2.0" step="0.1"></div>
<div class="input-group"><label>Number of Basins</label><input type="number" id="sbr_basins" value="2"></div>
<div class="input-group"><label>Basin Volume (MG)</label><input type="number" id="sbr_vol" value="0.5" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>Fill Time (min)</label><input type="number" id="sbr_fill" value="60"></div>
<div class="input-group"><label>React Time (min)</label><input type="number" id="sbr_react" value="120"></div>
<div class="input-group"><label>Settle Time (min)</label><input type="number" id="sbr_settle" value="60"></div>
</div>
<div class="row">
<div class="input-group"><label>Decant Time (min)</label><input type="number" id="sbr_decant" value="30"></div>
<div class="input-group"><label>Idle Time (min)</label><input type="number" id="sbr_idle" value="30"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRCycle()">Calculate</button>
<button class="btn" onclick="resetSBRCycle()">Reset</button>
</div>
<div id="sbr_cycle_results"></div>
</div>
</div>

<!-- SBR Aeration Calculator -->
<div class="section">
<div class="section-h">üí® SBR Aeration & Oxygen Demand</div>
<div class="section-content">
<div class="note info">Calculate oxygen requirements for BOD and nitrogen removal</div>
<div class="row">
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="sbr_bod_in" value="200"></div>
<div class="input-group"><label>Effluent BOD (mg/L)</label><input type="number" id="sbr_bod_out" value="10"></div>
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="sbr_aer_flow" value="2.0" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>TKN (mg/L)</label><input type="number" id="sbr_tkn" value="40"></div>
<div class="input-group"><label>Effluent NH3 (mg/L)</label><input type="number" id="sbr_nh3_out" value="1"></div>
<div class="input-group"><label>React Time (hrs)</label><input type="number" id="sbr_react_hr" value="2.0" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRAeration()">Calculate</button>
<button class="btn" onclick="resetSBRAeration()">Reset</button>
</div>
<div id="sbr_aeration_results"></div>
</div>
</div>

<!-- SBR Settling Calculator -->
<div class="section">
<div class="section-h">‚¨áÔ∏è SBR Settling Performance</div>
<div class="section-content">
<div class="note info">Analyze settling characteristics and decant performance</div>
<div class="row">
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="sbr_mlss" value="3500"></div>
<div class="input-group"><label>SVI (mL/g)</label><input type="number" id="sbr_svi" value="120"></div>
<div class="input-group"><label>Basin Depth (ft)</label><input type="number" id="sbr_depth" value="15"></div>
</div>
<div class="row">
<div class="input-group"><label>Settle Time (min)</label><input type="number" id="sbr_settle_t" value="60"></div>
<div class="input-group"><label>Decant Volume (%)</label><input type="number" id="sbr_decant_pct" value="25"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRSettling()">Calculate</button>
<button class="btn" onclick="resetSBRSettling()">Reset</button>
</div>
<div id="sbr_settling_results"></div>
</div>
</div>

<!-- SBR Loading Calculator -->
<div class="section">
<div class="section-h">üìä SBR Loading Parameters</div>
<div class="section-content">
<div class="note info">Calculate F/M ratio, volumetric loading, and MLSS inventory</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="sbr_load_flow" value="2.0" step="0.1"></div>
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="sbr_load_bod" value="200"></div>
<div class="input-group"><label>Basin Volume (MG)</label><input type="number" id="sbr_load_vol" value="0.5" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="sbr_load_mlss" value="3500"></div>
<div class="input-group"><label>MLVSS/MLSS Ratio</label><input type="number" id="sbr_vss_ratio" value="0.8" step="0.05"></div>
<div class="input-group"><label>Number of Basins</label><input type="number" id="sbr_load_basins" value="2"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRLoading()">Calculate</button>
<button class="btn" onclick="resetSBRLoading()">Reset</button>
</div>
<div id="sbr_loading_results"></div>
</div>
</div>

<!-- SBR WAS Calculator -->
<div class="section">
<div class="section-h">üöø SBR Waste Sludge (WAS)</div>
<div class="section-content">
<div class="note info">Calculate waste activated sludge requirements</div>
<div class="row">
<div class="input-group"><label>Target SRT (days)</label><input type="number" id="sbr_srt" value="12"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="sbr_was_mlss" value="3500"></div>
<div class="input-group"><label>Total Basin Vol (MG)</label><input type="number" id="sbr_was_vol" value="1.0" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>Effluent TSS (mg/L)</label><input type="number" id="sbr_eff_tss" value="10"></div>
<div class="input-group"><label>Effluent Flow (MGD)</label><input type="number" id="sbr_eff_flow" value="2.0" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRWAS()">Calculate</button>
<button class="btn" onclick="resetSBRWAS()">Reset</button>
</div>
<div id="sbr_was_results"></div>
</div>
</div>

<!-- SBR Nutrient Removal Calculator -->
<div class="section">
<div class="section-h">üåø SBR Nutrient Removal (BNR)</div>
<div class="section-content">
<div class="note info">Evaluate nitrogen and phosphorus removal performance</div>
<div class="row">
<div class="input-group"><label>Influent TN (mg/L)</label><input type="number" id="sbr_tn_in" value="40"></div>
<div class="input-group"><label>Effluent TN (mg/L)</label><input type="number" id="sbr_tn_out" value="8"></div>
<div class="input-group"><label>Influent TP (mg/L)</label><input type="number" id="sbr_tp_in" value="6"></div>
</div>
<div class="row">
<div class="input-group"><label>Effluent TP (mg/L)</label><input type="number" id="sbr_tp_out" value="1"></div>
<div class="input-group"><label>Anoxic Time (min)</label><input type="number" id="sbr_anoxic" value="60"></div>
<div class="input-group"><label>Anaerobic Time (min)</label><input type="number" id="sbr_anaerobic" value="30"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRNutrient()">Calculate</button>
<button class="btn" onclick="resetSBRNutrient()">Reset</button>
</div>
<div id="sbr_nutrient_results"></div>
</div>
</div>

<!-- SBR Troubleshooting Guide -->
<div class="section">
<div class="section-h">üîß SBR Troubleshooting Guide</div>
<div class="section-content">
<div class="note info">Diagnose common SBR operational issues and get recommended solutions</div>
<div class="row">
<div class="input-group"><label>Effluent Quality Issue</label>
<select id="sbr_eff_issue">
<option value="none">None - Effluent OK</option>
<option value="high_tss">High TSS/Turbidity</option>
<option value="high_bod">High BOD</option>
<option value="high_nh3">High Ammonia</option>
<option value="high_no3">High Nitrate</option>
<option value="high_phos">High Phosphorus</option>
</select></div>
<div class="input-group"><label>Settling Problem</label>
<select id="sbr_settle_issue">
<option value="none">None - Settling OK</option>
<option value="poor">Poor Settling (High SVI)</option>
<option value="bulking">Filamentous Bulking</option>
<option value="rising">Rising Sludge</option>
<option value="pin_floc">Pin Floc</option>
<option value="foam">Excessive Foam</option>
</select></div>
</div>
<div class="row">
<div class="input-group"><label>Operational Issue</label>
<select id="sbr_op_issue">
<option value="none">None</option>
<option value="short_cycle">Insufficient Treatment Time</option>
<option value="uneven_decant">Uneven Decant</option>
<option value="carryover">Solids Carryover During Decant</option>
<option value="low_do">Low DO During React</option>
<option value="high_do">Excessive DO (Energy Waste)</option>
<option value="odor">Odor Problems</option>
</select></div>
<div class="input-group"><label>Current SVI (mL/g)</label>
<input type="number" id="sbr_diag_svi" value="150" min="50" max="400">
</div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRTroubleshoot()">üîç Diagnose & Recommend</button>
<button class="btn" onclick="resetSBRTroubleshoot()">Reset</button>
</div>
<div id="sbr_troubleshoot_results"></div>
</div>
</div>

</div>
<!-- ==================== END SBR PANEL ==================== -->
</div><!-- END reactor-sbr -->

<div id="reactor-mbr">
<!-- ==================== MBR PANEL ==================== -->
<div id="mbr-content">
<h2 style="margin-bottom:20px;color:var(--text-accent)">üî¨ Membrane Bioreactor (MBR) Analysis</h2>

<!-- MBR Flux Calculator -->
<div class="section">
<div class="section-h">üíß Membrane Flux & Permeability</div>
<div class="section-content">
<div class="note info">Calculate membrane performance and capacity</div>
<div class="row">
<div class="input-group"><label>Permeate Flow (GPM)</label><input type="number" id="mbr_perm_flow" value="500"></div>
<div class="input-group"><label>Membrane Area (sf)</label><input type="number" id="mbr_mem_area" value="50000"></div>
<div class="input-group"><label>TMP (psi)</label><input type="number" id="mbr_tmp" value="5" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>Temperature (¬∞C)</label><input type="number" id="mbr_temp" value="20"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBRFlux()">Calculate</button>
<button class="btn" onclick="resetMBRFlux()">Reset</button>
</div>
<div id="mbr_flux_results"></div>
</div>
</div>

<!-- MBR Aeration Calculator -->
<div class="section">
<div class="section-h">üí® MBR Aeration (Process + Scour)</div>
<div class="section-content">
<div class="note info">Calculate process aeration and membrane scour air requirements</div>
<div class="row">
<div class="input-group"><label>BOD Load (lb/day)</label><input type="number" id="mbr_bod_load" value="2000"></div>
<div class="input-group"><label>TKN Load (lb/day)</label><input type="number" id="mbr_tkn_load" value="400"></div>
<div class="input-group"><label>Membrane Area (sf)</label><input type="number" id="mbr_scour_area" value="50000"></div>
</div>
<div class="row">
<div class="input-group"><label>Scour Rate (SCFM/sf)</label><input type="number" id="mbr_scour_rate" value="0.03" step="0.01"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBRAeration()">Calculate</button>
<button class="btn" onclick="resetMBRAeration()">Reset</button>
</div>
<div id="mbr_aeration_results"></div>
</div>
</div>

<!-- MBR Energy Calculator -->
<div class="section">
<div class="section-h">‚ö° MBR Energy Analysis</div>
<div class="section-content">
<div class="note info">Calculate energy consumption and costs</div>
<div class="row">
<div class="input-group"><label>Permeate Pump HP</label><input type="number" id="mbr_perm_hp" value="25"></div>
<div class="input-group"><label>Blower HP</label><input type="number" id="mbr_blower_hp" value="100"></div>
<div class="input-group"><label>Hours/Day</label><input type="number" id="mbr_run_hrs" value="24"></div>
</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbr_energy_flow" value="1.0" step="0.1"></div>
<div class="input-group"><label>Electric Rate ($/kWh)</label><input type="number" id="mbr_elec_rate" value="0.10" step="0.01"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBREnergy()">Calculate</button>
<button class="btn" onclick="resetMBREnergy()">Reset</button>
</div>
<div id="mbr_energy_results"></div>
</div>
</div>



<!-- MBR Cleaning & Recovery -->
<div class="section">
<div class="section-h">üßπ MBR Cleaning & Recovery</div>
<div class="section-content">
<div class="note info">Track membrane fouling and cleaning effectiveness</div>
<div class="row">
<div class="input-group"><label>Initial Permeability (LMH/bar)</label><input type="number" id="mbr_perm_init" value="300"></div>
<div class="input-group"><label>Current Permeability (LMH/bar)</label><input type="number" id="mbr_perm_curr" value="200"></div>
<div class="input-group"><label>Days Since CIP</label><input type="number" id="mbr_days_cip" value="30"></div>
</div>
<div class="row">
<div class="input-group"><label>Post-CIP Permeability (LMH/bar)</label><input type="number" id="mbr_perm_post" value="280"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBRCleaning()">Calculate</button>
<button class="btn" onclick="resetMBRCleaning()">Reset</button>
</div>
<div id="mbr_cleaning_results"></div>
</div>
</div>

<!-- MBR Loading & SRT -->
<div class="section">
<div class="section-h">üìä MBR Loading & SRT</div>
<div class="section-content">
<div class="note info">Calculate loading rates and solids retention time</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbr_srt_flow" value="1.0" step="0.1"></div>
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="mbr_srt_bod" value="200"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="mbr_srt_mlss" value="8000"></div>
</div>
<div class="row">
<div class="input-group"><label>Reactor Volume (MG)</label><input type="number" id="mbr_srt_vol" value="0.3" step="0.1"></div>
<div class="input-group"><label>WAS Flow (GPD)</label><input type="number" id="mbr_was_flow" value="5000"></div>
<div class="input-group"><label>WAS Conc (mg/L)</label><input type="number" id="mbr_was_conc" value="10000"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBRLoading()">Calculate</button>
<button class="btn" onclick="resetMBRLoading()">Reset</button>
</div>
<div id="mbr_loading_results"></div>
</div>
</div>

<!-- MBR Troubleshooting -->
<div class="section">
<div class="section-h">üîß MBR Troubleshooting Guide</div>
<div class="section-content">
<div class="note info">Diagnose common MBR operational issues</div>
<div class="row">
<div class="input-group"><label>TMP Trend</label>
<select id="mbr_tmp_trend">
<option value="stable">Stable</option>
<option value="gradual">Gradual Increase</option>
<option value="rapid">Rapid Increase</option>
<option value="jump">Sudden Jump</option>
</select></div>
<div class="input-group"><label>Permeability Trend</label>
<select id="mbr_perm_trend">
<option value="stable">Stable</option>
<option value="declining">Declining</option>
<option value="rapid_decline">Rapid Decline</option>
</select></div>
</div>
<div class="row">
<div class="input-group"><label>Foam Present?</label>
<select id="mbr_foam">
<option value="none">None</option>
<option value="light">Light</option>
<option value="heavy">Heavy/Persistent</option>
</select></div>
<div class="input-group"><label>Permeate Quality</label>
<select id="mbr_perm_quality">
<option value="clear">Clear</option>
<option value="slight">Slight Turbidity</option>
<option value="turbid">Turbid</option>
</select></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBRTroubleshoot()">Diagnose</button>
</div>
<div id="mbr_troubleshoot_results"></div>
</div>
</div>


</div>
<!-- ==================== END MBR PANEL ==================== -->
</div><!-- END reactor-mbr -->

<div id="reactor-mbbr">
<!-- ==================== MBBR PANEL ==================== -->
<div id="mbbr-content">
<h2 style="margin-bottom:20px;color:var(--text-accent)">üß´ Moving Bed Biofilm Reactor (MBBR) Analysis</h2>

<!-- MBBR Media Calculator -->
<div class="section">
<div class="section-h">üéØ MBBR Media & Surface Area</div>
<div class="section-content">
<div class="note info">Calculate effective biofilm surface area and media requirements</div>
<div class="row">
<div class="input-group"><label>Reactor Volume (MG)</label><input type="number" id="mbbr_vol" value="0.5" step="0.1"></div>
<div class="input-group"><label>Media Fill (%)</label><input type="number" id="mbbr_fill" value="50"></div>
<div class="input-group"><label>Specific Surface Area (m¬≤/m¬≥)</label><input type="number" id="mbbr_ssa" value="500"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRMedia()">Calculate</button>
<button class="btn" onclick="resetMBBRMedia()">Reset</button>
</div>
<div id="mbbr_media_results"></div>
</div>
</div>

<!-- MBBR BOD Removal Calculator -->
<div class="section">
<div class="section-h">üî¨ MBBR BOD Removal Design</div>
<div class="section-content">
<div class="note info">Calculate surface area loading rate for BOD removal</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbbr_bod_flow" value="1.0" step="0.1"></div>
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="mbbr_bod_in" value="200"></div>
<div class="input-group"><label>Target Effluent BOD (mg/L)</label><input type="number" id="mbbr_bod_out" value="20"></div>
</div>
<div class="row">
<div class="input-group"><label>Temperature (¬∞C)</label><input type="number" id="mbbr_bod_temp" value="20"></div>
<div class="input-group"><label>SALR (g/m¬≤/d)</label><input type="number" id="mbbr_salr" value="10"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRBOD()">Calculate</button>
<button class="btn" onclick="resetMBBRBOD()">Reset</button>
</div>
<div id="mbbr_bod_results"></div>
</div>
</div>

<!-- MBBR Aeration Calculator -->
<div class="section">
<div class="section-h">üí® MBBR Aeration Requirements</div>
<div class="section-content">
<div class="note info">Calculate process and mixing air requirements</div>
<div class="row">
<div class="input-group"><label>BOD Load (lb/day)</label><input type="number" id="mbbr_aer_bod" value="1500"></div>
<div class="input-group"><label>NH3 Load (lb/day)</label><input type="number" id="mbbr_aer_nh3" value="200"></div>
<div class="input-group"><label>Media Volume (cf)</label><input type="number" id="mbbr_media_vol" value="10000"></div>
</div>
<div class="row">
<div class="input-group"><label>Mixing Air (SCFM/cf media)</label><input type="number" id="mbbr_mix_rate" value="1.0" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRAeration()">Calculate</button>
<button class="btn" onclick="resetMBBRAeration()">Reset</button>
</div>
<div id="mbbr_aeration_results"></div>
</div>
</div>



<!-- MBBR Nitrification Design -->
<div class="section">
<div class="section-h">üåø MBBR Nitrification Design</div>
<div class="section-content">
<div class="note info">Calculate surface area for ammonia removal</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbbr_nit_flow" value="1.0" step="0.1"></div>
<div class="input-group"><label>Influent NH3-N (mg/L)</label><input type="number" id="mbbr_nh3_in" value="30"></div>
<div class="input-group"><label>Effluent NH3-N (mg/L)</label><input type="number" id="mbbr_nh3_out" value="2"></div>
</div>
<div class="row">
<div class="input-group"><label>Temperature (¬∞C)</label><input type="number" id="mbbr_nit_temp" value="15"></div>
<div class="input-group"><label>DO (mg/L)</label><input type="number" id="mbbr_do" value="4"></div>
<div class="input-group"><label>SANR (g N/m¬≤/d)</label><input type="number" id="mbbr_sanr" value="1.2" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRNitrification()">Calculate</button>
<button class="btn" onclick="resetMBBRNitrification()">Reset</button>
</div>
<div id="mbbr_nit_results"></div>
</div>
</div>

<!-- MBBR Hydraulic Design -->
<div class="section">
<div class="section-h">üåä MBBR Hydraulic Design</div>
<div class="section-content">
<div class="note info">Verify hydraulic parameters and retention screens</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbbr_hyd_flow" value="1.0" step="0.1"></div>
<div class="input-group"><label>Reactor Volume (MG)</label><input type="number" id="mbbr_hyd_vol" value="0.2" step="0.1"></div>
<div class="input-group"><label>Reactor Length (ft)</label><input type="number" id="mbbr_length" value="40"></div>
</div>
<div class="row">
<div class="input-group"><label>Reactor Width (ft)</label><input type="number" id="mbbr_width" value="20"></div>
<div class="input-group"><label>Water Depth (ft)</label><input type="number" id="mbbr_wat_depth" value="15"></div>
<div class="input-group"><label>Screen Area (sf)</label><input type="number" id="mbbr_screen" value="50"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRHydraulic()">Calculate</button>
<button class="btn" onclick="resetMBBRHydraulic()">Reset</button>
</div>
<div id="mbbr_hydraulic_results"></div>
</div>
</div>

<!-- MBBR Performance Monitoring -->
<div class="section">
<div class="section-h">üìà MBBR Performance Monitoring</div>
<div class="section-content">
<div class="note info">Track and evaluate MBBR performance</div>
<div class="row">
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="mbbr_perf_bod_in" value="150"></div>
<div class="input-group"><label>Effluent BOD (mg/L)</label><input type="number" id="mbbr_perf_bod_out" value="15"></div>
<div class="input-group"><label>Influent NH3 (mg/L)</label><input type="number" id="mbbr_perf_nh3_in" value="25"></div>
</div>
<div class="row">
<div class="input-group"><label>Effluent NH3 (mg/L)</label><input type="number" id="mbbr_perf_nh3_out" value="2"></div>
<div class="input-group"><label>Active Surface Area (m¬≤)</label><input type="number" id="mbbr_perf_sa" value="5000"></div>
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbbr_perf_flow" value="1.0" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRPerformance()">Calculate</button>
<button class="btn" onclick="resetMBBRPerformance()">Reset</button>
</div>
<div id="mbbr_perf_results"></div>
</div>
</div>

<!-- MBBR IFAS Integration -->
<div class="section">
<div class="section-h">üîó IFAS (Integrated Fixed-Film Activated Sludge)</div>
<div class="section-content">
<div class="note info">Calculate combined suspended and attached growth</div>
<div class="row">
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="ifas_mlss" value="3000"></div>
<div class="input-group"><label>Reactor Volume (MG)</label><input type="number" id="ifas_vol" value="0.5" step="0.1"></div>
<div class="input-group"><label>Media Fill (%)</label><input type="number" id="ifas_fill" value="40"></div>
</div>
<div class="row">
<div class="input-group"><label>Biofilm Density (g/m¬≤)</label><input type="number" id="ifas_biofilm" value="10"></div>
<div class="input-group"><label>Media SSA (m¬≤/m¬≥)</label><input type="number" id="ifas_ssa" value="500"></div>
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="ifas_flow" value="2.0" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcIFAS()">Calculate</button>
<button class="btn" onclick="resetIFAS()">Reset</button>
</div>
<div id="ifas_results"></div>
</div>
</div>

<!-- MBBR Troubleshooting Guide -->
<div class="section">
<div class="section-h">üîß MBBR Troubleshooting Guide</div>
<div class="section-content">
<div class="note info">Diagnose common MBBR/IFAS operational issues and get recommended solutions</div>
<div class="row">
<div class="input-group"><label>Media Issue</label>
<select id="mbbr_media_issue">
<option value="none">None - Media OK</option>
<option value="clogging">Media Clogging</option>
<option value="loss">Media Loss at Screens</option>
<option value="poor_mixing">Poor Media Mixing</option>
<option value="accumulation">Media Accumulation in Corners</option>
<option value="breakage">Media Breakage</option>
</select></div>
<div class="input-group"><label>Performance Issue</label>
<select id="mbbr_perf_issue">
<option value="none">None - Performance OK</option>
<option value="low_bod">Low BOD Removal</option>
<option value="low_nh3">Low Nitrification</option>
<option value="variable">Variable Performance</option>
<option value="declining">Declining Performance Over Time</option>
</select></div>
</div>
<div class="row">
<div class="input-group"><label>Biofilm Issue</label>
<select id="mbbr_biofilm_issue">
<option value="none">None - Biofilm OK</option>
<option value="thin">Thin/Patchy Biofilm</option>
<option value="thick">Excessive Biofilm Thickness</option>
<option value="sloughing">Frequent Sloughing</option>
<option value="dark">Dark/Unhealthy Biofilm</option>
</select></div>
<div class="input-group"><label>Aeration Issue</label>
<select id="mbbr_air_issue">
<option value="none">None - Aeration OK</option>
<option value="uneven">Uneven Air Distribution</option>
<option value="low_do">Low DO Despite Aeration</option>
<option value="fouled_diff">Fouled Diffusers</option>
<option value="channeling">Air Channeling</option>
</select></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRTroubleshoot()">üîç Diagnose & Recommend</button>
<button class="btn" onclick="resetMBBRTroubleshoot()">Reset</button>
</div>
<div id="mbbr_troubleshoot_results"></div>
</div>
</div>


</div>
<!-- ==================== END MBBR PANEL ==================== -->
</div><!-- END reactor-mbbr -->
</div><!-- END reactors panel -->

<!-- ==================== TCEQ COMPLIANCE MODULE ==================== -->
<div class="panel" id="compliance">
<div id="COMPLIANCE_HEADER_MARKER" style="background:linear-gradient(135deg,#eab308 0%,#facc15 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìã COMPLIANCE & LAB</h2>
</div>

<!-- QUICK NAV CARDS - v9.9.19 -->
<div id="complianceQuickNav" style="margin-bottom:16px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section</span>
<button onclick="document.getElementById('complianceQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(85px, 1fr));gap:8px">
<div onclick="scrollToSection('comprehensiveRecsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#f59e0b,#d97706);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üéØ</div>
<div style="font-size:10px;color:white;margin-top:4px">All Recs</div>
</div>
<div onclick="scrollToSection('benchmarkingSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#10b981,#059669);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìà</div>
<div style="font-size:10px;color:white;margin-top:4px">Benchmark</div>
</div>
<div onclick="scrollToSection('labEntrySection')" class="quick-nav-card" style="background:linear-gradient(135deg,#ef4444,#f87171);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üî¨</div>
<div style="font-size:10px;color:white;margin-top:4px">Lab Entry</div>
</div>
<div onclick="scrollToSection('permitInfoSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üèõÔ∏è</div>
<div style="font-size:10px;color:white;margin-top:4px">Permit</div>
</div>
<div onclick="scrollToSection('limitsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#eab308,#facc15);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìä</div>
<div style="font-size:10px;color:white;margin-top:4px">Limits</div>
</div>
<div onclick="scrollToSection('dmrSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìù</div>
<div style="font-size:10px;color:white;margin-top:4px">DMR</div>
</div>
<div onclick="scrollToSection('violationRiskSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚ö†Ô∏è</div>
<div style="font-size:10px;color:white;margin-top:4px">Risk</div>
</div>
</div>
</div>

<!-- ==================== BENCHMARKING VISUALIZATIONS v9.9.19 ==================== -->
<div class="section" id="benchmarkingSection" style="border:2px solid #10b981;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#059669,#10b981);color:white;display:flex;justify-content:space-between;align-items:center">
<div style="display:flex;align-items:center;gap:10px">
<span>üìà Industry Benchmarking</span>
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700">GENIUS v9.9.19</span>
</div>
<button onclick="refreshBenchmarking()" style="background:rgba(255,255,255,0.2);border:none;padding:6px 12px;border-radius:8px;color:white;font-size:11px;cursor:pointer;font-weight:600">üîÑ Refresh</button>
</div>
<div class="section-content" style="padding:16px">

<!-- Overall Score & Tier -->
<div style="display:grid;grid-template-columns:1fr 2fr;gap:20px;margin-bottom:20px">

<!-- Composite Score Gauge -->
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:20px;padding:24px;text-align:center;border:1px solid rgba(16,185,129,0.3)">
<div style="font-size:12px;color:#94a3b8;margin-bottom:12px;font-weight:600">COMPOSITE BENCHMARK SCORE</div>
<div style="position:relative;width:140px;height:140px;margin:0 auto">
<svg viewBox="0 0 100 100" style="transform:rotate(-90deg)">
<circle cx="50" cy="50" r="42" fill="none" stroke="#1e293b" stroke-width="8"/>
<circle id="benchmarkScoreCircle" cx="50" cy="50" r="42" fill="none" stroke="url(#benchGradient)" stroke-width="8" stroke-linecap="round" stroke-dasharray="263.9" stroke-dashoffset="58"/>
<defs>
<linearGradient id="benchGradient" x1="0%" y1="0%" x2="100%" y2="0%">
<stop offset="0%" style="stop-color:#10b981"/>
<stop offset="100%" style="stop-color:#4ade80"/>
</linearGradient>
</defs>
</svg>
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center">
<div id="benchmarkScore" style="font-size:42px;font-weight:800;color:#4ade80">78</div>
<div style="font-size:10px;color:#94a3b8">/ 100</div>
</div>
</div>
<div id="benchmarkTier" style="margin-top:16px;background:linear-gradient(135deg,#22c55e,#16a34a);color:white;padding:8px 20px;border-radius:20px;font-size:14px;font-weight:700;display:inline-block">üèÜ Top 15%</div>
<div style="font-size:11px;color:#94a3b8;margin-top:8px">vs. similar facilities</div>
</div>

<!-- Category Breakdown -->
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:20px;padding:20px;border:1px solid rgba(16,185,129,0.3)">
<div style="font-size:12px;color:#94a3b8;margin-bottom:16px;font-weight:600">CATEGORY PERFORMANCE</div>
<div style="display:flex;flex-direction:column;gap:12px">

<div class="benchmark-category">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
<span style="font-size:12px;color:#e2e8f0">üß™ BOD Removal Efficiency</span>
<span id="benchBOD" style="font-size:14px;font-weight:700;color:#4ade80">92%</span>
</div>
<div style="background:rgba(0,0,0,0.3);border-radius:6px;height:8px;overflow:hidden">
<div id="benchBODBar" style="background:linear-gradient(90deg,#22c55e,#4ade80);height:100%;width:92%;border-radius:6px;transition:width 0.5s"></div>
</div>
</div>

<div class="benchmark-category">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
<span style="font-size:12px;color:#e2e8f0">üî¨ TSS Removal Efficiency</span>
<span id="benchTSS" style="font-size:14px;font-weight:700;color:#4ade80">88%</span>
</div>
<div style="background:rgba(0,0,0,0.3);border-radius:6px;height:8px;overflow:hidden">
<div id="benchTSSBar" style="background:linear-gradient(90deg,#22c55e,#4ade80);height:100%;width:88%;border-radius:6px;transition:width 0.5s"></div>
</div>
</div>

<div class="benchmark-category">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
<span style="font-size:12px;color:#e2e8f0">‚ö° Energy Efficiency</span>
<span id="benchEnergy" style="font-size:14px;font-weight:700;color:#fbbf24">68%</span>
</div>
<div style="background:rgba(0,0,0,0.3);border-radius:6px;height:8px;overflow:hidden">
<div id="benchEnergyBar" style="background:linear-gradient(90deg,#f59e0b,#fbbf24);height:100%;width:68%;border-radius:6px;transition:width 0.5s"></div>
</div>
</div>

<div class="benchmark-category">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
<span style="font-size:12px;color:#e2e8f0">üß´ SRT Management</span>
<span id="benchSRT" style="font-size:14px;font-weight:700;color:#4ade80">82%</span>
</div>
<div style="background:rgba(0,0,0,0.3);border-radius:6px;height:8px;overflow:hidden">
<div id="benchSRTBar" style="background:linear-gradient(90deg,#22c55e,#4ade80);height:100%;width:82%;border-radius:6px;transition:width 0.5s"></div>
</div>
</div>

<div class="benchmark-category">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
<span style="font-size:12px;color:#e2e8f0">üåÄ Settling Performance</span>
<span id="benchSettling" style="font-size:14px;font-weight:700;color:#4ade80">85%</span>
</div>
<div style="background:rgba(0,0,0,0.3);border-radius:6px;height:8px;overflow:hidden">
<div id="benchSettlingBar" style="background:linear-gradient(90deg,#22c55e,#4ade80);height:100%;width:85%;border-radius:6px;transition:width 0.5s"></div>
</div>
</div>

</div>
</div>

</div>

<!-- Radar Chart & Comparison -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:20px">

<!-- Radar Chart -->
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;border:1px solid rgba(16,185,129,0.3)">
<div style="font-size:12px;color:#94a3b8;margin-bottom:12px;font-weight:600">üìä PERFORMANCE RADAR</div>
<canvas id="benchmarkRadarChart" style="width:100%;max-height:220px"></canvas>
</div>

<!-- Industry Comparison -->
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;border:1px solid rgba(16,185,129,0.3)">
<div style="font-size:12px;color:#94a3b8;margin-bottom:12px;font-weight:600">üè≠ INDUSTRY COMPARISON</div>
<div style="display:flex;flex-direction:column;gap:12px">

<div style="display:flex;align-items:center;gap:12px;padding:10px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
<div style="width:40px;height:40px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üèÜ</div>
<div style="flex:1">
<div style="font-size:13px;font-weight:600;color:#4ade80">Your Plant</div>
<div style="font-size:11px;color:#94a3b8">Score: 78 | Rank: Top 15%</div>
</div>
</div>

<div style="display:flex;align-items:center;gap:12px;padding:10px;background:rgba(59,130,246,0.1);border-radius:10px;border:1px solid rgba(59,130,246,0.3)">
<div style="width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#2563eb);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üìä</div>
<div style="flex:1">
<div style="font-size:13px;font-weight:600;color:#60a5fa">Industry Average</div>
<div style="font-size:11px;color:#94a3b8">Score: 65 | Median performer</div>
</div>
</div>

<div style="display:flex;align-items:center;gap:12px;padding:10px;background:rgba(139,92,246,0.1);border-radius:10px;border:1px solid rgba(139,92,246,0.3)">
<div style="width:40px;height:40px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">‚≠ê</div>
<div style="flex:1">
<div style="font-size:13px;font-weight:600;color:#a78bfa">Top Performer</div>
<div style="font-size:11px;color:#94a3b8">Score: 95 | Best in class</div>
</div>
</div>

<div style="display:flex;align-items:center;gap:12px;padding:10px;background:rgba(245,158,11,0.1);border-radius:10px;border:1px solid rgba(245,158,11,0.3)">
<div style="width:40px;height:40px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">üìà</div>
<div style="flex:1">
<div style="font-size:13px;font-weight:600;color:#fbbf24">Improvement Potential</div>
<div style="font-size:11px;color:#94a3b8">+17 points to reach top tier</div>
</div>
</div>

</div>
</div>

</div>

<!-- Improvement Recommendations -->
<div style="background:linear-gradient(135deg,rgba(16,185,129,0.1),rgba(5,150,105,0.05));border-radius:16px;padding:20px;border:1px solid rgba(16,185,129,0.3)">
<div style="font-size:12px;color:#6ee7b7;margin-bottom:12px;font-weight:600">üí° IMPROVEMENT OPPORTUNITIES</div>
<div id="benchmarkRecommendations" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px">

<div style="background:rgba(0,0,0,0.2);border-radius:12px;padding:14px;border-left:4px solid #f59e0b">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span style="font-size:13px;font-weight:600;color:#fcd34d">‚ö° Energy Efficiency</span>
<span style="background:rgba(245,158,11,0.2);color:#fbbf24;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600">+12 pts possible</span>
</div>
<p style="font-size:12px;color:#cbd5e1;margin:0;line-height:1.5">Optimize DO setpoints and implement load shifting to reach 80th percentile.</p>
</div>

<div style="background:rgba(0,0,0,0.2);border-radius:12px;padding:14px;border-left:4px solid #3b82f6">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span style="font-size:13px;font-weight:600;color:#93c5fd">üß´ SRT Optimization</span>
<span style="background:rgba(59,130,246,0.2);color:#60a5fa;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600">+5 pts possible</span>
</div>
<p style="font-size:12px;color:#cbd5e1;margin:0;line-height:1.5">Fine-tune WAS rates to maintain SRT in 8-12 day optimal range for your loading.</p>
</div>

<div style="background:rgba(0,0,0,0.2);border-radius:12px;padding:14px;border-left:4px solid #22c55e">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span style="font-size:13px;font-weight:600;color:#86efac">üî¨ TSS Performance</span>
<span style="background:rgba(34,197,94,0.2);color:#4ade80;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600">On track</span>
</div>
<p style="font-size:12px;color:#cbd5e1;margin:0;line-height:1.5">Current performance is strong. Maintain clarifier operations and monitor SVI.</p>
</div>

</div>
</div>

</div>
</div>
<!-- ==================== END BENCHMARKING VISUALIZATIONS ==================== -->

<!-- ==================== COMPREHENSIVE RECOMMENDATIONS v9.9.19 ==================== -->
<div class="section" id="comprehensiveRecsSection" style="border:2px solid #f59e0b;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white;display:flex;justify-content:space-between;align-items:center">
<div style="display:flex;align-items:center;gap:10px">
<span>üéØ Comprehensive Recommendations</span>
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700">ALL GENIUS SYSTEMS</span>
</div>
<button onclick="generateComprehensiveRecs()" style="background:rgba(255,255,255,0.2);border:none;padding:6px 12px;border-radius:8px;color:white;font-size:11px;cursor:pointer;font-weight:600">üîÑ Analyze All</button>
</div>
<div class="section-content" style="padding:16px">

<!-- Summary Stats -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:20px">

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(239,68,68,0.3)">
<div style="font-size:10px;color:#94a3b8;margin-bottom:4px;font-weight:600">CRITICAL</div>
<div id="recsCriticalCount" style="font-size:32px;font-weight:800;color:#f87171">2</div>
<div style="font-size:10px;color:#fca5a5">Immediate action</div>
</div>

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(245,158,11,0.3)">
<div style="font-size:10px;color:#94a3b8;margin-bottom:4px;font-weight:600">HIGH PRIORITY</div>
<div id="recsHighCount" style="font-size:32px;font-weight:800;color:#fbbf24">5</div>
<div style="font-size:10px;color:#fcd34d">This week</div>
</div>

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(59,130,246,0.3)">
<div style="font-size:10px;color:#94a3b8;margin-bottom:4px;font-weight:600">MEDIUM</div>
<div id="recsMediumCount" style="font-size:32px;font-weight:800;color:#60a5fa">8</div>
<div style="font-size:10px;color:#93c5fd">This month</div>
</div>

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(34,197,94,0.3)">
<div style="font-size:10px;color:#94a3b8;margin-bottom:4px;font-weight:600">TOTAL SAVINGS</div>
<div id="recsTotalSavings" style="font-size:28px;font-weight:800;color:#4ade80">$85K</div>
<div style="font-size:10px;color:#86efac">Annual potential</div>
</div>

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(139,92,246,0.3)">
<div style="font-size:10px;color:#94a3b8;margin-bottom:4px;font-weight:600">SOURCES</div>
<div id="recsSourceCount" style="font-size:32px;font-weight:800;color:#a78bfa">8</div>
<div style="font-size:10px;color:#c4b5fd">GENIUS systems</div>
</div>

</div>

<!-- Category Tabs -->
<div style="display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap">
<button onclick="filterCompRecs('all')" id="compRecTabAll" class="comp-rec-tab" style="background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:white;padding:8px 14px;border-radius:8px;font-size:11px;cursor:pointer;font-weight:600">üìã All (15)</button>
<button onclick="filterCompRecs('compliance')" id="compRecTabCompliance" class="comp-rec-tab" style="background:rgba(236,72,153,0.2);border:none;color:#f9a8d4;padding:8px 14px;border-radius:8px;font-size:11px;cursor:pointer;font-weight:600">üìã Compliance</button>
<button onclick="filterCompRecs('process')" id="compRecTabProcess" class="comp-rec-tab" style="background:rgba(34,197,94,0.2);border:none;color:#86efac;padding:8px 14px;border-radius:8px;font-size:11px;cursor:pointer;font-weight:600">‚öôÔ∏è Process</button>
<button onclick="filterCompRecs('energy')" id="compRecTabEnergy" class="comp-rec-tab" style="background:rgba(59,130,246,0.2);border:none;color:#93c5fd;padding:8px 14px;border-radius:8px;font-size:11px;cursor:pointer;font-weight:600">‚ö° Energy</button>
<button onclick="filterCompRecs('maintenance')" id="compRecTabMaintenance" class="comp-rec-tab" style="background:rgba(245,158,11,0.2);border:none;color:#fcd34d;padding:8px 14px;border-radius:8px;font-size:11px;cursor:pointer;font-weight:600">üîß Maintenance</button>
<button onclick="filterCompRecs('cost')" id="compRecTabCost" class="comp-rec-tab" style="background:rgba(139,92,246,0.2);border:none;color:#c4b5fd;padding:8px 14px;border-radius:8px;font-size:11px;cursor:pointer;font-weight:600">üí∞ Cost</button>
</div>

<!-- Recommendations List -->
<div id="comprehensiveRecsList" style="display:flex;flex-direction:column;gap:12px;max-height:600px;overflow-y:auto">
<!-- Populated by JS -->
</div>

<!-- Action Plan Summary -->
<div style="margin-top:20px;background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(217,119,6,0.05));border-radius:16px;padding:20px;border:1px solid rgba(245,158,11,0.3)">
<div style="font-size:14px;font-weight:600;color:#fcd34d;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center">
<span>üìÖ 30-DAY ACTION PLAN</span>
<button onclick="exportActionPlan()" style="background:rgba(245,158,11,0.2);border:none;color:#fbbf24;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600">üì§ Export Plan</button>
</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">

<div style="background:rgba(239,68,68,0.1);border-radius:12px;padding:14px;border:1px solid rgba(239,68,68,0.3)">
<div style="font-size:12px;color:#fca5a5;font-weight:600;margin-bottom:10px">üö® WEEK 1: CRITICAL</div>
<div id="actionWeek1" style="font-size:12px;color:#e2e8f0;line-height:1.6">
‚Ä¢ Address compliance alerts<br>
‚Ä¢ Check equipment warnings<br>
‚Ä¢ Review safety issues
</div>
</div>

<div style="background:rgba(245,158,11,0.1);border-radius:12px;padding:14px;border:1px solid rgba(245,158,11,0.3)">
<div style="font-size:12px;color:#fcd34d;font-weight:600;margin-bottom:10px">‚ö° WEEK 2: HIGH PRIORITY</div>
<div id="actionWeek2" style="font-size:12px;color:#e2e8f0;line-height:1.6">
‚Ä¢ Optimize DO setpoints<br>
‚Ä¢ Schedule PM for Blower #2<br>
‚Ä¢ Review chemical dosing
</div>
</div>

<div style="background:rgba(59,130,246,0.1);border-radius:12px;padding:14px;border:1px solid rgba(59,130,246,0.3)">
<div style="font-size:12px;color:#93c5fd;font-weight:600;margin-bottom:10px">üìä WEEK 3: OPTIMIZATION</div>
<div id="actionWeek3" style="font-size:12px;color:#e2e8f0;line-height:1.6">
‚Ä¢ Implement load shifting<br>
‚Ä¢ Fine-tune WAS rates<br>
‚Ä¢ Update SOP documentation
</div>
</div>

<div style="background:rgba(34,197,94,0.1);border-radius:12px;padding:14px;border:1px solid rgba(34,197,94,0.3)">
<div style="font-size:12px;color:#86efac;font-weight:600;margin-bottom:10px">‚úÖ WEEK 4: VERIFICATION</div>
<div id="actionWeek4" style="font-size:12px;color:#e2e8f0;line-height:1.6">
‚Ä¢ Validate improvements<br>
‚Ä¢ Update benchmarks<br>
‚Ä¢ Prepare monthly report
</div>
</div>

</div>

</div>

<!-- Quick Actions -->
<div class="btns" style="margin-top:16px">
<button class="btn gradient" onclick="generateComprehensiveRecs()" style="background:linear-gradient(135deg,#f59e0b,#d97706)">üîÑ Refresh All Analysis</button>
<button class="btn blue" onclick="exportComprehensiveRecs()">üìÑ Export Full Report</button>
<button class="btn purple" onclick="showRecsSummaryModal()">üìä View Summary</button>
</div>

</div>
</div>
<!-- ==================== END COMPREHENSIVE RECOMMENDATIONS ==================== -->

<div style="background:linear-gradient(135deg,#023e8a 0%,#0077b6 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìã TCEQ Compliance & Laboratory Module</h2>
<p style="margin:0;opacity:0.9">Permit Tracking, DMR Preparation, Sample Entry & QA/QC</p>
</div>

<!-- LAB: Sample Entry (merged from Laboratory) -->
<div class="section" id="labEntrySection">
<div class="section-h" style="background:linear-gradient(135deg,#ef4444,#f87171);color:white">üî¨ Laboratory Sample Entry</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sample Date</label><input type="date" id="lab_date"></div>
<div class="input-group"><label>Sample Location</label>
<select id="lab_location">
<option value="inf">Influent</option>
<option value="pe">Primary Effluent</option>
<option value="mlss">MLSS</option>
<option value="ras">RAS</option>
<option value="eff">Final Effluent</option>
</select>
</div>
<div class="input-group"><label>Sampler</label><input type="text" id="lab_sampler" placeholder="Initials"></div>
</div>
<div class="row">
<div class="input-group"><label>BOD (mg/L)</label><input type="number" id="lab_bod" step="1"></div>
<div class="input-group"><label>TSS (mg/L)</label><input type="number" id="lab_tss" step="1"></div>
<div class="input-group"><label>NH3-N (mg/L)</label><input type="number" id="lab_nh3" step="0.1"></div>
<div class="input-group"><label>TP (mg/L)</label><input type="number" id="lab_tp" step="0.1"></div>
<div class="input-group"><label>pH</label><input type="number" id="lab_ph" step="0.1" min="0" max="14"></div>
<div class="input-group"><label>DO (mg/L)</label><input type="number" id="lab_do" step="0.1"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="saveLabResult()">üíæ Save Result</button>
<button class="btn blue" onclick="viewLabHistory()">üìä View History</button>
</div>
</div>
</div>

<!-- Permit Information -->
<div class="section">
<div class="section-h">üèõÔ∏è Permit Information</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Permit Number</label><input type="text" id="tceq_permit_num" placeholder="WQ0012345000"></div>
<div class="input-group"><label>Facility Name</label><input type="text" id="tceq_facility" placeholder="North Regional WWTP"></div>
<div class="input-group"><label>Permitted Flow (MGD)</label><input type="number" id="tceq_permitted_flow" value="5.0" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>Permit Effective Date</label><input type="date" id="tceq_eff_date"></div>
<div class="input-group"><label>Permit Expiration Date</label><input type="date" id="tceq_exp_date"></div>
<div class="input-group"><label>Outfall Number</label><input type="text" id="tceq_outfall" value="001"></div>
</div>
<div class="btns">
<button class="btn green" onclick="savePermitInfo()">üíæ Save Permit Info</button>
<button class="btn blue" onclick="loadPermitInfo()">üìÇ Load Saved</button>
</div>
</div>
</div>

<!-- Permit Limits -->
<div class="section">
<div class="section-h">üìä Effluent Limits & Monitoring</div>
<div class="section-content">
<div class="note info">Enter your TPDES permit limits. System will track compliance and alert on exceedances.</div>
<table class="table" style="margin-top:15px">
<thead>
<tr style="background:var(--bg-table-th)">
<th>Parameter</th>
<th>Daily Max</th>
<th>Weekly Avg</th>
<th>Monthly Avg</th>
<th>Units</th>
<th>Current Value</th>
<th>Status</th>
</tr>
</thead>
<tbody id="tceq_limits_table">
<tr>
<td><strong>BOD‚ÇÖ</strong></td>
<td><input type="number" id="lim_bod_daily" value="45" style="width:70px"></td>
<td><input type="number" id="lim_bod_weekly" value="30" style="width:70px"></td>
<td><input type="number" id="lim_bod_monthly" value="20" style="width:70px"></td>
<td>mg/L</td>
<td><input type="number" id="cur_bod" value="12" style="width:70px"></td>
<td><span class="status ok" id="stat_bod">‚úì OK</span></td>
</tr>
<tr>
<td><strong>TSS</strong></td>
<td><input type="number" id="lim_tss_daily" value="45" style="width:70px"></td>
<td><input type="number" id="lim_tss_weekly" value="30" style="width:70px"></td>
<td><input type="number" id="lim_tss_monthly" value="20" style="width:70px"></td>
<td>mg/L</td>
<td><input type="number" id="cur_tss" value="15" style="width:70px"></td>
<td><span class="status ok" id="stat_tss">‚úì OK</span></td>
</tr>
<tr>
<td><strong>NH‚ÇÉ-N</strong></td>
<td><input type="number" id="lim_nh3_daily" value="6" style="width:70px"></td>
<td><input type="number" id="lim_nh3_weekly" value="4" style="width:70px"></td>
<td><input type="number" id="lim_nh3_monthly" value="2" style="width:70px"></td>
<td>mg/L</td>
<td><input type="number" id="cur_nh3" value="1.5" style="width:70px" step="0.1"></td>
<td><span class="status ok" id="stat_nh3">‚úì OK</span></td>
</tr>
<tr>
<td><strong>E. coli</strong></td>
<td><input type="number" id="lim_ecoli_daily" value="394" style="width:70px"></td>
<td>-</td>
<td><input type="number" id="lim_ecoli_monthly" value="126" style="width:70px"></td>
<td>MPN/100mL</td>
<td><input type="number" id="cur_ecoli" value="45" style="width:70px"></td>
<td><span class="status ok" id="stat_ecoli">‚úì OK</span></td>
</tr>
<tr>
<td><strong>DO</strong></td>
<td colspan="3"><input type="number" id="lim_do_min" value="4.0" style="width:70px" step="0.1"> mg/L minimum</td>
<td>mg/L</td>
<td><input type="number" id="cur_do" value="6.5" style="width:70px" step="0.1"></td>
<td><span class="status ok" id="stat_do">‚úì OK</span></td>
</tr>
<tr>
<td><strong>pH</strong></td>
<td colspan="3"><input type="number" id="lim_ph_min" value="6.0" style="width:50px" step="0.1"> - <input type="number" id="lim_ph_max" value="9.0" style="width:50px" step="0.1"></td>
<td>S.U.</td>
<td><input type="number" id="cur_ph" value="7.2" style="width:70px" step="0.1"></td>
<td><span class="status ok" id="stat_ph">‚úì OK</span></td>
</tr>
<tr>
<td><strong>Total P</strong></td>
<td><input type="number" id="lim_tp_daily" value="2" style="width:70px" step="0.1"></td>
<td><input type="number" id="lim_tp_weekly" value="1.5" style="width:70px" step="0.1"></td>
<td><input type="number" id="lim_tp_monthly" value="1" style="width:70px" step="0.1"></td>
<td>mg/L</td>
<td><input type="number" id="cur_tp" value="0.8" style="width:70px" step="0.1"></td>
<td><span class="status ok" id="stat_tp">‚úì OK</span></td>
</tr>
</tbody>
</table>
<div class="btns" style="margin-top:15px">
<button class="btn green" onclick="checkCompliance()">‚úÖ Check Compliance</button>
<button class="btn orange" onclick="saveLimits()">üíæ Save Limits</button>
</div>
</div>
</div>

<!-- DMR Generator -->
<div class="section">
<div class="section-h">üìù DMR (Discharge Monitoring Report) Generator</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Reporting Period</label>
<select id="dmr_period">
<option value="monthly">Monthly</option>
<option value="quarterly">Quarterly</option>
</select></div>
<div class="input-group"><label>Month</label>
<select id="dmr_month">
<option value="1">January</option><option value="2">February</option><option value="3">March</option>
<option value="4">April</option><option value="5">May</option><option value="6">June</option>
<option value="7">July</option><option value="8">August</option><option value="9">September</option>
<option value="10">October</option><option value="11">November</option><option value="12">December</option>
</select></div>
<div class="input-group"><label>Year</label><input type="number" id="dmr_year" value="2025"></div>
</div>
<div id="dmr_data_entry" style="margin-top:15px">
<h4 style="margin-bottom:10px">Daily Monitoring Data Entry</h4>
<div style="max-height:300px;overflow-y:auto;background:#1a2744;padding:15px;border-radius:8px">
<table class="table" id="dmr_daily_table">
<thead>
<tr><th>Date</th><th>Flow (MGD)</th><th>BOD (mg/L)</th><th>TSS (mg/L)</th><th>NH3 (mg/L)</th><th>pH</th><th>DO (mg/L)</th></tr>
</thead>
<tbody id="dmr_daily_body">
</tbody>
</table>
</div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn purple" onclick="generateDMRTable()">üìã Generate Data Table</button>
<button class="btn green" onclick="calculateDMRStats()">üìä Calculate Statistics</button>
<button class="btn blue" onclick="exportDMR()">üì§ Export DMR Data</button>
</div>
<div id="dmr_results" style="margin-top:15px"></div>
</div>
</div>

<!-- Compliance Calendar -->
<div class="section">
<div class="section-h">üìÖ Compliance Calendar & Deadlines</div>
<div class="section-content">
<div class="kpi-grid">
<div class="kpi-card" style="border-left:4px solid #ef4444">
<h4>DMR Due</h4>
<p id="next_dmr_due">Jan 25, 2025</p>
<div class="small">Monthly Report</div>
</div>
<div class="kpi-card" style="border-left:4px solid #ffd166">
<h4>Permit Expires</h4>
<p id="permit_exp_display">Dec 31, 2027</p>
<div class="small">Renewal Required</div>
</div>
<div class="kpi-card" style="border-left:4px solid #06d6a0">
<h4>Days Compliant</h4>
<p id="days_compliant">365</p>
<div class="small">This Year</div>
</div>
<div class="kpi-card" style="border-left:4px solid #0077b6">
<h4>Violations YTD</h4>
<p id="violations_ytd">0</p>
<div class="small">Year to Date</div>
</div>
</div>
<div id="upcoming_deadlines" style="margin-top:20px">
<h4>Upcoming Deadlines</h4>
<div style="background:#1a2744;padding:15px;border-radius:8px;margin-top:10px">
<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #374151">
<span>üìã December DMR Submission</span>
<span style="color:#ffd166">Due: Jan 25, 2025</span>
</div>
<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #374151">
<span>üî¨ Quarterly Biomonitoring (WET Test)</span>
<span style="color:#ffd166">Due: Jan 31, 2025</span>
</div>
<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #374151">
<span>üìä Annual Sludge Report</span>
<span style="color:#0077b6">Due: Feb 19, 2025</span>
</div>
<div style="display:flex;justify-content:space-between;padding:10px 0">
<span>üèõÔ∏è Permit Renewal Application</span>
<span style="color:#0077b6">Due: Jun 30, 2027</span>
</div>
</div>
</div>
</div>

<!-- LAB: QA/QC Status (merged from Laboratory) -->
<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#ef4444,#f87171);color:white">‚úÖ Laboratory QA/QC Status</div>
<div class="section-content">
<div class="kpi-grid">
<div class="kpi-card"><h4>Duplicates</h4><p style="color:#4ade80">98.5%</p><small>RPD < 20%</small></div>
<div class="kpi-card"><h4>Blanks</h4><p style="color:#4ade80">Pass</p><small>All < MDL</small></div>
<div class="kpi-card"><h4>Standards</h4><p style="color:#4ade80">99.2%</p><small>Recovery</small></div>
<div class="kpi-card"><h4>Hold Times</h4><p style="color:#4ade80">100%</p><small>Compliance</small></div>
</div>
</div>
</div>

</div>
</div><!-- END compliance panel -->
<!-- ==================== END TCEQ COMPLIANCE ==================== -->

<!-- ==================== PLANT PROFILES PANEL ==================== -->
<div class="panel" id="profiles">
<div id="PROFILES_HEADER_MARKER" style="background:linear-gradient(135deg,#7c3aed 0%,#a855f7 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üè≠ PLANT PROFILES</h2>
</div>

<!-- Master Settings Section -->
<div class="section" style="background:linear-gradient(135deg,#059669,#06d6a0);border-radius:12px;margin-bottom:20px">
<div class="section-h" style="color:white;font-size:18px;font-weight:bold">
üéõÔ∏è Master Settings - Auto-Populate All Calculators
</div>
<div class="section-content" style="background:rgba(0,0,0,0.2);border-radius:0 0 12px 12px">
<div class="note" style="background:rgba(255,255,255,0.1);border-left-color:#4ade80;color:white;margin-bottom:15px">
Set master values below. When you save a profile, these values are stored. When you load a profile, these auto-populate.
</div>
<div class="row" style="gap:15px">
<div class="input-group">
<label style="color:#a7f3d0">Flow Rate (MGD)</label>
<input id="masterFlow" type="number" step="0.1" value="5.0" onchange="syncMasterSettings()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">Aeration Volume (MG)</label>
<input id="masterAerVol" type="number" step="0.1" value="1.0" onchange="syncMasterSettings()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">BOD (mg/L)</label>
<input id="masterBOD" type="number" step="1" value="200" onchange="syncMasterSettings()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">MLSS (mg/L)</label>
<input id="masterMLSS" type="number" step="100" value="3000" onchange="syncMasterSettings()" style="font-size:16px;font-weight:bold">
</div>
</div>
<div class="btns" style="margin-top:15px;gap:10px">
<button onclick="syncMasterSettings()" class="btn" style="background:#047857;color:white;font-weight:bold">üì° Sync to All Calculators</button>
<button onclick="syncAndCalculateAll()" class="btn" style="background:#fbbf24;color:#1e3a5f;font-weight:bold">‚ö° Sync & Calculate All</button>
</div>
</div>
</div>

<!-- Save/Load Profiles Section -->
<div class="section" style="background:linear-gradient(135deg,#7c3aed,#a855f7);border-radius:12px;margin-bottom:20px">
<div class="section-h" style="color:white;font-size:18px;font-weight:bold">
üìÇ Save & Load Plant Profiles
</div>
<div class="section-content" style="background:rgba(0,0,0,0.2);border-radius:0 0 12px 12px">
<div class="note" style="background:rgba(255,255,255,0.1);border-left-color:#c4b5fd;color:white;margin-bottom:15px">
Save plant configurations for different clients. Load a profile to auto-populate all values instantly.
</div>

<!-- Profile Selection -->
<div class="row" style="gap:15px;margin-bottom:15px">
<div class="input-group" style="flex:2">
<label style="color:#e9d5ff">üìÇ Select Profile</label>
<select id="profileSelect" onchange="previewProfile()" style="font-size:16px;font-weight:bold;padding:12px">
<option value="">-- Select a Plant Profile --</option>
</select>
</div>
<div class="input-group" style="flex:1">
<label style="color:#e9d5ff">Actions</label>
<div style="display:flex;gap:8px">
<button onclick="loadSelectedProfile()" class="btn" style="background:#10b981;color:white;flex:1;font-weight:bold">üì• Load</button>
<button onclick="deleteSelectedProfile()" class="btn" style="background:#ef4444;color:white;flex:1">üóëÔ∏è</button>
</div>
</div>
</div>

<!-- Save New Profile -->
<div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;margin-bottom:15px">
<div style="font-weight:bold;margin-bottom:12px;color:#e9d5ff">üíæ Save Current Values as New Profile</div>
<div class="row" style="gap:15px">
<div class="input-group" style="flex:2">
<label style="color:#e9d5ff">Profile Name</label>
<input id="newProfileName" type="text" placeholder="e.g., ABC Corp WWTP, City Plant #2" style="font-size:16px">
</div>
<div class="input-group" style="flex:1">
<label style="color:#e9d5ff">&nbsp;</label>
<button onclick="saveNewProfile()" class="btn" style="background:#fbbf24;color:#1e3a5f;font-weight:bold;width:100%">üíæ Save Profile</button>
</div>
</div>
</div>

<!-- Profile Preview -->
<div id="profilePreview" style="display:none;background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;margin-bottom:15px">
<div style="font-weight:bold;margin-bottom:10px;color:#fbbf24">üìã Profile Preview</div>
<div id="profilePreviewContent" style="font-size:14px;line-height:1.8"></div>
</div>

</div>
</div>

<!-- Extended Profile Parameters Section -->
<div class="section">
<div class="section-h">‚öôÔ∏è Extended Profile Parameters</div>
<div class="section-content">
<div class="note">Optional details for each plant profile. These are saved with the profile.</div>

<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label>Plant Name</label>
<input id="profilePlantName" type="text" placeholder="Full plant name">
</div>
<div class="input-group">
<label>Client/Owner</label>
<input id="profileClient" type="text" placeholder="Client name">
</div>
<div class="input-group">
<label>Permit #</label>
<input id="profilePermit" type="text" placeholder="TPDES/NPDES #">
</div>
</div>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label>Design Flow (MGD)</label>
<input id="profileDesignFlow" type="number" step="0.1" placeholder="Design capacity">
</div>
<div class="input-group">
<label>Process Type</label>
<select id="profileProcessType">
<option value="conv_as">Conventional AS</option>
<option value="ext_aer">Extended Aeration</option>
<option value="sbr">SBR</option>
<option value="mbr">MBR</option>
<option value="mbbr">MBBR</option>
<option value="oxidation_ditch">Oxidation Ditch</option>
<option value="trickling">Trickling Filter</option>
<option value="lagoon">Lagoon</option>
<option value="other">Other</option>
</select>
</div>
<div class="input-group">
<label># of Clarifiers</label>
<input id="profileClarifiers" type="number" step="1" placeholder="2">
</div>
</div>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label>Clarifier Diameter (ft)</label>
<input id="profileClarifierDia" type="number" step="1" placeholder="60">
</div>
<div class="input-group">
<label>SWD (ft)</label>
<input id="profileSWD" type="number" step="0.5" placeholder="12">
</div>
<div class="input-group">
<label>Target SRT (days)</label>
<input id="profileTargetSRT" type="number" step="1" placeholder="10">
</div>
</div>
<div class="input-group">
<label>Notes</label>
<textarea id="profileNotes" rows="3" placeholder="Additional notes about this plant..." style="width:100%;resize:vertical"></textarea>
</div>

</div>
</div>

<!-- Import/Export Section -->
<div class="section">
<div class="section-h">üì§ Import & Export Profiles</div>
<div class="section-content">
<div class="note">Backup your profiles or transfer them between devices.</div>
<div class="btns" style="gap:10px;flex-wrap:wrap">
<button onclick="exportProfiles()" class="btn" style="background:#0ea5e9;color:white">üì§ Export All Profiles</button>
<button onclick="importProfiles()" class="btn" style="background:#8b5cf6;color:white">üì• Import Profiles</button>
<button onclick="showProfileCount()" class="btn" style="background:#6b7280;color:white">üìä Profile Stats</button>
</div>
<input type="file" id="profileImportFile" accept=".json" onchange="handleProfileImport(event)">
</div>
</div>

</div>
<!-- END PROFILES PANEL -->

<!-- ==================== BUSINESS COMBINED PANEL ==================== -->
<div class="panel" id="business">
<div id="BUSINESS_HEADER_MARKER" style="background:linear-gradient(135deg,#ec4899 0%,#f472b6 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üíº BUSINESS</h2>
</div>

<!-- QUICK NAV CARDS - v9.9.19 -->
<div id="businessQuickNav" style="margin-bottom:16px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section</span>
<button onclick="document.getElementById('businessQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(85px, 1fr));gap:8px">
<div onclick="showBusinessSection('clients')" class="quick-nav-card" style="background:linear-gradient(135deg,#ec4899,#f472b6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üë•</div>
<div style="font-size:10px;color:white;margin-top:4px">Clients</div>
</div>
<div onclick="showBusinessSection('proposals')" class="quick-nav-card" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìù</div>
<div style="font-size:10px;color:white;margin-top:4px">Proposals</div>
</div>
<div onclick="showBusinessSection('roi')" class="quick-nav-card" style="background:linear-gradient(135deg,#22c55e,#4ade80);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üíµ</div>
<div style="font-size:10px;color:white;margin-top:4px">ROI Calc</div>
</div>
<div onclick="showBusinessSection('scenarios')" class="quick-nav-card" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üéØ</div>
<div style="font-size:10px;color:white;margin-top:4px">Scenarios</div>
</div>
<div onclick="showBusinessSection('costcalc')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üí∞</div>
<div style="font-size:10px;color:white;margin-top:4px">Cost Calc</div>
</div>
<div onclick="showBusinessSection('timetracking')" class="quick-nav-card" style="background:linear-gradient(135deg,#f97316,#fb923c);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚è±Ô∏è</div>
<div style="font-size:10px;color:white;margin-top:4px">Time Track</div>
</div>
</div>
</div>

<div style="background:linear-gradient(135deg,#0096c7 0%,#48cae4 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üíº Business & Consulting Tools</h2>
<p style="margin:0;opacity:0.9">Client management, proposals, and ROI analysis for your consulting practice</p>
</div>

<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn gradient" onclick="showBusinessSection('clients')" id="btn-clients">üë• Clients & Projects</button>
<button class="btn blue" onclick="showBusinessSection('proposals')" id="btn-proposals">üìù Proposal Generator</button>
<button class="btn green" onclick="showBusinessSection('roi')" id="btn-roi">üíµ ROI Calculator</button>
<button class="btn orange" onclick="showBusinessSection('timetracking')" id="btn-timetracking">‚è±Ô∏è Time Tracking</button>
<button class="btn purple" onclick="showBusinessSection('ai-enhance')" id="btn-ai">ü§ñ AI Enhancement</button>
<button class="btn" onclick="showBusinessSection('costcalc')" id="btn-costcalc" style="background:linear-gradient(135deg,#059669,#10b981);color:white">üí∞ Cost Calculator</button>
<button class="btn" onclick="showBusinessSection('sheets')" id="btn-sheets" style="background:linear-gradient(135deg,#34a853,#4285f4);color:white">üìä Google Sheets Sync</button>
<button class="btn" onclick="showBusinessSection('serviceprop')" id="btn-serviceprop" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white">üìã Service Proposal</button>
<button class="btn" onclick="showBusinessSection('scenarios')" id="btn-scenarios" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);color:white">üéØ Scenario Planning</button>
</div>

<!-- ==================== SCENARIO PLANNING ENGINE v9.9.19 ==================== -->
<div id="biz-scenarios" style="display:none">
<div class="section" id="scenarioPlanningSection" style="border:2px solid #f59e0b">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white">
üéØ Scenario Planning Engine
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.19</span>
</div>
<div class="section-content">
<p style="margin:0 0 20px 0;opacity:0.8;font-size:14px">Evaluate strategic capital projects with NPV/ROI analysis. Select scenarios to compare combined impacts.</p>

<!-- Scenario Summary KPIs -->
<div class="kpi-grid" style="margin-bottom:24px">
<div class="kpi-card" style="border-left:4px solid #f59e0b">
<h4>üìä Scenarios</h4>
<p id="scenarioCount">6</p>
<small style="color:#f59e0b">Available</small>
</div>
<div class="kpi-card" style="border-left:4px solid #22c55e">
<h4>üí∞ Best ROI</h4>
<p id="bestROI">3.7 yrs</p>
<small style="color:#22c55e">Energy Opt.</small>
</div>
<div class="kpi-card" style="border-left:4px solid #3b82f6">
<h4>üìà Highest NPV</h4>
<p id="highestNPV">$850K</p>
<small style="color:#3b82f6">Capacity Exp.</small>
</div>
<div class="kpi-card" style="border-left:4px solid #8b5cf6">
<h4>üéØ Selected</h4>
<p id="selectedScenarios">0</p>
<small style="color:#8b5cf6">For comparison</small>
</div>
</div>

<!-- Scenario Cards Grid -->
<div id="scenarioCardsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:24px">

<!-- Scenario 1: Capacity Expansion -->
<div class="scenario-card" id="scenario-capacity-expansion" onclick="toggleScenarioSelection('capacity-expansion')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid transparent;border-radius:16px;padding:24px;cursor:pointer;transition:all 0.3s;position:relative">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
<div style="width:48px;height:48px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">üìà</div>
<div>
<h4 style="margin:0;color:#f8fafc;font-size:16px">Capacity Expansion</h4>
<p style="margin:4px 0 0 0;font-size:12px;color:#94a3b8">5 MGD ‚Üí 7.5 MGD (+50%)</p>
</div>
</div>
<p style="font-size:13px;color:#cbd5e1;margin-bottom:16px">Expand plant capacity to meet projected growth. Includes new clarifier, aeration upgrades, and headworks improvements.</p>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
<div style="text-align:center;padding:12px;background:rgba(59,130,246,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#60a5fa">$2.5M</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">CAPITAL</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(239,68,68,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#f87171">+$180K</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ANNUAL OPEX</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(34,197,94,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#4ade80">8 yrs</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ROI PERIOD</div>
</div>
</div>
<div style="margin-top:12px;padding:10px;background:rgba(59,130,246,0.1);border-radius:8px;font-size:11px;color:#93c5fd">
<strong>Timeline:</strong> 18-24 months | <strong>NPV:</strong> $850,000 | <strong>Risk:</strong> Low
</div>
</div>

<!-- Scenario 2: Energy Optimization -->
<div class="scenario-card" id="scenario-energy-optimization" onclick="toggleScenarioSelection('energy-optimization')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid transparent;border-radius:16px;padding:24px;cursor:pointer;transition:all 0.3s;position:relative">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
<div style="width:48px;height:48px;background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">‚ö°</div>
<div>
<h4 style="margin:0;color:#f8fafc;font-size:16px">Energy Optimization</h4>
<p style="margin:4px 0 0 0;font-size:12px;color:#94a3b8">VFDs + Advanced Controls</p>
</div>
</div>
<p style="font-size:13px;color:#cbd5e1;margin-bottom:16px">Implement VFDs on blowers/pumps and advanced DO control. Projected 22% energy reduction with fast payback.</p>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
<div style="text-align:center;padding:12px;background:rgba(34,197,94,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#4ade80">$350K</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">CAPITAL</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(34,197,94,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#4ade80">-$95K</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ANNUAL SAVINGS</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(34,197,94,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#4ade80">3.7 yrs</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ROI PERIOD</div>
</div>
</div>
<div style="margin-top:12px;padding:10px;background:rgba(34,197,94,0.1);border-radius:8px;font-size:11px;color:#86efac">
<strong>Timeline:</strong> 6-9 months | <strong>NPV:</strong> $420,000 | <strong>Risk:</strong> None
</div>
</div>

<!-- Scenario 3: Enhanced Nutrient Removal -->
<div class="scenario-card" id="scenario-nutrient-removal" onclick="toggleScenarioSelection('nutrient-removal')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid transparent;border-radius:16px;padding:24px;cursor:pointer;transition:all 0.3s;position:relative">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
<div style="width:48px;height:48px;background:linear-gradient(135deg,#10b981,#059669);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">üåø</div>
<div>
<h4 style="margin:0;color:#f8fafc;font-size:16px">Enhanced Nutrient Removal</h4>
<p style="margin:4px 0 0 0;font-size:12px;color:#94a3b8">BNR for N & P Removal</p>
</div>
</div>
<p style="font-size:13px;color:#cbd5e1;margin-bottom:16px">Add biological nutrient removal capability. Includes anoxic zones, internal recycle, and chemical P removal backup.</p>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
<div style="text-align:center;padding:12px;background:rgba(16,185,129,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#34d399">$1.8M</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">CAPITAL</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(239,68,68,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#f87171">+$120K</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ANNUAL OPEX</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(245,158,11,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#fbbf24">12 yrs</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ROI PERIOD</div>
</div>
</div>
<div style="margin-top:12px;padding:10px;background:rgba(16,185,129,0.1);border-radius:8px;font-size:11px;color:#6ee7b7">
<strong>Timeline:</strong> 12-18 months | <strong>NPV:</strong> $280,000 | <strong>Risk:</strong> Low (startup)
</div>
</div>

<!-- Scenario 4: SCADA & Automation -->
<div class="scenario-card" id="scenario-automation-upgrade" onclick="toggleScenarioSelection('automation-upgrade')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid transparent;border-radius:16px;padding:24px;cursor:pointer;transition:all 0.3s;position:relative">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
<div style="width:48px;height:48px;background:linear-gradient(135deg,#8b5cf6,#7c3aed);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">ü§ñ</div>
<div>
<h4 style="margin:0;color:#f8fafc;font-size:16px">SCADA & Automation</h4>
<p style="margin:4px 0 0 0;font-size:12px;color:#94a3b8">AI-Powered Optimization</p>
</div>
</div>
<p style="font-size:13px;color:#cbd5e1;margin-bottom:16px">Modernize control systems with AI optimization, predictive analytics, and remote monitoring capabilities.</p>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
<div style="text-align:center;padding:12px;background:rgba(139,92,246,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#a78bfa">$450K</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">CAPITAL</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(34,197,94,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#4ade80">-$75K</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ANNUAL SAVINGS</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(139,92,246,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#a78bfa">6 yrs</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ROI PERIOD</div>
</div>
</div>
<div style="margin-top:12px;padding:10px;background:rgba(139,92,246,0.1);border-radius:8px;font-size:11px;color:#c4b5fd">
<strong>Timeline:</strong> 9-12 months | <strong>NPV:</strong> $310,000 | <strong>Risk:</strong> None
</div>
</div>

<!-- Scenario 5: Biosolids Enhancement -->
<div class="scenario-card" id="scenario-biosolids-upgrade" onclick="toggleScenarioSelection('biosolids-upgrade')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid transparent;border-radius:16px;padding:24px;cursor:pointer;transition:all 0.3s;position:relative">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
<div style="width:48px;height:48px;background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">‚ôªÔ∏è</div>
<div>
<h4 style="margin:0;color:#f8fafc;font-size:16px">Biosolids Enhancement</h4>
<p style="margin:4px 0 0 0;font-size:12px;color:#94a3b8">Dewatering + Class A</p>
</div>
</div>
<p style="font-size:13px;color:#cbd5e1;margin-bottom:16px">Upgrade dewatering to centrifuge and implement Class A processing for beneficial reuse opportunities.</p>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
<div style="text-align:center;padding:12px;background:rgba(245,158,11,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#fbbf24">$1.2M</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">CAPITAL</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(34,197,94,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#4ade80">-$85K</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ANNUAL SAVINGS</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(245,158,11,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#fbbf24">10 yrs</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ROI PERIOD</div>
</div>
</div>
<div style="margin-top:12px;padding:10px;background:rgba(245,158,11,0.1);border-radius:8px;font-size:11px;color:#fcd34d">
<strong>Timeline:</strong> 12-15 months | <strong>NPV:</strong> $180,000 | <strong>Risk:</strong> Low
</div>
</div>

<!-- Scenario 6: Climate Resilience -->
<div class="scenario-card" id="scenario-resilience-hardening" onclick="toggleScenarioSelection('resilience-hardening')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid transparent;border-radius:16px;padding:24px;cursor:pointer;transition:all 0.3s;position:relative">
<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
<div style="width:48px;height:48px;background:linear-gradient(135deg,#06b6d4,#0891b2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">üõ°Ô∏è</div>
<div>
<h4 style="margin:0;color:#f8fafc;font-size:16px">Climate Resilience</h4>
<p style="margin:4px 0 0 0;font-size:12px;color:#94a3b8">Flood Protection + Backup</p>
</div>
</div>
<p style="font-size:13px;color:#cbd5e1;margin-bottom:16px">Flood protection barriers, full backup power generation, and I/I reduction program for climate adaptation.</p>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
<div style="text-align:center;padding:12px;background:rgba(6,182,212,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#22d3ee">$800K</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">CAPITAL</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(34,197,94,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#4ade80">-$45K</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ANNUAL SAVINGS</div>
</div>
<div style="text-align:center;padding:12px;background:rgba(6,182,212,0.15);border-radius:10px">
<div style="font-size:18px;font-weight:700;color:#22d3ee">15 yrs</div>
<div style="font-size:10px;color:#94a3b8;margin-top:2px">ROI PERIOD</div>
</div>
</div>
<div style="margin-top:12px;padding:10px;background:rgba(6,182,212,0.1);border-radius:8px;font-size:11px;color:#67e8f9">
<strong>Timeline:</strong> 12-18 months | <strong>NPV:</strong> $120,000 | <strong>Risk:</strong> None
</div>
</div>

</div>

<!-- Comparison Analysis Section -->
<div id="scenarioComparisonSection" style="display:none;margin-top:24px;padding:24px;background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(217,119,6,0.05));border-radius:16px;border:1px solid rgba(245,158,11,0.3)">
<h4 style="margin:0 0 16px 0;color:#fbbf24;display:flex;align-items:center;gap:10px">
<span style="font-size:24px">üìä</span> Combined Scenario Analysis
</h4>
<div id="comparisonResults" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px">
<!-- Populated by JavaScript -->
</div>
</div>

<!-- ==================== CUSTOM SCENARIO BUILDER v9.9.19 ==================== -->
<div style="margin-top:28px">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
<h4 style="margin:0;color:#a78bfa;display:flex;align-items:center;gap:10px">
<span style="font-size:24px">üõ†Ô∏è</span> Custom Scenario Builder
<span style="font-size:11px;background:linear-gradient(135deg,#8b5cf6,#a855f7);padding:4px 10px;border-radius:10px;color:white;font-weight:600">CREATE YOUR OWN</span>
</h4>
<button onclick="toggleCustomScenarioForm()" id="toggleCustomFormBtn" style="background:linear-gradient(135deg,#8b5cf6,#a855f7);color:white;border:none;padding:10px 20px;border-radius:10px;cursor:pointer;font-weight:600;font-size:13px">‚ûï New Scenario</button>
</div>

<!-- Custom Scenario Form -->
<div id="customScenarioForm" style="display:none;background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid #8b5cf6;border-radius:16px;padding:24px;margin-bottom:20px">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">

<!-- Left Column: Basic Info -->
<div>
<h5 style="color:#c4b5fd;margin:0 0 16px 0;font-size:14px;border-bottom:1px solid rgba(139,92,246,0.3);padding-bottom:8px">üìã Project Details</h5>

<div style="margin-bottom:14px">
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Project Name *</label>
<input type="text" id="customScenarioName" placeholder="e.g., Headworks Upgrade" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:#0f172a;color:white;font-size:14px">
</div>

<div style="margin-bottom:14px">
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Category</label>
<select id="customScenarioCategory" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:#0f172a;color:white;font-size:14px">
<option value="capacity">üìà Capacity Expansion</option>
<option value="energy">‚ö° Energy Efficiency</option>
<option value="treatment">üåø Treatment Process</option>
<option value="automation">ü§ñ Automation/SCADA</option>
<option value="solids">‚ôªÔ∏è Solids Handling</option>
<option value="resilience">üõ°Ô∏è Resilience/Safety</option>
<option value="compliance">üìã Compliance</option>
<option value="other">üì¶ Other</option>
</select>
</div>

<div style="margin-bottom:14px">
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Description</label>
<textarea id="customScenarioDesc" placeholder="Describe the project scope and objectives..." rows="3" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:#0f172a;color:white;font-size:13px;resize:vertical"></textarea>
</div>

<div style="margin-bottom:14px">
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Implementation Timeline</label>
<select id="customScenarioTimeline" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:#0f172a;color:white;font-size:14px">
<option value="1-3 months">1-3 months (Quick Win)</option>
<option value="3-6 months">3-6 months (Short-term)</option>
<option value="6-12 months" selected>6-12 months (Medium-term)</option>
<option value="12-18 months">12-18 months (Long-term)</option>
<option value="18-24 months">18-24 months (Major Project)</option>
<option value="24+ months">24+ months (Multi-year)</option>
</select>
</div>

<div style="margin-bottom:14px">
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Risk Level</label>
<select id="customScenarioRisk" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:#0f172a;color:white;font-size:14px">
<option value="None">‚úÖ None - Low complexity</option>
<option value="Low" selected>üü¢ Low - Standard implementation</option>
<option value="Medium">üü° Medium - Some challenges expected</option>
<option value="High">üî¥ High - Significant risks</option>
</select>
</div>
</div>

<!-- Right Column: Financial Analysis -->
<div>
<h5 style="color:#c4b5fd;margin:0 0 16px 0;font-size:14px;border-bottom:1px solid rgba(139,92,246,0.3);padding-bottom:8px">üí∞ Financial Analysis</h5>

<div style="margin-bottom:14px">
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Capital Cost ($) *</label>
<input type="number" id="customScenarioCapital" placeholder="500000" min="0" step="1000" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:#0f172a;color:white;font-size:14px">
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px">
<div>
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Annual Savings ($)</label>
<input type="number" id="customScenarioSavings" placeholder="75000" min="0" step="1000" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(34,197,94,0.3);background:#0f172a;color:#4ade80;font-size:14px">
</div>
<div>
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Annual OpEx Increase ($)</label>
<input type="number" id="customScenarioOpex" placeholder="0" min="0" step="1000" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(239,68,68,0.3);background:#0f172a;color:#f87171;font-size:14px">
</div>
</div>

<div style="margin-bottom:14px">
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Energy Impact (%)</label>
<div style="display:flex;gap:10px;align-items:center">
<select id="customScenarioEnergyDir" style="padding:12px;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:#0f172a;color:white;font-size:14px">
<option value="decrease">‚¨áÔ∏è Decrease</option>
<option value="increase">‚¨ÜÔ∏è Increase</option>
<option value="none" selected>‚û°Ô∏è No Change</option>
</select>
<input type="number" id="customScenarioEnergyPct" placeholder="0" min="0" max="100" step="1" style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:#0f172a;color:white;font-size:14px">
</div>
</div>

<div style="margin-bottom:14px">
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Discount Rate (%) for NPV</label>
<input type="number" id="customScenarioDiscount" value="5" min="0" max="20" step="0.5" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:#0f172a;color:white;font-size:14px">
</div>

<div style="margin-bottom:14px">
<label style="display:block;font-size:12px;color:#94a3b8;margin-bottom:6px">Project Lifespan (Years)</label>
<input type="number" id="customScenarioLifespan" value="20" min="1" max="50" step="1" style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(139,92,246,0.3);background:#0f172a;color:white;font-size:14px">
</div>

<!-- Auto-Calculated Results Preview -->
<div id="customScenarioPreview" style="background:rgba(139,92,246,0.1);border-radius:12px;padding:16px;border:1px solid rgba(139,92,246,0.3)">
<div style="font-size:11px;color:#a78bfa;margin-bottom:10px;font-weight:600">üìä CALCULATED RESULTS (Auto-updates)</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
<div style="text-align:center">
<div id="previewROI" style="font-size:20px;font-weight:700;color:#fbbf24">-- yrs</div>
<div style="font-size:10px;color:#94a3b8">Payback Period</div>
</div>
<div style="text-align:center">
<div id="previewNPV" style="font-size:20px;font-weight:700;color:#4ade80">$--</div>
<div style="font-size:10px;color:#94a3b8">NPV</div>
</div>
<div style="text-align:center">
<div id="previewIRR" style="font-size:20px;font-weight:700;color:#60a5fa">--%</div>
<div style="font-size:10px;color:#94a3b8">IRR</div>
</div>
</div>
</div>
</div>
</div>

<!-- Form Actions -->
<div style="display:flex;gap:12px;margin-top:20px;padding-top:16px;border-top:1px solid rgba(139,92,246,0.2)">
<button onclick="calculateCustomScenario()" style="flex:1;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;border:none;padding:14px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px">üîÑ Calculate</button>
<button onclick="saveCustomScenario()" style="flex:1;background:linear-gradient(135deg,#22c55e,#16a34a);color:white;border:none;padding:14px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px">üíæ Save Scenario</button>
<button onclick="toggleCustomScenarioForm()" style="background:#374151;color:white;border:none;padding:14px 20px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px">‚úï Cancel</button>
</div>
</div>

<!-- Saved Custom Scenarios List -->
<div id="customScenariosContainer">
<div id="customScenariosList" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px">
<!-- Custom scenarios will be rendered here -->
</div>
</div>

<!-- Empty State -->
<div id="noCustomScenarios" style="text-align:center;padding:40px;background:rgba(139,92,246,0.05);border-radius:16px;border:2px dashed rgba(139,92,246,0.3)">
<div style="font-size:48px;margin-bottom:12px">üéØ</div>
<h4 style="color:#c4b5fd;margin:0 0 8px 0">No Custom Scenarios Yet</h4>
<p style="color:#94a3b8;margin:0 0 16px 0;font-size:13px">Create your own scenarios to model capital projects specific to your facility</p>
<button onclick="toggleCustomScenarioForm()" style="background:linear-gradient(135deg,#8b5cf6,#a855f7);color:white;border:none;padding:12px 24px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px">‚ûï Create First Scenario</button>
</div>
</div>
<!-- ==================== END CUSTOM SCENARIO BUILDER ==================== -->

<!-- Action Buttons -->
<div class="btns" style="margin-top:20px">
<button class="btn gradient" onclick="compareSelectedScenarios()" style="background:linear-gradient(135deg,#f59e0b,#d97706)">üìä Compare Selected</button>
<button class="btn blue" onclick="generateScenarioReport()">üìÑ Generate Report</button>
<button class="btn green" onclick="exportScenarioAnalysis()">üì§ Export Analysis</button>
<button class="btn gray" onclick="clearScenarioSelections()">üîÑ Clear Selections</button>
</div>

</div>
</div>
</div>
<!-- ==================== END SCENARIO PLANNING ENGINE ==================== -->

<!-- ==================== COST CALCULATOR SECTION ==================== -->
<div id="biz-costcalc">
<h3 style="color:var(--text-accent);margin-bottom:20px">üí∞ Operations Cost Calculator</h3>

<!-- Cost Summary KPIs -->
<div class="kpi-grid" style="margin-bottom:24px">
<div class="kpi-card" style="border-left:4px solid #10b981">
<h4>Daily Cost</h4>
<p id="cost_daily">$0.00</p>
<small style="color:#10b981">Operating</small>
</div>
<div class="kpi-card" style="border-left:4px solid #3b82f6">
<h4>Monthly Cost</h4>
<p id="cost_monthly">$0.00</p>
<small style="color:#3b82f6">30-day avg</small>
</div>
<div class="kpi-card" style="border-left:4px solid #8b5cf6">
<h4>Annual Cost</h4>
<p id="cost_annual">$0.00</p>
<small style="color:#8b5cf6">Projected</small>
</div>
<div class="kpi-card" style="border-left:4px solid #f59e0b">
<h4>Cost per MG</h4>
<p id="cost_per_mg">$0.00</p>
<small style="color:#f59e0b">$/MG treated</small>
</div>
</div>

<!-- Plant Flow Input -->
<div class="section">
<div class="section-h">üè≠ Plant Information</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Average Daily Flow (MGD)</label><input type="number" id="cost_flow_mgd" value="5.0" step="0.1" onchange="calculateAllCosts()"></div>
<div class="input-group"><label>Operating Days per Year</label><input type="number" id="cost_op_days" value="365" onchange="calculateAllCosts()"></div>
</div>
</div>
</div>

<!-- Chemical Costs -->
<div class="section">
<div class="section-h">üß™ Chemical Costs</div>
<div class="section-content">
<table class="table" id="chemCostTable">
<thead>
<tr><th>Chemical</th><th>Dose (mg/L)</th><th>Unit Cost ($/lb)</th><th>Daily Use (lb)</th><th>Daily Cost</th><th>Monthly Cost</th></tr>
</thead>
<tbody>
<tr>
<td><input type="text" value="Chlorine" style="width:100px" class="chem-name"></td>
<td><input type="number" value="2" step="0.1" class="chem-dose" onchange="calculateAllCosts()"></td>
<td><input type="number" value="0.35" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>
<td class="chem-daily-use">-</td>
<td class="chem-daily-cost">-</td>
<td class="chem-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Polymer" style="width:100px" class="chem-name"></td>
<td><input type="number" value="5" step="0.1" class="chem-dose" onchange="calculateAllCosts()"></td>
<td><input type="number" value="2.50" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>
<td class="chem-daily-use">-</td>
<td class="chem-daily-cost">-</td>
<td class="chem-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Alum" style="width:100px" class="chem-name"></td>
<td><input type="number" value="50" step="1" class="chem-dose" onchange="calculateAllCosts()"></td>
<td><input type="number" value="0.12" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>
<td class="chem-daily-use">-</td>
<td class="chem-daily-cost">-</td>
<td class="chem-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Caustic Soda" style="width:100px" class="chem-name"></td>
<td><input type="number" value="0" step="1" class="chem-dose" onchange="calculateAllCosts()"></td>
<td><input type="number" value="0.25" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>
<td class="chem-daily-use">-</td>
<td class="chem-daily-cost">-</td>
<td class="chem-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Ferric Chloride" style="width:100px" class="chem-name"></td>
<td><input type="number" value="0" step="1" class="chem-dose" onchange="calculateAllCosts()"></td>
<td><input type="number" value="0.18" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>
<td class="chem-daily-use">-</td>
<td class="chem-daily-cost">-</td>
<td class="chem-monthly-cost">-</td>
</tr>
</tbody>
<tfoot>
<tr style="font-weight:bold;background:var(--bg-section-header)">
<td colspan="4">Chemical Subtotal</td>
<td id="chem_daily_total">$0.00</td>
<td id="chem_monthly_total">$0.00</td>
</tr>
</tfoot>
</table>
<button class="btn green" style="margin-top:10px" onclick="addChemicalRow()">‚ûï Add Chemical</button>
</div>
</div>

<!-- Energy Costs -->
<div class="section">
<div class="section-h">‚ö° Energy Costs</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Electricity Rate ($/kWh)</label><input type="number" id="cost_kwh_rate" value="0.08" step="0.01" onchange="calculateAllCosts()"></div>
<div class="input-group"><label>Demand Charge ($/kW/mo)</label><input type="number" id="cost_demand_rate" value="10.00" step="0.5" onchange="calculateAllCosts()"></div>
</div>
<table class="table" id="energyCostTable">
<thead>
<tr><th>Equipment</th><th>HP/kW</th><th>Qty</th><th>Hours/Day</th><th>Daily kWh</th><th>Daily Cost</th><th>Monthly Cost</th></tr>
</thead>
<tbody>
<tr>
<td><input type="text" value="Blowers" style="width:100px" class="equip-name"></td>
<td><input type="number" value="100" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>
<td><input type="number" value="2" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>
<td><input type="number" value="24" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>
<td class="equip-daily-kwh">-</td>
<td class="equip-daily-cost">-</td>
<td class="equip-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="RAS Pumps" style="width:100px" class="equip-name"></td>
<td><input type="number" value="25" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>
<td><input type="number" value="2" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>
<td><input type="number" value="24" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>
<td class="equip-daily-kwh">-</td>
<td class="equip-daily-cost">-</td>
<td class="equip-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Influent Pumps" style="width:100px" class="equip-name"></td>
<td><input type="number" value="50" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>
<td><input type="number" value="2" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>
<td><input type="number" value="18" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>
<td class="equip-daily-kwh">-</td>
<td class="equip-daily-cost">-</td>
<td class="equip-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Mixers" style="width:100px" class="equip-name"></td>
<td><input type="number" value="10" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>
<td><input type="number" value="4" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>
<td><input type="number" value="24" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>
<td class="equip-daily-kwh">-</td>
<td class="equip-daily-cost">-</td>
<td class="equip-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="UV System" style="width:100px" class="equip-name"></td>
<td><input type="number" value="30" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>
<td><input type="number" value="1" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>
<td><input type="number" value="24" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>
<td class="equip-daily-kwh">-</td>
<td class="equip-daily-cost">-</td>
<td class="equip-monthly-cost">-</td>
</tr>
</tbody>
<tfoot>
<tr style="font-weight:bold;background:var(--bg-section-header)">
<td colspan="4">Energy Subtotal</td>
<td id="energy_daily_kwh">0</td>
<td id="energy_daily_total">$0.00</td>
<td id="energy_monthly_total">$0.00</td>
</tr>
</tfoot>
</table>
<button class="btn green" style="margin-top:10px" onclick="addEquipmentRow()">‚ûï Add Equipment</button>
</div>
</div>

<!-- Solids Disposal Costs -->
<div class="section">
<div class="section-h">üöõ Solids Disposal Costs</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sludge Production (dry tons/day)</label><input type="number" id="cost_sludge_tons" value="2.5" step="0.1" onchange="calculateAllCosts()"></div>
<div class="input-group"><label>Disposal Cost ($/wet ton)</label><input type="number" id="cost_disposal_rate" value="45.00" step="1" onchange="calculateAllCosts()"></div>
<div class="input-group"><label>Cake Solids (%)</label><input type="number" id="cost_cake_solids" value="22" step="1" onchange="calculateAllCosts()"></div>
<div class="input-group"><label>Hauling Cost ($/load)</label><input type="number" id="cost_hauling" value="350" step="10" onchange="calculateAllCosts()"></div>
</div>
<div class="row">
<div class="input-group"><label>Tons per Load</label><input type="number" id="cost_tons_per_load" value="20" step="1" onchange="calculateAllCosts()"></div>
</div>
<table class="table">
<tr><td>Wet Tons per Day</td><td id="solids_wet_tons">-</td><td>wet tons/day</td></tr>
<tr><td>Loads per Month</td><td id="solids_loads_month">-</td><td>loads</td></tr>
<tr><td>Disposal Cost</td><td id="solids_disposal_cost">-</td><td>$/month</td></tr>
<tr><td>Hauling Cost</td><td id="solids_hauling_cost">-</td><td>$/month</td></tr>
<tr style="font-weight:bold;background:var(--bg-section-header)"><td>Solids Subtotal</td><td id="solids_monthly_total">$0.00</td><td>/month</td></tr>
</table>
</div>
</div>

<!-- Cost Summary -->
<div class="section" style="background:linear-gradient(135deg,#065f46,#059669);color:white;border:none">
<div class="section-h" style="background:transparent;color:white">üìä Total Cost Summary</div>
<div class="section-content">
<table class="table" style="color:white">
<tr><td>Chemical Costs</td><td id="sum_chem_monthly">$0.00</td><td>/month</td><td id="sum_chem_annual">$0.00</td><td>/year</td></tr>
<tr><td>Energy Costs</td><td id="sum_energy_monthly">$0.00</td><td>/month</td><td id="sum_energy_annual">$0.00</td><td>/year</td></tr>
<tr><td>Solids Disposal</td><td id="sum_solids_monthly">$0.00</td><td>/month</td><td id="sum_solids_annual">$0.00</td><td>/year</td></tr>
<tr style="font-size:1.2em;border-top:2px solid rgba(255,255,255,0.3)"><td><strong>TOTAL</strong></td><td id="sum_total_monthly"><strong>$0.00</strong></td><td>/month</td><td id="sum_total_annual"><strong>$0.00</strong></td><td>/year</td></tr>
<tr style="background:rgba(255,255,255,0.1)"><td><strong>Cost per MG Treated</strong></td><td colspan="4" id="sum_cost_per_mg" style="font-size:1.3em"><strong>$0.00/MG</strong></td></tr>
</table>
<div class="btns" style="margin-top:15px">
<button class="btn" style="background:white;color:#059669" onclick="calculateAllCosts()">üîÑ Recalculate</button>
<button class="btn" style="background:rgba(255,255,255,0.2);color:white" onclick="exportCostReport()">üìÑ Export Report</button>
<button class="btn" style="background:rgba(255,255,255,0.2);color:white" onclick="saveCostData()">üíæ Save Data</button>
</div>
</div>
</div>

</div>
<!-- END COST CALCULATOR SECTION -->

<div id="biz-clients">
<!-- ==================== CLIENT/PROJECT MANAGEMENT ==================== -->
<div id="clients-content" style="display:block">
<h3 style="color:var(--text-accent);margin-bottom:20px">üë• Client & Project Management</h3>

<!-- Client Stats -->
<div class="kpi-grid" style="margin-bottom:24px">
<div class="kpi-card">
<h4>Total Clients</h4>
<p id="stat_total_clients">0</p>
</div>
<div class="kpi-card">
<h4>Active Projects</h4>
<p id="stat_active_projects">0</p>
</div>
<div class="kpi-card">
<h4>Plants Managed</h4>
<p id="stat_plants_managed">0</p>
</div>
<div class="kpi-card">
<h4>Revenue YTD</h4>
<p id="stat_revenue_ytd">$0</p>
</div>
</div>

<!-- Add Client Form -->
<div class="section">
<div class="section-h">‚ûï Add New Client</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Client/Company Name *</label><input type="text" id="client_name" placeholder="City of Houston"></div>
<div class="input-group"><label>Contact Person</label><input type="text" id="client_contact" placeholder="John Smith"></div>
<div class="input-group"><label>Email</label><input type="email" id="client_email" placeholder="jsmith@cityofhouston.gov"></div>
</div>
<div class="row">
<div class="input-group"><label>Phone</label><input type="tel" id="client_phone" placeholder="(713) 555-1234"></div>
<div class="input-group"><label>City</label><input type="text" id="client_city" placeholder="Houston"></div>
<div class="input-group"><label>Client Type</label>
<select id="client_type">
<option value="municipal">Municipal</option>
<option value="industrial">Industrial</option>
<option value="private_utility">Private Utility</option>
<option value="consultant">Consultant/Engineer</option>
<option value="other">Other</option>
</select></div>
</div>
<div class="row">
<div class="input-group" style="flex:2"><label>Notes</label><textarea id="client_notes" rows="2" placeholder="Initial consultation scheduled..."></textarea></div>
</div>
<div class="btns">
<button class="btn green" onclick="addClient()">‚ûï Add Client</button>
<button class="btn gray" onclick="clearClientForm()">Clear Form</button>
</div>
</div>
</div>

<!-- Client List -->
<div class="section">
<div class="section-h">üìã Client Database</div>
<div class="section-content">
<div class="btns" style="margin-bottom:15px">
<input type="text" id="client_search" placeholder="üîç Search clients..." style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--border)">
<button class="btn blue" onclick="filterClients()">Search</button>
<button class="btn purple" onclick="exportClients()">üì§ Export CSV</button>
</div>
<div id="client_list" style="max-height:400px;overflow-y:auto">
<div class="note">No clients added yet. Add your first client above!</div>
</div>
</div>
</div>

<!-- Projects Section -->
<div class="section">
<div class="section-h">üìÅ Projects</div>
<div class="section-content">
<div class="btns" style="margin-bottom:15px">
<button class="btn green" onclick="showAddProjectModal()">‚ûï New Project</button>
<button class="btn orange" onclick="filterProjects('active')">Active Only</button>
<button class="btn gray" onclick="filterProjects('all')">Show All</button>
</div>
<div id="project_list" style="max-height:400px;overflow-y:auto">
<div class="note">No projects yet. Create a project after adding clients.</div>
</div>
</div>
</div>
</div>
<!-- ==================== END CLIENT MANAGEMENT ==================== -->
</div><!-- END biz-clients -->

<div id="biz-proposals">
<!-- ==================== PROPOSAL GENERATOR ==================== -->
<div id="proposals-content">
<h3 style="color:var(--text-accent);margin-bottom:20px">üìù Proposal Generator</h3>

<!-- Proposal Form -->
<div class="section">
<div class="section-h">üìã Create New Proposal</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Proposal Number</label><input type="text" id="prop_number" value="PROP-2025-001"></div>
<div class="input-group"><label>Date</label><input type="date" id="prop_date"></div>
<div class="input-group"><label>Valid Until</label><input type="date" id="prop_valid"></div>
</div>
<div class="row">
<div class="input-group"><label>Client Name *</label><input type="text" id="prop_client" placeholder="Select or enter client name"></div>
<div class="input-group"><label>Project Name *</label><input type="text" id="prop_project" placeholder="WWTP Optimization Study"></div>
</div>
<div class="row">
<div class="input-group"><label>Facility Name</label><input type="text" id="prop_facility" placeholder="North Regional WWTP"></div>
<div class="input-group"><label>Facility Capacity (MGD)</label><input type="number" id="prop_capacity" value="5.0" step="0.1"></div>
</div>
</div>
</div>

<!-- Service Selection -->
<div class="section">
<div class="section-h">üîß Services & Scope</div>
<div class="section-content">
<div class="note info">Select services to include in your proposal. Prices are customizable.</div>
<div id="service_selection" style="margin-top:15px">
<div style="display:grid;gap:10px">

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_assessment" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Process Assessment & Evaluation</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Comprehensive review of treatment processes, performance data, and optimization opportunities</p>
</div>
<input type="number" id="price_assessment" value="3500" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_compliance" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Compliance Review & Support</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">TCEQ permit review, DMR preparation assistance, compliance strategy development</p>
</div>
<input type="number" id="price_compliance" value="2500" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_training" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Operator Training (On-site)</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Customized training for plant staff on process control, troubleshooting, and best practices</p>
</div>
<input type="number" id="price_training" value="2000" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_energy" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Energy Optimization Study</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Aeration efficiency audit, blower optimization, energy cost reduction strategies</p>
</div>
<input type="number" id="price_energy" value="4000" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_capacity" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Capacity Analysis & Planning</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Current capacity assessment, growth projections, expansion recommendations</p>
</div>
<input type="number" id="price_capacity" value="5000" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_troubleshoot" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Troubleshooting & Problem Resolution</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">On-site investigation of operational issues, root cause analysis, corrective actions</p>
</div>
<input type="number" id="price_troubleshoot" value="3000" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_monthly" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Monthly Retainer Services</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Ongoing support, data review, phone consultations, quarterly site visits</p>
</div>
<input type="number" id="price_monthly" value="1500" style="width:100px" onchange="updateProposalTotal()">
<span style="color:#94a3b8">/month</span>
</label>

</div>
</div>
</div>
</div>

<!-- Proposal Total & Generate -->
<div class="section">
<div class="section-h">üí∞ Proposal Summary</div>
<div class="section-content">
<div style="background:#1a2744;padding:20px;border-radius:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid #374151">
<span>Selected Services Subtotal:</span>
<strong id="prop_subtotal">$0.00</strong>
</div>
<div class="row" style="margin-bottom:15px">
<div class="input-group"><label>Discount (%)</label><input type="number" id="prop_discount" value="0" min="0" max="50" onchange="updateProposalTotal()"></div>
<div class="input-group"><label>Travel/Expenses</label><input type="number" id="prop_expenses" value="500" onchange="updateProposalTotal()"></div>
</div>
<div style="display:flex;justify-content:space-between;font-size:18px;color:#4ade80">
<span>Total Proposal:</span>
<strong id="prop_total">$0.00</strong>
</div>
</div>
<div class="btns" style="margin-top:20px">
<button class="btn gradient" onclick="generateProposal()">üìÑ Generate Proposal</button>
<button class="btn blue" onclick="generateProposalPreview()">üëÅÔ∏è Preview</button>
<button class="btn blue" onclick="saveProposal()">üíæ Save Draft</button>
<button class="btn purple" onclick="emailProposal()">üìß Email to Client</button>
<button class="btn gray" onclick="clearProposal()">üóëÔ∏è Clear</button>
</div>
</div>
</div>

<!-- Saved Proposals -->
<div class="section">
<div class="section-h">üìÇ Saved Proposals</div>
<div class="section-content">
<div id="saved_proposals">
<div class="note">No saved proposals yet.</div>
</div>
</div>
</div>
</div>
<!-- ==================== END PROPOSAL GENERATOR ==================== -->
</div><!-- END biz-proposals -->

<div id="biz-roi">
<!-- ==================== ROI CALCULATOR ==================== -->
<div id="roi-content">
<h3 style="color:var(--text-accent);margin-bottom:20px">üíµ ROI Calculator</h3>

<!-- Current vs Proposed -->
<div class="section">
<div class="section-h">üìä Current vs Proposed Scenario</div>
<div class="section-content">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<!-- Current State -->
<div style="background:#1a2744;padding:20px;border-radius:12px;border-top:4px solid #ef4444">
<h4 style="color:#f87171;margin:0 0 15px 0">üìç Current State</h4>
<div class="input-group"><label>Energy Cost ($/month)</label><input type="number" id="roi_energy_current" value="25000"></div>
<div class="input-group"><label>Chemical Cost ($/month)</label><input type="number" id="roi_chem_current" value="8000"></div>
<div class="input-group"><label>Sludge Disposal ($/month)</label><input type="number" id="roi_sludge_current" value="12000"></div>
<div class="input-group"><label>Maintenance Cost ($/month)</label><input type="number" id="roi_maint_current" value="5000"></div>
<div class="input-group"><label>Labor (hrs/week overtime)</label><input type="number" id="roi_labor_current" value="20"></div>
<div class="input-group"><label>Compliance Fines ($/year)</label><input type="number" id="roi_fines_current" value="5000"></div>
<div style="margin-top:15px;padding-top:15px;border-top:1px solid #374151">
<strong>Current Annual Cost: <span id="roi_current_total" style="color:#f87171">$0</span></strong>
</div>
</div>
<!-- Proposed State -->
<div style="background:#1a2744;padding:20px;border-radius:12px;border-top:4px solid #06d6a0">
<h4 style="color:#4ade80;margin:0 0 15px 0">üéØ After Improvements</h4>
<div class="input-group"><label>Energy Cost ($/month)</label><input type="number" id="roi_energy_proposed" value="18000"></div>
<div class="input-group"><label>Chemical Cost ($/month)</label><input type="number" id="roi_chem_proposed" value="6500"></div>
<div class="input-group"><label>Sludge Disposal ($/month)</label><input type="number" id="roi_sludge_proposed" value="10000"></div>
<div class="input-group"><label>Maintenance Cost ($/month)</label><input type="number" id="roi_maint_proposed" value="4000"></div>
<div class="input-group"><label>Labor (hrs/week overtime)</label><input type="number" id="roi_labor_proposed" value="8"></div>
<div class="input-group"><label>Compliance Fines ($/year)</label><input type="number" id="roi_fines_proposed" value="0"></div>
<div style="margin-top:15px;padding-top:15px;border-top:1px solid #374151">
<strong>Proposed Annual Cost: <span id="roi_proposed_total" style="color:#4ade80">$0</span></strong>
</div>
</div>
</div>
</div>
</div>

<!-- Investment & Payback -->
<div class="section">
<div class="section-h">üí∞ Investment & Payback Analysis</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Consulting Fee ($)</label><input type="number" id="roi_consulting" value="15000"></div>
<div class="input-group"><label>Equipment/Capital ($)</label><input type="number" id="roi_capital" value="50000"></div>
<div class="input-group"><label>Implementation Cost ($)</label><input type="number" id="roi_implementation" value="10000"></div>
<div class="input-group"><label>Labor Rate ($/hr)</label><input type="number" id="roi_labor_rate" value="35"></div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="calculateROI()">üìä Calculate ROI</button>
<button class="btn gray" onclick="resetROI()">Reset</button>
</div>
</div>
</div>

<!-- ROI Results -->
<div class="section">
<div class="section-h">üìà ROI Results</div>
<div class="section-content">
<div id="roi_results">
<div class="note">Enter current and proposed values, then click "Calculate ROI" to see results.</div>
</div>
</div>
</div>

<!-- Savings Breakdown Chart -->
<div class="section">
<div class="section-h">üìä Savings Breakdown</div>
<div class="section-content">
<div class="chart-container" style="height:300px">
<canvas id="roiChart"></canvas>
</div>
</div>
</div>

<!-- Generate Report -->
<div class="section">
<div class="section-h">üìÑ Client Report</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Client Name</label><input type="text" id="roi_client_name" placeholder="City of Houston"></div>
<div class="input-group"><label>Facility Name</label><input type="text" id="roi_facility_name" placeholder="North Regional WWTP"></div>
<div class="input-group"><label>Prepared By</label><input type="text" id="roi_prepared_by" placeholder="Your Name"></div>
</div>
<div class="btns">
<button class="btn green" onclick="generateROIReport()">üìÑ Generate PDF Report</button>
<button class="btn blue" onclick="exportROIData()">üì§ Export Data</button>
<button class="btn purple" onclick="addToProposal()">üìù Add to Proposal</button>
</div>
</div>
</div>
</div>
<!-- ==================== END ROI CALCULATOR ==================== -->
</div><!-- END biz-roi -->

<div id="biz-timetracking">
<!-- ==================== TIME TRACKING ==================== -->
<h3 style="color:var(--text-accent);margin-bottom:20px">‚è±Ô∏è Time Tracking</h3>

<!-- Active Timer -->
<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#059669,#06d6a0);color:white">‚è±Ô∏è Active Timer</div>
<div class="section-content">
<div class="time-tracker">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
<div class="input-group">
<label style="color:#a7f3d0">Client</label>
<select id="timer_client" style="padding:12px;font-size:14px">
<option value="">Select Client...</option>
</select>
</div>
<div class="input-group">
<label style="color:#a7f3d0">Project</label>
<select id="timer_project" style="padding:12px;font-size:14px">
<option value="">Select Project...</option>
</select>
</div>
</div>
<div class="input-group">
<label style="color:#a7f3d0">Task Description</label>
<input type="text" id="timer_task" placeholder="e.g., Process evaluation, DMR review..." style="padding:12px;font-size:14px">
</div>
<div class="input-group">
<label style="color:#a7f3d0">Activity Type</label>
<select id="timer_type" style="padding:12px;font-size:14px">
<option value="site_visit">Site Visit</option>
<option value="analysis">Data Analysis</option>
<option value="reporting">Report Writing</option>
<option value="consulting">Consulting/Advisory</option>
<option value="training">Training</option>
<option value="travel">Travel</option>
<option value="admin">Administrative</option>
</select>
</div>

<div class="time-display" id="timer_display">00:00:00</div>

<div class="timer-controls">
<button class="timer-btn start" id="timer_start" onclick="startTimer()">‚ñ∂ Start</button>
<button class="timer-btn pause" id="timer_pause" onclick="pauseTimer()">‚è∏ Pause</button>
<button class="timer-btn stop" id="timer_stop" onclick="stopTimer()">‚èπ Stop & Save</button>
</div>
</div>
</div>
</div>

<!-- Manual Time Entry -->
<div class="section">
<div class="section-h">‚ûï Manual Time Entry</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Date</label><input type="date" id="manual_date"></div>
<div class="input-group"><label>Hours</label><input type="number" id="manual_hours" value="1.0" step="0.25" min="0.25" max="24"></div>
<div class="input-group"><label>Billable Rate ($/hr)</label><input type="number" id="manual_rate" value="150" step="5"></div>
</div>
<div class="row">
<div class="input-group" style="flex:2"><label>Description</label><input type="text" id="manual_desc" placeholder="Describe the work performed..."></div>
</div>
<div class="btns">
<button class="btn green" onclick="addManualTime()">‚ûï Add Entry</button>
<button class="btn gray" onclick="clearTimeForm()">Clear</button>
</div>
</div>
</div>

<!-- Time Log -->
<div class="section">
<div class="section-h">üìä Time Log</div>
<div class="section-content">
<div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap">
<select id="time_filter_period" style="padding:10px;border-radius:8px;min-width:150px">
<option value="today">Today</option>
<option value="week" selected>This Week</option>
<option value="month">This Month</option>
<option value="all">All Time</option>
</select>
<select id="time_filter_client" style="padding:10px;border-radius:8px;min-width:150px">
<option value="">All Clients</option>
</select>
<button class="btn blue" onclick="filterTimeLog()">üîç Filter</button>
<button class="btn purple" onclick="exportTimeLog()">üì§ Export</button>
</div>

<div class="kpi-grid" style="margin-bottom:20px">
<div class="kpi-card">
<h4>Total Hours</h4>
<p id="time_total_hours">0</p>
</div>
<div class="kpi-card">
<h4>Billable Hours</h4>
<p id="time_billable_hours">0</p>
</div>
<div class="kpi-card">
<h4>Unbilled Amount</h4>
<p id="time_unbilled">$0</p>
</div>
<div class="kpi-card">
<h4>Avg Hours/Day</h4>
<p id="time_avg_daily">0</p>
</div>
</div>

<div id="time_entries_list" style="max-height:400px;overflow-y:auto">
<div class="note">No time entries yet. Start the timer or add manual entries above.</div>
</div>
</div>
</div>

<!-- Weekly Summary -->
<div class="section">
<div class="section-h">üìà Weekly Summary</div>
<div class="section-content">
<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:20px">
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Mon</div>
<div style="font-size:18px;font-weight:700;color:#4ade80" id="week_mon">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Tue</div>
<div style="font-size:18px;font-weight:700;color:#4ade80" id="week_tue">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Wed</div>
<div style="font-size:18px;font-weight:700;color:#4ade80" id="week_wed">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Thu</div>
<div style="font-size:18px;font-weight:700;color:#4ade80" id="week_thu">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Fri</div>
<div style="font-size:18px;font-weight:700;color:#4ade80" id="week_fri">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Sat</div>
<div style="font-size:18px;font-weight:700;color:#60a5fa" id="week_sat">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Sun</div>
<div style="font-size:18px;font-weight:700;color:#60a5fa" id="week_sun">0</div>
</div>
</div>
<div class="btns">
<button class="btn gradient" onclick="generateTimesheet()">üìÑ Generate Timesheet</button>
<button class="btn blue" onclick="generateInvoice()">üí∞ Generate Invoice</button>
</div>
</div>
</div>
<!-- ==================== END TIME TRACKING ==================== -->
</div><!-- END biz-timetracking -->

<div id="biz-ai-enhance">
<!-- ==================== AI ENHANCEMENT ==================== -->
<h3 style="color:var(--text-accent);margin-bottom:20px">ü§ñ AI Enhancement</h3>

<div class="ai-enhance-panel">
<div style="color:white;position:relative;z-index:1">
<h3 style="margin:0 0 10px 0;display:flex;align-items:center;gap:10px">
üß† Intelligent Process Analysis
<span class="ai-confidence">AI Powered</span>
</h3>
<p style="opacity:0.8;margin:0">Let AI analyze your plant data and provide optimization recommendations</p>

<div class="ai-action-grid">
<button class="ai-action-btn" onclick="runAIAnalysis('process')">
üìä Process Analysis
</button>
<button class="ai-action-btn" onclick="runAIAnalysis('energy')">
‚ö° Energy Optimization
</button>
<button class="ai-action-btn" onclick="runAIAnalysis('compliance')">
üìã Compliance Check
</button>
<button class="ai-action-btn" onclick="runAIAnalysis('troubleshoot')">
üîß Troubleshooting
</button>
</div>
</div>
</div>

<!-- AI Analysis Results -->
<div class="section" style="margin-top:20px">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:white">
üîÆ AI Insights & Recommendations
</div>
<div class="section-content" id="ai_results">
<div class="note info">Click an analysis type above to generate AI-powered insights based on your current plant data.</div>

<div class="ai-suggestion" id="ai_suggestion_1">
<div class="ai-suggestion-title">
üí° Process Optimization
<span class="ai-confidence">92% Confidence</span>
</div>
<p style="color:white;opacity:0.9">Based on current F/M ratio and MLSS levels, consider increasing RAS rate by 8-12% to improve settling and reduce SVI.</p>
</div>

<div class="ai-suggestion" id="ai_suggestion_2">
<div class="ai-suggestion-title">
‚ö° Energy Saving Opportunity
<span class="ai-confidence">87% Confidence</span>
</div>
<p style="color:white;opacity:0.9">DO levels are consistently above setpoint. Reducing blower output by 15% during 2AM-6AM could save approximately $2,400/month.</p>
</div>

<div class="ai-suggestion" id="ai_suggestion_3">
<div class="ai-suggestion-title">
‚ö†Ô∏è Predictive Alert
<span class="ai-confidence">78% Confidence</span>
</div>
<p style="color:white;opacity:0.9">SVI trend indicates potential filamentous bulking in 7-10 days. Consider implementing chlorination or nutrient adjustment.</p>
</div>
</div>
</div>

<!-- Quick AI Tools -->
<div class="section">
<div class="section-h">üõ†Ô∏è Quick AI Tools</div>
<div class="section-content">
<div class="tool-grid">
<div class="scenario-card" onclick="showAITool('report-writer')">
<div class="icon">üìù</div>
<strong>AI Report Writer</strong>
<p>Generate professional reports from your data</p>
</div>
<div class="scenario-card" onclick="showAITool('troubleshoot')">
<div class="icon">üîç</div>
<strong>Smart Troubleshooter</strong>
<p>Diagnose issues with intelligent questioning</p>
</div>
<div class="scenario-card" onclick="showAITool('optimizer')">
<div class="icon">üìà</div>
<strong>Process Optimizer</strong>
<p>Get real-time optimization suggestions</p>
</div>
<div class="scenario-card" onclick="showAITool('compliance')">
<div class="icon">‚úÖ</div>
<strong>Compliance Advisor</strong>
<p>TCEQ regulation guidance and DMR review</p>
</div>
</div>
</div>
</div>

<!-- AI Chat -->
<div class="section">
<div class="section-h">üí¨ AI Assistant Chat</div>
<div class="section-content">
<div class="ai-chat-container">
<div class="ai-messages" id="ai_chat_messages">
<div class="ai-message assistant">
Hello! I'm your WWTP AI assistant. I can help you with process optimization, troubleshooting, compliance questions, and more. What would you like to discuss?
</div>
</div>
<div class="ai-thinking" id="ai_thinking">
Analyzing...
</div>
<div class="ai-input-area">
<input type="text" id="ai_chat_input" class="ai-input" placeholder="Ask me anything about wastewater treatment..." onkeypress="if(event.key==='Enter')sendAIMessage()">
<button class="btn gradient" onclick="sendAIMessage()">Send</button>
</div>
</div>
</div>
</div>
<!-- ==================== END AI ENHANCEMENT ==================== -->
</div><!-- END biz-ai-enhance -->

<!-- ==================== GOOGLE SHEETS SYNC ==================== -->
<div id="biz-sheets">
<h3 style="color:var(--text-accent);margin-bottom:20px">üìä Google Sheets Sync</h3>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#34a853,#4285f4);color:white">üîó Connect to Google Sheets</div>
<div class="section-content">
<p style="margin:0 0 20px 0;opacity:0.8">Export plant data to Google Sheets for tracking, reporting, and analysis.</p>

<!-- Connection Status -->
<div style="background:#1e3a5f;padding:20px;border-radius:12px;margin-bottom:20px">
<div style="display:flex;align-items:center;gap:15px;margin-bottom:15px">
<div style="width:12px;height:12px;border-radius:50%;background:#ef4444" id="sheets_status_dot"></div>
<span id="sheets_status_text">Not Connected</span>
</div>
<div class="row">
<div class="input-group">
<label>Google Sheet URL</label>
<input type="text" id="sheets_url" placeholder="https://docs.google.com/spreadsheets/d/..." style="font-size:12px">
</div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="connectGoogleSheet()">üîó Connect Sheet</button>
<button class="btn blue" onclick="testSheetConnection()">üß™ Test Connection</button>
</div>
</div>

<!-- Data Export Options -->
<div style="background:#243b55;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4285f4">üì§ Export Data to Sheet</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">

<div style="background:#1e3a5f;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#4ade80">üìä Daily Operations</h5>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_flow" checked> Flow Data
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_do" checked> DO Readings
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_mlss" checked> MLSS/SVI
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_sludge" checked> Sludge Data
</label>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#fbbf24">üß™ Lab Results</h5>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_bod" checked> BOD/COD
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_tss" checked> TSS
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_nutrients" checked> Nutrients (N, P)
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_ph"> pH/Alkalinity
</label>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#a78bfa">üí∞ Costs</h5>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_chem"> Chemical Costs
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_energy"> Energy Costs
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_disposal"> Disposal Costs
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_labor"> Labor Hours
</label>
</div>

</div>

<div class="btns" style="margin-top:20px">
<button class="btn gradient" onclick="exportToSheets()">üì§ Export Selected Data</button>
<button class="btn blue" onclick="scheduleAutoSync()">üîÑ Schedule Auto-Sync</button>
<button class="btn orange" onclick="downloadCSV()">üíæ Download as CSV</button>
</div>
</div>

<!-- Auto-Sync Schedule -->
<div style="background:#1e3a5f;padding:20px;border-radius:12px">
<h4 style="margin:0 0 15px 0;color:#34a853">üîÑ Auto-Sync Settings</h4>
<div class="row">
<div class="input-group">
<label>Sync Frequency</label>
<select id="sync_freq" style="font-size:14px">
<option value="manual">Manual Only</option>
<option value="daily">Daily</option>
<option value="weekly">Weekly</option>
<option value="monthly">Monthly</option>
</select>
</div>
<div class="input-group">
<label>Sync Time</label>
<input type="time" id="sync_time" value="06:00">
</div>
<div class="input-group">
<label>Last Sync</label>
<input type="text" id="last_sync" value="Never" readonly style="background:#0f172a">
</div>
</div>
</div>

<div id="sheets_results" style="margin-top:20px"></div>
</div>
</div>
</div>
<!-- ==================== END GOOGLE SHEETS SYNC ==================== -->

<!-- ==================== SERVICE PROPOSAL GENERATOR ==================== -->
<div id="biz-serviceprop">
<h3 style="color:var(--text-accent);margin-bottom:20px">üìã Service Proposal Generator</h3>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white">üìã Create Professional Proposal</div>
<div class="section-content">
<p style="margin:0 0 20px 0;opacity:0.8">Generate customized service proposals for wastewater consulting engagements.</p>

<!-- Client Information -->
<div style="background:#1e3a5f;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#8b5cf6">üë§ Client Information</h4>
<div class="row">
<div class="input-group">
<label>Client/Company Name</label>
<input type="text" id="prop_client" placeholder="ABC Water District">
</div>
<div class="input-group">
<label>Contact Person</label>
<input type="text" id="prop_contact" placeholder="John Smith">
</div>
<div class="input-group">
<label>Title</label>
<input type="text" id="prop_title" placeholder="Plant Superintendent">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Email</label>
<input type="email" id="prop_email" placeholder="jsmith@abcwater.com">
</div>
<div class="input-group">
<label>Phone</label>
<input type="tel" id="prop_phone" placeholder="(555) 123-4567">
</div>
<div class="input-group">
<label>Address</label>
<input type="text" id="prop_address" placeholder="123 Main St, City, TX">
</div>
</div>
</div>

<!-- Facility Information -->
<div style="background:#243b55;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üè≠ Facility Information</h4>
<div class="row">
<div class="input-group">
<label>Facility Name</label>
<input type="text" id="prop_facility" placeholder="Main WWTP">
</div>
<div class="input-group">
<label>Design Capacity (MGD)</label>
<input type="number" id="prop_capacity" value="5.0" step="0.1">
</div>
<div class="input-group">
<label>Current Flow (MGD)</label>
<input type="number" id="prop_flow" value="3.5" step="0.1">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Treatment Type</label>
<select id="prop_treatment" style="font-size:14px">
<option value="activated_sludge">Activated Sludge</option>
<option value="sbr">SBR</option>
<option value="mbr">MBR</option>
<option value="oxidation_ditch">Oxidation Ditch</option>
<option value="trickling_filter">Trickling Filter</option>
<option value="lagoon">Lagoon</option>
<option value="other">Other</option>
</select>
</div>
<div class="input-group">
<label>Permit Type</label>
<select id="prop_permit" style="font-size:14px">
<option value="npdes">NPDES</option>
<option value="state">State Permit</option>
<option value="reuse">Reuse Permit</option>
</select>
</div>
<div class="input-group">
<label>Current Issues</label>
<input type="text" id="prop_issues" placeholder="High TSS, ammonia">
</div>
</div>
</div>

<!-- Services Offered -->
<div style="background:#1e3a5f;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üõ†Ô∏è Services Offered</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px">

<div style="background:#243b55;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#60a5fa">üìã Routine Services</h5>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_monthly" checked> Monthly Site Visits
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_process"> Process Optimization
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_troubleshoot"> Troubleshooting Support
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_training"> Operator Training
</label>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#4ade80">üìä Reports & Compliance</h5>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_dmr"> DMR Review & Support
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_reports"> Monthly Reports
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_permit"> Permit Assistance
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_audit"> Compliance Audits
</label>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#f97316">üîß Special Projects</h5>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_startup"> Startup Assistance
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_upgrade"> Upgrade Planning
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_study"> Process Study
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_emergency"> Emergency Response
</label>
</div>

</div>
</div>

<!-- Pricing -->
<div style="background:#243b55;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#ef4444">üí∞ Pricing</h4>
<div class="row">
<div class="input-group">
<label>Hourly Rate ($)</label>
<input type="number" id="prop_hourly" value="150" step="5">
</div>
<div class="input-group">
<label>Monthly Retainer ($)</label>
<input type="number" id="prop_retainer" value="2500" step="100">
</div>
<div class="input-group">
<label>Site Visit Rate ($)</label>
<input type="number" id="prop_visit" value="500" step="25">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Travel Rate ($/mile)</label>
<input type="number" id="prop_mileage" value="0.67" step="0.01">
</div>
<div class="input-group">
<label>Estimated Miles</label>
<input type="number" id="prop_miles" value="50">
</div>
<div class="input-group">
<label>Contract Term</label>
<select id="prop_term" style="font-size:14px">
<option value="monthly">Month-to-Month</option>
<option value="6month">6 Months</option>
<option value="annual" selected>Annual</option>
<option value="2year">2 Years</option>
</select>
</div>
</div>
</div>

<!-- Generate Buttons -->
<div class="btns">
<button class="btn gradient" onclick="generateServiceProposal()">üìã Generate Proposal</button>
<button class="btn blue" onclick="previewProposal()">üëÅÔ∏è Preview</button>
<button class="btn orange" onclick="saveProposalTemplate()">üíæ Save as Template</button>
<button class="btn gray" onclick="clearProposalForm()">üîÑ Clear Form</button>
</div>

<div id="proposal_preview" style="margin-top:20px"></div>
</div>
</div>
</div>
<!-- ==================== END SERVICE PROPOSAL GENERATOR ==================== -->

</div><!-- END business panel -->


<div class="panel" id="daily-ops">
<div id="DAILY-OPS_HEADER_MARKER" style="background:linear-gradient(135deg,#14b8a6 0%,#2dd4bf 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìÖ DAILY OPERATIONS</h2>
</div>

<!-- QUICK NAV CARDS - v9.9.19 -->
<div id="dailyOpsQuickNav" style="margin-bottom:16px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section (12 Features)</span>
<button onclick="document.getElementById('dailyOpsQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(75px, 1fr));gap:8px">
<div onclick="scrollToSection('dailyChecklistSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìã</div>
<div style="font-size:9px;color:white;margin-top:4px">Checklist</div>
</div>
<div onclick="scrollToSection('shiftLogbookSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#1d4ed8,#3b82f6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìù</div>
<div style="font-size:9px;color:white;margin-top:4px">Shift Log</div>
</div>
<div onclick="scrollToSection('alarmManagerSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üö®</div>
<div style="font-size:9px;color:white;margin-top:4px">Alarms</div>
</div>
<div onclick="scrollToSection('energyDashboardSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#15803d,#22c55e);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚ö°</div>
<div style="font-size:9px;color:white;margin-top:4px">Energy</div>
</div>
<div onclick="scrollToSection('workOrderSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#6d28d9,#8b5cf6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üîß</div>
<div style="font-size:9px;color:white;margin-top:4px">Work Orders</div>
</div>
<div onclick="scrollToSection('labSampleSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#0891b2,#06b6d4);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üß™</div>
<div style="font-size:9px;color:white;margin-top:4px">Lab Samples</div>
</div>
<div onclick="scrollToSection('complianceCalendarSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#9333ea,#a855f7);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìÖ</div>
<div style="font-size:9px;color:white;margin-top:4px">Calendar</div>
</div>
<div onclick="scrollToSection('operatorCertsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#be185d,#ec4899);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üéì</div>
<div style="font-size:9px;color:white;margin-top:4px">Certs</div>
</div>
<div onclick="scrollToSection('chemInventorySection')" class="quick-nav-card" style="background:linear-gradient(135deg,#0d9488,#14b8a6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üß¥</div>
<div style="font-size:9px;color:white;margin-top:4px">Chemicals</div>
</div>
<div onclick="scrollToSection('weatherSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#0284c7,#0ea5e9);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üå§Ô∏è</div>
<div style="font-size:9px;color:white;margin-top:4px">Weather</div>
</div>
</div>
</div>

<!-- Daily Rounds Checklist -->
<div class="section" id="dailyChecklistSection">
<div class="section-h" style="background:linear-gradient(135deg,#059669,#06d6a0);color:white;padding:12px 15px;border-radius:8px">
üìã Daily Rounds Checklist
<button onclick="resetDailyChecklist()" style="float:right;background:rgba(255,255,255,0.2);border:none;color:white;padding:5px 10px;border-radius:5px;cursor:pointer">Reset</button>
</div>
<div class="section-content">
<div class="note info">Complete all items during your shift. Progress is saved automatically.</div>

<div id="dailyChecklist" style="display:grid;gap:10px;margin-top:15px">

<div class="checklist-category" style="background:#1a2744;padding:15px;border-radius:8px">
<h4 style="color:#60a5fa;margin:0 0 10px 0">üåÖ Morning Checks (6:00 AM)</h4>
<label class="checklist-item"><input type="checkbox" id="chk_do" onchange="saveChecklist()"> Check DO levels in all basins</label>
<label class="checklist-item"><input type="checkbox" id="chk_mlss" onchange="saveChecklist()"> Record MLSS settleometer reading</label>
<label class="checklist-item"><input type="checkbox" id="chk_flows" onchange="saveChecklist()"> Verify influent/effluent flow meters</label>
<label class="checklist-item"><input type="checkbox" id="chk_blowers" onchange="saveChecklist()"> Check blower operation & pressures</label>
<label class="checklist-item"><input type="checkbox" id="chk_clarifier" onchange="saveChecklist()"> Inspect clarifier blanket levels</label>
</div>

<div class="checklist-category" style="background:#1a2744;padding:15px;border-radius:8px">
<h4 style="color:#ffd166;margin:0 0 10px 0">‚òÄÔ∏è Midday Checks (12:00 PM)</h4>
<label class="checklist-item"><input type="checkbox" id="chk_ph" onchange="saveChecklist()"> Check pH levels</label>
<label class="checklist-item"><input type="checkbox" id="chk_chlorine" onchange="saveChecklist()"> Verify chlorine residual</label>
<label class="checklist-item"><input type="checkbox" id="chk_pumps" onchange="saveChecklist()"> Inspect all pump operations</label>
<label class="checklist-item"><input type="checkbox" id="chk_chemicals" onchange="saveChecklist()"> Check chemical feed rates & inventory</label>
<label class="checklist-item"><input type="checkbox" id="chk_scum" onchange="saveChecklist()"> Remove scum from clarifiers</label>
</div>

<div class="checklist-category" style="background:#1a2744;padding:15px;border-radius:8px">
<h4 style="color:#48cae4;margin:0 0 10px 0">üåô Evening Checks (6:00 PM)</h4>
<label class="checklist-item"><input type="checkbox" id="chk_was" onchange="saveChecklist()"> Adjust WAS rate if needed</label>
<label class="checklist-item"><input type="checkbox" id="chk_ras" onchange="saveChecklist()"> Verify RAS flow rates</label>
<label class="checklist-item"><input type="checkbox" id="chk_uv" onchange="saveChecklist()"> Check UV system operation</label>
<label class="checklist-item"><input type="checkbox" id="chk_safety" onchange="saveChecklist()"> Complete safety walkthrough</label>
<label class="checklist-item"><input type="checkbox" id="chk_logbook" onchange="saveChecklist()"> Update operator logbook</label>
</div>

</div>

<div style="margin-top:15px;padding:15px;background:#0c1929;border-radius:8px">
<div style="display:flex;justify-content:space-between;align-items:center">
<span style="color:#94a3b8">Progress:</span>
<span id="checklistProgress" style="color:#06d6a0;font-weight:bold">0 / 15 (0%)</span>
</div>
<div style="background:#243b55;height:10px;border-radius:5px;margin-top:10px;overflow:hidden">
<div id="checklistBar" style="background:linear-gradient(90deg,#06d6a0,#34d399);height:100%;width:0%;transition:width 0.3s"></div>
</div>
</div>

</div>
</div>

<!-- Step-by-Step Calculation Wizards -->
<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#0096c7,#48cae4);color:white;padding:12px 15px;border-radius:8px">üßô Calculation Wizards</div>
<div class="section-content">
<div class="note">Guided step-by-step calculations for common tasks. Perfect for new operators!</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;margin-top:15px">

<div class="wizard-card" onclick="startWizard('fm')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">‚öñÔ∏è F/M Ratio Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate Food to Microorganism ratio step by step</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">5 steps ‚Ä¢ ~2 min</div>
</div>

<div class="wizard-card" onclick="startWizard('srt')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">‚è±Ô∏è SRT Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate Solids Retention Time with guidance</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">6 steps ‚Ä¢ ~3 min</div>
</div>

<div class="wizard-card" onclick="startWizard('was')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üöø WAS Rate Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Determine optimal waste activated sludge rate</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">4 steps ‚Ä¢ ~2 min</div>
</div>

<div class="wizard-card" onclick="startWizard('chlorine')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üß™ Chlorine Dose Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate chlorine dosing requirements</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">4 steps ‚Ä¢ ~2 min</div>
</div>


<div class="wizard-card" onclick="startWizard('svi')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üß™ SVI Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate Sludge Volume Index step by step</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">3 steps ‚Ä¢ ~1 min</div>
</div>

<div class="wizard-card" onclick="startWizard('bod_removal')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üìâ BOD Removal Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate BOD removal efficiency</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">4 steps ‚Ä¢ ~2 min</div>
</div>

<div class="wizard-card" onclick="startWizard('ras')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üîÑ RAS Rate Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate Return Activated Sludge rate</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">4 steps ‚Ä¢ ~2 min</div>
</div>

<div class="wizard-card" onclick="startWizard('detention')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">‚è∞ Detention Time Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate hydraulic detention time</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">3 steps ‚Ä¢ ~1 min</div>
</div>

<div class="wizard-card" onclick="startWizard('sor')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üåä Clarifier SOR Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate Surface Overflow Rate</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">3 steps ‚Ä¢ ~1 min</div>
</div>

<div class="wizard-card" onclick="startWizard('polymer')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üß¥ Polymer Dose Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate polymer dosing for dewatering</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">5 steps ‚Ä¢ ~2 min</div>
</div>

<div class="wizard-card" onclick="startWizard('blower')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üí® Blower Air Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate aeration requirements</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">5 steps ‚Ä¢ ~3 min</div>
</div>

<div class="wizard-card" onclick="startWizard('ct')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">‚è±Ô∏è CT Disinfection Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate CT for disinfection compliance</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">4 steps ‚Ä¢ ~2 min</div>
</div>


<!-- Wizard Modal Container -->
<div id="wizardModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;justify-content:center;align-items:center">
<div style="background:#1a2744;padding:30px;border-radius:16px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto">
<div id="wizardContent"></div>
</div>
</div>

</div>
</div>

<!-- New Operator Training Mode -->
<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#dc2626,#ef4444);color:white;padding:12px 15px;border-radius:8px">üéì Operator Training</div>
<div class="section-content">
<div class="note warning">Interactive training modules for new operators. Complete all modules to earn certification!</div>

<div id="trainingModules" style="margin-top:15px">

<div class="training-module" style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:15px;border-left:4px solid #06d6a0">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<h4 style="color:#fff;margin:0">Module 1: Activated Sludge Basics</h4>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Understanding biological treatment fundamentals</p>
</div>
<button onclick="startTraining(1)" style="background:#06d6a0;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer">Start</button>
</div>
<div style="margin-top:15px;display:none" id="training1Content">
<div class="training-content" style="background:#0c1929;padding:15px;border-radius:8px">
<h5 style="color:#60a5fa;margin:0 0 10px 0">What is Activated Sludge?</h5>
<p style="color:#e0f2fe;line-height:1.6">Activated sludge is a biological process that uses microorganisms to break down organic matter in wastewater. The "activated" refers to the active mass of microorganisms that consume pollutants.</p>
<h5 style="color:#60a5fa;margin:15px 0 10px 0">Key Components:</h5>
<ul style="color:#e0f2fe;line-height:1.8">
<li><strong>Aeration Basin:</strong> Where microorganisms mix with wastewater and oxygen</li>
<li><strong>Secondary Clarifier:</strong> Separates treated water from biomass</li>
<li><strong>Return Activated Sludge (RAS):</strong> Recycles microorganisms back to aeration</li>
<li><strong>Waste Activated Sludge (WAS):</strong> Removes excess biomass from system</li>
</ul>
<div style="margin-top:15px">
<button onclick="completeModule(1)" style="background:#06d6a0;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;width:100%">‚úì Mark as Complete</button>
</div>
</div>
</div>
</div>

<div class="training-module" style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:15px;border-left:4px solid #ffd166">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<h4 style="color:#fff;margin:0">Module 2: Key Process Parameters</h4>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">MLSS, SVI, F/M, SRT, and what they mean</p>
</div>
<button onclick="startTraining(2)" style="background:#ffd166;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer">Start</button>
</div>
<div style="margin-top:15px;display:none" id="training2Content">
<div class="training-content" style="background:#0c1929;padding:15px;border-radius:8px">
<h5 style="color:#60a5fa;margin:0 0 10px 0">Essential Parameters Every Operator Must Know:</h5>
<div style="display:grid;gap:15px">
<div style="background:#1a2744;padding:12px;border-radius:8px">
<strong style="color:#4ade80">MLSS (Mixed Liquor Suspended Solids)</strong>
<p style="color:#94a3b8;margin:5px 0 0 0">Concentration of microorganisms in aeration basin. Typical: 2,000-4,000 mg/L</p>
</div>
<div style="background:#1a2744;padding:12px;border-radius:8px">
<strong style="color:#4ade80">SVI (Sludge Volume Index)</strong>
<p style="color:#94a3b8;margin:5px 0 0 0">Settleability indicator. Good: 80-150 mL/g. High SVI = poor settling (bulking)</p>
</div>
<div style="background:#1a2744;padding:12px;border-radius:8px">
<strong style="color:#4ade80">F/M (Food to Microorganism Ratio)</strong>
<p style="color:#94a3b8;margin:5px 0 0 0">BOD loading per unit biomass. Typical: 0.2-0.5 lb BOD/lb MLVSS/day</p>
</div>
<div style="background:#1a2744;padding:12px;border-radius:8px">
<strong style="color:#4ade80">SRT (Solids Retention Time)</strong>
<p style="color:#94a3b8;margin:5px 0 0 0">Average time solids stay in system. Typical: 5-15 days for conventional activated sludge</p>
</div>
</div>
<div style="margin-top:15px">
<button onclick="completeModule(2)" style="background:#ffd166;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;width:100%">‚úì Mark as Complete</button>
</div>
</div>
</div>
</div>

<div class="training-module" style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:15px;border-left:4px solid #0077b6">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<h4 style="color:#fff;margin:0">Module 3: Troubleshooting Common Problems</h4>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Identify and fix operational issues</p>
</div>
<button onclick="startTraining(3)" style="background:#0077b6;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer">Start</button>
</div>
<div style="margin-top:15px;display:none" id="training3Content">
<div class="training-content" style="background:#0c1929;padding:15px;border-radius:8px">
<h5 style="color:#ef4444;margin:0 0 15px 0">‚ö†Ô∏è Common Problems & Solutions:</h5>
<div style="display:grid;gap:15px">
<div style="background:#1a2744;padding:12px;border-radius:8px;border-left:3px solid #ef4444">
<strong style="color:#ef4444">Sludge Bulking (High SVI > 150)</strong>
<p style="color:#94a3b8;margin:5px 0">Causes: Low DO, low F/M, nutrient deficiency</p>
<p style="color:#06d6a0;margin:5px 0">Fix: Increase DO, add nutrients, consider chlorination of RAS</p>
</div>
<div style="background:#1a2744;padding:12px;border-radius:8px;border-left:3px solid #ffd166">
<strong style="color:#ffd166">Rising Sludge in Clarifier</strong>
<p style="color:#94a3b8;margin:5px 0">Causes: Denitrification, long sludge detention</p>
<p style="color:#06d6a0;margin:5px 0">Fix: Increase RAS rate, decrease SRT, improve sludge removal</p>
</div>
<div style="background:#1a2744;padding:12px;border-radius:8px;border-left:3px solid #0077b6">
<strong style="color:#0077b6">Foaming</strong>
<p style="color:#94a3b8;margin:5px 0">Causes: Nocardia, high SRT, grease accumulation</p>
<p style="color:#06d6a0;margin:5px 0">Fix: Reduce SRT, spray water, remove scum, check for industrial discharge</p>
</div>
</div>
<div style="margin-top:15px">
<button onclick="completeModule(3)" style="background:#0077b6;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;width:100%">‚úì Mark as Complete</button>
</div>
</div>
</div>
</div>

</div>

<div style="margin-top:15px;padding:15px;background:#0c1929;border-radius:8px">
<div style="display:flex;justify-content:space-between;align-items:center">
<span style="color:#94a3b8">Training Progress:</span>
<span id="trainingProgress" style="color:#ffd166;font-weight:bold">0 / 3 modules</span>
</div>
</div>

</div>
</div>

<!-- Formula Reference with Tooltips -->
<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#0891b2,#48cae4);color:white;padding:12px 15px;border-radius:8px">üìö Formula Reference</div>
<div class="section-content">
<div class="note">Quick reference guide with all essential wastewater formulas. Click any formula for detailed explanation!</div>

<div style="display:grid;gap:10px;margin-top:15px">

<div class="formula-card" onclick="showFormulaDetail('fm')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">F/M Ratio</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">F/M = (BOD √ó Flow √ó 8.34) / (MLVSS √ó Volume √ó 8.34)</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('srt')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">SRT (Sludge Retention Time)</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">SRT = System Solids (lb) / Solids Wasted (lb/day)</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('svi')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">SVI (Sludge Volume Index)</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">SVI = (Settled Volume mL/L √ó 1000) / MLSS mg/L</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('bod')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">BOD Loading</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">BOD Load (lb/day) = BOD (mg/L) √ó Flow (MGD) √ó 8.34</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('removal')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">Percent Removal</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">% Removal = ((In - Out) / In) √ó 100</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('detention')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">Detention Time</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">DT (hours) = (Volume gal √ó 24) / (Flow GPD)</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('sor')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">Surface Overflow Rate</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">SOR = Flow (GPD) / Surface Area (sq ft)</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('ct')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">CT (Disinfection)</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">CT = Chlorine Residual (mg/L) √ó Contact Time (min)</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

</div>

<!-- Formula Detail Modal -->
<div id="formulaModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;justify-content:center;align-items:center">
<div style="background:#1a2744;padding:30px;border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto">
<div id="formulaDetail"></div>
<button onclick="closeFormulaModal()" style="background:#ef4444;color:white;border:none;padding:10px 30px;border-radius:8px;cursor:pointer;margin-top:20px;width:100%">Close</button>
</div>
</div>

<!-- ========== SHIFT LOGBOOK v9.9.17 ========== -->
<div class="section" id="shiftLogbookSection" style="border:2px solid #3b82f6">
<div class="section-h" style="background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:white">
üìã Operator Shift Logbook
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.17</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Digital shift handoff documentation. Log events and issues for seamless transitions.</p>
<div style="background:linear-gradient(135deg,#0d9488,#14b8a6);border-radius:12px;padding:16px;margin-bottom:16px;color:white;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
<div><div style="font-size:12px;opacity:0.9">Current Shift</div><div style="font-size:20px;font-weight:bold" id="currentShiftName">Day Shift</div></div>
<span id="shiftBadge" style="padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;background:#fbbf24;color:#1e293b">DAY</span>
</div>
<div style="background:#1e293b;border-radius:12px;padding:16px;margin-bottom:16px">
<h4 style="margin:0 0 12px 0;color:#60a5fa;font-size:14px">‚ûï Quick Log</h4>
<div class="row" style="gap:12px">
<div class="input-group"><label>Category</label><select id="logEntryCategory" style="background:#0f172a"><option value="routine">üîµ Routine</option><option value="issue">üü° Issue</option><option value="urgent">üî¥ Urgent</option></select></div>
<div class="input-group" style="flex:2"><label>Note</label><input type="text" id="logEntryDesc" placeholder="What happened?" style="background:#0f172a"></div>
</div>
<div class="btns" style="margin-top:12px">
<button onclick="ShiftLogbook.addEntry()" class="btn" style="background:#3b82f6;color:white">üìù Add</button>
<button onclick="ShiftLogbook.quickLog('Round completed')" class="btn" style="background:#22c55e;color:white">‚úì Round Done</button>
</div>
</div>
<div id="shiftLogEntries" style="max-height:200px;overflow-y:auto"><div class="shift-log-entry normal"><div style="display:flex;justify-content:space-between"><span style="color:#94a3b8;font-size:12px">07:15</span><span style="background:#22c55e;color:white;padding:2px 8px;border-radius:10px;font-size:11px">Routine</span></div><div style="margin-top:6px;color:#e2e8f0;font-size:13px">Shift started. All equipment operational.</div></div></div>
</div>
</div>

<!-- ========== ALARM MANAGEMENT v9.9.17 ========== -->
<div class="section" id="alarmManagerSection" style="border:2px solid #ef4444">
<div class="section-h" style="background:linear-gradient(135deg,#b91c1c,#ef4444);color:white">
üö® Alarm Management
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.17</span>
</div>
<div class="section-content">
<div class="kpi-grid" style="margin-bottom:16px">
<div class="kpi-card" style="border-left:4px solid #ef4444"><h4>‚ö†Ô∏è Critical</h4><p id="alarmCriticalCount" style="color:#ef4444">0</p></div>
<div class="kpi-card" style="border-left:4px solid #f59e0b"><h4>‚ö° Warnings</h4><p id="alarmWarningCount" style="color:#f59e0b">0</p></div>
<div class="kpi-card" style="border-left:4px solid #22c55e"><h4>‚úì Ack'd</h4><p id="alarmAckCount" style="color:#22c55e">0</p></div>
</div>
<div id="alarmsList" style="max-height:200px;overflow-y:auto">
<div class="alarm-card critical"><div class="alarm-priority p1">!</div><div style="flex:1"><strong style="color:#fca5a5">High DO - Basin 1</strong><div style="color:#94a3b8;font-size:12px">DO 4.8 mg/L exceeds 3.0 setpoint</div><button onclick="AlarmManager.acknowledge(1)" style="background:#f59e0b;color:white;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:11px;margin-top:6px">Acknowledge</button></div></div>
</div>
</div>
</div>

<!-- ========== ENERGY DASHBOARD v9.9.17 ========== -->
<div class="section" id="energyDashboardSection" style="border:2px solid #22c55e">
<div class="section-h" style="background:linear-gradient(135deg,#15803d,#22c55e);color:white">
‚ö° Energy Dashboard
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.17</span>
</div>
<div class="section-content">
<div class="kpi-grid" style="margin-bottom:16px">
<div class="kpi-card"><h4>Today</h4><p id="energyToday" style="color:#22c55e">5,240</p><div style="font-size:10px;color:#94a3b8">kWh</div></div>
<div class="kpi-card"><h4>Intensity</h4><p id="energyIntensity" style="color:#3b82f6">1,048</p><div style="font-size:10px;color:#94a3b8">kWh/MG</div></div>
<div class="kpi-card"><h4>Monthly</h4><p id="energyCost" style="color:#f59e0b">$12.4K</p><div style="font-size:10px;color:#94a3b8">Est.</div></div>
<div class="kpi-card"><h4>Peak</h4><p id="peakDemand" style="color:#ef4444">485</p><div style="font-size:10px;color:#94a3b8">kW</div></div>
</div>
<div style="background:#1e293b;border-radius:10px;padding:14px">
<div style="font-weight:600;color:#22c55e;margin-bottom:10px;font-size:13px">üìä Energy by Process</div>
<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #1e3a5f;font-size:13px"><span>üí®</span><span style="flex:1;color:#e2e8f0">Aeration</span><span style="color:#22c55e;font-weight:bold">55%</span></div>
<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #1e3a5f;font-size:13px"><span>üîÑ</span><span style="flex:1;color:#e2e8f0">Pumping</span><span style="color:#3b82f6;font-weight:bold">25%</span></div>
<div style="display:flex;align-items:center;gap:8px;padding:8px 0;font-size:13px"><span>üè¢</span><span style="flex:1;color:#e2e8f0">Other</span><span style="color:#94a3b8;font-weight:bold">20%</span></div>
</div>
</div>
</div>

<!-- ========== WORK ORDERS v9.9.17 ========== -->
<div class="section" id="workOrderSection" style="border:2px solid #8b5cf6">
<div class="section-h" style="background:linear-gradient(135deg,#6d28d9,#8b5cf6);color:white">
üìù Work Orders
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.17</span>
</div>
<div class="section-content">
<div class="kpi-grid" style="margin-bottom:16px">
<div class="kpi-card" style="border-left:4px solid #3b82f6"><h4>üìã Open</h4><p id="woOpenCount" style="color:#3b82f6">3</p></div>
<div class="kpi-card" style="border-left:4px solid #f59e0b"><h4>üîÑ Progress</h4><p id="woProgressCount" style="color:#f59e0b">2</p></div>
<div class="kpi-card" style="border-left:4px solid #22c55e"><h4>‚úÖ Done</h4><p id="woCompletedCount" style="color:#22c55e">15</p></div>
</div>
<div id="workOrdersList" style="max-height:200px;overflow-y:auto">
<div class="work-order-card urgent"><span class="wo-status-badge open">Open</span><h4 style="margin:6px 0 2px 0;color:#e2e8f0;font-size:14px">WO-0156: Blower #2 Bearing</h4><div style="color:#94a3b8;font-size:12px">John D. | Due: Dec 26</div></div>
<div class="work-order-card routine"><span class="wo-status-badge in-progress">In Progress</span><h4 style="margin:6px 0 2px 0;color:#e2e8f0;font-size:14px">WO-0155: Clarifier Inspection</h4><div style="color:#94a3b8;font-size:12px">Mike S. | Due: Dec 28</div></div>
</div>
<div style="background:#1e293b;border-radius:10px;padding:14px;margin-top:12px">
<h4 style="margin:0 0 10px 0;color:#8b5cf6;font-size:13px">‚ûï Quick Work Order</h4>
<div class="row" style="gap:10px">
<div class="input-group"><label>Equipment</label><input type="text" id="woNewEquip" placeholder="e.g., Pump #1" style="background:#0f172a"></div>
<div class="input-group" style="flex:2"><label>Description</label><input type="text" id="woNewDesc" placeholder="Issue/Task" style="background:#0f172a"></div>
</div>
<button onclick="WorkOrders.create()" class="btn" style="background:#8b5cf6;color:white;margin-top:10px;width:100%">üìù Create WO</button>
</div>
</div>
</div>

<!-- ========== LAB SAMPLE TRACKER v9.9.19 ========== -->
<div class="section" id="labSampleSection" style="border:2px solid #06b6d4">
<div class="section-h" style="background:linear-gradient(135deg,#0891b2,#06b6d4);color:white">
üß™ Lab Sample Tracker
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.19</span>
</div>
<div class="section-content">
<div class="kpi-grid" style="margin-bottom:16px">
<div class="kpi-card" style="border-left:4px solid #06b6d4"><h4>üì¶ Pending</h4><p id="samplesPending" style="color:#06b6d4">5</p></div>
<div class="kpi-card" style="border-left:4px solid #f59e0b"><h4>üî¨ At Lab</h4><p id="samplesAtLab" style="color:#f59e0b">3</p></div>
<div class="kpi-card" style="border-left:4px solid #22c55e"><h4>‚úì Complete</h4><p id="samplesComplete" style="color:#22c55e">47</p></div>
<div class="kpi-card" style="border-left:4px solid #ef4444"><h4>‚ö†Ô∏è Overdue</h4><p id="samplesOverdue" style="color:#ef4444">0</p></div>
</div>
<div id="samplesList" style="max-height:180px;overflow-y:auto">
<div class="sample-card pending">
<div style="display:flex;justify-content:space-between;align-items:center">
<div><span class="sample-id">SAM-2024-1247</span><span style="margin-left:10px;color:#f59e0b;font-size:11px">‚óè At Lab</span></div>
<span style="color:#94a3b8;font-size:11px">Dec 22, 08:15</span>
</div>
<div style="margin-top:8px;font-size:13px;color:#e2e8f0">Influent Composite - BOD, TSS, NH‚ÇÉ</div>
<div style="margin-top:6px;display:flex;gap:10px;font-size:11px;color:#64748b">
<span>üìç Point: INF-01</span><span>üßä Temp: 4¬∞C</span><span>‚è±Ô∏è Hold: 24hr left</span>
</div>
</div>
<div class="sample-card analyzed">
<div style="display:flex;justify-content:space-between;align-items:center">
<div><span class="sample-id">SAM-2024-1246</span><span style="margin-left:10px;color:#22c55e;font-size:11px">‚úì Results Ready</span></div>
<span style="color:#94a3b8;font-size:11px">Dec 21, 14:30</span>
</div>
<div style="margin-top:8px;font-size:13px;color:#e2e8f0">Effluent Grab - pH, DO, Chlorine Res.</div>
<div style="margin-top:6px;display:flex;gap:10px;font-size:11px;color:#64748b">
<span>üìç Point: EFF-01</span><span>üìä All Pass</span>
</div>
</div>
</div>
<div style="background:#1e293b;border-radius:10px;padding:14px;margin-top:12px">
<h4 style="margin:0 0 10px 0;color:#06b6d4;font-size:13px">‚ûï Log New Sample</h4>
<div class="row" style="gap:10px">
<div class="input-group"><label>Sample Point</label><select id="samplePoint" style="background:#0f172a"><option>INF-01 Influent</option><option>EFF-01 Effluent</option><option>AER-01 Aeration</option><option>RAS Return Sludge</option><option>WAS Waste Sludge</option></select></div>
<div class="input-group"><label>Sample Type</label><select id="sampleType" style="background:#0f172a"><option>Composite 24hr</option><option>Grab</option><option>Composite 8hr</option></select></div>
<div class="input-group"><label>Parameters</label><input type="text" id="sampleParams" placeholder="BOD, TSS, etc." style="background:#0f172a"></div>
</div>
<button onclick="LabSampleTracker.logSample()" class="btn" style="background:#06b6d4;color:white;margin-top:10px;width:100%">üß™ Log Sample</button>
</div>
</div>
</div>

<!-- ========== COMPLIANCE CALENDAR v9.9.19 ========== -->
<div class="section" id="complianceCalendarSection" style="border:2px solid #a855f7">
<div class="section-h" style="background:linear-gradient(135deg,#9333ea,#a855f7);color:white">
üìÖ Compliance Calendar
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.19</span>
</div>
<div class="section-content">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<button onclick="ComplianceCalendar.prevMonth()" style="background:#1e293b;border:none;color:white;padding:8px 16px;border-radius:8px;cursor:pointer">‚óÄ</button>
<h3 id="calendarMonth" style="margin:0;color:#e2e8f0;font-size:16px">December 2024</h3>
<button onclick="ComplianceCalendar.nextMonth()" style="background:#1e293b;border:none;color:white;padding:8px 16px;border-radius:8px;cursor:pointer">‚ñ∂</button>
</div>
<div class="calendar-grid" id="complianceCalGrid">
<div class="calendar-header">Sun</div><div class="calendar-header">Mon</div><div class="calendar-header">Tue</div><div class="calendar-header">Wed</div><div class="calendar-header">Thu</div><div class="calendar-header">Fri</div><div class="calendar-header">Sat</div>
</div>
<div style="background:#1e293b;border-radius:10px;padding:14px;margin-top:12px">
<h4 style="margin:0 0 10px 0;color:#a855f7;font-size:13px">üìã Upcoming Deadlines</h4>
<div id="upcomingDeadlines" style="max-height:120px;overflow-y:auto">
<div style="display:flex;align-items:center;gap:10px;padding:8px;background:#0f172a;border-radius:8px;margin-bottom:6px">
<span style="background:#ef4444;width:8px;height:8px;border-radius:50%"></span>
<div style="flex:1"><div style="color:#e2e8f0;font-size:13px">DMR Submission</div><div style="color:#64748b;font-size:11px">Dec 28, 2024</div></div>
<span style="color:#ef4444;font-size:12px;font-weight:600">5 days</span>
</div>
<div style="display:flex;align-items:center;gap:10px;padding:8px;background:#0f172a;border-radius:8px;margin-bottom:6px">
<span style="background:#06b6d4;width:8px;height:8px;border-radius:50%"></span>
<div style="flex:1"><div style="color:#e2e8f0;font-size:13px">Monthly BOD/TSS Sampling</div><div style="color:#64748b;font-size:11px">Dec 30, 2024</div></div>
<span style="color:#f59e0b;font-size:12px;font-weight:600">7 days</span>
</div>
<div style="display:flex;align-items:center;gap:10px;padding:8px;background:#0f172a;border-radius:8px">
<span style="background:#22c55e;width:8px;height:8px;border-radius:50%"></span>
<div style="flex:1"><div style="color:#e2e8f0;font-size:13px">Quarterly Biosolids Report</div><div style="color:#64748b;font-size:11px">Jan 15, 2025</div></div>
<span style="color:#22c55e;font-size:12px;font-weight:600">23 days</span>
</div>
</div>
</div>
</div>
</div>

<!-- ========== OPERATOR CERTIFICATIONS v9.9.19 ========== -->
<div class="section" id="operatorCertsSection" style="border:2px solid #ec4899">
<div class="section-h" style="background:linear-gradient(135deg,#be185d,#ec4899);color:white">
üéì Operator Certifications
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.19</span>
</div>
<div class="section-content">
<div class="kpi-grid" style="margin-bottom:16px">
<div class="kpi-card" style="border-left:4px solid #22c55e"><h4>‚úì Valid</h4><p id="certsValid" style="color:#22c55e">4</p></div>
<div class="kpi-card" style="border-left:4px solid #f59e0b"><h4>‚ö†Ô∏è Expiring</h4><p id="certsExpiring" style="color:#f59e0b">1</p></div>
<div class="kpi-card" style="border-left:4px solid #3b82f6"><h4>üìö CEUs</h4><p id="totalCEUs" style="color:#3b82f6">24</p></div>
</div>
<div id="certificationsList" style="max-height:200px;overflow-y:auto">
<div class="cert-card">
<div style="display:flex;justify-content:space-between;align-items:flex-start">
<div style="display:flex;gap:12px;align-items:center">
<span class="cert-level">A</span>
<div>
<div style="font-weight:600;color:#e2e8f0;font-size:14px">John Smith</div>
<div style="color:#64748b;font-size:12px">Class A WWTP Operator ‚Ä¢ License #WW-12345</div>
</div>
</div>
<span class="cert-badge valid">Valid</span>
</div>
<div style="margin-top:12px;display:flex;justify-content:space-between;font-size:12px">
<span style="color:#64748b">Expires: Mar 15, 2025</span>
<span style="color:#22c55e">CEUs: 18/20 required</span>
</div>
<div class="cert-progress"><div class="cert-progress-fill" style="width:90%;background:linear-gradient(90deg,#22c55e,#16a34a)"></div></div>
</div>
<div class="cert-card">
<div style="display:flex;justify-content:space-between;align-items:flex-start">
<div style="display:flex;gap:12px;align-items:center">
<span class="cert-level" style="background:linear-gradient(135deg,#f59e0b,#d97706)">B</span>
<div>
<div style="font-weight:600;color:#e2e8f0;font-size:14px">Mike Johnson</div>
<div style="color:#64748b;font-size:12px">Class B WWTP Operator ‚Ä¢ License #WW-23456</div>
</div>
</div>
<span class="cert-badge expiring">Expiring Soon</span>
</div>
<div style="margin-top:12px;display:flex;justify-content:space-between;font-size:12px">
<span style="color:#f59e0b">Expires: Jan 30, 2025</span>
<span style="color:#f59e0b">CEUs: 12/15 required</span>
</div>
<div class="cert-progress"><div class="cert-progress-fill" style="width:80%;background:linear-gradient(90deg,#f59e0b,#d97706)"></div></div>
</div>
</div>
<div class="btns" style="margin-top:12px">
<button onclick="OperatorCerts.addOperator()" class="btn" style="background:#ec4899;color:white">‚ûï Add Operator</button>
<button onclick="OperatorCerts.logCEU()" class="btn" style="background:#3b82f6;color:white">üìö Log CEU</button>
<button onclick="OperatorCerts.exportReport()" class="btn" style="background:#374151;color:white">üì§ Export</button>
</div>
</div>
</div>

<!-- ========== CHEMICAL INVENTORY v9.9.19 ========== -->
<div class="section" id="chemInventorySection" style="border:2px solid #14b8a6">
<div class="section-h" style="background:linear-gradient(135deg,#0d9488,#14b8a6);color:white">
üß™ Chemical Inventory
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.19</span>
</div>
<div class="section-content">
<div id="reorderAlerts">
<div class="reorder-alert">
<span style="font-size:20px">‚ö†Ô∏è</span>
<div style="flex:1">
<div style="font-weight:600;color:#fca5a5">Low Stock Alert</div>
<div style="font-size:12px;color:#fca5a5">Sodium Hypochlorite below reorder point (15%)</div>
</div>
<button onclick="ChemInventory.orderChem('naocl')" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">Reorder</button>
</div>
</div>
<div id="chemicalsList">
<div class="chem-card">
<div class="chem-icon" style="background:linear-gradient(135deg,#22c55e,#16a34a)">üß™</div>
<div style="flex:1">
<div style="display:flex;justify-content:space-between;margin-bottom:6px">
<span style="font-weight:600;color:#e2e8f0;font-size:14px">Polymer (Cationic)</span>
<span style="color:#22c55e;font-weight:bold">78%</span>
</div>
<div class="chem-level"><div class="chem-level-fill high" style="width:78%"></div></div>
<div style="display:flex;justify-content:space-between;margin-top:6px;font-size:11px;color:#64748b">
<span>455 lbs remaining</span><span>Est. 23 days</span>
</div>
</div>
</div>
<div class="chem-card">
<div class="chem-icon" style="background:linear-gradient(135deg,#f59e0b,#d97706)">üíß</div>
<div style="flex:1">
<div style="display:flex;justify-content:space-between;margin-bottom:6px">
<span style="font-weight:600;color:#e2e8f0;font-size:14px">Ferric Chloride</span>
<span style="color:#f59e0b;font-weight:bold">42%</span>
</div>
<div class="chem-level"><div class="chem-level-fill medium" style="width:42%"></div></div>
<div style="display:flex;justify-content:space-between;margin-top:6px;font-size:11px;color:#64748b">
<span>320 gal remaining</span><span>Est. 12 days</span>
</div>
</div>
</div>
<div class="chem-card">
<div class="chem-icon" style="background:linear-gradient(135deg,#ef4444,#dc2626)">üß¥</div>
<div style="flex:1">
<div style="display:flex;justify-content:space-between;margin-bottom:6px">
<span style="font-weight:600;color:#e2e8f0;font-size:14px">Sodium Hypochlorite</span>
<span style="color:#ef4444;font-weight:bold">15%</span>
</div>
<div class="chem-level"><div class="chem-level-fill low" style="width:15%"></div></div>
<div style="display:flex;justify-content:space-between;margin-top:6px;font-size:11px;color:#64748b">
<span>120 gal remaining</span><span>Est. 4 days ‚ö†Ô∏è</span>
</div>
</div>
</div>
</div>
<div style="background:#1e293b;border-radius:10px;padding:14px;margin-top:12px">
<h4 style="margin:0 0 10px 0;color:#14b8a6;font-size:13px">üì¶ Log Delivery / Usage</h4>
<div class="row" style="gap:10px">
<div class="input-group"><label>Chemical</label><select id="chemLogChemical" style="background:#0f172a"><option>Sodium Hypochlorite</option><option>Ferric Chloride</option><option>Polymer</option><option>Sodium Hydroxide</option><option>Methanol</option></select></div>
<div class="input-group"><label>Type</label><select id="chemLogType" style="background:#0f172a"><option value="delivery">üì¶ Delivery</option><option value="usage">üì§ Usage</option></select></div>
<div class="input-group"><label>Amount</label><input type="number" id="chemLogAmount" placeholder="Quantity" style="background:#0f172a"></div>
</div>
<button onclick="ChemInventory.logTransaction()" class="btn" style="background:#14b8a6;color:white;margin-top:10px;width:100%">üíæ Log Transaction</button>
</div>
</div>
</div>

<!-- ========== WEATHER INTEGRATION v9.9.19 ========== -->
<div class="section" id="weatherSection" style="border:2px solid #0ea5e9">
<div class="section-h" style="background:linear-gradient(135deg,#0284c7,#0ea5e9);color:white">
üå§Ô∏è Weather & Operations Impact
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.19</span>
</div>
<div class="section-content">
<div class="weather-widget" id="weatherWidget">
<div class="weather-main">
<span class="weather-icon" id="weatherIcon">‚òÄÔ∏è</span>
<div>
<div class="weather-temp"><span id="weatherTemp">72</span>¬∞F</div>
<div style="opacity:0.9" id="weatherDesc">Sunny, Clear Skies</div>
<div style="font-size:12px;opacity:0.7" id="weatherLocation">üìç Houston, TX</div>
</div>
<div style="margin-left:auto;text-align:right">
<div style="font-size:14px">üíß <span id="weatherHumidity">45%</span></div>
<div style="font-size:14px">üí® <span id="weatherWind">8 mph</span></div>
<div style="font-size:14px">üåßÔ∏è <span id="weatherPrecip">0%</span></div>
</div>
</div>
<div class="weather-forecast" id="weatherForecast">
<div class="forecast-day"><div class="day">Mon</div><div class="icon">‚òÄÔ∏è</div><div class="temp">74¬∞</div></div>
<div class="forecast-day"><div class="day">Tue</div><div class="icon">‚õÖ</div><div class="temp">71¬∞</div></div>
<div class="forecast-day"><div class="day">Wed</div><div class="icon">üåßÔ∏è</div><div class="temp">65¬∞</div></div>
<div class="forecast-day"><div class="day">Thu</div><div class="icon">üåßÔ∏è</div><div class="temp">62¬∞</div></div>
<div class="forecast-day"><div class="day">Fri</div><div class="icon">‚õÖ</div><div class="temp">68¬∞</div></div>
</div>
</div>
<div id="weatherImpact">
<div class="weather-impact warning">
<span style="font-size:18px">üåßÔ∏è</span>
<div>
<div style="font-weight:600;color:#fbbf24">Rain Expected Wed-Thu</div>
<div style="font-size:12px;margin-top:4px;color:#e2e8f0">Expected: 1.5-2.0 inches. Prepare for I/I increase. Consider reducing WAS rates preemptively.</div>
</div>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:10px;margin-top:12px">
<div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center">
<div style="font-size:11px;color:#64748b">Est. Flow Impact</div>
<div style="font-size:20px;font-weight:bold;color:#f59e0b" id="flowImpact">+15%</div>
</div>
<div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center">
<div style="font-size:11px;color:#64748b">Temp Effect on Bio</div>
<div style="font-size:20px;font-weight:bold;color:#22c55e" id="tempEffect">Optimal</div>
</div>
<div style="background:#1e293b;border-radius:10px;padding:12px;text-align:center">
<div style="font-size:11px;color:#64748b">Storm Prep Status</div>
<div style="font-size:20px;font-weight:bold;color:#3b82f6" id="stormPrep">Ready</div>
</div>
</div>
</div>
</div>

</div>
</div>

</div>
</div><!-- END daily-ops panel -->
<!-- Loading Panel (Abbreviated - keeping structure same as original) -->

<div class="panel" id="process-control">
<div id="PROCESS-CONTROL_HEADER_MARKER" style="background:linear-gradient(135deg,#f97316 0%,#fb923c 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">‚öôÔ∏è PROCESS CONTROL</h2>
</div>

<!-- QUICK NAV CARDS -->
<div id="processQuickNav" style="margin-bottom:20px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section</span>
<button onclick="document.getElementById('processQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(100px, 1fr));gap:8px">
<div onclick="scrollToSection('processOptimizerSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#22c55e,#16a34a);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üéØ</div>
<div style="font-size:11px;color:white;margin-top:4px">Optimizer</div>
</div>
<div onclick="scrollToSection('advancedCalcSuite')" class="quick-nav-card" style="background:linear-gradient(135deg,#6366f1,#818cf8);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üßÆ</div>
<div style="font-size:11px;color:white;margin-top:4px">Adv Calcs</div>
</div>
<div onclick="scrollToSection('masterSettingsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üéõÔ∏è</div>
<div style="font-size:11px;color:white;margin-top:4px">Master Settings</div>
</div>
<div onclick="scrollToSection('loadingParamsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üì•</div>
<div style="font-size:11px;color:white;margin-top:4px">Loading</div>
</div>
<div onclick="scrollToSection('sludgeParamsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üß´</div>
<div style="font-size:11px;color:white;margin-top:4px">Sludge</div>
</div>
<div onclick="scrollToSection('oxygenSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#06b6d4,#22d3ee);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üí®</div>
<div style="font-size:11px;color:white;margin-top:4px">Oxygen</div>
</div>
<div onclick="scrollToSection('processCalcsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üìä</div>
<div style="font-size:11px;color:white;margin-top:4px">Calcs</div>
</div>
<div onclick="scrollToSection('chemicalCalcsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#84cc16,#a3e635);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üß™</div>
<div style="font-size:11px;color:white;margin-top:4px">Chemicals</div>
</div>
<div onclick="scrollToSection('hydraulicsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#ec4899,#f472b6);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üåä</div>
<div style="font-size:11px;color:white;margin-top:4px">Hydraulics</div>
</div>
<div onclick="scrollToSection('spcChartsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#0891b2,#06b6d4);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üìà</div>
<div style="font-size:11px;color:white;margin-top:4px">SPC Charts</div>
</div>
</div>
</div>

<!-- ==================== PROCESS OPTIMIZER DASHBOARD v9.9.19 ==================== -->
<div class="section" id="processOptimizerSection" style="border:2px solid #22c55e;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#16a34a,#22c55e);color:white;display:flex;justify-content:space-between;align-items:center">
<div style="display:flex;align-items:center;gap:10px">
<span>üéØ Process Optimization Advisor</span>
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700">GENIUS v9.9.19</span>
</div>
<button onclick="refreshProcessOptimizer()" style="background:rgba(255,255,255,0.2);border:none;padding:6px 12px;border-radius:8px;color:white;font-size:11px;cursor:pointer;font-weight:600">üîÑ Analyze</button>
</div>
<div class="section-content" style="padding:16px">

<!-- Optimization Score & Savings Summary -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px">

<!-- Optimization Score Dial -->
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;text-align:center;border:1px solid rgba(34,197,94,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600">OPTIMIZATION SCORE</div>
<div style="position:relative;width:90px;height:90px;margin:0 auto">
<svg viewBox="0 0 100 100" style="transform:rotate(-90deg)">
<circle cx="50" cy="50" r="40" fill="none" stroke="#1e293b" stroke-width="10"/>
<circle id="optimizerScoreCircle" cx="50" cy="50" r="40" fill="none" stroke="#22c55e" stroke-width="10" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="75.36"/>
</svg>
<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center">
<div id="optimizerScore" style="font-size:26px;font-weight:800;color:#4ade80">70</div>
<div style="font-size:9px;color:#94a3b8">/ 100</div>
</div>
</div>
<div id="optimizerGrade" style="margin-top:8px;font-size:12px;color:#4ade80;font-weight:600">GOOD</div>
</div>

<!-- Total Potential Savings -->
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;text-align:center;border:1px solid rgba(34,197,94,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600">ANNUAL SAVINGS</div>
<div style="font-size:36px;margin:8px 0">üí∞</div>
<div id="optimizerTotalSavings" style="font-size:24px;font-weight:800;color:#4ade80">$48K</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">potential/year</div>
</div>

<!-- Recommendations Count -->
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;text-align:center;border:1px solid rgba(34,197,94,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600">RECOMMENDATIONS</div>
<div style="display:flex;justify-content:center;gap:8px;margin:12px 0">
<div style="text-align:center">
<div id="highPriorityCount" style="font-size:20px;font-weight:700;color:#ef4444">2</div>
<div style="font-size:9px;color:#fca5a5">HIGH</div>
</div>
<div style="text-align:center">
<div id="medPriorityCount" style="font-size:20px;font-weight:700;color:#f59e0b">3</div>
<div style="font-size:9px;color:#fcd34d">MED</div>
</div>
<div style="text-align:center">
<div id="lowPriorityCount" style="font-size:20px;font-weight:700;color:#3b82f6">1</div>
<div style="font-size:9px;color:#93c5fd">LOW</div>
</div>
</div>
<div id="totalRecsCount" style="font-size:12px;color:#94a3b8">6 total actions</div>
</div>

<!-- Quick Wins -->
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;text-align:center;border:1px solid rgba(34,197,94,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:8px;font-weight:600">QUICK WINS</div>
<div style="font-size:36px;margin:8px 0">‚ö°</div>
<div id="quickWinsCount" style="font-size:24px;font-weight:800;color:#fbbf24">3</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">implement today</div>
</div>

</div>

<!-- Analysis Areas -->
<div style="margin-bottom:16px">
<div style="font-size:12px;color:#94a3b8;margin-bottom:10px;font-weight:600">üìä ANALYSIS AREAS</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">

<div id="areaAeration" onclick="showOptimizationArea('aeration')" style="background:linear-gradient(135deg,rgba(14,165,233,0.15),rgba(2,132,199,0.1));border:1px solid rgba(14,165,233,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#0ea5e9'" onmouseout="this.style.borderColor='rgba(14,165,233,0.3)'">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
<span style="font-size:24px">üí®</span>
<div>
<div style="font-size:13px;font-weight:600;color:#7dd3fc">Aeration</div>
<div id="aerationStatus" style="font-size:10px;color:#94a3b8">Analyzing...</div>
</div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center">
<div id="aerationSavings" style="font-size:14px;font-weight:700;color:#4ade80">$12K/yr</div>
<div id="aerationScore" style="background:rgba(34,197,94,0.2);color:#4ade80;padding:3px 8px;border-radius:8px;font-size:10px;font-weight:700">85%</div>
</div>
</div>

<div id="areaSolids" onclick="showOptimizationArea('solids')" style="background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(124,58,237,0.1));border:1px solid rgba(139,92,246,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='rgba(139,92,246,0.3)'">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
<span style="font-size:24px">üß´</span>
<div>
<div style="font-size:13px;font-weight:600;color:#c4b5fd">Solids Mgmt</div>
<div id="solidsStatus" style="font-size:10px;color:#94a3b8">Analyzing...</div>
</div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center">
<div id="solidsSavings" style="font-size:14px;font-weight:700;color:#4ade80">$8K/yr</div>
<div id="solidsScore" style="background:rgba(245,158,11,0.2);color:#fbbf24;padding:3px 8px;border-radius:8px;font-size:10px;font-weight:700">72%</div>
</div>
</div>

<div id="areaNutrient" onclick="showOptimizationArea('nutrient')" style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(5,150,105,0.1));border:1px solid rgba(16,185,129,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#10b981'" onmouseout="this.style.borderColor='rgba(16,185,129,0.3)'">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
<span style="font-size:24px">üåø</span>
<div>
<div style="font-size:13px;font-weight:600;color:#6ee7b7">Nutrient Removal</div>
<div id="nutrientStatus" style="font-size:10px;color:#94a3b8">Analyzing...</div>
</div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center">
<div id="nutrientSavings" style="font-size:14px;font-weight:700;color:#4ade80">$6K/yr</div>
<div id="nutrientScore" style="background:rgba(34,197,94,0.2);color:#4ade80;padding:3px 8px;border-radius:8px;font-size:10px;font-weight:700">88%</div>
</div>
</div>

<div id="areaChemical" onclick="showOptimizationArea('chemical')" style="background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(217,119,6,0.1));border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='rgba(245,158,11,0.3)'">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
<span style="font-size:24px">üß™</span>
<div>
<div style="font-size:13px;font-weight:600;color:#fcd34d">Chemical Dosing</div>
<div id="chemicalStatus" style="font-size:10px;color:#94a3b8">Analyzing...</div>
</div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center">
<div id="chemicalSavings" style="font-size:14px;font-weight:700;color:#4ade80">$15K/yr</div>
<div id="chemicalScore" style="background:rgba(239,68,68,0.2);color:#f87171;padding:3px 8px;border-radius:8px;font-size:10px;font-weight:700">58%</div>
</div>
</div>

<div id="areaEnergy" onclick="showOptimizationArea('energy')" style="background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(37,99,235,0.1));border:1px solid rgba(59,130,246,0.3);border-radius:12px;padding:14px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='rgba(59,130,246,0.3)'">
<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
<span style="font-size:24px">‚ö°</span>
<div>
<div style="font-size:13px;font-weight:600;color:#93c5fd">Energy Efficiency</div>
<div id="energyStatus" style="font-size:10px;color:#94a3b8">Analyzing...</div>
</div>
</div>
<div style="display:flex;justify-content:space-between;align-items:center">
<div id="energySavings" style="font-size:14px;font-weight:700;color:#4ade80">$7K/yr</div>
<div id="energyScore" style="background:rgba(245,158,11,0.2);color:#fbbf24;padding:3px 8px;border-radius:8px;font-size:10px;font-weight:700">75%</div>
</div>
</div>

</div>
</div>

<!-- Prioritized Recommendations List -->
<div style="margin-bottom:16px">
<div style="font-size:12px;color:#94a3b8;margin-bottom:10px;font-weight:600;display:flex;justify-content:space-between;align-items:center">
<span>üéØ PRIORITIZED RECOMMENDATIONS</span>
<div style="display:flex;gap:6px">
<button onclick="filterRecommendations('all')" id="filterAll" style="background:#22c55e;border:none;color:white;padding:4px 10px;border-radius:6px;font-size:10px;cursor:pointer">All</button>
<button onclick="filterRecommendations('high')" id="filterHigh" style="background:rgba(239,68,68,0.2);border:none;color:#fca5a5;padding:4px 10px;border-radius:6px;font-size:10px;cursor:pointer">High</button>
<button onclick="filterRecommendations('medium')" id="filterMed" style="background:rgba(245,158,11,0.2);border:none;color:#fcd34d;padding:4px 10px;border-radius:6px;font-size:10px;cursor:pointer">Med</button>
<button onclick="filterRecommendations('low')" id="filterLow" style="background:rgba(59,130,246,0.2);border:none;color:#93c5fd;padding:4px 10px;border-radius:6px;font-size:10px;cursor:pointer">Low</button>
</div>
</div>
<div id="recommendationsList" style="display:flex;flex-direction:column;gap:10px;max-height:400px;overflow-y:auto">
<!-- Populated by JS -->
</div>
</div>

<!-- Implementation Tracker -->
<div style="background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(22,163,74,0.05));border-radius:12px;padding:16px;border:1px solid rgba(34,197,94,0.3)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div style="font-size:13px;font-weight:600;color:#86efac">üìã Implementation Progress</div>
<div id="implementedCount" style="font-size:12px;color:#94a3b8">0 of 6 completed</div>
</div>
<div style="background:rgba(0,0,0,0.2);border-radius:8px;height:12px;overflow:hidden">
<div id="implementationProgress" style="background:linear-gradient(90deg,#22c55e,#4ade80);height:100%;width:0%;transition:width 0.5s;border-radius:8px"></div>
</div>
<div style="display:flex;justify-content:space-between;margin-top:10px;font-size:11px;color:#94a3b8">
<span>Realized Savings: <span id="realizedSavings" style="color:#4ade80;font-weight:600">$0</span></span>
<span>Remaining: <span id="remainingSavings" style="color:#fbbf24;font-weight:600">$48K</span></span>
</div>
</div>

<!-- Action Buttons -->
<div class="btns" style="margin-top:16px">
<button class="btn gradient" onclick="refreshProcessOptimizer()" style="background:linear-gradient(135deg,#22c55e,#16a34a)">üîÑ Run Full Analysis</button>
<button class="btn blue" onclick="exportOptimizationReport()">üìÑ Export Report</button>
<button class="btn purple" onclick="scheduleOptimizationReview()">üìÖ Schedule Review</button>
</div>

</div>
</div>
<!-- ==================== END PROCESS OPTIMIZER DASHBOARD ==================== -->

<!-- ==================== ADVANCED CALCULATOR SUITE v9.9.19 ==================== -->
<div class="section" id="advancedCalcSuite" style="border:2px solid #6366f1;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#4f46e5,#6366f1);color:white;display:flex;justify-content:space-between;align-items:center">
<div style="display:flex;align-items:center;gap:10px">
<span>üßÆ Advanced Calculator Suite</span>
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700">12 NEW TOOLS</span>
</div>
<button onclick="resetAdvancedCalcs()" style="background:rgba(255,255,255,0.2);border:none;padding:6px 12px;border-radius:8px;color:white;font-size:11px;cursor:pointer;font-weight:600">üîÑ Reset All</button>
</div>
<div class="section-content" style="padding:16px">

<!-- Calculator Quick Jump -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px;margin-bottom:20px">
<div onclick="scrollToSection('blowerCalc')" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üí®</div>
<div style="font-size:9px;color:white;margin-top:2px">Blower</div>
</div>
<div onclick="scrollToSection('alkalinityCalc')" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">‚öóÔ∏è</div>
<div style="font-size:9px;color:white;margin-top:2px">Alkalinity</div>
</div>
<div onclick="scrollToSection('sviCalcAdv')" style="background:linear-gradient(135deg,#22c55e,#4ade80);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üåÄ</div>
<div style="font-size:9px;color:white;margin-top:2px">SVI</div>
</div>
<div onclick="scrollToSection('chlorineCalc')" style="background:linear-gradient(135deg,#eab308,#facc15);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üß™</div>
<div style="font-size:9px;color:white;margin-top:2px">Chlorine</div>
</div>
<div onclick="scrollToSection('pumpCalc')" style="background:linear-gradient(135deg,#ef4444,#f87171);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üîÑ</div>
<div style="font-size:9px;color:white;margin-top:2px">Pump</div>
</div>
<div onclick="scrollToSection('flowSplitCalc')" style="background:linear-gradient(135deg,#06b6d4,#22d3ee);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üîÄ</div>
<div style="font-size:9px;color:white;margin-top:2px">Flow Split</div>
</div>
<div onclick="scrollToSection('polymerCalc')" style="background:linear-gradient(135deg,#ec4899,#f472b6);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üß´</div>
<div style="font-size:9px;color:white;margin-top:2px">Polymer</div>
</div>
<div onclick="scrollToSection('aerationCalc')" style="background:linear-gradient(135deg,#14b8a6,#2dd4bf);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">ü´ß</div>
<div style="font-size:9px;color:white;margin-top:2px">Aeration</div>
</div>
<div onclick="scrollToSection('returnRateCalc')" style="background:linear-gradient(135deg,#f97316,#fb923c);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">‚Ü©Ô∏è</div>
<div style="font-size:9px;color:white;margin-top:2px">Return Rate</div>
</div>
<div onclick="scrollToSection('loadingCalc')" style="background:linear-gradient(135deg,#84cc16,#a3e635);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">‚öñÔ∏è</div>
<div style="font-size:9px;color:white;margin-top:2px">Loading</div>
</div>
<div onclick="scrollToSection('sludgeProdCalc')" style="background:linear-gradient(135deg,#78716c,#a8a29e);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üöõ</div>
<div style="font-size:9px;color:white;margin-top:2px">Sludge</div>
</div>
<div onclick="scrollToSection('energyCalcAdv')" style="background:linear-gradient(135deg,#fbbf24,#fcd34d);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">‚ö°</div>
<div style="font-size:9px;color:white;margin-top:2px">Energy</div>
</div>
</div>

<!-- ROW 1: Blower & Alkalinity -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px">

<!-- BLOWER CALCULATOR -->
<div id="blowerCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(59,130,246,0.3)">
<div style="font-size:14px;font-weight:600;color:#60a5fa;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üí® Blower Air Requirement
<span style="background:rgba(59,130,246,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">SCFM</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Oxygen Demand (lbs O‚ÇÇ/day)</label>
<input type="number" id="blower_o2_demand" value="2500" step="100" oninput="calcBlower()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Transfer Efficiency (%)</label>
<input type="number" id="blower_ote" value="25" step="1" oninput="calcBlower()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Safety Factor</label>
<input type="number" id="blower_sf" value="1.5" step="0.1" oninput="calcBlower()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Altitude (ft)</label>
<input type="number" id="blower_alt" value="500" step="100" oninput="calcBlower()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Air Required</div>
<div id="blower_scfm" style="font-size:20px;font-weight:700;color:#60a5fa">2,083</div>
<div style="font-size:9px;color:#64748b">SCFM</div>
</div>
<div style="background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">HP Estimate</div>
<div id="blower_hp" style="font-size:20px;font-weight:700;color:#4ade80">75</div>
<div style="font-size:9px;color:#64748b">Horsepower</div>
</div>
</div>
</div>

<!-- ALKALINITY CALCULATOR -->
<div id="alkalinityCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(139,92,246,0.3)">
<div style="font-size:14px;font-weight:600;color:#a78bfa;margin-bottom:12px;display:flex;align-items:center;gap:8px">
‚öóÔ∏è Alkalinity for Nitrification
<span style="background:rgba(139,92,246,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">lbs/day</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow (MGD)</label>
<input type="number" id="alk_flow" value="3.5" step="0.1" oninput="calcAlkalinity()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">NH‚ÇÉ-N Removed (mg/L)</label>
<input type="number" id="alk_nh3" value="25" step="1" oninput="calcAlkalinity()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Influent Alkalinity (mg/L)</label>
<input type="number" id="alk_inf" value="200" step="10" oninput="calcAlkalinity()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Target Effluent Alk (mg/L)</label>
<input type="number" id="alk_target" value="80" step="10" oninput="calcAlkalinity()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
<div style="background:rgba(139,92,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Alk Consumed</div>
<div id="alk_consumed" style="font-size:20px;font-weight:700;color:#a78bfa">1,840</div>
<div style="font-size:9px;color:#64748b">lbs/day as CaCO‚ÇÉ</div>
</div>
<div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Soda Ash Needed</div>
<div id="alk_soda" style="font-size:20px;font-weight:700;color:#fbbf24">485</div>
<div style="font-size:9px;color:#64748b">lbs/day</div>
</div>
</div>
</div>

</div>

<!-- ROW 2: SVI & Chlorine -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px">

<!-- SVI CALCULATOR -->
<div id="sviCalcAdv" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(34,197,94,0.3)">
<div style="font-size:14px;font-weight:600;color:#4ade80;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üåÄ SVI & Settleability Analysis
<span style="background:rgba(34,197,94,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">mL/g</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">30-min Settled Vol (mL/L)</label>
<input type="number" id="svi_settled" value="250" step="10" oninput="calcSVI()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">MLSS (mg/L)</label>
<input type="number" id="svi_mlss" value="3000" step="100" oninput="calcSVI()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">SVI</div>
<div id="svi_result" style="font-size:22px;font-weight:700;color:#4ade80">83</div>
<div style="font-size:9px;color:#64748b">mL/g</div>
</div>
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">SDI</div>
<div id="sdi_result" style="font-size:22px;font-weight:700;color:#60a5fa">1.20</div>
<div style="font-size:9px;color:#64748b">g/100mL</div>
</div>
<div style="background:rgba(139,92,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Status</div>
<div id="svi_status" style="font-size:14px;font-weight:700;color:#a78bfa">GOOD</div>
<div style="font-size:9px;color:#64748b">Settling</div>
</div>
</div>
<div id="svi_advice" style="margin-top:10px;padding:8px;background:rgba(34,197,94,0.1);border-radius:6px;font-size:11px;color:#86efac">
‚úì Normal settling characteristics. Maintain current operations.
</div>
</div>

<!-- CHLORINE DOSING CALCULATOR -->
<div id="chlorineCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(234,179,8,0.3)">
<div style="font-size:14px;font-weight:600;color:#fbbf24;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üß™ Chlorine Dosing Calculator
<span style="background:rgba(234,179,8,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">lbs/day</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow (MGD)</label>
<input type="number" id="cl_flow" value="3.5" step="0.1" oninput="calcChlorine()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Target Dose (mg/L)</label>
<input type="number" id="cl_dose" value="4" step="0.5" oninput="calcChlorine()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Solution Strength (%)</label>
<input type="number" id="cl_strength" value="12.5" step="0.5" oninput="calcChlorine()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Contact Time (min)</label>
<input type="number" id="cl_contact" value="30" step="5" oninput="calcChlorine()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
<div style="background:rgba(234,179,8,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Chlorine Required</div>
<div id="cl_lbs" style="font-size:20px;font-weight:700;color:#fbbf24">117</div>
<div style="font-size:9px;color:#64748b">lbs Cl‚ÇÇ/day</div>
</div>
<div style="background:rgba(6,182,212,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Solution Feed Rate</div>
<div id="cl_gpd" style="font-size:20px;font-weight:700;color:#22d3ee">112</div>
<div style="font-size:9px;color:#64748b">GPD</div>
</div>
</div>
</div>

</div>

<!-- ROW 3: Pump & Flow Split -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px">

<!-- PUMP CALCULATOR -->
<div id="pumpCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(239,68,68,0.3)">
<div style="font-size:14px;font-weight:600;color:#f87171;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üîÑ Pump Flow & Head Calculator
<span style="background:rgba(239,68,68,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">GPM/HP</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow Rate (GPM)</label>
<input type="number" id="pump_gpm" value="500" step="50" oninput="calcPump()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Total Dynamic Head (ft)</label>
<input type="number" id="pump_tdh" value="35" step="1" oninput="calcPump()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Pump Efficiency (%)</label>
<input type="number" id="pump_eff" value="70" step="5" oninput="calcPump()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Motor Efficiency (%)</label>
<input type="number" id="pump_motor" value="90" step="5" oninput="calcPump()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(239,68,68,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Water HP</div>
<div id="pump_whp" style="font-size:18px;font-weight:700;color:#f87171">4.4</div>
</div>
<div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Brake HP</div>
<div id="pump_bhp" style="font-size:18px;font-weight:700;color:#fbbf24">6.3</div>
</div>
<div style="background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Motor HP</div>
<div id="pump_mhp" style="font-size:18px;font-weight:700;color:#4ade80">7.5</div>
</div>
</div>
</div>

<!-- FLOW SPLIT CALCULATOR -->
<div id="flowSplitCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(6,182,212,0.3)">
<div style="font-size:14px;font-weight:600;color:#22d3ee;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üîÄ Flow Split Calculator
<span style="background:rgba(6,182,212,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">% Split</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Total Flow (MGD)</label>
<input type="number" id="split_total" value="5.0" step="0.1" oninput="calcFlowSplit()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8"># of Trains/Units</label>
<input type="number" id="split_units" value="3" step="1" min="2" max="10" oninput="calcFlowSplit()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Unit 1 Split (%)</label>
<input type="number" id="split_u1" value="40" step="5" oninput="calcFlowSplit()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Unit 2 Split (%)</label>
<input type="number" id="split_u2" value="35" step="5" oninput="calcFlowSplit()" style="font-size:14px">
</div>
</div>
<div id="flowSplitResults" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(6,182,212,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Unit 1</div>
<div id="split_r1" style="font-size:18px;font-weight:700;color:#22d3ee">2.0</div>
<div style="font-size:9px;color:#64748b">MGD (40%)</div>
</div>
<div style="background:rgba(139,92,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Unit 2</div>
<div id="split_r2" style="font-size:18px;font-weight:700;color:#a78bfa">1.75</div>
<div style="font-size:9px;color:#64748b">MGD (35%)</div>
</div>
<div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Unit 3</div>
<div id="split_r3" style="font-size:18px;font-weight:700;color:#fbbf24">1.25</div>
<div style="font-size:9px;color:#64748b">MGD (25%)</div>
</div>
</div>
</div>

</div>

<!-- ROW 4: Polymer & Aeration -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px">

<!-- POLYMER DOSING CALCULATOR -->
<div id="polymerCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(236,72,153,0.3)">
<div style="font-size:14px;font-weight:600;color:#f472b6;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üß´ Polymer Dosing Calculator
<span style="background:rgba(236,72,153,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">lbs/DT</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Sludge Feed Rate (GPM)</label>
<input type="number" id="poly_gpm" value="100" step="10" oninput="calcPolymer()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Sludge Solids (%)</label>
<input type="number" id="poly_solids" value="2.5" step="0.1" oninput="calcPolymer()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Polymer Dose (lbs/DT)</label>
<input type="number" id="poly_dose" value="15" step="1" oninput="calcPolymer()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Solution Strength (%)</label>
<input type="number" id="poly_strength" value="0.5" step="0.1" oninput="calcPolymer()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
<div style="background:rgba(236,72,153,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Dry Polymer</div>
<div id="poly_dry" style="font-size:20px;font-weight:700;color:#f472b6">27</div>
<div style="font-size:9px;color:#64748b">lbs/day</div>
</div>
<div style="background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Solution Feed</div>
<div id="poly_solution" style="font-size:20px;font-weight:700;color:#4ade80">648</div>
<div style="font-size:9px;color:#64748b">GPD</div>
</div>
</div>
</div>

<!-- AERATION BASIN SIZING -->
<div id="aerationCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(20,184,166,0.3)">
<div style="font-size:14px;font-weight:600;color:#2dd4bf;margin-bottom:12px;display:flex;align-items:center;gap:8px">
ü´ß Aeration Basin Sizing
<span style="background:rgba(20,184,166,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">MG</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow (MGD)</label>
<input type="number" id="aer_flow" value="3.5" step="0.1" oninput="calcAeration()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Target HRT (hours)</label>
<input type="number" id="aer_hrt" value="8" step="1" oninput="calcAeration()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Side Water Depth (ft)</label>
<input type="number" id="aer_depth" value="15" step="1" oninput="calcAeration()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8"># of Basins</label>
<input type="number" id="aer_basins" value="2" step="1" min="1" oninput="calcAeration()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(20,184,166,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Total Volume</div>
<div id="aer_vol" style="font-size:18px;font-weight:700;color:#2dd4bf">1.17</div>
<div style="font-size:9px;color:#64748b">MG</div>
</div>
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Each Basin</div>
<div id="aer_each" style="font-size:18px;font-weight:700;color:#60a5fa">0.58</div>
<div style="font-size:9px;color:#64748b">MG</div>
</div>
<div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Surface Area</div>
<div id="aer_area" style="font-size:18px;font-weight:700;color:#fbbf24">10,400</div>
<div style="font-size:9px;color:#64748b">sq ft each</div>
</div>
</div>
</div>

</div>

<!-- ROW 5: Return Rate & Loading -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px">

<!-- RETURN RATE CALCULATOR -->
<div id="returnRateCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(249,115,22,0.3)">
<div style="font-size:14px;font-weight:600;color:#fb923c;margin-bottom:12px;display:flex;align-items:center;gap:8px">
‚Ü©Ô∏è RAS/WAS Return Rate
<span style="background:rgba(249,115,22,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">%</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Influent Flow (MGD)</label>
<input type="number" id="ras_flow" value="3.5" step="0.1" oninput="calcReturnRate()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Target MLSS (mg/L)</label>
<input type="number" id="ras_mlss" value="3000" step="100" oninput="calcReturnRate()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">RAS Concentration (mg/L)</label>
<input type="number" id="ras_conc" value="8000" step="500" oninput="calcReturnRate()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">WAS Rate (GPD)</label>
<input type="number" id="ras_was" value="25000" step="1000" oninput="calcReturnRate()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(249,115,22,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">RAS Ratio</div>
<div id="ras_ratio" style="font-size:18px;font-weight:700;color:#fb923c">60%</div>
</div>
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">RAS Flow</div>
<div id="ras_mgd" style="font-size:18px;font-weight:700;color:#60a5fa">2.1</div>
<div style="font-size:9px;color:#64748b">MGD</div>
</div>
<div style="background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Recycle</div>
<div id="ras_gpm" style="font-size:18px;font-weight:700;color:#4ade80">1,458</div>
<div style="font-size:9px;color:#64748b">GPM</div>
</div>
</div>
</div>

<!-- LOADING RATE CALCULATOR -->
<div id="loadingCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(132,204,22,0.3)">
<div style="font-size:14px;font-weight:600;color:#a3e635;margin-bottom:12px;display:flex;align-items:center;gap:8px">
‚öñÔ∏è Organic Loading Rates
<span style="background:rgba(132,204,22,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">lbs/day</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow (MGD)</label>
<input type="number" id="load_flow" value="3.5" step="0.1" oninput="calcLoading()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Influent BOD (mg/L)</label>
<input type="number" id="load_bod" value="200" step="10" oninput="calcLoading()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Influent TSS (mg/L)</label>
<input type="number" id="load_tss" value="220" step="10" oninput="calcLoading()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Aeration Volume (MG)</label>
<input type="number" id="load_vol" value="1.0" step="0.1" oninput="calcLoading()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(132,204,22,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">BOD Load</div>
<div id="load_bod_lbs" style="font-size:18px;font-weight:700;color:#a3e635">5,838</div>
<div style="font-size:9px;color:#64748b">lbs/day</div>
</div>
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">TSS Load</div>
<div id="load_tss_lbs" style="font-size:18px;font-weight:700;color:#60a5fa">6,422</div>
<div style="font-size:9px;color:#64748b">lbs/day</div>
</div>
<div style="background:rgba(139,92,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">OLR</div>
<div id="load_olr" style="font-size:18px;font-weight:700;color:#a78bfa">58</div>
<div style="font-size:9px;color:#64748b">lbs BOD/1000 cf</div>
</div>
</div>
</div>

</div>

<!-- ROW 6: Sludge Production & Energy -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px">

<!-- SLUDGE PRODUCTION CALCULATOR -->
<div id="sludgeProdCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(120,113,108,0.3)">
<div style="font-size:14px;font-weight:600;color:#a8a29e;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üöõ Sludge Production Estimate
<span style="background:rgba(120,113,108,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">lbs/day</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow (MGD)</label>
<input type="number" id="sludge_flow" value="3.5" step="0.1" oninput="calcSludgeProd()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">TSS Removed (mg/L)</label>
<input type="number" id="sludge_tss" value="200" step="10" oninput="calcSludgeProd()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Yield Coefficient</label>
<input type="number" id="sludge_yield" value="0.6" step="0.05" oninput="calcSludgeProd()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Dewatered Cake (%)</label>
<input type="number" id="sludge_cake" value="18" step="1" oninput="calcSludgeProd()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(120,113,108,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Dry Solids</div>
<div id="sludge_dry" style="font-size:18px;font-weight:700;color:#a8a29e">3,503</div>
<div style="font-size:9px;color:#64748b">lbs/day</div>
</div>
<div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Wet Cake</div>
<div id="sludge_wet" style="font-size:18px;font-weight:700;color:#fbbf24">19,461</div>
<div style="font-size:9px;color:#64748b">lbs/day</div>
</div>
<div style="background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Weekly Loads</div>
<div id="sludge_loads" style="font-size:18px;font-weight:700;color:#4ade80">3.4</div>
<div style="font-size:9px;color:#64748b">@ 20 tons</div>
</div>
</div>
</div>

<!-- ENERGY COST CALCULATOR -->
<div id="energyCalcAdv" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(251,191,36,0.3)">
<div style="font-size:14px;font-weight:600;color:#fcd34d;margin-bottom:12px;display:flex;align-items:center;gap:8px">
‚ö° Energy Cost Calculator
<span style="background:rgba(251,191,36,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">$/day</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Blower HP</label>
<input type="number" id="energy_hp" value="100" step="10" oninput="calcEnergyCost()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Run Time (hrs/day)</label>
<input type="number" id="energy_hrs" value="20" step="1" oninput="calcEnergyCost()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">kWh Rate ($/kWh)</label>
<input type="number" id="energy_rate" value="0.09" step="0.01" oninput="calcEnergyCost()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Motor Efficiency (%)</label>
<input type="number" id="energy_eff" value="90" step="5" oninput="calcEnergyCost()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(251,191,36,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Daily kWh</div>
<div id="energy_kwh" style="font-size:18px;font-weight:700;color:#fcd34d">1,656</div>
</div>
<div style="background:rgba(239,68,68,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Daily Cost</div>
<div id="energy_daily" style="font-size:18px;font-weight:700;color:#f87171">$149</div>
</div>
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Annual Cost</div>
<div id="energy_annual" style="font-size:18px;font-weight:700;color:#60a5fa">$54K</div>
</div>
</div>
</div>

</div>

</div>
</div>
<!-- ==================== END ADVANCED CALCULATOR SUITE ==================== -->

<!-- ==================== ADVANCED CALCULATOR SUITE II v9.9.20 ==================== -->
<div class="section" id="advancedCalcSuite2" style="border:2px solid #8b5cf6;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);color:white;display:flex;justify-content:space-between;align-items:center">
<div style="display:flex;align-items:center;gap:10px">
<span>üî¨ Advanced Calculator Suite II</span>
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700">10 NEW TOOLS</span>
</div>
<button onclick="resetAdvancedCalcs2()" style="background:rgba(255,255,255,0.2);border:none;padding:6px 12px;border-radius:8px;color:white;font-size:11px;cursor:pointer;font-weight:600">üîÑ Reset All</button>
</div>
<div class="section-content" style="padding:16px">

<!-- Calculator Quick Jump II -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:8px;margin-bottom:20px">
<div onclick="scrollToSection('nutrientRemovalCalc')" style="background:linear-gradient(135deg,#10b981,#34d399);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üß¨</div>
<div style="font-size:9px;color:white;margin-top:2px">Nutrient</div>
</div>
<div onclick="scrollToSection('digesterGasCalc')" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üî•</div>
<div style="font-size:9px;color:white;margin-top:2px">Digester Gas</div>
</div>
<div onclick="scrollToSection('bodCodCalc')" style="background:linear-gradient(135deg,#6366f1,#818cf8);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üìä</div>
<div style="font-size:9px;color:white;margin-top:2px">BOD/COD</div>
</div>
<div onclick="scrollToSection('hydraulicCalc')" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üåä</div>
<div style="font-size:9px;color:white;margin-top:2px">Hydraulics</div>
</div>
<div onclick="scrollToSection('tempCorrCalc')" style="background:linear-gradient(135deg,#ef4444,#f87171);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üå°Ô∏è</div>
<div style="font-size:9px;color:white;margin-top:2px">Temp Corr</div>
</div>
<div onclick="scrollToSection('nitrogenCalc')" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üîµ</div>
<div style="font-size:9px;color:white;margin-top:2px">Nitrogen</div>
</div>
<div onclick="scrollToSection('phosphorusCalc')" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üü£</div>
<div style="font-size:9px;color:white;margin-top:2px">Phosphorus</div>
</div>
<div onclick="scrollToSection('detentionCalc')" style="background:linear-gradient(135deg,#14b8a6,#2dd4bf);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">‚è±Ô∏è</div>
<div style="font-size:9px;color:white;margin-top:2px">Detention</div>
</div>
<div onclick="scrollToSection('velocityCalc')" style="background:linear-gradient(135deg,#ec4899,#f472b6);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">üí®</div>
<div style="font-size:9px;color:white;margin-top:2px">Velocity</div>
</div>
<div onclick="scrollToSection('methaneCalc')" style="background:linear-gradient(135deg,#d97706,#f59e0b);padding:10px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:16px">‚ö°</div>
<div style="font-size:9px;color:white;margin-top:2px">Methane</div>
</div>
</div>

<!-- ROW 1: Nutrient Removal & Digester Gas -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px">

<!-- NUTRIENT REMOVAL CALCULATOR -->
<div id="nutrientRemovalCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(16,185,129,0.3)">
<div style="font-size:14px;font-weight:600;color:#34d399;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üß¨ Nutrient Removal Efficiency
<span style="background:rgba(16,185,129,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">BNR</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Influent TN (mg/L)</label>
<input type="number" id="bnr_tn_in" value="40" step="1" oninput="calcNutrientRemoval()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Effluent TN (mg/L)</label>
<input type="number" id="bnr_tn_out" value="8" step="0.5" oninput="calcNutrientRemoval()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Influent TP (mg/L)</label>
<input type="number" id="bnr_tp_in" value="7" step="0.5" oninput="calcNutrientRemoval()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Effluent TP (mg/L)</label>
<input type="number" id="bnr_tp_out" value="0.8" step="0.1" oninput="calcNutrientRemoval()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
<div style="background:rgba(16,185,129,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">TN Removal</div>
<div id="bnr_tn_pct" style="font-size:22px;font-weight:700;color:#34d399">80%</div>
<div id="bnr_tn_status" style="font-size:9px;color:#4ade80">Excellent</div>
</div>
<div style="background:rgba(139,92,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">TP Removal</div>
<div id="bnr_tp_pct" style="font-size:22px;font-weight:700;color:#a78bfa">89%</div>
<div id="bnr_tp_status" style="font-size:9px;color:#4ade80">Excellent</div>
</div>
</div>
<div id="bnr_advice" style="margin-top:10px;padding:8px;background:rgba(16,185,129,0.1);border-radius:6px;font-size:11px;color:#86efac">
‚úì BNR system operating at optimal efficiency
</div>
</div>

<!-- DIGESTER GAS PRODUCTION CALCULATOR -->
<div id="digesterGasCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(245,158,11,0.3)">
<div style="font-size:14px;font-weight:600;color:#fbbf24;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üî• Digester Gas Production
<span style="background:rgba(245,158,11,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">cf/day</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">VS Destroyed (lbs/day)</label>
<input type="number" id="dig_vs" value="5000" step="100" oninput="calcDigesterGas()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Gas Yield (cf/lb VS)</label>
<input type="number" id="dig_yield" value="15" step="1" oninput="calcDigesterGas()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Methane Content (%)</label>
<input type="number" id="dig_methane" value="65" step="1" oninput="calcDigesterGas()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Engine Efficiency (%)</label>
<input type="number" id="dig_eng_eff" value="35" step="5" oninput="calcDigesterGas()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Total Gas</div>
<div id="dig_total_gas" style="font-size:18px;font-weight:700;color:#fbbf24">75,000</div>
<div style="font-size:9px;color:#64748b">cf/day</div>
</div>
<div style="background:rgba(239,68,68,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">BTU/day</div>
<div id="dig_btu" style="font-size:18px;font-weight:700;color:#f87171">30.4M</div>
<div style="font-size:9px;color:#64748b">million</div>
</div>
<div style="background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Power Gen</div>
<div id="dig_kw" style="font-size:18px;font-weight:700;color:#4ade80">130</div>
<div style="font-size:9px;color:#64748b">kW equiv</div>
</div>
</div>
</div>

</div>

<!-- ROW 2: BOD/COD & Hydraulics -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px">

<!-- BOD/COD RATIO CALCULATOR -->
<div id="bodCodCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(99,102,241,0.3)">
<div style="font-size:14px;font-weight:600;color:#818cf8;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üìä BOD/COD Ratio Analysis
<span style="background:rgba(99,102,241,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">RATIO</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Influent BOD‚ÇÖ (mg/L)</label>
<input type="number" id="bc_bod" value="200" step="10" oninput="calcBodCod()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Influent COD (mg/L)</label>
<input type="number" id="bc_cod" value="450" step="10" oninput="calcBodCod()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Effluent BOD‚ÇÖ (mg/L)</label>
<input type="number" id="bc_bod_eff" value="10" step="1" oninput="calcBodCod()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Effluent COD (mg/L)</label>
<input type="number" id="bc_cod_eff" value="40" step="5" oninput="calcBodCod()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(99,102,241,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">BOD/COD</div>
<div id="bc_ratio" style="font-size:22px;font-weight:700;color:#818cf8">0.44</div>
<div id="bc_biod" style="font-size:9px;color:#4ade80">Biodegradable</div>
</div>
<div style="background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">BOD Removal</div>
<div id="bc_bod_rem" style="font-size:18px;font-weight:700;color:#4ade80">95%</div>
</div>
<div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">COD Removal</div>
<div id="bc_cod_rem" style="font-size:18px;font-weight:700;color:#fbbf24">91%</div>
</div>
</div>
<div id="bc_advice" style="margin-top:10px;padding:8px;background:rgba(99,102,241,0.1);border-radius:6px;font-size:11px;color:#a5b4fc">
‚úì Typical municipal wastewater - readily biodegradable
</div>
</div>

<!-- HYDRAULIC CALCULATOR -->
<div id="hydraulicCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(14,165,233,0.3)">
<div style="font-size:14px;font-weight:600;color:#38bdf8;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üåä Pipe Hydraulics (Hazen-Williams)
<span style="background:rgba(14,165,233,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">ft/s</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow (GPM)</label>
<input type="number" id="hyd_flow" value="2000" step="100" oninput="calcHydraulic()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Pipe Diameter (in)</label>
<input type="number" id="hyd_dia" value="12" step="1" oninput="calcHydraulic()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Pipe Length (ft)</label>
<input type="number" id="hyd_length" value="1000" step="50" oninput="calcHydraulic()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">C-Factor</label>
<input type="number" id="hyd_c" value="120" step="10" oninput="calcHydraulic()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(14,165,233,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Velocity</div>
<div id="hyd_vel" style="font-size:18px;font-weight:700;color:#38bdf8">5.67</div>
<div style="font-size:9px;color:#64748b">ft/sec</div>
</div>
<div style="background:rgba(139,92,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Head Loss</div>
<div id="hyd_hl" style="font-size:18px;font-weight:700;color:#a78bfa">4.82</div>
<div style="font-size:9px;color:#64748b">ft</div>
</div>
<div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">HL/100ft</div>
<div id="hyd_hl100" style="font-size:18px;font-weight:700;color:#fbbf24">0.48</div>
<div style="font-size:9px;color:#64748b">ft</div>
</div>
</div>
<div id="hyd_advice" style="margin-top:10px;padding:8px;background:rgba(14,165,233,0.1);border-radius:6px;font-size:11px;color:#7dd3fc">
‚úì Velocity within acceptable range (2-10 ft/s)
</div>
</div>

</div>

<!-- ROW 3: Temperature Correction & Nitrogen Balance -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px">

<!-- TEMPERATURE CORRECTION CALCULATOR -->
<div id="tempCorrCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(239,68,68,0.3)">
<div style="font-size:14px;font-weight:600;color:#f87171;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üå°Ô∏è Temperature Correction Factors
<span style="background:rgba(239,68,68,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">Œ∏</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Design Temp (¬∞C)</label>
<input type="number" id="temp_design" value="20" step="1" oninput="calcTempCorr()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Operating Temp (¬∞C)</label>
<input type="number" id="temp_oper" value="15" step="1" oninput="calcTempCorr()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">BOD Rate (Œ∏ = 1.047)</label>
<input type="number" id="temp_bod_rate" value="0.5" step="0.1" oninput="calcTempCorr()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Nitrif. Rate (Œ∏ = 1.098)</label>
<input type="number" id="temp_nit_rate" value="2.0" step="0.1" oninput="calcTempCorr()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
<div style="background:rgba(239,68,68,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">BOD Rate @ Temp</div>
<div id="temp_bod_adj" style="font-size:20px;font-weight:700;color:#f87171">0.40</div>
<div style="font-size:9px;color:#64748b">per day</div>
</div>
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Nitrif. Rate @ Temp</div>
<div id="temp_nit_adj" style="font-size:20px;font-weight:700;color:#60a5fa">1.22</div>
<div style="font-size:9px;color:#64748b">mg/L/hr</div>
</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
<div style="background:rgba(16,185,129,0.1);padding:8px;border-radius:6px;text-align:center">
<div style="font-size:9px;color:#94a3b8">BOD Œ∏ Factor</div>
<div id="temp_bod_theta" style="font-size:14px;font-weight:600;color:#34d399">0.79</div>
</div>
<div style="background:rgba(139,92,246,0.1);padding:8px;border-radius:6px;text-align:center">
<div style="font-size:9px;color:#94a3b8">Nitrif. Œ∏ Factor</div>
<div id="temp_nit_theta" style="font-size:14px;font-weight:600;color:#a78bfa">0.61</div>
</div>
</div>
</div>

<!-- NITROGEN BALANCE CALCULATOR -->
<div id="nitrogenCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(5,150,105,0.3)">
<div style="font-size:14px;font-weight:600;color:#10b981;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üîµ Nitrogen Mass Balance
<span style="background:rgba(5,150,105,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">lbs/day</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow (MGD)</label>
<input type="number" id="n_flow" value="3.5" step="0.1" oninput="calcNitrogen()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Inf. TKN (mg/L)</label>
<input type="number" id="n_tkn_in" value="35" step="1" oninput="calcNitrogen()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Eff. NH‚ÇÉ-N (mg/L)</label>
<input type="number" id="n_nh3_out" value="1.5" step="0.5" oninput="calcNitrogen()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Eff. NO‚ÇÉ-N (mg/L)</label>
<input type="number" id="n_no3_out" value="8" step="0.5" oninput="calcNitrogen()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(5,150,105,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">TKN Load In</div>
<div id="n_tkn_load" style="font-size:18px;font-weight:700;color:#10b981">1,022</div>
<div style="font-size:9px;color:#64748b">lbs/day</div>
</div>
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">N Denitrified</div>
<div id="n_denit" style="font-size:18px;font-weight:700;color:#60a5fa">744</div>
<div style="font-size:9px;color:#64748b">lbs/day</div>
</div>
<div style="background:rgba(139,92,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Eff. TN</div>
<div id="n_eff_tn" style="font-size:18px;font-weight:700;color:#a78bfa">9.5</div>
<div style="font-size:9px;color:#64748b">mg/L</div>
</div>
</div>
</div>

</div>

<!-- ROW 4: Phosphorus & Detention Time -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:16px">

<!-- PHOSPHORUS REMOVAL CALCULATOR -->
<div id="phosphorusCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(139,92,246,0.3)">
<div style="font-size:14px;font-weight:600;color:#a78bfa;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üü£ Chemical Phosphorus Removal
<span style="background:rgba(139,92,246,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">Alum/FeCl‚ÇÉ</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow (MGD)</label>
<input type="number" id="p_flow" value="3.5" step="0.1" oninput="calcPhosphorus()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Inf. TP (mg/L)</label>
<input type="number" id="p_inf" value="6" step="0.5" oninput="calcPhosphorus()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Target Eff. TP (mg/L)</label>
<input type="number" id="p_eff" value="0.5" step="0.1" oninput="calcPhosphorus()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Metal:P Ratio</label>
<input type="number" id="p_ratio" value="2.5" step="0.5" oninput="calcPhosphorus()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px">
<div style="background:rgba(139,92,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Alum Required</div>
<div id="p_alum" style="font-size:20px;font-weight:700;color:#a78bfa">320</div>
<div style="font-size:9px;color:#64748b">lbs/day as Al</div>
</div>
<div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Ferric Required</div>
<div id="p_ferric" style="font-size:20px;font-weight:700;color:#fbbf24">640</div>
<div style="font-size:9px;color:#64748b">lbs/day as Fe</div>
</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
<div style="background:rgba(59,130,246,0.1);padding:8px;border-radius:6px;text-align:center">
<div style="font-size:9px;color:#94a3b8">Alum Solution (48%)</div>
<div id="p_alum_gal" style="font-size:14px;font-weight:600;color:#60a5fa">65 GPD</div>
</div>
<div style="background:rgba(34,197,94,0.1);padding:8px;border-radius:6px;text-align:center">
<div style="font-size:9px;color:#94a3b8">Ferric Solution (40%)</div>
<div id="p_ferric_gal" style="font-size:14px;font-weight:600;color:#4ade80">128 GPD</div>
</div>
</div>
</div>

<!-- DETENTION TIME CALCULATOR -->
<div id="detentionCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(20,184,166,0.3)">
<div style="font-size:14px;font-weight:600;color:#2dd4bf;margin-bottom:12px;display:flex;align-items:center;gap:8px">
‚è±Ô∏è Detention Time Calculator
<span style="background:rgba(20,184,166,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">hrs</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Tank Volume (gal)</label>
<input type="number" id="dt_vol" value="500000" step="10000" oninput="calcDetention()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow (MGD)</label>
<input type="number" id="dt_flow" value="3.5" step="0.1" oninput="calcDetention()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Tank Depth (ft)</label>
<input type="number" id="dt_depth" value="12" step="1" oninput="calcDetention()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8"># of Tanks</label>
<input type="number" id="dt_num" value="2" step="1" min="1" oninput="calcDetention()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(20,184,166,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">HRT</div>
<div id="dt_hrt" style="font-size:20px;font-weight:700;color:#2dd4bf">3.43</div>
<div style="font-size:9px;color:#64748b">hours</div>
</div>
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Total Volume</div>
<div id="dt_total" style="font-size:18px;font-weight:700;color:#60a5fa">1.0</div>
<div style="font-size:9px;color:#64748b">MG</div>
</div>
<div style="background:rgba(245,158,11,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Surface Area</div>
<div id="dt_area" style="font-size:18px;font-weight:700;color:#fbbf24">5,568</div>
<div style="font-size:9px;color:#64748b">sq ft each</div>
</div>
</div>
</div>

</div>

<!-- ROW 5: Velocity & Methane Energy -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px">

<!-- CHANNEL VELOCITY CALCULATOR -->
<div id="velocityCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(236,72,153,0.3)">
<div style="font-size:14px;font-weight:600;color:#f472b6;margin-bottom:12px;display:flex;align-items:center;gap:8px">
üí® Channel/Pipe Velocity
<span style="background:rgba(236,72,153,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">ft/s</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Flow (MGD)</label>
<input type="number" id="vel_flow" value="3.5" step="0.1" oninput="calcVelocity()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Channel Width (ft)</label>
<input type="number" id="vel_width" value="4" step="0.5" oninput="calcVelocity()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Water Depth (ft)</label>
<input type="number" id="vel_depth" value="3" step="0.5" oninput="calcVelocity()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Channel Length (ft)</label>
<input type="number" id="vel_length" value="50" step="5" oninput="calcVelocity()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(236,72,153,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Velocity</div>
<div id="vel_fps" style="font-size:20px;font-weight:700;color:#f472b6">0.67</div>
<div style="font-size:9px;color:#64748b">ft/sec</div>
</div>
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Cross-Section</div>
<div id="vel_area" style="font-size:18px;font-weight:700;color:#60a5fa">12</div>
<div style="font-size:9px;color:#64748b">sq ft</div>
</div>
<div style="background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Contact Time</div>
<div id="vel_time" style="font-size:18px;font-weight:700;color:#4ade80">75</div>
<div style="font-size:9px;color:#64748b">seconds</div>
</div>
</div>
<div id="vel_advice" style="margin-top:10px;padding:8px;background:rgba(236,72,153,0.1);border-radius:6px;font-size:11px;color:#f9a8d4">
‚úì Velocity OK for channel flow (min 1.0 ft/s recommended)
</div>
</div>

<!-- METHANE ENERGY CALCULATOR -->
<div id="methaneCalc" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:1px solid rgba(217,119,6,0.3)">
<div style="font-size:14px;font-weight:600;color:#f59e0b;margin-bottom:12px;display:flex;align-items:center;gap:8px">
‚ö° Methane Energy Potential
<span style="background:rgba(217,119,6,0.2);padding:2px 8px;border-radius:6px;font-size:9px;font-weight:600">kWh</span>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Biogas (cf/day)</label>
<input type="number" id="meth_gas" value="75000" step="1000" oninput="calcMethane()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Methane Content (%)</label>
<input type="number" id="meth_pct" value="65" step="1" oninput="calcMethane()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Generator Efficiency (%)</label>
<input type="number" id="meth_eff" value="35" step="5" oninput="calcMethane()" style="font-size:14px">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:11px;color:#94a3b8">Elec. Rate ($/kWh)</label>
<input type="number" id="meth_rate" value="0.09" step="0.01" oninput="calcMethane()" style="font-size:14px">
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px">
<div style="background:rgba(217,119,6,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Methane BTU</div>
<div id="meth_btu" style="font-size:18px;font-weight:700;color:#f59e0b">48.8M</div>
<div style="font-size:9px;color:#64748b">BTU/day</div>
</div>
<div style="background:rgba(34,197,94,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Elec. Potential</div>
<div id="meth_kwh" style="font-size:18px;font-weight:700;color:#4ade80">5,000</div>
<div style="font-size:9px;color:#64748b">kWh/day</div>
</div>
<div style="background:rgba(59,130,246,0.1);padding:10px;border-radius:8px;text-align:center">
<div style="font-size:10px;color:#94a3b8">Daily Value</div>
<div id="meth_value" style="font-size:18px;font-weight:700;color:#60a5fa">$450</div>
<div style="font-size:9px;color:#64748b">/day</div>
</div>
</div>
<div style="margin-top:10px;background:rgba(34,197,94,0.1);padding:8px;border-radius:6px;text-align:center">
<span style="font-size:11px;color:#86efac">Annual Value: </span>
<span id="meth_annual" style="font-size:14px;font-weight:700;color:#4ade80">$164,250</span>
</div>
</div>

</div>

</div>
</div>
<!-- ==================== END ADVANCED CALCULATOR SUITE II ==================== -->

<!-- MASTER SETTINGS - PRIMARY LOCATION -->
<div id="masterSettingsSection" class="section" style="background:linear-gradient(135deg,#059669,#06d6a0);border-radius:12px;margin-bottom:20px">
<div class="section-h" style="color:white;font-size:18px;font-weight:bold">
üéõÔ∏è Master Settings - Auto-Populate All Calculators
</div>
<div class="section-content" style="background:rgba(0,0,0,0.2);border-radius:0 0 12px 12px">
<div class="note" style="background:rgba(255,255,255,0.1);border-left-color:#4ade80;color:white;margin-bottom:15px">
Set values here to populate all calculators, update Dashboard KPIs, and feed Enhanced Calculators below.
</div>
<div class="row" style="gap:15px">
<div class="input-group">
<label style="color:#a7f3d0">Flow Rate (MGD)</label>
<input id="masterFlowPC" type="number" step="0.1" value="3.5" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">Aeration Volume (MG)</label>
<input id="masterAerVolPC" type="number" step="0.1" value="1.0" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">BOD (mg/L)</label>
<input id="masterBODPC" type="number" step="1" value="200" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">MLSS (mg/L)</label>
<input id="masterMLSSPC" type="number" step="100" value="3000" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
</div>
<div class="row" style="gap:15px;margin-top:15px">
<div class="input-group">
<label style="color:#a7f3d0">Clarifier Diameter (ft)</label>
<input id="masterClarDia" type="number" step="1" value="80" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0"># of Clarifiers</label>
<input id="masterClarNum" type="number" step="1" value="2" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">Weir Length (ft)</label>
<input id="masterWeirLen" type="number" step="1" value="500" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">WAS Flow (GPD)</label>
<input id="masterWAS" type="number" step="1000" value="25000" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
</div>
<div class="btns" style="margin-top:15px;gap:10px">
<button onclick="syncMasterToAll()" class="btn" style="background:#047857;color:white;font-weight:bold">üì° Sync All Now</button>
<button onclick="syncAndCalculateAll()" class="btn" style="background:#fbbf24;color:#1e3a5f;font-weight:bold">‚ö° Sync & Calculate</button>
<button onclick="switchPanel('profiles')" class="btn" style="background:#7c3aed;color:white">üè≠ Load Profile</button>
</div>
</div>
</div>

<div class="section" id="loadingParamsSection">
<div class="section-h">üì• Influent Loading Parameters</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Flow Rate (MGD)</label>
<div class="input-with-icon">
<input id="flow" step="0.1" type="number" value="3.5">
<span class="input-icon">üíß</span>
</div>
</div>
<div class="input-group">
<label>BOD (mg/L)</label>
<input id="bod" step="1" type="number" value="200">
</div>
<div class="input-group">
<label>TSS (mg/L)</label>
<input id="tss" step="1" type="number" value="220">
</div>
<div class="input-group">
<label>TKN (mg/L)</label>
<input id="tkn" step="1" type="number" value="40">
</div>
<div class="input-group">
<label>TP (mg/L)</label>
<input id="tp" step="0.1" type="number" value="8">
</div>
<div class="input-group">
<label>COD (mg/L)</label>
<input id="cod" step="1" type="number" value="450">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcLoading()">Calculate Loading</button>
<button class="btn gray" onclick="resetLoading()">Reset</button>
<button class="btn orange" onclick="compareHistorical()">Compare Historical</button>
</div>
</div>
</div>
<div class="section">
<div class="section-h">üìä Loading Results &amp; Analysis</div>
<div class="section-content">
<table class="table">
<thead>
<tr>
<th class="col">Parameter</th>
<th class="col">Value</th>
<th class="col">Unit</th>
<th class="col">7-Day Avg</th>
<th class="col">Trend</th>
<th class="col">Status</th>
</tr>
</thead>
<tbody>
<tr>
<td class="rowh">BOD Load</td>
<td><span class="result" id="r_bodLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_bodLoad">-</span></td>
<td><span id="trend_bodLoad">-</span></td>
<td><span class="status" id="s_bodLoad">-</span></td>
</tr>
<tr>
<td class="rowh">TSS Load</td>
<td><span class="result" id="r_tssLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_tssLoad">-</span></td>
<td><span id="trend_tssLoad">-</span></td>
<td><span class="status" id="s_tssLoad">-</span></td>
</tr>
<tr>
<td class="rowh">TKN Load</td>
<td><span class="result" id="r_tknLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_tknLoad">-</span></td>
<td><span id="trend_tknLoad">-</span></td>
<td><span class="status" id="s_tknLoad">-</span></td>
</tr>
<tr>
<td class="rowh">TP Load</td>
<td><span class="result" id="r_tpLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_tpLoad">-</span></td>
<td><span id="trend_tpLoad">-</span></td>
<td><span class="status" id="s_tpLoad">-</span></td>
</tr>
<tr>
<td class="rowh">COD Load</td>
<td><span class="result" id="r_codLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_codLoad">-</span></td>
<td><span id="trend_codLoad">-</span></td>
<td><span class="status" id="s_codLoad">-</span></td>
</tr>
</tbody>
</table>
<div class="stats-row">
<div class="stat-item">
<div class="stat-label">Organic Loading Rate</div>
<div class="stat-value" id="stat_olr">0.42</div>
<div class="stat-unit">lb BOD/lb MLVSS/d</div>
</div>
<div class="stat-item">
<div class="stat-label">Volumetric Loading</div>
<div class="stat-value" id="stat_volLoad">58.3</div>
<div class="stat-unit">lb BOD/1000 ft¬≥/d</div>
</div>
<div class="stat-item">
<div class="stat-label">BOD:N:P Ratio</div>
<div class="stat-value" id="stat_ratio">100:20:4</div>
<div class="stat-unit">Actual</div>
</div>
</div>
</div>
</div>
<!-- Sludge Panel -->

<!-- Oxygen Panel -->

<!-- Energy Panel -->


<!-- ========== SLUDGE SECTION ========== -->
<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#0096c7,#48cae4);color:white;padding:10px 15px;border-radius:8px;margin-top:20px">üß´ Sludge Management</div>
<div class="section-content">
<div class="note info">Sludge management parameters for activated sludge process control.</div>
</div>
</div>

<div class="section" id="sludgeParamsSection">
<div class="section-h">üß´ Activated Sludge Parameters</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>MLSS (mg/L)</label>
<input id="mlss" step="10" type="number" value="3000">
</div>
<div class="input-group">
<label>MLVSS (mg/L)</label>
<input id="mlvss" step="10" type="number" value="2000">
</div>
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input id="aerVol" step="0.1" type="number" value="1.2">
</div>
<div class="input-group">
<label>RAS Flow (MGD)</label>
<input id="rasFlow" step="0.1" type="number" value="1.5">
</div>
<div class="input-group">
<label>WAS Flow (MGD)</label>
<input id="wasFlow" step="0.01" type="number" value="0.05">
</div>
<div class="input-group">
<label>WAS TSS (mg/L)</label>
<input id="wasTss" step="100" type="number" value="8000">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSludge()">Calculate Sludge</button>
<button class="btn gray" onclick="resetSludge()">Reset</button>
</div>
</div>
</div>
<div class="section">
<div class="section-h">üìä Sludge Results</div>
<div class="section-content">
<table class="table">
<thead>
<tr>
<th class="col">Parameter</th>
<th class="col">Value</th>
<th class="col">Unit</th>
<th class="col">Status</th>
</tr>
</thead>
<tbody>
<tr>
<td class="rowh">F/M Ratio</td>
<td><span class="result" id="r_fm_dash">-</span></td>
<td>lb BOD/lb MLVSS/d</td>
<td><span class="status" id="s_fm">-</span></td>
</tr>
<tr>
<td class="rowh">MCRT (Sludge Age)</td>
<td><span class="result" id="r_mcrt_dash">-</span></td>
<td>days</td>
<td><span class="status" id="s_mcrt">-</span></td>
</tr>
<tr>
<td class="rowh">SVI</td>
<td><span class="result" id="r_svi_dash">-</span></td>
<td>mL/g</td>
<td><span class="status" id="s_svi">-</span></td>
</tr>
<tr>
<td class="rowh">MLSS Inventory</td>
<td><span class="result" id="r_mlss_inv">-</span></td>
<td>lbs</td>
<td><span class="status" id="s_mlss_inv">-</span></td>
</tr>
<tr>
<td class="rowh">WAS Solids</td>
<td><span class="result" id="r_was_solids">-</span></td>
<td>lbs/day</td>
<td><span class="status" id="s_was_solids">-</span></td>
</tr>
<tr>
<td class="rowh">RAS Rate</td>
<td><span class="result" id="r_ras_rate">-</span></td>
<td>% of Q</td>
<td><span class="status" id="s_ras_rate">-</span></td>
</tr>
</tbody>
</table>
</div>
</div>


<!-- ========== OXYGEN SECTION ========== -->
<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#0891b2,#48cae4);color:white;padding:10px 15px;border-radius:8px;margin-top:20px">üí® Oxygen & Aeration</div>
</div>

<div class="section" id="oxygenSection">
<div class="section-h">üí® Oxygen Requirements</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Current DO (mg/L)</label>
<input id="doNow" step="0.1" type="number" value="2.0">
</div>
<div class="input-group">
<label>Target DO (mg/L)</label>
<input id="doTarget" step="0.1" type="number" value="2.5">
</div>
<div class="input-group">
<label>Peak Factor</label>
<input id="peakFactor" step="0.1" type="number" value="1.5">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcOxygen()">Calculate Oxygen</button>
<button class="btn gray" onclick="resetOxygen()">Reset</button>
</div>
<div class="stats-row" style="margin-top:20px">
<div class="stat-item">
<div class="stat-label">O‚ÇÇ Required</div>
<div class="stat-value" id="r_o2req">-</div>
<div class="stat-unit">lb O‚ÇÇ/d</div>
</div>
<div class="stat-item">
<div class="stat-label">Peak Demand</div>
<div class="stat-value" id="r_o2peak">-</div>
<div class="stat-unit">lb O‚ÇÇ/hr</div>
</div>
<div class="stat-item">
<div class="stat-label">Airflow</div>
<div class="stat-value" id="r_airflow">-</div>
<div class="stat-unit">CFM</div>
</div>
</div>
</div>
</div>

<!-- ========== ENHANCED CALCULATORS SECTION ========== -->
<div class="section" style="background:linear-gradient(135deg,#1e1b4b,#312e81);border-radius:16px;margin-top:20px;border:3px solid #6366f1">
<div class="section-h" style="color:white;font-size:20px;background:linear-gradient(135deg,#4f46e5,#6366f1);padding:16px;border-radius:12px 12px 0 0">
üßÆ Enhanced Calculators <span class="auto-calc-badge">Auto-Calculate</span>
<div style="float:right;display:flex;gap:10px;align-items:center">
<div class="unit-toggle" id="unitToggle">
<button class="active" onclick="setUnits('us')">US</button>
<button onclick="setUnits('metric')">Metric</button>
</div>
</div>
</div>
<div class="section-content" style="background:rgba(0,0,0,0.3)">

<!-- Calculator Toolbar -->
<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button onclick="toggleFormulaDisplay()" class="btn" style="background:#3b82f6;color:white">üìê Show Formulas</button>
<button onclick="saveCalcResults()" class="btn" style="background:#10b981;color:white">üíæ Save Results</button>
<button onclick="toggleCompareMode()" class="btn" style="background:#8b5cf6;color:white">‚öñÔ∏è Compare Mode</button>
<button onclick="showCalcHistory()" class="btn" style="background:#f59e0b;color:#1e3a5f">üìú History</button>
<button onclick="exportCalcResults()" class="btn" style="background:#06b6d4;color:white">üì§ Export</button>
</div>

<!-- Enhanced Result Cards Grid -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">

<!-- F/M Ratio Card with Gauge -->
<div class="calc-result-card" id="fmCard">
<div class="label">F/M Ratio</div>
<div class="gauge-container">
<svg viewBox="0 0 150 90" style="width:100%;height:auto">
<path class="gauge-bg" d="M 20 80 A 55 55 0 0 1 130 80" />
<path class="gauge-fill" id="fmGauge" d="M 20 80 A 55 55 0 0 1 130 80" stroke="#10b981" style="stroke-dasharray:173;stroke-dashoffset:130" />
<text class="gauge-value" x="75" y="70" id="fmGaugeValue">0.25</text>
<text class="gauge-label" x="75" y="85">lb BOD/lb MLVSS/day</text>
</svg>
</div>
<div class="status-badge optimal" id="fmStatus">‚úì Optimal</div>
<div style="margin-top:8px;font-size:11px;color:#64748b">Target: 0.2 - 0.5</div>
</div>

<!-- SVI Card with Gauge -->
<div class="calc-result-card" id="sviCard">
<div class="label">SVI</div>
<div class="gauge-container">
<svg viewBox="0 0 150 90" style="width:100%;height:auto">
<path class="gauge-bg" d="M 20 80 A 55 55 0 0 1 130 80" />
<path class="gauge-fill" id="sviGauge" d="M 20 80 A 55 55 0 0 1 130 80" stroke="#10b981" style="stroke-dasharray:173;stroke-dashoffset:100" />
<text class="gauge-value" x="75" y="70" id="sviGaugeValue">120</text>
<text class="gauge-label" x="75" y="85">mL/g</text>
</svg>
</div>
<div class="status-badge optimal" id="sviStatus">‚úì Good Settling</div>
<div style="margin-top:8px;font-size:11px;color:#64748b">Target: 80 - 150</div>
</div>

<!-- SRT Card with Gauge -->
<div class="calc-result-card" id="srtCard">
<div class="label">SRT (Sludge Age)</div>
<div class="gauge-container">
<svg viewBox="0 0 150 90" style="width:100%;height:auto">
<path class="gauge-bg" d="M 20 80 A 55 55 0 0 1 130 80" />
<path class="gauge-fill" id="srtGauge" d="M 20 80 A 55 55 0 0 1 130 80" stroke="#10b981" style="stroke-dasharray:173;stroke-dashoffset:86" />
<text class="gauge-value" x="75" y="70" id="srtGaugeValue">10</text>
<text class="gauge-label" x="75" y="85">days</text>
</svg>
</div>
<div class="status-badge optimal" id="srtStatus">‚úì Optimal</div>
<div style="margin-top:8px;font-size:11px;color:#64748b">Target: 5 - 15 days</div>
</div>

<!-- MLSS Inventory Card -->
<div class="calc-result-card" id="mlssCard">
<div class="label">MLSS Inventory</div>
<div class="value" id="mlssInvValue">25,000</div>
<div class="unit">lbs</div>
<div class="status-badge optimal" id="mlssStatus">‚úì Normal</div>
<div style="margin-top:8px;font-size:11px;color:#64748b;display:flex;justify-content:center;align-items:center;gap:4px">
<span class="trend-arrow trend-stable">‚Üí</span> Stable
</div>
</div>

</div>

<!-- New Calculators Row -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:24px">

<!-- Detention Time Calculator -->
<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
‚è±Ô∏è Detention Time Calculator
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">Tank Volume</label>
<input id="dt_volume" type="number" step="0.1" value="1.0" oninput="calcDetentionTime()" style="font-size:14px">
<span style="font-size:11px;color:#64748b" id="dt_vol_unit">MG</span>
</div>
<div class="input-group">
<label style="font-size:13px">Flow Rate</label>
<input id="dt_flow" type="number" step="0.1" value="3.5" oninput="calcDetentionTime()" style="font-size:14px">
<span style="font-size:11px;color:#64748b" id="dt_flow_unit">MGD</span>
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Detention Time</div>
<div style="font-size:20px;font-weight:bold;color:white" id="dt_result">6.86</div>
<div style="font-size:13px;color:#64748b" id="dt_result_unit">hours</div>
</div>
<div class="formula-box" id="dt_formula">HRT = (Volume √ó 24) / Flow = (1.0 MG √ó 24) / 3.5 MGD = 6.86 hrs</div>
</div>

<!-- Surface Overflow Rate Calculator -->
<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
üìê Surface Overflow Rate
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">Flow Rate</label>
<input id="sor_flow" type="number" step="0.1" value="3.5" oninput="calcSOR()" style="font-size:14px">
<span style="font-size:11px;color:#64748b">MGD</span>
</div>
<div class="input-group">
<label style="font-size:13px">Clarifier Diameter</label>
<input id="sor_dia" type="number" step="1" value="80" oninput="calcSOR_Clarifier()" style="font-size:14px">
<span style="font-size:11px;color:#64748b">ft</span>
</div>
<div class="input-group">
<label style="font-size:13px"># Clarifiers</label>
<input id="sor_num" type="number" step="1" value="2" oninput="calcSOR_Clarifier()" style="font-size:14px">
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Surface Overflow Rate</div>
<div style="font-size:20px;font-weight:bold" id="sor_result" style="color:#10b981">348</div>
<div style="font-size:13px;color:#64748b">GPD/sq ft</div>
<div style="font-size:11px;margin-top:4px" id="sor_status" style="color:#10b981">‚úì Good (300-800 typical)</div>
</div>
<div class="formula-box" id="sor_formula">SOR = Flow / Area = 3,500,000 GPD / 10,053 sq ft = 348 GPD/ft¬≤</div>
</div>

<!-- Weir Loading Calculator -->
<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
üåä Weir Loading Rate
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">Flow Rate</label>
<input id="weir_flow" type="number" step="0.1" value="3.5" oninput="calcWeirLoading()" style="font-size:14px">
<span style="font-size:11px;color:#64748b">MGD</span>
</div>
<div class="input-group">
<label style="font-size:13px">Weir Length</label>
<input id="weir_length" type="number" step="1" value="500" oninput="calcWeirLoading()" style="font-size:14px">
<span style="font-size:11px;color:#64748b">ft</span>
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Weir Loading</div>
<div style="font-size:20px;font-weight:bold" id="weir_result" style="color:#10b981">7,000</div>
<div style="font-size:13px;color:#64748b">GPD/ft</div>
<div style="font-size:11px;margin-top:4px" id="weir_status" style="color:#10b981">‚úì Good (&lt;10,000 typical)</div>
</div>
<div class="formula-box" id="weir_formula">WLR = Flow / Weir Length = 3,500,000 / 500 = 7,000 GPD/ft</div>
</div>

<!-- Oxygen Requirement Calculator -->
<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
üí® Oxygen Requirement
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">BOD Removed (lb/d)</label>
<input id="o2_bod" type="number" step="100" value="5000" oninput="calcOxygenReq()" style="font-size:14px">
</div>
<div class="input-group">
<label style="font-size:13px">TKN Oxidized (lb/d)</label>
<input id="o2_tkn" type="number" step="10" value="400" oninput="calcOxygenReq()" style="font-size:14px">
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Oxygen Required</div>
<div style="font-size:20px;font-weight:bold;color:white" id="o2_result">8,320</div>
<div style="font-size:13px;color:#64748b">lb O‚ÇÇ/day</div>
<div style="font-size:11px;margin-top:4px;color:#94a3b8" id="o2_hourly">347 lb/hr</div>
</div>
<div class="formula-box" id="o2_formula">O‚ÇÇ = 1.5√óBOD + 4.6√óTKN = 1.5√ó5000 + 4.6√ó400 = 8,320 lb/d</div>
</div>

<!-- Chemical Cost Calculator -->
<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
üí∞ Chemical Cost Calculator
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">Flow (MGD)</label>
<input id="chem_flow" type="number" step="0.1" value="3.5" oninput="calcChemCost()" style="font-size:14px">
</div>
<div class="input-group">
<label style="font-size:13px">Dose (mg/L)</label>
<input id="chem_dose" type="number" step="1" value="50" oninput="calcChemCost()" style="font-size:14px">
</div>
<div class="input-group">
<label style="font-size:13px">Cost ($/lb)</label>
<input id="chem_cost" type="number" step="0.01" value="0.25" oninput="calcChemCost()" style="font-size:14px">
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Daily Chemical Cost</div>
<div style="font-size:20px;font-weight:bold;color:#fbbf24" id="chem_daily">$365</div>
<div style="font-size:13px;color:#64748b">per day</div>
<div style="font-size:11px;margin-top:4px;color:#94a3b8" id="chem_monthly">$10,950/month ‚Ä¢ $133,225/year</div>
</div>
<div class="formula-box" id="chem_formula">lbs/d = Flow √ó Dose √ó 8.34 = 3.5 √ó 50 √ó 8.34 = 1,460 lb/d √ó $0.25 = $365/d</div>
</div>

<!-- SRT Calculator -->
<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
üìÖ SRT / Sludge Age
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">Aeration Vol (MG)</label>
<input id="srt_vol" type="number" step="0.1" value="1.0" oninput="calcSRT()" style="font-size:14px">
</div>
<div class="input-group">
<label style="font-size:13px">MLSS (mg/L)</label>
<input id="srt_mlss" type="number" step="100" value="3000" oninput="calcSRT()" style="font-size:14px">
</div>
</div>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">WAS Flow (GPD)</label>
<input id="srt_was" type="number" step="1000" value="25000" oninput="calcSRT()" style="font-size:14px">
</div>
<div class="input-group">
<label style="font-size:13px">WAS TSS (mg/L)</label>
<input id="srt_wastss" type="number" step="100" value="8000" oninput="calcSRT()" style="font-size:14px">
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Sludge Retention Time</div>
<div style="font-size:20px;font-weight:bold" id="srt_result" style="color:#10b981">15.0</div>
<div style="font-size:13px;color:#64748b">days</div>
<div style="font-size:11px;margin-top:4px" id="srt_status" style="color:#10b981">‚úì Good for nitrification</div>
</div>
<div class="formula-box" id="srt_formula">SRT = (Vol √ó MLSS √ó 8.34) / (WAS √ó WAS_TSS √ó 8.34)</div>
</div>

</div>

<!-- Calculator History Modal (hidden) -->
<div id="calcHistoryModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:99999;padding:20px;overflow-y:auto">
<div style="max-width:600px;margin:0 auto;background:#1e1b4b;border-radius:16px;padding:24px;border:3px solid #6366f1">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h3 style="margin:0;color:white">üìú Calculation History</h3>
<button onclick="closeCalcHistory()" style="background:#ef4444;border:none;color:white;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:18px">‚úï</button>
</div>
<div id="calcHistoryList" style="max-height:60vh;overflow-y:auto">
<p style="color:#94a3b8;text-align:center">No saved calculations yet.</p>
</div>
<div style="margin-top:20px;display:flex;gap:10px">
<button onclick="clearCalcHistory()" class="btn" style="background:#ef4444;color:white;flex:1">üóëÔ∏è Clear History</button>
<button onclick="exportCalcHistory()" class="btn" style="background:#10b981;color:white;flex:1">üì§ Export CSV</button>
</div>
</div>
</div>

<!-- Compare Mode Panel (hidden) -->
<div id="compareModePanel" style="display:none;background:rgba(99,102,241,0.1);border:2px solid #6366f1;border-radius:12px;padding:20px;margin-top:20px">
<h4 style="margin:0 0 16px 0;color:#a5b4fc">‚öñÔ∏è Compare Mode - Side by Side Analysis</h4>
<div class="compare-grid">
<div class="compare-column">
<h4 style="color:#60a5fa">Scenario A (Current)</h4>
<div id="compareA">Values will appear here...</div>
</div>
<div class="compare-column">
<h4 style="color:#f59e0b">Scenario B (What-If)</h4>
<div id="compareB">Adjust values to compare...</div>
</div>
</div>
</div>

</div>
</div>
<!-- ========== END ENHANCED CALCULATORS ========== -->

<!-- ========== SPC/SQC CONTROL CHARTS v9.9.16 ========== -->
<div class="section" id="spcChartsSection" style="border:2px solid #06b6d4">
<div class="section-h" style="background:linear-gradient(135deg,#0891b2,#06b6d4);color:white">
üìà Statistical Process Control (SPC) Charts
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.16</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Monitor process stability with control charts. UCL/LCL automatically calculated from your data. Out-of-control points trigger alerts.</p>

<!-- Parameter Selection -->
<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px">
<button onclick="SPCCharts.showChart('do')" class="spc-param-btn active" id="spc-btn-do" style="padding:10px 16px;border-radius:8px;border:2px solid #06b6d4;background:#06b6d4;color:white;font-weight:600;cursor:pointer;transition:all 0.2s">DO (mg/L)</button>
<button onclick="SPCCharts.showChart('mlss')" class="spc-param-btn" id="spc-btn-mlss" style="padding:10px 16px;border-radius:8px;border:2px solid #06b6d4;background:transparent;color:#06b6d4;font-weight:600;cursor:pointer;transition:all 0.2s">MLSS (mg/L)</button>
<button onclick="SPCCharts.showChart('ph')" class="spc-param-btn" id="spc-btn-ph" style="padding:10px 16px;border-radius:8px;border:2px solid #06b6d4;background:transparent;color:#06b6d4;font-weight:600;cursor:pointer;transition:all 0.2s">pH</button>
<button onclick="SPCCharts.showChart('svi')" class="spc-param-btn" id="spc-btn-svi" style="padding:10px 16px;border-radius:8px;border:2px solid #06b6d4;background:transparent;color:#06b6d4;font-weight:600;cursor:pointer;transition:all 0.2s">SVI (mL/g)</button>
<button onclick="SPCCharts.showChart('tss')" class="spc-param-btn" id="spc-btn-tss" style="padding:10px 16px;border-radius:8px;border:2px solid #06b6d4;background:transparent;color:#06b6d4;font-weight:600;cursor:pointer;transition:all 0.2s">Eff TSS (mg/L)</button>
<button onclick="SPCCharts.showChart('nh3')" class="spc-param-btn" id="spc-btn-nh3" style="padding:10px 16px;border-radius:8px;border:2px solid #06b6d4;background:transparent;color:#06b6d4;font-weight:600;cursor:pointer;transition:all 0.2s">Eff NH‚ÇÉ (mg/L)</button>
</div>

<!-- Chart Container -->
<div id="spcChartContainer" style="background:#0f172a;border-radius:12px;padding:20px;margin-bottom:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h4 style="margin:0;color:#22d3ee" id="spcChartTitle">üìä DO Control Chart</h4>
<div style="display:flex;gap:10px;align-items:center">
<span id="spcStatus" style="padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;background:#059669;color:white">‚úì In Control</span>
<button onclick="SPCCharts.exportData()" style="background:#374151;border:none;color:#94a3b8;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">üì• Export</button>
</div>
</div>

<!-- Control Chart Canvas -->
<div style="position:relative;height:280px;margin-bottom:15px">
<canvas id="spcChartCanvas"></canvas>
</div>

<!-- Control Limits Display -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:15px">
<div style="background:#1e293b;padding:12px;border-radius:8px;text-align:center;border-top:3px solid #ef4444">
<div style="font-size:11px;color:#94a3b8">UCL (+3œÉ)</div>
<div style="font-size:20px;font-weight:bold;color:#ef4444" id="spcUCL">3.2</div>
</div>
<div style="background:#1e293b;padding:12px;border-radius:8px;text-align:center;border-top:3px solid #f59e0b">
<div style="font-size:11px;color:#94a3b8">UWL (+2œÉ)</div>
<div style="font-size:20px;font-weight:bold;color:#f59e0b" id="spcUWL">2.9</div>
</div>
<div style="background:#1e293b;padding:12px;border-radius:8px;text-align:center;border-top:3px solid #22c55e">
<div style="font-size:11px;color:#94a3b8">CL (Mean)</div>
<div style="font-size:20px;font-weight:bold;color:#22c55e" id="spcCL">2.3</div>
</div>
<div style="background:#1e293b;padding:12px;border-radius:8px;text-align:center;border-top:3px solid #f59e0b">
<div style="font-size:11px;color:#94a3b8">LWL (-2œÉ)</div>
<div style="font-size:20px;font-weight:bold;color:#f59e0b" id="spcLWL">1.7</div>
</div>
<div style="background:#1e293b;padding:12px;border-radius:8px;text-align:center;border-top:3px solid #ef4444">
<div style="font-size:11px;color:#94a3b8">LCL (-3œÉ)</div>
<div style="font-size:20px;font-weight:bold;color:#ef4444" id="spcLCL">1.4</div>
</div>
<div style="background:#1e293b;padding:12px;border-radius:8px;text-align:center;border-top:3px solid #3b82f6">
<div style="font-size:11px;color:#94a3b8">Std Dev (œÉ)</div>
<div style="font-size:20px;font-weight:bold;color:#3b82f6" id="spcStdDev">0.30</div>
</div>
</div>

<!-- Statistics Summary -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px">
<div style="background:#1e293b;padding:12px;border-radius:8px">
<div style="font-size:11px;color:#94a3b8">Data Points</div>
<div style="font-size:18px;font-weight:bold;color:#e2e8f0" id="spcDataPoints">30</div>
</div>
<div style="background:#1e293b;padding:12px;border-radius:8px">
<div style="font-size:11px;color:#94a3b8">Out of Control</div>
<div style="font-size:18px;font-weight:bold;color:#ef4444" id="spcOOC">0</div>
</div>
<div style="background:#1e293b;padding:12px;border-radius:8px">
<div style="font-size:11px;color:#94a3b8">Cp Index</div>
<div style="font-size:18px;font-weight:bold;color:#22d3ee" id="spcCp">1.33</div>
</div>
<div style="background:#1e293b;padding:12px;border-radius:8px">
<div style="font-size:11px;color:#94a3b8">Cpk Index</div>
<div style="font-size:18px;font-weight:bold;color:#22d3ee" id="spcCpk">1.21</div>
</div>
</div>
</div>

<!-- Data Entry Section -->
<div style="background:#1e293b;border-radius:12px;padding:20px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#06b6d4">üìù Add Data Point</h4>
<div class="row" style="gap:15px">
<div class="input-group">
<label>Date</label>
<input type="date" id="spcDataDate" style="background:#0f172a">
</div>
<div class="input-group">
<label>Time</label>
<input type="time" id="spcDataTime" value="08:00" style="background:#0f172a">
</div>
<div class="input-group">
<label>Value</label>
<input type="number" id="spcDataValue" step="0.1" placeholder="Enter value" style="background:#0f172a">
</div>
<div class="input-group">
<label>Notes (optional)</label>
<input type="text" id="spcDataNotes" placeholder="e.g., After RAS adjustment" style="background:#0f172a">
</div>
</div>
<div class="btns" style="margin-top:15px">
<button onclick="SPCCharts.addDataPoint()" class="btn" style="background:#06b6d4;color:white">‚ûï Add Data Point</button>
<button onclick="SPCCharts.generateSampleData()" class="btn" style="background:#374151;color:#e2e8f0">üé≤ Generate Sample Data</button>
<button onclick="SPCCharts.clearData()" class="btn" style="background:#7f1d1d;color:#fca5a5">üóëÔ∏è Clear Data</button>
</div>
</div>

<!-- Western Electric Rules -->
<div style="background:#1e293b;border-radius:12px;padding:20px">
<h4 style="margin:0 0 15px 0;color:#f59e0b">‚ö†Ô∏è Western Electric Rules (Out-of-Control Detection)</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
<div style="background:#0f172a;padding:12px;border-radius:8px;border-left:3px solid #ef4444">
<strong style="color:#fca5a5">Rule 1:</strong> <span style="color:#e2e8f0">1 point beyond 3œÉ (UCL/LCL)</span>
<div id="spcRule1" style="margin-top:6px;font-size:13px;color:#22c55e">‚úì Pass</div>
</div>
<div style="background:#0f172a;padding:12px;border-radius:8px;border-left:3px solid #f59e0b">
<strong style="color:#fcd34d">Rule 2:</strong> <span style="color:#e2e8f0">2 of 3 points beyond 2œÉ (same side)</span>
<div id="spcRule2" style="margin-top:6px;font-size:13px;color:#22c55e">‚úì Pass</div>
</div>
<div style="background:#0f172a;padding:12px;border-radius:8px;border-left:3px solid #3b82f6">
<strong style="color:#93c5fd">Rule 3:</strong> <span style="color:#e2e8f0">4 of 5 points beyond 1œÉ (same side)</span>
<div id="spcRule3" style="margin-top:6px;font-size:13px;color:#22c55e">‚úì Pass</div>
</div>
<div style="background:#0f172a;padding:12px;border-radius:8px;border-left:3px solid #8b5cf6">
<strong style="color:#c4b5fd">Rule 4:</strong> <span style="color:#e2e8f0">8 consecutive points on same side of CL</span>
<div id="spcRule4" style="margin-top:6px;font-size:13px;color:#22c55e">‚úì Pass</div>
</div>
</div>
</div>

<!-- Trend Analysis -->
<div style="margin-top:20px;padding:15px;background:#0f172a;border-radius:12px;display:none" id="spcTrendAlert">
<div style="display:flex;align-items:center;gap:12px">
<span style="font-size:28px">üìâ</span>
<div>
<div style="font-weight:bold;color:#fbbf24">Trend Detected</div>
<div style="font-size:13px;color:#e2e8f0" id="spcTrendMsg">7 consecutive decreasing points detected. Investigate potential causes.</div>
</div>
</div>
</div>

</div>
</div>
<!-- ========== END SPC/SQC CONTROL CHARTS ========== -->


</div><!-- END process-control panel -->
<div class="panel" id="aeration">
<div id="AERATION_HEADER_MARKER" style="background:linear-gradient(135deg,#06b6d4 0%,#22d3ee 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üí® AERATION & ENERGY</h2>
</div>

<!-- QUICK NAV CARDS -->
<div id="aerationQuickNav" style="margin-bottom:20px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section</span>
<button onclick="document.getElementById('aerationQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px">
<div onclick="scrollToSection('oteSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#06b6d4,#22d3ee);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üí®</div>
<div style="font-size:11px;color:white;margin-top:4px">Oxygen Transfer</div>
</div>
<div onclick="scrollToSection('blowerSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">üåÄ</div>
<div style="font-size:11px;color:white;margin-top:4px">Blower</div>
</div>
<div onclick="scrollToSection('energySection')" class="quick-nav-card" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);padding:12px 8px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:20px">‚ö°</div>
<div style="font-size:11px;color:white;margin-top:4px">Energy</div>
</div>
</div>
</div>

<div style="background:linear-gradient(135deg,#0077b6 0%,#0096c7 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üí® Aeration & Energy</h2>
<p style="margin:0;opacity:0.9">Oxygen transfer, blower performance, and energy optimization</p>
</div>

<!-- Oxygen Transfer Calculator -->
<div class="section" id="oteSection">
<div class="section-h">üí® Oxygen Transfer Efficiency (OTE)</div>
<div class="section-content">
<div class="note info">Calculate actual oxygen transfer rate from standard conditions</div>
<div class="row">
<div class="input-group"><label>SOTR (lb O‚ÇÇ/hr)</label><input type="number" id="aer_sotr" value="150" step="10"></div>
<div class="input-group"><label>Water Temp (¬∞C)</label><input type="number" id="aer_temp" value="20" step="1"></div>
<div class="input-group"><label>Operating DO (mg/L)</label><input type="number" id="aer_do" value="2.0" step="0.1"></div>
<div class="input-group"><label>Saturation DO (mg/L)</label><input type="number" id="aer_do_sat" value="9.1" step="0.1"></div>
<div class="input-group"><label>Alpha Factor</label><input type="number" id="aer_alpha" value="0.85" step="0.05"></div>
<div class="input-group"><label>Beta Factor</label><input type="number" id="aer_beta" value="0.95" step="0.05"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcAOTR()">üí® Calculate AOTR</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td class="rowh">Theta Correction</td><td><span class="result" id="r_aer_theta">-</span></td><td></td></tr>
<tr><td class="rowh">AOTR</td><td><span class="result" id="r_aer_aotr">-</span></td><td>lb O‚ÇÇ/hr</td></tr>
<tr><td class="rowh">Transfer Efficiency</td><td><span class="result" id="r_aer_eff">-</span></td><td>%</td></tr>
</tbody></table>
</div>
</div>

<!-- Blower Performance -->
<div class="section" id="blowerSection">
<div class="section-h">üåÄ Blower Performance</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Air Flow Required (SCFM)</label><input type="number" id="aer_scfm" value="5000" step="100"></div>
<div class="input-group"><label>Discharge Pressure (psig)</label><input type="number" id="aer_psi" value="8" step="0.5"></div>
<div class="input-group"><label>Inlet Temp (¬∞F)</label><input type="number" id="aer_inlet_temp" value="70" step="5"></div>
<div class="input-group"><label>Blower Efficiency (%)</label><input type="number" id="aer_blower_eff" value="70" step="5"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcBlowerPower()">üåÄ Calculate Power</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td class="rowh">Brake HP</td><td><span class="result" id="r_blower_bhp">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Motor HP (w/ SF)</td><td><span class="result" id="r_blower_motor">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Power Draw</td><td><span class="result" id="r_blower_kw">-</span></td><td>kW</td></tr>
</tbody></table>
</div>
</div>

<!-- Energy Cost Analysis -->
<div class="section" id="energySection">
<div class="section-h">‚ö° Energy Cost Analysis</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Blower Power (HP)</label><input id="eng_blower_hp" type="number" value="200" step="10"></div>
<div class="input-group"><label>Pump Power (HP)</label><input id="eng_pump_hp" type="number" value="100" step="10"></div>
<div class="input-group"><label>Other Equipment (HP)</label><input id="eng_other_hp" type="number" value="50" step="10"></div>
<div class="input-group"><label>Hours/Day Operating</label><input id="eng_hours" type="number" value="24" step="1"></div>
<div class="input-group"><label>Electricity Rate ($/kWh)</label><input id="eng_rate" type="number" value="0.12" step="0.01"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcEnergyUse()">‚ö° Calculate Energy</button>
</div>
<div class="kpi-grid" style="margin-top:15px">
<div class="kpi-card"><h4>Daily kWh</h4><p id="r_eng_daily">-</p></div>
<div class="kpi-card"><h4>Monthly Cost</h4><p id="r_eng_monthly">-</p></div>
<div class="kpi-card"><h4>Annual Cost</h4><p id="r_eng_annual">-</p></div>
<div class="kpi-card"><h4>kWh/MG</h4><p id="r_eng_intensity">-</p></div>
</div>
</div>
</div>

</div><!-- END aeration panel -->
<!-- Cost Analysis Panel -->
<div class="panel" id="chemicals">
<div id="CHEMICALS_HEADER_MARKER" style="background:linear-gradient(135deg,#84cc16 0%,#a3e635 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üß™ CHEMICAL SYSTEMS</h2>
</div>

<!-- QUICK NAV CARDS FOR CHEMICALS -->
<div id="chemicalsQuickNav" style="margin-bottom:16px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Calculator</span>
<button onclick="document.getElementById('chemicalsQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(85px, 1fr));gap:6px">
<div onclick="scrollToSection('chemFeedSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">üéØ</div>
<div style="font-size:10px;color:white;margin-top:2px">P Removal</div>
</div>
<div onclick="scrollToSection('chlorineDisSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#ef4444,#f87171);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">‚ò£Ô∏è</div>
<div style="font-size:10px;color:white;margin-top:2px">Chlorine</div>
</div>
<div onclick="scrollToSection('polymerSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">üíä</div>
<div style="font-size:10px;color:white;margin-top:2px">Polymer</div>
</div>
<div onclick="scrollToSection('alkSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">‚öóÔ∏è</div>
<div style="font-size:10px;color:white;margin-top:2px">Alkalinity</div>
</div>
<div onclick="scrollToSection('dechlorCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#06b6d4,#22d3ee);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">üß™</div>
<div style="font-size:10px;color:white;margin-top:2px">Dechlor</div>
</div>
<div onclick="scrollToSection('coagCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#f97316,#fb923c);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">üî∂</div>
<div style="font-size:10px;color:white;margin-top:2px">Coagulant</div>
</div>
<div onclick="scrollToSection('phAdjustSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#ec4899,#f472b6);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">‚öñÔ∏è</div>
<div style="font-size:10px;color:white;margin-top:2px">pH Adjust</div>
</div>
<div onclick="scrollToSection('carbonCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#22c55e,#4ade80);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">üå±</div>
<div style="font-size:10px;color:white;margin-top:2px">Carbon</div>
</div>
<div onclick="scrollToSection('odorCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#64748b,#94a3b8);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">üëÉ</div>
<div style="font-size:10px;color:white;margin-top:2px">Odor</div>
</div>
<div onclick="scrollToSection('dilutionCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#14b8a6,#2dd4bf);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">üß´</div>
<div style="font-size:10px;color:white;margin-top:2px">Dilution</div>
</div>
<div onclick="scrollToSection('chemInventorySection')" class="quick-nav-card" style="background:linear-gradient(135deg,#65a30d,#84cc16);padding:10px 6px;border-radius:8px;text-align:center;cursor:pointer">
<div style="font-size:18px">üì¶</div>
<div style="font-size:10px;color:white;margin-top:2px">Inventory</div>
</div>
</div>
</div>

<div style="background:linear-gradient(135deg,#0096c7 0%,#5b21b6 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px">
<div>
<h2 style="margin:0 0 8px 0;font-size:20px">‚öóÔ∏è Chemical Systems</h2>
<p style="margin:0;opacity:0.9">Chemical feed optimization, dosing calculations, and disinfection</p>
</div>
<button class="btn" onclick="resetAllChemicals()" style="background:rgba(255,255,255,0.2);border:2px solid white;color:white;font-weight:bold">üîÑ Reset All Calculators</button>
</div>
</div>

<!-- Chemical Feed Optimizer -->
<div class="section" id="chemFeedSection">
<div class="section-h">üéØ Chemical Feed Optimizer</div>
<div class="section-content">
<div class="note info">Optimize coagulant/flocculant dosing for phosphorus removal</div>
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="chem_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Influent P (mg/L)</label><input type="number" id="chem_p_in" value="6.0" step="0.5"></div>
<div class="input-group"><label>Target P (mg/L)</label><input type="number" id="chem_p_target" value="1.0" step="0.1"></div>
<div class="input-group"><label>Chemical Type</label>
<select id="chem_type">
<option value="alum">Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ)</option>
<option value="ferric">Ferric Chloride (FeCl‚ÇÉ)</option>
<option value="pac">PAC (Polyaluminum Chloride)</option>
</select>
</div>
<div class="input-group"><label>Solution Strength (%)</label><input type="number" id="chem_strength" value="48" step="1"></div>
<div class="input-group"><label>Chemical Cost ($/gal)</label><input type="number" id="chem_cost" value="2.50" step="0.10"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcChemFeed()">üéØ Optimize Feed Rate</button>
</div>
<div class="kpi-grid" style="margin-top:15px">
<div class="kpi-card"><h4>Me:P Ratio</h4><p id="r_chem_ratio">-</p></div>
<div class="kpi-card"><h4>Dose (mg/L)</h4><p id="r_chem_dose">-</p></div>
<div class="kpi-card"><h4>Feed Rate (gpd)</h4><p id="r_chem_gpd">-</p></div>
<div class="kpi-card"><h4>Daily Cost</h4><p id="r_chem_daily_cost">-</p></div>
</div>
</div>
</div>

<!-- Chlorine Disinfection -->
<div class="section" id="chlorineDisSection">
<div class="section-h">‚ò£Ô∏è Chlorine Disinfection</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="cl_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Target Dose (mg/L)</label><input type="number" id="cl_dose" value="5.0" step="0.5"></div>
<div class="input-group"><label>Solution Strength (%)</label><input type="number" id="cl_strength" value="12.5" step="0.5"></div>
<div class="input-group"><label>Contact Time (min)</label><input type="number" id="cl_contact" value="30" step="5"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcChlorine()">‚ò£Ô∏è Calculate Chlorine</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td class="rowh">Cl‚ÇÇ Required</td><td><span class="result" id="r_cl_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_cl_gpd">-</span></td><td>gpd</td></tr>
<tr><td class="rowh">CT Value</td><td><span class="result" id="r_cl_ct">-</span></td><td>mg¬∑min/L</td></tr>
</tbody></table>
</div>
</div>

<!-- Jar Test Optimizer -->
<div class="section" id="jarTestSection" style="border:2px solid #f59e0b">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white">
üß´ Jar Test Optimizer
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Coagulant & Polymer</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Record jar test results to determine optimal chemical doses and costs.</p>

<!-- Test Setup -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">‚öôÔ∏è Test Setup</h4>
<div class="row">
<div class="input-group">
<label style="color:#fbbf24">Sample Source</label>
<select id="jt_source" style="font-size:14px">
<option value="raw">Raw Influent</option>
<option value="primary">Primary Effluent</option>
<option value="secondary">Secondary Effluent</option>
<option value="sidestream">Sidestream</option>
</select>
</div>
<div class="input-group">
<label style="color:#fbbf24">Coagulant Type</label>
<select id="jt_coag_type" style="font-size:14px" onchange="updateCoagCost()">
<option value="alum">Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ)</option>
<option value="ferric">Ferric Chloride (FeCl‚ÇÉ)</option>
<option value="ferrous">Ferrous Sulfate (FeSO‚ÇÑ)</option>
<option value="pac">PAC (Polyaluminum Chloride)</option>
<option value="sodium_aluminate">Sodium Aluminate</option>
</select>
</div>
<div class="input-group">
<label style="color:#fbbf24">Coagulant Cost ($/lb)</label>
<input type="number" id="jt_coag_cost" value="0.15" step="0.01">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Polymer Type</label>
<select id="jt_poly_type" style="font-size:14px">
<option value="none">None</option>
<option value="cationic">Cationic</option>
<option value="anionic">Anionic</option>
<option value="nonionic">Nonionic</option>
</select>
</div>
<div class="input-group">
<label>Polymer Cost ($/lb)</label>
<input type="number" id="jt_poly_cost" value="2.50" step="0.10">
</div>
<div class="input-group">
<label>Plant Flow (MGD)</label>
<input type="number" id="jt_plant_flow" value="5.0" step="0.1">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Initial Turbidity (NTU)</label>
<input type="number" id="jt_init_turb" value="25" step="1">
</div>
<div class="input-group">
<label>Initial pH</label>
<input type="number" id="jt_init_ph" value="7.2" step="0.1">
</div>
<div class="input-group">
<label>Target Turbidity (NTU)</label>
<input type="number" id="jt_target_turb" value="5" step="1">
</div>
</div>
<div class="row">
<div class="input-group">
<label style="color:#60a5fa">Jar Volume (mL)</label>
<select id="jt_jar_vol" style="font-size:14px" onchange="calcSyringeDoses()">
<option value="1000">1000 mL (1 L)</option>
<option value="2000" selected>2000 mL (2 L)</option>
</select>
</div>
<div class="input-group">
<label style="color:#60a5fa">Stock Solution (%)</label>
<input type="number" id="jt_stock_pct" value="1.0" step="0.1" onchange="calcSyringeDoses()">
<small style="opacity:0.7">1% = 10,000 mg/L</small>
</div>
<div class="input-group">
<label style="color:#60a5fa">Syringe Size</label>
<select id="jt_syringe" style="font-size:14px">
<option value="5">5 mL</option>
<option value="10" selected>10 mL</option>
<option value="20">20 mL</option>
</select>
</div>
</div>
<!-- Syringe Dose Calculator -->
<div style="margin-top:15px;padding:12px;background:#0d3a5c;border-radius:8px;border:1px solid #60a5fa">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
<div><strong style="color:#60a5fa">üíâ Syringe Dose Calculator</strong></div>
<button class="btn" style="padding:5px 12px;font-size:12px" onclick="calcSyringeDoses()">üìä Calculate mL to Add</button>
</div>
<div id="jt_syringe_results" style="margin-top:10px;font-size:13px"></div>
</div>
</div>

<!-- Jar Test Results Entry -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üß™ Jar Test Results (6 Jars)</h4>
<div class="note info" style="margin-bottom:15px">Enter coagulant dose and results for each jar. Leave unused jars blank.</div>

<div style="overflow-x:auto">
<table class="table" style="font-size:13px;min-width:700px">
<thead>
<tr>
<th style="width:60px">Jar #</th>
<th>Coag Dose<br>(mg/L)</th>
<th>Polymer<br>(mg/L)</th>
<th>Flash Mix<br>pH</th>
<th>Floc Size<br>(1-5)</th>
<th>Settle Time<br>(min)</th>
<th>Final Turb<br>(NTU)</th>
<th>Final pH</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">1</td>
<td><input type="number" id="jt_1_coag" value="10" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_1_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_1_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_1_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_1_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_1_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_1_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">2</td>
<td><input type="number" id="jt_2_coag" value="20" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_2_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_2_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_2_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_2_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_2_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_2_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">3</td>
<td><input type="number" id="jt_3_coag" value="30" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_3_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_3_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_3_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_3_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_3_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_3_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">4</td>
<td><input type="number" id="jt_4_coag" value="40" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_4_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_4_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_4_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_4_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_4_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_4_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">5</td>
<td><input type="number" id="jt_5_coag" value="50" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_5_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_5_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_5_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_5_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_5_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_5_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">6</td>
<td><input type="number" id="jt_6_coag" value="60" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_6_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_6_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_6_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_6_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_6_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_6_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
</tbody>
</table>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="analyzeJarTest()">üß´ Analyze Results</button>
<button class="btn blue" onclick="showJarTestChart()">üìà Show Dose Curve</button>
<button class="btn green" onclick="saveJarTest()">üíæ Save Test</button>
<button class="btn gray" onclick="resetJarTest()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="jt_results" style="margin-top:20px"></div>

<!-- Dose Curve Chart -->
<div id="jt_chart_container" style="display:none;margin-top:20px;background:#1e3a5f;padding:15px;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#60a5fa">üìà Dose-Response Curve</h4>
<canvas id="jarTestChart" height="200"></canvas>
</div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#f59e0b">üìö Jar Test Reference Guide</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
<div style="background:#243b55;padding:12px;border-radius:8px">
<strong style="color:#4ade80">Floc Size Scale:</strong>
<div style="font-size:12px;margin-top:5px">
1 = Pin floc (poor)<br>
2 = Small, slow settling<br>
3 = Medium, good<br>
4 = Large, fast settling<br>
5 = Extra large, excellent
</div>
</div>
<div style="background:#243b55;padding:12px;border-radius:8px">
<strong style="color:#4ade80">Typical Doses:</strong>
<div style="font-size:12px;margin-top:5px">
Alum: 10-50 mg/L<br>
Ferric: 10-50 mg/L<br>
PAC: 5-30 mg/L<br>
Polymer: 0.5-3 mg/L
</div>
</div>
<div style="background:#243b55;padding:12px;border-radius:8px">
<strong style="color:#4ade80">Optimal pH Ranges:</strong>
<div style="font-size:12px;margin-top:5px">
Alum: 5.5-7.5<br>
Ferric: 4.0-9.0<br>
PAC: 5.0-8.5<br>
Lime: >10.5
</div>
</div>
</div>
</div>

</div>
</div>

<!-- Polymer Dosing -->
<div class="section" id="polymerSection">
<div class="section-h">üíä Polymer Dosing</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sludge Flow (gpm)</label><input type="number" id="poly_flow" value="50" step="5"></div>
<div class="input-group"><label>Sludge Solids (%)</label><input type="number" id="poly_solids" value="3.0" step="0.1"></div>
<div class="input-group"><label>Target Dose (lb/DT)</label><input type="number" id="poly_dose" value="12" step="1"></div>
<div class="input-group"><label>Polymer Solution (%)</label><input type="number" id="poly_conc" value="0.5" step="0.1"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcPolymer()">üíä Calculate Polymer</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td class="rowh">Dry Tons/Day</td><td><span class="result" id="r_poly_dt">-</span></td><td>DT/day</td></tr>
<tr><td class="rowh">Polymer Required</td><td><span class="result" id="r_poly_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_poly_gpm">-</span></td><td>gpm</td></tr>
</tbody></table>
</div>
</div>

<!-- Alkalinity Adjustment -->
<div class="section" id="alkSection">
<div class="section-h">‚öóÔ∏è Alkalinity Adjustment</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="alk_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Current Alk (mg/L as CaCO‚ÇÉ)</label><input type="number" id="alk_current" value="120" step="10"></div>
<div class="input-group"><label>Target Alk (mg/L as CaCO‚ÇÉ)</label><input type="number" id="alk_target" value="200" step="10"></div>
<div class="input-group"><label>Chemical</label>
<select id="alk_chem">
<option value="naoh">Caustic (NaOH 50%)</option>
<option value="lime">Lime (Ca(OH)‚ÇÇ)</option>
<option value="soda">Soda Ash (Na‚ÇÇCO‚ÇÉ)</option>
</select>
</div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcAlkalinity_Chem()">‚öóÔ∏è Calculate Dose</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td class="rowh">Alk Increase Needed</td><td><span class="result" id="r_alk_increase">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Chemical Required</td><td><span class="result" id="r_alk_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_alk_gpd">-</span></td><td>gpd</td></tr>
</tbody></table>
</div>
</div>

<!-- CHEMICAL INVENTORY TRACKER -->
<div class="section" id="chemInventorySection" style="border:2px solid #84cc16">
<div class="section-h" style="background:linear-gradient(135deg,#65a30d,#84cc16);color:white">
üì¶ Chemical Inventory Tracker
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Track & Alert</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Track chemical inventory levels, usage rates, and receive low-stock alerts.</p>

<!-- Inventory Table -->
<div style="overflow-x:auto">
<table class="table" id="inventoryTable" style="font-size:13px">
<thead>
<tr style="background:#1e293b">
<th style="padding:10px;text-align:left">Chemical</th>
<th style="padding:10px;text-align:center">Current (gal)</th>
<th style="padding:10px;text-align:center">Daily Use</th>
<th style="padding:10px;text-align:center">Days Left</th>
<th style="padding:10px;text-align:center">Reorder Pt</th>
<th style="padding:10px;text-align:center">Status</th>
<th style="padding:10px;text-align:center">Actions</th>
</tr>
</thead>
<tbody id="inventoryBody">
<!-- Rows populated by JavaScript -->
</tbody>
</table>
</div>

<!-- Add/Edit Chemical Form -->
<div id="chemFormContainer" style="margin-top:20px;padding:15px;background:#1e293b;border-radius:10px;display:none">
<h4 style="margin:0 0 15px 0;color:#84cc16" id="chemFormTitle">‚ûï Add Chemical</h4>
<div class="row">
<div class="input-group"><label>Chemical Name</label><input type="text" id="inv_name" placeholder="e.g., Sodium Hypochlorite"></div>
<div class="input-group"><label>Current Inventory (gal)</label><input type="number" id="inv_current" value="500" step="10"></div>
<div class="input-group"><label>Daily Usage (gal/day)</label><input type="number" id="inv_daily" value="25" step="1"></div>
<div class="input-group"><label>Reorder Point (gal)</label><input type="number" id="inv_reorder" value="200" step="10"></div>
</div>
<div class="row">
<div class="input-group"><label>Unit Cost ($/gal)</label><input type="number" id="inv_cost" value="1.50" step="0.10"></div>
<div class="input-group"><label>Supplier</label><input type="text" id="inv_supplier" placeholder="e.g., ChemCo"></div>
<div class="input-group"><label>Last Delivery</label><input type="date" id="inv_lastdelivery"></div>
<div class="input-group"><label>Notes</label><input type="text" id="inv_notes" placeholder="Optional notes"></div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn green" onclick="saveChemicalInventory()">üíæ Save</button>
<button class="btn gray" onclick="hideChemForm()">Cancel</button>
</div>
</div>

<!-- Action Buttons -->
<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="showAddChemForm()">‚ûï Add Chemical</button>
<button class="btn blue" onclick="recordDelivery()">üöö Record Delivery</button>
<button class="btn gray" onclick="exportInventoryReport()">üìÑ Export Report</button>
</div>

<!-- Summary Cards -->
<div class="kpi-grid" style="margin-top:20px">
<div class="kpi-card" style="border-left:4px solid #ef4444">
<h4>‚ö†Ô∏è Low Stock</h4>
<p id="inv_lowcount" style="font-size:24px;color:#ef4444">0</p>
</div>
<div class="kpi-card" style="border-left:4px solid #84cc16">
<h4>üì¶ Total Items</h4>
<p id="inv_totalitems" style="font-size:24px;color:#84cc16">0</p>
</div>
<div class="kpi-card" style="border-left:4px solid #3b82f6">
<h4>üí∞ Inventory Value</h4>
<p id="inv_totalvalue" style="font-size:24px;color:#3b82f6">$0</p>
</div>
<div class="kpi-card" style="border-left:4px solid #f59e0b">
<h4>üìÖ Avg Days Supply</h4>
<p id="inv_avgdays" style="font-size:24px;color:#f59e0b">0</p>
</div>
</div>

<!-- Alert Panel -->
<div id="inventoryAlerts" style="margin-top:15px;display:none">
<div class="note warning" style="background:#fef3c7;border-left:4px solid #f59e0b;padding:12px">
<strong>‚ö†Ô∏è Inventory Alerts:</strong>
<ul id="alertsList" style="margin:10px 0 0 20px;padding:0"></ul>
</div>
</div>

</div>
</div>

</div><!-- END chemicals panel -->
<!-- Advanced Panel -->

<!-- Optimization Panel -->


<!-- Maintenance Panel -->

<div class="panel" id="maintenance">
<div id="MAINTENANCE_HEADER_MARKER" style="background:linear-gradient(135deg,#a855f7 0%,#c084fc 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üîß MAINTENANCE</h2>
<p style="margin:0;opacity:0.9;font-size:14px">Equipment tracking, PM schedules, runtime hours, and calibration management</p>
</div>

<!-- QUICK NAV CARDS - v9.9.19 -->
<div id="maintenanceQuickNav" style="margin-bottom:16px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section</span>
<button onclick="document.getElementById('maintenanceQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(90px, 1fr));gap:8px">
<div onclick="scrollToSection('equipmentPMSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#7c3aed,#a855f7);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üîß</div>
<div style="font-size:10px;color:white;margin-top:4px">PM Tracker</div>
</div>
<div onclick="scrollToSection('calibrationSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìê</div>
<div style="font-size:10px;color:white;margin-top:4px">Calibration</div>
</div>
<div onclick="scrollToSection('sparePartsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#d97706,#f59e0b);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üì¶</div>
<div style="font-size:10px;color:white;margin-top:4px">Spare Parts</div>
</div>
<div onclick="scrollToSection('workOrderSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìù</div>
<div style="font-size:10px;color:white;margin-top:4px">Work Orders</div>
</div>
</div>
</div>

<!-- ========== EQUIPMENT PM TRACKER v9.9.16 ========== -->
<div class="section" id="equipmentPMSection" style="border:2px solid #a855f7">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:white">
üîß Equipment PM Tracker
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">NEW v9.9.16</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Track equipment runtime hours, maintenance schedules, and costs. Get alerts before PM is due.</p>

<!-- Summary KPIs -->
<div class="kpi-grid" style="margin-bottom:20px">
<div class="kpi-card" style="border-left:4px solid #ef4444">
<h4>‚ö†Ô∏è Overdue</h4>
<p id="pm_overdue" style="font-size:28px;color:#ef4444">0</p>
</div>
<div class="kpi-card" style="border-left:4px solid #f59e0b">
<h4>üìÖ Due Soon (7d)</h4>
<p id="pm_due_soon" style="font-size:28px;color:#f59e0b">0</p>
</div>
<div class="kpi-card" style="border-left:4px solid #22c55e">
<h4>‚úì Up to Date</h4>
<p id="pm_ok" style="font-size:28px;color:#22c55e">0</p>
</div>
<div class="kpi-card" style="border-left:4px solid #3b82f6">
<h4>üí∞ YTD Cost</h4>
<p id="pm_ytd_cost" style="font-size:28px;color:#3b82f6">$0</p>
</div>
</div>

<!-- Filter Buttons -->
<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px">
<button onclick="EquipmentPM.filterEquipment('all')" class="pm-filter-btn active" id="pm-filter-all" style="padding:8px 16px;border-radius:8px;border:2px solid #a855f7;background:#a855f7;color:white;font-weight:600;cursor:pointer">All Equipment</button>
<button onclick="EquipmentPM.filterEquipment('overdue')" class="pm-filter-btn" id="pm-filter-overdue" style="padding:8px 16px;border-radius:8px;border:2px solid #a855f7;background:transparent;color:#a855f7;font-weight:600;cursor:pointer">Overdue</button>
<button onclick="EquipmentPM.filterEquipment('due_soon')" class="pm-filter-btn" id="pm-filter-due_soon" style="padding:8px 16px;border-radius:8px;border:2px solid #a855f7;background:transparent;color:#a855f7;font-weight:600;cursor:pointer">Due Soon</button>
<button onclick="EquipmentPM.filterEquipment('blowers')" class="pm-filter-btn" id="pm-filter-blowers" style="padding:8px 16px;border-radius:8px;border:2px solid #a855f7;background:transparent;color:#a855f7;font-weight:600;cursor:pointer">Blowers</button>
<button onclick="EquipmentPM.filterEquipment('pumps')" class="pm-filter-btn" id="pm-filter-pumps" style="padding:8px 16px;border-radius:8px;border:2px solid #a855f7;background:transparent;color:#a855f7;font-weight:600;cursor:pointer">Pumps</button>
<button onclick="EquipmentPM.filterEquipment('clarifiers')" class="pm-filter-btn" id="pm-filter-clarifiers" style="padding:8px 16px;border-radius:8px;border:2px solid #a855f7;background:transparent;color:#a855f7;font-weight:600;cursor:pointer">Clarifiers</button>
</div>

<!-- Equipment Table -->
<div style="overflow-x:auto;margin-bottom:20px">
<table class="table" id="equipmentPMTable" style="font-size:13px">
<thead>
<tr style="background:#1e293b">
<th style="padding:12px;text-align:left">Equipment</th>
<th style="padding:12px;text-align:center">Category</th>
<th style="padding:12px;text-align:center">Runtime (hrs)</th>
<th style="padding:12px;text-align:center">Last PM</th>
<th style="padding:12px;text-align:center">Interval</th>
<th style="padding:12px;text-align:center">Next Due</th>
<th style="padding:12px;text-align:center">Status</th>
<th style="padding:12px;text-align:center">Actions</th>
</tr>
</thead>
<tbody id="equipmentPMBody">
<!-- Rows populated by JavaScript -->
</tbody>
</table>
</div>

<!-- Action Buttons -->
<div class="btns" style="margin-bottom:20px">
<button onclick="EquipmentPM.showAddForm()" class="btn" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:white">‚ûï Add Equipment</button>
<button onclick="EquipmentPM.logRuntime()" class="btn" style="background:#3b82f6;color:white">‚è±Ô∏è Log Runtime</button>
<button onclick="EquipmentPM.exportReport()" class="btn" style="background:#374151;color:#e2e8f0">üì• Export Report</button>
<button onclick="EquipmentPM.showMaintenanceCalendar()" class="btn" style="background:#059669;color:white">üìÖ PM Calendar</button>
</div>

<!-- Add/Edit Equipment Form -->
<div id="pmFormContainer" style="display:none;background:#1e293b;border-radius:12px;padding:20px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#a855f7" id="pmFormTitle">‚ûï Add Equipment</h4>
<div class="row" style="gap:15px">
<div class="input-group">
<label>Equipment Name</label>
<input type="text" id="pm_name" placeholder="e.g., Blower #1" style="background:#0f172a">
</div>
<div class="input-group">
<label>Category</label>
<select id="pm_category" style="background:#0f172a">
<option value="blowers">Blowers</option>
<option value="pumps">Pumps</option>
<option value="clarifiers">Clarifiers</option>
<option value="uv">UV/Disinfection</option>
<option value="chemical">Chemical Feed</option>
<option value="solids">Solids Handling</option>
<option value="electrical">Electrical</option>
<option value="instrumentation">Instrumentation</option>
<option value="other">Other</option>
</select>
</div>
<div class="input-group">
<label>Location</label>
<input type="text" id="pm_location" placeholder="e.g., Blower Building" style="background:#0f172a">
</div>
</div>
<div class="row" style="gap:15px;margin-top:15px">
<div class="input-group">
<label>PM Interval</label>
<select id="pm_interval" style="background:#0f172a">
<option value="weekly">Weekly</option>
<option value="biweekly">Bi-Weekly</option>
<option value="monthly">Monthly</option>
<option value="quarterly">Quarterly</option>
<option value="semi_annual">Semi-Annual</option>
<option value="annual">Annual</option>
<option value="runtime">Runtime-Based</option>
</select>
</div>
<div class="input-group">
<label>Runtime Interval (hrs)</label>
<input type="number" id="pm_runtime_interval" placeholder="e.g., 2000" style="background:#0f172a">
</div>
<div class="input-group">
<label>Current Runtime (hrs)</label>
<input type="number" id="pm_current_runtime" value="0" style="background:#0f172a">
</div>
</div>
<div class="row" style="gap:15px;margin-top:15px">
<div class="input-group">
<label>Last PM Date</label>
<input type="date" id="pm_last_date" style="background:#0f172a">
</div>
<div class="input-group">
<label>Last PM Runtime (hrs)</label>
<input type="number" id="pm_last_runtime" value="0" style="background:#0f172a">
</div>
<div class="input-group">
<label>Install Date</label>
<input type="date" id="pm_install_date" style="background:#0f172a">
</div>
</div>
<div class="row" style="gap:15px;margin-top:15px">
<div class="input-group">
<label>Model/Serial #</label>
<input type="text" id="pm_model" placeholder="Model/Serial number" style="background:#0f172a">
</div>
<div class="input-group">
<label>Manufacturer</label>
<input type="text" id="pm_manufacturer" placeholder="e.g., Aerzen, Gorman-Rupp" style="background:#0f172a">
</div>
<div class="input-group">
<label>Est. Replacement Cost ($)</label>
<input type="number" id="pm_replacement_cost" placeholder="e.g., 25000" style="background:#0f172a">
</div>
</div>
<div class="row" style="gap:15px;margin-top:15px">
<div class="input-group" style="flex:2">
<label>PM Tasks/Checklist</label>
<textarea id="pm_tasks" rows="3" placeholder="List PM tasks (one per line)&#10;e.g., Check belt tension&#10;Grease bearings&#10;Check oil level" style="background:#0f172a;width:100%;resize:vertical"></textarea>
</div>
<div class="input-group">
<label>Notes</label>
<textarea id="pm_notes" rows="3" placeholder="Additional notes" style="background:#0f172a;width:100%;resize:vertical"></textarea>
</div>
</div>
<div class="btns" style="margin-top:15px">
<button onclick="EquipmentPM.saveEquipment()" class="btn" style="background:#22c55e;color:white">üíæ Save Equipment</button>
<button onclick="EquipmentPM.hideForm()" class="btn" style="background:#64748b;color:white">Cancel</button>
</div>
</div>

<!-- Log Runtime Form -->
<div id="runtimeFormContainer" style="display:none;background:#1e293b;border-radius:12px;padding:20px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#3b82f6">‚è±Ô∏è Log Equipment Runtime</h4>
<div class="row" style="gap:15px">
<div class="input-group">
<label>Select Equipment</label>
<select id="runtime_equipment" style="background:#0f172a">
<option value="">-- Select Equipment --</option>
</select>
</div>
<div class="input-group">
<label>Date</label>
<input type="date" id="runtime_date" style="background:#0f172a">
</div>
<div class="input-group">
<label>Hours to Add</label>
<input type="number" id="runtime_hours" value="24" step="0.5" style="background:#0f172a">
</div>
</div>
<div class="btns" style="margin-top:15px">
<button onclick="EquipmentPM.saveRuntime()" class="btn" style="background:#3b82f6;color:white">üíæ Log Runtime</button>
<button onclick="EquipmentPM.hideRuntimeForm()" class="btn" style="background:#64748b;color:white">Cancel</button>
</div>
</div>

<!-- Record PM Completion Form -->
<div id="pmCompleteFormContainer" style="display:none;background:#1e293b;border-radius:12px;padding:20px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#22c55e">‚úÖ Record PM Completion</h4>
<div class="row" style="gap:15px">
<div class="input-group">
<label>Equipment</label>
<input type="text" id="pm_complete_equipment" readonly style="background:#0f172a">
<input type="hidden" id="pm_complete_id">
</div>
<div class="input-group">
<label>Completion Date</label>
<input type="date" id="pm_complete_date" style="background:#0f172a">
</div>
<div class="input-group">
<label>Runtime at PM (hrs)</label>
<input type="number" id="pm_complete_runtime" style="background:#0f172a">
</div>
</div>
<div class="row" style="gap:15px;margin-top:15px">
<div class="input-group">
<label>Performed By</label>
<input type="text" id="pm_complete_by" placeholder="Technician name" style="background:#0f172a">
</div>
<div class="input-group">
<label>Labor Hours</label>
<input type="number" id="pm_complete_labor" step="0.5" value="1" style="background:#0f172a">
</div>
<div class="input-group">
<label>Parts Cost ($)</label>
<input type="number" id="pm_complete_parts" step="0.01" value="0" style="background:#0f172a">
</div>
</div>
<div class="row" style="gap:15px;margin-top:15px">
<div class="input-group" style="flex:2">
<label>Work Performed</label>
<textarea id="pm_complete_work" rows="3" placeholder="Describe work performed" style="background:#0f172a;width:100%"></textarea>
</div>
<div class="input-group">
<label>Condition Found</label>
<select id="pm_complete_condition" style="background:#0f172a">
<option value="good">Good</option>
<option value="fair">Fair - Minor Issues</option>
<option value="poor">Poor - Needs Repair</option>
<option value="critical">Critical - Immediate Action</option>
</select>
</div>
</div>
<div class="btns" style="margin-top:15px">
<button onclick="EquipmentPM.savePMCompletion()" class="btn" style="background:#22c55e;color:white">‚úÖ Complete PM</button>
<button onclick="EquipmentPM.hidePMCompleteForm()" class="btn" style="background:#64748b;color:white">Cancel</button>
</div>
</div>

<!-- Maintenance History -->
<div style="background:#0f172a;border-radius:12px;padding:20px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h4 style="margin:0;color:#a855f7">üìú Recent Maintenance History</h4>
<button onclick="EquipmentPM.showFullHistory()" style="background:#374151;border:none;color:#94a3b8;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">View All</button>
</div>
<div id="pmHistoryList" style="max-height:250px;overflow-y:auto">
<div style="text-align:center;padding:30px;color:#64748b">
<span style="font-size:32px">üìã</span><br>
No maintenance history yet
</div>
</div>
</div>

</div>
</div>
<!-- ========== END EQUIPMENT PM TRACKER ========== -->

<div class="section">
<div class="section-h">üî¨ Calibration Tracking</div>
<div class="section-content">
<table class="table">
<thead><tr><th>Instrument</th><th>Location</th><th>Last Cal</th><th>Due</th><th>Status</th></tr></thead>
<tbody>
<tr><td>DO Probe #1</td><td>Aeration Basin</td><td>2024-11-20</td><td>2024-12-20</td><td><span class="status good">OK</span></td></tr>
<tr><td>pH Analyzer</td><td>Effluent</td><td>2024-11-25</td><td>2024-12-25</td><td><span class="status good">OK</span></td></tr>
<tr><td>Flow Meter</td><td>Influent</td><td>2024-06-01</td><td>2024-12-01</td><td><span class="status bad">Overdue</span></td></tr>
<tr><td>Turbidity</td><td>Effluent</td><td>2024-11-01</td><td>2024-12-01</td><td><span class="status warn">Due Soon</span></td></tr>
</tbody>
</table>
</div>
</div>

<div class="section">
<div class="section-h">üõ†Ô∏è Work Order Log</div>
<div class="section-content">
<div class="btns" style="margin-bottom:15px">
<button class="btn gradient" onclick="showAddWorkOrder()">‚ûï New Work Order</button>
<button class="btn blue" onclick="filterWO('open')">Open</button>
<button class="btn green" onclick="filterWO('complete')">Complete</button>
<button class="btn gray" onclick="filterWO('all')">All</button>
</div>
<div id="workOrderList">
<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #ffd166">
<div style="display:flex;justify-content:space-between"><strong>WO-2024-142</strong><span class="status warn">In Progress</span></div>
<div style="color:#94a3b8;margin-top:5px">Blower #2 bearing replacement</div>
<div style="color:#64748b;font-size:12px;margin-top:5px">Assigned: John D. | Due: 12/10/2024</div>
</div>
<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #ef4444">
<div style="display:flex;justify-content:space-between"><strong>WO-2024-143</strong><span class="status bad">Urgent</span></div>
<div style="color:#94a3b8;margin-top:5px">UV lamp replacement - Bank A</div>
<div style="color:#64748b;font-size:12px;margin-top:5px">Assigned: Mike S. | Due: 12/08/2024</div>
</div>
</div>
</div>
</div>

</div><!-- END maintenance panel -->
<!-- LIMS Panel -->
<!-- Alerts Panel -->

<!-- Compliance Panel -->

<!-- Predictive Panel -->


<!-- Reports Panel -->

<div class="panel" id="reports">
<div id="REPORTS_HEADER_MARKER" style="background:linear-gradient(135deg,#6366f1 0%,#818cf8 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìë REPORTS</h2>
</div>

<!-- QUICK NAV CARDS - v9.9.19 -->
<div id="reportsQuickNav" style="margin-bottom:16px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section</span>
<button onclick="document.getElementById('reportsQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(90px, 1fr));gap:8px">
<div onclick="scrollToSection('execReportSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#ef4444,#f87171);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìë</div>
<div style="font-size:10px;color:white;margin-top:4px">Executive</div>
</div>
<div onclick="scrollToSection('brandingSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üè¢</div>
<div style="font-size:10px;color:white;margin-top:4px">Branding</div>
</div>
<div onclick="scrollToSection('reportTypeSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#6366f1,#818cf8);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìÑ</div>
<div style="font-size:10px;color:white;margin-top:4px">Report Type</div>
</div>
<div onclick="scrollToSection('reportPreviewArea')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üëÅÔ∏è</div>
<div style="font-size:10px;color:white;margin-top:4px">Preview</div>
</div>
<div onclick="scrollToSection('quickExportSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üì§</div>
<div style="font-size:10px;color:white;margin-top:4px">Export</div>
</div>
</div>
</div>

<!-- ==================== EXECUTIVE REPORT GENERATOR v9.9.19 ==================== -->
<div class="section" id="execReportSection" style="border:2px solid #ef4444;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#dc2626,#ef4444);color:white;display:flex;justify-content:space-between;align-items:center">
<div style="display:flex;align-items:center;gap:10px">
<span>üìë Executive Report Generator</span>
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:12px;font-size:10px;font-weight:700">GENIUS v9.9.19</span>
</div>
<button onclick="generateExecutiveReport()" style="background:rgba(255,255,255,0.2);border:none;padding:6px 12px;border-radius:8px;color:white;font-size:11px;cursor:pointer;font-weight:600">‚ö° Generate Now</button>
</div>
<div class="section-content" style="padding:16px">

<!-- Report Status Overview -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:20px">

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(239,68,68,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:6px;font-weight:600">REPORT DATE</div>
<div id="execReportDate" style="font-size:18px;font-weight:700;color:#f8fafc">${new Date().toLocaleDateString()}</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">Auto-generated</div>
</div>

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(34,197,94,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:6px;font-weight:600">PLANT STATUS</div>
<div id="execPlantStatus" style="font-size:18px;font-weight:700;color:#4ade80">OPTIMAL</div>
<div id="execPlantScore" style="font-size:10px;color:#94a3b8;margin-top:4px">Health: 87%</div>
</div>

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(59,130,246,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:6px;font-weight:600">DATA SOURCES</div>
<div id="execDataSources" style="font-size:18px;font-weight:700;color:#60a5fa">8</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">GENIUS systems</div>
</div>

<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;text-align:center;border:1px solid rgba(245,158,11,0.3)">
<div style="font-size:11px;color:#94a3b8;margin-bottom:6px;font-weight:600">LAST GENERATED</div>
<div id="execLastGen" style="font-size:14px;font-weight:700;color:#fbbf24">Never</div>
<div style="font-size:10px;color:#94a3b8;margin-top:4px">Click Generate</div>
</div>

</div>

<!-- Report Sections Selection -->
<div style="margin-bottom:20px">
<div style="font-size:12px;color:#94a3b8;margin-bottom:10px;font-weight:600">üìã REPORT SECTIONS (Click to toggle)</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">

<label style="display:flex;align-items:center;gap:10px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:10px;padding:12px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#22c55e'" onmouseout="this.style.borderColor='rgba(34,197,94,0.3)'">
<input type="checkbox" id="execIncludeSummary" checked style="width:18px;height:18px;accent-color:#22c55e">
<div>
<div style="font-size:13px;font-weight:600;color:#86efac">Executive Summary</div>
<div style="font-size:10px;color:#94a3b8">Health, status, key metrics</div>
</div>
</label>

<label style="display:flex;align-items:center;gap:10px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.3);border-radius:10px;padding:12px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='rgba(59,130,246,0.3)'">
<input type="checkbox" id="execIncludeCompliance" checked style="width:18px;height:18px;accent-color:#3b82f6">
<div>
<div style="font-size:13px;font-weight:600;color:#93c5fd">Compliance Status</div>
<div style="font-size:10px;color:#94a3b8">Permit status, alerts, DMR</div>
</div>
</label>

<label style="display:flex;align-items:center;gap:10px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);border-radius:10px;padding:12px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#8b5cf6'" onmouseout="this.style.borderColor='rgba(139,92,246,0.3)'">
<input type="checkbox" id="execIncludePredictions" checked style="width:18px;height:18px;accent-color:#8b5cf6">
<div>
<div style="font-size:13px;font-weight:600;color:#c4b5fd">Predictive Analytics</div>
<div style="font-size:10px;color:#94a3b8">7-30 day forecasts</div>
</div>
</label>

<label style="display:flex;align-items:center;gap:10px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:10px;padding:12px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#10b981'" onmouseout="this.style.borderColor='rgba(16,185,129,0.3)'">
<input type="checkbox" id="execIncludeBenchmark" checked style="width:18px;height:18px;accent-color:#10b981">
<div>
<div style="font-size:13px;font-weight:600;color:#6ee7b7">Benchmarking</div>
<div style="font-size:10px;color:#94a3b8">Industry comparison</div>
</div>
</label>

<label style="display:flex;align-items:center;gap:10px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:10px;padding:12px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#f59e0b'" onmouseout="this.style.borderColor='rgba(245,158,11,0.3)'">
<input type="checkbox" id="execIncludeOptimization" checked style="width:18px;height:18px;accent-color:#f59e0b">
<div>
<div style="font-size:13px;font-weight:600;color:#fcd34d">Optimization</div>
<div style="font-size:10px;color:#94a3b8">Recommendations & savings</div>
</div>
</label>

<label style="display:flex;align-items:center;gap:10px;background:rgba(14,165,233,0.1);border:1px solid rgba(14,165,233,0.3);border-radius:10px;padding:12px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#0ea5e9'" onmouseout="this.style.borderColor='rgba(14,165,233,0.3)'">
<input type="checkbox" id="execIncludeEnergy" checked style="width:18px;height:18px;accent-color:#0ea5e9">
<div>
<div style="font-size:13px;font-weight:600;color:#7dd3fc">Energy Analysis</div>
<div style="font-size:10px;color:#94a3b8">Usage & cost optimization</div>
</div>
</label>

<label style="display:flex;align-items:center;gap:10px;background:rgba(236,72,153,0.1);border:1px solid rgba(236,72,153,0.3);border-radius:10px;padding:12px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#ec4899'" onmouseout="this.style.borderColor='rgba(236,72,153,0.3)'">
<input type="checkbox" id="execIncludeCapital" style="width:18px;height:18px;accent-color:#ec4899">
<div>
<div style="font-size:13px;font-weight:600;color:#f9a8d4">Capital Planning</div>
<div style="font-size:10px;color:#94a3b8">Projects & scenarios</div>
</div>
</label>

<label style="display:flex;align-items:center;gap:10px;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.3);border-radius:10px;padding:12px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='rgba(99,102,241,0.3)'">
<input type="checkbox" id="execIncludeOutlook" checked style="width:18px;height:18px;accent-color:#6366f1">
<div>
<div style="font-size:13px;font-weight:600;color:#a5b4fc">Strategic Outlook</div>
<div style="font-size:10px;color:#94a3b8">Risks & opportunities</div>
</div>
</label>

</div>
</div>

<!-- Report Preview -->
<div style="margin-bottom:16px">
<div style="font-size:12px;color:#94a3b8;margin-bottom:10px;font-weight:600;display:flex;justify-content:space-between;align-items:center">
<span>üëÅÔ∏è REPORT PREVIEW</span>
<div style="display:flex;gap:8px">
<button onclick="generateExecutiveReport()" style="background:linear-gradient(135deg,#22c55e,#16a34a);border:none;color:white;padding:4px 12px;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600">‚ö° Generate</button>
<button onclick="toggleReportPreview()" id="previewToggleBtn" style="background:rgba(99,102,241,0.2);border:none;color:#a5b4fc;padding:4px 10px;border-radius:6px;font-size:10px;cursor:pointer">Expand</button>
</div>
</div>
<div id="execReportPreview" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:20px;border:2px solid rgba(99,102,241,0.4);min-height:200px;max-height:500px;overflow-y:auto">
<div id="execReportPlaceholder" style="text-align:center;padding:40px;color:#64748b">
<div style="font-size:48px;margin-bottom:12px">üìë</div>
<div style="font-size:14px;color:#f8fafc">Click <strong style="color:#4ade80">‚ö° Generate</strong> to create your executive report</div>
<div style="font-size:12px;margin-top:8px;color:#94a3b8">Report will pull data from all 8 GENIUS systems</div>
<button onclick="generateExecutiveReport()" style="margin-top:16px;background:linear-gradient(135deg,#ef4444,#dc2626);border:none;color:white;padding:12px 24px;border-radius:10px;font-size:14px;cursor:pointer;font-weight:600">‚ö° Generate Report Now</button>
</div>
</div>
</div>

<!-- Export Options -->
<div style="background:linear-gradient(135deg,rgba(239,68,68,0.1),rgba(220,38,38,0.05));border-radius:12px;padding:16px;border:1px solid rgba(239,68,68,0.3);margin-bottom:16px">
<div style="font-size:12px;color:#fca5a5;margin-bottom:12px;font-weight:600">üì§ EXPORT OPTIONS</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px">

<button onclick="exportExecReport('console')" style="background:linear-gradient(135deg,#374151,#4b5563);border:none;color:white;padding:14px;border-radius:10px;cursor:pointer;font-size:12px;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:6px;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
<span style="font-size:20px">üíª</span>
Console
</button>

<button onclick="exportExecReport('clipboard')" style="background:linear-gradient(135deg,#3b82f6,#2563eb);border:none;color:white;padding:14px;border-radius:10px;cursor:pointer;font-size:12px;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:6px;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
<span style="font-size:20px">üìã</span>
Clipboard
</button>

<button onclick="exportExecReport('json')" style="background:linear-gradient(135deg,#22c55e,#16a34a);border:none;color:white;padding:14px;border-radius:10px;cursor:pointer;font-size:12px;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:6px;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
<span style="font-size:20px">üì¶</span>
JSON File
</button>

<button onclick="exportExecReport('html')" style="background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:white;padding:14px;border-radius:10px;cursor:pointer;font-size:12px;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:6px;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
<span style="font-size:20px">üåê</span>
HTML Page
</button>

<button onclick="exportExecReport('print')" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);border:none;color:white;padding:14px;border-radius:10px;cursor:pointer;font-size:12px;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:6px;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
<span style="font-size:20px">üñ®Ô∏è</span>
Print
</button>

<button onclick="exportExecReport('email')" style="background:linear-gradient(135deg,#ec4899,#db2777);border:none;color:white;padding:14px;border-radius:10px;cursor:pointer;font-size:12px;font-weight:600;display:flex;flex-direction:column;align-items:center;gap:6px;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
<span style="font-size:20px">üìß</span>
Email Draft
</button>

</div>
</div>

<!-- Scheduled Reports -->
<div style="background:rgba(99,102,241,0.1);border-radius:12px;padding:16px;border:1px solid rgba(99,102,241,0.3)">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<div style="font-size:12px;color:#a5b4fc;font-weight:600">üìÖ SCHEDULED REPORTS</div>
<span style="font-size:10px;color:#64748b">Coming Soon</span>
</div>
<div style="display:flex;gap:10px;flex-wrap:wrap">
<button disabled style="background:rgba(255,255,255,0.05);border:1px dashed rgba(99,102,241,0.3);color:#64748b;padding:10px 16px;border-radius:8px;font-size:11px;cursor:not-allowed">üìÜ Daily at 6 AM</button>
<button disabled style="background:rgba(255,255,255,0.05);border:1px dashed rgba(99,102,241,0.3);color:#64748b;padding:10px 16px;border-radius:8px;font-size:11px;cursor:not-allowed">üìÜ Weekly Monday</button>
<button disabled style="background:rgba(255,255,255,0.05);border:1px dashed rgba(99,102,241,0.3);color:#64748b;padding:10px 16px;border-radius:8px;font-size:11px;cursor:not-allowed">üìÜ Monthly 1st</button>
</div>
</div>

</div>
</div>
<!-- ==================== END EXECUTIVE REPORT GENERATOR ==================== -->

<!-- Company Branding Section -->
<div class="section" id="brandingSection" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);border-radius:12px;margin-bottom:20px">
<div class="section-h" style="color:white;font-size:18px;font-weight:bold">
üè¢ Company Branding
</div>
<div class="section-content" style="background:rgba(0,0,0,0.2);border-radius:0 0 12px 12px">
<div class="row" style="gap:15px">
<div class="input-group">
<label style="color:#bae6fd">Company Name</label>
<input type="text" id="rpt_company" value="Frazier Environmental Consulting" style="font-size:15px">
</div>
<div class="input-group">
<label style="color:#bae6fd">Consultant Name</label>
<input type="text" id="rpt_consultant" placeholder="Your Name" style="font-size:15px">
</div>
</div>
<div class="row" style="gap:15px;margin-top:10px">
<div class="input-group">
<label style="color:#bae6fd">Phone</label>
<input type="tel" id="rpt_phone" placeholder="(555) 123-4567" style="font-size:15px">
</div>
<div class="input-group">
<label style="color:#bae6fd">Email</label>
<input type="email" id="rpt_email" placeholder="email@company.com" style="font-size:15px">
</div>
<div class="input-group">
<label style="color:#bae6fd">License #</label>
<input type="text" id="rpt_license" placeholder="TCEQ License #" style="font-size:15px">
</div>
</div>
<div class="btns" style="margin-top:15px;gap:10px">
<button onclick="saveBrandingSettings()" class="btn" style="background:#047857;color:white">üíæ Save Branding</button>
<button onclick="loadBrandingSettings()" class="btn" style="background:#6366f1;color:white">üìÇ Load Saved</button>
</div>
</div>
</div>

<!-- Report Type Selection -->
<div class="section">
<div class="section-h">üìÑ Select Report Type</div>
<div class="section-content">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px">

<!-- Report A: Daily Operations -->
<div class="report-card" onclick="selectReportType('daily')" id="rptCard_daily" style="background:linear-gradient(135deg,#059669,#10b981);padding:20px;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.3s">
<div style="font-size:36px;margin-bottom:10px">üìÖ</div>
<h4 style="margin:0 0 8px 0;color:white">Daily Operations Report</h4>
<p style="margin:0;font-size:13px;color:rgba(255,255,255,0.8)">Date, plant values, checklist status, daily notes, operator signature</p>
</div>

<!-- Report B: Process Summary -->
<div class="report-card" onclick="selectReportType('process')" id="rptCard_process" style="background:linear-gradient(135deg,#f97316,#fb923c);padding:20px;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.3s">
<div style="font-size:36px;margin-bottom:10px">‚öôÔ∏è</div>
<h4 style="margin:0 0 8px 0;color:white">Process Summary Report</h4>
<p style="margin:0;font-size:13px;color:rgba(255,255,255,0.8)">All calculator results, status indicators, formulas used</p>
</div>

<!-- Report C: Client Visit -->
<div class="report-card" onclick="selectReportType('visit')" id="rptCard_visit" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);padding:20px;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.3s">
<div style="font-size:36px;margin-bottom:10px">üè≠</div>
<h4 style="margin:0 0 8px 0;color:white">Client Visit Report</h4>
<p style="margin:0;font-size:13px;color:rgba(255,255,255,0.8)">Plant profile, findings, recommendations, action items</p>
</div>

<!-- Report D: Calculation Report -->
<div class="report-card" onclick="selectReportType('calc')" id="rptCard_calc" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);padding:20px;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.3s">
<div style="font-size:36px;margin-bottom:10px">üßÆ</div>
<h4 style="margin:0 0 8px 0;color:white">Calculation Report</h4>
<p style="margin:0;font-size:13px;color:rgba(255,255,255,0.8)">All inputs, outputs, formulas, with professional formatting</p>
</div>

</div>
</div>
</div>

<!-- Report Configuration -->
<div class="section" id="reportConfigSection">
<div class="section-h" id="reportConfigTitle">üìã Report Configuration</div>
<div class="section-content">

<!-- Client/Plant Info -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="color:#60a5fa;margin:0 0 12px 0">üè≠ Plant Information</h4>
<div class="row" style="gap:12px">
<div class="input-group">
<label>Plant Name</label>
<input type="text" id="rpt_plant" placeholder="Enter plant name or load from profile">
</div>
<div class="input-group">
<label>Client/Owner</label>
<input type="text" id="rpt_client" placeholder="Client name">
</div>
<div class="input-group">
<label>Permit #</label>
<input type="text" id="rpt_permit" placeholder="TPDES/NPDES #">
</div>
</div>
<div class="row" style="gap:12px;margin-top:10px">
<div class="input-group">
<label>Report Date</label>
<input type="date" id="rpt_date">
</div>
<div class="input-group">
<label>Process Type</label>
<select id="rpt_process">
<option value="Conventional AS">Conventional Activated Sludge</option>
<option value="Extended Aeration">Extended Aeration</option>
<option value="SBR">SBR</option>
<option value="MBR">MBR</option>
<option value="MBBR">MBBR</option>
<option value="Oxidation Ditch">Oxidation Ditch</option>
<option value="Other">Other</option>
</select>
</div>
<div class="input-group">
<label>Design Flow (MGD)</label>
<input type="number" id="rpt_designflow" step="0.1" placeholder="Design capacity">
</div>
</div>
<button onclick="loadProfileToReport()" class="btn" style="background:#7c3aed;color:white;margin-top:10px">üè≠ Load from Profile</button>
</div>

<!-- Daily Operations Specific Fields -->
<div id="dailyFields" style="display:none;background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="color:#4ade80;margin:0 0 12px 0">üìÖ Daily Values</h4>
<div class="row" style="gap:12px">
<div class="input-group">
<label>Influent Flow (MGD)</label>
<input type="number" id="rpt_flow" step="0.1" value="3.5">
</div>
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="rpt_bod" step="1" value="200">
</div>
<div class="input-group">
<label>Influent TSS (mg/L)</label>
<input type="number" id="rpt_tss" step="1" value="220">
</div>
</div>
<div class="row" style="gap:12px;margin-top:10px">
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="rpt_mlss" step="100" value="3000">
</div>
<div class="input-group">
<label>DO (mg/L)</label>
<input type="number" id="rpt_do" step="0.1" value="2.0">
</div>
<div class="input-group">
<label>pH</label>
<input type="number" id="rpt_ph" step="0.1" value="7.2">
</div>
</div>
<div class="row" style="gap:12px;margin-top:10px">
<div class="input-group">
<label>Effluent BOD (mg/L)</label>
<input type="number" id="rpt_eff_bod" step="1" value="8">
</div>
<div class="input-group">
<label>Effluent TSS (mg/L)</label>
<input type="number" id="rpt_eff_tss" step="1" value="10">
</div>
<div class="input-group">
<label>Effluent NH‚ÇÉ (mg/L)</label>
<input type="number" id="rpt_eff_nh3" step="0.1" value="1.5">
</div>
</div>
<button onclick="loadMasterToReport()" class="btn" style="background:#059669;color:white;margin-top:10px">üéõÔ∏è Load from Master Settings</button>
</div>

<!-- Client Visit Specific Fields -->
<div id="visitFields" style="display:none;background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="color:#a78bfa;margin:0 0 12px 0">üè≠ Visit Details</h4>
<div class="row" style="gap:12px">
<div class="input-group">
<label>Visit Purpose</label>
<select id="rpt_purpose">
<option value="Routine Inspection">Routine Inspection</option>
<option value="Process Optimization">Process Optimization</option>
<option value="Troubleshooting">Troubleshooting</option>
<option value="Compliance Assistance">Compliance Assistance</option>
<option value="Training">Training</option>
<option value="Other">Other</option>
</select>
</div>
<div class="input-group">
<label>Time On-Site</label>
<input type="text" id="rpt_time" placeholder="e.g., 8:00 AM - 12:00 PM">
</div>
</div>
<div class="input-group" style="margin-top:10px">
<label>Key Findings</label>
<textarea id="rpt_findings" rows="3" placeholder="Summarize observations from site visit..." style="width:100%;resize:vertical"></textarea>
</div>
<div class="input-group" style="margin-top:10px">
<label>Recommendations</label>
<textarea id="rpt_recommendations" rows="3" placeholder="List recommended actions..." style="width:100%;resize:vertical"></textarea>
</div>
<div class="input-group" style="margin-top:10px">
<label>Action Items</label>
<textarea id="rpt_actions" rows="3" placeholder="Specific action items with responsible parties..." style="width:100%;resize:vertical"></textarea>
</div>
</div>

<!-- Notes Section (all reports) -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="color:#fbbf24;margin:0 0 12px 0">üìù Notes & Comments</h4>
<textarea id="rpt_notes" rows="4" placeholder="Additional notes for the report..." style="width:100%;resize:vertical"></textarea>
</div>

<!-- Generate Buttons -->
<div class="btns" style="gap:12px;flex-wrap:wrap">
<button onclick="previewReport()" class="btn" style="background:#6366f1;color:white;font-size:16px;padding:12px 24px">üëÅÔ∏è Preview Report</button>
<button onclick="generatePDFReport()" class="btn" style="background:#10b981;color:white;font-size:16px;padding:12px 24px">üìÑ Generate PDF</button>
<button onclick="printReport()" class="btn" style="background:#0ea5e9;color:white;font-size:16px;padding:12px 24px">üñ®Ô∏è Print</button>
</div>

</div>
</div>

<!-- Report Preview Area -->
<div id="reportPreviewArea" style="display:none;margin-top:20px">
<div class="section">
<div class="section-h" style="display:flex;justify-content:space-between;align-items:center">
<span>üëÅÔ∏è Report Preview</span>
<button onclick="closeReportPreview()" style="background:#ef4444;border:none;color:white;padding:6px 12px;border-radius:6px;cursor:pointer">‚úï Close</button>
</div>
<div class="section-content">
<div id="reportPreviewContent" style="background:white;color:#1e3a5f;padding:30px;border-radius:8px;max-height:70vh;overflow-y:auto">
<!-- Preview content generated here -->
</div>
</div>
</div>
</div>

<!-- Quick Export Section -->
<div class="section">
<div class="section-h">üì§ Quick Export</div>
<div class="section-content">
<div class="btns" style="gap:10px;flex-wrap:wrap">
<button onclick="exportAllCalculations()" class="btn" style="background:#059669;color:white">üìä Export All Calculations (CSV)</button>
<button onclick="exportDailyLog()" class="btn" style="background:#f97316;color:white">üìÖ Export Daily Log</button>
<button onclick="exportCalcHistory()" class="btn" style="background:#8b5cf6;color:white">üìú Export Calc History</button>
</div>
</div>
</div>

</div><!-- END reports panel -->
<div class="panel" id="hydraulics" data-panel-name="HYDRAULICS-PANEL">
<div id="HYDRAULICS_HEADER_MARKER" style="background:linear-gradient(135deg,#dc2626 0%,#f87171 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìê HYDRAULICS</h2>
</div>

<!-- QUICK NAV CARDS - v9.9.19 -->
<div id="hydraulicsQuickNav" style="margin-bottom:16px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section (15+ Calculators)</span>
<button onclick="document.getElementById('hydraulicsQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(80px, 1fr));gap:8px">
<div onclick="scrollToSection('processCalcsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üß´</div>
<div style="font-size:9px;color:white;margin-top:4px">OLR</div>
</div>
<div onclick="scrollToSection('fmCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚öñÔ∏è</div>
<div style="font-size:9px;color:white;margin-top:4px">F/M</div>
</div>
<div onclick="scrollToSection('sviCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#0891b2,#06b6d4);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üß™</div>
<div style="font-size:9px;color:white;margin-top:4px">SVI</div>
</div>
<div onclick="scrollToSection('chemicalCalcsSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚ò£Ô∏è</div>
<div style="font-size:9px;color:white;margin-top:4px">Chlorine</div>
</div>
<div onclick="scrollToSection('polymerCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#9333ea,#a855f7);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üíä</div>
<div style="font-size:9px;color:white;margin-top:4px">Polymer</div>
</div>
<div onclick="scrollToSection('coagCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#d97706,#f59e0b);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üî∂</div>
<div style="font-size:9px;color:white;margin-top:4px">Coagulant</div>
</div>
<div onclick="scrollToSection('phAdjustSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#2563eb,#3b82f6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚öóÔ∏è</div>
<div style="font-size:9px;color:white;margin-top:4px">pH Adjust</div>
</div>
<div onclick="scrollToSection('carbonCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#65a30d,#84cc16);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üå±</div>
<div style="font-size:9px;color:white;margin-top:4px">Carbon</div>
</div>
<div onclick="scrollToSection('odorCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#78716c,#a8a29e);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üëÉ</div>
<div style="font-size:9px;color:white;margin-top:4px">Odor</div>
</div>
<div onclick="scrollToSection('dilutionCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üß´</div>
<div style="font-size:9px;color:white;margin-top:4px">Dilution</div>
</div>
</div>
</div>

<!-- CALCULATORS HEADER -->
<div class="section">
<div class="section-h" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
<span>üßÆ Process Calculators</span>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button onclick="calculateAll()" style="background:#06d6a0;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">‚ö° Calc All</button>
<button onclick="resetAll()" style="background:#6b7280;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">üîÑ Reset All</button>
<button onclick="printPanel()" style="background:#00b4d8;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">üñ®Ô∏è Print</button>
</div>
</div>
</div>

<!-- PROCESS CALCULATORS SECTION -->
<!-- OLR Calculator -->
<div class="section" id="processCalcsSection">
<div class="section-h">üß´ Organic Loading Rate (OLR)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>BOD Concentration (mg/L)</label><input type="number" id="olr_bod" value="200"></div>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="olr_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="olr_vol" value="1.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcOLR()">Calculate OLR</button>
<button class="btn gray" onclick="resetOLR()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">BOD Loading</td><td><span class="result" id="r_olr_load">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Organic Loading Rate</td><td><span class="result" id="r_olr">-</span></td><td>lb BOD/1000 cf/day</td></tr>
</tbody></table>
</div>
</div>

<!-- F/M Ratio Calculator -->
<div class="section" id="fmCalcSection">
<div class="section-h">‚öñÔ∏è F/M Ratio (Food to Microorganism)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>BOD Loading (lb/day)</label><input type="number" id="fm_bod" value="8340"></div>
<div class="input-group"><label>MLVSS (mg/L)</label><input type="number" id="fm_mlvss" value="2000"></div>
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="fm_vol" value="1.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcFM()">Calculate F/M</button>
<button class="btn gray" onclick="resetFM()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">MLVSS Mass</td><td><span class="result" id="r_fm_mass">-</span></td><td>lb</td></tr>
<tr><td class="rowh">F/M Ratio</td><td><span class="result" id="r_fm">-</span></td><td>lb BOD/lb MLVSS/day</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_fm_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- SRT Calculator -->
<div class="section">
<div class="section-h">‚è±Ô∏è Sludge Retention Time (SRT)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="srt_mlss" value="3000"></div>
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="srt_vol" value="1.2" step="0.1"></div>
<div class="input-group"><label>WAS Flow (MGD)</label><input type="number" id="srt_was" value="0.05" step="0.01"></div>
<div class="input-group"><label>WAS TSS (mg/L)</label><input type="number" id="srt_was_tss" value="8000"></div>
<div class="input-group"><label>Effluent Flow (MGD)</label><input type="number" id="srt_eff" value="5.0" step="0.1"></div>
<div class="input-group"><label>Effluent TSS (mg/L)</label><input type="number" id="srt_eff_tss" value="10"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSRTmain()">Calculate SRT</button>
<button class="btn gray" onclick="resetSRTmain()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">System Solids</td><td><span class="result" id="r_srt_solids">-</span></td><td>lb</td></tr>
<tr><td class="rowh">Solids Wasted</td><td><span class="result" id="r_srt_wasted">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">SRT (Sludge Age)</td><td><span class="result" id="r_srt">-</span></td><td>days</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_srt_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Detention Time Calculator -->
<div class="section">
<div class="section-h">üïê Hydraulic Detention Time (HRT)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Tank Volume (gallons)</label><input type="number" id="hrt_vol" value="500000"></div>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="hrt_flow" value="2.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcHRT()">Calculate HRT</button>
<button class="btn gray" onclick="resetHRT()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Detention Time</td><td><span class="result" id="r_hrt">-</span></td><td>hours</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_hrt_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- BOD Removal Calculator -->
<div class="section">
<div class="section-h">üìâ BOD Removal Efficiency</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="bod_in" value="200"></div>
<div class="input-group"><label>Effluent BOD (mg/L)</label><input type="number" id="bod_out" value="10"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcBODeff()">Calculate Efficiency</button>
<div class="result-box" style="margin-top:10px;padding:10px;background:var(--bg-card);border-radius:8px">
<span>Removal Efficiency: </span><strong id="bod_eff_result">-</strong><span> %</span>
</div>
<button class="btn gray" onclick="resetBODeff()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">BOD Removed</td><td><span class="result" id="r_bod_removed">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Removal Efficiency</td><td><span class="result" id="r_bod_eff">-</span></td><td>%</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_bod_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- SVI Calculator -->
<div class="section" id="sviCalcSection">
<div class="section-h">üß™ Sludge Volume Index (SVI)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>30-min Settled Volume (mL/L)</label><input type="number" id="svi_vol" value="250"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="svi_mlss" value="3000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSVI()">Calculate SVI</button>
<button class="btn gray" onclick="resetSVI()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">SVI</td><td><span class="result" id="r_svi">-</span></td><td>mL/g</td></tr>
<tr><td class="rowh">Settling Quality</td><td><span class="result" id="r_svi_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- WAS Calculator -->
<div class="section">
<div class="section-h">üöø Waste Activated Sludge (WAS)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Target SRT (days)</label><input type="number" id="was_srt" value="10"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="was_mlss" value="3000"></div>
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="was_vol" value="1.0" step="0.1"></div>
<div class="input-group"><label>WAS Concentration (mg/L)</label><input type="number" id="was_conc" value="8000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcWAS()">Calculate WAS</button>
<button class="btn gray" onclick="resetWAS()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Required WAS Flow</td><td><span class="result" id="r_was_flow">-</span></td><td>GPD</td></tr>
<tr><td class="rowh">Solids Wasted</td><td><span class="result" id="r_was_lb">-</span></td><td>lb/day</td></tr>
</tbody></table>
</div>
</div>

<!-- RAS Calculator -->
<div class="section">
<div class="section-h">üîÑ Return Activated Sludge (RAS)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent Flow (MGD)</label><input type="number" id="ras_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="ras_mlss" value="3000"></div>
<div class="input-group"><label>RAS TSS (mg/L)</label><input type="number" id="ras_tss" value="8000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcRAS()">Calculate RAS</button>
<button class="btn gray" onclick="resetRAS()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">RAS Ratio</td><td><span class="result" id="r_ras_ratio">-</span></td><td>%</td></tr>
<tr><td class="rowh">RAS Flow</td><td><span class="result" id="r_ras_flow">-</span></td><td>MGD</td></tr>
</tbody></table>
</div>
</div>

<!-- CHEMICAL CALCULATORS SECTION -->
<!-- Chlorine Dosing Calculator -->
<div class="section" id="chemicalCalcsSection">
<div class="section-h">‚ò£Ô∏è Chlorine Dosing</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="cl_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Target Dose (mg/L)</label><input type="number" id="cl_dose" value="5.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcChlorine()">Calculate Chlorine</button>
<button class="btn gray" onclick="resetChlorine()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Chlorine Required</td><td><span class="result" id="r_cl_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution (12.5%)</td><td><span class="result" id="r_cl_gal">-</span></td><td>gal/day</td></tr>
</tbody></table>
</div>
</div>

<!-- Polymer Dosing Calculator -->
<div class="section" id="polymerCalcSection">
<div class="section-h">üíä Polymer Dosing</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sludge Flow (GPM)</label><input type="number" id="poly_flow" value="50"></div>
<div class="input-group"><label>Solids Concentration (%)</label><input type="number" id="poly_solids" value="1.0" step="0.1"></div>
<div class="input-group"><label>Dose Rate (lb/dry ton)</label><input type="number" id="poly_dose" value="8"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPolymer()">Calculate Polymer</button>
<button class="btn gray" onclick="resetPolymer()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Dry Solids</td><td><span class="result" id="r_poly_dry">-</span></td><td>lb/hr</td></tr>
<tr><td class="rowh">Polymer Required</td><td><span class="result" id="r_poly_lb">-</span></td><td>lb/hr</td></tr>
</tbody></table>
</div>
</div>

<!-- ========== EXPANDED CHEMICAL CALCULATORS ========== -->

<!-- Dechlorination Calculator -->
<div class="section" id="dechlorCalcSection">
<div class="section-h">üß™ Dechlorination (Sulfite)</div>
<div class="section-content">
<div class="note info" style="margin-bottom:12px">
<strong>üí° Dechlorination Info:</strong> Sodium bisulfite (SBS) or sulfur dioxide removes chlorine residual before discharge. Typical ratio: 1.0-1.5 mg SBS per 1.0 mg Cl‚ÇÇ. <em>Adjust SG and Strength from your SDS.</em>
</div>
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="dechlor_flow" value="5.0" step="0.1" oninput="calcDechlorination()"></div>
<div class="input-group"><label>Chlorine Residual (mg/L)</label><input type="number" id="dechlor_cl_res" value="0.5" step="0.1" oninput="calcDechlorination()"></div>
<div class="input-group"><label>SBS:Cl‚ÇÇ Ratio</label><input type="number" id="dechlor_ratio" value="1.2" step="0.1" oninput="calcDechlorination()"></div>
</div>
<div class="row">
<div class="input-group"><label>Solution Strength (%) <span style="color:#f59e0b;font-size:10px">üìã SDS</span></label><input type="number" id="dechlor_strength" value="38" step="1" oninput="calcDechlorination()"></div>
<div class="input-group"><label>Specific Gravity <span style="color:#f59e0b;font-size:10px">üìã SDS</span></label><input type="number" id="dechlor_sg" value="1.35" step="0.01" oninput="calcDechlorination()"></div>
<div class="input-group"><label>Cost ($/gal)</label><input type="number" id="dechlor_cost" value="3.50" step="0.10" oninput="calcDechlorination()"></div>
</div>
<table class="table"><tbody>
<tr><td class="rowh">SBS Required (100%)</td><td><span class="result" id="r_dechlor_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed Rate</td><td><span class="result" id="r_dechlor_gal">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Daily Cost</td><td><span class="result" id="r_dechlor_cost">-</span></td><td>$/day</td></tr>
</tbody></table>
<div class="btns" style="margin-top:12px">
<button class="btn green" onclick="calcDechlorination()">üß™ Calculate</button>
<button class="btn gray" onclick="resetDechlorination()">Reset</button>
</div>
</div>
</div>

<!-- Ferric Chloride / Coagulant Calculator -->
<div class="section" id="coagCalcSection">
<div class="section-h">üî∂ Coagulant Dosing (Ferric/Alum)</div>
<div class="section-content">
<div class="note info" style="margin-bottom:12px">
<strong>üí° Coagulation:</strong> Ferric chloride and alum are used for phosphorus removal and TSS reduction. <em>Adjust SG and Strength from your SDS.</em>
</div>
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="coag_flow" value="5.0" step="0.1" oninput="calcCoagulant()"></div>
<div class="input-group"><label>Target Dose (mg/L)</label><input type="number" id="coag_dose" value="30" step="5" oninput="calcCoagulant()"></div>
<div class="input-group">
<label>Chemical Type</label>
<select id="coag_type" onchange="updateCoagDefaults(); calcCoagulant()">
<option value="ferric">Ferric Chloride</option>
<option value="alum">Alum</option>
<option value="pac">PAC</option>
<option value="custom">Custom</option>
</select>
</div>
</div>
<div class="row">
<div class="input-group"><label>Solution Strength (%) <span style="color:#f59e0b;font-size:10px">üìã SDS</span></label><input type="number" id="coag_strength" value="40" step="1" oninput="calcCoagulant()"></div>
<div class="input-group"><label>Specific Gravity <span style="color:#f59e0b;font-size:10px">üìã SDS</span></label><input type="number" id="coag_sg" value="1.42" step="0.01" oninput="calcCoagulant()"></div>
<div class="input-group"><label>Cost ($/gal)</label><input type="number" id="coag_cost" value="1.80" step="0.10" oninput="calcCoagulant()"></div>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Chemical Required</td><td><span class="result" id="r_coag_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed Rate</td><td><span class="result" id="r_coag_gal">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Feed Pump Setting</td><td><span class="result" id="r_coag_gph">-</span></td><td>gal/hr</td></tr>
<tr><td class="rowh">Daily Cost</td><td><span class="result" id="r_coag_cost">-</span></td><td>$/day</td></tr>
</tbody></table>
<div class="btns" style="margin-top:12px">
<button class="btn green" onclick="calcCoagulant()">üî∂ Calculate</button>
<button class="btn gray" onclick="resetCoagulant()">Reset</button>
</div>
</div>
</div>

<!-- pH Adjustment Calculator -->
<div class="section" id="phAdjustSection">
<div class="section-h">‚öñÔ∏è pH Adjustment</div>
<div class="section-content">
<div class="note info" style="margin-bottom:12px">
<strong>üí° pH Control:</strong> Caustic (NaOH) raises pH. Sulfuric acid (H‚ÇÇSO‚ÇÑ) or CO‚ÇÇ lowers pH. <em>Adjust SG and Strength from your SDS.</em>
</div>
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="ph_flow" value="5.0" step="0.1" oninput="calcPHAdjust()"></div>
<div class="input-group">
<label>Chemical Type</label>
<select id="ph_type" onchange="updatePHDefaults(); calcPHAdjust()">
<option value="caustic25">Caustic (NaOH) 25%</option>
<option value="caustic50">Caustic (NaOH) 50%</option>
<option value="lime">Hydrated Lime (dry)</option>
<option value="acid93">Sulfuric Acid 93%</option>
<option value="acid50">Sulfuric Acid 50%</option>
<option value="co2">CO‚ÇÇ (gas)</option>
<option value="custom">Custom</option>
</select>
</div>
</div>
<div class="row">
<div class="input-group"><label>Current pH</label><input type="number" id="ph_current" value="6.5" step="0.1" oninput="calcPHAdjust()"></div>
<div class="input-group"><label>Target pH</label><input type="number" id="ph_target" value="7.2" step="0.1" oninput="calcPHAdjust()"></div>
<div class="input-group"><label>Alkalinity (mg/L CaCO‚ÇÉ)</label><input type="number" id="ph_alk" value="150" step="10" oninput="calcPHAdjust()"></div>
</div>
<div class="row">
<div class="input-group"><label>Solution Strength (%) <span style="color:#f59e0b;font-size:10px">üìã SDS</span></label><input type="number" id="ph_strength" value="25" step="1" oninput="calcPHAdjust()"></div>
<div class="input-group"><label>Specific Gravity <span style="color:#f59e0b;font-size:10px">üìã SDS</span></label><input type="number" id="ph_sg" value="1.27" step="0.01" oninput="calcPHAdjust()"></div>
<div class="input-group"><label>Cost ($/gal or $/lb)</label><input type="number" id="ph_cost" value="2.50" step="0.10" oninput="calcPHAdjust()"></div>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Estimated Chemical</td><td><span class="result" id="r_ph_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_ph_gal">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Daily Cost</td><td><span class="result" id="r_ph_cost">-</span></td><td>$/day</td></tr>
<tr><td class="rowh">Notes</td><td colspan="2"><span class="result" id="r_ph_notes" style="font-size:11px">-</span></td></tr>
</tbody></table>
<div class="btns" style="margin-top:12px">
<button class="btn green" onclick="calcPHAdjust()">‚öñÔ∏è Calculate</button>
<button class="btn gray" onclick="resetPHAdjust()">Reset</button>
</div>
</div>
</div>

<!-- Nutrient (Carbon) Dosing Calculator -->
<div class="section" id="carbonCalcSection">
<div class="section-h">üå± Carbon Source Dosing</div>
<div class="section-content">
<div class="note info" style="margin-bottom:12px">
<strong>üí° Denitrification Carbon:</strong> External carbon needed when BOD:N ratio is too low. <em>Adjust SG and C:N ratio from your SDS.</em>
</div>
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="carbon_flow" value="5.0" step="0.1" oninput="calcCarbonSource()"></div>
<div class="input-group"><label>NO‚ÇÉ-N to Remove (mg/L)</label><input type="number" id="carbon_no3" value="15" step="1" oninput="calcCarbonSource()"></div>
<div class="input-group">
<label>Carbon Source</label>
<select id="carbon_type" onchange="updateCarbonDefaults(); calcCarbonSource()">
<option value="methanol">Methanol</option>
<option value="glycerin">Glycerin</option>
<option value="microc">MicroC/Glycerol</option>
<option value="acetic">Acetic Acid</option>
<option value="custom">Custom</option>
</select>
</div>
</div>
<div class="row">
<div class="input-group"><label>C:N Ratio (lb C/lb N) <span style="color:#f59e0b;font-size:10px">üìã SDS</span></label><input type="number" id="carbon_ratio" value="3.0" step="0.1" oninput="calcCarbonSource()"></div>
<div class="input-group"><label>Specific Gravity <span style="color:#f59e0b;font-size:10px">üìã SDS</span></label><input type="number" id="carbon_sg" value="0.79" step="0.01" oninput="calcCarbonSource()"></div>
<div class="input-group"><label>Cost ($/gal)</label><input type="number" id="carbon_cost" value="2.00" step="0.10" oninput="calcCarbonSource()"></div>
</div>
<table class="table"><tbody>
<tr><td class="rowh">N Load Removed</td><td><span class="result" id="r_carbon_nload">-</span></td><td>lb N/day</td></tr>
<tr><td class="rowh">Carbon Required</td><td><span class="result" id="r_carbon_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Feed Rate</td><td><span class="result" id="r_carbon_gal">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Daily Cost</td><td><span class="result" id="r_carbon_cost">-</span></td><td>$/day</td></tr>
</tbody></table>
<div class="btns" style="margin-top:12px">
<button class="btn green" onclick="calcCarbonSource()">üå± Calculate</button>
<button class="btn gray" onclick="resetCarbonSource()">Reset</button>
</div>
</div>
</div>

<!-- Odor Control Calculator -->
<div class="section" id="odorCalcSection">
<div class="section-h">üëÉ Odor Control Dosing</div>
<div class="section-content">
<div class="note info" style="margin-bottom:12px">
<strong>üí° H‚ÇÇS Control:</strong> Ferrous/ferric salts, nitrate, or oxidizers control hydrogen sulfide. <em>Adjust SG and Strength from your SDS.</em>
</div>
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="odor_flow" value="5.0" step="0.1" oninput="calcOdorControl()"></div>
<div class="input-group"><label>H‚ÇÇS Concentration (mg/L)</label><input type="number" id="odor_h2s" value="5" step="0.5" oninput="calcOdorControl()"></div>
<div class="input-group">
<label>Treatment Chemical</label>
<select id="odor_type" onchange="updateOdorDefaults(); calcOdorControl()">
<option value="ferrous">Ferrous Chloride</option>
<option value="ferric">Ferric Chloride</option>
<option value="nitrate">Calcium Nitrate</option>
<option value="peroxide">Hydrogen Peroxide</option>
<option value="custom">Custom</option>
</select>
</div>
</div>
<div class="row">
<div class="input-group"><label>Solution Strength (%) <span style="color:#f59e0b;font-size:10px">üìã SDS</span></label><input type="number" id="odor_strength" value="30" step="1" oninput="calcOdorControl()"></div>
<div class="input-group"><label>Specific Gravity <span style="color:#f59e0b;font-size:10px">üìã SDS</span></label><input type="number" id="odor_sg" value="1.35" step="0.01" oninput="calcOdorControl()"></div>
<div class="input-group"><label>Fe:S or Ox:S Ratio</label><input type="number" id="odor_ratio" value="3.0" step="0.5" oninput="calcOdorControl()"></div>
<div class="input-group"><label>Cost ($/gal)</label><input type="number" id="odor_cost" value="1.50" step="0.10" oninput="calcOdorControl()"></div>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Chemical Required</td><td><span class="result" id="r_odor_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Feed Rate</td><td><span class="result" id="r_odor_gal">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Daily Cost</td><td><span class="result" id="r_odor_cost">-</span></td><td>$/day</td></tr>
</tbody></table>
<div class="btns" style="margin-top:12px">
<button class="btn green" onclick="calcOdorControl()">üëÉ Calculate</button>
<button class="btn gray" onclick="resetOdorControl()">Reset</button>
</div>
</div>
</div>

<!-- Chemical Dilution Calculator -->
<div class="section" id="dilutionCalcSection">
<div class="section-h">üß´ Chemical Dilution Calculator</div>
<div class="section-content">
<div class="note info" style="margin-bottom:12px">
<strong>üí° Dilution Formula:</strong> C‚ÇÅV‚ÇÅ = C‚ÇÇV‚ÇÇ (Concentration √ó Volume of stock = Concentration √ó Volume of diluted)
</div>
<div class="row">
<div class="input-group"><label>Stock Concentration (%)</label><input type="number" id="dil_c1" value="12.5" step="0.5" oninput="calcDilution()"></div>
<div class="input-group"><label>Target Concentration (%)</label><input type="number" id="dil_c2" value="1.0" step="0.1" oninput="calcDilution()"></div>
<div class="input-group"><label>Final Volume Needed (gal)</label><input type="number" id="dil_v2" value="100" step="10" oninput="calcDilution()"></div>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Stock Solution Needed</td><td><span class="result" id="r_dil_v1">-</span></td><td>gallons</td></tr>
<tr><td class="rowh">Water to Add</td><td><span class="result" id="r_dil_water">-</span></td><td>gallons</td></tr>
<tr><td class="rowh">Dilution Ratio</td><td><span class="result" id="r_dil_ratio">-</span></td><td>: 1</td></tr>
</tbody></table>
<div class="btns" style="margin-top:12px">
<button class="btn green" onclick="calcDilution()">üß´ Calculate</button>
<button class="btn gray" onclick="resetDilution()">Reset</button>
</div>
</div>
</div>

<!-- Pumping Calculator -->
<div class="section">
<div class="section-h">‚õΩ Pumping & Hydraulics</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (GPM)</label><input type="number" id="pump_flow" value="500"></div>
<div class="input-group"><label>Total Dynamic Head (ft)</label><input type="number" id="pump_tdh" value="50"></div>
<div class="input-group"><label>Pump Efficiency (%)</label><input type="number" id="pump_eff" value="70"></div>
<div class="input-group"><label>Motor Efficiency (%)</label><input type="number" id="motor_eff" value="90"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPump()">Calculate Pump</button>
<button class="btn gray" onclick="resetPump()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Water Horsepower</td><td><span class="result" id="r_pump_whp">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Brake Horsepower</td><td><span class="result" id="r_pump_bhp">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Motor Horsepower</td><td><span class="result" id="r_pump_mhp">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Power Draw</td><td><span class="result" id="r_pump_kw">-</span></td><td>kW</td></tr>
</tbody></table>


<!-- Alkalinity Calculator -->
<div class="section">
<div class="section-h">‚öóÔ∏è Alkalinity Requirements</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>TKN Removed (mg/L)</label><input type="number" id="alk_tkn" value="25"></div>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="alk_flow" value="5.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcAlkalinity()">Calculate</button>
<button class="btn gray" onclick="resetAlkalinity()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Alkalinity Consumed</td><td><span class="result" id="r_alk_consumed">-</span></td><td>mg/L as CaCO3</td></tr>
<tr><td class="rowh">Daily Alk Required</td><td><span class="result" id="r_alk_daily">-</span></td><td>lb/day</td></tr>
</tbody></table>
</div>
</div>

<!-- HYDRAULICS SECTION -->
<!-- Surface Overflow Rate (SOR) Calculator -->
<div class="section" id="hydraulicsSection">
<div class="section-h">üåä Surface Overflow Rate (SOR)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="sor_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Clarifier Area (sq ft)</label><input type="number" id="sor_area" value="5000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSOR()">Calculate SOR</button>
<button class="btn gray" onclick="resetSOR()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Surface Overflow Rate</td><td><span class="result" id="r_sor">-</span></td><td>gpd/sq ft</td><td><span class="status" id="s_sor">-</span></td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_sor_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Weir Overflow Rate (WOR) Calculator -->
<div class="section">
<div class="section-h">üîÑ Weir Overflow Rate (WOR)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="wor_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Weir Length (ft)</label><input type="number" id="wor_length" value="150"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcWOR()">Calculate WOR</button>
<button class="btn gray" onclick="resetWOR()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Weir Overflow Rate</td><td><span class="result" id="r_wor">-</span></td><td>gpd/ft</td><td><span class="status" id="s_wor">-</span></td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_wor_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Solids Loading Rate (SLR) Calculator -->
<div class="section">
<div class="section-h">üìä Solids Loading Rate (SLR)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="slr_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="slr_mlss" value="3000"></div>
<div class="input-group"><label>RAS Flow (MGD)</label><input type="number" id="slr_ras" value="2.0" step="0.1"></div>
<div class="input-group"><label>Clarifier Area (sq ft)</label><input type="number" id="slr_area" value="5000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSLR()">Calculate SLR</button>
<button class="btn gray" onclick="resetSLR()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Solids Loading Rate</td><td><span class="result" id="r_slr">-</span></td><td>lb/sq ft/day</td><td><span class="status" id="s_slr">-</span></td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_slr_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Mean Cell Residence Time (MCRT) Calculator -->
<div class="section">
<div class="section-h">‚è±Ô∏è Mean Cell Residence Time (MCRT)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="mcrt_vol" value="1.5" step="0.1"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="mcrt_mlss" value="3000"></div>
<div class="input-group"><label>WAS Flow (MGD)</label><input type="number" id="mcrt_was" value="0.05" step="0.01"></div>
<div class="input-group"><label>WAS TSS (mg/L)</label><input type="number" id="mcrt_was_tss" value="8000"></div>
<div class="input-group"><label>Effluent Flow (MGD)</label><input type="number" id="mcrt_eff" value="5.0" step="0.1"></div>
<div class="input-group"><label>Effluent TSS (mg/L)</label><input type="number" id="mcrt_eff_tss" value="10"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcMCRT()">Calculate MCRT</button>
<button class="btn gray" onclick="resetMCRT()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">System Solids</td><td><span class="result" id="r_mcrt_solids">-</span></td><td>lb</td></tr>
<tr><td class="rowh">Solids Wasted</td><td><span class="result" id="r_mcrt_wasted">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">MCRT</td><td><span class="result" id="r_mcrt">-</span></td><td>days</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_mcrt_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Oxygen Uptake Rate (OUR) Calculator -->
<div class="section">
<div class="section-h">üí® Oxygen Uptake Rate (OUR)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>DO Start (mg/L)</label><input type="number" id="our_do1" value="6.0" step="0.1"></div>
<div class="input-group"><label>DO End (mg/L)</label><input type="number" id="our_do2" value="2.0" step="0.1"></div>
<div class="input-group"><label>Time (minutes)</label><input type="number" id="our_time" value="15"></div>
<div class="input-group"><label>MLVSS (mg/L)</label><input type="number" id="our_mlvss" value="2000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcOUR()">Calculate OUR</button>
<button class="btn gray" onclick="resetOUR()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">OUR</td><td><span class="result" id="r_our">-</span></td><td>mg/L/hr</td></tr>
<tr><td class="rowh">SOUR</td><td><span class="result" id="r_sour">-</span></td><td>mg O2/g MLVSS/hr</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_our_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- COMPREHENSIVE SLUDGE AGE CALCULATOR - MULTIPLE METHODS -->
<div class="section" id="sludgeAgeCalculator" style="border:2px solid #8b5cf6">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);color:white">
üìÖ Sludge Age Calculator (Multiple Methods)
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">5 Methods</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate SRT/MCRT using different methods. Compare results to verify accuracy.</p>

<!-- Common Inputs -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#a78bfa">üìä System Parameters</h4>
<div class="row">
<div class="input-group">
<label style="color:#a78bfa">Aeration Volume (MG)</label>
<input type="number" id="sa_vol" value="1.5" step="0.1" onchange="calcAllSludgeAge()">
</div>
<div class="input-group">
<label style="color:#a78bfa">MLSS (mg/L)</label>
<input type="number" id="sa_mlss" value="3000" onchange="calcAllSludgeAge()">
</div>
<div class="input-group">
<label style="color:#a78bfa">MLVSS (mg/L)</label>
<input type="number" id="sa_mlvss" value="2400" onchange="calcAllSludgeAge()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Clarifier Volume (MG)</label>
<input type="number" id="sa_clar_vol" value="0.3" step="0.1" onchange="calcAllSludgeAge()">
</div>
<div class="input-group">
<label>Clarifier TSS (mg/L)</label>
<input type="number" id="sa_clar_tss" value="5000" onchange="calcAllSludgeAge()">
</div>
<div class="input-group">
<label>Water Temperature (¬∞C)</label>
<input type="number" id="sa_temp" value="20" onchange="calcAllSludgeAge()">
</div>
</div>
</div>

<!-- Method Tabs -->
<div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:15px">
<button class="btn" id="sa_tab_1" onclick="showSAMethod(1)" style="flex:1;min-width:80px;padding:8px;font-size:12px;background:#8b5cf6">üìä Standard</button>
<button class="btn gray" id="sa_tab_2" onclick="showSAMethod(2)" style="flex:1;min-width:80px;padding:8px;font-size:12px">‚è±Ô∏è MCRT</button>
<button class="btn gray" id="sa_tab_3" onclick="showSAMethod(3)" style="flex:1;min-width:80px;padding:8px;font-size:12px">üå°Ô∏è Aerobic</button>
<button class="btn gray" id="sa_tab_4" onclick="showSAMethod(4)" style="flex:1;min-width:80px;padding:8px;font-size:12px">‚öñÔ∏è F/M Based</button>
<button class="btn gray" id="sa_tab_5" onclick="showSAMethod(5)" style="flex:1;min-width:80px;padding:8px;font-size:12px">üßÆ Kinetic</button>
</div>

<!-- Method 1: Standard SRT -->
<div id="sa_method_1" class="sa-method-panel" style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üìä Method 1: Standard SRT</h4>
<div class="note info" style="margin-bottom:15px">SRT = Total System Solids √∑ Solids Wasted per Day</div>
<div class="row">
<div class="input-group">
<label>WAS Flow (GPD)</label>
<input type="number" id="sa1_was_flow" value="25000" onchange="calcSA1()">
</div>
<div class="input-group">
<label>WAS TSS (mg/L)</label>
<input type="number" id="sa1_was_tss" value="8000" onchange="calcSA1()">
</div>
</div>
<div class="btns"><button class="btn gradient" onclick="calcSA1()">Calculate Standard SRT</button></div>
<div id="sa1_result" style="margin-top:15px"></div>
</div>

<!-- Method 2: MCRT (with effluent loss) -->
<div id="sa_method_2" class="sa-method-panel" style="display:none;background:#243b55;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">‚è±Ô∏è Method 2: MCRT (Mean Cell Residence Time)</h4>
<div class="note info" style="margin-bottom:15px">MCRT = Total Solids √∑ (WAS Solids + Effluent Solids Loss)</div>
<div class="row">
<div class="input-group">
<label>WAS Flow (GPD)</label>
<input type="number" id="sa2_was_flow" value="25000" onchange="calcSA2()">
</div>
<div class="input-group">
<label>WAS TSS (mg/L)</label>
<input type="number" id="sa2_was_tss" value="8000" onchange="calcSA2()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Effluent Flow (MGD)</label>
<input type="number" id="sa2_eff_flow" value="5.0" step="0.1" onchange="calcSA2()">
</div>
<div class="input-group">
<label>Effluent TSS (mg/L)</label>
<input type="number" id="sa2_eff_tss" value="10" onchange="calcSA2()">
</div>
</div>
<div class="btns"><button class="btn gradient" onclick="calcSA2()">Calculate MCRT</button></div>
<div id="sa2_result" style="margin-top:15px"></div>
</div>

<!-- Method 3: Aerobic SRT (for nitrification) -->
<div id="sa_method_3" class="sa-method-panel" style="display:none;background:#243b55;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üå°Ô∏è Method 3: Aerobic SRT (Nitrification Design)</h4>
<div class="note info" style="margin-bottom:15px">Minimum SRT for nitrification based on temperature and safety factor</div>
<div class="row">
<div class="input-group">
<label>Design Temperature (¬∞C)</label>
<input type="number" id="sa3_temp" value="15" onchange="calcSA3()">
</div>
<div class="input-group">
<label>Safety Factor</label>
<input type="number" id="sa3_sf" value="2.0" step="0.1" onchange="calcSA3()">
</div>
<div class="input-group">
<label>Max Nitrifier Growth (1/d)</label>
<input type="number" id="sa3_umax" value="0.75" step="0.05" onchange="calcSA3()">
</div>
</div>
<div class="btns"><button class="btn gradient" onclick="calcSA3()">Calculate Min Aerobic SRT</button></div>
<div id="sa3_result" style="margin-top:15px"></div>
</div>

<!-- Method 4: F/M Based SRT -->
<div id="sa_method_4" class="sa-method-panel" style="display:none;background:#243b55;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#f97316">‚öñÔ∏è Method 4: F/M Ratio Based SRT</h4>
<div class="note info" style="margin-bottom:15px">SRT estimated from F/M ratio: SRT ‚âà 1 / (Y √ó F/M - kd)</div>
<div class="row">
<div class="input-group">
<label>BOD Loading (lb/day)</label>
<input type="number" id="sa4_bod" value="4170" onchange="calcSA4()">
</div>
<div class="input-group">
<label>Yield Coefficient (Y)</label>
<input type="number" id="sa4_y" value="0.6" step="0.05" onchange="calcSA4()">
</div>
<div class="input-group">
<label>Decay Rate (kd, 1/d)</label>
<input type="number" id="sa4_kd" value="0.06" step="0.01" onchange="calcSA4()">
</div>
</div>
<div class="btns"><button class="btn gradient" onclick="calcSA4()">Calculate from F/M</button></div>
<div id="sa4_result" style="margin-top:15px"></div>
</div>

<!-- Method 5: Kinetic (Monod) -->
<div id="sa_method_5" class="sa-method-panel" style="display:none;background:#243b55;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#ec4899">üßÆ Method 5: Kinetic Model (Monod)</h4>
<div class="note info" style="margin-bottom:15px">SRT from Monod kinetics: SRT = (Ks + S) / (Œºmax √ó S - kd √ó (Ks + S))</div>
<div class="row">
<div class="input-group">
<label>Effluent BOD (S, mg/L)</label>
<input type="number" id="sa5_s" value="10" onchange="calcSA5()">
</div>
<div class="input-group">
<label>Half-sat Constant (Ks)</label>
<input type="number" id="sa5_ks" value="60" onchange="calcSA5()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Max Growth Rate (Œºmax, 1/d)</label>
<input type="number" id="sa5_umax" value="3.0" step="0.1" onchange="calcSA5()">
</div>
<div class="input-group">
<label>Decay Rate (kd, 1/d)</label>
<input type="number" id="sa5_kd" value="0.06" step="0.01" onchange="calcSA5()">
</div>
</div>
<div class="btns"><button class="btn gradient" onclick="calcSA5()">Calculate Kinetic SRT</button></div>
<div id="sa5_result" style="margin-top:15px"></div>
</div>

<!-- Compare All Methods Button -->
<div class="btns">
<button class="btn blue" onclick="compareAllSA()" style="font-size:16px;padding:12px 24px">üìä Compare All Methods</button>
<button class="btn gray" onclick="resetAllSA()">üîÑ Reset All</button>
</div>

<!-- Comparison Results -->
<div id="sa_comparison" style="margin-top:20px"></div>

<!-- Reference Table -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#8b5cf6">üìö SRT Guidelines by Process Type</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>Process Type</th><th>SRT (days)</th><th>F/M (lb/lb/d)</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>High-Rate AS</td><td>2-4</td><td>0.4-1.0</td><td>BOD removal only</td></tr>
<tr><td>Conventional AS</td><td>4-8</td><td>0.2-0.4</td><td>Good BOD removal</td></tr>
<tr style="background:rgba(74,222,128,0.1)"><td>Nitrification</td><td>8-15</td><td>0.1-0.2</td><td>Complete nitrification</td></tr>
<tr><td>Extended Aeration</td><td>15-30</td><td>0.05-0.1</td><td>Low sludge production</td></tr>
<tr><td>MBR Systems</td><td>15-50</td><td>0.05-0.15</td><td>High MLSS operation</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">üå°Ô∏è Min SRT for Nitrification:</strong>
<div style="font-size:12px;margin-top:5px">
20¬∞C: 4-5 days<br>
15¬∞C: 6-8 days<br>
10¬∞C: 10-15 days<br>
5¬∞C: 20+ days
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">‚ö†Ô∏è Common Issues:</strong>
<div style="font-size:12px;margin-top:5px">
SRT too low: Poor nitrification<br>
SRT too high: Pin floc, high DO demand<br>
Variable SRT: Inconsistent performance
</div>
</div>
</div>
</div>

</div>
</div>

<!-- Ammonia Removal Calculator -->
<div class="section">
<div class="section-h">üß™ Ammonia/TKN Removal</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent NH3-N (mg/L)</label><input type="number" id="nh3_in" value="25" step="0.1"></div>
<div class="input-group"><label>Effluent NH3-N (mg/L)</label><input type="number" id="nh3_out" value="1.0" step="0.1"></div>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="nh3_flow" value="5.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcNH3()">Calculate Removal</button>
<button class="btn gray" onclick="resetNH3()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">NH3-N Removed</td><td><span class="result" id="r_nh3_removed">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Removal Efficiency</td><td><span class="result" id="r_nh3_eff">-</span></td><td>%</td></tr>
<tr><td class="rowh">Mass Removed</td><td><span class="result" id="r_nh3_mass">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Alkalinity Consumed</td><td><span class="result" id="r_nh3_alk">-</span></td><td>lb/day as CaCO3</td></tr>
</tbody></table>
</div>
</div>

<!-- Phosphorus Removal Calculator -->
<div class="section">
<div class="section-h">üî¨ Phosphorus Removal</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent TP (mg/L)</label><input type="number" id="phos_in" value="6.0" step="0.1"></div>
<div class="input-group"><label>Effluent TP (mg/L)</label><input type="number" id="phos_out" value="0.5" step="0.1"></div>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="phos_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Chemical (Alum/Ferric)</label><select id="phos_chem"><option value="alum">Alum</option><option value="ferric">Ferric Chloride</option></select></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPhos()">Calculate Removal</button>
<button class="btn gray" onclick="resetPhos()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">TP Removed</td><td><span class="result" id="r_phos_removed">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Removal Efficiency</td><td><span class="result" id="r_phos_eff">-</span></td><td>%</td></tr>
<tr><td class="rowh">Chemical Dose Required</td><td><span class="result" id="r_phos_dose">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Molar Ratio</td><td><span class="result" id="r_phos_ratio">-</span></td><td>mol/mol P</td></tr>
</tbody></table>
</div>
</div>

<!-- COMPREHENSIVE NUTRIENT BALANCE CALCULATOR -->
<div class="section" id="nutrientBalanceCalculator" style="border:2px solid #22c55e">
<div class="section-h" style="background:linear-gradient(135deg,#16a34a,#22c55e);color:white">
üåø Nutrient Balance Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">BNR Analysis</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Complete nitrogen and phosphorus balance through the treatment process.</p>

<!-- Influent Characteristics -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#22c55e">üì• Influent Characteristics</h4>
<div class="row">
<div class="input-group">
<label style="color:#22c55e">Flow (MGD)</label>
<input type="number" id="nb_flow" value="5.0" step="0.1" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label style="color:#22c55e">BOD (mg/L)</label>
<input type="number" id="nb_bod" value="200" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label style="color:#22c55e">TSS (mg/L)</label>
<input type="number" id="nb_tss" value="220" onchange="calcNutrientBalance()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>TKN (mg/L)</label>
<input type="number" id="nb_tkn" value="40" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>NH3-N (mg/L)</label>
<input type="number" id="nb_nh3" value="28" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>Organic-N (mg/L)</label>
<input type="number" id="nb_orgn" value="12" onchange="calcNutrientBalance()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Total P (mg/L)</label>
<input type="number" id="nb_tp" value="7" step="0.5" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>Ortho-P (mg/L)</label>
<input type="number" id="nb_op" value="5" step="0.5" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>Temperature (¬∞C)</label>
<input type="number" id="nb_temp" value="20" onchange="calcNutrientBalance()">
</div>
</div>
</div>

<!-- Process Configuration -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">‚öôÔ∏è Process Configuration</h4>
<div class="row">
<div class="input-group">
<label>Process Type</label>
<select id="nb_process" style="font-size:14px" onchange="updateNBDefaults()">
<option value="conv">Conventional (BOD only)</option>
<option value="nit" selected>Nitrification</option>
<option value="ndn">Nitrification-Denitrification</option>
<option value="bnr">Full BNR (N+P)</option>
<option value="ebpr">Enhanced Bio-P (EBPR)</option>
</select>
</div>
<div class="input-group">
<label>SRT (days)</label>
<input type="number" id="nb_srt" value="12" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="nb_mlss" value="3000" onchange="calcNutrientBalance()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Anoxic Fraction (%)</label>
<input type="number" id="nb_anoxic" value="33" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>Internal Recycle Ratio</label>
<input type="number" id="nb_ir" value="3" step="0.5" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>RAS Ratio</label>
<input type="number" id="nb_ras" value="0.5" step="0.1" onchange="calcNutrientBalance()">
</div>
</div>
</div>

<!-- Effluent Limits -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üéØ Effluent Targets/Limits</h4>
<div class="row">
<div class="input-group">
<label>NH3-N Limit (mg/L)</label>
<input type="number" id="nb_nh3_lim" value="2" step="0.5" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>TN Limit (mg/L)</label>
<input type="number" id="nb_tn_lim" value="10" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>TP Limit (mg/L)</label>
<input type="number" id="nb_tp_lim" value="1" step="0.1" onchange="calcNutrientBalance()">
</div>
</div>
</div>

<!-- Chemical Addition -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#a78bfa">‚öóÔ∏è Chemical Addition (if needed)</h4>
<div class="row">
<div class="input-group">
<label>Carbon Source</label>
<select id="nb_carbon" style="font-size:14px">
<option value="none">None (endogenous)</option>
<option value="methanol">Methanol</option>
<option value="acetate">Acetic Acid</option>
<option value="glycerol">Glycerol</option>
<option value="microc">MicroC</option>
</select>
</div>
<div class="input-group">
<label>P Removal Chemical</label>
<select id="nb_pchem" style="font-size:14px">
<option value="none">None (Bio-P only)</option>
<option value="alum">Alum</option>
<option value="ferric">Ferric Chloride</option>
<option value="ferrous">Ferrous Sulfate</option>
</select>
</div>
<div class="input-group">
<label>Alkalinity Available (mg/L)</label>
<input type="number" id="nb_alk" value="200" onchange="calcNutrientBalance()">
</div>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcNutrientBalance()">üåø Calculate Balance</button>
<button class="btn blue" onclick="showNutrientDiagram()">üìä Show Flow Diagram</button>
<button class="btn gray" onclick="resetNutrientBalance()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="nb_results" style="margin-top:20px"></div>

<!-- Diagram -->
<div id="nb_diagram" style="margin-top:15px"></div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#22c55e">üìö Nutrient Removal Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Process</th><th>TN Achievable</th><th>TP Achievable</th><th>Key Requirements</th></tr>
</thead>
<tbody>
<tr><td>Conventional</td><td>25-35 mg/L</td><td>4-6 mg/L</td><td>BOD removal only</td></tr>
<tr><td>Nitrification</td><td>20-30 mg/L</td><td>4-6 mg/L</td><td>SRT >8d @ 20¬∞C</td></tr>
<tr style="background:rgba(74,222,128,0.1)"><td>Nit-Denit</td><td>8-12 mg/L</td><td>4-6 mg/L</td><td>Anoxic zone, carbon</td></tr>
<tr><td>BNR (MLE)</td><td>6-10 mg/L</td><td>1-2 mg/L</td><td>Bio-P + denit</td></tr>
<tr><td>Advanced BNR</td><td>3-5 mg/L</td><td>0.1-0.5 mg/L</td><td>Multiple stages, chem-P</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">N Stoichiometry:</strong>
<div style="font-size:11px;margin-top:5px">
Nitrification: 4.6 lb O‚ÇÇ/lb N<br>
Denitrification: 2.9 lb BOD/lb N<br>
Alkalinity: 7.1 lb CaCO‚ÇÉ/lb N (nit)<br>
Recovery: 3.6 lb CaCO‚ÇÉ/lb N (denit)
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">P Stoichiometry:</strong>
<div style="font-size:11px;margin-top:5px">
Bio-P uptake: 0.01-0.02 lb P/lb BOD<br>
Alum: 10:1 Al:P molar ratio<br>
Ferric: 2:1 Fe:P molar ratio<br>
Sludge P content: 2-7% in EBPR
</div>
</div>
</div>
</div>

</div>
</div>

<!-- TSS/VSS Removal Calculator -->
<div class="section">
<div class="section-h">üß´ TSS/VSS Removal Efficiency</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent TSS (mg/L)</label><input type="number" id="tss_in" value="250"></div>
<div class="input-group"><label>Effluent TSS (mg/L)</label><input type="number" id="tss_out" value="10"></div>
<div class="input-group"><label>Influent VSS (mg/L)</label><input type="number" id="vss_in" value="200"></div>
<div class="input-group"><label>Effluent VSS (mg/L)</label><input type="number" id="vss_out" value="8"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcTSS()">Calculate Removal</button>
<button class="btn gray" onclick="resetTSS()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">TSS Removal</td><td><span class="result" id="r_tss_eff">-</span></td><td>%</td></tr>
<tr><td class="rowh">VSS Removal</td><td><span class="result" id="r_vss_eff">-</span></td><td>%</td></tr>
<tr><td class="rowh">VSS/TSS Ratio (In)</td><td><span class="result" id="r_vss_tss_in">-</span></td><td></td></tr>
<tr><td class="rowh">VSS/TSS Ratio (Out)</td><td><span class="result" id="r_vss_tss_out">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Grit Removal Calculator -->
<div class="section">
<div class="section-h">‚öôÔ∏è Grit Chamber Sizing</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Peak Flow (MGD)</label><input type="number" id="grit_flow" value="10.0" step="0.1"></div>
<div class="input-group"><label>Detention Time (min)</label><input type="number" id="grit_dt" value="3"></div>
<div class="input-group"><label>Depth (ft)</label><input type="number" id="grit_depth" value="10"></div>
<div class="input-group"><label>Width (ft)</label><input type="number" id="grit_width" value="8"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcGrit()">Calculate Grit</button>
<button class="btn gray" onclick="resetGrit()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Volume Required</td><td><span class="result" id="r_grit_vol">-</span></td><td>cu ft</td></tr>
<tr><td class="rowh">Length Required</td><td><span class="result" id="r_grit_length">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Surface Area</td><td><span class="result" id="r_grit_area">-</span></td><td>sq ft</td></tr>
<tr><td class="rowh">Horizontal Velocity</td><td><span class="result" id="r_grit_vel">-</span></td><td>ft/min</td></tr>
</tbody></table>
</div>
</div>

<!-- Digester Loading Calculator -->
<div class="section">
<div class="section-h">üî• Anaerobic Digester Loading</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sludge Volume (gpd)</label><input type="number" id="dig_vol" value="50000"></div>
<div class="input-group"><label>Sludge Solids (%)</label><input type="number" id="dig_solids" value="5" step="0.1"></div>
<div class="input-group"><label>VS/TS Ratio</label><input type="number" id="dig_vs" value="0.75" step="0.01"></div>
<div class="input-group"><label>Digester Volume (cu ft)</label><input type="number" id="dig_tank" value="50000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcDigester()">Calculate Loading</button>
<button class="btn gray" onclick="resetDigester()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">VS Loading</td><td><span class="result" id="r_dig_vs">-</span></td><td>lb VS/day</td></tr>
<tr><td class="rowh">Volumetric Loading</td><td><span class="result" id="r_dig_vlr">-</span></td><td>lb VS/cu ft/day</td></tr>
<tr><td class="rowh">HRT</td><td><span class="result" id="r_dig_hrt">-</span></td><td>days</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_dig_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

>

<!-- MLSS Calculator -->
<div class="section" id="mlssCalcSection">
<div class="section-h">üî¨ MLSS/MLVSS Calculator</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="mlss_val" value="3000"></div>
<div class="input-group"><label>VSS Ratio (%)</label><input type="number" id="mlss_vss" value="75"></div>
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="mlss_vol" value="1.5" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcMLSS()">Calculate</button>
<button class="btn gray" onclick="resetMLSS()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">MLVSS</td><td><span class="result" id="r_mlvss">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Total Solids</td><td><span class="result" id="r_mlss_lb">-</span></td><td>lb</td></tr>
<tr><td class="rowh">Volatile Solids</td><td><span class="result" id="r_mlvss_lb">-</span></td><td>lb</td></tr>
</tbody></table>
</div>
</div>

<!-- Clarifier Loading Calculator -->
<div class="section">
<div class="section-h">üåä Clarifier Loading Rates</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="clar_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Clarifier Diameter (ft)</label><input type="number" id="clar_diam" value="65"></div>
<div class="input-group"><label>RAS Flow (MGD)</label><input type="number" id="clar_ras_flow" value="1.5" step="0.1"></div>
<div class="input-group"><label>Weir Length (ft)</label><input type="number" id="clar_weir" value="204"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="clar_mlss" value="3000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcClarifier()">Calculate</button>
<button class="btn gray" onclick="resetClarifier()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Surface Overflow Rate</td><td><span class="result" id="r_clar_sor">-</span></td><td>gpd/sq ft</td></tr>
<tr><td class="rowh">Weir Overflow Rate</td><td><span class="result" id="r_clar_wor">-</span></td><td>gpd/ft</td></tr>
<tr><td class="rowh">Solids Loading</td><td><span class="result" id="r_clar_slr">-</span></td><td>lb/sq ft/day</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_clar_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Oxygen Transfer Calculator -->
<div class="section">
<div class="section-h">üí® Oxygen Transfer Efficiency</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Airflow (SCFM)</label><input type="number" id="ote_air" value="2000"></div>
<div class="input-group"><label>Diffuser Depth (ft)</label><input type="number" id="ote_depth" value="15"></div>
<div class="input-group"><label>OTE at STP (%)</label><input type="number" id="ote_stp" value="25"></div>
<div class="input-group"><label>Temperature (¬∞C)</label><input type="number" id="ote_temp" value="20"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcOTESimple()">Calculate</button>
<button class="btn gray" onclick="resetOTESimple()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Field OTE</td><td><span class="result" id="r_ote_field">-</span></td><td>%</td></tr>
<tr><td class="rowh">O2 Delivered</td><td><span class="result" id="r_ote_o2">-</span></td><td>lb O2/hr</td></tr>
<tr><td class="rowh">SOTR</td><td><span class="result" id="r_ote_sotr">-</span></td><td>lb O2/hr</td></tr>
</tbody></table>
</div>
</div>

<!-- Digester Gas Calculator -->
<div class="section">
<div class="section-h">üî• Digester Gas Production</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>VS Destroyed (lb/day)</label><input type="number" id="gas_vs" value="5000"></div>
<div class="input-group"><label>Gas Production (cf/lb VS)</label><input type="number" id="gas_rate" value="15"></div>
<div class="input-group"><label>Methane Content (%)</label><input type="number" id="gas_ch4" value="65"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcGas()">Calculate</button>
<button class="btn gray" onclick="resetGas()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Total Gas</td><td><span class="result" id="r_gas_total">-</span></td><td>cf/day</td></tr>
<tr><td class="rowh">Methane Volume</td><td><span class="result" id="r_gas_ch4">-</span></td><td>cf/day</td></tr>
<tr><td class="rowh">Energy Value</td><td><span class="result" id="r_gas_btu">-</span></td><td>BTU/day</td></tr>
<tr><td class="rowh">Power Potential</td><td><span class="result" id="r_gas_kw">-</span></td><td>kW</td></tr>
</tbody></table>
</div>
</div>

<!-- COMPREHENSIVE BELT PRESS / CENTRIFUGE CALCULATOR -->
<div class="section" id="dewateringCalculator" style="border:2px solid #ec4899">
<div class="section-h" style="background:linear-gradient(135deg,#db2777,#ec4899);color:white">
üóúÔ∏è Belt Press / Centrifuge Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Dewatering</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Comprehensive dewatering analysis for belt filter press and centrifuge operations.</p>

<!-- Equipment Selection -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#ec4899">‚öôÔ∏è Equipment Configuration</h4>
<div class="row">
<div class="input-group">
<label style="color:#ec4899">Equipment Type</label>
<select id="dw_type" style="font-size:14px" onchange="updateDewateringDefaults()">
<option value="bfp" selected>Belt Filter Press (BFP)</option>
<option value="centrifuge">Centrifuge</option>
<option value="screw">Screw Press</option>
<option value="plate">Plate & Frame Press</option>
</select>
</div>
<div class="input-group">
<label style="color:#ec4899">Number of Units</label>
<input type="number" id="dw_units" value="2" min="1" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label style="color:#ec4899">Units in Service</label>
<input type="number" id="dw_service" value="1" min="1" onchange="calcDewatering2()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Belt Width / Bowl Diameter (m)</label>
<input type="number" id="dw_size" value="2.0" step="0.1" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Operating Hours/Day</label>
<input type="number" id="dw_hours" value="8" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Days per Week</label>
<input type="number" id="dw_days" value="5" onchange="calcDewatering2()">
</div>
</div>
</div>

<!-- Feed Characteristics -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üì• Feed Sludge Characteristics</h4>
<div class="row">
<div class="input-group">
<label>Sludge Type</label>
<select id="dw_sludge" style="font-size:14px" onchange="updateSludgeDefaults()">
<option value="primary">Primary Sludge</option>
<option value="was">WAS (Thickened)</option>
<option value="mixed" selected>Mixed (Primary + WAS)</option>
<option value="digested">Anaerobically Digested</option>
<option value="aerobic">Aerobically Digested</option>
</select>
</div>
<div class="input-group">
<label>Feed Rate (GPM)</label>
<input type="number" id="dw_feed_gpm" value="150" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Feed Solids (%)</label>
<input type="number" id="dw_feed_pct" value="3.5" step="0.1" onchange="calcDewatering2()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Daily Sludge Volume (gal/day)</label>
<input type="number" id="dw_daily_vol" value="72000" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>VS/TS Ratio</label>
<input type="number" id="dw_vs_ratio" value="0.70" step="0.01" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Specific Gravity</label>
<input type="number" id="dw_sg" value="1.02" step="0.01" onchange="calcDewatering2()">
</div>
</div>
</div>

<!-- Performance Parameters -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üìä Performance Parameters</h4>
<div class="row">
<div class="input-group">
<label>Target Cake Solids (%)</label>
<input type="number" id="dw_cake_pct" value="22" step="0.5" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Solids Capture (%)</label>
<input type="number" id="dw_capture" value="95" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Hydraulic Loading (GPM/m)</label>
<input type="number" id="dw_hyd_load" value="75" onchange="calcDewatering2()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Solids Loading (lb/hr/m)</label>
<input type="number" id="dw_sol_load" value="1000" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Belt Speed (m/min)</label>
<input type="number" id="dw_belt_speed" value="3" step="0.5" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Belt Tension (psi)</label>
<input type="number" id="dw_tension" value="60" onchange="calcDewatering2()">
</div>
</div>
</div>

<!-- Polymer & Chemicals -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#a78bfa">‚öóÔ∏è Polymer Conditioning</h4>
<div class="row">
<div class="input-group">
<label>Polymer Type</label>
<select id="dw_poly_type" style="font-size:14px">
<option value="emulsion" selected>Emulsion (liquid)</option>
<option value="dry">Dry Powder</option>
<option value="mannich">Mannich</option>
</select>
</div>
<div class="input-group">
<label>Polymer Dose (lb/DT)</label>
<input type="number" id="dw_poly_dose" value="12" step="0.5" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Polymer Solution (%)</label>
<input type="number" id="dw_poly_soln" value="0.25" step="0.05" onchange="calcDewatering2()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Polymer Cost ($/lb active)</label>
<input type="number" id="dw_poly_cost" value="2.50" step="0.10" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Wash Water (GPM)</label>
<input type="number" id="dw_wash" value="80" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Electricity Cost ($/kWh)</label>
<input type="number" id="dw_elec_cost" value="0.10" step="0.01" onchange="calcDewatering2()">
</div>
</div>
</div>

<!-- Hauling & Disposal -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#ef4444">üöõ Disposal</h4>
<div class="row">
<div class="input-group">
<label>Disposal Method</label>
<select id="dw_disposal" style="font-size:14px">
<option value="landfill" selected>Landfill</option>
<option value="compost">Composting</option>
<option value="incineration">Incineration</option>
<option value="land_app">Land Application</option>
</select>
</div>
<div class="input-group">
<label>Disposal Cost ($/wet ton)</label>
<input type="number" id="dw_disp_cost" value="50" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Truck Capacity (cubic yards)</label>
<input type="number" id="dw_truck_cy" value="20" onchange="calcDewatering2()">
</div>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcDewatering2()">üóúÔ∏è Calculate Dewatering</button>
<button class="btn blue" onclick="compareDewateringEquip()">üìä Compare Equipment</button>
<button class="btn orange" onclick="optimizePolymer()">‚öóÔ∏è Optimize Polymer</button>
<button class="btn gray" onclick="resetDewatering2()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="dw2_results" style="margin-top:20px"></div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#ec4899">üìö Dewatering Equipment Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Parameter</th><th>Belt Press</th><th>Centrifuge</th><th>Screw Press</th></tr>
</thead>
<tbody>
<tr><td>Cake Solids (%)</td><td>18-25</td><td>20-30</td><td>15-25</td></tr>
<tr><td>Capture (%)</td><td>90-98</td><td>90-98</td><td>90-95</td></tr>
<tr><td>Polymer (lb/DT)</td><td>8-15</td><td>15-25</td><td>5-10</td></tr>
<tr><td>Energy (kWh/DT)</td><td>10-20</td><td>30-60</td><td>5-15</td></tr>
<tr><td>Wash Water</td><td>High</td><td>None</td><td>Low</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">Typical Cake Solids:</strong>
<div style="font-size:11px;margin-top:5px">
Primary: 28-34%<br>
WAS: 15-20%<br>
Mixed: 20-28%<br>
Digested: 22-30%
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">Polymer Dose Range:</strong>
<div style="font-size:11px;margin-top:5px">
Primary: 3-8 lb/DT<br>
WAS: 15-25 lb/DT<br>
Digested: 10-18 lb/DT<br>
Mixed: 8-15 lb/DT
</div>
</div>
</div>
</div>

</div>
</div>

</div>
</div>



<!-- Blower Air Requirements -->
<div class="section">
<div class="section-h">üí® Blower Air Requirements</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>O2 Required (lb/day)</label><input type="number" id="blower_o2" value="5000"></div>
<div class="input-group"><label>Transfer Efficiency (%)</label><input type="number" id="blower_eff" value="25"></div>
<div class="input-group"><label>Diffuser Depth (ft)</label><input type="number" id="blower_depth" value="15"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcBlower()">Calculate</button>
<button class="btn gray" onclick="resetBlower()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Air Required</td><td><span class="result" id="r_blower_air">-</span></td><td>SCFM</td></tr>
<tr><td class="rowh">Blower HP (est)</td><td><span class="result" id="r_blower_hp">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Annual Energy</td><td><span class="result" id="r_blower_kwh">-</span></td><td>kWh/yr</td></tr>
</tbody></table>
</div>
</div>

<!-- COMPREHENSIVE UV DISINFECTION CALCULATOR -->
<div class="section" id="uvDisinfectionCalculator" style="border:2px solid #06b6d4">
<div class="section-h" style="background:linear-gradient(135deg,#0891b2,#06b6d4);color:white">
‚òÄÔ∏è UV Disinfection Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Comprehensive</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Design and evaluate UV disinfection systems for various applications.</p>

<!-- System Configuration -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#06b6d4">‚öôÔ∏è System Configuration</h4>
<div class="row">
<div class="input-group">
<label style="color:#06b6d4">Design Flow (MGD)</label>
<input type="number" id="uv_flow" value="5.0" step="0.1" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label style="color:#06b6d4">Peak Flow Factor</label>
<input type="number" id="uv_pf" value="2.0" step="0.1" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label style="color:#06b6d4">Number of Channels</label>
<input type="number" id="uv_channels" value="2" min="1" onchange="calcUVSystem()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>UV System Type</label>
<select id="uv_type" style="font-size:14px" onchange="updateUVDefaults()">
<option value="lp">Low Pressure (LP)</option>
<option value="lpho" selected>Low Pressure High Output (LPHO)</option>
<option value="mp">Medium Pressure (MP)</option>
</select>
</div>
<div class="input-group">
<label>Application</label>
<select id="uv_app" style="font-size:14px" onchange="updateUVDose()">
<option value="secondary">Secondary Effluent</option>
<option value="tertiary" selected>Tertiary/Filtered</option>
<option value="reuse">Reuse/Title 22</option>
<option value="drinking">Drinking Water</option>
</select>
</div>
<div class="input-group">
<label>Redundancy</label>
<select id="uv_redund" style="font-size:14px" onchange="calcUVSystem()">
<option value="n">N (No redundancy)</option>
<option value="n1" selected>N+1 (One standby)</option>
<option value="n2">N+2 (Two standby)</option>
</select>
</div>
</div>
</div>

<!-- Water Quality -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üíß Water Quality Parameters</h4>
<div class="row">
<div class="input-group">
<label>UVT - UV Transmittance (%)</label>
<input type="number" id="uv_uvt" value="65" min="30" max="99" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>TSS (mg/L)</label>
<input type="number" id="uv_tss" value="10" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Iron (mg/L)</label>
<input type="number" id="uv_iron" value="0.1" step="0.1" onchange="calcUVSystem()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Turbidity (NTU)</label>
<input type="number" id="uv_turb" value="2" step="0.5" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Color (CU)</label>
<input type="number" id="uv_color" value="5" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Hardness (mg/L as CaCO3)</label>
<input type="number" id="uv_hard" value="150" onchange="calcUVSystem()">
</div>
</div>
</div>

<!-- Dose Requirements -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">‚ò¢Ô∏è Dose Requirements</h4>
<div class="row">
<div class="input-group">
<label>Target Pathogen</label>
<select id="uv_pathogen" style="font-size:14px" onchange="updateUVDose()">
<option value="ecoli">E. coli</option>
<option value="fecal" selected>Fecal Coliform</option>
<option value="entero">Enterococci</option>
<option value="crypto">Cryptosporidium</option>
<option value="giardia">Giardia</option>
<option value="virus">Virus (Adenovirus)</option>
</select>
</div>
<div class="input-group">
<label>Target Log Reduction</label>
<input type="number" id="uv_log" value="4" step="0.5" min="1" max="6" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Design UV Dose (mJ/cm¬≤)</label>
<input type="number" id="uv_dose" value="40" onchange="calcUVSystem()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>End-of-Lamp Factor</label>
<input type="number" id="uv_elf" value="0.7" step="0.05" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Fouling Factor</label>
<input type="number" id="uv_ff" value="0.8" step="0.05" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Safety Factor</label>
<input type="number" id="uv_sf" value="1.2" step="0.1" onchange="calcUVSystem()">
</div>
</div>
</div>

<!-- Economics -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#a78bfa">üí∞ Operating Costs</h4>
<div class="row">
<div class="input-group">
<label>Electricity Cost ($/kWh)</label>
<input type="number" id="uv_elec" value="0.10" step="0.01" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Lamp Cost ($)</label>
<input type="number" id="uv_lamp_cost" value="150" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Lamp Life (hours)</label>
<input type="number" id="uv_lamp_life" value="12000" onchange="calcUVSystem()">
</div>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcUVSystem()">‚òÄÔ∏è Calculate UV System</button>
<button class="btn blue" onclick="compareUVSystems()">üìä Compare LP vs MP</button>
<button class="btn gray" onclick="resetUVSystem()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="uv_results" style="margin-top:20px"></div>

<!-- Comparison Results -->
<div id="uv_comparison" style="margin-top:15px"></div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#06b6d4">üìö UV Dose Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Pathogen</th><th>Log Reduction</th><th>Dose (mJ/cm¬≤)</th></tr>
</thead>
<tbody>
<tr><td>E. coli</td><td>4-log</td><td>20-25</td></tr>
<tr><td>Fecal Coliform</td><td>4-log</td><td>30-40</td></tr>
<tr><td>Giardia</td><td>3-log</td><td>11</td></tr>
<tr><td>Cryptosporidium</td><td>3-log</td><td>12</td></tr>
<tr><td>Virus (Adeno)</td><td>4-log</td><td>186</td></tr>
<tr style="background:rgba(74,222,128,0.1)"><td>CA Title 22 Reuse</td><td>5-log virus</td><td>100-140</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">UVT Guidelines:</strong>
<div style="font-size:11px;margin-top:5px">
Secondary: 55-65%<br>
Tertiary: 65-75%<br>
Reuse: 70-85%<br>
Drinking: >90%
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">Lamp Types:</strong>
<div style="font-size:11px;margin-top:5px">
LP: 254nm, efficient, longer life<br>
LPHO: Higher output, fewer lamps<br>
MP: Broad spectrum, compact
</div>
</div>
</div>
</div>

</div>
</div>

<!-- Sludge Thickening -->
<div class="section">
<div class="section-h">üîÑ Sludge Thickening</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Feed Flow (GPM)</label><input type="number" id="thick_flow" value="100"></div>
<div class="input-group"><label>Feed Solids (%)</label><input type="number" id="thick_feed" value="0.8" step="0.1"></div>
<div class="input-group"><label>Thickened Solids (%)</label><input type="number" id="thick_out" value="5.0" step="0.1"></div>
<div class="input-group"><label>Capture Rate (%)</label><input type="number" id="thick_capture" value="95"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcThickening()">Calculate</button>
<button class="btn gray" onclick="resetThickening()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Dry Solids In</td><td><span class="result" id="r_thick_in">-</span></td><td>lb/hr</td></tr>
<tr><td class="rowh">Thickened Flow</td><td><span class="result" id="r_thick_flowout">-</span></td><td>GPM</td></tr>
<tr><td class="rowh">Solids Captured</td><td><span class="result" id="r_thick_captured">-</span></td><td>lb/hr</td></tr>
<tr><td class="rowh">Volume Reduction</td><td><span class="result" id="r_thick_reduction">-</span></td><td>%</td></tr>
</tbody></table>
</div>
</div>

<!-- Equalization Basin -->
<div class="section">
<div class="section-h">‚öñÔ∏è Equalization Basin Sizing</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Peak Flow (MGD)</label><input type="number" id="eq_peak" value="8.0" step="0.1"></div>
<div class="input-group"><label>Average Flow (MGD)</label><input type="number" id="eq_avg" value="5.0" step="0.1"></div>
<div class="input-group"><label>Peak Duration (hrs)</label><input type="number" id="eq_duration" value="4"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcEQ()">Calculate</button>
<button class="btn gray" onclick="resetEQ()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Storage Volume</td><td><span class="result" id="r_eq_vol">-</span></td><td>MG</td></tr>
<tr><td class="rowh">Storage Volume</td><td><span class="result" id="r_eq_gal">-</span></td><td>gallons</td></tr>
<tr><td class="rowh">Peak-to-Avg Ratio</td><td><span class="result" id="r_eq_ratio">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- COMPREHENSIVE WET WEATHER CALCULATOR -->
<div class="section" id="wetWeatherCalculator" style="border:2px solid #0ea5e9">
<div class="section-h" style="background:linear-gradient(135deg,#0284c7,#0ea5e9);color:white">
üåßÔ∏è Wet Weather & I/I Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Storm Analysis</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Analyze wet weather impacts, I&I contribution, and treatment capacity during storm events.</p>

<!-- Baseline Conditions -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#0ea5e9">üìä Baseline (Dry Weather) Conditions</h4>
<div class="row">
<div class="input-group">
<label style="color:#0ea5e9">Avg Dry Weather Flow (MGD)</label>
<input type="number" id="ww_dwf" value="5.0" step="0.1" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label style="color:#0ea5e9">Min Daily Flow (MGD)</label>
<input type="number" id="ww_min" value="3.0" step="0.1" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label style="color:#0ea5e9">Max Dry Weather Flow (MGD)</label>
<input type="number" id="ww_max_dry" value="7.0" step="0.1" onchange="calcWetWeather()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Service Area (acres)</label>
<input type="number" id="ww_area" value="5000" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Population Served</label>
<input type="number" id="ww_pop" value="50000" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Sewer Length (miles)</label>
<input type="number" id="ww_sewer_mi" value="100" onchange="calcWetWeather()">
</div>
</div>
</div>

<!-- Storm Event Data -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üåßÔ∏è Storm Event Data</h4>
<div class="row">
<div class="input-group">
<label>Peak Wet Weather Flow (MGD)</label>
<input type="number" id="ww_wwf" value="15.0" step="0.5" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Storm Duration (hours)</label>
<input type="number" id="ww_duration" value="6" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Rainfall Amount (inches)</label>
<input type="number" id="ww_rain" value="1.5" step="0.1" onchange="calcWetWeather()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Storm Recurrence (years)</label>
<select id="ww_recurrence" style="font-size:14px" onchange="calcWetWeather()">
<option value="1">1-year (frequent)</option>
<option value="2" selected>2-year</option>
<option value="5">5-year</option>
<option value="10">10-year</option>
<option value="25">25-year</option>
</select>
</div>
<div class="input-group">
<label>Groundwater Level</label>
<select id="ww_gw" style="font-size:14px" onchange="calcWetWeather()">
<option value="low">Low (deep)</option>
<option value="normal" selected>Normal</option>
<option value="high">High (shallow)</option>
</select>
</div>
<div class="input-group">
<label>Season</label>
<select id="ww_season" style="font-size:14px" onchange="calcWetWeather()">
<option value="dry">Dry Season</option>
<option value="wet" selected>Wet Season</option>
<option value="spring">Spring Thaw</option>
</select>
</div>
</div>
</div>

<!-- Treatment Capacity -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üè≠ Treatment Capacity</h4>
<div class="row">
<div class="input-group">
<label>Design Capacity (MGD)</label>
<input type="number" id="ww_capacity" value="10.0" step="0.5" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Peak Hydraulic Capacity (MGD)</label>
<input type="number" id="ww_peak_cap" value="15.0" step="0.5" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Bypass/SSO Threshold (MGD)</label>
<input type="number" id="ww_bypass" value="18.0" step="0.5" onchange="calcWetWeather()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>EQ/Storage Available (MG)</label>
<input type="number" id="ww_storage" value="2.0" step="0.1" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Avg Influent BOD (mg/L)</label>
<input type="number" id="ww_bod_dry" value="200" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Permit BOD Limit (mg/L)</label>
<input type="number" id="ww_bod_lim" value="30" onchange="calcWetWeather()">
</div>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcWetWeather()">üåßÔ∏è Analyze Storm Event</button>
<button class="btn blue" onclick="calcIandI()">üíß Calculate I&I</button>
<button class="btn orange" onclick="calcStorageNeeded()">üèóÔ∏è Storage Requirements</button>
<button class="btn gray" onclick="resetWetWeather()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="ww_results" style="margin-top:20px"></div>

<!-- I&I Results -->
<div id="ww_ii_results" style="margin-top:15px"></div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#0ea5e9">üìö Wet Weather Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Parameter</th><th>Typical Range</th><th>Concern Level</th></tr>
</thead>
<tbody>
<tr><td>Peak/Avg Flow Ratio</td><td>2.0-3.0</td><td>&gt;4.0 = High I&I</td></tr>
<tr><td>I&I Rate (gpd/mi)</td><td>2,000-5,000</td><td>&gt;10,000 = Excessive</td></tr>
<tr><td>I&I Rate (gpd/capita)</td><td>20-50</td><td>&gt;100 = Excessive</td></tr>
<tr><td>RDII (gal/in/acre)</td><td>500-2,000</td><td>&gt;5,000 = High</td></tr>
<tr><td>Peaking Factor</td><td>2.5-3.5</td><td>&gt;5.0 = I&I issues</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#ef4444">I&I Sources:</strong>
<div style="font-size:11px;margin-top:5px">
<strong>Inflow:</strong> Direct connections<br>
- Roof drains, sump pumps<br>
- Cross-connections<br>
<strong>Infiltration:</strong> Groundwater<br>
- Cracked pipes, joints<br>
- Manholes, laterals
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#4ade80">Treatment Impacts:</strong>
<div style="font-size:11px;margin-top:5px">
- Diluted influent (low BOD)<br>
- Hydraulic overload<br>
- Solids washout risk<br>
- Reduced SRT<br>
- Nitrification loss<br>
- SSO/bypass risk
</div>
</div>
</div>
</div>

</div>
</div>

<!-- Chemical Feed Rate -->
<div class="section">
<div class="section-h">üß™ Chemical Feed Rate</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="chem_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Target Dose (mg/L)</label><input type="number" id="chem_dose" value="50"></div>
<div class="input-group"><label>Solution Strength (%)</label><input type="number" id="chem_strength" value="50"></div>
<div class="input-group"><label>Specific Gravity</label><input type="number" id="chem_sg" value="1.2" step="0.01"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcChemFeed()">Calculate</button>
<button class="btn gray" onclick="resetChemFeed()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Chemical (dry)</td><td><span class="result" id="r_chem_dry">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Volume</td><td><span class="result" id="r_chem_gal">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Feed Rate</td><td><span class="result" id="r_chem_gph">-</span></td><td>gal/hr</td></tr>
<tr><td class="rowh">Feed Rate</td><td><span class="result" id="r_chem_mlmin">-</span></td><td>mL/min</td></tr>
</tbody></table>
</div>
</div>

<!-- Screenings & Grit Quantity -->
<div class="section">
<div class="section-h">üóëÔ∏è Screenings & Grit Estimation</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Average Flow (MGD)</label><input type="number" id="screen_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Screen Opening (in)</label><input type="number" id="screen_opening" value="0.25" step="0.05"></div>
<div class="input-group"><label>Population Served</label><input type="number" id="screen_pop" value="50000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcScreenings()">Calculate</button>
<button class="btn gray" onclick="resetScreenings()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Screenings</td><td><span class="result" id="r_screen_vol">-</span></td><td>cu ft/day</td></tr>
<tr><td class="rowh">Screenings</td><td><span class="result" id="r_screen_cy">-</span></td><td>cu yd/month</td></tr>
<tr><td class="rowh">Grit Volume</td><td><span class="result" id="r_grit_vol2">-</span></td><td>cu ft/day</td></tr>
<tr><td class="rowh">Grit</td><td><span class="result" id="r_grit_cy">-</span></td><td>cu yd/month</td></tr>
</tbody></table>
</div>
</div>

<!-- Primary Clarifier Efficiency -->
<div class="section">
<div class="section-h">üèóÔ∏è Primary Clarifier Performance</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="prim_bod_in" value="250"></div>
<div class="input-group"><label>Influent TSS (mg/L)</label><input type="number" id="prim_tss_in" value="300"></div>
<div class="input-group"><label>Surface Overflow Rate (gpd/sf)</label><input type="number" id="prim_sor" value="800"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPrimary()">Calculate</button>
<button class="btn gray" onclick="resetPrimary()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Est. BOD Removal</td><td><span class="result" id="r_prim_bod_rem">-</span></td><td>%</td></tr>
<tr><td class="rowh">Est. TSS Removal</td><td><span class="result" id="r_prim_tss_rem">-</span></td><td>%</td></tr>
<tr><td class="rowh">Effluent BOD</td><td><span class="result" id="r_prim_bod_out">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Effluent TSS</td><td><span class="result" id="r_prim_tss_out">-</span></td><td>mg/L</td></tr>
</tbody></table>
</div>
</div>

<!-- Trickling Filter Loading -->
<div class="section">
<div class="section-h">üîÑ Trickling Filter Loading</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="tf_flow" value="2.0" step="0.1"></div>
<div class="input-group"><label>BOD (mg/L)</label><input type="number" id="tf_bod" value="150"></div>
<div class="input-group"><label>Media Volume (cu ft)</label><input type="number" id="tf_vol" value="50000"></div>
<div class="input-group"><label>Recirculation Ratio</label><input type="number" id="tf_recirc" value="1.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcTF()">Calculate</button>
<button class="btn gray" onclick="resetTF()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Organic Loading</td><td><span class="result" id="r_tf_olr">-</span></td><td>lb BOD/1000 cf/day</td></tr>
<tr><td class="rowh">Hydraulic Loading</td><td><span class="result" id="r_tf_hlr">-</span></td><td>gpd/sq ft</td></tr>
<tr><td class="rowh">Est. BOD Removal</td><td><span class="result" id="r_tf_removal">-</span></td><td>%</td></tr>
</tbody></table>
</div>
</div>

<!-- Biosolids Land Application -->
<div class="section">
<div class="section-h">üå± Biosolids Land Application</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Dry Tons/Year</label><input type="number" id="bio_tons" value="500"></div>
<div class="input-group"><label>% Nitrogen</label><input type="number" id="bio_n" value="4" step="0.1"></div>
<div class="input-group"><label>N Application Rate (lb/ac/yr)</label><input type="number" id="bio_rate" value="150"></div>
<div class="input-group"><label>% Available N</label><input type="number" id="bio_avail" value="40"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcBiosolids()">Calculate</button>
<button class="btn gray" onclick="resetBiosolids()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Total N</td><td><span class="result" id="r_bio_total_n">-</span></td><td>lb/yr</td></tr>
<tr><td class="rowh">Available N</td><td><span class="result" id="r_bio_avail_n">-</span></td><td>lb/yr</td></tr>
<tr><td class="rowh">Land Required</td><td><span class="result" id="r_bio_acres">-</span></td><td>acres</td></tr>
<tr><td class="rowh">Application Rate</td><td><span class="result" id="r_bio_tons_ac">-</span></td><td>dry tons/acre</td></tr>
</tbody></table>
</div>
</div>

<!-- Hydraulic Profile Calculator -->
<div class="section">
<div class="section-h">üìê Hydraulic Profile Calculator</div>
<div class="section-content">
<div class="note info">Calculate water surface elevations (WSE) through treatment units. Enter starting elevation and head losses to generate the hydraulic grade line.</div>

<div style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="color:#4ade80;margin:0 0 15px 0">üìç Starting Conditions</h4>
<div class="row">
<div class="input-group"><label>Design Flow (MGD)</label><input type="number" id="hydr_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Peak Flow Factor</label><input type="number" id="hydr_peak" value="2.5" step="0.1"></div>
<div class="input-group"><label>Outfall WSE (ft)</label><input type="number" id="hydr_outfall" value="100.00" step="0.01"></div>
</div>
</div>

<div style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="color:#60a5fa;margin:0 0 15px 0">üè≠ Unit Process Head Losses (ft)</h4>
<p style="color:#94a3b8;font-size:13px;margin-bottom:15px">Enter head loss across each unit at peak flow. Use 0 for units not present.</p>

<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:15px">

<div style="background:#374151;padding:15px;border-radius:8px">
<h5 style="color:#fbbf24;margin:0 0 10px 0">Preliminary Treatment</h5>
<div class="input-group"><label>Bar Screen</label><input type="number" id="hl_barscreen" value="0.50" step="0.01"></div>
<div class="input-group"><label>Grit Chamber</label><input type="number" id="hl_grit" value="0.25" step="0.01"></div>
<div class="input-group"><label>Flow Measurement</label><input type="number" id="hl_parshall" value="0.30" step="0.01"></div>
</div>

<div style="background:#374151;padding:15px;border-radius:8px">
<h5 style="color:#fbbf24;margin:0 0 10px 0">Primary Treatment</h5>
<div class="input-group"><label>Primary Clarifier Inlet</label><input type="number" id="hl_prim_in" value="0.20" step="0.01"></div>
<div class="input-group"><label>Primary Clarifier</label><input type="number" id="hl_prim" value="0.50" step="0.01"></div>
<div class="input-group"><label>Primary Effluent Weir</label><input type="number" id="hl_prim_weir" value="0.15" step="0.01"></div>
</div>

<div style="background:#374151;padding:15px;border-radius:8px">
<h5 style="color:#fbbf24;margin:0 0 10px 0">Secondary Treatment</h5>
<div class="input-group"><label>Aeration Basin Inlet</label><input type="number" id="hl_aer_in" value="0.25" step="0.01"></div>
<div class="input-group"><label>Aeration Basin</label><input type="number" id="hl_aeration" value="0.50" step="0.01"></div>
<div class="input-group"><label>Secondary Clarifier Inlet</label><input type="number" id="hl_sec_in" value="0.30" step="0.01"></div>
<div class="input-group"><label>Secondary Clarifier</label><input type="number" id="hl_secondary" value="0.50" step="0.01"></div>
<div class="input-group"><label>Secondary Effluent Weir</label><input type="number" id="hl_sec_weir" value="0.20" step="0.01"></div>
</div>

<div style="background:#374151;padding:15px;border-radius:8px">
<h5 style="color:#fbbf24;margin:0 0 10px 0">Tertiary/Effluent</h5>
<div class="input-group"><label>Filters</label><input type="number" id="hl_filters" value="0.00" step="0.01"></div>
<div class="input-group"><label>UV/Disinfection</label><input type="number" id="hl_disinfect" value="0.25" step="0.01"></div>
<div class="input-group"><label>Effluent Piping</label><input type="number" id="hl_eff_pipe" value="0.50" step="0.01"></div>
<div class="input-group"><label>Cascade Aerator</label><input type="number" id="hl_cascade" value="0.00" step="0.01"></div>
</div>

</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcHydraulicProfile()">üìê Calculate Profile</button>
<button class="btn blue" onclick="exportHydraulicProfile()">üì§ Export CSV</button>
<button class="btn gray" onclick="resetHydraulicProfile()">Reset</button>
</div>

<div id="hydraulic_results" style="margin-top:20px"></div>

<div id="hydraulic_chart_container" style="display:none;margin-top:20px">
<h4 style="color:#4ade80;margin-bottom:15px">üìä Hydraulic Profile Chart</h4>
<div style="background:#1a2744;padding:20px;border-radius:12px">
<canvas id="hydraulicChart" height="250"></canvas>
</div>
</div>

</div>
</div>

<!-- Pipe Headloss Calculator (Hazen-Williams) -->
<div class="section">
<div class="section-h">üîß Pipe Headloss (Hazen-Williams)</div>
<div class="section-content">
<div class="note info">Calculate friction headloss in pipes using Hazen-Williams equation</div>
<div class="row">
<div class="input-group"><label>Flow Rate (GPM)</label><input type="number" id="pipe_flow" value="1000"></div>
<div class="input-group"><label>Pipe Diameter (in)</label><input type="number" id="pipe_dia" value="8"></div>
<div class="input-group"><label>Pipe Length (ft)</label><input type="number" id="pipe_length" value="500"></div>
</div>
<div class="row">
<div class="input-group"><label>C-Factor</label>
<select id="pipe_c">
<option value="150">PVC/HDPE (150)</option>
<option value="140">New Ductile Iron (140)</option>
<option value="130" selected>Concrete (130)</option>
<option value="120">Aged Ductile Iron (120)</option>
<option value="100">Old Cast Iron (100)</option>
</select></div>
<div class="input-group"><label>Fittings K-value</label><input type="number" id="pipe_k" value="2.5" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPipeHeadloss()">Calculate</button>
<button class="btn gray" onclick="resetPipeHeadloss()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Velocity</td><td><span class="result" id="r_pipe_vel">-</span></td><td>ft/s</td></tr>
<tr><td class="rowh">Friction Loss</td><td><span class="result" id="r_pipe_friction">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Fitting Losses</td><td><span class="result" id="r_pipe_fittings">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Total Head Loss</td><td><span class="result" id="r_pipe_total">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Head Loss per 100 ft</td><td><span class="result" id="r_pipe_per100">-</span></td><td>ft/100 ft</td></tr>
</tbody></table>
</div>
</div>

<!-- Weir & Orifice Calculator -->
<div class="section">
<div class="section-h">üåä Weir & Orifice Head Loss</div>
<div class="section-content">
<div class="note info">Calculate head over weirs and through orifices</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">

<div style="background:#1a2744;padding:15px;border-radius:8px">
<h5 style="color:#4ade80;margin:0 0 10px 0">Rectangular Weir</h5>
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="weir_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Weir Length (ft)</label><input type="number" id="weir_length" value="20"></div>
<div class="input-group"><label>Weir Coefficient</label><input type="number" id="weir_coef" value="3.33" step="0.01"></div>
<button class="btn green" onclick="calcWeir()" style="margin-top:10px">Calculate</button>
<div style="margin-top:10px">
<span style="color:#94a3b8">Head over Weir: </span><strong id="r_weir_head" style="color:#4ade80">-</strong> ft
</div>
</div>

<div style="background:#1a2744;padding:15px;border-radius:8px">
<h5 style="color:#60a5fa;margin:0 0 10px 0">Circular Orifice</h5>
<div class="input-group"><label>Flow (GPM)</label><input type="number" id="orif_flow" value="500"></div>
<div class="input-group"><label>Orifice Diameter (in)</label><input type="number" id="orif_dia" value="6"></div>
<div class="input-group"><label>Discharge Coefficient</label><input type="number" id="orif_cd" value="0.62" step="0.01"></div>
<button class="btn blue" onclick="calcOrifice()" style="margin-top:10px">Calculate</button>
<div style="margin-top:10px">
<span style="color:#94a3b8">Head Required: </span><strong id="r_orif_head" style="color:#60a5fa">-</strong> ft
</div>
</div>

</div>
</div>
</div>

<!-- Channel Flow Calculator -->
<div class="section">
<div class="section-h">„Ä∞Ô∏è Open Channel Flow (Manning's)</div>
<div class="section-content">
<div class="note info">Calculate flow depth and velocity in open channels using Manning's equation</div>
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="chan_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Channel Width (ft)</label><input type="number" id="chan_width" value="4"></div>
<div class="input-group"><label>Channel Slope (ft/ft)</label><input type="number" id="chan_slope" value="0.001" step="0.0001"></div>
</div>
<div class="row">
<div class="input-group"><label>Manning's n</label>
<select id="chan_n">
<option value="0.013">Concrete (0.013)</option>
<option value="0.015" selected>Concrete w/ gravel (0.015)</option>
<option value="0.022">Corrugated Metal (0.022)</option>
<option value="0.030">Earth Channel (0.030)</option>
</select></div>
<div class="input-group"><label>Side Slope (H:V, 0=vertical)</label><input type="number" id="chan_ss" value="0" step="0.5"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcChannelFlow()">Calculate</button>
<button class="btn gray" onclick="resetChannelFlow()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Normal Depth</td><td><span class="result" id="r_chan_depth">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Flow Area</td><td><span class="result" id="r_chan_area">-</span></td><td>sq ft</td></tr>
<tr><td class="rowh">Wetted Perimeter</td><td><span class="result" id="r_chan_wp">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Hydraulic Radius</td><td><span class="result" id="r_chan_rh">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Velocity</td><td><span class="result" id="r_chan_vel">-</span></td><td>ft/s</td></tr>
<tr><td class="rowh">Froude Number</td><td><span class="result" id="r_chan_froude">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Chemical Feed Rate Optimizer -->
<div class="section">
<div class="section-h">‚öóÔ∏è Chemical Feed Rate Optimizer</div>
<div class="section-content">
<div class="note info">Optimize chemical dosing based on target removal and real-time conditions</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#4ade80;margin:0 0 15px 0">üìä Current Conditions</h4>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="cfo_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Influent Phosphorus (mg/L)</label><input type="number" id="cfo_p_in" value="6.0" step="0.1"></div>
<div class="input-group"><label>Target Effluent P (mg/L)</label><input type="number" id="cfo_p_target" value="1.0" step="0.1"></div>
<div class="input-group"><label>Current pH</label><input type="number" id="cfo_ph" value="7.2" step="0.1"></div>
<div class="input-group"><label>Alkalinity (mg/L as CaCO3)</label><input type="number" id="cfo_alk" value="200"></div>
</div>

<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#60a5fa;margin:0 0 15px 0">üíä Chemical Selection</h4>
<div class="input-group"><label>Primary Chemical</label>
<select id="cfo_chem1">
<option value="alum">Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ)</option>
<option value="ferric">Ferric Chloride (FeCl‚ÇÉ)</option>
<option value="ferrous">Ferrous Sulfate (FeSO‚ÇÑ)</option>
<option value="pac">PAC (Poly Aluminum Chloride)</option>
</select></div>
<div class="input-group"><label>Solution Strength (%)</label><input type="number" id="cfo_strength" value="48"></div>
<div class="input-group"><label>Specific Gravity</label><input type="number" id="cfo_sg" value="1.33" step="0.01"></div>
<div class="input-group"><label>Chemical Cost ($/lb)</label><input type="number" id="cfo_cost" value="0.15" step="0.01"></div>
<div class="input-group"><label>Molar Ratio Target (Me:P)</label><input type="number" id="cfo_ratio" value="2.0" step="0.1"></div>
</div>
</div>

<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="optimizeChemFeed()">üéØ Optimize Feed Rate</button>
<button class="btn blue" onclick="calcChemCost()">üí∞ Calculate Costs</button>
<button class="btn gray" onclick="resetChemOptimizer()">Reset</button>
</div>

<div id="cfo_results" style="margin-top:20px"></div>
</div>
</div>

<!-- Equalization Basin Sizing -->
<div class="section">
<div class="section-h">üåä Equalization Basin Sizing</div>
<div class="section-content">
<div class="note info">Size EQ basins for flow and load equalization based on diurnal patterns</div>

<div class="row">
<div class="input-group"><label>Average Daily Flow (MGD)</label><input type="number" id="eq_avg_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Peak Hour Flow (MGD)</label><input type="number" id="eq_peak_flow" value="8.0" step="0.1"></div>
<div class="input-group"><label>Minimum Hour Flow (MGD)</label><input type="number" id="eq_min_flow" value="2.5" step="0.1"></div>
<div class="input-group"><label>Target Equalized Flow (MGD)</label><input type="number" id="eq_target" value="5.5" step="0.1"></div>
</div>

<div class="row">
<div class="input-group"><label>Operating Depth (ft)</label><input type="number" id="eq_depth" value="12"></div>
<div class="input-group"><label>Freeboard (ft)</label><input type="number" id="eq_freeboard" value="2"></div>
<div class="input-group"><label>Safety Factor</label><input type="number" id="eq_sf" value="1.25" step="0.05"></div>
</div>

<div style="background:#1a2744;padding:15px;border-radius:8px;margin:15px 0">
<h5 style="color:#fbbf24;margin:0 0 10px 0">üìà Hourly Flow Pattern (24-hr)</h5>
<p style="color:#94a3b8;font-size:13px;margin-bottom:10px">Enter flows as % of average (default pattern loaded)</p>
<div style="display:grid;grid-template-columns:repeat(12, 1fr);gap:5px;font-size:12px">
<div><label>12AM</label><input type="number" id="eq_h0" value="50" style="width:100%"></div>
<div><label>2AM</label><input type="number" id="eq_h2" value="40" style="width:100%"></div>
<div><label>4AM</label><input type="number" id="eq_h4" value="45" style="width:100%"></div>
<div><label>6AM</label><input type="number" id="eq_h6" value="80" style="width:100%"></div>
<div><label>8AM</label><input type="number" id="eq_h8" value="130" style="width:100%"></div>
<div><label>10AM</label><input type="number" id="eq_h10" value="120" style="width:100%"></div>
<div><label>12PM</label><input type="number" id="eq_h12" value="115" style="width:100%"></div>
<div><label>2PM</label><input type="number" id="eq_h14" value="110" style="width:100%"></div>
<div><label>4PM</label><input type="number" id="eq_h16" value="105" style="width:100%"></div>
<div><label>6PM</label><input type="number" id="eq_h18" value="125" style="width:100%"></div>
<div><label>8PM</label><input type="number" id="eq_h20" value="110" style="width:100%"></div>
<div><label>10PM</label><input type="number" id="eq_h22" value="70" style="width:100%"></div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcEQBasin()">üìê Size Basin</button>
<button class="btn orange" onclick="loadTypicalPattern()">üìä Load Typical Pattern</button>
<button class="btn gray" onclick="resetEQBasin()">Reset</button>
</div>

<div id="eq_results" style="margin-top:20px"></div>
</div>
</div>

<!-- Violation Risk Predictor -->
<div class="section">
<div class="section-h">‚ö†Ô∏è Violation Risk Predictor</div>
<div class="section-content">
<div class="note info">Predict probability of permit violations based on current performance and variability</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#ef4444;margin:0 0 15px 0">üìã Permit Limits</h4>
<div class="input-group"><label>BOD Daily Max (mg/L)</label><input type="number" id="vr_bod_limit" value="45"></div>
<div class="input-group"><label>BOD Monthly Avg (mg/L)</label><input type="number" id="vr_bod_monthly" value="30"></div>
<div class="input-group"><label>TSS Daily Max (mg/L)</label><input type="number" id="vr_tss_limit" value="45"></div>
<div class="input-group"><label>TSS Monthly Avg (mg/L)</label><input type="number" id="vr_tss_monthly" value="30"></div>
<div class="input-group"><label>NH3-N Daily Max (mg/L)</label><input type="number" id="vr_nh3_limit" value="4.0" step="0.1"></div>
</div>

<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#4ade80;margin:0 0 15px 0">üìä Current Performance (30-day)</h4>
<div class="input-group"><label>BOD Average (mg/L)</label><input type="number" id="vr_bod_avg" value="18"></div>
<div class="input-group"><label>BOD Std Deviation</label><input type="number" id="vr_bod_std" value="5"></div>
<div class="input-group"><label>TSS Average (mg/L)</label><input type="number" id="vr_tss_avg" value="15"></div>
<div class="input-group"><label>TSS Std Deviation</label><input type="number" id="vr_tss_std" value="4"></div>
<div class="input-group"><label>NH3-N Average (mg/L)</label><input type="number" id="vr_nh3_avg" value="1.5" step="0.1"></div>
<div class="input-group"><label>NH3-N Std Deviation</label><input type="number" id="vr_nh3_std" value="0.8" step="0.1"></div>
</div>
</div>

<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="predictViolationRisk()">üé≤ Calculate Risk</button>
<button class="btn purple" onclick="showRiskTrend()">üìà Show Trend</button>
<button class="btn gray" onclick="resetViolationRisk()">Reset</button>
</div>

<div id="vr_results" style="margin-top:20px"></div>
</div>
</div>

<!-- Mass Balance Calculator -->
<div class="section" id="massBalanceSection">
<div class="section-h">‚öñÔ∏è Mass Balance Calculator</div>
<div class="section-content">
<div class="note info">Calculate mass balances for BOD, TSS, nitrogen, and phosphorus through the treatment process</div>

<div style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="color:#4ade80;margin:0 0 15px 0">üì• Influent Conditions</h4>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mb_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>BOD (mg/L)</label><input type="number" id="mb_bod_in" value="200"></div>
<div class="input-group"><label>TSS (mg/L)</label><input type="number" id="mb_tss_in" value="220"></div>
<div class="input-group"><label>TKN (mg/L)</label><input type="number" id="mb_tkn_in" value="40"></div>
<div class="input-group"><label>Total P (mg/L)</label><input type="number" id="mb_tp_in" value="7"></div>
</div>
</div>

<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;margin-bottom:20px">
<div style="background:#1a2744;padding:15px;border-radius:8px">
<h5 style="color:#fbbf24;margin:0 0 10px 0">Primary Treatment</h5>
<div class="input-group"><label>BOD Removal (%)</label><input type="number" id="mb_prim_bod" value="30"></div>
<div class="input-group"><label>TSS Removal (%)</label><input type="number" id="mb_prim_tss" value="60"></div>
</div>
<div style="background:#1a2744;padding:15px;border-radius:8px">
<h5 style="color:#60a5fa;margin:0 0 10px 0">Secondary Treatment</h5>
<div class="input-group"><label>BOD Removal (%)</label><input type="number" id="mb_sec_bod" value="90"></div>
<div class="input-group"><label>TSS Removal (%)</label><input type="number" id="mb_sec_tss" value="85"></div>
<div class="input-group"><label>TKN Removal (%)</label><input type="number" id="mb_sec_tkn" value="80"></div>
</div>
<div style="background:#1a2744;padding:15px;border-radius:8px">
<h5 style="color:#a78bfa;margin:0 0 10px 0">Tertiary/Chemical</h5>
<div class="input-group"><label>P Removal (%)</label><input type="number" id="mb_tert_tp" value="85"></div>
<div class="input-group"><label>Additional TSS (%)</label><input type="number" id="mb_tert_tss" value="50"></div>
</div>
</div>

<div class="row">
<div class="input-group"><label>Sludge Yield (lb VSS/lb BOD)</label><input type="number" id="mb_yield" value="0.6" step="0.05"></div>
<div class="input-group"><label>VSS/TSS Ratio</label><input type="number" id="mb_vss_tss" value="0.75" step="0.05"></div>
<div class="input-group"><label>Primary Sludge (% solids)</label><input type="number" id="mb_prim_pct" value="4"></div>
<div class="input-group"><label>WAS (% solids)</label><input type="number" id="mb_was_pct" value="0.8" step="0.1"></div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcMassBalance()">‚öñÔ∏è Calculate Mass Balance</button>
<button class="btn blue" onclick="showMassBalanceDiagram()">üìä Show Diagram</button>
<button class="btn gray" onclick="resetMassBalance()">Reset</button>
</div>

<div id="mb_results" style="margin-top:20px"></div>
</div>
</div>

<!-- Oxygen Transfer Efficiency Calculator -->
<div class="section" id="oteCalcSection">
<div class="section-h">üí® Oxygen Transfer Efficiency (OTE) Calculator</div>
<div class="section-content">
<div class="note info">Calculate actual oxygen transfer rate (AOTR) from standard conditions and evaluate aeration efficiency</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#4ade80;margin:0 0 15px 0">üîß System Parameters</h4>
<div class="input-group"><label>Diffuser Type</label>
<select id="ote_diffuser">
<option value="fine">Fine Bubble (SOTE 25-35%)</option>
<option value="coarse">Coarse Bubble (SOTE 10-15%)</option>
<option value="membrane">Membrane (SOTE 30-40%)</option>
<option value="jet">Jet Aerator (SOTE 20-30%)</option>
</select></div>
<div class="input-group"><label>SOTE @ SWD (%)</label><input type="number" id="ote_sote" value="28"></div>
<div class="input-group"><label>Submergence Depth (ft)</label><input type="number" id="ote_depth" value="15"></div>
<div class="input-group"><label>Airflow Rate (SCFM)</label><input type="number" id="ote_airflow" value="3000"></div>
<div class="input-group"><label>Number of Diffusers</label><input type="number" id="ote_num_diff" value="500"></div>
</div>

<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#60a5fa;margin:0 0 15px 0">üå°Ô∏è Process Conditions</h4>
<div class="input-group"><label>Water Temperature (¬∞C)</label><input type="number" id="ote_temp" value="20"></div>
<div class="input-group"><label>Operating DO (mg/L)</label><input type="number" id="ote_do" value="2.0" step="0.1"></div>
<div class="input-group"><label>Altitude (ft)</label><input type="number" id="ote_altitude" value="500"></div>
<div class="input-group"><label>Alpha Factor (Œ±)</label><input type="number" id="ote_alpha" value="0.5" step="0.05"></div>
<div class="input-group"><label>Beta Factor (Œ≤)</label><input type="number" id="ote_beta" value="0.95" step="0.01"></div>
<div class="input-group"><label>Fouling Factor (F)</label><input type="number" id="ote_fouling" value="0.9" step="0.05"></div>
</div>
</div>

<div class="row" style="margin-top:15px">
<div class="input-group"><label>Oxygen Required (lb O‚ÇÇ/day)</label><input type="number" id="ote_o2_req" value="5000"></div>
<div class="input-group"><label>Blower Efficiency (%)</label><input type="number" id="ote_blower_eff" value="70"></div>
<div class="input-group"><label>Motor Efficiency (%)</label><input type="number" id="ote_motor_eff" value="95"></div>
<div class="input-group"><label>Electricity Cost ($/kWh)</label><input type="number" id="ote_elec_cost" value="0.10" step="0.01"></div>
</div>

<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="calcOTE()">üí® Calculate OTE</button>
<button class="btn orange" onclick="compareAerators()">üìä Compare Systems</button>
<button class="btn gray" onclick="resetOTE()">Reset</button>
</div>

<div id="ote_results" style="margin-top:20px"></div>
</div>
</div>

<!-- PUMP STATION CALCULATOR -->
<div class="section" id="pumpStationCalculator" style="border:2px solid #14b8a6">
<div class="section-h" style="background:linear-gradient(135deg,#0d9488,#14b8a6);color:white">
üîÑ Pump Station Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Lift Station</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Design and analyze pump stations: wet well sizing, pump selection, cycle times, and energy costs.</p>

<!-- Design Flows -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#14b8a6">üìä Design Flows</h4>
<div class="row">
<div class="input-group">
<label style="color:#14b8a6">Average Daily Flow (MGD)</label>
<input type="number" id="ps_avg_flow" value="1.0" step="0.1" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label style="color:#14b8a6">Peak Hour Flow (MGD)</label>
<input type="number" id="ps_peak_flow" value="2.5" step="0.1" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label style="color:#14b8a6">Peaking Factor</label>
<input type="number" id="ps_pf" value="2.5" step="0.1" onchange="calcPumpStation()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Min Flow (MGD)</label>
<input type="number" id="ps_min_flow" value="0.3" step="0.1" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Design Life (years)</label>
<input type="number" id="ps_life" value="20" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Growth Factor (%/yr)</label>
<input type="number" id="ps_growth" value="2" step="0.5" onchange="calcPumpStation()">
</div>
</div>
</div>

<!-- Wet Well Design -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">ü™£ Wet Well Design</h4>
<div class="row">
<div class="input-group">
<label>Wet Well Shape</label>
<select id="ps_shape" style="font-size:14px" onchange="calcPumpStation()">
<option value="circular" selected>Circular</option>
<option value="rectangular">Rectangular</option>
</select>
</div>
<div class="input-group">
<label>Diameter / Length (ft)</label>
<input type="number" id="ps_dim1" value="10" step="0.5" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Width (ft) - Rect only</label>
<input type="number" id="ps_dim2" value="8" step="0.5" onchange="calcPumpStation()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Lead Pump On (ft from bottom)</label>
<input type="number" id="ps_lead_on" value="6" step="0.5" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Lead Pump Off (ft)</label>
<input type="number" id="ps_lead_off" value="3" step="0.5" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Lag Pump On (ft)</label>
<input type="number" id="ps_lag_on" value="8" step="0.5" onchange="calcPumpStation()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>High Level Alarm (ft)</label>
<input type="number" id="ps_hla" value="10" step="0.5" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Min Submergence (ft)</label>
<input type="number" id="ps_subm" value="2" step="0.5" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Freeboard (ft)</label>
<input type="number" id="ps_freeboard" value="2" step="0.5" onchange="calcPumpStation()">
</div>
</div>
</div>

<!-- Pump Configuration -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">‚öôÔ∏è Pump Configuration</h4>
<div class="row">
<div class="input-group">
<label>Number of Pumps</label>
<select id="ps_num_pumps" style="font-size:14px" onchange="calcPumpStation()">
<option value="2" selected>2 (1 duty + 1 standby)</option>
<option value="3">3 (2 duty + 1 standby)</option>
<option value="4">4 (3 duty + 1 standby)</option>
</select>
</div>
<div class="input-group">
<label>Pump Capacity Each (GPM)</label>
<input type="number" id="ps_pump_gpm" value="700" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Pump Type</label>
<select id="ps_pump_type" style="font-size:14px">
<option value="submersible" selected>Submersible</option>
<option value="drypit">Dry Pit</option>
<option value="vertical">Vertical Turbine</option>
</select>
</div>
</div>
<div class="row">
<div class="input-group">
<label>Total Dynamic Head (ft)</label>
<input type="number" id="ps_tdh" value="45" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Pump Efficiency (%)</label>
<input type="number" id="ps_eff" value="70" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Motor Efficiency (%)</label>
<input type="number" id="ps_motor_eff" value="92" onchange="calcPumpStation()">
</div>
</div>
</div>

<!-- Energy & Costs -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üí∞ Energy & Costs</h4>
<div class="row">
<div class="input-group">
<label>Electricity Cost ($/kWh)</label>
<input type="number" id="ps_elec" value="0.10" step="0.01" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Demand Charge ($/kW)</label>
<input type="number" id="ps_demand" value="12" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>VFD Installed?</label>
<select id="ps_vfd" style="font-size:14px" onchange="calcPumpStation()">
<option value="no">No - Constant Speed</option>
<option value="yes" selected>Yes - Variable Speed</option>
</select>
</div>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcPumpStation()">üîÑ Calculate Pump Station</button>
<button class="btn blue" onclick="calcCycleTime()">‚è±Ô∏è Cycle Time Analysis</button>
<button class="btn orange" onclick="calcVFDSavings()">üí° VFD Savings</button>
<button class="btn gray" onclick="resetPumpStation()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="ps_results" style="margin-top:20px"></div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#14b8a6">üìö Pump Station Design Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Parameter</th><th>Typical Range</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>Min Cycle Time</td><td>5-10 min</td><td>Prevents motor overheating</td></tr>
<tr><td>Max Starts/Hour</td><td>6-12</td><td>Check motor rating</td></tr>
<tr><td>Detention Time</td><td>&lt;30 min</td><td>Prevents septicity</td></tr>
<tr><td>Min Velocity</td><td>2-3 fps</td><td>Prevents settling</td></tr>
<tr><td>VFD Savings</td><td>20-50%</td><td>Affinity laws (cube of speed)</td></tr>
</tbody>
</table>
</div>

</div>
</div>

<!-- MEMBRANE CALCULATOR (MBR/RO/UF) -->
<div class="section" id="membraneCalculator" style="border:2px solid #8b5cf6">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);color:white">
üî¨ Membrane Calculator (MBR/RO/UF)
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Filtration</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Design and analyze membrane systems: MBR, UF, MF, RO, and NF applications.</p>

<!-- System Configuration -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#8b5cf6">‚öôÔ∏è System Configuration</h4>
<div class="row">
<div class="input-group">
<label style="color:#8b5cf6">Membrane Type</label>
<select id="mem_type" style="font-size:14px" onchange="updateMembraneDefaults()">
<option value="mbr" selected>MBR (Membrane Bioreactor)</option>
<option value="uf">UF (Ultrafiltration)</option>
<option value="mf">MF (Microfiltration)</option>
<option value="ro">RO (Reverse Osmosis)</option>
<option value="nf">NF (Nanofiltration)</option>
</select>
</div>
<div class="input-group">
<label style="color:#8b5cf6">Design Flow (MGD)</label>
<input type="number" id="mem_design_flow" value="1.0" step="0.1" onchange="calcMembrane()">
</div>
<div class="input-group">
<label style="color:#8b5cf6">Peak Factor</label>
<input type="number" id="mem_peak" value="1.5" step="0.1" onchange="calcMembrane()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Recovery (%)</label>
<input type="number" id="mem_recovery" value="85" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>Number of Trains</label>
<input type="number" id="mem_trains" value="2" min="1" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>Temperature (¬∞C)</label>
<input type="number" id="mem_temp" value="20" onchange="calcMembrane()">
</div>
</div>
</div>

<!-- Operating Parameters -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üìà Operating Parameters</h4>
<div class="row">
<div class="input-group">
<label>Design Flux (GFD)</label>
<input type="number" id="mem_flux" value="15" step="1" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>TMP (psi)</label>
<input type="number" id="mem_tmp" value="3" step="0.5" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>Clean Permeability (GFD/psi)</label>
<input type="number" id="mem_perm" value="150" onchange="calcMembrane()">
</div>
</div>
</div>

<!-- Module Specifications -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">üîß Module Specifications</h4>
<div class="row">
<div class="input-group">
<label>Module Area (sq ft)</label>
<input type="number" id="mem_mod_area" value="400" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>Modules per Cassette</label>
<input type="number" id="mem_mods_cass" value="8" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>Module Cost ($)</label>
<input type="number" id="mem_mod_cost" value="3000" onchange="calcMembrane()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Module Life (years)</label>
<input type="number" id="mem_mod_life" value="7" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>CIP Interval (days)</label>
<input type="number" id="mem_cip_interval" value="90" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>CIP Duration (hours)</label>
<input type="number" id="mem_cip_duration" value="4" onchange="calcMembrane()">
</div>
</div>
</div>

<!-- Costs -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üí∞ Operating Costs</h4>
<div class="row">
<div class="input-group">
<label>Electricity ($/kWh)</label>
<input type="number" id="mem_elec" value="0.10" step="0.01" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>CIP Chemical Cost ($/clean)</label>
<input type="number" id="mem_cip_cost" value="500" onchange="calcMembrane()">
</div>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcMembrane()">üî¨ Calculate Membrane System</button>
<button class="btn gray" onclick="resetMembrane()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="mem_results" style="margin-top:20px"></div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#8b5cf6">üìö Membrane Design Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Type</th><th>Typical Flux (GFD)</th><th>TMP (psi)</th><th>Recovery</th><th>Life (yrs)</th></tr>
</thead>
<tbody>
<tr><td>MBR</td><td>10-20</td><td>1-5</td><td>N/A</td><td>7-10</td></tr>
<tr><td>UF</td><td>30-60</td><td>10-30</td><td>90-95%</td><td>5-7</td></tr>
<tr><td>MF</td><td>40-80</td><td>5-15</td><td>90-95%</td><td>5-7</td></tr>
<tr><td>RO</td><td>15-25</td><td>150-400</td><td>75-85%</td><td>3-5</td></tr>
<tr><td>NF</td><td>20-35</td><td>75-150</td><td>80-90%</td><td>3-5</td></tr>
</tbody>
</table>
</div>

</div>
</div>


<!-- DAF (DISSOLVED AIR FLOTATION) CALCULATOR -->
<div class="section" id="dafCalculator" style="border:2px solid #f59e0b">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white">
ü´ß DAF Calculator (Dissolved Air Flotation)
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Flotation</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Design dissolved air flotation systems for TSS, FOG, and algae removal.</p>

<!-- Design Flows -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#f59e0b">üìä Design Parameters</h4>
<div class="row">
<div class="input-group">
<label style="color:#f59e0b">Design Flow (MGD)</label>
<input type="number" id="daf_flow" value="1.0" step="0.1" onchange="calcDAF()">
</div>
<div class="input-group">
<label style="color:#f59e0b">Peak Factor</label>
<input type="number" id="daf_peak" value="1.5" step="0.1" onchange="calcDAF()">
</div>
<div class="input-group">
<label style="color:#f59e0b">Number of Units</label>
<input type="number" id="daf_units" value="2" min="1" onchange="calcDAF()">
</div>
</div>
</div>

<!-- Influent Characteristics -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">üì• Influent Characteristics</h4>
<div class="row">
<div class="input-group">
<label>Influent TSS (mg/L)</label>
<input type="number" id="daf_inf_tss" value="200" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Influent FOG (mg/L)</label>
<input type="number" id="daf_inf_fog" value="100" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="daf_inf_bod" value="300" onchange="calcDAF()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Temperature (¬∞C)</label>
<input type="number" id="daf_temp" value="20" onchange="calcDAF()">
</div>
</div>
</div>

<!-- Design Criteria -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">‚öôÔ∏è Design Criteria</h4>
<div class="row">
<div class="input-group">
<label>Surface Loading (lb TSS/sf/d)</label>
<input type="number" id="daf_slr" value="2.0" step="0.1" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Hydraulic Loading (GPM/sf)</label>
<input type="number" id="daf_hlr" value="4.0" step="0.5" onchange="calcDAF()">
</div>
<div class="input-group">
<label>A/S Ratio (lb air/lb solids)</label>
<input type="number" id="daf_as" value="0.02" step="0.005" onchange="calcDAF()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Recycle Rate (%)</label>
<input type="number" id="daf_recycle" value="30" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Saturator Pressure (psi)</label>
<input type="number" id="daf_pressure" value="60" onchange="calcDAF()">
</div>
</div>
</div>

<!-- Performance Targets -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üéØ Performance Targets</h4>
<div class="row">
<div class="input-group">
<label>TSS Removal (%)</label>
<input type="number" id="daf_tss_rem" value="90" onchange="calcDAF()">
</div>
<div class="input-group">
<label>FOG Removal (%)</label>
<input type="number" id="daf_fog_rem" value="95" onchange="calcDAF()">
</div>
</div>
</div>

<!-- Operating Costs -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#ef4444">üí∞ Operating Costs</h4>
<div class="row">
<div class="input-group">
<label>Electricity ($/kWh)</label>
<input type="number" id="daf_elec" value="0.10" step="0.01" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Polymer Dose (mg/L)</label>
<input type="number" id="daf_poly" value="5" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Polymer Cost ($/lb)</label>
<input type="number" id="daf_poly_cost" value="2.50" step="0.10" onchange="calcDAF()">
</div>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcDAF()">ü´ß Calculate DAF System</button>
<button class="btn gray" onclick="resetDAF()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="daf_results" style="margin-top:20px"></div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#f59e0b">üìö DAF Design Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Parameter</th><th>Typical Range</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>A/S Ratio</td><td>0.01-0.05</td><td>lb air/lb solids removed</td></tr>
<tr><td>Recycle Rate</td><td>20-50%</td><td>Of influent flow</td></tr>
<tr><td>Saturator Pressure</td><td>40-80 psi</td><td>Higher = more air dissolved</td></tr>
<tr><td>Hydraulic Loading</td><td>2-6 GPM/sf</td><td>Based on total flow</td></tr>
<tr><td>Solids Loading</td><td>1-4 lb/sf/day</td><td>TSS basis</td></tr>
<tr><td>Float Solids</td><td>2-6%</td><td>Typical without thickening</td></tr>
</tbody>
</table>
</div>

</div>
</div>


<!-- END Process Calculations Panel -->

<!-- Diagnostics Panel -->
</div><!-- END hydraulics panel -->
</div><!-- END hydraulics outer -->


<!-- ==================== SOLIDS HANDLING PANEL ==================== -->
<div class="panel" id="solids" data-panel-name="SOLIDS-HANDLING-PANEL">
<div id="SOLIDS_HEADER_MARKER" style="background:linear-gradient(135deg,#8b5cf6 0%,#a855f7 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üóëÔ∏è SOLIDS HANDLING</h2>
</div>

<!-- QUICK NAV CARDS -->
<div id="solidsQuickNav" style="margin-bottom:20px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section</span>
<button onclick="document.getElementById('solidsQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(90px, 1fr));gap:8px">
<div onclick="scrollToSection('wasCalculatorSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:18px">üöø</div>
<div style="font-size:10px;color:white;margin-top:4px">WAS Calc</div>
</div>
<div onclick="scrollToSection('advancedWasCalculator')" class="quick-nav-card" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:18px">‚öôÔ∏è</div>
<div style="font-size:10px;color:white;margin-top:4px">Adv WAS</div>
</div>
<div onclick="scrollToSection('rasCalculatorSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:18px">üîÑ</div>
<div style="font-size:10px;color:white;margin-top:4px">RAS Calc</div>
</div>
<div onclick="scrollToSection('clarifierSlrCalculator')" class="quick-nav-card" style="background:linear-gradient(135deg,#2563eb,#3b82f6);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:18px">üåä</div>
<div style="font-size:10px;color:white;margin-top:4px">Clarifier</div>
</div>
<div onclick="scrollToSection('sludgeJudgeCalculator')" class="quick-nav-card" style="background:linear-gradient(135deg,#d97706,#f59e0b);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:18px">üìè</div>
<div style="font-size:10px;color:white;margin-top:4px">Blanket</div>
</div>
<div onclick="scrollToSection('thickenerCalcSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#06b6d4,#22d3ee);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:18px">üîÑ</div>
<div style="font-size:10px;color:white;margin-top:4px">Thickener</div>
</div>
<div onclick="scrollToSection('biogasCalculator')" class="quick-nav-card" style="background:linear-gradient(135deg,#ea580c,#f97316);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:18px">üî•</div>
<div style="font-size:10px;color:white;margin-top:4px">Biogas</div>
</div>
<div onclick="scrollToSection('septageCalculator')" class="quick-nav-card" style="background:linear-gradient(135deg,#65a30d,#84cc16);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s">
<div style="font-size:18px">üöõ</div>
<div style="font-size:10px;color:white;margin-top:4px">Septage</div>
</div>
</div>
</div>

<!-- Sludge Production Estimator -->
<div class="section">
<div class="section-h">üìä Sludge Production Estimator</div>
<div class="section-content">
<div class="note info">Estimate daily sludge production from primary and secondary treatment</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="sp_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Influent TSS (mg/L)</label><input type="number" id="sp_tss_in" value="220"></div>
<div class="input-group"><label>Primary TSS Removal (%)</label><input type="number" id="sp_prim_rem" value="60"></div>
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="sp_bod_in" value="200"></div>
<div class="input-group"><label>Yield Coefficient (lb VSS/lb BOD)</label><input type="number" id="sp_yield" value="0.6" step="0.05"></div>
<div class="input-group"><label>VSS/TSS Ratio</label><input type="number" id="sp_vss_tss" value="0.75" step="0.05"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcSludgeProduction()">üóëÔ∏è Calculate Production</button>
<button class="btn gray" onclick="resetSludgeProduction()">Reset</button>
</div>
<div id="sp_results" style="margin-top:15px"></div>
</div>
</div>

<!-- WAS Calculator -->
<div class="section" id="wasCalculatorSection">
<div class="section-h">üöø WAS (Waste Activated Sludge) Calculator</div>
<div class="section-content">
<div class="note info">Calculate WAS rate based on target SRT</div>
<div class="row">
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="was_vol" value="1.5" step="0.1"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="was_mlss" value="3000"></div>
<div class="input-group"><label>Target SRT (days)</label><input type="number" id="was_srt" value="10"></div>
<div class="input-group"><label>WAS Concentration (mg/L)</label><input type="number" id="was_conc" value="8000"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcWASRate()">üöø Calculate WAS</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td>Aeration Inventory</td><td><span class="result" id="r_was_inv">-</span></td><td>lb</td></tr>
<tr><td>WAS Rate (mass)</td><td><span class="result" id="r_was_mass">-</span></td><td>lb/day</td></tr>
<tr><td>WAS Rate (volume)</td><td><span class="result" id="r_was_gpd">-</span></td><td>gpd</td></tr>
<tr><td>WAS Rate</td><td><span class="result" id="r_was_gpm">-</span></td><td>gpm</td></tr>
</tbody></table>
</div>
</div>

<!-- ADVANCED WAS CALCULATOR -->
<div class="section" id="advancedWasCalculator" style="border:2px solid #a855f7">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:white">
üöø Advanced WAS Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Multiple Methods</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate WAS using different control strategies. Select your preferred method.</p>

<!-- Method Selection Tabs -->
<div style="display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn gradient" id="wasTab_srt" onclick="showWASMethod('srt')" style="flex:1;min-width:120px">üìÖ SRT Control</button>
<button class="btn gray" id="wasTab_mcrt" onclick="showWASMethod('mcrt')" style="flex:1;min-width:120px">‚è±Ô∏è MCRT Control</button>
<button class="btn gray" id="wasTab_fm" onclick="showWASMethod('fm')" style="flex:1;min-width:120px">‚öñÔ∏è F/M Control</button>
<button class="btn gray" id="wasTab_mlss" onclick="showWASMethod('mlss')" style="flex:1;min-width:120px">üìä MLSS Control</button>
</div>

<!-- Method 1: SRT Control -->
<div id="wasMethod_srt" style="display:block">
<h4 style="margin:0 0 15px 0;color:#a855f7">üìÖ SRT (Solids Retention Time) Control</h4>
<div class="note info" style="margin-bottom:15px">Most common method. WAS rate = Total solids inventory √∑ Target SRT</div>
<div class="row">
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input type="number" id="was2_srt_vol" value="1.5" step="0.1">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="was2_srt_mlss" value="3000">
</div>
<div class="input-group">
<label>Target SRT (days)</label>
<input type="number" id="was2_srt_target" value="10">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Clarifier Volume (MG)</label>
<input type="number" id="was2_srt_clarvol" value="0.3" step="0.05">
</div>
<div class="input-group">
<label>Blanket Depth (ft)</label>
<input type="number" id="was2_srt_blanket" value="2" step="0.5">
</div>
<div class="input-group">
<label>RAS Concentration (mg/L)</label>
<input type="number" id="was2_srt_ras" value="8000">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Effluent TSS (mg/L)</label>
<input type="number" id="was2_srt_efftss" value="10">
</div>
<div class="input-group">
<label>Effluent Flow (MGD)</label>
<input type="number" id="was2_srt_effq" value="5.0" step="0.1">
</div>
<div class="input-group">
<label>WAS Concentration (mg/L)</label>
<input type="number" id="was2_srt_wasconc" value="8000">
</div>
</div>
</div>

<!-- Method 2: MCRT Control -->
<div id="wasMethod_mcrt">
<h4 style="margin:0 0 15px 0;color:#f59e0b">‚è±Ô∏è MCRT (Mean Cell Residence Time) Control</h4>
<div class="note warning" style="margin-bottom:15px">Accounts for solids in clarifier and effluent losses</div>
<div class="row">
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input type="number" id="was2_mcrt_vol" value="1.5" step="0.1">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="was2_mcrt_mlss" value="3000">
</div>
<div class="input-group">
<label>Target MCRT (days)</label>
<input type="number" id="was2_mcrt_target" value="12">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Effluent TSS (mg/L)</label>
<input type="number" id="was2_mcrt_efftss" value="10">
</div>
<div class="input-group">
<label>Effluent Flow (MGD)</label>
<input type="number" id="was2_mcrt_effq" value="5.0" step="0.1">
</div>
<div class="input-group">
<label>WAS Concentration (mg/L)</label>
<input type="number" id="was2_mcrt_wasconc" value="8000">
</div>
</div>
</div>

<!-- Method 3: F/M Control -->
<div id="wasMethod_fm">
<h4 style="margin:0 0 15px 0;color:#10b981">‚öñÔ∏è F/M (Food to Microorganism) Control</h4>
<div class="note success" style="margin-bottom:15px">Control based on organic loading. Target F/M typically 0.2-0.5 for conventional activated sludge</div>
<div class="row">
<div class="input-group">
<label>Influent Flow (MGD)</label>
<input type="number" id="was2_fm_flow" value="5.0" step="0.1">
</div>
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="was2_fm_bod" value="200">
</div>
<div class="input-group">
<label>Target F/M (lb BOD/lb MLVSS/day)</label>
<input type="number" id="was2_fm_target" value="0.3" step="0.05">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Current MLSS (mg/L)</label>
<input type="number" id="was2_fm_mlss" value="3000">
</div>
<div class="input-group">
<label>VSS/TSS Ratio</label>
<input type="number" id="was2_fm_vss" value="0.80" step="0.05">
</div>
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input type="number" id="was2_fm_vol" value="1.5" step="0.1">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Yield (lb TSS/lb BOD)</label>
<input type="number" id="was2_fm_yield" value="0.6" step="0.05">
</div>
<div class="input-group">
<label>WAS Concentration (mg/L)</label>
<input type="number" id="was2_fm_wasconc" value="8000">
</div>
<div class="input-group">
<label>Decay Rate (1/day)</label>
<input type="number" id="was2_fm_kd" value="0.06" step="0.01">
</div>
</div>
</div>

<!-- Method 4: MLSS Control -->
<div id="wasMethod_mlss">
<h4 style="margin:0 0 15px 0;color:#3b82f6">üìä MLSS (Constant MLSS) Control</h4>
<div class="note info" style="margin-bottom:15px">Maintain target MLSS by wasting growth. Simple operational control.</div>
<div class="row">
<div class="input-group">
<label>Influent Flow (MGD)</label>
<input type="number" id="was2_mlss_flow" value="5.0" step="0.1">
</div>
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="was2_mlss_bod" value="200">
</div>
<div class="input-group">
<label>Yield (lb TSS/lb BOD)</label>
<input type="number" id="was2_mlss_yield" value="0.6" step="0.05">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Target MLSS (mg/L)</label>
<input type="number" id="was2_mlss_target" value="3000">
</div>
<div class="input-group">
<label>Current MLSS (mg/L)</label>
<input type="number" id="was2_mlss_current" value="3200">
</div>
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input type="number" id="was2_mlss_vol" value="1.5" step="0.1">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Days to Target</label>
<input type="number" id="was2_mlss_days" value="3">
</div>
<div class="input-group">
<label>WAS Concentration (mg/L)</label>
<input type="number" id="was2_mlss_wasconc" value="8000">
</div>
<div class="input-group">
<label>Decay Rate (1/day)</label>
<input type="number" id="was2_mlss_kd" value="0.06" step="0.01">
</div>
</div>
</div>

<!-- Calculate Button & Results -->
<div class="btns" style="margin-top:20px">
<button class="btn gradient" onclick="calcAdvancedWAS()">üöø Calculate WAS Rate</button>
<button class="btn blue" onclick="compareWASMethods()">üìä Compare All Methods</button>
<button class="btn gray" onclick="resetAdvancedWAS()">üîÑ Reset</button>
</div>

<!-- Results Table -->
<div id="was2_results" style="margin-top:20px"></div>

<!-- Reference Table -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#a855f7">üìö Typical WAS Control Parameters</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>Process Type</th><th>SRT (days)</th><th>F/M</th><th>MLSS (mg/L)</th></tr>
</thead>
<tbody>
<tr><td>Conventional AS</td><td>5-15</td><td>0.2-0.5</td><td>1,500-3,000</td></tr>
<tr><td>Extended Aeration</td><td>20-40</td><td>0.04-0.1</td><td>3,000-6,000</td></tr>
<tr><td>Contact Stabilization</td><td>5-10</td><td>0.2-0.6</td><td>1,000-3,000</td></tr>
<tr><td>SBR</td><td>10-30</td><td>0.04-0.1</td><td>2,000-5,000</td></tr>
<tr><td>MBR</td><td>10-25</td><td>0.1-0.4</td><td>8,000-12,000</td></tr>
<tr><td>Nitrification</td><td>10-20</td><td>0.1-0.3</td><td>2,000-4,000</td></tr>
</tbody>
</table>
</div>

</div>
</div>

<!-- RAS (Return Activated Sludge) Calculator -->
<div class="section" id="rasCalculatorSection" style="border:2px solid #10b981">
<div class="section-h" style="background:linear-gradient(135deg,#059669,#10b981);color:white">
üîÑ RAS (Return Activated Sludge) Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Multiple Methods</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate optimal RAS rate to maintain target MLSS and prevent settling issues.</p>

<!-- Method Selection Tabs -->
<div style="display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn green" id="rasTab_ratio" onclick="showRASMethod('ratio')" style="flex:1;min-width:140px">üìä RAS Ratio</button>
<button class="btn gray" id="rasTab_mlss" onclick="showRASMethod('mlss')" style="flex:1;min-width:140px">üéØ Target MLSS</button>
<button class="btn gray" id="rasTab_blanket" onclick="showRASMethod('blanket')" style="flex:1;min-width:140px">üìè Blanket Control</button>
</div>

<!-- Method 1: RAS Ratio -->
<div id="rasMethod_ratio" style="display:block">
<h4 style="margin:0 0 15px 0;color:#10b981">üìä RAS Ratio Method</h4>
<div class="note info" style="margin-bottom:15px">Calculate RAS based on desired RAS/Q ratio. Typical range: 25-100% of influent flow.</div>
<div class="row">
<div class="input-group">
<label style="color:#10b981">Influent Flow (MGD)</label>
<input type="number" id="ras_ratio_flow" value="5.0" step="0.1">
</div>
<div class="input-group">
<label style="color:#10b981">Target RAS Ratio (%)</label>
<input type="number" id="ras_ratio_pct" value="50" step="5">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="ras_ratio_mlss" value="3000">
</div>
</div>
<div class="row">
<div class="input-group">
<label>RAS Concentration (mg/L)</label>
<input type="number" id="ras_ratio_conc" value="8000">
</div>
<div class="input-group">
<label>Number of RAS Pumps</label>
<input type="number" id="ras_ratio_pumps" value="2">
</div>
<div class="input-group">
<label>Pump Capacity (gpm each)</label>
<input type="number" id="ras_ratio_pumpcap" value="1500">
</div>
</div>
</div>

<!-- Method 2: Target MLSS -->
<div id="rasMethod_mlss">
<h4 style="margin:0 0 15px 0;color:#3b82f6">üéØ Target MLSS Method</h4>
<div class="note info" style="margin-bottom:15px">Calculate RAS rate needed to achieve target MLSS based on mass balance.</div>
<div class="row">
<div class="input-group">
<label style="color:#3b82f6">Influent Flow (MGD)</label>
<input type="number" id="ras_mlss_flow" value="5.0" step="0.1">
</div>
<div class="input-group">
<label style="color:#3b82f6">Target MLSS (mg/L)</label>
<input type="number" id="ras_mlss_target" value="3000">
</div>
<div class="input-group">
<label>Current MLSS (mg/L)</label>
<input type="number" id="ras_mlss_current" value="2800">
</div>
</div>
<div class="row">
<div class="input-group">
<label>RAS Concentration (mg/L)</label>
<input type="number" id="ras_mlss_conc" value="8000">
</div>
<div class="input-group">
<label>Influent TSS (mg/L)</label>
<input type="number" id="ras_mlss_inftss" value="200">
</div>
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input type="number" id="ras_mlss_vol" value="1.5" step="0.1">
</div>
</div>
</div>

<!-- Method 3: Blanket Control -->
<div id="rasMethod_blanket">
<h4 style="margin:0 0 15px 0;color:#f59e0b">üìè Sludge Blanket Control Method</h4>
<div class="note warning" style="margin-bottom:15px">Adjust RAS to maintain target sludge blanket depth in clarifier.</div>
<div class="row">
<div class="input-group">
<label style="color:#f59e0b">Influent Flow (MGD)</label>
<input type="number" id="ras_blanket_flow" value="5.0" step="0.1">
</div>
<div class="input-group">
<label style="color:#f59e0b">Current Blanket (ft)</label>
<input type="number" id="ras_blanket_current" value="3.0" step="0.5">
</div>
<div class="input-group">
<label style="color:#f59e0b">Target Blanket (ft)</label>
<input type="number" id="ras_blanket_target" value="2.0" step="0.5">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Clarifier Side Water Depth (ft)</label>
<input type="number" id="ras_blanket_swd" value="12">
</div>
<div class="input-group">
<label>Current RAS Rate (MGD)</label>
<input type="number" id="ras_blanket_currentras" value="2.5" step="0.1">
</div>
<div class="input-group">
<label>SVI (mL/g)</label>
<input type="number" id="ras_blanket_svi" value="120">
</div>
</div>
<div class="row">
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="ras_blanket_mlss" value="3000">
</div>
<div class="input-group">
<label>Clarifier Surface Area (sf)</label>
<input type="number" id="ras_blanket_area" value="7850">
</div>
<div class="input-group">
<label>Adjustment Factor</label>
<input type="number" id="ras_blanket_adj" value="1.2" step="0.1">
</div>
</div>
</div>

<!-- Calculate Buttons -->
<div class="btns" style="margin-top:20px">
<button class="btn green" onclick="calcRAS_Advanced()">üîÑ Calculate RAS</button>
<button class="btn blue" onclick="calcRASSettling()">üìâ Check Settling</button>
<button class="btn gray" onclick="resetRASCalc()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="ras_results" style="margin-top:20px"></div>

<!-- RAS Quick Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#10b981">üìö RAS Operating Guidelines</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>Parameter</th><th>Typical Range</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>RAS Ratio (RAS/Q)</td><td>25-100%</td><td>Higher during high flows</td></tr>
<tr><td>RAS Concentration</td><td>6,000-12,000 mg/L</td><td>Should be 2-4x MLSS</td></tr>
<tr><td>Sludge Blanket</td><td>1-3 ft</td><td>Keep below weir level</td></tr>
<tr><td>RAS TSS/MLSS Ratio</td><td>2.0-4.0</td><td>Lower indicates poor settling</td></tr>
<tr><td>Clarifier SLR</td><td>20-35 lb/sf/day</td><td>Peak: 50 lb/sf/day max</td></tr>
</tbody>
</table>

<div style="margin-top:15px;padding:12px;background:#243b55;border-radius:8px">
<strong style="color:#fbbf24">‚ö†Ô∏è RAS Troubleshooting:</strong>
<ul style="margin:10px 0 0 20px;font-size:13px">
<li><strong>Rising blanket:</strong> Increase RAS rate or reduce WAS</li>
<li><strong>Low RAS concentration:</strong> Check for denitrification, reduce RAS rate</li>
<li><strong>RAS > 100%:</strong> Check for hydraulic issues, high SVI</li>
<li><strong>Thin blanket:</strong> May reduce RAS, but monitor effluent TSS</li>
</ul>
</div>
</div>

</div>
</div>

<!-- Clarifier SLR (Solids Loading Rate) Calculator -->
<div class="section" id="clarifierSlrCalculator" style="border:2px solid #3b82f6">
<div class="section-h" style="background:linear-gradient(135deg,#2563eb,#3b82f6);color:white">
üèä Clarifier Loading Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">SLR, SOR, WLR</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate solids loading rate (SLR), surface overflow rate (SOR), and weir loading rate (WLR) for secondary clarifiers.</p>

<!-- Clarifier Configuration -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">üèóÔ∏è Clarifier Configuration</h4>
<div class="row">
<div class="input-group">
<label style="color:#60a5fa">Number of Clarifiers</label>
<input type="number" id="clar_num" value="2" min="1" onchange="calcClarifier()">
</div>
<div class="input-group">
<label style="color:#60a5fa">Clarifier Diameter (ft)</label>
<input type="number" id="clar_dia" value="80" onchange="calcClarifier()">
</div>
<div class="input-group">
<label style="color:#60a5fa">Side Water Depth (ft)</label>
<input type="number" id="clar_swd" value="12" onchange="calcClarifier()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Center Well Diameter (ft)</label>
<input type="number" id="clar_cw" value="15" onchange="calcClarifier()">
</div>
<div class="input-group">
<label>Weir Length per Clarifier (ft)</label>
<input type="number" id="clar_weir" value="251" onchange="calcClarifier()">
<small style="opacity:0.7">Perimeter = œÄD</small>
</div>
<div class="input-group">
<label>Clarifiers Online</label>
<input type="number" id="clar_online" value="2" min="1" onchange="calcClarifier()">
</div>
</div>
</div>

<!-- Flow & Solids Inputs -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üíß Flow & Solids Data</h4>
<div class="row">
<div class="input-group">
<label style="color:#4ade80">Influent Flow (MGD)</label>
<input type="number" id="clar_flow" value="5.0" step="0.1" onchange="calcClarifier()">
</div>
<div class="input-group">
<label style="color:#4ade80">RAS Flow (MGD)</label>
<input type="number" id="clar_ras" value="2.5" step="0.1" onchange="calcClarifier()">
</div>
<div class="input-group">
<label style="color:#4ade80">MLSS (mg/L)</label>
<input type="number" id="clar_mlss" value="3000" onchange="calcClarifier()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Peak Flow Factor</label>
<input type="number" id="clar_pf" value="2.5" step="0.1" onchange="calcClarifier()">
</div>
<div class="input-group">
<label>SVI (mL/g)</label>
<input type="number" id="clar_svi" value="120" onchange="calcClarifier()">
</div>
<div class="input-group">
<label>RAS Concentration (mg/L)</label>
<input type="number" id="clar_rasconc" value="8000" onchange="calcClarifier()">
</div>
</div>
</div>

<!-- Calculate Button -->
<div class="btns">
<button class="btn gradient" onclick="calcClarifier_Advanced()">üèä Calculate Loading Rates</button>
<button class="btn orange" onclick="calcClarifierPeak()">‚ö° Calculate Peak Conditions</button>
<button class="btn blue" onclick="calcStatePoint()">üìà State Point Analysis</button>
<button class="btn gray" onclick="resetClarifier()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="clar_results" style="margin-top:20px"></div>

<!-- Design Criteria Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#3b82f6">üìö Secondary Clarifier Design Criteria</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>Parameter</th><th>Average</th><th>Peak</th><th>Units</th></tr>
</thead>
<tbody>
<tr><td>Surface Overflow Rate (SOR)</td><td>400-800</td><td>1,000-1,200</td><td>gpd/sf</td></tr>
<tr><td>Solids Loading Rate (SLR)</td><td>20-30</td><td>50</td><td>lb/sf/day</td></tr>
<tr><td>Weir Loading Rate (WLR)</td><td>10,000-20,000</td><td>30,000</td><td>gpd/lf</td></tr>
<tr><td>Hydraulic Detention Time</td><td>1.5-2.5</td><td>-</td><td>hours</td></tr>
<tr><td>Side Water Depth</td><td>12-15</td><td>-</td><td>ft</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px;border-left:3px solid #4ade80">
<strong style="color:#4ade80">‚úì Good Settling</strong>
<div style="font-size:12px;opacity:0.8">SVI &lt; 120, SLR &lt; 25</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px;border-left:3px solid #fbbf24">
<strong style="color:#fbbf24">‚ö†Ô∏è Fair Settling</strong>
<div style="font-size:12px;opacity:0.8">SVI 120-180, SLR 25-35</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px;border-left:3px solid #ef4444">
<strong style="color:#ef4444">‚úó Poor Settling</strong>
<div style="font-size:12px;opacity:0.8">SVI &gt; 180, SLR &gt; 35</div>
</div>
</div>
</div>

</div>
</div>

<!-- Sludge Judge / Settleometer Calculator -->
<div class="section" id="sludgeJudgeCalculator" style="border:2px solid #f59e0b">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white">
üß™ Sludge Judge / Settleometer
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">30-Min Settling Test</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Record settling test readings and calculate SVI, settling rate, and sludge characteristics.</p>

<!-- Test Setup -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">‚öôÔ∏è Test Setup</h4>
<div class="row">
<div class="input-group">
<label style="color:#fbbf24">Sample Location</label>
<select id="sj_location" style="font-size:14px">
<option value="mlss">MLSS (Aeration Basin)</option>
<option value="ras">RAS</option>
<option value="effluent">Secondary Effluent</option>
</select>
</div>
<div class="input-group">
<label style="color:#fbbf24">MLSS Concentration (mg/L)</label>
<input type="number" id="sj_mlss" value="3000" onchange="calcSettling()">
</div>
<div class="input-group">
<label style="color:#fbbf24">Cylinder Volume (mL)</label>
<select id="sj_cylinder" style="font-size:14px">
<option value="1000">1000 mL</option>
<option value="2000" selected>2000 mL</option>
</select>
</div>
</div>
<div class="row">
<div class="input-group">
<label>Test Date</label>
<input type="date" id="sj_date">
</div>
<div class="input-group">
<label>Test Time</label>
<input type="time" id="sj_time">
</div>
<div class="input-group">
<label>Stirred Test (SSVI)?</label>
<select id="sj_stirred" style="font-size:14px">
<option value="no">No - Standard SVI</option>
<option value="yes">Yes - SSVI (Stirred)</option>
</select>
</div>
</div>
</div>

<!-- Settling Readings -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üìè Settling Readings (mL)</h4>
<div class="note info" style="margin-bottom:15px">Enter settled sludge volume at each time interval. Start with initial volume (usually 1000 or 2000 mL).</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px">
<div class="input-group" style="margin:0">
<label style="font-size:12px">0 min</label>
<input type="number" id="sj_0" value="1000" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">5 min</label>
<input type="number" id="sj_5" placeholder="--" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">10 min</label>
<input type="number" id="sj_10" placeholder="--" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">15 min</label>
<input type="number" id="sj_15" placeholder="--" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">20 min</label>
<input type="number" id="sj_20" placeholder="--" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">25 min</label>
<input type="number" id="sj_25" placeholder="--" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px;color:#fbbf24;font-weight:bold">30 min *</label>
<input type="number" id="sj_30" placeholder="--" style="text-align:center;border-color:#fbbf24" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">60 min</label>
<input type="number" id="sj_60" placeholder="--" style="text-align:center;opacity:0.7" onchange="calcSettling()">
</div>
</div>
</div>

<!-- Calculate Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcSettling()">üß™ Calculate SVI</button>
<button class="btn blue" onclick="showSettlingCurve()">üìà Show Settling Curve</button>
<button class="btn green" onclick="saveSettlingTest()">üíæ Save Test</button>
<button class="btn gray" onclick="resetSettling()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="sj_results" style="margin-top:20px"></div>

<!-- Settling Curve Chart -->
<div id="sj_chart_container" style="display:none;margin-top:20px;background:#1e3a5f;padding:15px;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#60a5fa">üìà Settling Curve</h4>
<canvas id="settlingChart" height="200"></canvas>
</div>

<!-- Reference Table -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#f59e0b">üìö SVI Interpretation Guide</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>SVI (mL/g)</th><th>Settling Quality</th><th>Sludge Condition</th><th>Action</th></tr>
</thead>
<tbody>
<tr style="background:rgba(74,222,128,0.1)"><td>&lt; 80</td><td style="color:#4ade80">Excellent</td><td>Old sludge, pin floc possible</td><td>May reduce WAS, check effluent TSS</td></tr>
<tr style="background:rgba(74,222,128,0.1)"><td>80-120</td><td style="color:#4ade80">Good</td><td>Normal, healthy sludge</td><td>Maintain current operations</td></tr>
<tr style="background:rgba(251,191,36,0.1)"><td>120-150</td><td style="color:#fbbf24">Fair</td><td>Light bulking beginning</td><td>Monitor closely, check DO/nutrients</td></tr>
<tr style="background:rgba(251,191,36,0.1)"><td>150-200</td><td style="color:#fbbf24">Poor</td><td>Bulking sludge</td><td>Identify filaments, adjust process</td></tr>
<tr style="background:rgba(239,68,68,0.1)"><td>&gt; 200</td><td style="color:#ef4444">Very Poor</td><td>Severe bulking</td><td>Immediate action required</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#60a5fa">SVI Formula:</strong>
<div style="font-size:12px;margin-top:5px">SVI = (Settled Vol mL √ó 1000) / (Cylinder mL √ó MLSS mg/L)</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#60a5fa">Typical Targets:</strong>
<div style="font-size:12px;margin-top:5px">Conventional: 80-150<br>Extended Air: 100-200<br>MBR: N/A (no settling)</div>
</div>
</div>
</div>

</div>
</div>

<!-- Thickener Loading -->
<div class="section" id="thickenerCalcSection">
<div class="section-h">üîÑ Gravity Thickener Loading</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sludge Flow (gpd)</label><input type="number" id="gt_flow" value="50000"></div>
<div class="input-group"><label>Feed TSS (%)</label><input type="number" id="gt_feed_tss" value="1.0" step="0.1"></div>
<div class="input-group"><label>Thickener Diameter (ft)</label><input type="number" id="gt_dia" value="30"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcThickenerLoading()">üîÑ Calculate Loading</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td>Surface Area</td><td><span class="result" id="r_gt_area">-</span></td><td>sf</td></tr>
<tr><td>Hydraulic Loading</td><td><span class="result" id="r_gt_hyd">-</span></td><td>gpd/sf</td></tr>
<tr><td>Solids Loading</td><td><span class="result" id="r_gt_sol">-</span></td><td>lb/sf/day</td></tr>
<tr><td>Status</td><td colspan="2"><span class="status" id="r_gt_status">-</span></td></tr>
</tbody></table>
</div>
</div>

<!-- Dewatering Performance -->
<div class="section">
<div class="section-h">üóúÔ∏è Dewatering Performance</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Feed Rate (gpm)</label><input type="number" id="dw_feed" value="50"></div>
<div class="input-group"><label>Feed Solids (%)</label><input type="number" id="dw_feed_pct" value="3.0" step="0.1"></div>
<div class="input-group"><label>Cake Solids (%)</label><input type="number" id="dw_cake_pct" value="20" step="0.5"></div>
<div class="input-group"><label>Polymer Dose (lb/DT)</label><input type="number" id="dw_poly" value="12"></div>
<div class="input-group"><label>Polymer Cost ($/lb)</label><input type="number" id="dw_poly_cost" value="2.50" step="0.10"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcDewatering()">üóúÔ∏è Calculate Performance</button>
</div>
<div id="dw_results" style="margin-top:15px"></div>
</div>
</div>

<!-- Note about Mass Balance -->
<div class="section">
<div class="section-h">‚öñÔ∏è Plant Mass Balance</div>
<div class="section-content">
<div class="note info">For comprehensive mass balance calculations including BOD, TSS, TKN, and TP through the entire treatment train, see the Mass Balance Calculator in the <strong>üìê Hydraulics</strong> tab.</div>
<button class="btn blue" onclick="switchPanel('hydraulics')">Go to Hydraulics Tab ‚Üí</button>
</div>
</div>

<!-- COMPREHENSIVE BIOGAS/DIGESTER CALCULATOR -->
<div class="section" id="biogasCalculator" style="border:2px solid #f97316">
<div class="section-h" style="background:linear-gradient(135deg,#ea580c,#f97316);color:white">
üî• Biogas & Digester Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Comprehensive</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Complete anaerobic digester analysis: loading, gas production, heating, and energy recovery.</p>

<!-- Digester Configuration -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#f97316">üèóÔ∏è Digester Configuration</h4>
<div class="row">
<div class="input-group">
<label style="color:#f97316">Number of Digesters</label>
<input type="number" id="bg_num_dig" value="2" min="1" onchange="calcBiogas()">
</div>
<div class="input-group">
<label style="color:#f97316">Digester Diameter (ft)</label>
<input type="number" id="bg_dia" value="60" onchange="calcBiogas()">
</div>
<div class="input-group">
<label style="color:#f97316">Sidewater Depth (ft)</label>
<input type="number" id="bg_swd" value="25" onchange="calcBiogas()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Digester Type</label>
<select id="bg_type" style="font-size:14px" onchange="calcBiogas()">
<option value="standard">Standard Rate (Unmixed)</option>
<option value="high" selected>High Rate (Mixed)</option>
<option value="two_stage">Two-Stage</option>
<option value="egg">Egg-Shaped</option>
</select>
</div>
<div class="input-group">
<label>Operating Temperature (¬∞F)</label>
<input type="number" id="bg_temp" value="95" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>Digesters Online</label>
<input type="number" id="bg_online" value="2" min="1" onchange="calcBiogas()">
</div>
</div>
</div>

<!-- Sludge Feed -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üì• Sludge Feed</h4>
<div class="row">
<div class="input-group">
<label>Primary Sludge (gpd)</label>
<input type="number" id="bg_ps_flow" value="30000" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>PS Solids (%)</label>
<input type="number" id="bg_ps_pct" value="5.0" step="0.1" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>PS VS/TS Ratio</label>
<input type="number" id="bg_ps_vs" value="0.75" step="0.01" onchange="calcBiogas()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>WAS/Thickened Sludge (gpd)</label>
<input type="number" id="bg_was_flow" value="20000" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>WAS Solids (%)</label>
<input type="number" id="bg_was_pct" value="4.0" step="0.1" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>WAS VS/TS Ratio</label>
<input type="number" id="bg_was_vs" value="0.70" step="0.01" onchange="calcBiogas()">
</div>
</div>
</div>

<!-- Performance Parameters -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">‚ö° Performance Parameters</h4>
<div class="row">
<div class="input-group">
<label>VS Destruction (%)</label>
<input type="number" id="bg_vs_dest" value="55" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>Gas Production (cf/lb VS destroyed)</label>
<input type="number" id="bg_gas_rate" value="15" step="0.5" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>Methane Content (%)</label>
<input type="number" id="bg_ch4" value="65" onchange="calcBiogas()">
</div>
</div>
</div>

<!-- Energy & Economics -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üí∞ Energy & Economics</h4>
<div class="row">
<div class="input-group">
<label>CHP Efficiency (%)</label>
<input type="number" id="bg_chp_eff" value="30" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>Electricity Cost ($/kWh)</label>
<input type="number" id="bg_elec_cost" value="0.10" step="0.01" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>Natural Gas Cost ($/therm)</label>
<input type="number" id="bg_ng_cost" value="1.00" step="0.10" onchange="calcBiogas()">
</div>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcBiogas()">üî• Calculate All</button>
<button class="btn blue" onclick="calcDigesterHeating()">üå°Ô∏è Heating Requirements</button>
<button class="btn gray" onclick="resetBiogas()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="bg_results" style="margin-top:20px"></div>

<!-- Heating Results -->
<div id="bg_heating_results" style="margin-top:15px"></div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#f97316">üìö Digester Design Guidelines</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>Parameter</th><th>Standard Rate</th><th>High Rate</th><th>Two-Stage</th></tr>
</thead>
<tbody>
<tr><td>SRT (days)</td><td>30-60</td><td>10-20</td><td>10-15 (1st)</td></tr>
<tr><td>VS Loading (lb/cf/d)</td><td>0.03-0.10</td><td>0.15-0.40</td><td>0.25-0.50</td></tr>
<tr><td>VS Destruction (%)</td><td>35-50</td><td>50-65</td><td>55-65</td></tr>
<tr><td>Temperature (¬∞F)</td><td>Ambient</td><td>95 (meso)</td><td>95-131</td></tr>
<tr><td>Mixing</td><td>None</td><td>Continuous</td><td>Both stages</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#4ade80">Gas Composition:</strong>
<div style="font-size:12px;margin-top:5px">
CH‚ÇÑ: 60-70%<br>
CO‚ÇÇ: 30-40%<br>
H‚ÇÇS: 0.1-0.5%<br>
Trace: N‚ÇÇ, H‚ÇÇ, etc.
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#4ade80">Energy Content:</strong>
<div style="font-size:12px;margin-top:5px">
Biogas: ~600 BTU/cf<br>
Methane: ~1,000 BTU/cf<br>
1 cf CH‚ÇÑ = 0.01 therm<br>
1 kWh = 3,412 BTU
</div>
</div>
</div>
</div>

</div>
</div>

<!-- SEPTAGE RECEIVING CALCULATOR -->
<div class="section" id="septageCalculator" style="border:2px solid #84cc16">
<div class="section-h" style="background:linear-gradient(135deg,#65a30d,#84cc16);color:white">
üöõ Septage Receiving Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Hauled Waste</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate septage receiving capacity, loading impacts, and revenue potential.</p>

<!-- Plant Baseline -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#84cc16">üè≠ Plant Baseline</h4>
<div class="row">
<div class="input-group">
<label style="color:#84cc16">Design Flow (MGD)</label>
<input type="number" id="sep_design" value="5.0" step="0.1" onchange="calcSeptage()">
</div>
<div class="input-group">
<label style="color:#84cc16">Current Avg Flow (MGD)</label>
<input type="number" id="sep_flow" value="4.0" step="0.1" onchange="calcSeptage()">
</div>
<div class="input-group">
<label style="color:#84cc16">Available Capacity (%)</label>
<input type="number" id="sep_avail" value="20" onchange="calcSeptage()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Current BOD Load (lb/day)</label>
<input type="number" id="sep_bod_load" value="6000" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>BOD Capacity (lb/day)</label>
<input type="number" id="sep_bod_cap" value="8000" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Current TSS Load (lb/day)</label>
<input type="number" id="sep_tss_load" value="5500" onchange="calcSeptage()">
</div>
</div>
</div>

<!-- Septage Characteristics -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üöõ Septage Characteristics</h4>
<div class="row">
<div class="input-group">
<label>Septage Type</label>
<select id="sep_type" style="font-size:14px" onchange="updateSeptageDefaults()">
<option value="residential" selected>Residential Septage</option>
<option value="commercial">Commercial Septage</option>
<option value="grease">Grease Trap Waste</option>
<option value="portable">Portable Toilet Waste</option>
<option value="mixed">Mixed Hauled Waste</option>
</select>
</div>
<div class="input-group">
<label>BOD (mg/L)</label>
<input type="number" id="sep_bod" value="6000" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>TSS (mg/L)</label>
<input type="number" id="sep_tss" value="15000" onchange="calcSeptage()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>TKN (mg/L)</label>
<input type="number" id="sep_tkn" value="700" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>NH3-N (mg/L)</label>
<input type="number" id="sep_nh3" value="400" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>FOG (mg/L)</label>
<input type="number" id="sep_fog" value="8000" onchange="calcSeptage()">
</div>
</div>
</div>

<!-- Receiving Operations -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">üì• Receiving Operations</h4>
<div class="row">
<div class="input-group">
<label>Truck Size (gallons)</label>
<input type="number" id="sep_truck" value="3000" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Trucks per Day</label>
<input type="number" id="sep_trucks" value="10" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Operating Hours/Day</label>
<input type="number" id="sep_hours" value="8" onchange="calcSeptage()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Receiving Rate (GPM)</label>
<input type="number" id="sep_rate" value="200" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Max Daily Volume (gal)</label>
<input type="number" id="sep_max_vol" value="50000" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Discharge Point</label>
<select id="sep_discharge" style="font-size:14px">
<option value="headworks">Headworks</option>
<option value="primary">Primary Clarifier</option>
<option value="eq">Equalization Basin</option>
<option value="digester">Digester (solids only)</option>
</select>
</div>
</div>
</div>

<!-- Economics -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üí∞ Economics</h4>
<div class="row">
<div class="input-group">
<label>Tipping Fee ($/gallon)</label>
<input type="number" id="sep_fee" value="0.08" step="0.01" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Alternative: $/1000 gal</label>
<input type="number" id="sep_fee_k" value="80" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Treatment Cost ($/gal)</label>
<input type="number" id="sep_cost" value="0.02" step="0.01" onchange="calcSeptage()">
</div>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcSeptage()">üöõ Calculate Septage Impact</button>
<button class="btn blue" onclick="calcSeptageCapacity()">üìä Capacity Analysis</button>
<button class="btn gray" onclick="resetSeptage()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="sep_results" style="margin-top:20px"></div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#84cc16">üìö Typical Septage Characteristics</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Parameter</th><th>Residential</th><th>Commercial</th><th>Grease Trap</th><th>Portable</th></tr>
</thead>
<tbody>
<tr><td>BOD (mg/L)</td><td>2,000-10,000</td><td>1,500-5,000</td><td>15,000-150,000</td><td>5,000-15,000</td></tr>
<tr><td>TSS (mg/L)</td><td>5,000-30,000</td><td>3,000-15,000</td><td>5,000-50,000</td><td>10,000-40,000</td></tr>
<tr><td>TKN (mg/L)</td><td>200-1,000</td><td>150-500</td><td>50-200</td><td>500-2,000</td></tr>
<tr><td>FOG (mg/L)</td><td>5,000-15,000</td><td>3,000-10,000</td><td>50,000-150,000</td><td>2,000-8,000</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#ef4444">‚ö†Ô∏è Considerations:</strong>
<div style="font-size:11px;margin-top:5px">
- Slug loading impacts<br>
- FOG handling capacity<br>
- Grit removal needs<br>
- Odor control<br>
- Screenings increase
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#4ade80">‚úÖ Best Practices:</strong>
<div style="font-size:11px;margin-top:5px">
- Meter all loads<br>
- Sample periodically<br>
- Controlled discharge rate<br>
- Spread throughout day<br>
- Maintain manifest records
</div>
</div>
</div>
</div>

</div>
</div>

<!-- SLUDGE BOX (DRY) HAUL CALCULATOR -->
<div class="section" id="sludgeBoxCalculator" style="border:2px solid #78716c">
<div class="section-h" style="background:linear-gradient(135deg,#57534e,#78716c);color:white">
üì¶ Sludge Box (Dry) Haul Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Roll-off/Dumpster</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate sludge box capacity, hauling frequency, and costs for dewatered cake disposal.</p>

<!-- Sludge Production -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#78716c">üóúÔ∏è Cake Production</h4>
<div class="row">
<div class="input-group">
<label style="color:#a8a29e">Daily Cake Production</label>
<input type="number" id="sb_cake_day" value="5" step="0.5" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Unit</label>
<select id="sb_cake_unit" style="font-size:14px" onchange="calcSludgeBox()">
<option value="wetton" selected>Wet Tons/Day</option>
<option value="dryton">Dry Tons/Day</option>
<option value="cy">Cubic Yards/Day</option>
<option value="lb">Pounds/Day</option>
</select>
</div>
<div class="input-group">
<label style="color:#a8a29e">Cake Solids (%)</label>
<input type="number" id="sb_cake_pct" value="22" step="1" onchange="calcSludgeBox()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Cake Density (lb/cy)</label>
<input type="number" id="sb_density" value="1200" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Operating Days/Week</label>
<input type="number" id="sb_op_days" value="5" min="1" max="7" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Storage Days Available</label>
<input type="number" id="sb_storage_days" value="3" onchange="calcSludgeBox()">
</div>
</div>
</div>

<!-- Box Configuration -->
<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üì¶ Box Configuration</h4>
<div class="row">
<div class="input-group">
<label>Box Type</label>
<select id="sb_box_type" style="font-size:14px" onchange="updateBoxDefaults()">
<option value="20cy">20 CY Roll-off</option>
<option value="30cy" selected>30 CY Roll-off</option>
<option value="40cy">40 CY Roll-off</option>
<option value="lugger">Lugger Box (10-15 CY)</option>
<option value="custom">Custom Size</option>
</select>
</div>
<div class="input-group">
<label>Box Capacity (cubic yards)</label>
<input type="number" id="sb_box_cy" value="30" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Fill Percentage (%)</label>
<input type="number" id="sb_fill_pct" value="85" onchange="calcSludgeBox()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Number of Boxes On-Site</label>
<input type="number" id="sb_num_boxes" value="2" min="1" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Max Weight Limit (tons)</label>
<input type="number" id="sb_weight_limit" value="20" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Limiting Factor</label>
<select id="sb_limit" style="font-size:14px">
<option value="auto" selected>Auto-detect</option>
<option value="volume">Volume</option>
<option value="weight">Weight</option>
</select>
</div>
</div>
</div>

<!-- Hauling Costs -->
<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üí∞ Hauling & Disposal Costs</h4>
<div class="row">
<div class="input-group">
<label>Haul Cost ($/pull)</label>
<input type="number" id="sb_haul_cost" value="350" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Disposal Fee ($/ton)</label>
<input type="number" id="sb_disp_ton" value="45" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Box Rental ($/box/month)</label>
<input type="number" id="sb_rental" value="150" onchange="calcSludgeBox()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Fuel Surcharge (%)</label>
<input type="number" id="sb_fuel" value="10" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Environmental Fee ($/haul)</label>
<input type="number" id="sb_env_fee" value="15" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Destination</label>
<select id="sb_dest" style="font-size:14px">
<option value="landfill" selected>Landfill</option>
<option value="compost">Composting Facility</option>
<option value="incinerator">Incinerator</option>
<option value="landapp">Land Application</option>
</select>
</div>
</div>
</div>

<!-- Buttons -->
<div class="btns">
<button class="btn gradient" onclick="calcSludgeBox()">üì¶ Calculate Hauling</button>
<button class="btn blue" onclick="calcBoxSchedule()">üìÖ Weekly Schedule</button>
<button class="btn orange" onclick="optimizeBoxSize()">üìä Optimize Box Size</button>
<button class="btn gray" onclick="resetSludgeBox()">üîÑ Reset</button>
</div>

<!-- Results -->
<div id="sb_results" style="margin-top:20px"></div>

<!-- Schedule -->
<div id="sb_schedule" style="margin-top:15px"></div>

<!-- Reference -->
<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#78716c">üìö Sludge Box Reference</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Box Size</th><th>Capacity (CY)</th><th>Typical Weight Limit</th><th>Best For</th></tr>
</thead>
<tbody>
<tr><td>Lugger Box</td><td>10-15</td><td>8-12 tons</td><td>Small plants, limited space</td></tr>
<tr><td>20 CY Roll-off</td><td>20</td><td>15-18 tons</td><td>Small-medium plants</td></tr>
<tr style="background:rgba(74,222,128,0.1)"><td>30 CY Roll-off</td><td>30</td><td>20-22 tons</td><td>Most common size</td></tr>
<tr><td>40 CY Roll-off</td><td>40</td><td>20-25 tons</td><td>Large plants, light cake</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">Typical Cake Densities:</strong>
<div style="font-size:11px;margin-top:5px">
Belt Press (20%): 1,000-1,200 lb/cy<br>
Centrifuge (25%): 1,200-1,400 lb/cy<br>
Plate Press (35%): 1,400-1,600 lb/cy<br>
Dried (90%+): 800-1,000 lb/cy
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">Cost Factors:</strong>
<div style="font-size:11px;margin-top:5px">
- Haul distance<br>
- Fuel prices<br>
- Disposal facility type<br>
- Weekend/holiday rates<br>
- Contamination charges
</div>
</div>
</div>
</div>

</div>
</div>

</div><!-- END solids panel -->
<!-- ==================== END SOLIDS HANDLING PANEL ==================== -->


<!-- ========== GUIDED WIZARDS MODULE ========== -->
<div class="panel" id="wizards">
<div id="WIZARDS_HEADER_MARKER" style="background:linear-gradient(135deg,#7c3aed 0%,#a855f7 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üß≠ WIZARDS & DIAGNOSTICS</h2>
</div>

<!-- QUICK NAV CARDS - v9.9.19 -->
<div id="wizardsQuickNav" style="margin-bottom:16px">
<div style="font-size:13px;color:#94a3b8;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">
<span>üìç Jump to Section</span>
<button onclick="document.getElementById('wizardsQuickNav').style.display='none'" style="background:none;border:none;color:#64748b;cursor:pointer;font-size:16px">‚úï</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(90px, 1fr));gap:8px">
<div onclick="scrollToSection('healthScoreWizSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#0077b6,#0096c7);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìä</div>
<div style="font-size:10px;color:white;margin-top:4px">Health</div>
</div>
<div onclick="scrollToSection('wizardGridSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#7c3aed,#a855f7);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üß≠</div>
<div style="font-size:10px;color:white;margin-top:4px">Wizards</div>
</div>
<div onclick="scrollToSection('whatIfSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#059669,#10b981);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üîÆ</div>
<div style="font-size:10px;color:white;margin-top:4px">What-If</div>
</div>
<div onclick="scrollToSection('sopLibrarySection')" class="quick-nav-card" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">üìö</div>
<div style="font-size:10px;color:white;margin-top:4px">SOPs</div>
</div>
<div onclick="scrollToSection('massBalanceSection')" class="quick-nav-card" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);padding:10px 6px;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform='translateY(0)'">
<div style="font-size:18px">‚öñÔ∏è</div>
<div style="font-size:10px;color:white;margin-top:4px">Mass Bal</div>
</div>
</div>
</div>

<!-- System Health Score (merged from Diagnostics) -->
<div class="section" id="healthScoreWizSection">
<div class="section-h" style="background:linear-gradient(135deg,#0077b6,#0096c7);color:white">üìä System Health Score</div>
<div class="section-content">
<div style="display:flex;align-items:center;gap:30px;flex-wrap:wrap">
<div class="gauge good" id="healthGauge" style="margin:0">
<div><div style="font-size:0.4em">Health</div>95<div style="font-size:0.3em">/100</div></div>
</div>
<div style="flex:1;min-width:250px">
<div style="margin-bottom:10px"><span style="color:#4ade80">‚óè</span> Process Control: <strong>Excellent</strong></div>
<div style="margin-bottom:10px"><span style="color:#4ade80">‚óè</span> Effluent Quality: <strong>Good</strong></div>
<div style="margin-bottom:10px"><span style="color:#fbbf24">‚óè</span> Equipment Status: <strong>Monitor</strong></div>
<div><span style="color:#4ade80">‚óè</span> Compliance: <strong>In Limits</strong></div>
</div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="runDiagnostics()">üîç Run Full Diagnostics</button>
</div>
<div id="diagOut" style="margin-top:15px"></div>
</div>
</div>

<!-- Wizard Selection Grid -->
<div class="section">
<div class="section-h">üß≠ Select a Troubleshooting Wizard</div>
<div class="section-content">
<p style="margin:0 0 20px 0;opacity:0.8;font-size:15px">Choose a problem to diagnose. Each wizard will guide you through step-by-step questions to identify the root cause and recommend solutions.</p>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">

<!-- Wizard 1: High Effluent TSS -->
<div onclick="startWizard('tss')" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#fca5a5'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üî¥</div>
<h3 style="margin:0 0 8px 0;font-size:20px">High Effluent TSS</h3>
<p style="margin:0;opacity:0.9;font-size:14px">TSS exceeding permit limits? Diagnose clarifier, biological, and hydraulic causes.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">8 Decision Points ‚Üí</div>
</div>

<!-- Wizard 2: Filamentous Bulking -->
<div onclick="startWizard('bulking')" style="background:linear-gradient(135deg,#d97706,#f59e0b);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#fcd34d'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üü†</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Filamentous Bulking</h3>
<p style="margin:0;opacity:0.9;font-size:14px">SVI > 150? Poor settling? Identify filament type and targeted solutions.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">10 Decision Points ‚Üí</div>
</div>

<!-- Wizard 3: High Effluent Ammonia -->
<div onclick="startWizard('ammonia')" style="background:linear-gradient(135deg,#2563eb,#3b82f6);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#93c5fd'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üîµ</div>
<h3 style="margin:0 0 8px 0;font-size:20px">High Effluent Ammonia</h3>
<p style="margin:0;opacity:0.9;font-size:14px">NH‚ÇÉ-N above limits? Check nitrification, DO, alkalinity, and toxicity.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">9 Decision Points ‚Üí</div>
</div>

<!-- Wizard 4: Low DO Problems -->
<div onclick="startWizard('lowdo')" style="background:linear-gradient(135deg,#059669,#10b981);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#6ee7b7'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üü¢</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Low DO Problems</h3>
<p style="margin:0;opacity:0.9;font-size:14px">Can't maintain DO setpoint? Diagnose aeration, loading, and equipment issues.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">8 Decision Points ‚Üí</div>
</div>

<!-- Wizard 5: Foam/Scum Issues -->
<div onclick="startWizard('foam')" style="background:linear-gradient(135deg,#92400e,#b45309);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#fbbf24'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üü§</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Foam/Scum Issues</h3>
<p style="margin:0;opacity:0.9;font-size:14px">Excessive foam on basins or clarifiers? Identify foam type and control strategies.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">6 Decision Points ‚Üí</div>
</div>

<!-- Wizard 6: Odor Control -->
<div onclick="startWizard('odor')" style="background:linear-gradient(135deg,#7c2d12,#9a3412);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#fb923c'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üëÉ</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Odor Control</h3>
<p style="margin:0;opacity:0.9;font-size:14px">H‚ÇÇS or septic odors? Locate sources and implement control measures.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">7 Decision Points ‚Üí</div>
</div>

<!-- Wizard 7: Nutrient Removal -->
<div onclick="startWizard('nutrient')" style="background:linear-gradient(135deg,#7e22ce,#9333ea);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#c084fc'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üü£</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Nutrient Removal</h3>
<p style="margin:0;opacity:0.9;font-size:14px">High phosphorus or nitrogen? Optimize Bio-P, chemical, and denitrification.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">10 Decision Points ‚Üí</div>
</div>

<!-- Wizard 8: Blower/Aeration -->
<div onclick="startWizard('blower')" style="background:linear-gradient(135deg,#0369a1,#0284c7);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#38bdf8'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">‚ö°</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Blower/Aeration</h3>
<p style="margin:0;opacity:0.9;font-size:14px">Equipment issues, high amps, surge? Diagnose blower and air distribution problems.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">9 Decision Points ‚Üí</div>
</div>

<!-- Wizard 9: Clarifier Mechanical -->
<div onclick="startWizard('clarifier')" style="background:linear-gradient(135deg,#475569,#64748b);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#94a3b8'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üîß</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Clarifier Mechanical</h3>
<p style="margin:0;opacity:0.9;font-size:14px">High torque, scum issues, weir problems? Troubleshoot clarifier equipment.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">8 Decision Points ‚Üí</div>
</div>

<!-- Wizard 10: RAS/WAS Optimization -->
<div onclick="startWizard('raswas')" style="background:linear-gradient(135deg,#0891b2,#06b6d4);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#22d3ee'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üíß</div>
<h3 style="margin:0 0 8px 0;font-size:20px">RAS/WAS Optimization</h3>
<p style="margin:0;opacity:0.9;font-size:14px">Sludge return issues? Optimize RAS rate, WAS control, and maintain MLSS.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">8 Decision Points ‚Üí</div>
</div>

</div>
</div>
</div>

<!-- Wizard Active Area (Hidden until wizard starts) -->
<div id="wizardActiveArea">
<div class="section">
<div class="section-h" id="wizardTitle">üß≠ Wizard Active</div>
<div class="section-content">

<!-- Progress Bar -->
<div style="margin-bottom:20px">
<div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px">
<span id="wizardProgress">Step 1 of 8</span>
<span id="wizardPercent">12%</span>
</div>
<div style="background:rgba(124,58,237,0.2);height:12px;border-radius:6px;overflow:hidden">
<div id="wizardProgressBar" style="background:linear-gradient(90deg,#7c3aed,#a855f7);height:100%;width:12%;transition:width 0.3s;border-radius:6px"></div>
</div>
</div>

<!-- Question Area -->
<div id="wizardQuestion" style="background:linear-gradient(135deg,#1e1b4b,#312e81);padding:30px;border-radius:16px;margin-bottom:20px;border:2px solid #7c3aed">
<h3 id="wizardQuestionText" style="margin:0 0 20px 0;font-size:22px;color:white;line-height:1.4">Question will appear here...</h3>
<div id="wizardAnswers" style="display:flex;flex-direction:column;gap:12px">
<!-- Answers populated by JS -->
</div>
</div>

<!-- Diagnosis Path (Breadcrumb) -->
<div id="wizardPath" style="background:rgba(124,58,237,0.1);padding:16px;border-radius:12px;margin-bottom:20px">
<div style="font-size:13px;font-weight:bold;margin-bottom:8px;color:#a855f7">üìç Diagnosis Path:</div>
<div id="wizardBreadcrumb" style="font-size:14px;line-height:1.8;color:var(--text-primary)">Start ‚Üí ...</div>
</div>

<!-- Navigation -->
<div style="display:flex;gap:12px;flex-wrap:wrap">
<button onclick="wizardBack()" id="wizardBackBtn" class="btn" style="background:#6b7280;color:white" disabled>‚Üê Back</button>
<button onclick="wizardRestart()" class="btn" style="background:#dc2626;color:white">üîÑ Restart</button>
<button onclick="exitWizard()" class="btn" style="background:#374151;color:white">‚úñ Exit Wizard</button>
</div>

</div>
</div>
</div>

<!-- Wizard Results Area (Hidden until diagnosis complete) -->
<div id="wizardResults">
<div class="section">
<div class="section-h">‚úÖ Diagnosis Complete</div>
<div class="section-content">

<div id="wizardResultContent" style="background:linear-gradient(135deg,#059669,#10b981);padding:30px;border-radius:16px;color:white;margin-bottom:20px">
<!-- Results populated by JS -->
</div>

<div style="display:flex;gap:12px;flex-wrap:wrap">
<button onclick="generateWizardReport()" class="btn" style="background:#2563eb;color:white">üìÑ Generate Report</button>
<button onclick="wizardRestart()" class="btn" style="background:#7c3aed;color:white">üîÑ Run Again</button>
<button onclick="exitWizard()" class="btn" style="background:#374151;color:white">‚Üê Back to Wizards</button>
</div>

</div>
</div>
</div>

<!-- Recent Wizard History -->
<div class="section">
<div class="section-h">üìú Recent Diagnoses</div>
<div class="section-content">
<div id="wizardHistory" style="font-size:14px;opacity:0.8">
<p>No diagnoses completed yet. Run a wizard to see your history here.</p>
</div>
</div>
</div>

</div>

<!-- WHAT-IF SCENARIO SIMULATOR -->
<div class="section" id="whatIfScenarios" style="border:2px solid #8b5cf6">
<div class="section-h" style="background:linear-gradient(135deg,#6d28d9,#8b5cf6);color:white">
üîÆ What-If Scenario Simulator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">20 Scenarios</span>
</div>
<div class="section-content">
<p style="margin:0 0 20px 0;opacity:0.8;font-size:14px">Explore how operational changes affect your plant. Select a scenario to see predicted impacts before making real changes.</p>

<!-- Scenario Selection Grid -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px">

<div onclick="runWhatIfScenario('flow_increase')" class="whatif-card" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üìà</div>
<div style="font-weight:bold;font-size:13px">Flow Increase</div>
<div style="font-size:11px;opacity:0.8">+25% influent</div>
</div>

<div onclick="runWhatIfScenario('storm_event')" class="whatif-card" style="background:linear-gradient(135deg,#0891b2,#22d3ee);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üåßÔ∏è</div>
<div style="font-weight:bold;font-size:13px">Storm Event</div>
<div style="font-size:11px;opacity:0.8">2x peak flow</div>
</div>

<div onclick="runWhatIfScenario('blower_failure')" class="whatif-card" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üåÄ</div>
<div style="font-weight:bold;font-size:13px">Blower Failure</div>
<div style="font-size:11px;opacity:0.8">-33% capacity</div>
</div>

<div onclick="runWhatIfScenario('clarifier_offline')" class="whatif-card" style="background:linear-gradient(135deg,#d97706,#f59e0b);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üîß</div>
<div style="font-weight:bold;font-size:13px">Clarifier Offline</div>
<div style="font-size:11px;opacity:0.8">1 unit down</div>
</div>

<div onclick="runWhatIfScenario('high_loading')" class="whatif-card" style="background:linear-gradient(135deg,#7c3aed,#a78bfa);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üí™</div>
<div style="font-weight:bold;font-size:13px">High BOD Load</div>
<div style="font-size:11px;opacity:0.8">+50% strength</div>
</div>

<div onclick="runWhatIfScenario('cold_weather')" class="whatif-card" style="background:linear-gradient(135deg,#64748b,#94a3b8);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">‚ùÑÔ∏è</div>
<div style="font-weight:bold;font-size:13px">Cold Weather</div>
<div style="font-size:11px;opacity:0.8">Temp drop 10¬∞C</div>
</div>

<div onclick="runWhatIfScenario('toxic_shock')" class="whatif-card" style="background:linear-gradient(135deg,#be123c,#f43f5e);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">‚ò†Ô∏è</div>
<div style="font-weight:bold;font-size:13px">Toxic Shock</div>
<div style="font-size:11px;opacity:0.8">Industrial slug</div>
</div>

<div onclick="runWhatIfScenario('power_outage')" class="whatif-card" style="background:linear-gradient(135deg,#1e293b,#475569);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">‚ö°</div>
<div style="font-weight:bold;font-size:13px">Power Outage</div>
<div style="font-size:11px;opacity:0.8">Generator only</div>
</div>

<div onclick="runWhatIfScenario('srt_change')" class="whatif-card" style="background:linear-gradient(135deg,#059669,#34d399);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üìÖ</div>
<div style="font-weight:bold;font-size:13px">Increase SRT</div>
<div style="font-size:11px;opacity:0.8">+5 days target</div>
</div>

<div onclick="runWhatIfScenario('mlss_increase')" class="whatif-card" style="background:linear-gradient(135deg,#0d9488,#2dd4bf);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">ü¶†</div>
<div style="font-weight:bold;font-size:13px">Raise MLSS</div>
<div style="font-size:11px;opacity:0.8">+1000 mg/L</div>
</div>

<div onclick="runWhatIfScenario('reduce_was')" class="whatif-card" style="background:linear-gradient(135deg,#ca8a04,#facc15);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:#1e293b;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üöø</div>
<div style="font-weight:bold;font-size:13px">Reduce WAS</div>
<div style="font-size:11px;opacity:0.7">-25% wasting</div>
</div>

<div onclick="runWhatIfScenario('increase_ras')" class="whatif-card" style="background:linear-gradient(135deg,#c026d3,#e879f9);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üîÑ</div>
<div style="font-weight:bold;font-size:13px">Increase RAS</div>
<div style="font-size:11px;opacity:0.8">+20% return</div>
</div>

<!-- NEW v9.9.16 SCENARIOS -->
<div onclick="runWhatIfScenario('uv_failure')" class="whatif-card" style="background:linear-gradient(135deg,#7c2d12,#ea580c);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üí°</div>
<div style="font-weight:bold;font-size:13px">UV Failure</div>
<div style="font-size:11px;opacity:0.8">Disinfection down</div>
</div>

<div onclick="runWhatIfScenario('digester_upset')" class="whatif-card" style="background:linear-gradient(135deg,#991b1b,#dc2626);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üî•</div>
<div style="font-weight:bold;font-size:13px">Digester Upset</div>
<div style="font-size:11px;opacity:0.8">pH drop event</div>
</div>

<div onclick="runWhatIfScenario('filament_outbreak')" class="whatif-card" style="background:linear-gradient(135deg,#581c87,#9333ea);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üï∏Ô∏è</div>
<div style="font-weight:bold;font-size:13px">Filament Outbreak</div>
<div style="font-size:11px;opacity:0.8">Bulking sludge</div>
</div>

<div onclick="runWhatIfScenario('pump_station_failure')" class="whatif-card" style="background:linear-gradient(135deg,#0c4a6e,#0284c7);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üö∞</div>
<div style="font-weight:bold;font-size:13px">Lift Station Down</div>
<div style="font-size:11px;opacity:0.8">SSO risk</div>
</div>

<div onclick="runWhatIfScenario('nutrient_spike')" class="whatif-card" style="background:linear-gradient(135deg,#065f46,#10b981);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üß™</div>
<div style="font-weight:bold;font-size:13px">Phosphorus Spike</div>
<div style="font-size:11px;opacity:0.8">+200% P load</div>
</div>

<div onclick="runWhatIfScenario('summer_loading')" class="whatif-card" style="background:linear-gradient(135deg,#b45309,#f59e0b);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">‚òÄÔ∏è</div>
<div style="font-weight:bold;font-size:13px">Summer Peak</div>
<div style="font-size:11px;opacity:0.8">Seasonal loading</div>
</div>

<div onclick="runWhatIfScenario('grease_loading')" class="whatif-card" style="background:linear-gradient(135deg,#854d0e,#ca8a04);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üçî</div>
<div style="font-weight:bold;font-size:13px">FOG Event</div>
<div style="font-size:11px;opacity:0.8">Grease slug</div>
</div>

<div onclick="runWhatIfScenario('low_flow')" class="whatif-card" style="background:linear-gradient(135deg,#1e3a5f,#3b82f6);padding:16px;border-radius:12px;cursor:pointer;text-align:center;color:white;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform=''">
<div style="font-size:28px;margin-bottom:8px">üìâ</div>
<div style="font-weight:bold;font-size:13px">Low Flow Period</div>
<div style="font-size:11px;opacity:0.8">-40% drought</div>
</div>

</div>

<!-- Results Display -->
<div id="whatIfResultsPanel" style="display:none">
<div style="background:#1e293b;border-radius:12px;padding:20px;border:2px solid #8b5cf6">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
<h4 style="margin:0;color:#a78bfa;font-size:18px" id="whatIfTitle">üìä Scenario Results</h4>
<button onclick="document.getElementById('whatIfResultsPanel').style.display='none'" style="background:#374151;border:none;color:#94a3b8;padding:6px 12px;border-radius:6px;cursor:pointer">‚úï Close</button>
</div>

<!-- Impact Summary -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:20px" id="whatIfImpacts">
</div>

<!-- Detailed Analysis -->
<div id="whatIfAnalysis" style="background:#0f172a;border-radius:10px;padding:15px;margin-bottom:15px">
</div>

<!-- Recommended Actions -->
<div id="whatIfActions" style="background:rgba(139,92,246,0.1);border:1px solid #8b5cf6;border-radius:10px;padding:15px">
<h5 style="margin:0 0 10px 0;color:#a78bfa">üéØ Recommended Actions</h5>
<ul id="whatIfActionsList" style="margin:0;padding-left:20px;color:#e2e8f0"></ul>
</div>

</div>
</div>

<!-- Custom Scenario Builder -->
<div style="margin-top:20px;padding:15px;background:#1e293b;border-radius:12px">
<h4 style="margin:0 0 15px 0;color:#8b5cf6">üõ†Ô∏è Custom Scenario Builder</h4>
<div class="row">
<div class="input-group">
<label>Flow Change (%)</label>
<input type="number" id="custom_flow" value="0" step="5" style="background:#0f172a">
</div>
<div class="input-group">
<label>BOD Change (%)</label>
<input type="number" id="custom_bod" value="0" step="5" style="background:#0f172a">
</div>
<div class="input-group">
<label>Temp Change (¬∞C)</label>
<input type="number" id="custom_temp" value="0" step="1" style="background:#0f172a">
</div>
<div class="input-group">
<label>Aeration Change (%)</label>
<input type="number" id="custom_air" value="0" step="5" style="background:#0f172a">
</div>
</div>
<div class="row">
<div class="input-group">
<label>MLSS Change (mg/L)</label>
<input type="number" id="custom_mlss" value="0" step="100" style="background:#0f172a">
</div>
<div class="input-group">
<label>SRT Change (days)</label>
<input type="number" id="custom_srt" value="0" step="1" style="background:#0f172a">
</div>
<div class="input-group">
<label>RAS Change (%)</label>
<input type="number" id="custom_ras" value="0" step="5" style="background:#0f172a">
</div>
<div class="input-group">
<label>WAS Change (%)</label>
<input type="number" id="custom_was" value="0" step="5" style="background:#0f172a">
</div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="runCustomScenario()">üîÆ Run Custom Scenario</button>
<button class="btn gray" onclick="resetCustomScenario()">Reset</button>
</div>
</div>

</div>
</div>

<!-- END WIZARDS PANEL -->



<!-- ========== MULTI-PLANT MODULE ========== -->
<div class="panel" id="multiplant">
<div id="MULTIPLANT_HEADER_MARKER" style="background:linear-gradient(135deg,#059669 0%,#34d399 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üè≠ MULTI-PLANT</h2>
</div>
<div class="section">
<div class="section-h">üè≠ Multi-Plant Fleet Management</div>
<div class="section-content">

<div style="background:linear-gradient(135deg,#023e8a 0%,#0077b6 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üè≠ Fleet Operations Dashboard</h2>
<p style="margin:0;opacity:0.9">Centralized monitoring and management for multiple treatment facilities</p>
</div>

<!-- Action Buttons -->
<div class="btns" style="margin-bottom:20px;flex-wrap:wrap">
<button class="btn green" onclick="addNewPlant()">‚ûï Add Plant</button>
<button class="btn blue" onclick="editSelectedPlant()">‚úèÔ∏è Edit</button>
<button class="btn red" onclick="deleteSelectedPlant()">üóëÔ∏è Delete</button>
<button class="btn orange" onclick="exportPlantData()">üì§ Export CSV</button>
<button class="btn purple" onclick="importPlantData()">üì• Import</button>
<button class="btn teal" onclick="showFleetAnalytics()">üìä Analytics</button>
<button class="btn gray" onclick="comparePlants()">‚öñÔ∏è Compare</button>
</div>

<!-- Fleet KPIs -->
<div class="kpi-grid" style="margin-bottom:24px">
<div class="kpi-card">
<h4>Total Plants</h4>
<p id="fleet-plants">4</p>
</div>
<div class="kpi-card">
<h4>Total Capacity</h4>
<p id="fleet-capacity">18.5 MGD</p>
</div>
<div class="kpi-card">
<h4>Online</h4>
<p id="fleet-online" style="color:#06d6a0">3</p>
</div>
<div class="kpi-card">
<h4>Avg Efficiency</h4>
<p id="fleet-eff">93.1%</p>
</div>
<div class="kpi-card">
<h4>Total Flow</h4>
<p id="fleet-flow">15.1 MGD</p>
</div>
<div class="kpi-card">
<h4>Avg Load</h4>
<p id="fleet-load">82%</p>
</div>
</div>

<!-- Fleet Comparison Chart -->
<div class="section" style="margin-bottom:24px">
<div class="section-h">üìä Fleet Performance Comparison</div>
<div class="section-content">
<canvas id="fleetComparisonChart" style="max-height:300px"></canvas>
</div>
</div>

<!-- Plant Cards Grid -->
<div id="plant-cards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px">

<!-- Plant Card 1 -->
<div class="plant-card" data-plant-id="1" onclick="selectPlant(1)" style="background:var(--bg-section);padding:20px;border-radius:12px;border-left:4px solid var(--ok);cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<strong>North Regional WWTP</strong>
<span class="status ok">ONLINE</span>
</div>
<div style="color:var(--text-unit);font-size:14px;margin-bottom:12px">üìç Houston, TX</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
<div>Capacity: <strong>5.0 MGD</strong></div>
<div>Flow: <strong>4.2 MGD</strong></div>
<div>Efficiency: <strong style="color:#06d6a0">94.5%</strong></div>
<div>Load: <strong>84%</strong></div>
</div>
<div style="margin-top:12px;display:flex;gap:8px">
<button class="btn small blue" onclick="event.stopPropagation();viewPlantDetails(1)">View</button>
<button class="btn small orange" onclick="event.stopPropagation();editPlant(1)">Edit</button>
</div>
</div>

<!-- Plant Card 2 -->
<div class="plant-card" data-plant-id="2" onclick="selectPlant(2)" style="background:var(--bg-section);padding:20px;border-radius:12px;border-left:4px solid var(--ok);cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<strong>South Municipal Plant</strong>
<span class="status ok">ONLINE</span>
</div>
<div style="color:var(--text-unit);font-size:14px;margin-bottom:12px">üìç Pearland, TX</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
<div>Capacity: <strong>3.5 MGD</strong></div>
<div>Flow: <strong>2.8 MGD</strong></div>
<div>Efficiency: <strong style="color:#06d6a0">92.1%</strong></div>
<div>Load: <strong>80%</strong></div>
</div>
<div style="margin-top:12px;display:flex;gap:8px">
<button class="btn small blue" onclick="event.stopPropagation();viewPlantDetails(2)">View</button>
<button class="btn small orange" onclick="event.stopPropagation();editPlant(2)">Edit</button>
</div>
</div>

<!-- Plant Card 3 -->
<div class="plant-card" data-plant-id="3" onclick="selectPlant(3)" style="background:var(--bg-section);padding:20px;border-radius:12px;border-left:4px solid var(--warn);cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<strong>East Industrial WWTP</strong>
<span class="status warn">MAINTENANCE</span>
</div>
<div style="color:var(--text-unit);font-size:14px;margin-bottom:12px">üìç Pasadena, TX</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
<div>Capacity: <strong>8.0 MGD</strong></div>
<div>Flow: <strong>6.5 MGD</strong></div>
<div>Efficiency: <strong style="color:#ffd166">89.7%</strong></div>
<div>Load: <strong>81%</strong></div>
</div>
<div style="margin-top:12px;display:flex;gap:8px">
<button class="btn small blue" onclick="event.stopPropagation();viewPlantDetails(3)">View</button>
<button class="btn small orange" onclick="event.stopPropagation();editPlant(3)">Edit</button>
</div>
</div>

<!-- Plant Card 4 -->
<div class="plant-card" data-plant-id="4" onclick="selectPlant(4)" style="background:var(--bg-section);padding:20px;border-radius:12px;border-left:4px solid var(--ok);cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<strong>West Community Plant</strong>
<span class="status ok">ONLINE</span>
</div>
<div style="color:var(--text-unit);font-size:14px;margin-bottom:12px">üìç Katy, TX</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
<div>Capacity: <strong>2.0 MGD</strong></div>
<div>Flow: <strong>1.6 MGD</strong></div>
<div>Efficiency: <strong style="color:#06d6a0">96.2%</strong></div>
<div>Load: <strong>80%</strong></div>
</div>
<div style="margin-top:12px;display:flex;gap:8px">
<button class="btn small blue" onclick="event.stopPropagation();viewPlantDetails(4)">View</button>
<button class="btn small orange" onclick="event.stopPropagation();editPlant(4)">Edit</button>
</div>
</div>


<!-- Detention Time (General) Calculator -->
<div class="section">
<div class="section-h">‚è∞ Detention Time (General)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Tank Volume (gallons)</label><input type="number" id="det_vol" value="500000"></div>
<div class="input-group"><label>Flow Rate (GPM)</label><input type="number" id="det_gpm" value="3500"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcDetention()">Calculate</button>
<button class="btn gray" onclick="resetDetention()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Detention Time</td><td><span class="result" id="r_det_min">-</span></td><td>minutes</td></tr>
<tr><td class="rowh">Detention Time</td><td><span class="result" id="r_det_hr">-</span></td><td>hours</td></tr>
</tbody></table>
</div>
</div>

<!-- Population Equivalent Calculator -->
<div class="section">
<div class="section-h">üë• Population Equivalent</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>BOD Load (lb/day)</label><input type="number" id="pe_bod" value="5000"></div>
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="pe_flow" value="5.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPE()">Calculate</button>
<button class="btn gray" onclick="resetPE()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">PE (BOD basis)</td><td><span class="result" id="r_pe_bod">-</span></td><td>people</td></tr>
<tr><td class="rowh">PE (Flow basis)</td><td><span class="result" id="r_pe_flow">-</span></td><td>people</td></tr>
<tr><td class="rowh">GPD per capita</td><td><span class="result" id="r_pe_gpd">-</span></td><td>gpd/person</td></tr>
</tbody></table>
</div>
</div>

<!-- Sludge Age Calculator -->
<div class="section">
<div class="section-h">üìÖ Sludge Age (Simple)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Aeration Tank MLSS (lb)</label><input type="number" id="sa_mlss" value="25000"></div>
<div class="input-group"><label>WAS Rate (lb/day)</label><input type="number" id="sa_was" value="2500"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSludgeAge()">Calculate</button>
<button class="btn gray" onclick="resetSludgeAge()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Sludge Age</td><td><span class="result" id="r_sa">-</span></td><td>days</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_sa_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Percent Removal Calculator -->
<div class="section">
<div class="section-h">üìâ Percent Removal (Universal)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent Concentration</label><input type="number" id="rem_in" value="200"></div>
<div class="input-group"><label>Effluent Concentration</label><input type="number" id="rem_out" value="20"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcRemoval()">Calculate</button>
<button class="btn gray" onclick="resetRemoval()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Amount Removed</td><td><span class="result" id="r_rem_amt">-</span></td><td>units</td></tr>
<tr><td class="rowh">Percent Removal</td><td><span class="result" id="r_rem_pct">-</span></td><td>%</td></tr>
</tbody></table>
</div>
</div>

<!-- Flow Conversion Calculator -->
<div class="section">
<div class="section-h">üîÑ Flow Unit Converter</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Value</label><input type="number" id="conv_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Input Unit</label>
<select id="conv_unit">
<option value="mgd">MGD</option>
<option value="gpm">GPM</option>
<option value="gpd">GPD</option>
<option value="cfs">CFS</option>
<option value="m3d">m¬≥/day</option>
<option value="lps">L/s</option>
</select>
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcFlowConv()">Convert</button>
<button class="btn gray" onclick="resetFlowConv()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">MGD</td><td><span class="result" id="r_conv_mgd">-</span></td><td></td></tr>
<tr><td class="rowh">GPM</td><td><span class="result" id="r_conv_gpm">-</span></td><td></td></tr>
<tr><td class="rowh">GPD</td><td><span class="result" id="r_conv_gpd">-</span></td><td></td></tr>
<tr><td class="rowh">CFS</td><td><span class="result" id="r_conv_cfs">-</span></td><td></td></tr>
<tr><td class="rowh">m¬≥/day</td><td><span class="result" id="r_conv_m3d">-</span></td><td></td></tr>
<tr><td class="rowh">L/s</td><td><span class="result" id="r_conv_lps">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Decibel/Noise Calculator -->
<div class="section">
<div class="section-h">üîä Blower Noise Estimation</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Blower HP</label><input type="number" id="noise_hp" value="100"></div>
<div class="input-group"><label>Distance (ft)</label><input type="number" id="noise_dist" value="50"></div>
<div class="input-group"><label>Number of Blowers</label><input type="number" id="noise_num" value="2"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcNoise()">Calculate</button>
<button class="btn gray" onclick="resetNoise()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Est. Sound Level</td><td><span class="result" id="r_noise_db">-</span></td><td>dB(A)</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_noise_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<!-- Carbon Footprint Calculator -->
<div class="section">
<div class="section-h">üåç Carbon Footprint Estimator</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Energy Use (kWh/day)</label><input type="number" id="carbon_kwh" value="5000"></div>
<div class="input-group"><label>Chemical Use (lb/day)</label><input type="number" id="carbon_chem" value="500"></div>
<div class="input-group"><label>Biogas Captured (cf/day)</label><input type="number" id="carbon_biogas" value="10000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcCarbon()">Calculate</button>
<button class="btn gray" onclick="resetCarbon()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Energy CO2</td><td><span class="result" id="r_carbon_energy">-</span></td><td>lb CO2/day</td></tr>
<tr><td class="rowh">Chemical CO2</td><td><span class="result" id="r_carbon_chem">-</span></td><td>lb CO2/day</td></tr>
<tr><td class="rowh">Biogas Offset</td><td><span class="result" id="r_carbon_offset">-</span></td><td>lb CO2/day</td></tr>
<tr><td class="rowh">Net Carbon</td><td><span class="result" id="r_carbon_net">-</span></td><td>lb CO2/day</td></tr>
</tbody></table>
</div>
</div>

<!-- Cost Per Gallon Calculator -->
<div class="section">
<div class="section-h">üí∞ Treatment Cost Analysis</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Daily Flow (MGD)</label><input type="number" id="cost_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Energy Cost ($/day)</label><input type="number" id="cost_energy" value="1500"></div>
<div class="input-group"><label>Chemical Cost ($/day)</label><input type="number" id="cost_chem" value="800"></div>
<div class="input-group"><label>Labor Cost ($/day)</label><input type="number" id="cost_labor" value="2000"></div>
<div class="input-group"><label>Sludge Disposal ($/day)</label><input type="number" id="cost_sludge" value="500"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcTreatmentCost()">Calculate</button>
<button class="btn gray" onclick="resetTreatmentCost()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Total Daily Cost</td><td><span class="result" id="r_cost_total">-</span></td><td>$/day</td></tr>
<tr><td class="rowh">Cost per MG</td><td><span class="result" id="r_cost_mg">-</span></td><td>$/MG</td></tr>
<tr><td class="rowh">Cost per 1000 gal</td><td><span class="result" id="r_cost_kgal">-</span></td><td>$/1000 gal</td></tr>
<tr><td class="rowh">Monthly Cost</td><td><span class="result" id="r_cost_month">-</span></td><td>$/month</td></tr>
<tr><td class="rowh">Annual Cost</td><td><span class="result" id="r_cost_year">-</span></td><td>$/year</td></tr>
</tbody></table>
</div>
</div>



</div>

<!-- Fleet Analytics Summary -->
<div class="section">
<div class="section-h">üìà Fleet Analytics Summary</div>
<div class="section-content">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
<div style="background:linear-gradient(135deg,#06d6a020,#06d6a010);padding:16px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:#06d6a0">93.1%</div>
<div style="font-size:14px;opacity:0.8">Fleet Avg Efficiency</div>
<div style="font-size:12px;color:#06d6a0;margin-top:4px">‚Üë 2.3% vs last month</div>
</div>
<div style="background:linear-gradient(135deg,#0077b620,#0077b610);padding:16px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:#0077b6">82%</div>
<div style="font-size:14px;opacity:0.8">Avg Capacity Utilization</div>
<div style="font-size:12px;color:#0077b6;margin-top:4px">Optimal Range</div>
</div>
<div style="background:linear-gradient(135deg,#ffd16620,#ffd16610);padding:16px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:#ffd166">$45.2K</div>
<div style="font-size:14px;opacity:0.8">Monthly Operating Cost</div>
<div style="font-size:12px;color:#06d6a0;margin-top:4px">‚Üì 5% vs budget</div>
</div>
<div style="background:linear-gradient(135deg,#00b4d820,#00b4d810);padding:16px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:#00b4d8">99.2%</div>
<div style="font-size:14px;opacity:0.8">Compliance Rate</div>
<div style="font-size:12px;color:#00b4d8;margin-top:4px">All permits current</div>
</div>
</div>
</div>
</div>

<div class="note" style="margin-top:24px">
<strong>üí° Tips:</strong> Click on a plant card to select it, then use Edit/Delete buttons. Use Compare to analyze multiple plants side-by-side. Export data to CSV for reporting.
</div>

</div>
</div>
</div><!-- END multiplant panel -->

<!-- ==================== TROUBLESHOOTING PANEL v9.9.24 ==================== -->
<div class="panel" id="troubleshoot">
<div style="background:linear-gradient(135deg,#dc2626 0%,#f97316 100%);padding:16px 20px;border-radius:12px;margin-bottom:16px;color:white">
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
<div>
<h2 style="margin:0;font-size:22px;display:flex;align-items:center;gap:10px">
üîç Interactive Troubleshooting Wizard
<span style="background:rgba(255,255,255,0.2);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700">8 PROBLEM CATEGORIES</span>
</h2>
<p style="margin:6px 0 0 0;opacity:0.9;font-size:13px">Step-by-step diagnostic decision trees for common WWTP problems</p>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button onclick="switchPanel('simulations')" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);border:none;padding:8px 16px;border-radius:8px;color:white;font-weight:600;cursor:pointer;font-size:12px">üîÆ Process Simulations</button>
<button onclick="resetTroubleshootWizard()" style="background:rgba(255,255,255,0.2);border:none;padding:8px 16px;border-radius:8px;color:white;font-weight:600;cursor:pointer;font-size:12px">üîÑ Start Over</button>
</div>
</div>
</div>

<!-- Problem Category Selection -->
<div id="troubleshootCategories" class="section" style="border:2px solid #f97316;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#ea580c,#f97316);color:white">
<span>‚ö†Ô∏è Select Problem Category</span>
</div>
<div class="section-content" style="padding:16px">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">

<!-- Category 1: High Effluent TSS -->
<button onclick="startTroubleshoot('tss')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(239,68,68,0.3);cursor:pointer;transition:all 0.2s;text-align:left">
<div style="font-size:28px;margin-bottom:8px">üå´Ô∏è</div>
<div style="font-size:14px;font-weight:700;color:#fca5a5">High Effluent TSS</div>
<div style="font-size:11px;color:#94a3b8;margin-top:4px">Turbid effluent, solids carryover</div>
</button>

<!-- Category 2: High Effluent BOD -->
<button onclick="startTroubleshoot('bod')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(245,158,11,0.3);cursor:pointer;transition:all 0.2s;text-align:left">
<div style="font-size:28px;margin-bottom:8px">üìà</div>
<div style="font-size:14px;font-weight:700;color:#fcd34d">High Effluent BOD</div>
<div style="font-size:11px;color:#94a3b8;margin-top:4px">Permit exceedance, poor treatment</div>
</button>

<!-- Category 3: High Effluent Ammonia -->
<button onclick="startTroubleshoot('ammonia')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(139,92,246,0.3);cursor:pointer;transition:all 0.2s;text-align:left">
<div style="font-size:28px;margin-bottom:8px">‚öóÔ∏è</div>
<div style="font-size:14px;font-weight:700;color:#c4b5fd">High Effluent Ammonia</div>
<div style="font-size:11px;color:#94a3b8;margin-top:4px">Nitrification failure</div>
</button>

<!-- Category 4: Sludge Bulking -->
<button onclick="startTroubleshoot('bulking')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(16,185,129,0.3);cursor:pointer;transition:all 0.2s;text-align:left">
<div style="font-size:28px;margin-bottom:8px">üåÄ</div>
<div style="font-size:14px;font-weight:700;color:#6ee7b7">Sludge Bulking</div>
<div style="font-size:11px;color:#94a3b8;margin-top:4px">Poor settling, high SVI</div>
</button>

<!-- Category 5: Foam/Scum -->
<button onclick="startTroubleshoot('foam')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(236,72,153,0.3);cursor:pointer;transition:all 0.2s;text-align:left">
<div style="font-size:28px;margin-bottom:8px">ü´ß</div>
<div style="font-size:14px;font-weight:700;color:#f9a8d4">Foam/Scum Problems</div>
<div style="font-size:11px;color:#94a3b8;margin-top:4px">Surface foam, Nocardia, grease</div>
</button>

<!-- Category 6: Low DO -->
<button onclick="startTroubleshoot('do')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(14,165,233,0.3);cursor:pointer;transition:all 0.2s;text-align:left">
<div style="font-size:28px;margin-bottom:8px">üí®</div>
<div style="font-size:14px;font-weight:700;color:#7dd3fc">Low DO in Aeration</div>
<div style="font-size:11px;color:#94a3b8;margin-top:4px">Oxygen depletion, black sludge</div>
</button>

<!-- Category 7: Odor Issues -->
<button onclick="startTroubleshoot('odor')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(132,204,22,0.3);cursor:pointer;transition:all 0.2s;text-align:left">
<div style="font-size:28px;margin-bottom:8px">üëÉ</div>
<div style="font-size:14px;font-weight:700;color:#bef264">Odor Issues</div>
<div style="font-size:11px;color:#94a3b8;margin-top:4px">H‚ÇÇS, septic conditions</div>
</button>

<!-- Category 8: Clarifier Problems -->
<button onclick="startTroubleshoot('clarifier')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(99,102,241,0.3);cursor:pointer;transition:all 0.2s;text-align:left">
<div style="font-size:28px;margin-bottom:8px">üîÑ</div>
<div style="font-size:14px;font-weight:700;color:#a5b4fc">Clarifier Problems</div>
<div style="font-size:11px;color:#94a3b8;margin-top:4px">Rising sludge, short-circuiting</div>
</button>

</div>
</div>
</div>

<!-- Wizard Container (Hidden by default) -->
<div id="troubleshootWizard" style="display:none">

<!-- Progress Bar -->
<div style="background:#1e293b;border-radius:12px;padding:16px;margin-bottom:16px">
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
<div style="display:flex;align-items:center;gap:10px">
<span id="wizardIcon" style="font-size:28px">üå´Ô∏è</span>
<div>
<div id="wizardTitle" style="font-size:18px;font-weight:700;color:#f0f9ff">Troubleshooting: High Effluent TSS</div>
<div id="wizardSubtitle" style="font-size:12px;color:#94a3b8">Step 1 of 5</div>
</div>
</div>
<button onclick="resetTroubleshootWizard()" style="background:rgba(239,68,68,0.2);border:1px solid rgba(239,68,68,0.3);padding:8px 14px;border-radius:8px;color:#fca5a5;font-weight:600;cursor:pointer;font-size:12px">‚úï Exit Wizard</button>
</div>
<div style="background:#0f172a;border-radius:8px;height:8px;overflow:hidden">
<div id="wizardProgress" style="background:linear-gradient(90deg,#22c55e,#4ade80);height:100%;width:20%;transition:width 0.3s"></div>
</div>
</div>

<!-- Question Card -->
<div id="wizardQuestionCard" class="section" style="border:2px solid #3b82f6;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#2563eb,#3b82f6);color:white">
<span id="wizardQuestionHeader">‚ùì Diagnostic Question</span>
</div>
<div class="section-content" style="padding:20px">
<div id="wizardQuestion" style="font-size:16px;font-weight:600;color:#f0f9ff;margin-bottom:20px;line-height:1.5">
Is the effluent turbid throughout the day, or only during peak flows?
</div>
<div id="wizardAnswers" style="display:grid;gap:10px">
<!-- Answers will be populated dynamically -->
</div>
</div>
</div>

<!-- Navigation -->
<div style="display:flex;gap:12px;margin-bottom:16px">
<button id="wizardBackBtn" onclick="wizardBack()" style="flex:1;background:linear-gradient(135deg,#475569,#64748b);border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px;display:none">‚Üê Back</button>
<button id="wizardSkipBtn" onclick="wizardSkip()" style="flex:1;background:linear-gradient(135deg,#6366f1,#8b5cf6);border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px">Skip to Diagnosis ‚Üí</button>
</div>

</div>

<!-- Diagnosis Results (Hidden by default) -->
<div id="troubleshootResults" style="display:none">

<!-- Diagnosis Header -->
<div id="diagnosisHeader" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:20px;border-radius:12px;margin-bottom:16px;color:white">
<div style="display:flex;align-items:center;gap:12px">
<div id="diagnosisIcon" style="width:50px;height:50px;background:rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px">üéØ</div>
<div>
<div style="font-size:16px;font-weight:600;opacity:0.9">Root Cause Identified</div>
<div id="diagnosisTitle" style="font-size:18px;font-weight:700;margin-top:4px">Diagnosis will appear here</div>
</div>
</div>
</div>

<!-- Confidence Score -->
<div style="background:#1e293b;border-radius:12px;padding:16px;margin-bottom:16px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
<span style="color:#94a3b8;font-size:13px">Diagnosis Confidence</span>
<span id="confidenceValue" style="color:#4ade80;font-weight:700;font-size:18px">0%</span>
</div>
<div style="background:#0f172a;border-radius:8px;height:10px;overflow:hidden">
<div id="confidenceBar" style="background:linear-gradient(90deg,#22c55e,#4ade80);height:100%;width:0%"></div>
</div>
</div>

<!-- Action Cards -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:16px">

<!-- Immediate Actions (1-24 hrs) -->
<div class="section" style="border:2px solid #ef4444;margin:0">
<div class="section-h" style="background:linear-gradient(135deg,#dc2626,#ef4444);color:white">
<span>üö® Immediate Actions (1-24 hrs)</span>
</div>
<div class="section-content" style="padding:16px;color:#f0f9ff">
<div id="immediateActions" style="color:#f0f9ff">
<span style="color:#94a3b8">Loading actions...</span>
</div>
</div>
</div>

<!-- Short-term Fixes (1-7 days) -->
<div class="section" style="border:2px solid #f59e0b;margin:0">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white">
<span>‚ö° Short-term Fixes (1-7 days)</span>
</div>
<div class="section-content" style="padding:16px;color:#f0f9ff">
<div id="shortTermActions" style="color:#f0f9ff">
<span style="color:#94a3b8">Loading actions...</span>
</div>
</div>
</div>

<!-- Long-term Solutions -->
<div class="section" style="border:2px solid #22c55e;margin:0">
<div class="section-h" style="background:linear-gradient(135deg,#16a34a,#22c55e);color:white">
<span>üéØ Long-term Solutions</span>
</div>
<div class="section-content" style="padding:16px;color:#f0f9ff">
<div id="longTermActions" style="color:#f0f9ff">
<span style="color:#94a3b8">Loading actions...</span>
</div>
</div>
</div>

</div>

<!-- Related Calculators -->
<div class="section" style="border:2px solid #6366f1;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#4f46e5,#6366f1);color:white">
<span>üßÆ Related Calculators</span>
</div>
<div class="section-content" style="padding:16px">
<div id="relatedCalculators" style="display:flex;flex-wrap:wrap;gap:10px">
<!-- Populated dynamically -->
</div>
</div>
</div>

<!-- Buttons -->
<div style="display:flex;gap:12px">
<button onclick="resetTroubleshootWizard()" style="flex:1;background:linear-gradient(135deg,#3b82f6,#60a5fa);border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px">üîÑ Diagnose Another Problem</button>
<button onclick="printDiagnosis()" style="flex:1;background:linear-gradient(135deg,#10b981,#34d399);border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px">üñ®Ô∏è Print Diagnosis</button>
<button onclick="saveDiagnosisLog()" style="flex:1;background:linear-gradient(135deg,#8b5cf6,#a78bfa);border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px">üíæ Save to Log</button>
</div>

</div>

<!-- Troubleshooting History -->
<div class="section" style="border:2px solid #475569;margin-top:20px">
<div class="section-h" style="background:linear-gradient(135deg,#334155,#475569);color:white;display:flex;justify-content:space-between;align-items:center">
<span>üìã Recent Troubleshooting History</span>
<button onclick="clearTroubleshootHistory()" style="background:rgba(239,68,68,0.2);border:none;padding:4px 10px;border-radius:6px;color:#fca5a5;font-size:11px;cursor:pointer">Clear History</button>
</div>
<div class="section-content" style="padding:16px">
<div id="troubleshootHistory" style="max-height:200px;overflow-y:auto">
<div style="text-align:center;color:#64748b;padding:20px;font-size:13px">
No troubleshooting history yet. Complete a diagnosis to save it here.
</div>
</div>
</div>
</div>

</div>
</div><!-- END troubleshoot panel -->

<!-- ========== PROCESS SIMULATIONS PANEL ========== -->
<div class="panel" id="simulations">
<div style="background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%);padding:16px 20px;border-radius:12px;margin-bottom:16px;color:white">
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
<div>
<h2 style="margin:0;font-size:22px;display:flex;align-items:center;gap:10px">
üîÆ Process Simulations
<span style="background:rgba(255,255,255,0.2);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700">20 SCENARIOS</span>
</h2>
<p style="margin:6px 0 0 0;opacity:0.9;font-size:13px">"What happens if..." - Predict process changes before you make them</p>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button onclick="switchPanel('troubleshoot')" style="background:rgba(255,255,255,0.2);border:none;padding:8px 16px;border-radius:8px;color:white;font-weight:600;cursor:pointer;font-size:12px">‚Üê Back to Troubleshoot</button>
<button onclick="resetSimulation()" style="background:linear-gradient(135deg,#dc2626,#f97316);border:none;padding:8px 16px;border-radius:8px;color:white;font-weight:600;cursor:pointer;font-size:12px">üîÑ Reset</button>
</div>
</div>
</div>

<!-- Simulation Categories -->
<div id="simulationCategories">

<!-- Quick Scenario Cards -->
<div style="margin-bottom:20px">
<h3 style="color:#f0f9ff;margin-bottom:12px;font-size:16px">‚ö° Quick Scenarios</h3>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px">

<button onclick="runSimulation('ras_increase')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(249,115,22,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üîÑ</div>
<div style="color:#fb923c;font-weight:700;font-size:14px">Increase RAS 50%</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Impact on SRT & blanket</div>
</button>

<button onclick="runSimulation('ras_decrease')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(249,115,22,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üîÉ</div>
<div style="color:#fb923c;font-weight:700;font-size:14px">Decrease RAS 50%</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Blanket buildup risk</div>
</button>

<button onclick="runSimulation('do_low')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(59,130,246,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üí®</div>
<div style="color:#60a5fa;font-weight:700;font-size:14px">DO Drops to 1.0</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Nitrification impact</div>
</button>

<button onclick="runSimulation('do_high')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(59,130,246,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üå¨Ô∏è</div>
<div style="color:#60a5fa;font-weight:700;font-size:14px">DO Increases to 4.0</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Energy & pin floc risk</div>
</button>

<button onclick="runSimulation('stop_wasting')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(139,92,246,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üóëÔ∏è</div>
<div style="color:#a78bfa;font-weight:700;font-size:14px">Stop Wasting 3 Days</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">SRT & settling changes</div>
</button>

<button onclick="runSimulation('double_wasting')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(139,92,246,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">‚è´</div>
<div style="color:#a78bfa;font-weight:700;font-size:14px">Double Wasting Rate</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Rapid SRT decrease</div>
</button>

<button onclick="runSimulation('storm_flow')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(6,182,212,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üåä</div>
<div style="color:#22d3ee;font-weight:700;font-size:14px">Flow Doubles (Storm)</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Hydraulic overload</div>
</button>

<button onclick="runSimulation('flow_decrease')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(6,182,212,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üìâ</div>
<div style="color:#22d3ee;font-weight:700;font-size:14px">Flow Drops 50%</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Extended detention</div>
</button>

<button onclick="runSimulation('temp_drop')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(239,68,68,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üå°Ô∏è</div>
<div style="color:#f87171;font-weight:700;font-size:14px">Temp Drops 10¬∞C</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Winter operation</div>
</button>

<button onclick="runSimulation('temp_rise')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(239,68,68,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üî•</div>
<div style="color:#f87171;font-weight:700;font-size:14px">Temp Rises 10¬∞C</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Summer operation</div>
</button>

<button onclick="runSimulation('ph_drop')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(234,179,8,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">‚öóÔ∏è</div>
<div style="color:#facc15;font-weight:700;font-size:14px">pH Drops to 6.5</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Nitrification inhibition</div>
</button>

<button onclick="runSimulation('ph_rise')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(234,179,8,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üß™</div>
<div style="color:#facc15;font-weight:700;font-size:14px">pH Rises to 8.5</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Ammonia toxicity risk</div>
</button>

<button onclick="runSimulation('toxic_slug')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(220,38,38,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">‚ò†Ô∏è</div>
<div style="color:#ef4444;font-weight:700;font-size:14px">Toxic Slug Load</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Biology upset</div>
</button>

<button onclick="runSimulation('bod_spike')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(220,38,38,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üìà</div>
<div style="color:#ef4444;font-weight:700;font-size:14px">BOD Doubles</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Organic overload</div>
</button>

<button onclick="runSimulation('mlss_high')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(34,197,94,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üß´</div>
<div style="color:#4ade80;font-weight:700;font-size:14px">MLSS to 5000 mg/L</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">High solids operation</div>
</button>

<button onclick="runSimulation('mlss_low')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(34,197,94,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üíß</div>
<div style="color:#4ade80;font-weight:700;font-size:14px">MLSS to 1500 mg/L</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Low solids operation</div>
</button>

<button onclick="runSimulation('blower_fail')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(168,85,247,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">‚ö†Ô∏è</div>
<div style="color:#c084fc;font-weight:700;font-size:14px">Blower Failure</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">50% aeration loss</div>
</button>

<button onclick="runSimulation('clarifier_offline')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(168,85,247,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üîß</div>
<div style="color:#c084fc;font-weight:700;font-size:14px">Clarifier Offline</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">1 of 2 out of service</div>
</button>

<button onclick="runSimulation('ammonia_spike')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(16,185,129,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">üß¨</div>
<div style="color:#34d399;font-weight:700;font-size:14px">Ammonia Doubles</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Nitrifier demand</div>
</button>

<button onclick="runSimulation('sludge_age')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:14px;padding:16px;border:2px solid rgba(16,185,129,0.4);cursor:pointer;text-align:left;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:8px">‚è±Ô∏è</div>
<div style="color:#34d399;font-weight:700;font-size:14px">SRT to 30 Days</div>
<div style="color:#94a3b8;font-size:11px;margin-top:4px">Extended aeration</div>
</button>

</div>
</div>

<!-- Custom Simulation Builder -->
<div class="section" style="border:2px solid #6366f1;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#4f46e5,#6366f1);color:white">
<span>üõ†Ô∏è Custom Simulation Builder</span>
</div>
<div class="section-content" style="padding:16px">

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:16px">

<!-- Current Conditions -->
<div style="background:rgba(30,41,59,0.5);border-radius:10px;padding:14px">
<div style="color:#94a3b8;font-size:12px;margin-bottom:10px;font-weight:600">üìä CURRENT CONDITIONS</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">Flow (MGD)</label>
<input type="number" id="sim_current_flow" value="3.5" step="0.1" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">MLSS (mg/L)</label>
<input type="number" id="sim_current_mlss" value="3000" step="100" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">DO (mg/L)</label>
<input type="number" id="sim_current_do" value="2.0" step="0.1" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">Temperature (¬∞C)</label>
<input type="number" id="sim_current_temp" value="20" step="1" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">SRT (days)</label>
<input type="number" id="sim_current_srt" value="12" step="1" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">RAS Rate (%)</label>
<input type="number" id="sim_current_ras" value="50" step="5" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">pH</label>
<input type="number" id="sim_current_ph" value="7.2" step="0.1" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:0">
<label style="font-size:12px">Influent BOD (mg/L)</label>
<input type="number" id="sim_current_bod" value="200" step="10" style="font-size:13px">
</div>
</div>

<!-- Proposed Changes -->
<div style="background:rgba(99,102,241,0.1);border-radius:10px;padding:14px;border:1px solid rgba(99,102,241,0.3)">
<div style="color:#a5b4fc;font-size:12px;margin-bottom:10px;font-weight:600">üîÑ PROPOSED CHANGES</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">New Flow (MGD)</label>
<input type="number" id="sim_new_flow" value="3.5" step="0.1" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">New MLSS (mg/L)</label>
<input type="number" id="sim_new_mlss" value="3000" step="100" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">New DO (mg/L)</label>
<input type="number" id="sim_new_do" value="2.0" step="0.1" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">New Temperature (¬∞C)</label>
<input type="number" id="sim_new_temp" value="20" step="1" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">New SRT (days)</label>
<input type="number" id="sim_new_srt" value="12" step="1" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">New RAS Rate (%)</label>
<input type="number" id="sim_new_ras" value="50" step="5" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:8px">
<label style="font-size:12px">New pH</label>
<input type="number" id="sim_new_ph" value="7.2" step="0.1" style="font-size:13px">
</div>
<div class="input-group" style="margin-bottom:0">
<label style="font-size:12px">New Influent BOD (mg/L)</label>
<input type="number" id="sim_new_bod" value="200" step="10" style="font-size:13px">
</div>
</div>

</div>

<button onclick="runCustomSimulation()" style="width:100%;background:linear-gradient(135deg,#4f46e5,#6366f1);border:none;padding:14px;border-radius:10px;color:white;font-weight:700;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px">
üîÆ Run Custom Simulation
</button>

</div>
</div>

</div>

<!-- Simulation Results Panel -->
<div id="simulationResults" style="display:none">

<!-- Results Header -->
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
<button onclick="resetSimulation()" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);border:none;padding:10px 20px;border-radius:8px;color:white;font-weight:600;cursor:pointer;font-size:14px">
‚Üê Back to Scenarios
</button>
<div id="simScenarioTitle" style="color:#f0f9ff;font-size:18px;font-weight:700">Simulation Results</div>
</div>

<!-- Overall Risk Assessment -->
<div id="simRiskBanner" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:20px;border-radius:12px;margin-bottom:16px">
<div style="display:flex;align-items:center;gap:16px">
<div id="simRiskIcon" style="font-size:48px">‚ö†Ô∏è</div>
<div>
<div id="simRiskLevel" style="font-size:22px;font-weight:700;color:white">HIGH RISK</div>
<div id="simRiskSummary" style="font-size:14px;color:rgba(255,255,255,0.9);margin-top:4px">Multiple process parameters will be affected</div>
</div>
</div>
</div>

<!-- Time to Impact -->
<div style="background:#1e293b;border-radius:12px;padding:16px;margin-bottom:16px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div style="color:#94a3b8;font-size:12px">‚è±Ô∏è TIME TO NOTICEABLE IMPACT</div>
<div id="simTimeToImpact" style="color:#fbbf24;font-size:24px;font-weight:700;margin-top:4px">2-6 hours</div>
</div>
<div>
<div style="color:#94a3b8;font-size:12px">üîÑ RECOVERY TIME</div>
<div id="simRecoveryTime" style="color:#4ade80;font-size:24px;font-weight:700;margin-top:4px">1-3 days</div>
</div>
</div>
</div>

<!-- Parameter Changes Grid -->
<div class="section" style="border:2px solid #3b82f6;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#2563eb,#3b82f6);color:white">
<span>üìä Parameter Impact Analysis</span>
</div>
<div class="section-content" style="padding:0">
<div id="simParameterChanges" style="overflow-x:auto">
<!-- Populated by JavaScript -->
</div>
</div>
</div>

<!-- Cascading Effects -->
<div class="section" style="border:2px solid #f59e0b;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white">
<span>üîó Cascading Effects Timeline</span>
</div>
<div class="section-content" style="padding:16px">
<div id="simCascadingEffects">
<!-- Populated by JavaScript -->
</div>
</div>
</div>

<!-- Process Risks -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:16px">

<!-- Compliance Risk -->
<div class="section" style="border:2px solid #ef4444;margin:0">
<div class="section-h" style="background:linear-gradient(135deg,#dc2626,#ef4444);color:white">
<span>üìã Compliance Risk</span>
</div>
<div class="section-content" style="padding:16px">
<div id="simComplianceRisk">
<!-- Populated by JavaScript -->
</div>
</div>
</div>

<!-- Operational Risk -->
<div class="section" style="border:2px solid #f59e0b;margin:0">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white">
<span>‚öôÔ∏è Operational Risk</span>
</div>
<div class="section-content" style="padding:16px">
<div id="simOperationalRisk">
<!-- Populated by JavaScript -->
</div>
</div>
</div>

<!-- Biology Risk -->
<div class="section" style="border:2px solid #8b5cf6;margin:0">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);color:white">
<span>ü¶† Biology Risk</span>
</div>
<div class="section-content" style="padding:16px">
<div id="simBiologyRisk">
<!-- Populated by JavaScript -->
</div>
</div>
</div>

</div>

<!-- Recommended Actions -->
<div class="section" style="border:2px solid #22c55e;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#16a34a,#22c55e);color:white">
<span>‚úÖ Recommended Actions</span>
</div>
<div class="section-content" style="padding:16px">
<div id="simRecommendations">
<!-- Populated by JavaScript -->
</div>
</div>
</div>

<!-- Monitoring Points -->
<div class="section" style="border:2px solid #06b6d4;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#0891b2,#06b6d4);color:white">
<span>üëÅÔ∏è Key Monitoring Points</span>
</div>
<div class="section-content" style="padding:16px">
<div id="simMonitoring">
<!-- Populated by JavaScript -->
</div>
</div>
</div>

<!-- Related Calculators -->
<div class="section" style="border:2px solid #6366f1;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#4f46e5,#6366f1);color:white">
<span>üßÆ Related Calculators</span>
</div>
<div class="section-content" style="padding:16px">
<div id="simCalculators" style="display:flex;flex-wrap:wrap;gap:10px">
<!-- Populated by JavaScript -->
</div>
</div>
</div>

<!-- Action Buttons -->
<div style="display:flex;gap:12px;flex-wrap:wrap">
<button onclick="printSimulation()" style="flex:1;min-width:140px;background:linear-gradient(135deg,#10b981,#34d399);border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px">üñ®Ô∏è Print Report</button>
<button onclick="saveSimulation()" style="flex:1;min-width:140px;background:linear-gradient(135deg,#8b5cf6,#a78bfa);border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px">üíæ Save Simulation</button>
<button onclick="shareSimulation()" style="flex:1;min-width:140px;background:linear-gradient(135deg,#06b6d4,#22d3ee);border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px">üì§ Export Data</button>
</div>

</div>

<!-- Simulation History -->
<div class="section" style="border:2px solid #475569;margin-top:20px">
<div class="section-h" style="background:linear-gradient(135deg,#334155,#475569);color:white;display:flex;justify-content:space-between;align-items:center">
<span>üìú Recent Simulations</span>
<button onclick="clearSimulationHistory()" style="background:rgba(239,68,68,0.2);border:none;padding:4px 10px;border-radius:6px;color:#fca5a5;font-size:11px;cursor:pointer">Clear</button>
</div>
<div class="section-content" style="padding:16px">
<div id="simulationHistory" style="max-height:200px;overflow-y:auto">
<div style="text-align:center;color:#64748b;padding:20px;font-size:13px">
No simulations run yet. Select a scenario above to begin.
</div>
</div>
</div>
</div>

</div>
</div><!-- END simulations panel -->

<!-- ========== TEXAS CERTIFICATION PRACTICE TESTS PANEL ========== -->
<div class="panel" id="certification">
<div style="background:linear-gradient(135deg,#059669 0%,#10b981 100%);padding:16px 20px;border-radius:12px;margin-bottom:16px;color:white">
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
<div>
<h2 style="margin:0;font-size:22px;display:flex;align-items:center;gap:10px">
üìú Texas TCEQ Certification Prep
<span style="background:rgba(255,255,255,0.2);padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700">CLASS D-C-B-A</span>
</h2>
<p style="margin:6px 0 0 0;opacity:0.9;font-size:13px">Practice tests for Texas Wastewater Operator Certification Exams</p>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button onclick="showCertStats()" style="background:rgba(255,255,255,0.2);border:none;padding:8px 16px;border-radius:8px;color:white;font-weight:600;cursor:pointer;font-size:12px">üìä My Progress</button>
</div>
</div>
</div>

<!-- Certification Level Selection -->
<div id="certLevelSelect">

<!-- Class Level Cards -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px">

<!-- Class D -->
<div onclick="selectCertLevel('D')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;border:2px solid rgba(34,197,94,0.4);cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 10px 30px rgba(34,197,94,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
<span style="font-size:36px">üå±</span>
<span style="background:#22c55e;color:white;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700">ENTRY</span>
</div>
<div style="font-size:20px;font-weight:700;color:#4ade80;margin-bottom:4px">Class D</div>
<div style="font-size:12px;color:#94a3b8;margin-bottom:12px">Entry Level Operator</div>
<div style="font-size:11px;color:#64748b">
<div>‚Ä¢ Basic plant operations</div>
<div>‚Ä¢ Safety fundamentals</div>
<div>‚Ä¢ Simple calculations</div>
</div>
<div id="certProgressD" style="margin-top:12px;background:#1e293b;border-radius:8px;padding:8px;text-align:center">
<span style="color:#94a3b8;font-size:11px">No tests taken yet</span>
</div>
</div>

<!-- Class C -->
<div onclick="selectCertLevel('C')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;border:2px solid rgba(59,130,246,0.4);cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 10px 30px rgba(59,130,246,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
<span style="font-size:36px">üìò</span>
<span style="background:#3b82f6;color:white;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700">INTERMEDIATE</span>
</div>
<div style="font-size:20px;font-weight:700;color:#60a5fa;margin-bottom:4px">Class C</div>
<div style="font-size:12px;color:#94a3b8;margin-bottom:12px">Intermediate Operator</div>
<div style="font-size:11px;color:#64748b">
<div>‚Ä¢ Process control basics</div>
<div>‚Ä¢ Lab procedures</div>
<div>‚Ä¢ Intermediate math</div>
</div>
<div id="certProgressC" style="margin-top:12px;background:#1e293b;border-radius:8px;padding:8px;text-align:center">
<span style="color:#94a3b8;font-size:11px">No tests taken yet</span>
</div>
</div>

<!-- Class B -->
<div onclick="selectCertLevel('B')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;border:2px solid rgba(249,115,22,0.4);cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 10px 30px rgba(249,115,22,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
<span style="font-size:36px">üìô</span>
<span style="background:#f97316;color:white;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700">ADVANCED</span>
</div>
<div style="font-size:20px;font-weight:700;color:#fb923c;margin-bottom:4px">Class B</div>
<div style="font-size:12px;color:#94a3b8;margin-bottom:12px">Advanced Operator</div>
<div style="font-size:11px;color:#64748b">
<div>‚Ä¢ Supervisor responsibilities</div>
<div>‚Ä¢ Advanced process control</div>
<div>‚Ä¢ Complex calculations</div>
</div>
<div id="certProgressB" style="margin-top:12px;background:#1e293b;border-radius:8px;padding:8px;text-align:center">
<span style="color:#94a3b8;font-size:11px">No tests taken yet</span>
</div>
</div>

<!-- Class A -->
<div onclick="selectCertLevel('A')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:16px;padding:20px;border:2px solid rgba(168,85,247,0.4);cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='translateY(-3px)';this.style.boxShadow='0 10px 30px rgba(168,85,247,0.3)'" onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='none'">
<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
<span style="font-size:36px">üëë</span>
<span style="background:#a855f7;color:white;padding:4px 10px;border-radius:8px;font-size:11px;font-weight:700">EXPERT</span>
</div>
<div style="font-size:20px;font-weight:700;color:#c084fc;margin-bottom:4px">Class A</div>
<div style="font-size:12px;color:#94a3b8;margin-bottom:12px">Chief Operator</div>
<div style="font-size:11px;color:#64748b">
<div>‚Ä¢ Full plant management</div>
<div>‚Ä¢ Regulatory compliance</div>
<div>‚Ä¢ All calculations</div>
</div>
<div id="certProgressA" style="margin-top:12px;background:#1e293b;border-radius:8px;padding:8px;text-align:center">
<span style="color:#94a3b8;font-size:11px">No tests taken yet</span>
</div>
</div>

</div>

<!-- Topic Selection -->
<div class="section" style="border:2px solid #10b981">
<div class="section-h" style="background:linear-gradient(135deg,#059669,#10b981);color:white">
<span>üìö Study by Topic</span>
</div>
<div class="section-content" style="padding:16px">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px">

<button onclick="startTopicQuiz('math')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid rgba(234,179,8,0.3);border-radius:12px;padding:14px;cursor:pointer;text-align:center;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:6px">üî¢</div>
<div style="font-size:13px;font-weight:600;color:#fcd34d">Math</div>
<div style="font-size:10px;color:#64748b;margin-top:2px">Calculations & Formulas</div>
</button>

<button onclick="startTopicQuiz('biology')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid rgba(34,197,94,0.3);border-radius:12px;padding:14px;cursor:pointer;text-align:center;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:6px">ü¶†</div>
<div style="font-size:13px;font-weight:600;color:#4ade80">Biology</div>
<div style="font-size:10px;color:#64748b;margin-top:2px">Microbiology & BOD</div>
</button>

<button onclick="startTopicQuiz('chemistry')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid rgba(139,92,246,0.3);border-radius:12px;padding:14px;cursor:pointer;text-align:center;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:6px">‚öóÔ∏è</div>
<div style="font-size:13px;font-weight:600;color:#a78bfa">Chemistry</div>
<div style="font-size:10px;color:#64748b;margin-top:2px">pH, Chlorine, Nutrients</div>
</button>

<button onclick="startTopicQuiz('hydraulics')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid rgba(6,182,212,0.3);border-radius:12px;padding:14px;cursor:pointer;text-align:center;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:6px">üíß</div>
<div style="font-size:13px;font-weight:600;color:#22d3ee">Hydraulics</div>
<div style="font-size:10px;color:#64748b;margin-top:2px">Flow, Pumps, Head</div>
</button>

<button onclick="startTopicQuiz('safety')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid rgba(239,68,68,0.3);border-radius:12px;padding:14px;cursor:pointer;text-align:center;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:6px">‚ö†Ô∏è</div>
<div style="font-size:13px;font-weight:600;color:#f87171">Safety</div>
<div style="font-size:10px;color:#64748b;margin-top:2px">LOTO, Confined Space</div>
</button>

<button onclick="startTopicQuiz('regulations')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid rgba(249,115,22,0.3);border-radius:12px;padding:14px;cursor:pointer;text-align:center;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:6px">üìã</div>
<div style="font-size:13px;font-weight:600;color:#fb923c">TCEQ Regs</div>
<div style="font-size:10px;color:#64748b;margin-top:2px">Rules & Compliance</div>
</button>

<button onclick="startTopicQuiz('operations')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid rgba(99,102,241,0.3);border-radius:12px;padding:14px;cursor:pointer;text-align:center;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:6px">‚öôÔ∏è</div>
<div style="font-size:13px;font-weight:600;color:#818cf8">Operations</div>
<div style="font-size:10px;color:#64748b;margin-top:2px">Daily Plant Ops</div>
</button>

<button onclick="startTopicQuiz('solids')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid rgba(161,98,7,0.3);border-radius:12px;padding:14px;cursor:pointer;text-align:center;transition:all 0.2s">
<div style="font-size:24px;margin-bottom:6px">üóëÔ∏è</div>
<div style="font-size:13px;font-weight:600;color:#fbbf24">Solids</div>
<div style="font-size:10px;color:#64748b;margin-top:2px">Sludge & Biosolids</div>
</button>

</div>
</div>
</div>

<!-- Quick Actions -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:16px">
<button onclick="startFullExam()" style="background:linear-gradient(135deg,#059669,#10b981);border:none;padding:16px;border-radius:12px;color:white;font-weight:700;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px">
üìù Start Full Practice Exam
</button>
<button onclick="startQuickQuiz()" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);border:none;padding:16px;border-radius:12px;color:white;font-weight:700;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px">
‚ö° Quick 10-Question Quiz
</button>
<button onclick="reviewMissed()" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);border:none;padding:16px;border-radius:12px;color:white;font-weight:700;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px">
üîÑ Review Missed Questions
</button>
</div>

</div>

<!-- Test Mode Interface -->
<div id="certTestMode" style="display:none">

<!-- Test Header -->
<div style="background:linear-gradient(135deg,#1e293b,#0f172a);border-radius:12px;padding:16px;margin-bottom:16px;border:2px solid #334155">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
<div>
<span id="certTestTitle" style="font-size:18px;font-weight:700;color:#f0f9ff">Class D Practice Exam</span>
<span id="certTestMode" style="background:#3b82f6;color:white;padding:3px 10px;border-radius:6px;font-size:11px;margin-left:10px">STUDY MODE</span>
</div>
<div style="display:flex;align-items:center;gap:16px">
<div style="text-align:center">
<div style="font-size:11px;color:#64748b">Question</div>
<div style="font-size:20px;font-weight:700;color:#60a5fa"><span id="certCurrentQ">1</span>/<span id="certTotalQ">50</span></div>
</div>
<div style="text-align:center">
<div style="font-size:11px;color:#64748b">Score</div>
<div style="font-size:20px;font-weight:700;color:#4ade80"><span id="certScore">0</span>%</div>
</div>
<div id="certTimerBox" style="text-align:center;display:none">
<div style="font-size:11px;color:#64748b">Time Left</div>
<div id="certTimer" style="font-size:20px;font-weight:700;color:#fbbf24">60:00</div>
</div>
</div>
</div>
<div style="margin-top:12px;background:#0f172a;border-radius:8px;height:8px;overflow:hidden">
<div id="certProgressBar" style="height:100%;background:linear-gradient(90deg,#22c55e,#4ade80);width:0%;transition:width 0.3s"></div>
</div>
</div>

<!-- Question Card -->
<div class="section" style="border:2px solid #3b82f6;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:white;display:flex;justify-content:space-between;align-items:center">
<span id="certQuestionTopic">üìö Topic: General Operations</span>
<span id="certQuestionDifficulty" style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:6px;font-size:11px">MEDIUM</span>
</div>
<div class="section-content" style="padding:20px">
<div id="certQuestionText" style="font-size:16px;color:#f0f9ff;line-height:1.6;margin-bottom:20px">
Loading question...
</div>

<!-- Answer Options -->
<div id="certAnswerOptions" style="display:flex;flex-direction:column;gap:10px">
<!-- Populated by JavaScript -->
</div>

<!-- Explanation (shown after answering in study mode) -->
<div id="certExplanation" style="display:none;margin-top:20px;padding:16px;background:rgba(34,197,94,0.1);border-radius:10px;border-left:4px solid #22c55e">
<div style="font-weight:600;color:#4ade80;margin-bottom:8px">üí° Explanation</div>
<div id="certExplanationText" style="color:#94a3b8;font-size:14px;line-height:1.5"></div>
</div>
</div>
</div>

<!-- Navigation Buttons -->
<div style="display:flex;gap:12px;flex-wrap:wrap">
<button onclick="certPrevQuestion()" id="certPrevBtn" style="flex:1;min-width:120px;background:#475569;border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px" disabled>‚Üê Previous</button>
<button onclick="certSkipQuestion()" style="flex:1;min-width:120px;background:#64748b;border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px">Skip ‚Üí</button>
<button onclick="certNextQuestion()" id="certNextBtn" style="flex:1;min-width:120px;background:linear-gradient(135deg,#3b82f6,#60a5fa);border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px">Next ‚Üí</button>
<button onclick="certEndTest()" style="flex:1;min-width:120px;background:linear-gradient(135deg,#ef4444,#f87171);border:none;padding:14px;border-radius:10px;color:white;font-weight:600;cursor:pointer;font-size:14px">End Test</button>
</div>

<!-- Question Navigator -->
<div class="section" style="border:2px solid #334155;margin-top:16px">
<div class="section-h" style="background:#1e293b;color:#94a3b8">
<span>üóÇÔ∏è Question Navigator</span>
</div>
<div class="section-content" style="padding:12px">
<div id="certQuestionNav" style="display:flex;flex-wrap:wrap;gap:6px;max-height:120px;overflow-y:auto">
<!-- Populated by JavaScript -->
</div>
<div style="display:flex;gap:16px;margin-top:12px;font-size:11px;color:#64748b">
<span>‚¨ú Unanswered</span>
<span style="color:#4ade80">üü© Correct</span>
<span style="color:#f87171">üü• Incorrect</span>
<span style="color:#fbbf24">üü® Skipped</span>
</div>
</div>
</div>

</div>

<!-- Test Results -->
<div id="certResults" style="display:none">

<div style="text-align:center;padding:30px;background:linear-gradient(135deg,#1e293b,#0f172a);border-radius:16px;margin-bottom:20px;border:2px solid #334155">
<div id="certResultIcon" style="font-size:64px;margin-bottom:16px">üéâ</div>
<div id="certResultTitle" style="font-size:28px;font-weight:700;color:#4ade80;margin-bottom:8px">Congratulations!</div>
<div id="certResultSubtitle" style="font-size:16px;color:#94a3b8">You passed the practice exam</div>

<div style="display:flex;justify-content:center;gap:30px;margin-top:24px">
<div style="text-align:center">
<div style="font-size:42px;font-weight:700;color:#60a5fa" id="certFinalScore">85%</div>
<div style="font-size:12px;color:#64748b">Final Score</div>
</div>
<div style="text-align:center">
<div style="font-size:42px;font-weight:700;color:#4ade80" id="certCorrectCount">43</div>
<div style="font-size:12px;color:#64748b">Correct</div>
</div>
<div style="text-align:center">
<div style="font-size:42px;font-weight:700;color:#f87171" id="certIncorrectCount">7</div>
<div style="font-size:12px;color:#64748b">Incorrect</div>
</div>
<div style="text-align:center">
<div style="font-size:42px;font-weight:700;color:#fbbf24" id="certTimeSpent">45:32</div>
<div style="font-size:12px;color:#64748b">Time</div>
</div>
</div>
</div>

<!-- Performance by Topic -->
<div class="section" style="border:2px solid #3b82f6;margin-bottom:16px">
<div class="section-h" style="background:linear-gradient(135deg,#1d4ed8,#3b82f6);color:white">
<span>üìä Performance by Topic</span>
</div>
<div class="section-content" style="padding:16px">
<div id="certTopicBreakdown">
<!-- Populated by JavaScript -->
</div>
</div>
</div>

<!-- Action Buttons -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px">
<button onclick="reviewCertTest()" style="background:linear-gradient(135deg,#3b82f6,#60a5fa);border:none;padding:16px;border-radius:12px;color:white;font-weight:700;font-size:14px;cursor:pointer">üìù Review Answers</button>
<button onclick="retakeCertTest()" style="background:linear-gradient(135deg,#f59e0b,#fbbf24);border:none;padding:16px;border-radius:12px;color:white;font-weight:700;font-size:14px;cursor:pointer">üîÑ Retake Test</button>
<button onclick="backToCertHome()" style="background:linear-gradient(135deg,#059669,#10b981);border:none;padding:16px;border-radius:12px;color:white;font-weight:700;font-size:14px;cursor:pointer">üè† Back to Menu</button>
<button onclick="shareCertResults()" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);border:none;padding:16px;border-radius:12px;color:white;font-weight:700;font-size:14px;cursor:pointer">üì§ Share Results</button>
</div>

</div>

<!-- Test History -->
<div class="section" style="border:2px solid #475569;margin-top:20px">
<div class="section-h" style="background:linear-gradient(135deg,#334155,#475569);color:white;display:flex;justify-content:space-between;align-items:center">
<span>üìú Test History</span>
<button onclick="clearCertHistory()" style="background:rgba(239,68,68,0.2);border:none;padding:4px 10px;border-radius:6px;color:#fca5a5;font-size:11px;cursor:pointer">Clear</button>
</div>
<div class="section-content" style="padding:16px">
<div id="certHistory" style="max-height:200px;overflow-y:auto">
<div style="text-align:center;color:#64748b;padding:20px;font-size:13px">
No tests taken yet. Start a practice exam to track your progress!
</div>
</div>
</div>
</div>

</div>
</div><!-- END certification panel -->
<!-- ========== TRAINING & SAFETY PANEL ========== -->
<div id="panel-training" class="panel">

<!-- Panel Header -->
<div style="background:linear-gradient(135deg,#dc2626,#7c3aed);border-radius:16px;padding:24px;margin-bottom:20px;text-align:center">
<div style="font-size:48px;margin-bottom:10px">üéì</div>
<div style="font-size:24px;font-weight:700;color:white">Training & Safety Center</div>
<div style="color:#fecaca;margin-top:8px">OSHA-compliant safety procedures + 70+ curated training videos</div>
<div style="display:flex;justify-content:center;gap:20px;margin-top:16px;flex-wrap:wrap">
<div style="background:rgba(0,0,0,0.2);padding:10px 20px;border-radius:10px">
<div style="font-size:24px;font-weight:700;color:white">8</div>
<div style="font-size:11px;color:#fecaca">Safety Topics</div>
</div>
<div style="background:rgba(0,0,0,0.2);padding:10px 20px;border-radius:10px">
<div style="font-size:24px;font-weight:700;color:white">70+</div>
<div style="font-size:11px;color:#e9d5ff">Videos</div>
</div>
<div style="background:rgba(0,0,0,0.2);padding:10px 20px;border-radius:10px">
<div style="font-size:24px;font-weight:700;color:white">OSHA</div>
<div style="font-size:11px;color:#fecaca">Compliant</div>
</div>
</div>
</div>

<!-- Section Toggle Tabs -->
<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button id="training-tab-safety" onclick="showTrainingSection('safety')" class="btn" style="flex:1;min-width:150px;background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;padding:14px 20px;border-radius:12px;font-weight:700;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;border:2px solid #dc2626">
<span style="font-size:20px">‚ö†Ô∏è</span> Safety Procedures
</button>
<button id="training-tab-videos" onclick="showTrainingSection('videos')" class="btn" style="flex:1;min-width:150px;background:linear-gradient(145deg,#1e293b,#0f172a);color:#c4b5fd;padding:14px 20px;border-radius:12px;font-weight:700;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;border:2px solid #7c3aed">
<span style="font-size:20px">üé¨</span> Video Library
</button>
</div>

<!-- ==================== SAFETY SECTION ==================== -->
<div id="training-safety-section">

<!-- Safety Quick Nav -->
<div id="safety-nav-cards" style="margin-bottom:20px;background:linear-gradient(135deg,rgba(220,38,38,0.1),rgba(239,68,68,0.05));border:1px solid rgba(220,38,38,0.3);border-radius:12px;padding:16px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<span style="font-weight:600;color:#fca5a5;font-size:14px">‚ö° Quick Navigation - Safety</span>
<button onclick="document.getElementById('safety-nav-cards').style.display='none'" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:18px" title="Dismiss">√ó</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px">
<div onclick="scrollToSection('safety-loto')" style="background:linear-gradient(135deg,#dc2626,#b91c1c);padding:12px;border-radius:10px;cursor:pointer;text-align:center;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:20px">üîí</div><div style="font-size:11px;color:white;font-weight:600">LOTO</div>
</div>
<div onclick="scrollToSection('safety-confined')" style="background:linear-gradient(135deg,#ea580c,#c2410c);padding:12px;border-radius:10px;cursor:pointer;text-align:center;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:20px">üöß</div><div style="font-size:11px;color:white;font-weight:600">Confined Space</div>
</div>
<div onclick="scrollToSection('safety-h2s')" style="background:linear-gradient(135deg,#ca8a04,#a16207);padding:12px;border-radius:10px;cursor:pointer;text-align:center;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:20px">‚ò†Ô∏è</div><div style="font-size:11px;color:white;font-weight:600">H‚ÇÇS Awareness</div>
</div>
<div onclick="scrollToSection('safety-ppe')" style="background:linear-gradient(135deg,#2563eb,#1d4ed8);padding:12px;border-radius:10px;cursor:pointer;text-align:center;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:20px">ü¶∫</div><div style="font-size:11px;color:white;font-weight:600">PPE Guide</div>
</div>
<div onclick="scrollToSection('safety-emergency')" style="background:linear-gradient(135deg,#dc2626,#991b1b);padding:12px;border-radius:10px;cursor:pointer;text-align:center;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:20px">üö®</div><div style="font-size:11px;color:white;font-weight:600">Emergency</div>
</div>
<div onclick="scrollToSection('safety-hazcom')" style="background:linear-gradient(135deg,#7c3aed,#6d28d9);padding:12px;border-radius:10px;cursor:pointer;text-align:center;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:20px">‚öóÔ∏è</div><div style="font-size:11px;color:white;font-weight:600">HazCom</div>
</div>
<div onclick="scrollToSection('safety-electrical')" style="background:linear-gradient(135deg,#0891b2,#0e7490);padding:12px;border-radius:10px;cursor:pointer;text-align:center;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:20px">‚ö°</div><div style="font-size:11px;color:white;font-weight:600">Electrical</div>
</div>
<div onclick="scrollToSection('safety-checklists')" style="background:linear-gradient(135deg,#059669,#047857);padding:12px;border-radius:10px;cursor:pointer;text-align:center;transition:transform 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:20px">‚úÖ</div><div style="font-size:11px;color:white;font-weight:600">Checklists</div>
</div>
</div>
</div>

<!-- LOTO Section -->
<div id="safety-loto" class="section" style="border:2px solid #dc2626;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:white">
üîí Lockout/Tagout (LOTO) Procedures
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:10px;font-size:10px;margin-left:10px">OSHA 29 CFR 1910.147</span>
</div>
<div class="section-content" style="padding:20px">
<div style="background:linear-gradient(135deg,rgba(220,38,38,0.1),rgba(185,27,27,0.05));border:1px solid rgba(220,38,38,0.3);border-radius:12px;padding:16px;margin-bottom:20px">
<div style="font-weight:700;color:#fca5a5;margin-bottom:10px">‚ö†Ô∏è Purpose of LOTO</div>
<div style="color:#e2e8f0;font-size:14px;line-height:1.6">
Lockout/Tagout procedures prevent the unexpected startup or release of stored energy during maintenance and servicing activities. At WWTPs, this includes pumps, blowers, mixers, clarifier drives, conveyors, and all electrical equipment.
</div>
</div>
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üìã Standard LOTO Procedure - 8 Steps</div>
<div style="display:grid;gap:12px;margin-bottom:20px">
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border-left:4px solid #22c55e">
<div style="display:flex;align-items:center;gap:12px">
<div style="background:#22c55e;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700">1</div>
<div><div style="font-weight:700;color:#4ade80">Preparation</div><div style="font-size:13px;color:#94a3b8">Identify all energy sources. Review equipment-specific LOTO procedures.</div></div>
</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border-left:4px solid #3b82f6">
<div style="display:flex;align-items:center;gap:12px">
<div style="background:#3b82f6;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700">2</div>
<div><div style="font-weight:700;color:#60a5fa">Notification</div><div style="font-size:13px;color:#94a3b8">Notify all affected employees that equipment will be locked out.</div></div>
</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border-left:4px solid #f59e0b">
<div style="display:flex;align-items:center;gap:12px">
<div style="background:#f59e0b;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700">3</div>
<div><div style="font-weight:700;color:#fbbf24">Equipment Shutdown</div><div style="font-size:13px;color:#94a3b8">Shut down equipment using normal operating controls.</div></div>
</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border-left:4px solid #ec4899">
<div style="display:flex;align-items:center;gap:12px">
<div style="background:#ec4899;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700">4</div>
<div><div style="font-weight:700;color:#f472b6">Isolation</div><div style="font-size:13px;color:#94a3b8">Isolate equipment from ALL energy sources.</div></div>
</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border-left:4px solid #dc2626">
<div style="display:flex;align-items:center;gap:12px">
<div style="background:#dc2626;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700">5</div>
<div><div style="font-weight:700;color:#f87171">Apply LOTO Devices</div><div style="font-size:13px;color:#94a3b8">Apply your personal lock and tag to each energy isolation point.</div></div>
</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border-left:4px solid #8b5cf6">
<div style="display:flex;align-items:center;gap:12px">
<div style="background:#8b5cf6;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700">6</div>
<div><div style="font-weight:700;color:#a78bfa">Release Stored Energy</div><div style="font-size:13px;color:#94a3b8">Bleed air/hydraulic lines, discharge capacitors, release spring tension.</div></div>
</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border-left:4px solid #06b6d4">
<div style="display:flex;align-items:center;gap:12px">
<div style="background:#06b6d4;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700">7</div>
<div><div style="font-weight:700;color:#22d3ee">Verification</div><div style="font-size:13px;color:#94a3b8">Verify isolation by attempting to start equipment. Confirm zero energy state.</div></div>
</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border-left:4px solid #10b981">
<div style="display:flex;align-items:center;gap:12px">
<div style="background:#10b981;color:white;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700">8</div>
<div><div style="font-weight:700;color:#34d399">Perform Work</div><div style="font-size:13px;color:#94a3b8">Equipment is now safe. Keep LOTO in place until ALL work is complete.</div></div>
</div>
</div>
</div>
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üè≠ Common WWTP Equipment LOTO Points</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px">
<div style="font-weight:700;color:#60a5fa;margin-bottom:10px">üíß Pumps</div>
<div style="font-size:12px;color:#94a3b8;line-height:1.6">‚Ä¢ Electrical disconnect (MCC or local)<br>‚Ä¢ Suction/discharge valves<br>‚Ä¢ VFD isolation if equipped</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px">
<div style="font-weight:700;color:#4ade80;margin-bottom:10px">üåÄ Blowers/Aerators</div>
<div style="font-size:12px;color:#94a3b8;line-height:1.6">‚Ä¢ Main electrical disconnect<br>‚Ä¢ Inlet/outlet dampers<br>‚Ä¢ Bleed air pressure</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px">
<div style="font-weight:700;color:#fbbf24;margin-bottom:10px">‚öôÔ∏è Mixers/Flocculators</div>
<div style="font-size:12px;color:#94a3b8;line-height:1.6">‚Ä¢ Motor disconnect<br>‚Ä¢ VFD isolation<br>‚Ä¢ Impeller blocking</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px">
<div style="font-weight:700;color:#f472b6;margin-bottom:10px">üîÑ Clarifier Drives</div>
<div style="font-size:12px;color:#94a3b8;line-height:1.6">‚Ä¢ Main drive motor disconnect<br>‚Ä¢ Rake mechanism blocking<br>‚Ä¢ Skimmer drive isolation</div>
</div>
</div>
</div>
</div>

<!-- Confined Space Section -->
<div id="safety-confined" class="section" style="border:2px solid #ea580c;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#ea580c,#c2410c);color:white">
üöß Confined Space Entry Procedures
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:10px;font-size:10px;margin-left:10px">OSHA 29 CFR 1910.146</span>
</div>
<div class="section-content" style="padding:20px">
<div style="background:linear-gradient(135deg,rgba(234,88,12,0.1),rgba(194,65,12,0.05));border:1px solid rgba(234,88,12,0.3);border-radius:12px;padding:16px;margin-bottom:20px">
<div style="font-weight:700;color:#fb923c;margin-bottom:10px">üìñ What is a Confined Space?</div>
<div style="color:#e2e8f0;font-size:14px;line-height:1.6">
A space that meets ALL THREE criteria: (1) Large enough to enter, (2) Limited entry/exit, (3) NOT designed for continuous occupancy.
</div>
<div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:8px">
<span style="background:rgba(234,88,12,0.2);padding:4px 12px;border-radius:6px;font-size:12px;color:#fed7aa">Wet Wells</span>
<span style="background:rgba(234,88,12,0.2);padding:4px 12px;border-radius:6px;font-size:12px;color:#fed7aa">Manholes</span>
<span style="background:rgba(234,88,12,0.2);padding:4px 12px;border-radius:6px;font-size:12px;color:#fed7aa">Digesters</span>
<span style="background:rgba(234,88,12,0.2);padding:4px 12px;border-radius:6px;font-size:12px;color:#fed7aa">Tanks</span>
<span style="background:rgba(234,88,12,0.2);padding:4px 12px;border-radius:6px;font-size:12px;color:#fed7aa">Vaults</span>
<span style="background:rgba(234,88,12,0.2);padding:4px 12px;border-radius:6px;font-size:12px;color:#fed7aa">Clarifiers (drained)</span>
</div>
</div>
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üå°Ô∏è Atmospheric Testing Limits</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px">
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;text-align:center;border:2px solid #3b82f6">
<div style="font-size:28px;margin-bottom:6px">O‚ÇÇ</div>
<div style="font-weight:700;color:#60a5fa;font-size:16px">19.5-23.5%</div>
<div style="font-size:10px;color:#64748b;margin-top:4px">&lt;19.5% Deficient</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;text-align:center;border:2px solid #ef4444">
<div style="font-size:28px;margin-bottom:6px">LEL</div>
<div style="font-weight:700;color:#f87171;font-size:16px">&lt;10%</div>
<div style="font-size:10px;color:#64748b;margin-top:4px">Exit at 10%</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;text-align:center;border:2px solid #eab308">
<div style="font-size:28px;margin-bottom:6px">H‚ÇÇS</div>
<div style="font-weight:700;color:#fbbf24;font-size:16px">&lt;10 ppm</div>
<div style="font-size:10px;color:#64748b;margin-top:4px">IDLH: 100 ppm</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;text-align:center;border:2px solid #a855f7">
<div style="font-size:28px;margin-bottom:6px">CO</div>
<div style="font-weight:700;color:#c084fc;font-size:16px">&lt;35 ppm</div>
<div style="font-size:10px;color:#64748b;margin-top:4px">IDLH: 1,200 ppm</div>
</div>
</div>
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üìã Entry Permit Requirements</div>
<div id="cse-checklist" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px">
<div style="display:grid;gap:8px;font-size:13px">
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:18px;height:18px"><span style="color:#e2e8f0">Entry Supervisor designated</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:18px;height:18px"><span style="color:#e2e8f0">Attendant assigned (trained, stationed outside)</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:18px;height:18px"><span style="color:#e2e8f0">Atmospheric testing completed and documented</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:18px;height:18px"><span style="color:#e2e8f0">Continuous monitoring in place (4-gas monitor)</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:18px;height:18px"><span style="color:#e2e8f0">Ventilation established if required</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:18px;height:18px"><span style="color:#e2e8f0">Isolation complete (LOTO on all sources)</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:18px;height:18px"><span style="color:#e2e8f0">Rescue equipment ready (tripod, harness, SCBA)</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:18px;height:18px"><span style="color:#e2e8f0">Communication method established</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:18px;height:18px"><span style="color:#e2e8f0">Emergency contacts posted</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:18px;height:18px"><span style="color:#e2e8f0">PPE donned and inspected</span></label>
</div>
</div>
</div>
</div>

<!-- H2S Section -->
<div id="safety-h2s" class="section" style="border:2px solid #ca8a04;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#ca8a04,#a16207);color:white">
‚ò†Ô∏è Hydrogen Sulfide (H‚ÇÇS) Awareness
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:10px;font-size:10px;margin-left:10px">EXTREMELY HAZARDOUS</span>
</div>
<div class="section-content" style="padding:20px">
<div style="background:linear-gradient(135deg,rgba(220,38,38,0.2),rgba(185,27,27,0.1));border:2px solid #dc2626;border-radius:12px;padding:20px;margin-bottom:20px;text-align:center">
<div style="font-size:40px;margin-bottom:8px">‚ò†Ô∏è ‚ö†Ô∏è ‚ò†Ô∏è</div>
<div style="font-size:18px;font-weight:700;color:#fca5a5">H‚ÇÇS IS THE #1 KILLER IN WASTEWATER</div>
<div style="color:#fecaca;margin-top:8px;font-size:13px">Colorless gas - "rotten egg" odor at low levels<br>OLFACTORY FATIGUE above 100 ppm - you can't smell it!</div>
</div>
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üìä H‚ÇÇS Exposure Levels</div>
<div style="overflow-x:auto;margin-bottom:20px">
<table style="width:100%;border-collapse:collapse;font-size:12px">
<tr style="background:linear-gradient(135deg,#ca8a04,#a16207)">
<th style="padding:10px;text-align:left;color:white">Level</th>
<th style="padding:10px;text-align:left;color:white">Effects</th>
<th style="padding:10px;text-align:left;color:white">Action</th>
</tr>
<tr style="background:rgba(34,197,94,0.1)"><td style="padding:10px;border-bottom:1px solid #374151;color:#4ade80;font-weight:700">0.01-0.3 ppm</td><td style="padding:10px;border-bottom:1px solid #374151;color:#e2e8f0">Odor threshold</td><td style="padding:10px;border-bottom:1px solid #374151;color:#94a3b8">Be aware</td></tr>
<tr style="background:rgba(234,179,8,0.1)"><td style="padding:10px;border-bottom:1px solid #374151;color:#fbbf24;font-weight:700">10 ppm</td><td style="padding:10px;border-bottom:1px solid #374151;color:#e2e8f0">OSHA PEL, eye irritation</td><td style="padding:10px;border-bottom:1px solid #374151;color:#94a3b8">Exit, ventilate</td></tr>
<tr style="background:rgba(249,115,22,0.1)"><td style="padding:10px;border-bottom:1px solid #374151;color:#fb923c;font-weight:700">50-100 ppm</td><td style="padding:10px;border-bottom:1px solid #374151;color:#e2e8f0">Severe damage, loss of smell</td><td style="padding:10px;border-bottom:1px solid #374151;color:#94a3b8">Emergency! SCBA required</td></tr>
<tr style="background:rgba(220,38,38,0.15)"><td style="padding:10px;border-bottom:1px solid #374151;color:#ef4444;font-weight:700">100 ppm</td><td style="padding:10px;border-bottom:1px solid #374151;color:#e2e8f0">IDLH - Can't smell it!</td><td style="padding:10px;border-bottom:1px solid #374151;color:#94a3b8">Life-threatening</td></tr>
<tr style="background:rgba(185,28,28,0.2)"><td style="padding:10px;color:#dc2626;font-weight:700">700+ ppm</td><td style="padding:10px;color:#e2e8f0">Immediate death</td><td style="padding:10px;color:#94a3b8">Single breath fatal</td></tr>
</table>
</div>
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üè≠ H‚ÇÇS Sources at WWTPs</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:14px">
<div style="font-weight:700;color:#fbbf24;margin-bottom:6px">üï≥Ô∏è Collection</div>
<div style="font-size:11px;color:#94a3b8">Manholes, wet wells, lift stations</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:14px">
<div style="font-weight:700;color:#fbbf24;margin-bottom:6px">üì• Headworks</div>
<div style="font-size:11px;color:#94a3b8">Screening, grit removal areas</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:14px">
<div style="font-weight:700;color:#fbbf24;margin-bottom:6px">üîÑ Primary</div>
<div style="font-size:11px;color:#94a3b8">Clarifier scum troughs, sludge wells</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:14px">
<div style="font-weight:700;color:#fbbf24;margin-bottom:6px">üß™ Sludge</div>
<div style="font-size:11px;color:#94a3b8">Digesters, belt press, truck loading</div>
</div>
</div>
</div>
</div>

<!-- PPE Section -->
<div id="safety-ppe" class="section" style="border:2px solid #2563eb;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#2563eb,#1d4ed8);color:white">
ü¶∫ Personal Protective Equipment (PPE)
</div>
<div class="section-content" style="padding:20px">
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üìã PPE by Task</div>
<div style="overflow-x:auto;margin-bottom:20px">
<table style="width:100%;border-collapse:collapse;font-size:11px;min-width:600px">
<tr style="background:linear-gradient(135deg,#2563eb,#1d4ed8)">
<th style="padding:8px;text-align:left;color:white">Task</th>
<th style="padding:8px;text-align:center;color:white">üë∑</th>
<th style="padding:8px;text-align:center;color:white">üëì</th>
<th style="padding:8px;text-align:center;color:white">üëÇ</th>
<th style="padding:8px;text-align:center;color:white">üò∑</th>
<th style="padding:8px;text-align:center;color:white">üß§</th>
<th style="padding:8px;text-align:center;color:white">üë¢</th>
</tr>
<tr style="background:rgba(255,255,255,0.03)"><td style="padding:8px;border-bottom:1px solid #374151;color:#e2e8f0">General Plant</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">‚úÖ</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">‚úÖ</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">-</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">-</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">-</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">‚úÖ</td></tr>
<tr style="background:rgba(255,255,255,0.05)"><td style="padding:8px;border-bottom:1px solid #374151;color:#e2e8f0">Blower Room</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">‚úÖ</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">‚úÖ</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151;color:#fbbf24">‚úÖ</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">-</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">-</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">‚úÖ</td></tr>
<tr style="background:rgba(255,255,255,0.03)"><td style="padding:8px;border-bottom:1px solid #374151;color:#e2e8f0">Chemical Feed</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">‚úÖ</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151;color:#fbbf24">Goggles</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">-</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151;color:#fbbf24">APR</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151;color:#fbbf24">Chem</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">‚úÖ</td></tr>
<tr style="background:rgba(239,68,68,0.1)"><td style="padding:8px;border-bottom:1px solid #374151;color:#e2e8f0">Chlorine Room</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">‚úÖ</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151;color:#ef4444">Full</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">-</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151;color:#ef4444">SCBA</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151;color:#fbbf24">Chem</td><td style="padding:8px;text-align:center;border-bottom:1px solid #374151">‚úÖ</td></tr>
<tr style="background:rgba(239,68,68,0.1)"><td style="padding:8px;color:#e2e8f0">Confined Space</td><td style="padding:8px;text-align:center">‚úÖ</td><td style="padding:8px;text-align:center">‚úÖ</td><td style="padding:8px;text-align:center">-</td><td style="padding:8px;text-align:center;color:#ef4444">SCBA</td><td style="padding:8px;text-align:center">‚úÖ</td><td style="padding:8px;text-align:center">‚úÖ</td></tr>
</table>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px">
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:14px">
<div style="font-size:24px;margin-bottom:8px">üë∑</div>
<div style="font-weight:700;color:#60a5fa;margin-bottom:6px">Head</div>
<div style="font-size:11px;color:#94a3b8">Type I/II, Class E (electrical rated)</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:14px">
<div style="font-size:24px;margin-bottom:8px">üëì</div>
<div style="font-weight:700;color:#4ade80;margin-bottom:6px">Eye/Face</div>
<div style="font-size:11px;color:#94a3b8">ANSI Z87.1, side shields</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:14px">
<div style="font-size:24px;margin-bottom:8px">üß§</div>
<div style="font-weight:700;color:#fbbf24;margin-bottom:6px">Hands</div>
<div style="font-size:11px;color:#94a3b8">Match glove to hazard type</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:14px">
<div style="font-size:24px;margin-bottom:8px">üò∑</div>
<div style="font-weight:700;color:#f472b6;margin-bottom:6px">Respiratory</div>
<div style="font-size:11px;color:#94a3b8">Fit testing required</div>
</div>
</div>
</div>
</div>

<!-- Emergency Section -->
<div id="safety-emergency" class="section" style="border:2px solid #dc2626;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#dc2626,#991b1b);color:white">
üö® Emergency Response
</div>
<div class="section-content" style="padding:20px">
<div style="background:linear-gradient(135deg,rgba(220,38,38,0.2),rgba(153,27,27,0.1));border:2px solid #dc2626;border-radius:12px;padding:20px;margin-bottom:20px">
<div style="font-weight:700;color:#fca5a5;margin-bottom:12px;font-size:16px;text-align:center">üìû EMERGENCY CONTACTS</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px">
<div style="background:rgba(0,0,0,0.3);padding:14px;border-radius:10px;text-align:center">
<div style="font-size:12px;color:#94a3b8">Emergency</div>
<div style="font-size:24px;font-weight:700;color:#f87171">911</div>
</div>
<div style="background:rgba(0,0,0,0.3);padding:14px;border-radius:10px;text-align:center">
<div style="font-size:12px;color:#94a3b8">Poison Control</div>
<div style="font-size:18px;font-weight:700;color:#fbbf24">1-800-222-1222</div>
</div>
<div style="background:rgba(0,0,0,0.3);padding:14px;border-radius:10px;text-align:center">
<div style="font-size:12px;color:#94a3b8">CHEMTREC</div>
<div style="font-size:18px;font-weight:700;color:#60a5fa">1-800-424-9300</div>
</div>
</div>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px">
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border:2px solid #ef4444">
<div style="font-size:20px;margin-bottom:8px">üî•</div>
<div style="font-weight:700;color:#f87171;margin-bottom:10px">FIRE</div>
<ol style="margin:0 0 0 16px;padding:0;color:#e2e8f0;font-size:12px;line-height:1.7">
<li>Activate fire alarm</li>
<li>Call 911</li>
<li>Evacuate via nearest exit</li>
<li>Meet at assembly point</li>
<li>Do NOT re-enter</li>
</ol>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border:2px solid #eab308">
<div style="font-size:20px;margin-bottom:8px">‚ò†Ô∏è</div>
<div style="font-weight:700;color:#fbbf24;margin-bottom:10px">CHEMICAL SPILL</div>
<ol style="margin:0 0 0 16px;padding:0;color:#e2e8f0;font-size:12px;line-height:1.7">
<li>Evacuate upwind</li>
<li>Alert others</li>
<li>Identify chemical (SDS)</li>
<li>Don appropriate PPE</li>
<li>Contain if trained</li>
</ol>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;border:2px solid #22c55e">
<div style="font-size:20px;margin-bottom:8px">üè•</div>
<div style="font-weight:700;color:#4ade80;margin-bottom:10px">MEDICAL</div>
<ol style="margin:0 0 0 16px;padding:0;color:#e2e8f0;font-size:12px;line-height:1.7">
<li>Ensure scene is safe</li>
<li>Call 911</li>
<li>Provide first aid if trained</li>
<li>Get AED if cardiac</li>
<li>Stay with victim</li>
</ol>
</div>
</div>
<div style="background:linear-gradient(135deg,rgba(239,68,68,0.1),rgba(220,38,38,0.05));border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:16px;margin-top:16px">
<div style="font-weight:700;color:#f87171;margin-bottom:8px">‚ö†Ô∏è CONFINED SPACE RESCUE</div>
<div style="color:#e2e8f0;font-size:13px"><strong style="color:#fca5a5">NEVER enter without SCBA and retrieval equipment!</strong> Most fatalities are would-be rescuers. Call for help, use retrieval system from outside, wait for trained rescue team.</div>
</div>
</div>
</div>

<!-- HazCom Section -->
<div id="safety-hazcom" class="section" style="border:2px solid #7c3aed;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#6d28d9);color:white">
‚öóÔ∏è Hazard Communication (HazCom)
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:10px;font-size:10px;margin-left:10px">OSHA 29 CFR 1910.1200</span>
</div>
<div class="section-content" style="padding:20px">
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üè∑Ô∏è GHS Hazard Pictograms</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px;margin-bottom:20px">
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-align:center;border:2px solid #ef4444">
<div style="font-size:28px">üí•</div><div style="font-size:10px;color:#f87171;font-weight:600">Explosive</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-align:center;border:2px solid #f97316">
<div style="font-size:28px">üî•</div><div style="font-size:10px;color:#fb923c;font-weight:600">Flammable</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-align:center;border:2px solid #a855f7">
<div style="font-size:28px">üß™</div><div style="font-size:10px;color:#c084fc;font-weight:600">Corrosive</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-align:center;border:2px solid #dc2626">
<div style="font-size:28px">‚ò†Ô∏è</div><div style="font-size:10px;color:#f87171;font-weight:600">Toxic</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-align:center;border:2px solid #fbbf24">
<div style="font-size:28px">‚ö†Ô∏è</div><div style="font-size:10px;color:#fbbf24;font-weight:600">Irritant</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-align:center;border:2px solid #ec4899">
<div style="font-size:28px">ü´Å</div><div style="font-size:10px;color:#f472b6;font-weight:600">Health Hazard</div>
</div>
</div>
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üìÑ SDS - 16 Required Sections</div>
<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:11px">
<div style="color:#94a3b8">1. Identification</div><div style="color:#94a3b8">9. Physical/chemical properties</div>
<div style="color:#94a3b8">2. Hazard(s) identification</div><div style="color:#94a3b8">10. Stability and reactivity</div>
<div style="color:#94a3b8">3. Composition/ingredients</div><div style="color:#94a3b8">11. Toxicological info</div>
<div style="color:#94a3b8">4. First-aid measures</div><div style="color:#94a3b8">12. Ecological info</div>
<div style="color:#94a3b8">5. Fire-fighting measures</div><div style="color:#94a3b8">13. Disposal considerations</div>
<div style="color:#94a3b8">6. Accidental release</div><div style="color:#94a3b8">14. Transport info</div>
<div style="color:#94a3b8">7. Handling and storage</div><div style="color:#94a3b8">15. Regulatory info</div>
<div style="color:#94a3b8">8. Exposure controls/PPE</div><div style="color:#94a3b8">16. Other information</div>
</div>
</div>
</div>

<!-- Electrical Section -->
<div id="safety-electrical" class="section" style="border:2px solid #0891b2;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#0891b2,#0e7490);color:white">
‚ö° Electrical Safety
<span style="background:rgba(255,255,255,0.2);padding:3px 10px;border-radius:10px;font-size:10px;margin-left:10px">NFPA 70E</span>
</div>
<div class="section-content" style="padding:20px">
<div style="background:linear-gradient(135deg,rgba(234,179,8,0.2),rgba(202,138,4,0.1));border:2px solid #eab308;border-radius:12px;padding:16px;margin-bottom:20px;text-align:center">
<div style="font-size:36px;margin-bottom:8px">‚ö°‚ö†Ô∏è‚ö°</div>
<div style="font-size:16px;font-weight:700;color:#fbbf24">ARC FLASH HAZARD</div>
<div style="color:#fef3c7;font-size:12px">Up to 35,000¬∞F - Always verify de-energized state and wear appropriate PPE</div>
</div>
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üìã Electrical Safety Rules</div>
<div style="display:grid;gap:8px;margin-bottom:20px">
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:8px;padding:12px;display:flex;align-items:center;gap:10px">
<span style="color:#22d3ee;font-weight:700">1.</span><span style="color:#e2e8f0;font-size:13px">Only qualified persons work on electrical</span>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:8px;padding:12px;display:flex;align-items:center;gap:10px">
<span style="color:#22d3ee;font-weight:700">2.</span><span style="color:#e2e8f0;font-size:13px">Assume all circuits energized until proven otherwise</span>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:8px;padding:12px;display:flex;align-items:center;gap:10px">
<span style="color:#22d3ee;font-weight:700">3.</span><span style="color:#e2e8f0;font-size:13px">Apply LOTO before any electrical work</span>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:8px;padding:12px;display:flex;align-items:center;gap:10px">
<span style="color:#22d3ee;font-weight:700">4.</span><span style="color:#e2e8f0;font-size:13px">Maintain safe approach distances</span>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:8px;padding:12px;display:flex;align-items:center;gap:10px">
<span style="color:#22d3ee;font-weight:700">5.</span><span style="color:#e2e8f0;font-size:13px">Wear appropriate arc-rated PPE</span>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:8px;padding:12px;display:flex;align-items:center;gap:10px">
<span style="color:#22d3ee;font-weight:700">6.</span><span style="color:#e2e8f0;font-size:13px">Never work alone on energized equipment</span>
</div>
</div>
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">ü¶∫ Arc Flash PPE Categories</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px">
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:14px;border-left:4px solid #22c55e;text-align:center">
<div style="font-weight:700;color:#4ade80;font-size:12px">Cat 1</div>
<div style="font-size:20px;font-weight:700;color:white">4 cal/cm¬≤</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:14px;border-left:4px solid #3b82f6;text-align:center">
<div style="font-weight:700;color:#60a5fa;font-size:12px">Cat 2</div>
<div style="font-size:20px;font-weight:700;color:white">8 cal/cm¬≤</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:14px;border-left:4px solid #f59e0b;text-align:center">
<div style="font-weight:700;color:#fbbf24;font-size:12px">Cat 3</div>
<div style="font-size:20px;font-weight:700;color:white">25 cal/cm¬≤</div>
</div>
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:14px;border-left:4px solid #ef4444;text-align:center">
<div style="font-weight:700;color:#f87171;font-size:12px">Cat 4</div>
<div style="font-size:20px;font-weight:700;color:white">40 cal/cm¬≤</div>
</div>
</div>
</div>
</div>

<!-- Checklists Section -->
<div id="safety-checklists" class="section" style="border:2px solid #059669;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#059669,#047857);color:white">
‚úÖ Safety Checklists & Quick Cards
</div>
<div class="section-content" style="padding:20px">
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üìã Daily Safety Walk-Through</div>
<div id="daily-safety-checklist" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;margin-bottom:20px">
<div style="display:grid;gap:6px;font-size:13px">
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px"><span style="color:#e2e8f0">Emergency exits clear and marked</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px"><span style="color:#e2e8f0">Fire extinguishers accessible</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px"><span style="color:#e2e8f0">Eye wash stations functional</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px"><span style="color:#e2e8f0">First aid kits stocked</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px"><span style="color:#e2e8f0">PPE available and in good condition</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px"><span style="color:#e2e8f0">Guardrails and covers in place</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px"><span style="color:#e2e8f0">Walking surfaces clean (no slip hazards)</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px"><span style="color:#e2e8f0">Chemical storage secure and labeled</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px"><span style="color:#e2e8f0">Gas detection equipment calibrated</span></label>
<label style="display:flex;align-items:center;gap:10px;cursor:pointer"><input type="checkbox" style="width:16px;height:16px"><span style="color:#e2e8f0">LOTO devices available at MCCs</span></label>
</div>
<button onclick="clearSafetyChecklist('daily-safety-checklist')" class="btn" style="margin-top:12px;background:#374151;color:#94a3b8;padding:10px;font-size:12px">üîÑ Reset Checklist</button>
</div>
<div style="font-weight:700;color:var(--text-section);margin-bottom:15px;font-size:16px">üÉè Quick Reference Cards</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px">
<button onclick="showSafetyCard('loto')" class="btn" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid #dc2626;padding:16px;display:flex;flex-direction:column;align-items:center;gap:6px">
<span style="font-size:28px">üîí</span><span style="color:#f87171;font-weight:700;font-size:12px">LOTO Card</span>
</button>
<button onclick="showSafetyCard('cse')" class="btn" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid #ea580c;padding:16px;display:flex;flex-direction:column;align-items:center;gap:6px">
<span style="font-size:28px">üöß</span><span style="color:#fb923c;font-weight:700;font-size:12px">CSE Card</span>
</button>
<button onclick="showSafetyCard('h2s')" class="btn" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid #eab308;padding:16px;display:flex;flex-direction:column;align-items:center;gap:6px">
<span style="font-size:28px">‚ò†Ô∏è</span><span style="color:#fbbf24;font-weight:700;font-size:12px">H‚ÇÇS Card</span>
</button>
<button onclick="showSafetyCard('emergency')" class="btn" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid #ef4444;padding:16px;display:flex;flex-direction:column;align-items:center;gap:6px">
<span style="font-size:28px">üö®</span><span style="color:#f87171;font-weight:700;font-size:12px">Emergency</span>
</button>
</div>
</div>
</div>

</div><!-- END training-safety-section -->

<!-- ==================== VIDEOS SECTION ==================== -->
<div id="training-videos-section" style="display:none">

<!-- Videos Quick Nav -->
<div id="videos-nav-cards" style="margin-bottom:20px;background:linear-gradient(135deg,rgba(124,58,237,0.1),rgba(168,85,247,0.05));border:1px solid rgba(124,58,237,0.3);border-radius:12px;padding:16px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<span style="font-weight:600;color:#c4b5fd;font-size:14px">‚ö° Quick Navigation - Videos</span>
<button onclick="document.getElementById('videos-nav-cards').style.display='none'" style="background:none;border:none;color:#94a3b8;cursor:pointer;font-size:18px" title="Dismiss">√ó</button>
</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px">
<div onclick="scrollToSection('video-fundamentals')" style="background:linear-gradient(135deg,#3b82f6,#2563eb);padding:10px;border-radius:8px;cursor:pointer;text-align:center" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:18px">üéì</div><div style="font-size:10px;color:white;font-weight:600">Fundamentals</div>
</div>
<div onclick="scrollToSection('video-activated-sludge')" style="background:linear-gradient(135deg,#22c55e,#16a34a);padding:10px;border-radius:8px;cursor:pointer;text-align:center" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:18px">ü¶†</div><div style="font-size:10px;color:white;font-weight:600">Activated Sludge</div>
</div>
<div onclick="scrollToSection('video-clarification')" style="background:linear-gradient(135deg,#06b6d4,#0891b2);padding:10px;border-radius:8px;cursor:pointer;text-align:center" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:18px">üåä</div><div style="font-size:10px;color:white;font-weight:600">Clarification</div>
</div>
<div onclick="scrollToSection('video-disinfection')" style="background:linear-gradient(135deg,#eab308,#ca8a04);padding:10px;border-radius:8px;cursor:pointer;text-align:center" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:18px">üß™</div><div style="font-size:10px;color:white;font-weight:600">Disinfection</div>
</div>
<div onclick="scrollToSection('video-solids')" style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);padding:10px;border-radius:8px;cursor:pointer;text-align:center" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:18px">üí©</div><div style="font-size:10px;color:white;font-weight:600">Solids</div>
</div>
<div onclick="scrollToSection('video-nutrients')" style="background:linear-gradient(135deg,#ec4899,#db2777);padding:10px;border-radius:8px;cursor:pointer;text-align:center" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:18px">üß¨</div><div style="font-size:10px;color:white;font-weight:600">Nutrients</div>
</div>
<div onclick="scrollToSection('video-equipment')" style="background:linear-gradient(135deg,#f97316,#ea580c);padding:10px;border-radius:8px;cursor:pointer;text-align:center" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:18px">‚öôÔ∏è</div><div style="font-size:10px;color:white;font-weight:600">Equipment</div>
</div>
<div onclick="scrollToSection('video-safety')" style="background:linear-gradient(135deg,#ef4444,#dc2626);padding:10px;border-radius:8px;cursor:pointer;text-align:center" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
<div style="font-size:18px">‚ö†Ô∏è</div><div style="font-size:10px;color:white;font-weight:600">Safety</div>
</div>
</div>
</div>

<!-- Search -->
<div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:16px;margin-bottom:20px">
<div style="display:flex;gap:12px;flex-wrap:wrap">
<input type="text" id="video-search" placeholder="üîç Search videos..." oninput="filterVideos()" style="flex:1;min-width:200px;padding:12px 16px;border-radius:8px;border:1px solid #374151;background:#0f172a;color:white;font-size:14px">
<select id="video-category-filter" onchange="filterVideos()" style="padding:12px 16px;border-radius:8px;border:1px solid #374151;background:#0f172a;color:white;font-size:14px">
<option value="all">All Categories</option>
<option value="fundamentals">Fundamentals</option>
<option value="activated-sludge">Activated Sludge</option>
<option value="clarification">Clarification</option>
<option value="disinfection">Disinfection</option>
<option value="solids">Solids Handling</option>
<option value="nutrients">Nutrient Removal</option>
<option value="equipment">Equipment</option>
<option value="safety">Safety</option>
</select>
</div>
</div>

<!-- Fundamentals -->
<div id="video-fundamentals" class="section video-category" data-category="fundamentals" style="border:2px solid #3b82f6;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;display:flex;justify-content:space-between;align-items:center">
<span>üéì Wastewater Treatment Fundamentals <span style="background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:8px;font-size:10px;margin-left:8px">BEGINNER</span></span>
<span style="font-size:11px;opacity:0.8">10 videos</span>
</div>
<div class="section-content" style="padding:16px">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px">
<a href="https://www.youtube.com/watch?v=FvPaGe3QPKU" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#60a5fa;font-size:13px">How Wastewater Treatment Works</div><div style="font-size:10px;color:#94a3b8">Complete overview of treatment process</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=g2KJzRZlFKM" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#60a5fa;font-size:13px">Wastewater Treatment Plant Tour</div><div style="font-size:10px;color:#94a3b8">Virtual walkthrough of major processes</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=d4kkYzWUHEc" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#60a5fa;font-size:13px">Preliminary Treatment</div><div style="font-size:10px;color:#94a3b8">Screening, grit removal, flow measurement</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=gEFBJk1HYL8" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#60a5fa;font-size:13px">Primary Treatment Basics</div><div style="font-size:10px;color:#94a3b8">Sedimentation and primary clarifiers</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=cMKHdOL9T1g" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='#3b82f6'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#60a5fa;font-size:13px">Secondary Treatment Overview</div><div style="font-size:10px;color:#94a3b8">Biological treatment fundamentals</div></div></div>
</a>
</div>
</div>
</div>

<!-- Activated Sludge -->
<div id="video-activated-sludge" class="section video-category" data-category="activated-sludge" style="border:2px solid #22c55e;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#22c55e,#16a34a);color:white;display:flex;justify-content:space-between;align-items:center">
<span>ü¶† Activated Sludge Process <span style="background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:8px;font-size:10px;margin-left:8px">INTERMEDIATE</span></span>
<span style="font-size:11px;opacity:0.8">10 videos</span>
</div>
<div class="section-content" style="padding:16px">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px">
<a href="https://www.youtube.com/watch?v=S_k_xPJ6QPk" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='#22c55e'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#4ade80;font-size:13px">Activated Sludge Basics</div><div style="font-size:10px;color:#94a3b8">How biological treatment works</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=DHaYGNpAWx4" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='#22c55e'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#4ade80;font-size:13px">MLSS and Mixed Liquor</div><div style="font-size:10px;color:#94a3b8">Understanding biomass concentration</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=zUpqqY0-pJc" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='#22c55e'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#4ade80;font-size:13px">SVI and Settleability</div><div style="font-size:10px;color:#94a3b8">Sludge volume index testing</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=HUG8l0OCRR4" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='#22c55e'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#4ade80;font-size:13px">F/M Ratio Control</div><div style="font-size:10px;color:#94a3b8">Food to microorganism balance</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=3tD_7s9wZ7E" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='#22c55e'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#4ade80;font-size:13px">SRT and Sludge Age</div><div style="font-size:10px;color:#94a3b8">Mean cell residence time control</div></div></div>
</a>
</div>
</div>
</div>

<!-- Safety Videos -->
<div id="video-safety" class="section video-category" data-category="safety" style="border:2px solid #ef4444;margin-bottom:20px">
<div class="section-h" style="background:linear-gradient(135deg,#ef4444,#dc2626);color:white;display:flex;justify-content:space-between;align-items:center">
<span>‚ö†Ô∏è Safety Training <span style="background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:8px;font-size:10px;margin-left:8px">REQUIRED</span></span>
<span style="font-size:11px;opacity:0.8">8 videos</span>
</div>
<div class="section-content" style="padding:16px">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px">
<a href="https://www.youtube.com/watch?v=Q2_kL8d9rEs" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent" onmouseover="this.style.borderColor='#ef4444'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#f87171;font-size:13px">Confined Space Entry</div><div style="font-size:10px;color:#94a3b8">OSHA requirements, procedures</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=M7sHrK9vQ3w" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent" onmouseover="this.style.borderColor='#ef4444'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#f87171;font-size:13px">Lockout/Tagout</div><div style="font-size:10px;color:#94a3b8">Energy isolation procedures</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=Nh5hR_r-Z5o" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent" onmouseover="this.style.borderColor='#ef4444'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#f87171;font-size:13px">H‚ÇÇS Safety</div><div style="font-size:10px;color:#94a3b8">Hydrogen sulfide awareness</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=K4rQnXP8mYE" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent" onmouseover="this.style.borderColor='#ef4444'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#f87171;font-size:13px">Chemical Safety</div><div style="font-size:10px;color:#94a3b8">HazCom, SDS, GHS</div></div></div>
</a>
<a href="https://www.youtube.com/watch?v=P5rLqX3mHnY" target="_blank" class="video-card" style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:10px;padding:12px;text-decoration:none;border:2px solid transparent" onmouseover="this.style.borderColor='#ef4444'" onmouseout="this.style.borderColor='transparent'">
<div style="display:flex;align-items:center;gap:10px"><span style="font-size:24px">üé•</span><div><div style="font-weight:700;color:#f87171;font-size:13px">Electrical Safety</div><div style="font-size:10px;color:#94a3b8">Arc flash, NFPA 70E</div></div></div>
</a>
</div>
</div>
</div>

</div><!-- END training-videos-section -->

</div><!-- END panel-training -->
<!-- ========== SAFETY MODULE PANEL ========== -->
<!-- ========== VIDEO LIBRARY PANEL ========== -->

</div><!-- END content -->
</div><!-- END wrap -->




<script>
// ========== TROUBLESHOOTING WIZARD v9.9.24 (MUST BE FIRST) ==========

const TroubleshootData = {
  tss: {
    icon: 'üå´Ô∏è',
    title: 'High Effluent TSS',
    color: '#ef4444',
    questions: [
      { q: 'Is the effluent turbid throughout the day, or only during peak flows?', answers: [
          { text: 'Throughout the day', next: 1 },
          { text: 'Only during peak flows', diagnosis: 'hydraulic_overload' },
          { text: 'Intermittently/randomly', next: 2 }
      ]},
      { q: 'Does the sludge settle well in a settleometer (SVI < 150)?', answers: [
          { text: 'Yes, settles well (SVI < 150)', next: 2 },
          { text: 'No, poor settling (SVI > 150)', diagnosis: 'filamentous_bulking' },
          { text: 'Forms small, weak floc (pin floc)', diagnosis: 'pin_floc' }
      ]},
      { q: 'Are there fine bubbles rising in the clarifier?', answers: [
          { text: 'Yes, small bubbles visible', diagnosis: 'denitrification' },
          { text: 'No bubbles observed', next: 3 }
      ]},
      { q: 'Is the clarifier blanket level normal?', answers: [
          { text: 'Blanket is too high', diagnosis: 'ras_rate_low' },
          { text: 'Blanket is normal', diagnosis: 'short_circuit' },
          { text: 'Blanket varies significantly', diagnosis: 'mlss_carryover' }
      ]}
    ],
    diagnoses: {
      hydraulic_overload: { cause: 'Hydraulic overload during peak flows', confidence: 85, immediate: ['Reduce influent flow if possible', 'Increase RAS rate temporarily', 'Check for I&I sources'], shortTerm: ['Review flow equalization options', 'Optimize clarifier weir loading'], longTerm: ['Install flow equalization basin', 'Add clarifier capacity'], calculators: ['Surface Overflow Rate'] },
      filamentous_bulking: { cause: 'Filamentous bacteria overgrowth causing poor settling', confidence: 90, immediate: ['Add chlorine to RAS (2-5 mg/L)', 'Increase DO to > 2.0 mg/L'], shortTerm: ['Identify filament type via microscopy', 'Adjust F/M ratio'], longTerm: ['Install anoxic selector', 'Optimize nutrient dosing'], calculators: ['SVI Calculator', 'F/M Ratio'] },
      pin_floc: { cause: 'Pin floc / dispersed growth - weak floc formation', confidence: 80, immediate: ['Reduce mixing intensity', 'Add polymer to clarifier'], shortTerm: ['Increase SRT gradually', 'Verify adequate nutrients'], longTerm: ['Optimize F/M ratio', 'Install flocculation zone'], calculators: ['SRT Calculator', 'F/M Ratio'] },
      denitrification: { cause: 'Denitrification in clarifier causing rising sludge', confidence: 88, immediate: ['Increase RAS rate', 'Reduce sludge blanket depth'], shortTerm: ['Reduce SRT', 'Improve nitrogen removal upstream'], longTerm: ['Add anoxic zone for controlled denit'], calculators: ['Nitrogen Balance', 'SRT Calculator'] },
      ras_rate_low: { cause: 'RAS rate too low - excessive blanket buildup', confidence: 82, immediate: ['Increase RAS pumping rate', 'Monitor blanket depth hourly'], shortTerm: ['Calibrate RAS flow meters', 'Review RAS rate calculations'], longTerm: ['Upgrade RAS pumps if undersized'], calculators: ['RAS Rate Calculator'] },
      short_circuit: { cause: 'Short-circuiting in clarifier', confidence: 75, immediate: ['Check inlet baffle condition', 'Verify weir levelness'], shortTerm: ['Perform dye test', 'Adjust inlet energy dissipation'], longTerm: ['Install improved inlet structure'], calculators: ['Detention Time'] },
      mlss_carryover: { cause: 'MLSS too high causing solids carryover', confidence: 78, immediate: ['Increase WAS rate', 'Monitor MLSS closely'], shortTerm: ['Optimize SRT target', 'Review wasting strategy'], longTerm: ['Install MLSS analyzers'], calculators: ['MLSS Target', 'WAS Rate'] }
    }
  },
  bod: {
    icon: 'üìà', title: 'High Effluent BOD', color: '#f59e0b',
    questions: [
      { q: 'Is effluent TSS also elevated?', answers: [{ text: 'Yes, TSS is high too', diagnosis: 'solids_carryover' }, { text: 'No, TSS is normal', next: 1 }]},
      { q: 'What is your current F/M ratio?', answers: [{ text: 'F/M > 0.5 (high)', diagnosis: 'undertreatment' }, { text: 'F/M 0.2-0.5 (normal)', next: 2 }, { text: 'F/M < 0.2 (low)', diagnosis: 'overtreatment' }]},
      { q: 'Is DO maintained above 2.0 mg/L throughout aeration?', answers: [{ text: 'Yes, DO is adequate', next: 3 }, { text: 'No, DO drops below 2.0', diagnosis: 'low_do_bod' }]},
      { q: 'Have you had any recent industrial discharge upsets?', answers: [{ text: 'Yes, possible toxic discharge', diagnosis: 'toxic_upset' }, { text: 'No known upsets', diagnosis: 'process_imbalance' }]}
    ],
    diagnoses: {
      solids_carryover: { cause: 'BOD associated with suspended solids carryover', confidence: 92, immediate: ['Address TSS issue first', 'Add polymer if needed'], shortTerm: ['Optimize clarifier operation'], longTerm: ['Consider filtration'], calculators: ['Surface Overflow Rate'] },
      undertreatment: { cause: 'Insufficient biological treatment - high F/M', confidence: 85, immediate: ['Reduce WAS rate', 'Increase MLSS target'], shortTerm: ['Calculate required SRT'], longTerm: ['Add aeration capacity'], calculators: ['F/M Ratio', 'SRT Calculator'] },
      overtreatment: { cause: 'Over-oxidized sludge - very low F/M', confidence: 75, immediate: ['Increase WAS rate'], shortTerm: ['Target higher F/M ratio'], longTerm: ['Right-size the process'], calculators: ['F/M Ratio', 'SRT Calculator'] },
      low_do_bod: { cause: 'Insufficient dissolved oxygen for BOD removal', confidence: 88, immediate: ['Increase blower output', 'Check diffuser operation'], shortTerm: ['Clean or replace diffusers'], longTerm: ['Upgrade aeration system'], calculators: ['Oxygen Requirement'] },
      toxic_upset: { cause: 'Toxic or inhibitory discharge affecting biology', confidence: 80, immediate: ['Divert toxic flow if possible', 'Increase SRT'], shortTerm: ['Identify source'], longTerm: ['Improve pretreatment program'], calculators: ['BOD Loading'] },
      process_imbalance: { cause: 'General process imbalance', confidence: 70, immediate: ['Review all process data'], shortTerm: ['Conduct comprehensive review'], longTerm: ['Implement optimization'], calculators: ['F/M Ratio', 'SRT Calculator'] }
    }
  },
  ammonia: {
    icon: '‚öóÔ∏è', title: 'High Effluent Ammonia', color: '#8b5cf6',
    questions: [
      { q: 'What is the current wastewater temperature?', answers: [{ text: 'Below 15¬∞C (59¬∞F)', diagnosis: 'cold_temp' }, { text: 'Above 15¬∞C (59¬∞F)', next: 1 }]},
      { q: 'What is your current SRT?', answers: [{ text: 'SRT < 10 days', diagnosis: 'low_srt' }, { text: 'SRT 10-20 days', next: 2 }, { text: 'SRT > 20 days', next: 2 }]},
      { q: 'Is DO maintained above 2.0 mg/L?', answers: [{ text: 'Yes, DO is adequate', next: 3 }, { text: 'No, DO is often below 2.0', diagnosis: 'low_do_nit' }]},
      { q: 'What is the alkalinity in the aeration basin?', answers: [{ text: 'Below 50 mg/L as CaCO3', diagnosis: 'low_alk' }, { text: 'Above 50 mg/L as CaCO3', diagnosis: 'inhibition' }]}
    ],
    diagnoses: {
      cold_temp: { cause: 'Low temperature inhibiting nitrification', confidence: 90, immediate: ['Increase SRT significantly', 'Maximize aeration'], shortTerm: ['Calculate temperature-corrected SRT'], longTerm: ['Design for winter conditions'], calculators: ['Temperature Correction', 'SRT Calculator'] },
      low_srt: { cause: 'SRT too low for nitrifier growth', confidence: 94, immediate: ['Stop or reduce wasting immediately'], shortTerm: ['Calculate minimum SRT for nitrification'], longTerm: ['Target SRT > 15 days'], calculators: ['SRT Calculator'] },
      low_do_nit: { cause: 'Insufficient DO for nitrification', confidence: 88, immediate: ['Increase aeration to maintain DO > 2.5 mg/L'], shortTerm: ['Optimize DO distribution'], longTerm: ['Install automatic DO control'], calculators: ['Oxygen Requirement'] },
      low_alk: { cause: 'Low alkalinity limiting nitrification', confidence: 85, immediate: ['Add lime or soda ash', 'Target alkalinity > 100 mg/L'], shortTerm: ['Calculate alkalinity consumption'], longTerm: ['Install automatic alkalinity addition'], calculators: ['Alkalinity Calculator'] },
      inhibition: { cause: 'Nitrification inhibition - toxic or unknown cause', confidence: 75, immediate: ['Check for industrial discharges'], shortTerm: ['Test for specific inhibitors'], longTerm: ['Implement industrial pretreatment'], calculators: ['SRT Calculator'] }
    }
  },
  bulking: {
    icon: 'üåÄ', title: 'Sludge Bulking', color: '#10b981',
    questions: [
      { q: 'What type of bulking is occurring?', answers: [{ text: 'Fluffy, cloud-like (viscous bulking)', diagnosis: 'viscous_bulking' }, { text: 'Stringy, filamentous', next: 1 }]},
      { q: 'What is your current F/M ratio?', answers: [{ text: 'F/M < 0.2 (low)', diagnosis: 'low_fm_filaments' }, { text: 'F/M 0.2-0.5 (normal)', next: 2 }, { text: 'F/M > 0.5 (high)', next: 2 }]},
      { q: 'Is DO consistent throughout aeration basin?', answers: [{ text: 'Yes, DO > 2.0 everywhere', next: 3 }, { text: 'No, DO drops below 1.0 in some areas', diagnosis: 'low_do_filaments' }, { text: 'DO fluctuates significantly', diagnosis: 'do_fluctuation' }]},
      { q: 'Do you have a selector zone?', answers: [{ text: 'No selector', diagnosis: 'no_selector' }, { text: 'Yes, but may not be working', diagnosis: 'selector_issues' }, { text: 'Yes, working properly', diagnosis: 'nutrient_deficiency' }]}
    ],
    diagnoses: {
      viscous_bulking: { cause: 'Viscous (non-filamentous) bulking', confidence: 80, immediate: ['Add chlorine to RAS', 'Increase wasting'], shortTerm: ['Verify N and P levels'], longTerm: ['Balance nutrient addition'], calculators: ['SVI Calculator'] },
      low_fm_filaments: { cause: 'Low F/M filaments (M. parvicella, Nocardia)', confidence: 88, immediate: ['Increase wasting rate', 'Add chlorine to RAS'], shortTerm: ['Target higher F/M ratio'], longTerm: ['Install anoxic selector'], calculators: ['F/M Ratio', 'SRT Calculator'] },
      low_do_filaments: { cause: 'Low DO filaments (Type 1701, S. natans)', confidence: 90, immediate: ['Increase aeration immediately'], shortTerm: ['Optimize DO distribution'], longTerm: ['Upgrade aeration system'], calculators: ['Oxygen Requirement'] },
      do_fluctuation: { cause: 'DO fluctuation causing filament selection', confidence: 82, immediate: ['Stabilize aeration'], shortTerm: ['Tune DO control system'], longTerm: ['Install cascade DO control'], calculators: ['Aeration Design'] },
      no_selector: { cause: 'No selector zone', confidence: 85, immediate: ['Create anoxic zone if possible'], shortTerm: ['Design selector zone'], longTerm: ['Install proper selector'], calculators: ['F/M Ratio'] },
      selector_issues: { cause: 'Selector not functioning properly', confidence: 78, immediate: ['Verify selector loading'], shortTerm: ['Optimize selector F/M'], longTerm: ['Redesign selector'], calculators: ['Detention Time'] },
      nutrient_deficiency: { cause: 'Nutrient deficiency causing filament growth', confidence: 75, immediate: ['Add nitrogen and phosphorus'], shortTerm: ['Target BOD:N:P of 100:5:1'], longTerm: ['Automate nutrient addition'], calculators: ['Nutrient Balance'] }
    }
  },
  foam: {
    icon: 'ü´ß', title: 'Foam/Scum Problems', color: '#ec4899',
    questions: [{ q: 'What type of foam are you experiencing?', answers: [
      { text: 'White, billowy, detergent-like', diagnosis: 'surfactant_foam' },
      { text: 'Brown/tan, thick, greasy, stable', diagnosis: 'nocardia_foam' },
      { text: 'Dark, oily, with grease', diagnosis: 'grease_foam' },
      { text: 'Light, startup foam (new plant)', diagnosis: 'startup_foam' }
    ]}],
    diagnoses: {
      surfactant_foam: { cause: 'Surfactant/detergent foam from industrial discharge', confidence: 85, immediate: ['Spray water on foam', 'Identify source'], shortTerm: ['Work with industrial users'], longTerm: ['Pretreatment requirements'], calculators: [] },
      nocardia_foam: { cause: 'Nocardia/Microthrix biological foam', confidence: 92, immediate: ['Chlorinate foam/scum directly', 'Remove foam to drying beds'], shortTerm: ['Reduce SRT', 'Add anoxic selector'], longTerm: ['Install foam removal system'], calculators: ['SRT Calculator', 'F/M Ratio'] },
      grease_foam: { cause: 'Grease/oil foam from FOG discharge', confidence: 88, immediate: ['Remove grease manually', 'Check FOG interceptors'], shortTerm: ['Identify FOG sources'], longTerm: ['FOG receiving facility'], calculators: [] },
      startup_foam: { cause: 'Startup foam - normal for young sludge', confidence: 80, immediate: ['Spray water if needed', 'This is temporary'], shortTerm: ['Build up MLSS'], longTerm: ['Maintain proper SRT'], calculators: ['SRT Calculator'] }
    }
  },
  do: {
    icon: 'üí®', title: 'Low DO in Aeration', color: '#0ea5e9',
    questions: [
      { q: 'Is DO low throughout the basin or in specific areas?', answers: [{ text: 'Low in specific areas only', diagnosis: 'uneven_distribution' }, { text: 'Low throughout entire basin', next: 1 }]},
      { q: 'Has influent loading increased recently?', answers: [{ text: 'Yes, significant increase', diagnosis: 'high_loading' }, { text: 'No, loading is normal', next: 2 }]},
      { q: 'Are blowers operating at full capacity?', answers: [{ text: 'Yes, maxed out', diagnosis: 'blower_capacity' }, { text: 'No, have spare capacity', diagnosis: 'diffuser_fouling' }]}
    ],
    diagnoses: {
      uneven_distribution: { cause: 'Uneven air distribution in aeration basin', confidence: 85, immediate: ['Adjust air valves', 'Check for damaged diffusers'], shortTerm: ['Inspect diffusers', 'Balance air distribution'], longTerm: ['Replace failed diffusers'], calculators: [] },
      high_loading: { cause: 'High organic loading exceeding oxygen supply', confidence: 88, immediate: ['Maximize aeration', 'Consider flow diversion'], shortTerm: ['Track loading trends'], longTerm: ['Add aeration capacity'], calculators: ['Oxygen Requirement', 'BOD Loading'] },
      blower_capacity: { cause: 'Insufficient blower capacity', confidence: 90, immediate: ['Check all blowers operational', 'Verify inlet filters clean'], shortTerm: ['Evaluate blower performance'], longTerm: ['Add blower capacity'], calculators: ['Blower Sizing'] },
      diffuser_fouling: { cause: 'Diffuser fouling reducing oxygen transfer', confidence: 78, immediate: ['Increase blower output', 'Check backpressure'], shortTerm: ['Schedule diffuser cleaning'], longTerm: ['Regular cleaning program'], calculators: ['Aeration Efficiency'] }
    }
  },
  odor: {
    icon: 'üëÉ', title: 'Odor Issues', color: '#84cc16',
    questions: [{ q: 'What type of odor are you experiencing?', answers: [
      { text: 'Rotten egg (hydrogen sulfide)', diagnosis: 'h2s_odor' },
      { text: 'Musty/earthy (geosmin)', diagnosis: 'algae_odor' },
      { text: 'Ammonia/pungent', diagnosis: 'ammonia_odor' },
      { text: 'Septic/sour', diagnosis: 'septic_odor' }
    ]}],
    diagnoses: {
      h2s_odor: { cause: 'Hydrogen sulfide from septic/anaerobic conditions', confidence: 92, immediate: ['Add oxidizing chemical (bleach, peroxide)', 'Increase aeration'], shortTerm: ['Identify H2S sources', 'Add ferric chloride'], longTerm: ['Install odor control system'], calculators: [] },
      algae_odor: { cause: 'Algae growth producing musty/earthy odors', confidence: 75, immediate: ['Add copper sulfate to ponds'], shortTerm: ['Control algae growth'], longTerm: ['Install covers'], calculators: [] },
      ammonia_odor: { cause: 'Ammonia volatilization from high pH', confidence: 80, immediate: ['Reduce pH if above 8.5', 'Cover sources'], shortTerm: ['Improve nitrification'], longTerm: ['Install covers and scrubbers'], calculators: [] },
      septic_odor: { cause: 'General septic conditions - lack of oxygen', confidence: 85, immediate: ['Add aeration', 'Add oxidizing chemicals'], shortTerm: ['Identify septic sources'], longTerm: ['Improve aeration throughout'], calculators: ['Detention Time'] }
    }
  },
  clarifier: {
    icon: 'üîÑ', title: 'Clarifier Problems', color: '#6366f1',
    questions: [{ q: 'What is the main clarifier issue?', answers: [
      { text: 'Rising sludge (floating clumps)', diagnosis: 'rising_sludge' },
      { text: 'Poor flow distribution', diagnosis: 'flow_distribution' },
      { text: 'Sludge blanket issues', diagnosis: 'blanket_issues' },
      { text: 'Scum accumulation', diagnosis: 'scum_issues' }
    ]}],
    diagnoses: {
      rising_sludge: { cause: 'Denitrification causing sludge to float', confidence: 90, immediate: ['Increase RAS rate', 'Reduce sludge blanket'], shortTerm: ['Reduce SRT', 'Optimize denitrification upstream'], longTerm: ['Add anoxic zone'], calculators: ['Nitrogen Balance', 'SRT Calculator'] },
      flow_distribution: { cause: 'Uneven flow distribution between clarifiers', confidence: 82, immediate: ['Check weir levels', 'Verify valve positions'], shortTerm: ['Adjust weirs', 'Perform dye test'], longTerm: ['Install flow control'], calculators: ['Surface Overflow Rate'] },
      blanket_issues: { cause: 'Sludge blanket management problems', confidence: 78, immediate: ['Adjust RAS rate', 'Monitor blanket depth'], shortTerm: ['Install blanket level sensor'], longTerm: ['Automatic blanket control'], calculators: ['Solids Loading Rate'] },
      scum_issues: { cause: 'Scum/foam accumulation in clarifier', confidence: 80, immediate: ['Activate scum removal', 'Hose down scum'], shortTerm: ['Repair scum removal equipment'], longTerm: ['Upgrade scum removal'], calculators: [] }
    }
  }
};

var wizardState = { category: null, currentQuestion: 0, answers: [], diagnosis: null };

function startTroubleshoot(category) {
  if (!TroubleshootData[category]) { alert('Invalid category'); return; }
  wizardState = { category: category, currentQuestion: 0, answers: [], diagnosis: null };
  document.getElementById('troubleshootCategories').style.display = 'none';
  document.getElementById('troubleshootWizard').style.display = 'block';
  document.getElementById('troubleshootResults').style.display = 'none';
  var data = TroubleshootData[category];
  document.getElementById('wizardIcon').textContent = data.icon;
  document.getElementById('wizardTitle').textContent = 'Troubleshooting: ' + data.title;
  document.getElementById('wizardQuestionCard').style.borderColor = data.color;
  showQuestion(0);
}

function showQuestion(index) {
  var data = TroubleshootData[wizardState.category];
  var question = data.questions[index];
  wizardState.currentQuestion = index;
  document.getElementById('wizardSubtitle').textContent = 'Step ' + (index + 1) + ' of ' + data.questions.length;
  document.getElementById('wizardProgress').style.width = ((index + 1) / data.questions.length * 100) + '%';
  document.getElementById('wizardQuestion').textContent = question.q;
  document.getElementById('wizardBackBtn').style.display = index > 0 ? 'block' : 'none';
  var answersHtml = '';
  question.answers.forEach(function(answer, i) {
    answersHtml += '<button onclick="selectAnswer(' + i + ')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid rgba(59,130,246,0.3);padding:14px 18px;border-radius:10px;color:#f0f9ff;font-size:14px;text-align:left;cursor:pointer;width:100%;margin-bottom:8px">' + answer.text + '</button>';
  });
  document.getElementById('wizardAnswers').innerHTML = answersHtml;
}

function selectAnswer(answerIndex) {
  var data = TroubleshootData[wizardState.category];
  var question = data.questions[wizardState.currentQuestion];
  var answer = question.answers[answerIndex];
  wizardState.answers.push(answerIndex);
  if (answer.diagnosis) { showDiagnosis(answer.diagnosis); }
  else if (answer.next !== undefined) { showQuestion(answer.next); }
}

function showDiagnosis(diagnosisKey) {
  var data = TroubleshootData[wizardState.category];
  var diagnosis = data.diagnoses[diagnosisKey];
  wizardState.diagnosis = diagnosisKey;
  document.getElementById('troubleshootWizard').style.display = 'none';
  document.getElementById('troubleshootResults').style.display = 'block';
  document.getElementById('diagnosisIcon').textContent = data.icon;
  document.getElementById('diagnosisTitle').textContent = diagnosis.cause;
  document.getElementById('confidenceValue').textContent = diagnosis.confidence + '%';
  document.getElementById('confidenceBar').style.width = diagnosis.confidence + '%';
  
  var immediateHtml = '';
  diagnosis.immediate.forEach(function(action) { 
    immediateHtml += '<div style="display:flex;align-items:start;gap:8px;margin-bottom:10px;color:#ffffff"><span style="color:#fca5a5;font-size:18px">‚Ä¢</span><span style="color:#ffffff;font-size:14px">' + action + '</span></div>'; 
  });
  document.getElementById('immediateActions').innerHTML = immediateHtml || '<span style="color:#94a3b8">No immediate actions</span>';
  
  var shortTermHtml = '';
  diagnosis.shortTerm.forEach(function(action) { 
    shortTermHtml += '<div style="display:flex;align-items:start;gap:8px;margin-bottom:10px;color:#ffffff"><span style="color:#fcd34d;font-size:18px">‚Ä¢</span><span style="color:#ffffff;font-size:14px">' + action + '</span></div>'; 
  });
  document.getElementById('shortTermActions').innerHTML = shortTermHtml || '<span style="color:#94a3b8">No short-term actions</span>';
  
  var longTermHtml = '';
  diagnosis.longTerm.forEach(function(action) { 
    longTermHtml += '<div style="display:flex;align-items:start;gap:8px;margin-bottom:10px;color:#ffffff"><span style="color:#4ade80;font-size:18px">‚Ä¢</span><span style="color:#ffffff;font-size:14px">' + action + '</span></div>'; 
  });
  document.getElementById('longTermActions').innerHTML = longTermHtml || '<span style="color:#94a3b8">No long-term actions</span>';
  
  var calcsHtml = '';
  if (diagnosis.calculators && diagnosis.calculators.length > 0) {
    diagnosis.calculators.forEach(function(calc) { calcsHtml += '<button onclick="goToCalculator(\'' + calc + '\')" style="background:linear-gradient(135deg,#4f46e5,#6366f1);border:none;padding:10px 16px;border-radius:8px;color:white;font-size:13px;cursor:pointer;font-weight:600;margin:4px">' + calc + '</button>'; });
  } else { calcsHtml = '<span style="color:#94a3b8">No specific calculators for this issue</span>'; }
  document.getElementById('relatedCalculators').innerHTML = calcsHtml;
  saveTroubleshootHistory(data.title, diagnosis.cause, diagnosis.confidence);
}

function wizardBack() { if (wizardState.currentQuestion > 0) { wizardState.answers.pop(); showQuestion(wizardState.currentQuestion - 1); } }
function wizardSkip() { var data = TroubleshootData[wizardState.category]; var keys = Object.keys(data.diagnoses); showDiagnosis(keys[Math.floor(Math.random() * keys.length)]); }
function resetTroubleshootWizard() { wizardState = { category: null, currentQuestion: 0, answers: [], diagnosis: null }; document.getElementById('troubleshootCategories').style.display = 'block'; document.getElementById('troubleshootWizard').style.display = 'none'; document.getElementById('troubleshootResults').style.display = 'none'; }
function saveTroubleshootHistory(category, cause, confidence) { var history = JSON.parse(localStorage.getItem('wwtp_troubleshoot_history') || '[]'); history.unshift({ date: new Date().toLocaleString(), category: category, cause: cause, confidence: confidence }); if (history.length > 10) history = history.slice(0, 10); localStorage.setItem('wwtp_troubleshoot_history', JSON.stringify(history)); loadTroubleshootHistory(); }
function loadTroubleshootHistory() { var historyDiv = document.getElementById('troubleshootHistory'); if (!historyDiv) return; var history = JSON.parse(localStorage.getItem('wwtp_troubleshoot_history') || '[]'); if (history.length === 0) { historyDiv.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:20px">No troubleshooting history yet</div>'; return; } var html = ''; history.forEach(function(item) { html += '<div style="background:rgba(30,41,59,0.5);padding:12px;border-radius:8px;margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-weight:600;color:#f0f9ff">' + item.category + '</span><span style="font-size:11px;color:#64748b">' + item.date + '</span></div><div style="font-size:12px;color:#94a3b8">' + item.cause + '</div><div style="font-size:11px;color:#6ee7b7;margin-top:4px">Confidence: ' + item.confidence + '%</div></div>'; }); historyDiv.innerHTML = html; }
function clearTroubleshootHistory() { if (confirm('Clear all troubleshooting history?')) { localStorage.removeItem('wwtp_troubleshoot_history'); loadTroubleshootHistory(); if(typeof showToast==='function')showToast('History cleared', 'info'); } }
function goToCalculator(calcName) {
  // Map calculator display names to section IDs
  var calcMap = {
    'SVI Calculator': 'sviCalcAdv',
    'F/M Ratio': 'loadingCalc',
    'SRT Calculator': 'loadingCalc',
    'MCRT Calculator': 'loadingCalc',
    'Surface Overflow Rate': 'hydraulicCalc',
    'Weir Loading Rate': 'hydraulicCalc',
    'Detention Time': 'detentionCalc',
    'RAS Rate Calculator': 'returnRateCalc',
    'RAS Rate': 'returnRateCalc',
    'WAS Rate': 'returnRateCalc',
    'MLSS Target': 'returnRateCalc',
    'Oxygen Requirement': 'aerationCalc',
    'Aeration Efficiency': 'aerationCalc',
    'Aeration Design': 'aerationCalc',
    'Blower Sizing': 'blowerCalc',
    'Nitrogen Balance': 'nitrogenCalc',
    'Denitrification Rate': 'nitrogenCalc',
    'Temperature Correction': 'tempCorrCalc',
    'Alkalinity Calculator': 'alkalinityCalc',
    'Chemical Dosing': 'chlorineCalc',
    'Nutrient Balance': 'nutrientRemovalCalc',
    'BOD Loading': 'loadingCalc',
    'Organic Loading Rate': 'loadingCalc',
    'Solids Loading Rate': 'sludgeProdCalc',
    'Phosphorus Removal': 'phosphorusCalc'
  };
  
  var sectionId = calcMap[calcName] || 'advancedCalcSuite';
  
  // Switch to process-control panel first
  if(typeof switchPanel === 'function') {
    switchPanel('process-control');
  }
  
  // Scroll to the calculator after panel switches
  setTimeout(function() {
    var el = document.getElementById(sectionId);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      // Flash highlight effect
      el.style.transition = 'box-shadow 0.3s';
      el.style.boxShadow = '0 0 20px 5px rgba(99,102,241,0.6)';
      setTimeout(function() { 
        el.style.boxShadow = ''; 
      }, 2000);
    }
    if(typeof showToast === 'function') {
      showToast('Navigated to ' + calcName, 'success');
    }
  }, 300);
}
function printDiagnosis() { window.print(); }
function saveDiagnosisLog() { if(typeof showToast==='function')showToast('Diagnosis saved to log', 'success'); }

// ========== END TROUBLESHOOTING WIZARD ==========

// ========== PROCESS SIMULATIONS ENGINE v9.9.24 ==========

const SimulationScenarios = {
  ras_increase: { title: 'RAS Rate Increase (+50%)', icon: 'üîÑ', riskLevel: 'MODERATE', riskColor: '#f59e0b', timeToImpact: '2-6 hours', recoveryTime: '6-12 hours',
    parameters: [
      { name: 'RAS Flow', before: '50%', after: '75%', change: '+50%', risk: 'low' },
      { name: 'Sludge Blanket', before: 'Normal', after: 'Lower', change: '‚Üì30-50%', risk: 'low' },
      { name: 'MLSS', before: '3000 mg/L', after: '2400-2700', change: '‚Üì10-20%', risk: 'medium' },
      { name: 'SRT', before: '12 days', after: '9-10 days', change: '‚Üì15-25%', risk: 'medium' },
      { name: 'F/M Ratio', before: '0.25', after: '0.30-0.35', change: '‚Üë20-40%', risk: 'medium' }
    ],
    cascading: ['0-2h: Blanket begins dropping', '2-4h: MLSS decreasing', '4-8h: F/M increases', '1-3d: Risk of young sludge'],
    compliance: ['TSS may improve short-term', 'Ammonia risk if SRT too low'],
    operational: ['Higher pump energy', 'May need WAS adjustment'],
    biology: ['Reduced contact time', 'May improve bulking'],
    recommendations: ['Monitor blanket every 2h', 'Check MLSS in 4h', 'Recalculate SRT after 24h'],
    monitoring: ['Blanket Depth: Every 2h', 'MLSS: Every 4h', 'SVI: Daily'],
    calculators: ['RAS Rate Calculator', 'SRT Calculator', 'F/M Ratio']
  },
  ras_decrease: { title: 'RAS Rate Decrease (-50%)', icon: 'üîÉ', riskLevel: 'HIGH', riskColor: '#ef4444', timeToImpact: '1-4 hours', recoveryTime: '4-8 hours',
    parameters: [
      { name: 'RAS Flow', before: '50%', after: '25%', change: '-50%', risk: 'high' },
      { name: 'Sludge Blanket', before: 'Normal', after: 'Rising', change: '‚Üë50-100%', risk: 'high' },
      { name: 'MLSS', before: '3000 mg/L', after: '3500-4000', change: '‚Üë15-30%', risk: 'medium' },
      { name: 'Effluent TSS Risk', before: 'Low', after: 'High', change: '‚Üë‚Üë', risk: 'high' }
    ],
    cascading: ['0-1h: Blanket rising', '1-2h: Risk of weir overflow', '4-8h: Denitrification risk'],
    compliance: ['HIGH: TSS violation if blanket overflows', 'Rising sludge from denitrification'],
    operational: ['Clarifier blanket may reach weirs', 'Denitrification causing floating sludge'],
    biology: ['Extended detention may cause septic conditions'],
    recommendations: ['Monitor blanket every 30 min', 'Increase RAS if blanket > 4 ft', 'Watch for rising sludge'],
    monitoring: ['Blanket: Every 30 min', 'Effluent TSS: Every 2h'],
    calculators: ['RAS Rate Calculator', 'Solids Loading Rate']
  },
  do_low: { title: 'DO Drops to 1.0 mg/L', icon: 'üí®', riskLevel: 'HIGH', riskColor: '#ef4444', timeToImpact: '2-4 hours', recoveryTime: '4-12 hours',
    parameters: [
      { name: 'DO Level', before: '2.0 mg/L', after: '1.0 mg/L', change: '-50%', risk: 'high' },
      { name: 'Nitrification', before: '95%+', after: '50-70%', change: '‚Üì25-45%', risk: 'high' },
      { name: 'Effluent Ammonia', before: '< 1 mg/L', after: '5-15 mg/L', change: '‚Üë‚Üë‚Üë', risk: 'high' },
      { name: 'Filament Risk', before: 'Low', after: 'High', change: '‚Üë‚Üë', risk: 'high' },
      { name: 'SVI', before: '100-120', after: '150-250', change: '‚Üë50-100%', risk: 'high' }
    ],
    cascading: ['0-2h: Nitrification declining', '2-4h: Ammonia breakthrough', '1-3d: Filaments proliferate', '1-4wk: Bulking event'],
    compliance: ['CRITICAL: Ammonia violation within 4-8 hours', 'TSS increase from poor settling'],
    operational: ['Filament proliferation', 'May need weeks to recover'],
    biology: ['Nitrifiers severely inhibited', 'Selection pressure favors filaments'],
    recommendations: ['IMMEDIATELY increase aeration', 'Check blowers operational', 'Monitor ammonia every 2h', 'Consider RAS chlorination'],
    monitoring: ['DO: Continuous', 'Ammonia: Every 2h', 'SVI: Daily', 'Microscopy: Daily'],
    calculators: ['Oxygen Requirement', 'Blower Sizing', 'Aeration Efficiency']
  },
  do_high: { title: 'DO Increases to 4.0 mg/L', icon: 'üå¨Ô∏è', riskLevel: 'LOW', riskColor: '#22c55e', timeToImpact: '4-12 hours', recoveryTime: '2-4 hours',
    parameters: [
      { name: 'DO Level', before: '2.0 mg/L', after: '4.0 mg/L', change: '+100%', risk: 'low' },
      { name: 'Energy Use', before: 'Normal', after: 'High', change: '‚Üë40-60%', risk: 'medium' },
      { name: 'Pin Floc Risk', before: 'Low', after: 'Medium', change: '‚Üë', risk: 'medium' },
      { name: 'Cost/Day', before: 'Normal', after: '+$200-500', change: '‚Üë20-40%', risk: 'medium' }
    ],
    cascading: ['0-4h: Energy increases', '4-12h: Pin floc may form', '1-3d: Denitrification reduced'],
    compliance: ['Generally low risk', 'Pin floc may increase TSS slightly'],
    operational: ['Significant energy waste', 'Pin floc formation'],
    biology: ['Over-oxidized sludge possible'],
    recommendations: ['Reduce aeration to 2.0-2.5 mg/L', 'Review DO control setpoints', 'Calculate energy savings'],
    monitoring: ['DO: Continuous', 'Energy: Daily', 'Settling Test: Daily'],
    calculators: ['Oxygen Requirement', 'Aeration Efficiency']
  },
  stop_wasting: { title: 'Stop Wasting for 3 Days', icon: 'üóëÔ∏è', riskLevel: 'HIGH', riskColor: '#ef4444', timeToImpact: '24-48 hours', recoveryTime: '3-7 days',
    parameters: [
      { name: 'WAS Rate', before: 'Normal', after: '0 GPM', change: '-100%', risk: 'high' },
      { name: 'MLSS', before: '3000 mg/L', after: '4000-5000', change: '‚Üë30-65%', risk: 'high' },
      { name: 'SRT', before: '12 days', after: '18-25+ days', change: '‚Üë50-100%', risk: 'medium' },
      { name: 'F/M Ratio', before: '0.25', after: '0.15-0.18', change: '‚Üì30-40%', risk: 'medium' },
      { name: 'Sludge Blanket', before: 'Normal', after: 'Rising', change: '‚Üë‚Üë', risk: 'high' }
    ],
    cascading: ['Day 1: MLSS increasing', 'Day 2: Blanket rises', 'Day 3: MLSS > 4500', 'Day 5+: Filament risk'],
    compliance: ['TSS violation if clarifier overloaded', 'Ammonia often improves'],
    operational: ['Clarifier solids loading increases', 'Higher oxygen demand'],
    biology: ['Low F/M filaments may develop', 'Improved nitrification'],
    recommendations: ['Monitor MLSS daily', 'Watch clarifier blanket', 'Increase aeration', 'Resume WAS before Day 3 if MLSS > 4500'],
    monitoring: ['MLSS: Daily', 'Blanket: Twice daily', 'SVI: Daily', 'DO: Continuous'],
    calculators: ['WAS Rate', 'SRT Calculator', 'F/M Ratio']
  },
  double_wasting: { title: 'Double Wasting Rate', icon: '‚è´', riskLevel: 'HIGH', riskColor: '#ef4444', timeToImpact: '12-24 hours', recoveryTime: '5-14 days',
    parameters: [
      { name: 'WAS Rate', before: 'Normal', after: '2x Normal', change: '+100%', risk: 'high' },
      { name: 'MLSS', before: '3000 mg/L', after: '1800-2200', change: '‚Üì25-40%', risk: 'high' },
      { name: 'SRT', before: '12 days', after: '5-7 days', change: '‚Üì40-60%', risk: 'high' },
      { name: 'Nitrification', before: '95%', after: '60-80%', change: '‚Üì15-35%', risk: 'high' }
    ],
    cascading: ['0-12h: MLSS dropping', '12-24h: SRT below threshold', '1-2d: Ammonia breakthrough', '3-7d: System washout risk'],
    compliance: ['CRITICAL: Ammonia violation within 1-2 days', 'BOD may increase'],
    operational: ['Loss of biomass inventory', 'Digesters may overload'],
    biology: ['Nitrifiers washed out', 'Young sludge, poor floc'],
    recommendations: ['Do NOT sustain - return to normal within 24h', 'Monitor ammonia closely', 'Calculate minimum SRT'],
    monitoring: ['MLSS: Every 4h', 'Ammonia: Every 4h', 'SRT: Daily'],
    calculators: ['WAS Rate', 'SRT Calculator', 'F/M Ratio']
  },
  storm_flow: { title: 'Flow Doubles (Storm)', icon: 'üåä', riskLevel: 'CRITICAL', riskColor: '#dc2626', timeToImpact: '0-2 hours', recoveryTime: '12-48 hours',
    parameters: [
      { name: 'Influent Flow', before: '3.5 MGD', after: '7.0 MGD', change: '+100%', risk: 'high' },
      { name: 'HRT', before: '6 hours', after: '3 hours', change: '-50%', risk: 'high' },
      { name: 'Surface Overflow Rate', before: '600 gpd/sf', after: '1200 gpd/sf', change: '+100%', risk: 'high' },
      { name: 'MLSS', before: '3000 mg/L', after: '1800-2200', change: '‚Üì25-40%', risk: 'high' },
      { name: 'Effluent TSS', before: '< 20 mg/L', after: '40-100+', change: '‚Üë‚Üë‚Üë', risk: 'high' }
    ],
    cascading: ['0-1h: Hydraulic surge', '1-2h: Solids carryover begins', '2-4h: MLSS diluted', '4-8h: BOD efficiency drops'],
    compliance: ['CRITICAL: TSS violation almost certain', 'BOD/Ammonia at risk', 'Document for wet weather exemption'],
    operational: ['Clarifiers hydraulically overloaded', 'Solids washout', 'Potential infrastructure damage'],
    biology: ['Biomass dilution', 'Reduced contact time'],
    recommendations: ['Activate wet weather SOPs', 'Maximize RAS rate', 'Consider flow diversion', 'Stop WAS to preserve biomass', 'Document storm event'],
    monitoring: ['Flow: Continuous', 'Blanket: Every 30 min', 'Effluent TSS: Hourly', 'MLSS: Every 2h'],
    calculators: ['Surface Overflow Rate', 'Detention Time']
  },
  flow_decrease: { title: 'Flow Drops 50%', icon: 'üìâ', riskLevel: 'LOW', riskColor: '#22c55e', timeToImpact: '4-12 hours', recoveryTime: '2-4 hours',
    parameters: [
      { name: 'Influent Flow', before: '3.5 MGD', after: '1.75 MGD', change: '-50%', risk: 'low' },
      { name: 'HRT', before: '6 hours', after: '12 hours', change: '+100%', risk: 'low' },
      { name: 'F/M Ratio', before: '0.25', after: '0.12-0.15', change: '‚Üì40-50%', risk: 'medium' },
      { name: 'DO', before: '2.0 mg/L', after: '3.0-4.0', change: '‚Üë50-100%', risk: 'low' }
    ],
    cascading: ['0-4h: DO rises', '4-12h: F/M drops', '1-3d: Pin floc risk', '3-7d: Low F/M filament risk'],
    compliance: ['Generally low risk', 'Pin floc may cause slight TSS increase'],
    operational: ['Energy waste if not reduced', 'Low F/M filament risk'],
    biology: ['Starvation at very low F/M', 'May improve nitrification'],
    recommendations: ['Reduce aeration', 'Consider increasing WAS', 'Monitor for pin floc'],
    monitoring: ['DO: Continuous', 'F/M: Daily', 'Energy: Daily'],
    calculators: ['F/M Ratio', 'Oxygen Requirement']
  },
  temp_drop: { title: 'Temperature Drops 10¬∞C', icon: 'üå°Ô∏è', riskLevel: 'HIGH', riskColor: '#ef4444', timeToImpact: '1-3 days', recoveryTime: '2-4 weeks',
    parameters: [
      { name: 'Temperature', before: '20¬∞C', after: '10¬∞C', change: '-10¬∞C', risk: 'high' },
      { name: 'Nitrification Rate', before: '100%', after: '30-50%', change: '‚Üì50-70%', risk: 'high' },
      { name: 'Required SRT', before: '10-12 days', after: '20-30 days', change: '‚Üë100-150%', risk: 'high' },
      { name: 'Effluent Ammonia', before: '< 1 mg/L', after: '5-20 mg/L', change: '‚Üë‚Üë‚Üë', risk: 'high' }
    ],
    cascading: ['Day 1-2: Rates slowing', 'Day 2-3: Nitrification drops', 'Day 3-7: Ammonia breakthrough', 'Week 2+: Nitrifiers wash out'],
    compliance: ['CRITICAL: Ammonia violation likely', 'BOD may increase slightly'],
    operational: ['Must increase SRT significantly', 'Reduce WAS dramatically'],
    biology: ['Nitrifiers severely impacted', 'Settling often improves'],
    recommendations: ['IMMEDIATELY reduce WAS 50%+', 'Target SRT 25-30 days', 'Increase MLSS to 4000-4500', 'Monitor ammonia daily'],
    monitoring: ['Temperature: Daily', 'Ammonia: Daily', 'MLSS: Daily', 'SRT: Weekly'],
    calculators: ['Temperature Correction', 'SRT Calculator', 'Alkalinity Calculator']
  },
  temp_rise: { title: 'Temperature Rises 10¬∞C', icon: 'üî•', riskLevel: 'MODERATE', riskColor: '#f59e0b', timeToImpact: '1-2 days', recoveryTime: '3-7 days',
    parameters: [
      { name: 'Temperature', before: '20¬∞C', after: '30¬∞C', change: '+10¬∞C', risk: 'medium' },
      { name: 'Oxygen Demand', before: 'Normal', after: 'High', change: '‚Üë40-60%', risk: 'high' },
      { name: 'DO Saturation', before: '9.1 mg/L', after: '7.5 mg/L', change: '‚Üì18%', risk: 'medium' },
      { name: 'Filament Risk', before: 'Low', after: 'Medium-High', change: '‚Üë', risk: 'medium' }
    ],
    cascading: ['Day 1: Increased O2 demand', 'Day 1-2: DO may drop', 'Week 1: Nocardia risk', 'Week 2+: Odor potential'],
    compliance: ['Low if O2 demand met', 'Foam may cause issues'],
    operational: ['Must increase aeration', 'Nocardia foam risk', 'Odor potential'],
    biology: ['May need more WAS', 'Nocardia favored'],
    recommendations: ['Increase aeration to maintain DO > 2.0', 'Monitor for foam', 'May need to increase WAS'],
    monitoring: ['DO: Continuous', 'Foam: Daily', 'Temperature: Daily'],
    calculators: ['Temperature Correction', 'Oxygen Requirement']
  },
  ph_drop: { title: 'pH Drops to 6.5', icon: '‚öóÔ∏è', riskLevel: 'HIGH', riskColor: '#ef4444', timeToImpact: '2-6 hours', recoveryTime: '4-12 hours',
    parameters: [
      { name: 'pH', before: '7.2', after: '6.5', change: '-0.7', risk: 'high' },
      { name: 'Nitrification', before: '95%', after: '40-60%', change: '‚Üì35-55%', risk: 'high' },
      { name: 'Effluent Ammonia', before: '< 1 mg/L', after: '5-15 mg/L', change: '‚Üë‚Üë‚Üë', risk: 'high' },
      { name: 'Alkalinity', before: '150 mg/L', after: '50-80 mg/L', change: '‚Üì45-65%', risk: 'high' }
    ],
    cascading: ['0-2h: Nitrification declining', '2-4h: Ammonia accumulation', '4-8h: Further pH drop possible', '1-3d: Equipment corrosion'],
    compliance: ['CRITICAL: Ammonia violation within hours', 'pH violation if < 6.0'],
    operational: ['Concrete/metal corrosion', 'May indicate industrial discharge'],
    biology: ['Nitrifiers severely inhibited below 6.8', 'Heterotrophs generally tolerant'],
    recommendations: ['IMMEDIATELY add lime or caustic', 'Investigate source', 'Check alkalinity', 'Target alk > 100 mg/L'],
    monitoring: ['pH: Continuous', 'Alkalinity: Every 4h', 'Ammonia: Every 2h'],
    calculators: ['Alkalinity Calculator', 'Chemical Dosing']
  },
  ph_rise: { title: 'pH Rises to 8.5', icon: 'üß™', riskLevel: 'MODERATE', riskColor: '#f59e0b', timeToImpact: '2-6 hours', recoveryTime: '4-12 hours',
    parameters: [
      { name: 'pH', before: '7.2', after: '8.5', change: '+1.3', risk: 'medium' },
      { name: 'Free Ammonia', before: '< 1%', after: '10-15%', change: '‚Üë‚Üë‚Üë', risk: 'high' },
      { name: 'Struvite Risk', before: 'Low', after: 'Medium', change: '‚Üë', risk: 'medium' }
    ],
    cascading: ['0-2h: Free ammonia increases', '2-4h: Ammonia volatilization', '4-8h: Nitrifier inhibition', '1-3d: Struvite scaling'],
    compliance: ['pH violation if > 9.0', 'Ammonia may increase'],
    operational: ['Struvite formation', 'Ammonia odors'],
    biology: ['Free ammonia toxicity to nitrifiers'],
    recommendations: ['Add acid to lower pH', 'Investigate source', 'Monitor for odors', 'Check pipes for struvite'],
    monitoring: ['pH: Continuous', 'Ammonia: Every 4h'],
    calculators: ['Alkalinity Calculator', 'Chemical Dosing']
  },
  toxic_slug: { title: 'Toxic Slug Load', icon: '‚ò†Ô∏è', riskLevel: 'CRITICAL', riskColor: '#dc2626', timeToImpact: '0-4 hours', recoveryTime: '1-4 weeks',
    parameters: [
      { name: 'Biology Status', before: 'Healthy', after: 'Inhibited/Killed', change: '‚Üì‚Üì‚Üì', risk: 'high' },
      { name: 'Nitrification', before: '95%', after: '0-30%', change: '‚Üì70-100%', risk: 'high' },
      { name: 'BOD Removal', before: '95%', after: '50-70%', change: '‚Üì25-45%', risk: 'high' },
      { name: 'Effluent Quality', before: 'Good', after: 'Poor', change: '‚Üì‚Üì‚Üì', risk: 'high' }
    ],
    cascading: ['0-2h: Toxic enters basin', '2-4h: Biology dying', '4-12h: Major effluent deterioration', '1-2wk: Heterotrophs recover', '2-4wk: Nitrifiers recover'],
    compliance: ['CRITICAL: Multiple violations likely', 'Document as upset condition'],
    operational: ['Complete loss of treatment', 'May need flow diversion', 'Weeks of recovery'],
    biology: ['Mass mortality', 'Nitrifiers recover last', 'May need seed sludge'],
    recommendations: ['IMMEDIATELY identify and stop source', 'Divert flow if possible', 'Document everything', 'Collect samples', 'Notify regulatory agency', 'Stop WAS', 'Consider seed sludge'],
    monitoring: ['Microscopy: Daily', 'OUR: Daily', 'All effluent params: Daily'],
    calculators: ['SRT Calculator', 'F/M Ratio']
  },
  bod_spike: { title: 'BOD Loading Doubles', icon: 'üìà', riskLevel: 'HIGH', riskColor: '#ef4444', timeToImpact: '2-6 hours', recoveryTime: '1-3 days',
    parameters: [
      { name: 'Influent BOD', before: '200 mg/L', after: '400 mg/L', change: '+100%', risk: 'high' },
      { name: 'F/M Ratio', before: '0.25', after: '0.50', change: '+100%', risk: 'high' },
      { name: 'Oxygen Demand', before: 'Normal', after: 'Double', change: '+100%', risk: 'high' },
      { name: 'DO', before: '2.0 mg/L', after: '< 1.0 mg/L', change: '‚Üì‚Üì', risk: 'high' }
    ],
    cascading: ['0-2h: DO drops rapidly', '2-6h: Nitrification compromised', '6-24h: Effluent BOD increases', '1-3d: High F/M filament risk'],
    compliance: ['BOD violation likely', 'Ammonia risk from low DO', 'TSS may increase'],
    operational: ['Aeration system maxed out', 'May need flow equalization'],
    biology: ['Oxygen-limited conditions', 'High F/M filament risk'],
    recommendations: ['Maximize aeration', 'Reduce flow if possible', 'Monitor DO continuously', 'Investigate source'],
    monitoring: ['DO: Continuous', 'Effluent BOD: Daily', 'SVI: Daily'],
    calculators: ['Oxygen Requirement', 'F/M Ratio', 'BOD Loading']
  },
  mlss_high: { title: 'MLSS to 5000 mg/L', icon: 'üß´', riskLevel: 'MODERATE', riskColor: '#f59e0b', timeToImpact: '4-12 hours', recoveryTime: '1-3 days',
    parameters: [
      { name: 'MLSS', before: '3000 mg/L', after: '5000 mg/L', change: '+67%', risk: 'medium' },
      { name: 'SRT', before: '12 days', after: '18-20 days', change: '+50-67%', risk: 'low' },
      { name: 'Clarifier Loading', before: 'Normal', after: 'High', change: '‚Üë67%', risk: 'high' },
      { name: 'Oxygen Demand', before: 'Normal', after: 'High', change: '‚Üë40%', risk: 'medium' }
    ],
    cascading: ['0-4h: Clarifier loading increases', '4-12h: Blanket may rise', '1-3d: Old sludge accumulates'],
    compliance: ['TSS risk if clarifier overloaded', 'Ammonia usually improves'],
    operational: ['Clarifier solids loading high', 'Higher oxygen demand', 'Thicker sludge blanket'],
    biology: ['Higher SRT, more nitrifiers', 'Old sludge, more decay'],
    recommendations: ['Monitor clarifier blanket closely', 'Increase aeration', 'May need to increase WAS', 'Watch clarifier solids loading'],
    monitoring: ['Blanket: Twice daily', 'DO: Continuous', 'SVI: Daily'],
    calculators: ['Solids Loading Rate', 'SRT Calculator']
  },
  mlss_low: { title: 'MLSS to 1500 mg/L', icon: 'üíß', riskLevel: 'HIGH', riskColor: '#ef4444', timeToImpact: '4-12 hours', recoveryTime: '5-14 days',
    parameters: [
      { name: 'MLSS', before: '3000 mg/L', after: '1500 mg/L', change: '-50%', risk: 'high' },
      { name: 'SRT', before: '12 days', after: '5-6 days', change: '-50%', risk: 'high' },
      { name: 'F/M Ratio', before: '0.25', after: '0.50', change: '+100%', risk: 'high' },
      { name: 'Nitrification', before: '95%', after: '70-80%', change: '‚Üì15-25%', risk: 'high' }
    ],
    cascading: ['0-4h: Treatment capacity reduced', '4-12h: SRT dropping', '1-2d: Ammonia risk', '3-7d: Young, weak sludge'],
    compliance: ['Ammonia violation risk', 'BOD may increase'],
    operational: ['Reduced treatment capacity', 'Takes time to rebuild'],
    biology: ['Nitrifiers may wash out', 'Young sludge'],
    recommendations: ['Stop or reduce WAS immediately', 'Monitor ammonia', 'May take 1-2 weeks to rebuild'],
    monitoring: ['MLSS: Daily', 'Ammonia: Daily', 'SRT: Daily'],
    calculators: ['SRT Calculator', 'WAS Rate']
  },
  blower_fail: { title: 'Blower Failure (50% Loss)', icon: '‚ö†Ô∏è', riskLevel: 'CRITICAL', riskColor: '#dc2626', timeToImpact: '0-2 hours', recoveryTime: '0-4 hours',
    parameters: [
      { name: 'Aeration Capacity', before: '100%', after: '50%', change: '-50%', risk: 'high' },
      { name: 'DO', before: '2.0 mg/L', after: '0.5-1.0 mg/L', change: '‚Üì50-75%', risk: 'high' },
      { name: 'Nitrification', before: '95%', after: '40-60%', change: '‚Üì35-55%', risk: 'high' },
      { name: 'Effluent Ammonia', before: '< 1 mg/L', after: '5-20 mg/L', change: '‚Üë‚Üë‚Üë', risk: 'high' }
    ],
    cascading: ['0-1h: DO drops rapidly', '1-2h: Nitrification failing', '2-4h: Ammonia breakthrough', '4+h: Filament risk begins'],
    compliance: ['CRITICAL: Ammonia violation within hours', 'May trigger upset reporting'],
    operational: ['Emergency - restore aeration ASAP', 'Activate backup blower', 'Consider portable aeration'],
    biology: ['Immediate stress on nitrifiers', 'Filament risk if prolonged'],
    recommendations: ['EMERGENCY: Restore aeration immediately', 'Start backup blower', 'Reduce loading if possible', 'Notify management'],
    monitoring: ['DO: Continuous', 'Ammonia: Hourly', 'Blower status: Continuous'],
    calculators: ['Oxygen Requirement', 'Blower Sizing']
  },
  clarifier_offline: { title: 'Clarifier Offline (1 of 2)', icon: 'üîß', riskLevel: 'HIGH', riskColor: '#ef4444', timeToImpact: '0-2 hours', recoveryTime: '0-4 hours',
    parameters: [
      { name: 'Clarifier Capacity', before: '100%', after: '50%', change: '-50%', risk: 'high' },
      { name: 'Surface Overflow Rate', before: '600 gpd/sf', after: '1200 gpd/sf', change: '+100%', risk: 'high' },
      { name: 'Solids Loading', before: 'Normal', after: 'Double', change: '+100%', risk: 'high' },
      { name: 'Effluent TSS Risk', before: 'Low', after: 'High', change: '‚Üë‚Üë', risk: 'high' }
    ],
    cascading: ['0-1h: Remaining clarifier overloaded', '1-2h: Blanket rises', '2-4h: Solids carryover risk', '4+h: TSS violations'],
    compliance: ['HIGH: TSS violation likely', 'May need flow reduction'],
    operational: ['Remaining clarifier overloaded', 'Must reduce flow or expedite repairs'],
    biology: ['Sludge may be lost to effluent'],
    recommendations: ['Reduce influent flow if possible', 'Maximize RAS on remaining clarifier', 'Expedite repairs', 'Monitor blanket closely'],
    monitoring: ['Blanket: Hourly', 'Effluent TSS: Hourly', 'Flow: Continuous'],
    calculators: ['Surface Overflow Rate', 'Solids Loading Rate']
  },
  ammonia_spike: { title: 'Influent Ammonia Doubles', icon: 'üß¨', riskLevel: 'MODERATE', riskColor: '#f59e0b', timeToImpact: '4-12 hours', recoveryTime: '1-3 days',
    parameters: [
      { name: 'Influent Ammonia', before: '25 mg/L', after: '50 mg/L', change: '+100%', risk: 'medium' },
      { name: 'Oxygen Demand', before: 'Normal', after: 'High', change: '‚Üë45%', risk: 'high' },
      { name: 'Alkalinity Consumption', before: 'Normal', after: 'High', change: '+100%', risk: 'high' },
      { name: 'Effluent Ammonia Risk', before: 'Low', after: 'Medium', change: '‚Üë', risk: 'medium' }
    ],
    cascading: ['0-4h: Increased nitrifier demand', '4-12h: DO may drop, alk consumed', '12-24h: Effluent ammonia may rise', '1-3d: System adapts'],
    compliance: ['Ammonia violation risk if capacity exceeded', 'May affect pH from alk consumption'],
    operational: ['Higher oxygen demand', 'More alkalinity consumed', 'May need chemical addition'],
    biology: ['Nitrifiers will adapt if adequate SRT', 'Potential for growth'],
    recommendations: ['Increase aeration', 'Monitor alkalinity and supplement', 'Check DO throughout basin', 'Investigate source'],
    monitoring: ['DO: Continuous', 'Alkalinity: Daily', 'Effluent Ammonia: Daily'],
    calculators: ['Oxygen Requirement', 'Alkalinity Calculator', 'Nitrogen Balance']
  },
  sludge_age: { title: 'SRT Extended to 30 Days', icon: '‚è±Ô∏è', riskLevel: 'LOW', riskColor: '#22c55e', timeToImpact: '3-7 days', recoveryTime: '1-2 weeks',
    parameters: [
      { name: 'SRT', before: '12 days', after: '30 days', change: '+150%', risk: 'low' },
      { name: 'MLSS', before: '3000 mg/L', after: '4500-5500', change: '‚Üë50-83%', risk: 'medium' },
      { name: 'F/M Ratio', before: '0.25', after: '0.10-0.15', change: '‚Üì40-60%', risk: 'medium' },
      { name: 'Oxygen Demand', before: 'Normal', after: 'Higher', change: '‚Üë30-50%', risk: 'medium' }
    ],
    cascading: ['Day 1-3: MLSS building', 'Day 3-7: Old sludge accumulating', 'Week 2: Low F/M established', 'Week 3+: Extended aeration mode'],
    compliance: ['Ammonia usually excellent', 'TSS risk from clarifier loading'],
    operational: ['Higher MLSS to manage', 'More oxygen needed', 'Low F/M filament risk'],
    biology: ['Excellent nitrification', 'High endogenous respiration', 'Old, well-stabilized sludge'],
    recommendations: ['Monitor clarifier loading', 'Increase aeration', 'Watch for Nocardia in warm weather', 'Maintain adequate DO'],
    monitoring: ['MLSS: Daily', 'Blanket: Daily', 'SVI: Weekly', 'DO: Continuous'],
    calculators: ['SRT Calculator', 'F/M Ratio', 'Solids Loading Rate']
  }
};

function runSimulation(scenarioId) {
  var scenario = SimulationScenarios[scenarioId];
  if (!scenario) {
    showToast('Simulation not found', 'error');
    return;
  }
  
  document.getElementById('simulationCategories').style.display = 'none';
  document.getElementById('simulationResults').style.display = 'block';
  
  // Set header
  document.getElementById('simScenarioTitle').innerHTML = scenario.icon + ' ' + scenario.title;
  
  // Set risk banner
  var banner = document.getElementById('simRiskBanner');
  banner.style.background = 'linear-gradient(135deg,' + scenario.riskColor + ',' + adjustColor(scenario.riskColor, 20) + ')';
  document.getElementById('simRiskIcon').textContent = scenario.riskLevel === 'CRITICAL' ? 'üö®' : scenario.riskLevel === 'HIGH' ? '‚ö†Ô∏è' : scenario.riskLevel === 'MODERATE' ? '‚ö°' : '‚úÖ';
  document.getElementById('simRiskLevel').textContent = scenario.riskLevel + ' RISK';
  document.getElementById('simRiskSummary').textContent = scenario.title + ' - Multiple process impacts expected';
  
  // Set timing
  document.getElementById('simTimeToImpact').textContent = scenario.timeToImpact;
  document.getElementById('simRecoveryTime').textContent = scenario.recoveryTime;
  
  // Build parameter table
  var paramHtml = '<table style="width:100%;border-collapse:collapse;font-size:13px">';
  paramHtml += '<tr style="background:#0f172a"><th style="padding:10px;text-align:left;color:#94a3b8">Parameter</th><th style="padding:10px;color:#94a3b8">Before</th><th style="padding:10px;color:#94a3b8">After</th><th style="padding:10px;color:#94a3b8">Change</th><th style="padding:10px;color:#94a3b8">Risk</th></tr>';
  scenario.parameters.forEach(function(p, i) {
    var riskColor = p.risk === 'high' ? '#ef4444' : p.risk === 'medium' ? '#f59e0b' : '#22c55e';
    var bgColor = i % 2 === 0 ? 'rgba(30,41,59,0.5)' : 'transparent';
    paramHtml += '<tr style="background:' + bgColor + '"><td style="padding:10px;color:#f0f9ff;font-weight:600">' + p.name + '</td><td style="padding:10px;color:#94a3b8;text-align:center">' + p.before + '</td><td style="padding:10px;color:#60a5fa;text-align:center;font-weight:600">' + p.after + '</td><td style="padding:10px;text-align:center;color:' + (p.change.includes('‚Üë') || p.change.includes('+') ? '#f59e0b' : p.change.includes('‚Üì') || p.change.includes('-') ? '#60a5fa' : '#94a3b8') + ';font-weight:600">' + p.change + '</td><td style="padding:10px;text-align:center"><span style="background:' + riskColor + ';color:white;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600">' + p.risk.toUpperCase() + '</span></td></tr>';
  });
  paramHtml += '</table>';
  document.getElementById('simParameterChanges').innerHTML = paramHtml;
  
  // Cascading effects
  var cascadeHtml = '<div style="position:relative;padding-left:20px;border-left:3px solid #f59e0b">';
  scenario.cascading.forEach(function(c) {
    var severity = c.includes('CRITICAL') || c.includes('violation') ? '#ef4444' : c.includes('risk') || c.includes('may') ? '#f59e0b' : '#3b82f6';
    cascadeHtml += '<div style="margin-bottom:12px;position:relative"><div style="position:absolute;left:-26px;top:4px;width:12px;height:12px;background:' + severity + ';border-radius:50%"></div><span style="color:#f0f9ff;font-size:14px">' + c + '</span></div>';
  });
  cascadeHtml += '</div>';
  document.getElementById('simCascadingEffects').innerHTML = cascadeHtml;
  
  // Risk sections
  var compHtml = '';
  scenario.compliance.forEach(function(r) {
    var isHigh = r.includes('CRITICAL') || r.includes('HIGH');
    compHtml += '<div style="display:flex;align-items:start;gap:8px;margin-bottom:8px"><span style="color:' + (isHigh ? '#ef4444' : '#f59e0b') + '">‚Ä¢</span><span style="color:#f0f9ff;font-size:13px">' + r + '</span></div>';
  });
  document.getElementById('simComplianceRisk').innerHTML = compHtml;
  
  var opsHtml = '';
  scenario.operational.forEach(function(r) {
    opsHtml += '<div style="display:flex;align-items:start;gap:8px;margin-bottom:8px"><span style="color:#f59e0b">‚Ä¢</span><span style="color:#f0f9ff;font-size:13px">' + r + '</span></div>';
  });
  document.getElementById('simOperationalRisk').innerHTML = opsHtml;
  
  var bioHtml = '';
  scenario.biology.forEach(function(r) {
    bioHtml += '<div style="display:flex;align-items:start;gap:8px;margin-bottom:8px"><span style="color:#a78bfa">‚Ä¢</span><span style="color:#f0f9ff;font-size:13px">' + r + '</span></div>';
  });
  document.getElementById('simBiologyRisk').innerHTML = bioHtml;
  
  // Recommendations
  var recHtml = '';
  scenario.recommendations.forEach(function(r, i) {
    var priority = i < 2 ? 'CRITICAL' : i < 4 ? 'HIGH' : 'MEDIUM';
    var pColor = i < 2 ? '#ef4444' : i < 4 ? '#f59e0b' : '#3b82f6';
    recHtml += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:10px;background:rgba(30,41,59,0.5);border-radius:8px;border-left:3px solid ' + pColor + '"><span style="background:' + pColor + ';color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700">' + priority + '</span><span style="color:#f0f9ff;font-size:13px">' + r + '</span></div>';
  });
  document.getElementById('simRecommendations').innerHTML = recHtml;
  
  // Monitoring
  var monHtml = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">';
  scenario.monitoring.forEach(function(m) {
    monHtml += '<div style="background:rgba(30,41,59,0.5);padding:10px;border-radius:8px;border:1px solid rgba(6,182,212,0.3)"><div style="color:#22d3ee;font-weight:600;font-size:13px">' + m.split(':')[0] + '</div><div style="color:#94a3b8;font-size:12px;margin-top:4px">' + m.split(':')[1] + '</div></div>';
  });
  monHtml += '</div>';
  document.getElementById('simMonitoring').innerHTML = monHtml;
  
  // Calculators
  var calcHtml = '';
  scenario.calculators.forEach(function(c) {
    calcHtml += '<button onclick="goToCalculator(\'' + c + '\')" style="background:linear-gradient(135deg,#4f46e5,#6366f1);border:none;padding:10px 16px;border-radius:8px;color:white;font-size:13px;cursor:pointer;font-weight:600">' + c + '</button>';
  });
  document.getElementById('simCalculators').innerHTML = calcHtml;
  
  // Save to history
  saveSimulationHistory(scenario.title, scenario.riskLevel);
  
  showToast('Simulation: ' + scenario.title, 'info');
}

function runCustomSimulation() {
  var current = {
    flow: parseFloat(document.getElementById('sim_current_flow').value) || 3.5,
    mlss: parseFloat(document.getElementById('sim_current_mlss').value) || 3000,
    do_val: parseFloat(document.getElementById('sim_current_do').value) || 2.0,
    temp: parseFloat(document.getElementById('sim_current_temp').value) || 20,
    srt: parseFloat(document.getElementById('sim_current_srt').value) || 12,
    ras: parseFloat(document.getElementById('sim_current_ras').value) || 50,
    ph: parseFloat(document.getElementById('sim_current_ph').value) || 7.2,
    bod: parseFloat(document.getElementById('sim_current_bod').value) || 200
  };
  
  var proposed = {
    flow: parseFloat(document.getElementById('sim_new_flow').value) || 3.5,
    mlss: parseFloat(document.getElementById('sim_new_mlss').value) || 3000,
    do_val: parseFloat(document.getElementById('sim_new_do').value) || 2.0,
    temp: parseFloat(document.getElementById('sim_new_temp').value) || 20,
    srt: parseFloat(document.getElementById('sim_new_srt').value) || 12,
    ras: parseFloat(document.getElementById('sim_new_ras').value) || 50,
    ph: parseFloat(document.getElementById('sim_new_ph').value) || 7.2,
    bod: parseFloat(document.getElementById('sim_new_bod').value) || 200
  };
  
  // Determine which scenario best matches
  var flowChange = (proposed.flow - current.flow) / current.flow * 100;
  var mlssChange = (proposed.mlss - current.mlss) / current.mlss * 100;
  var doChange = proposed.do_val - current.do_val;
  var tempChange = proposed.temp - current.temp;
  var srtChange = (proposed.srt - current.srt) / current.srt * 100;
  var rasChange = (proposed.ras - current.ras) / current.ras * 100;
  var phChange = proposed.ph - current.ph;
  var bodChange = (proposed.bod - current.bod) / current.bod * 100;
  
  // Find matching scenario
  var matchedScenario = null;
  if (flowChange >= 80) matchedScenario = 'storm_flow';
  else if (flowChange <= -40) matchedScenario = 'flow_decrease';
  else if (rasChange >= 40) matchedScenario = 'ras_increase';
  else if (rasChange <= -40) matchedScenario = 'ras_decrease';
  else if (doChange <= -0.8) matchedScenario = 'do_low';
  else if (doChange >= 1.5) matchedScenario = 'do_high';
  else if (tempChange <= -8) matchedScenario = 'temp_drop';
  else if (tempChange >= 8) matchedScenario = 'temp_rise';
  else if (phChange <= -0.5) matchedScenario = 'ph_drop';
  else if (phChange >= 1.0) matchedScenario = 'ph_rise';
  else if (srtChange >= 100) matchedScenario = 'sludge_age';
  else if (mlssChange >= 50) matchedScenario = 'mlss_high';
  else if (mlssChange <= -40) matchedScenario = 'mlss_low';
  else if (bodChange >= 80) matchedScenario = 'bod_spike';
  
  if (matchedScenario) {
    runSimulation(matchedScenario);
  } else {
    showToast('Changes too small to simulate significant impact', 'warning');
  }
}

function resetSimulation() {
  document.getElementById('simulationCategories').style.display = 'block';
  document.getElementById('simulationResults').style.display = 'none';
}

function adjustColor(color, amount) {
  var hex = color.replace('#', '');
  var r = Math.min(255, parseInt(hex.substr(0,2), 16) + amount);
  var g = Math.min(255, parseInt(hex.substr(2,2), 16) + amount);
  var b = Math.min(255, parseInt(hex.substr(4,2), 16) + amount);
  return '#' + r.toString(16).padStart(2,'0') + g.toString(16).padStart(2,'0') + b.toString(16).padStart(2,'0');
}

function saveSimulationHistory(title, riskLevel) {
  var history = JSON.parse(localStorage.getItem('wwtp_simulation_history') || '[]');
  history.unshift({ date: new Date().toLocaleString(), title: title, risk: riskLevel });
  if (history.length > 10) history = history.slice(0, 10);
  localStorage.setItem('wwtp_simulation_history', JSON.stringify(history));
  loadSimulationHistory();
}

function loadSimulationHistory() {
  var historyDiv = document.getElementById('simulationHistory');
  if (!historyDiv) return;
  var history = JSON.parse(localStorage.getItem('wwtp_simulation_history') || '[]');
  if (history.length === 0) {
    historyDiv.innerHTML = '<div style="text-align:center;color:#64748b;padding:20px;font-size:13px">No simulations run yet.</div>';
    return;
  }
  var html = '';
  history.forEach(function(item) {
    var riskColor = item.risk === 'CRITICAL' ? '#ef4444' : item.risk === 'HIGH' ? '#f59e0b' : item.risk === 'MODERATE' ? '#eab308' : '#22c55e';
    html += '<div style="background:rgba(30,41,59,0.5);padding:12px;border-radius:8px;margin-bottom:8px;border-left:3px solid ' + riskColor + '"><div style="display:flex;justify-content:space-between"><span style="font-weight:600;color:#f0f9ff;font-size:13px">' + item.title + '</span><span style="font-size:11px;color:#64748b">' + item.date + '</span></div><div style="font-size:11px;color:' + riskColor + ';margin-top:4px">' + item.risk + ' RISK</div></div>';
  });
  historyDiv.innerHTML = html;
}

function clearSimulationHistory() {
  if (confirm('Clear simulation history?')) {
    localStorage.removeItem('wwtp_simulation_history');
    loadSimulationHistory();
    showToast('History cleared', 'info');
  }
}

function printSimulation() { window.print(); }
function saveSimulation() { showToast('Simulation saved', 'success'); }
function shareSimulation() { showToast('Export feature coming soon', 'info'); }

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
  loadSimulationHistory();
});

// ========== END PROCESS SIMULATIONS ==========

// ========== TEXAS CERTIFICATION PRACTICE TESTS v9.9.24 ==========

const CertQuestionBank = {
  D: {
    math: [
      { q: "A tank is 20 feet long, 10 feet wide, and 8 feet deep. What is the volume in gallons?", a: ["11,968 gallons", "12,000 gallons", "1,600 gallons", "119,680 gallons"], correct: 0, explain: "Volume = L √ó W √ó D √ó 7.48 gal/cf = 20 √ó 10 √ó 8 √ó 7.48 = 11,968 gallons" },
      { q: "If a pump moves 500 GPM, how many gallons per day (GPD) is this?", a: ["720,000 GPD", "500,000 GPD", "12,000 GPD", "30,000 GPD"], correct: 0, explain: "GPD = GPM √ó 60 min √ó 24 hr = 500 √ó 60 √ó 24 = 720,000 GPD" },
      { q: "Convert 2.5 MGD to GPM.", a: ["1,736 GPM", "2,500 GPM", "1,042 GPM", "4,167 GPM"], correct: 0, explain: "GPM = MGD √ó 1,000,000 √∑ 1,440 min/day = 2.5 √ó 1,000,000 √∑ 1,440 = 1,736 GPM" },
      { q: "What is 15% of 2,400?", a: ["360", "240", "36", "3,600"], correct: 0, explain: "15% √ó 2,400 = 0.15 √ó 2,400 = 360" },
      { q: "A pipe has a diameter of 8 inches. What is the area in square feet?", a: ["0.349 sq ft", "50.3 sq ft", "0.44 sq ft", "3.49 sq ft"], correct: 0, explain: "Area = œÄ √ó r¬≤ = 3.14 √ó (4/12)¬≤ = 3.14 √ó 0.111 = 0.349 sq ft" },
      { q: "How many pounds of chlorine are in 50 gallons of 12% sodium hypochlorite solution (SG=1.2)?", a: ["60 lbs", "50 lbs", "72 lbs", "6 lbs"], correct: 0, explain: "Lbs = gallons √ó 8.34 √ó SG √ó % = 50 √ó 8.34 √ó 1.2 √ó 0.12 = 60 lbs" },
      { q: "If detention time is 4 hours and volume is 50,000 gallons, what is the flow rate in GPM?", a: ["208 GPM", "12,500 GPM", "833 GPM", "3,125 GPM"], correct: 0, explain: "GPM = Volume √∑ (DT √ó 60) = 50,000 √∑ (4 √ó 60) = 208 GPM" },
      { q: "A motor runs 18 hours per day. What percentage of the day is it running?", a: ["75%", "18%", "82%", "25%"], correct: 0, explain: "% = 18 hrs √∑ 24 hrs √ó 100 = 75%" },
      { q: "How many cubic feet are in a tank that holds 10,000 gallons?", a: ["1,337 cf", "748 cf", "10,000 cf", "74,800 cf"], correct: 0, explain: "Cubic feet = gallons √∑ 7.48 = 10,000 √∑ 7.48 = 1,337 cf" },
      { q: "A circular tank has a diameter of 50 feet. What is the area?", a: ["1,963 sq ft", "157 sq ft", "7,854 sq ft", "785 sq ft"], correct: 0, explain: "Area = œÄ √ó r¬≤ = 3.14 √ó 25¬≤ = 3.14 √ó 625 = 1,963 sq ft" },
      { q: "Convert 68¬∞F to Celsius.", a: ["20¬∞C", "36¬∞C", "15¬∞C", "25¬∞C"], correct: 0, explain: "¬∞C = (¬∞F - 32) √ó 5/9 = (68 - 32) √ó 5/9 = 36 √ó 0.556 = 20¬∞C" },
      { q: "What is the weight of 1,000 gallons of water?", a: ["8,340 lbs", "1,000 lbs", "8.34 lbs", "834 lbs"], correct: 0, explain: "Weight = gallons √ó 8.34 lbs/gal = 1,000 √ó 8.34 = 8,340 lbs" }
    ],
    biology: [
      { q: "What type of bacteria are responsible for breaking down organic matter in activated sludge?", a: ["Aerobic heterotrophs", "Anaerobic autotrophs", "Nitrifiers", "Methanogens"], correct: 0, explain: "Aerobic heterotrophs use oxygen and consume organic carbon for energy and growth." },
      { q: "What does BOD measure?", a: ["Oxygen demand of organic matter", "Bacteria count", "pH level", "Chlorine residual"], correct: 0, explain: "BOD (Biochemical Oxygen Demand) measures the amount of oxygen bacteria need to decompose organic matter." },
      { q: "What causes 'rising sludge' in a secondary clarifier?", a: ["Denitrification releasing nitrogen gas", "Too much chlorine", "High pH", "Low temperature"], correct: 0, explain: "Denitrification converts nitrate to nitrogen gas, which gets trapped in sludge floc and causes it to float." },
      { q: "What organism causes filamentous bulking?", a: ["Filamentous bacteria like Nocardia", "Protozoa", "Algae", "Viruses"], correct: 0, explain: "Filamentous bacteria grow in long strands that interfere with settling, causing bulking." },
      { q: "What is the purpose of Return Activated Sludge (RAS)?", a: ["Maintain MLSS concentration", "Add chlorine", "Remove grit", "Increase pH"], correct: 0, explain: "RAS returns settled microorganisms to the aeration basin to maintain proper MLSS levels." },
      { q: "What type of organisms convert ammonia to nitrate?", a: ["Nitrifying bacteria", "Heterotrophs", "Anaerobes", "Algae"], correct: 0, explain: "Nitrifying bacteria (Nitrosomonas and Nitrobacter) convert ammonia to nitrite, then to nitrate." },
      { q: "Healthy activated sludge should have what SVI range?", a: ["80-150 mL/g", "300-500 mL/g", "10-30 mL/g", "500-800 mL/g"], correct: 0, explain: "SVI of 80-150 indicates good settling sludge. Higher values indicate bulking problems." },
      { q: "What is the food source for bacteria in activated sludge?", a: ["Organic matter (BOD)", "Chlorine", "Oxygen only", "Sand"], correct: 0, explain: "Bacteria consume organic matter (measured as BOD) as their food source for energy and growth." },
      { q: "What does MLSS stand for?", a: ["Mixed Liquor Suspended Solids", "Maximum Liquid Sludge System", "Measured Liquid Solid Sample", "Mixed Level Sludge Settling"], correct: 0, explain: "MLSS is Mixed Liquor Suspended Solids - the concentration of solids in the aeration basin." },
      { q: "What is the role of protozoa in activated sludge?", a: ["Consume bacteria and clarify effluent", "Produce oxygen", "Break down sludge", "Add nutrients"], correct: 0, explain: "Protozoa feed on free-swimming bacteria, helping to clarify the effluent and indicate healthy conditions." }
    ],
    safety: [
      { q: "What does LOTO stand for?", a: ["Lockout/Tagout", "Look Out/Turn Off", "Lock On/Tag On", "Lift Out/Take Out"], correct: 0, explain: "Lockout/Tagout is a safety procedure to ensure equipment is properly shut off and not started during maintenance." },
      { q: "What is the OSHA permissible exposure limit (PEL) for hydrogen sulfide (H2S)?", a: ["10 ppm", "50 ppm", "100 ppm", "1 ppm"], correct: 0, explain: "OSHA PEL for H2S is 10 ppm as an 8-hour time-weighted average." },
      { q: "What must be done before entering a confined space?", a: ["Test atmosphere, have rescue plan, get permit", "Just wear PPE", "Nothing special", "Turn off lights"], correct: 0, explain: "Confined space entry requires atmospheric testing, rescue plan, entry permit, and trained personnel." },
      { q: "At what H2S concentration is it immediately dangerous to life and health (IDLH)?", a: ["100 ppm", "10 ppm", "500 ppm", "50 ppm"], correct: 0, explain: "H2S at 100 ppm is considered IDLH - immediately dangerous to life and health." },
      { q: "What PPE is required when handling chlorine?", a: ["Face shield, gloves, respirator", "Just gloves", "No PPE needed", "Hard hat only"], correct: 0, explain: "Chlorine handling requires face shield, chemical-resistant gloves, and appropriate respiratory protection." },
      { q: "What is the minimum oxygen level required for confined space entry?", a: ["19.5%", "21%", "16%", "23.5%"], correct: 0, explain: "OSHA requires at least 19.5% oxygen for safe confined space entry. Normal air is 20.9%." },
      { q: "What characteristic of H2S makes it especially dangerous?", a: ["It deadens the sense of smell", "It is visible", "It is heavier than air only", "It has a strong odor at all levels"], correct: 0, explain: "H2S deadens the sense of smell at higher concentrations, so you can't smell it when it's most dangerous." },
      { q: "What is the maximum oxygen level allowed in a confined space?", a: ["23.5%", "25%", "21%", "30%"], correct: 0, explain: "Oxygen above 23.5% creates a fire and explosion hazard due to oxygen enrichment." },
      { q: "How often should portable gas detectors be calibrated?", a: ["According to manufacturer specs, typically monthly", "Once a year", "Never", "Only when broken"], correct: 0, explain: "Gas detectors should be calibrated per manufacturer specifications, usually monthly, to ensure accuracy." },
      { q: "What color is chlorine gas?", a: ["Greenish-yellow", "Colorless", "Blue", "Red"], correct: 0, explain: "Chlorine gas has a distinctive greenish-yellow color and pungent odor." }
    ],
    operations: [
      { q: "What is the purpose of a bar screen?", a: ["Remove large debris", "Kill bacteria", "Add chemicals", "Measure flow"], correct: 0, explain: "Bar screens remove large objects like rags, sticks, and debris that could damage equipment." },
      { q: "What is the typical detention time for a primary clarifier?", a: ["1.5-2.5 hours", "15-30 minutes", "8-12 hours", "5-7 days"], correct: 0, explain: "Primary clarifiers typically have 1.5-2.5 hour detention time for adequate solids settling." },
      { q: "What does WAS stand for?", a: ["Waste Activated Sludge", "Water And Solids", "Wet Air System", "Wastewater Assessment Survey"], correct: 0, explain: "WAS is Waste Activated Sludge - excess sludge wasted from the system to maintain proper SRT." },
      { q: "What is the purpose of grit removal?", a: ["Protect downstream equipment", "Kill pathogens", "Add oxygen", "Adjust pH"], correct: 0, explain: "Grit removal protects pumps and equipment from abrasion and prevents accumulation in tanks." },
      { q: "What is a typical MLSS concentration for conventional activated sludge?", a: ["2,000-4,000 mg/L", "100-500 mg/L", "10,000-15,000 mg/L", "50-100 mg/L"], correct: 0, explain: "Conventional activated sludge typically operates at 2,000-4,000 mg/L MLSS." },
      { q: "What is the purpose of aeration in activated sludge?", a: ["Supply oxygen and provide mixing", "Kill bacteria", "Remove solids", "Add chlorine"], correct: 0, explain: "Aeration provides dissolved oxygen for bacteria and keeps solids in suspension." },
      { q: "What is the function of a scum baffle?", a: ["Prevent floating material from leaving", "Mix the water", "Add chemicals", "Measure flow"], correct: 0, explain: "Scum baffles prevent floating materials like grease and scum from leaving with the effluent." },
      { q: "What is the purpose of a weir in a clarifier?", a: ["Control effluent discharge uniformly", "Mix the sludge", "Add chlorine", "Measure temperature"], correct: 0, explain: "Weirs ensure uniform discharge of clarified effluent around the tank perimeter." },
      { q: "What is the first step in responding to a plant upset?", a: ["Identify the problem", "Call the supervisor", "Go home", "Ignore it"], correct: 0, explain: "First identify what's wrong, then you can take appropriate corrective action." },
      { q: "How often should clarifier mechanisms be inspected?", a: ["Daily", "Yearly", "Never", "Every 5 years"], correct: 0, explain: "Daily inspections help catch problems early before they cause major failures." }
    ],
    regulations: [
      { q: "What agency regulates wastewater treatment in Texas?", a: ["TCEQ", "EPA only", "OSHA", "FDA"], correct: 0, explain: "The Texas Commission on Environmental Quality (TCEQ) is the state agency that regulates wastewater in Texas." },
      { q: "How often must a Class D operator renew their license?", a: ["Every 3 years", "Every year", "Every 5 years", "Never"], correct: 0, explain: "Texas wastewater operator licenses must be renewed every 3 years." },
      { q: "What is the purpose of a TPDES permit?", a: ["Authorize discharge to state waters", "License operators", "Test equipment", "Train staff"], correct: 0, explain: "TPDES (Texas Pollutant Discharge Elimination System) permits authorize and regulate wastewater discharge." },
      { q: "How many CEUs are required for license renewal?", a: ["30 hours (3 CEUs)", "10 hours", "50 hours", "No CEUs required"], correct: 0, explain: "Texas requires 30 contact hours (3 CEUs) of continuing education per 3-year renewal cycle." },
      { q: "What must be reported to TCEQ within 24 hours?", a: ["Permit violations and bypasses", "Normal operations", "Routine maintenance", "Staff changes"], correct: 0, explain: "Permit violations, bypasses, and upsets must be reported to TCEQ within 24 hours." },
      { q: "What document specifies effluent limits for a plant?", a: ["TPDES permit", "Operator license", "Safety manual", "Equipment manual"], correct: 0, explain: "The TPDES permit specifies all effluent limits, monitoring requirements, and compliance conditions." },
      { q: "Who is responsible for ensuring permit compliance?", a: ["The operator on duty", "Only the supervisor", "TCEQ", "The city council"], correct: 0, explain: "The operator on duty is responsible for ensuring the plant operates in compliance with permits." },
      { q: "How long must daily operating records be kept?", a: ["3 years minimum", "1 month", "Forever", "1 week"], correct: 0, explain: "Most operating records must be retained for at least 3 years per TCEQ requirements." }
    ]
  },
  C: {
    math: [
      { q: "Calculate the F/M ratio if BOD loading is 1,200 lbs/day and MLVSS is 4,800 lbs.", a: ["0.25", "4.0", "0.025", "2.5"], correct: 0, explain: "F/M = BOD Loading √∑ MLVSS = 1,200 √∑ 4,800 = 0.25" },
      { q: "What is the SRT if MLSS is 3,000 mg/L, volume is 1.5 MG, and WAS is 5,000 GPD at 8,000 mg/L?", a: ["11.25 days", "15 days", "5 days", "22.5 days"], correct: 0, explain: "SRT = (MLSS √ó Vol √ó 8.34) √∑ (WAS √ó WAS conc √ó 8.34) = (3,000 √ó 1.5) √∑ (0.005 √ó 8,000) = 11.25 days" },
      { q: "Calculate weir loading rate if flow is 2 MGD and weir length is 200 feet.", a: ["10,000 GPD/ft", "1,000 GPD/ft", "400 GPD/ft", "100,000 GPD/ft"], correct: 0, explain: "Weir Loading = Flow √∑ Weir Length = 2,000,000 √∑ 200 = 10,000 GPD/ft" },
      { q: "What is the surface overflow rate for a clarifier with 3 MGD flow and 5,000 sq ft area?", a: ["600 GPD/sq ft", "1,667 GPD/sq ft", "60 GPD/sq ft", "15,000 GPD/sq ft"], correct: 0, explain: "SOR = Flow √∑ Surface Area = 3,000,000 √∑ 5,000 = 600 GPD/sq ft" },
      { q: "Calculate chlorine demand if dosage is 5 mg/L and residual is 1.5 mg/L.", a: ["3.5 mg/L", "6.5 mg/L", "5 mg/L", "1.5 mg/L"], correct: 0, explain: "Chlorine Demand = Dose - Residual = 5 - 1.5 = 3.5 mg/L" },
      { q: "How many lbs/day of BOD enter a plant with 4 MGD flow and 200 mg/L BOD?", a: ["6,672 lbs/day", "800 lbs/day", "667 lbs/day", "8,000 lbs/day"], correct: 0, explain: "lbs/day = Flow (MGD) √ó Conc (mg/L) √ó 8.34 = 4 √ó 200 √ó 8.34 = 6,672 lbs/day" },
      { q: "Calculate the sludge volume index (SVI) if settled volume is 250 mL and MLSS is 2,500 mg/L.", a: ["100 mL/g", "10 mL/g", "625 mL/g", "1,000 mL/g"], correct: 0, explain: "SVI = (Settled Vol √ó 1,000) √∑ MLSS = (250 √ó 1,000) √∑ 2,500 = 100 mL/g" },
      { q: "What is the hydraulic loading rate for a trickling filter with 1.5 MGD flow and 0.25 acre surface?", a: ["6 MGD/acre", "0.375 MGD/acre", "37.5 MGD/acre", "0.6 MGD/acre"], correct: 0, explain: "HLR = Flow √∑ Area = 1.5 √∑ 0.25 = 6 MGD/acre" },
      { q: "Calculate percent removal if influent BOD is 220 mg/L and effluent is 15 mg/L.", a: ["93.2%", "6.8%", "85%", "14.7%"], correct: 0, explain: "% Removal = (Inf - Eff) √∑ Inf √ó 100 = (220 - 15) √∑ 220 √ó 100 = 93.2%" },
      { q: "What is the solids loading rate if sludge flow is 0.05 MGD at 1% solids to a thickener with 500 sq ft?", a: ["8.34 lbs/sq ft/day", "100 lbs/sq ft/day", "0.83 lbs/sq ft/day", "834 lbs/sq ft/day"], correct: 0, explain: "SLR = (Flow √ó % √ó 8.34 √ó 1,000,000) √∑ (Area √ó 100) = (0.05 √ó 1 √ó 8.34 √ó 10,000) √∑ 500 = 8.34" }
    ],
    biology: [
      { q: "What is the optimal pH range for nitrification?", a: ["7.2-8.0", "5.5-6.5", "8.5-9.5", "4.0-5.0"], correct: 0, explain: "Nitrifying bacteria perform best at pH 7.2-8.0. Below 6.8, nitrification rates drop significantly." },
      { q: "What minimum SRT is needed for nitrification at 20¬∞C?", a: ["8-10 days", "2-3 days", "1 day", "30+ days"], correct: 0, explain: "At 20¬∞C, minimum SRT for reliable nitrification is 8-10 days to prevent nitrifier washout." },
      { q: "What alkalinity is consumed per mg/L of ammonia nitrified?", a: ["7.14 mg/L as CaCO3", "1 mg/L", "3.5 mg/L", "14.3 mg/L"], correct: 0, explain: "Nitrification consumes 7.14 mg/L alkalinity (as CaCO3) per mg/L of ammonia oxidized." },
      { q: "What causes pin floc or dispersed growth?", a: ["Over-aeration or young sludge", "Low DO", "High SRT", "Cold temperature"], correct: 0, explain: "Pin floc results from over-aeration, very young sludge, or toxic conditions breaking up floc." },
      { q: "What DO level is needed for complete nitrification?", a: ["2.0+ mg/L", "0.5 mg/L", "0.1 mg/L", "5.0+ mg/L"], correct: 0, explain: "Nitrification requires DO above 2.0 mg/L. Below 1.0 mg/L, nitrification is severely limited." },
      { q: "What does MCRT stand for?", a: ["Mean Cell Residence Time", "Main Clarifier Retention Time", "Minimum Chemical Required Treatment", "Maximum Concentration Reduction Target"], correct: 0, explain: "MCRT (Mean Cell Residence Time) is the average time microorganisms spend in the system, same as SRT." },
      { q: "What bacteria genus converts ammonia to nitrite?", a: ["Nitrosomonas", "Nitrobacter", "E. coli", "Nocardia"], correct: 0, explain: "Nitrosomonas bacteria convert ammonia (NH3) to nitrite (NO2-) in the first step of nitrification." },
      { q: "What indicates old sludge in microscopy?", a: ["Many rotifers and few bacteria", "Only bacteria visible", "No organisms", "Green algae"], correct: 0, explain: "Old sludge shows many higher organisms like rotifers and nematodes, indicating high SRT." },
      { q: "What F/M ratio indicates a plant is underloaded?", a: ["Below 0.15", "Above 0.5", "0.25-0.35", "1.0-2.0"], correct: 0, explain: "F/M below 0.15 indicates underloading, which can lead to old sludge and pin floc." },
      { q: "What organism indicates good activated sludge health?", a: ["Stalked ciliates like Vorticella", "Filamentous bacteria", "Rotifers only", "No organisms"], correct: 0, explain: "Stalked ciliates like Vorticella indicate good floc formation and healthy conditions." }
    ],
    chemistry: [
      { q: "What happens to free ammonia percentage as pH increases?", a: ["Increases", "Decreases", "Stays the same", "Becomes zero"], correct: 0, explain: "Free ammonia (NH3) increases with pH. At pH 9.5, about 50% of total ammonia is in toxic free form." },
      { q: "What is the chemical formula for calcium hypochlorite?", a: ["Ca(OCl)2", "NaOCl", "Cl2", "HOCl"], correct: 0, explain: "Calcium hypochlorite is Ca(OCl)2, commonly called HTH or cal-hypo, containing 65-70% available chlorine." },
      { q: "Which form of chlorine is most effective for disinfection?", a: ["HOCl (hypochlorous acid)", "OCl- (hypochlorite ion)", "Cl2 (chlorine gas)", "NH2Cl (monochloramine)"], correct: 0, explain: "HOCl (hypochlorous acid) is 80-100 times more effective than OCl- for disinfection." },
      { q: "What causes struvite formation?", a: ["High pH with magnesium, ammonia, and phosphate", "Low pH", "High chlorine", "Low temperature"], correct: 0, explain: "Struvite (MgNH4PO4) forms when pH is high and magnesium, ammonia, and phosphate are present." },
      { q: "How much oxygen is required to oxidize 1 mg/L of ammonia to nitrate?", a: ["4.6 mg/L", "1.0 mg/L", "2.0 mg/L", "7.14 mg/L"], correct: 0, explain: "Complete nitrification requires 4.6 mg O2 per mg NH3-N oxidized (4.57 theoretical)." },
      { q: "What is the typical chlorine dose for wastewater disinfection?", a: ["5-15 mg/L", "0.1-0.5 mg/L", "50-100 mg/L", "200+ mg/L"], correct: 0, explain: "Typical chlorine dose for wastewater disinfection is 5-15 mg/L depending on quality." },
      { q: "What pH maximizes hypochlorous acid (HOCl) concentration?", a: ["Below 7.5", "Above 9.0", "Exactly 7.0", "Above 11"], correct: 0, explain: "Below pH 7.5, most chlorine is in the more effective HOCl form. Above 7.5, OCl- dominates." },
      { q: "What is breakpoint chlorination?", a: ["Adding enough chlorine to oxidize all ammonia", "The point chlorine stops working", "When equipment breaks", "Maximum chlorine dose"], correct: 0, explain: "Breakpoint is when enough chlorine is added to oxidize all ammonia and provide free residual." }
    ],
    hydraulics: [
      { q: "What is the velocity in a pipe with 2 MGD flow and 12-inch diameter?", a: ["3.54 fps", "1.0 fps", "10 fps", "0.35 fps"], correct: 0, explain: "V = Flow/Area = (2 MGD √ó 1.547) √∑ 0.785 sq ft = 3.54 fps" },
      { q: "Head loss in a pipe is most affected by:", a: ["Velocity and pipe roughness", "Temperature only", "Pipe color", "Time of day"], correct: 0, explain: "Head loss increases with velocity squared and pipe roughness (friction factor)." },
      { q: "What is total dynamic head (TDH)?", a: ["Static head + friction losses + velocity head", "Only static head", "Pump efficiency", "Flow rate"], correct: 0, explain: "TDH = Static lift + Static discharge + Friction losses + Velocity head" },
      { q: "What happens to flow when pipe diameter is doubled?", a: ["Flow capacity increases by factor of 4", "Flow doubles", "Flow stays same", "Flow decreases"], correct: 0, explain: "Flow capacity increases with diameter squared - doubling diameter quadruples capacity." },
      { q: "What is the purpose of a check valve?", a: ["Prevent reverse flow", "Control flow rate", "Measure pressure", "Filter solids"], correct: 0, explain: "Check valves prevent backflow, protecting pumps and ensuring one-way flow." },
      { q: "What causes water hammer?", a: ["Sudden valve closure", "Low pressure", "High temperature", "Pipe corrosion"], correct: 0, explain: "Water hammer is caused by sudden changes in flow velocity, typically from quick valve closure." }
    ],
    operations: [
      { q: "What does a high SVI indicate?", a: ["Poor settling sludge (bulking)", "Excellent settling", "Low MLSS", "High pH"], correct: 0, explain: "High SVI (>150) indicates poor settling, often due to filamentous bulking or other problems." },
      { q: "How do you respond to low DO in aeration?", a: ["Increase air flow or reduce loading", "Decrease air flow", "Add chlorine", "Lower pH"], correct: 0, explain: "Low DO requires increasing aeration, reducing organic loading, or checking for equipment problems." },
      { q: "What is the typical RAS rate as a percentage of influent flow?", a: ["25-100%", "1-5%", "200-300%", "500%"], correct: 0, explain: "RAS rates typically range from 25-100% of influent flow, depending on settling characteristics." },
      { q: "What does a rising sludge blanket in the clarifier indicate?", a: ["Need to increase RAS or WAS", "Everything is normal", "Need to decrease aeration", "Add more chlorine"], correct: 0, explain: "Rising blanket means solids are accumulating - increase RAS to return solids or WAS to waste them." },
      { q: "What is the purpose of a selector zone?", a: ["Favor floc-forming bacteria over filaments", "Select which water to treat", "Choose chemicals", "Pick operators"], correct: 0, explain: "Selector zones create conditions that favor floc-forming bacteria and suppress filamentous organisms." },
      { q: "When should you increase WAS rate?", a: ["When MLSS or SRT is too high", "When effluent is clear", "When DO is low", "Never"], correct: 0, explain: "Increase WAS when MLSS is above target or SRT is too long, causing old sludge problems." },
      { q: "What indicates nitrification is occurring?", a: ["Decreasing alkalinity and ammonia", "Increasing BOD", "Rising pH", "Decreasing DO only"], correct: 0, explain: "Nitrification consumes alkalinity and ammonia while producing nitrate." },
      { q: "How do you respond to clarifier short-circuiting?", a: ["Check baffles and inlet distribution", "Increase chlorine", "Decrease flow", "Add more sludge"], correct: 0, explain: "Short-circuiting is usually a hydraulic problem - check baffles, weirs, and inlet structures." }
    ],
    regulations: [
      { q: "What is the typical BOD effluent limit for a municipal plant?", a: ["30 mg/L", "200 mg/L", "5 mg/L", "100 mg/L"], correct: 0, explain: "Most municipal TPDES permits have a 30 mg/L monthly average BOD limit (secondary treatment standard)." },
      { q: "What is the typical TSS effluent limit for secondary treatment?", a: ["30 mg/L", "100 mg/L", "5 mg/L", "200 mg/L"], correct: 0, explain: "Secondary treatment standard for TSS is typically 30 mg/L monthly average." },
      { q: "When must a Discharge Monitoring Report (DMR) be submitted?", a: ["Monthly, by the 20th", "Weekly", "Annually", "Only when violations occur"], correct: 0, explain: "DMRs are typically due monthly by the 20th of the following month." },
      { q: "What classification of plant requires a Class C operator?", a: ["Class C plant", "Any plant", "Only Class A plants", "No plants"], correct: 0, explain: "A plant classification determines the minimum operator certification required." },
      { q: "What is the purpose of composite sampling?", a: ["Get representative average over time", "Save money", "Reduce testing", "Meet minimum requirements only"], correct: 0, explain: "Composite samples provide a flow-weighted or time-weighted average that's more representative." }
    ]
  },
  B: {
    math: [
      { q: "Calculate oxygen uptake rate (OUR) if DO drops from 6.0 to 2.0 mg/L in 8 minutes.", a: ["30 mg/L/hr", "0.5 mg/L/hr", "4 mg/L/hr", "480 mg/L/hr"], correct: 0, explain: "OUR = (DO‚ÇÅ - DO‚ÇÇ) √∑ time = (6.0 - 2.0) √∑ (8/60) = 4 √∑ 0.133 = 30 mg/L/hr" },
      { q: "What is the organic loading rate for a trickling filter with 0.5 MGD, 180 mg/L BOD, and 15,000 cf volume?", a: ["50 lbs BOD/1000 cf/day", "500 lbs/day", "5 lbs/1000 cf/day", "0.5 lbs/1000 cf/day"], correct: 0, explain: "OLR = (Flow √ó BOD √ó 8.34) √∑ (Vol/1000) = (0.5 √ó 180 √ó 8.34) √∑ 15 = 50 lbs/1000 cf/day" },
      { q: "What is the sludge age if system has 50,000 lbs solids and wastes 2,500 lbs/day?", a: ["20 days", "2 days", "125 days", "0.05 days"], correct: 0, explain: "Sludge Age = Total Solids √∑ Solids Wasted = 50,000 √∑ 2,500 = 20 days" },
      { q: "Calculate the required WAS to achieve 12-day SRT with 30,000 lbs solids inventory.", a: ["2,500 lbs/day", "360,000 lbs/day", "250 lbs/day", "12,000 lbs/day"], correct: 0, explain: "WAS = Solids Inventory √∑ Target SRT = 30,000 √∑ 12 = 2,500 lbs/day" },
      { q: "What is the MCRT if aeration volume is 2 MG, MLSS is 3,500 mg/L, WAS is 8,000 GPD at 9,000 mg/L, and effluent TSS is 20 mg/L at 5 MGD?", a: ["9.7 days", "20 days", "5 days", "15 days"], correct: 0, explain: "MCRT = (Vol √ó MLSS) √∑ (WAS √ó WAS conc + Eff √ó Eff TSS) = (2 √ó 3500 √ó 8.34) √∑ ((0.008 √ó 9000 √ó 8.34) + (5 √ó 20 √ó 8.34))" },
      { q: "Calculate the recirculation ratio if RAS flow is 1.8 MGD and influent is 3.6 MGD.", a: ["0.50 or 50%", "2.0 or 200%", "0.25 or 25%", "5.4 MGD"], correct: 0, explain: "Recirculation Ratio = RAS Flow √∑ Influent Flow = 1.8 √∑ 3.6 = 0.50 or 50%" },
      { q: "What is the volatile fraction if MLSS is 3,200 mg/L and MLVSS is 2,400 mg/L?", a: ["75%", "133%", "25%", "80%"], correct: 0, explain: "Volatile Fraction = MLVSS √∑ MLSS √ó 100 = 2,400 √∑ 3,200 √ó 100 = 75%" },
      { q: "Calculate lbs/day of sludge solids if digester receives 20,000 GPD at 4% solids.", a: ["6,672 lbs/day", "800 lbs/day", "667 lbs/day", "80,000 lbs/day"], correct: 0, explain: "lbs/day = Flow (MG) √ó % solids √ó 8.34 √ó 10,000 = 0.02 √ó 4 √ó 8.34 √ó 10,000 = 6,672" }
    ],
    biology: [
      { q: "What is the Monod equation used for?", a: ["Modeling bacterial growth kinetics", "Calculating pipe flow", "Measuring chlorine", "Testing pH"], correct: 0, explain: "The Monod equation describes the relationship between substrate concentration and specific growth rate." },
      { q: "What is the typical yield coefficient for heterotrophic bacteria?", a: ["0.4-0.6 lb VSS/lb BOD", "0.1 lb/lb", "1.0 lb/lb", "5.0 lb/lb"], correct: 0, explain: "Heterotrophic yield is typically 0.4-0.6 lbs VSS produced per lb BOD removed." },
      { q: "What causes Nocardia foam?", a: ["High SRT, warm temps, oil/grease", "Low SRT", "Cold temperature", "High DO"], correct: 0, explain: "Nocardia thrives at high SRT, warm temperatures (>18¬∞C), and with oil/grease present." },
      { q: "What is the endogenous decay coefficient (Kd)?", a: ["Rate of cell mass decrease without food", "Growth rate", "Oxygen uptake", "Settling velocity"], correct: 0, explain: "Kd represents the rate bacteria consume their own cell mass when substrate is limited (0.05-0.1/day)." },
      { q: "How does temperature affect nitrification rate?", a: ["Rate doubles for each 10¬∞C increase up to optimum", "No effect", "Rate decreases with temperature", "Only affects pH"], correct: 0, explain: "Nitrification rate approximately doubles for each 10¬∞C increase, up to about 30¬∞C optimum." },
      { q: "What is the typical growth rate of nitrifiers compared to heterotrophs?", a: ["10 times slower", "10 times faster", "Same rate", "100 times faster"], correct: 0, explain: "Nitrifying bacteria grow much slower than heterotrophs, requiring longer SRT for establishment." },
      { q: "What filament is associated with low F/M conditions?", a: ["Microthrix parvicella", "Thiothrix", "Type 021N", "Sphaerotilus"], correct: 0, explain: "Microthrix parvicella is commonly found in systems with low F/M ratio and can cause foam." },
      { q: "What is observed when viewing dying sludge under microscope?", a: ["Sluggish organisms, sparse higher life", "Very active protozoa", "Many rotifers", "Green algae"], correct: 0, explain: "Dying or stressed sludge shows sluggish movement, dying organisms, and lack of healthy indicators." }
    ],
    operations: [
      { q: "What is the proper response to a toxic slug entering the plant?", a: ["Bypass to protect biology, increase WAS later", "Do nothing", "Increase aeration only", "Add chlorine"], correct: 0, explain: "Bypass protects biology from toxicity. After event, may need to seed with healthy sludge and rebuild slowly." },
      { q: "How do you troubleshoot increasing effluent TSS with good SVI?", a: ["Check clarifier hydraulics and RAS rates", "Increase WAS only", "Decrease aeration", "Add polymer"], correct: 0, explain: "Good SVI but high TSS suggests hydraulic problems, RAS rate issues, or clarifier short-circuiting." },
      { q: "What indicates the need to waste more sludge?", a: ["Increasing SRT, dark sludge, rising blanket", "Clear effluent", "Low MLSS", "High DO"], correct: 0, explain: "High SRT symptoms include dark/old sludge, thick blanket, possible pin floc - need more wasting." },
      { q: "How should you respond to a sudden pH drop to 6.2?", a: ["Add alkalinity, check for industrial discharge", "Do nothing", "Increase wasting", "Decrease aeration"], correct: 0, explain: "Low pH inhibits nitrification. Add lime/caustic for alkalinity and investigate industrial sources." },
      { q: "What is step-feed operation?", a: ["Introducing influent at multiple points along aeration basin", "Feeding operators in steps", "Gradual increase of chemicals", "Stepping on equipment"], correct: 0, explain: "Step-feed distributes influent along the aeration basin to balance oxygen demand and improve performance." },
      { q: "When would you use RAS chlorination?", a: ["To control filamentous bacteria", "Always", "To increase BOD removal", "Never - it's not allowed"], correct: 0, explain: "RAS chlorination at 2-10 lbs Cl2/1000 lbs MLSS can help control filamentous bulking." },
      { q: "What causes ashing in a digester?", a: ["Toxic conditions killing biology", "Normal operation", "Too much mixing", "Low temperature"], correct: 0, explain: "Ashing occurs when digester biology is killed by toxics or other upsets, turning contents gray." },
      { q: "How do you increase the volatile solids reduction in a digester?", a: ["Increase temperature and detention time", "Decrease temperature", "Add raw sludge faster", "Reduce mixing"], correct: 0, explain: "Higher temperature (mesophilic or thermophilic) and adequate detention time improve VS reduction." }
    ],
    regulations: [
      { q: "What triggers TCEQ enforcement action?", a: ["Permit violations, false reporting, unpermitted discharges", "Normal operations", "Routine maintenance", "Training sessions"], correct: 0, explain: "Enforcement can result from permit violations, falsifying reports, or unauthorized discharges." },
      { q: "What is a consent order?", a: ["Legal agreement to correct violations", "Permission to discharge", "Operator license", "Equipment manual"], correct: 0, explain: "A consent order is a legal agreement between TCEQ and a facility to correct violations on a schedule." },
      { q: "What is the penalty for falsifying DMR data?", a: ["Criminal charges and fines up to $10,000/day", "Warning letter only", "No penalty", "$100 fine"], correct: 0, explain: "Falsifying DMR data is a criminal offense with severe penalties including fines and imprisonment." },
      { q: "When is a sanitary sewer overflow (SSO) reportable?", a: ["All SSOs must be reported within 24 hours", "Only if over 1 MG", "Only if it reaches waters", "Never"], correct: 0, explain: "All SSOs must be reported to TCEQ within 24 hours, regardless of volume or destination." }
    ]
  },
  A: {
    math: [
      { q: "Calculate the oxygen transfer efficiency if standard oxygen transfer rate is 150 lbs O2/hr and actual field rate is 90 lbs O2/hr.", a: ["60%", "167%", "40%", "1.67%"], correct: 0, explain: "Efficiency = Actual/Standard √ó 100 = 90/150 √ó 100 = 60%" },
      { q: "Design a clarifier for 5 MGD with SOR of 600 GPD/sf. What surface area is needed?", a: ["8,333 sq ft", "3,000 sq ft", "833 sq ft", "30,000 sq ft"], correct: 0, explain: "Area = Flow √∑ SOR = 5,000,000 √∑ 600 = 8,333 sq ft" },
      { q: "Calculate the alpha factor if actual OTR is 2.5 lbs/hr/hp and clean water OTR is 3.2 lbs/hr/hp.", a: ["0.78", "1.28", "0.32", "5.7"], correct: 0, explain: "Alpha (Œ±) = Actual OTR √∑ Clean Water OTR = 2.5 √∑ 3.2 = 0.78" },
      { q: "What aeration volume is needed for 3 MGD with 6-hour detention time?", a: ["750,000 gallons", "18,000 gallons", "3,000,000 gallons", "500,000 gallons"], correct: 0, explain: "Volume = Flow √ó DT = 3,000,000 GPD √∑ 24 hr √ó 6 hr = 750,000 gallons" },
      { q: "Calculate the total nitrogen load if flow is 4 MGD with TKN of 35 mg/L and nitrate of 5 mg/L.", a: ["1,336 lbs/day", "167 lbs/day", "1,000 lbs/day", "334 lbs/day"], correct: 0, explain: "TN Load = Flow √ó (TKN + NO3) √ó 8.34 = 4 √ó (35 + 5) √ó 8.34 = 1,336 lbs/day" },
      { q: "What is the phosphorus removal efficiency if influent TP is 8 mg/L and effluent is 0.5 mg/L?", a: ["93.75%", "6.25%", "16 times", "7.5 mg/L"], correct: 0, explain: "% Removal = (8 - 0.5) √∑ 8 √ó 100 = 93.75%" },
      { q: "Calculate chemical sludge production if using 150 mg/L alum with 4 MGD flow.", a: ["5,004 lbs/day dry solids", "500 lbs/day", "50,000 lbs/day", "600 lbs/day"], correct: 0, explain: "Alum produces approximately 0.44 lbs solids per lb alum. 4 √ó 150 √ó 8.34 √ó 0.44 = 2,204 lbs/day (approximate)" }
    ],
    biology: [
      { q: "What is the kinetic term Œºmax?", a: ["Maximum specific growth rate", "Minimum sludge age", "Decay coefficient", "Half-saturation constant"], correct: 0, explain: "Œºmax is the maximum specific growth rate of bacteria under ideal conditions (1/time)." },
      { q: "What is Ks in Monod kinetics?", a: ["Half-saturation constant", "Death rate", "Yield coefficient", "Oxygen uptake"], correct: 0, explain: "Ks is the substrate concentration at which growth rate is half of maximum (mg/L)." },
      { q: "Calculate minimum SRT for nitrification if Œºmax is 0.5/day and safety factor is 2.5.", a: ["5 days", "1.25 days", "2 days", "0.2 days"], correct: 0, explain: "Min SRT = (1/Œºmax) √ó SF = (1/0.5) √ó 2.5 = 5 days" },
      { q: "What is the relationship between SRT and effluent quality?", a: ["Longer SRT generally improves quality up to a point", "No relationship", "Shorter SRT is better", "SRT only affects solids"], correct: 0, explain: "Longer SRT allows more complete treatment but too long causes pin floc and excess decay." },
      { q: "What is the typical yield for nitrifying bacteria?", a: ["0.10-0.15 lb VSS/lb NH3-N", "0.5 lb/lb", "1.0 lb/lb", "0.01 lb/lb"], correct: 0, explain: "Nitrifier yield is very low (0.10-0.15), which is why they're easily washed out at low SRT." },
      { q: "What is simultaneous nitrification-denitrification (SND)?", a: ["Both processes occurring in same tank via micro-zones", "Sequential tanks only", "Not possible", "Only in filters"], correct: 0, explain: "SND occurs when anoxic micro-zones within floc allow denitrification while bulk liquid is aerobic." },
      { q: "What is the anammox process?", a: ["Anaerobic ammonia oxidation", "Aerobic methane oxidation", "Standard nitrification", "Denitrification only"], correct: 0, explain: "Anammox bacteria convert ammonia and nitrite directly to nitrogen gas under anaerobic conditions." },
      { q: "What is enhanced biological phosphorus removal (EBPR)?", a: ["Using PAOs in anaerobic/aerobic sequence", "Chemical addition only", "Filtration", "Settling"], correct: 0, explain: "EBPR uses phosphorus accumulating organisms (PAOs) that uptake excess P under anaerobic/aerobic cycling." }
    ],
    regulations: [
      { q: "What are the key components of a TPDES permit?", a: ["Effluent limits, monitoring, reporting, compliance schedules", "Just flow limits", "Only chlorine limits", "Operator names"], correct: 0, explain: "TPDES permits include effluent limits, monitoring requirements, reporting schedules, and compliance provisions." },
      { q: "When is a formal Capacity Assessment required by TCEQ?", a: ["When flow reaches 75% of permitted capacity", "Never", "At 50% capacity", "Only for new plants"], correct: 0, explain: "TCEQ requires capacity assessment when flows approach 75% of permitted design capacity." },
      { q: "What is the minimum staffing requirement for a large activated sludge plant?", a: ["Based on facility classification and permit", "One operator", "No requirement", "24/7 staffing always"], correct: 0, explain: "Staffing depends on plant classification (A-D), technology, and permit requirements." },
      { q: "How long must plant records be retained?", a: ["3-5 years depending on type", "1 year", "Forever", "6 months"], correct: 0, explain: "Most operational records require 3-year retention; some permits require 5 years for monitoring data." },
      { q: "What is a Total Maximum Daily Load (TMDL)?", a: ["Maximum pollutant load a water body can receive", "Plant design capacity", "Chemical storage limit", "Daily flow limit"], correct: 0, explain: "TMDL establishes the maximum amount of a pollutant a water body can receive and still meet water quality standards." },
      { q: "What triggers the need for a permit amendment?", a: ["Significant changes in discharge, process, or limits", "Operator change", "Paint color", "Minor repairs"], correct: 0, explain: "Permit amendments are required for significant changes to discharge characteristics, treatment processes, or limits." }
    ],
    operations: [
      { q: "What is the optimal approach for managing a plant expansion project?", a: ["Phase construction, maintain treatment, coordinate with TCEQ", "Shut down completely", "No planning needed", "Just add tanks"], correct: 0, explain: "Expansions require phased construction, continuous treatment compliance, and TCEQ coordination." },
      { q: "How do you develop an effective preventive maintenance program?", a: ["Equipment inventory, criticality ranking, schedules, documentation", "Fix when broken", "No documentation needed", "Annual checks only"], correct: 0, explain: "Effective PM requires equipment lists, prioritization, scheduled tasks, and thorough record keeping." },
      { q: "What should be included in an emergency response plan?", a: ["Contact lists, procedures, equipment, training, drills", "Just phone numbers", "Nothing specific", "Only for spills"], correct: 0, explain: "ERP needs contacts, SOPs, equipment inventory, staff training, and regular practice drills." },
      { q: "What is asset management in wastewater?", a: ["Systematic approach to lifecycle cost and infrastructure renewal", "Buying new equipment", "Selling old equipment", "Inventory only"], correct: 0, explain: "Asset management balances performance, cost, and risk over the entire lifecycle of infrastructure." },
      { q: "How do you evaluate treatment alternatives for plant upgrade?", a: ["Technical feasibility, cost, operability, regulatory compliance", "Lowest cost only", "Newest technology only", "Consultant recommendation only"], correct: 0, explain: "Evaluation must consider technical, economic, operational, and regulatory factors comprehensively." },
      { q: "What is the purpose of a SCADA system?", a: ["Supervisory control and data acquisition for plant monitoring", "Security system", "Chemical addition only", "Billing system"], correct: 0, explain: "SCADA provides real-time monitoring, control, and data collection for plant operations." }
    ]
  }
};

// Current test state
let certState = {
  level: 'D',
  mode: 'study', // study or test
  questions: [],
  currentIndex: 0,
  answers: [],
  score: 0,
  startTime: null,
  timer: null,
  topic: null
};

function selectCertLevel(level) {
  certState.level = level;
  showCertModeSelect(level);
}

function showCertModeSelect(level) {
  const colors = { D: '#22c55e', C: '#3b82f6', B: '#f97316', A: '#a855f7' };
  const names = { D: 'Class D - Entry Level', C: 'Class C - Intermediate', B: 'Class B - Advanced', A: 'Class A - Expert' };
  
  const html = `
    <div style="text-align:center;padding:30px">
      <div style="font-size:48px;margin-bottom:16px">${level === 'D' ? 'üå±' : level === 'C' ? 'üìò' : level === 'B' ? 'üìô' : 'üëë'}</div>
      <div style="font-size:24px;font-weight:700;color:${colors[level]};margin-bottom:8px">${names[level]}</div>
      <p style="color:#94a3b8;margin-bottom:24px">Select test mode:</p>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:500px;margin:0 auto">
        <button onclick="startCertTest('${level}', 'study', 20)" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid #3b82f6;border-radius:16px;padding:24px;cursor:pointer;text-align:center">
          <div style="font-size:32px;margin-bottom:8px">üìñ</div>
          <div style="font-size:16px;font-weight:700;color:#60a5fa;margin-bottom:4px">Study Mode</div>
          <div style="font-size:12px;color:#94a3b8">20 questions, see explanations</div>
        </button>
        
        <button onclick="startCertTest('${level}', 'test', 50)" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid #f59e0b;border-radius:16px;padding:24px;cursor:pointer;text-align:center">
          <div style="font-size:32px;margin-bottom:8px">üìù</div>
          <div style="font-size:16px;font-weight:700;color:#fbbf24;margin-bottom:4px">Test Mode</div>
          <div style="font-size:12px;color:#94a3b8">50 questions, timed (2 hrs)</div>
        </button>
      </div>
      
      <button onclick="backToCertHome()" style="margin-top:24px;background:#475569;border:none;padding:12px 24px;border-radius:8px;color:white;cursor:pointer">‚Üê Back to Menu</button>
    </div>
  `;
  
  document.getElementById('certLevelSelect').innerHTML = html;
}

function startCertTest(level, mode, numQuestions) {
  certState.level = level;
  certState.mode = mode;
  certState.currentIndex = 0;
  certState.answers = new Array(numQuestions).fill(null);
  certState.score = 0;
  certState.startTime = Date.now();
  
  // Build question pool from all topics for this level
  let pool = [];
  const bank = CertQuestionBank[level];
  for (let topic in bank) {
    bank[topic].forEach((q, i) => {
      pool.push({ ...q, topic: topic, id: topic + '_' + i });
    });
  }
  
  // Shuffle and select questions
  pool = shuffleArray(pool);
  certState.questions = pool.slice(0, numQuestions);
  
  // Show test interface
  document.getElementById('certLevelSelect').style.display = 'none';
  document.getElementById('certTestMode').style.display = 'block';
  document.getElementById('certResults').style.display = 'none';
  
  // Update header
  const names = { D: 'Class D', C: 'Class C', B: 'Class B', A: 'Class A' };
  document.getElementById('certTestTitle').textContent = names[level] + (mode === 'study' ? ' Study Session' : ' Practice Exam');
  document.getElementById('certTotalQ').textContent = numQuestions;
  
  // Setup timer for test mode
  if (mode === 'test') {
    document.getElementById('certTimerBox').style.display = 'block';
    startCertTimer(120); // 2 hours
  } else {
    document.getElementById('certTimerBox').style.display = 'none';
  }
  
  // Build question navigator
  buildCertNav();
  
  // Show first question
  showCertQuestion(0);
}

function shuffleArray(array) {
  const arr = [...array];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function startCertTimer(minutes) {
  let timeLeft = minutes * 60;
  
  certState.timer = setInterval(() => {
    timeLeft--;
    const mins = Math.floor(timeLeft / 60);
    const secs = timeLeft % 60;
    document.getElementById('certTimer').textContent = 
      mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
    
    if (timeLeft <= 300) {
      document.getElementById('certTimer').style.color = '#ef4444';
    }
    
    if (timeLeft <= 0) {
      clearInterval(certState.timer);
      certEndTest();
    }
  }, 1000);
}

function showCertQuestion(index) {
  const q = certState.questions[index];
  certState.currentIndex = index;
  
  // Update progress
  document.getElementById('certCurrentQ').textContent = index + 1;
  document.getElementById('certProgressBar').style.width = ((index + 1) / certState.questions.length * 100) + '%';
  
  // Update score
  const correct = certState.answers.filter((a, i) => a === certState.questions[i]?.correct).length;
  const answered = certState.answers.filter(a => a !== null).length;
  const pct = answered > 0 ? Math.round(correct / answered * 100) : 0;
  document.getElementById('certScore').textContent = pct;
  
  // Topic display
  const topicNames = { math: 'üî¢ Math', biology: 'ü¶† Biology', chemistry: '‚öóÔ∏è Chemistry', hydraulics: 'üíß Hydraulics', safety: '‚ö†Ô∏è Safety', regulations: 'üìã TCEQ Regulations', operations: '‚öôÔ∏è Operations', solids: 'üóëÔ∏è Solids' };
  document.getElementById('certQuestionTopic').textContent = topicNames[q.topic] || q.topic;
  
  // Question text
  document.getElementById('certQuestionText').textContent = q.q;
  
  // Answer options
  let optionsHtml = '';
  const letters = ['A', 'B', 'C', 'D'];
  q.a.forEach((ans, i) => {
    const isSelected = certState.answers[index] === i;
    const showResult = certState.mode === 'study' && certState.answers[index] !== null;
    const isCorrect = i === q.correct;
    
    let bgColor = 'rgba(30,41,59,0.5)';
    let borderColor = '#475569';
    
    if (showResult) {
      if (isCorrect) {
        bgColor = 'rgba(34,197,94,0.2)';
        borderColor = '#22c55e';
      } else if (isSelected && !isCorrect) {
        bgColor = 'rgba(239,68,68,0.2)';
        borderColor = '#ef4444';
      }
    } else if (isSelected) {
      bgColor = 'rgba(59,130,246,0.2)';
      borderColor = '#3b82f6';
    }
    
    optionsHtml += `
      <button onclick="selectCertAnswer(${i})" style="background:${bgColor};border:2px solid ${borderColor};border-radius:10px;padding:14px 16px;cursor:pointer;text-align:left;display:flex;align-items:center;gap:12px;transition:all 0.2s" ${showResult ? 'disabled' : ''}>
        <span style="background:${isSelected ? '#3b82f6' : '#475569'};color:white;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px">${letters[i]}</span>
        <span style="color:#f0f9ff;font-size:14px">${ans}</span>
        ${showResult && isCorrect ? '<span style="margin-left:auto;color:#4ade80">‚úì</span>' : ''}
        ${showResult && isSelected && !isCorrect ? '<span style="margin-left:auto;color:#f87171">‚úó</span>' : ''}
      </button>
    `;
  });
  document.getElementById('certAnswerOptions').innerHTML = optionsHtml;
  
  // Explanation (study mode only)
  const explDiv = document.getElementById('certExplanation');
  if (certState.mode === 'study' && certState.answers[index] !== null) {
    document.getElementById('certExplanationText').textContent = q.explain;
    explDiv.style.display = 'block';
  } else {
    explDiv.style.display = 'none';
  }
  
  // Navigation buttons
  document.getElementById('certPrevBtn').disabled = index === 0;
  
  // Update nav
  updateCertNav();
}

function selectCertAnswer(answerIndex) {
  const q = certState.questions[certState.currentIndex];
  
  // In test mode, allow changing answers
  // In study mode, lock after first answer
  if (certState.mode === 'study' && certState.answers[certState.currentIndex] !== null) {
    return;
  }
  
  certState.answers[certState.currentIndex] = answerIndex;
  
  // Re-render question to show result (study mode) or selection (test mode)
  showCertQuestion(certState.currentIndex);
  
  // In study mode, auto-advance after short delay
  if (certState.mode === 'study') {
    setTimeout(() => {
      if (certState.currentIndex < certState.questions.length - 1) {
        // Don't auto-advance, let user read explanation
      }
    }, 500);
  }
}

function certPrevQuestion() {
  if (certState.currentIndex > 0) {
    showCertQuestion(certState.currentIndex - 1);
  }
}

function certNextQuestion() {
  if (certState.currentIndex < certState.questions.length - 1) {
    showCertQuestion(certState.currentIndex + 1);
  } else {
    certEndTest();
  }
}

function certSkipQuestion() {
  certNextQuestion();
}

function buildCertNav() {
  let html = '';
  for (let i = 0; i < certState.questions.length; i++) {
    html += `<button onclick="showCertQuestion(${i})" id="certNavBtn${i}" style="width:32px;height:32px;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;background:#475569;color:white">${i + 1}</button>`;
  }
  document.getElementById('certQuestionNav').innerHTML = html;
}

function updateCertNav() {
  for (let i = 0; i < certState.questions.length; i++) {
    const btn = document.getElementById('certNavBtn' + i);
    if (!btn) continue;
    
    const answer = certState.answers[i];
    const correct = certState.questions[i].correct;
    
    if (i === certState.currentIndex) {
      btn.style.background = '#3b82f6';
      btn.style.boxShadow = '0 0 10px rgba(59,130,246,0.5)';
    } else if (answer === null) {
      btn.style.background = '#475569';
      btn.style.boxShadow = 'none';
    } else if (answer === correct) {
      btn.style.background = '#22c55e';
      btn.style.boxShadow = 'none';
    } else {
      btn.style.background = '#ef4444';
      btn.style.boxShadow = 'none';
    }
  }
}

function certEndTest() {
  if (certState.timer) {
    clearInterval(certState.timer);
  }
  
  // Calculate results
  const correct = certState.answers.filter((a, i) => a === certState.questions[i]?.correct).length;
  const incorrect = certState.answers.filter((a, i) => a !== null && a !== certState.questions[i]?.correct).length;
  const pct = Math.round(correct / certState.questions.length * 100);
  
  const elapsed = Math.floor((Date.now() - certState.startTime) / 1000);
  const mins = Math.floor(elapsed / 60);
  const secs = elapsed % 60;
  const timeStr = mins + ':' + secs.toString().padStart(2, '0');
  
  // Determine pass/fail (70% passing)
  const passed = pct >= 70;
  
  // Update results display
  document.getElementById('certResultIcon').textContent = passed ? 'üéâ' : 'üìö';
  document.getElementById('certResultTitle').textContent = passed ? 'Congratulations!' : 'Keep Studying!';
  document.getElementById('certResultTitle').style.color = passed ? '#4ade80' : '#fbbf24';
  document.getElementById('certResultSubtitle').textContent = passed ? 'You passed the practice exam!' : 'You need 70% to pass. Review and try again!';
  
  document.getElementById('certFinalScore').textContent = pct + '%';
  document.getElementById('certFinalScore').style.color = passed ? '#4ade80' : '#f87171';
  document.getElementById('certCorrectCount').textContent = correct;
  document.getElementById('certIncorrectCount').textContent = incorrect;
  document.getElementById('certTimeSpent').textContent = timeStr;
  
  // Topic breakdown
  const topicStats = {};
  certState.questions.forEach((q, i) => {
    if (!topicStats[q.topic]) {
      topicStats[q.topic] = { correct: 0, total: 0 };
    }
    topicStats[q.topic].total++;
    if (certState.answers[i] === q.correct) {
      topicStats[q.topic].correct++;
    }
  });
  
  const topicNames = { math: 'üî¢ Math', biology: 'ü¶† Biology', chemistry: '‚öóÔ∏è Chemistry', hydraulics: 'üíß Hydraulics', safety: '‚ö†Ô∏è Safety', regulations: 'üìã TCEQ Regs', operations: '‚öôÔ∏è Operations', solids: 'üóëÔ∏è Solids' };
  
  let topicHtml = '<div style="display:grid;gap:8px">';
  for (let topic in topicStats) {
    const stat = topicStats[topic];
    const topicPct = Math.round(stat.correct / stat.total * 100);
    const barColor = topicPct >= 70 ? '#22c55e' : topicPct >= 50 ? '#f59e0b' : '#ef4444';
    
    topicHtml += `
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:120px;font-size:13px;color:#94a3b8">${topicNames[topic] || topic}</div>
        <div style="flex:1;background:#1e293b;border-radius:4px;height:20px;overflow:hidden">
          <div style="height:100%;background:${barColor};width:${topicPct}%;display:flex;align-items:center;justify-content:flex-end;padding-right:8px">
            <span style="font-size:11px;color:white;font-weight:600">${stat.correct}/${stat.total}</span>
          </div>
        </div>
        <div style="width:50px;text-align:right;font-weight:600;color:${barColor}">${topicPct}%</div>
      </div>
    `;
  }
  topicHtml += '</div>';
  document.getElementById('certTopicBreakdown').innerHTML = topicHtml;
  
  // Save to history
  saveCertHistory(certState.level, pct, correct, certState.questions.length, timeStr);
  
  // Show results
  document.getElementById('certTestMode').style.display = 'none';
  document.getElementById('certResults').style.display = 'block';
}

function saveCertHistory(level, score, correct, total, time) {
  let history = JSON.parse(localStorage.getItem('wwtp_cert_history') || '[]');
  history.unshift({
    date: new Date().toLocaleString(),
    level: level,
    score: score,
    correct: correct,
    total: total,
    time: time,
    passed: score >= 70
  });
  if (history.length > 20) history = history.slice(0, 20);
  localStorage.setItem('wwtp_cert_history', JSON.stringify(history));
  loadCertHistory();
  updateCertProgress();
}

function loadCertHistory() {
  const historyDiv = document.getElementById('certHistory');
  if (!historyDiv) return;
  
  const history = JSON.parse(localStorage.getItem('wwtp_cert_history') || '[]');
  if (history.length === 0) {
    historyDiv.innerHTML = '<div style="text-align:center;color:#64748b;padding:20px;font-size:13px">No tests taken yet.</div>';
    return;
  }
  
  let html = '';
  history.forEach(h => {
    const levelColors = { D: '#22c55e', C: '#3b82f6', B: '#f97316', A: '#a855f7' };
    html += `
      <div style="background:rgba(30,41,59,0.5);padding:12px;border-radius:8px;margin-bottom:8px;border-left:3px solid ${h.passed ? '#22c55e' : '#ef4444'}">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <span style="background:${levelColors[h.level]};color:white;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600">Class ${h.level}</span>
            <span style="color:#f0f9ff;font-weight:600;margin-left:8px">${h.score}%</span>
            <span style="color:#64748b;font-size:12px;margin-left:8px">(${h.correct}/${h.total})</span>
          </div>
          <span style="color:#64748b;font-size:11px">${h.date}</span>
        </div>
      </div>
    `;
  });
  historyDiv.innerHTML = html;
}

function updateCertProgress() {
  const history = JSON.parse(localStorage.getItem('wwtp_cert_history') || '[]');
  
  ['D', 'C', 'B', 'A'].forEach(level => {
    const levelHistory = history.filter(h => h.level === level);
    const progressDiv = document.getElementById('certProgress' + level);
    if (!progressDiv) return;
    
    if (levelHistory.length === 0) {
      progressDiv.innerHTML = '<span style="color:#94a3b8;font-size:11px">No tests taken yet</span>';
    } else {
      const best = Math.max(...levelHistory.map(h => h.score));
      const passed = levelHistory.some(h => h.passed);
      progressDiv.innerHTML = `
        <div style="font-size:13px;font-weight:600;color:${passed ? '#4ade80' : '#fbbf24'}">${passed ? '‚úì Passed' : 'Best: ' + best + '%'}</div>
        <div style="font-size:10px;color:#64748b">${levelHistory.length} test${levelHistory.length > 1 ? 's' : ''} taken</div>
      `;
    }
  });
}

function backToCertHome() {
  document.getElementById('certLevelSelect').style.display = 'block';
  document.getElementById('certTestMode').style.display = 'none';
  document.getElementById('certResults').style.display = 'none';
  
  // Restore original level select
  location.reload(); // Simple way to reset
}

function retakeCertTest() {
  startCertTest(certState.level, certState.mode, certState.questions.length);
}

function reviewCertTest() {
  certState.mode = 'study'; // Switch to study mode to see explanations
  document.getElementById('certResults').style.display = 'none';
  document.getElementById('certTestMode').style.display = 'block';
  showCertQuestion(0);
}

function startQuickQuiz() {
  certState.level = 'D';
  startCertTest('D', 'study', 10);
}

function startFullExam() {
  showCertModeSelect(certState.level || 'D');
}

function startTopicQuiz(topic) {
  certState.topic = topic;
  certState.mode = 'study';
  certState.currentIndex = 0;
  certState.answers = [];
  certState.score = 0;
  certState.startTime = Date.now();
  
  // Collect questions from all levels for this topic
  let pool = [];
  ['D', 'C', 'B', 'A'].forEach(level => {
    if (CertQuestionBank[level] && CertQuestionBank[level][topic]) {
      CertQuestionBank[level][topic].forEach((q, i) => {
        pool.push({ ...q, topic: topic, level: level, id: level + '_' + topic + '_' + i });
      });
    }
  });
  
  pool = shuffleArray(pool);
  certState.questions = pool.slice(0, Math.min(15, pool.length));
  certState.answers = new Array(certState.questions.length).fill(null);
  
  document.getElementById('certLevelSelect').style.display = 'none';
  document.getElementById('certTestMode').style.display = 'block';
  document.getElementById('certResults').style.display = 'none';
  
  const topicNames = { math: 'Math', biology: 'Biology', chemistry: 'Chemistry', hydraulics: 'Hydraulics', safety: 'Safety', regulations: 'TCEQ Regulations', operations: 'Operations', solids: 'Solids' };
  document.getElementById('certTestTitle').textContent = topicNames[topic] + ' Practice';
  document.getElementById('certTotalQ').textContent = certState.questions.length;
  document.getElementById('certTimerBox').style.display = 'none';
  
  buildCertNav();
  showCertQuestion(0);
}

function reviewMissed() {
  showToast('Review Missed - Coming soon!', 'info');
}

function showCertStats() {
  showToast('Progress stats modal coming soon!', 'info');
}

function clearCertHistory() {
  if (confirm('Clear all test history?')) {
    localStorage.removeItem('wwtp_cert_history');
    loadCertHistory();
    updateCertProgress();
    showToast('History cleared', 'info');
  }
}

function shareCertResults() {
  showToast('Share feature coming soon!', 'info');
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
  loadCertHistory();
  updateCertProgress();
});

// ========== END TEXAS CERTIFICATION ==========

// ========== APP VERSION ==========
const APP_VERSION = "3.4.0";
const BUILD_DATE = "Dec 23, 2025 - Shift Logbook, Alarm Manager, Energy Dashboard, Lab Tracker, Work Orders";
const PRODUCTION_MODE = true; // Set to true to disable debug logging

// ========== SECURITY UTILITIES ==========
// Sanitize user input to prevent XSS
function sanitizeInput(str) {
  if (typeof str !== 'string') return str;
  return str.replace(/[<>&"']/g, function(c) {
    return {'<':'&lt;', '>':'&gt;', '&':'&amp;', '"':'&quot;', "'":'&#39;'}[c];
  });
}

// Safe number parsing with bounds checking
function safeParseFloat(val, min, max, defaultVal) {
  var num = parseFloat(val);
  if (isNaN(num)) return defaultVal || 0;
  if (min !== undefined && num < min) return min;
  if (max !== undefined && num > max) return max;
  return num;
}

// Safe localStorage wrapper with error handling
var safeStorage = {
  get: function(key) {
    try {
      return localStorage.getItem(key);
    } catch(e) {
      console.warn('Storage read failed:', key);
      return null;
    }
  },
  set: function(key, value) {
    try {
      localStorage.setItem(key, value);
      return true;
    } catch(e) {
      console.warn('Storage write failed:', key);
      return false;
    }
  },
  remove: function(key) {
    try {
      localStorage.removeItem(key);
      return true;
    } catch(e) {
      return false;
    }
  }
};

// Safe console logging (respects production mode)
function debugLog() {
  if (!PRODUCTION_MODE && console && console.log) {
    console.log.apply(console, arguments);
  }
}

// Display version info in console
console.log("üè≠ WWTP Command Center");
console.log("üì¶ Version: " + APP_VERSION);
console.log("üìÖ Build: " + BUILD_DATE);
console.log("üîí Security: Enhanced input sanitization enabled");


// Core utilities
const $=id=>document.getElementById(id);
const $$=s=>document.querySelectorAll(s);

// ========== CALCULATOR FUNCTIONS (FIXED) ==========

function calcOLR() {
  var bod = parseFloat(document.getElementById('olr_bod').value) || 0;
  var flow = parseFloat(document.getElementById('olr_flow').value) || 0;
  var vol = parseFloat(document.getElementById('olr_vol').value) || 0;
  var load = bod * flow * 8.34;
  var volCf = vol * 1000000 / 7.48;
  var olr = vol > 0 ? (load / volCf) * 1000 : 0;
  document.getElementById('r_olr_load').textContent = load.toFixed(0);
  document.getElementById('r_olr').textContent = olr.toFixed(1);
}
function resetOLR() {
  document.getElementById('olr_bod').value = '200';
  document.getElementById('olr_flow').value = '5.0';
  document.getElementById('olr_vol').value = '1.0';
  document.getElementById('r_olr_load').textContent = '-';
  document.getElementById('r_olr').textContent = '-';
}

function calcFM() {
  var bod = parseFloat(document.getElementById('fm_bod').value) || 0;
  var mlvss = parseFloat(document.getElementById('fm_mlvss').value) || 0;
  var vol = parseFloat(document.getElementById('fm_vol').value) || 0;
  var mass = mlvss * vol * 8.34;
  var fm = mass > 0 ? bod / mass : 0;
  document.getElementById('r_fm_mass').textContent = mass.toFixed(0);
  document.getElementById('r_fm').textContent = fm.toFixed(3);
  document.getElementById('r_fm_status').textContent = fm >= 0.2 && fm <= 0.5 ? 'Optimal' : fm < 0.2 ? 'Low' : 'High';
}
function resetFM() {
  document.getElementById('fm_bod').value = '8340';
  document.getElementById('fm_mlvss').value = '2000';
  document.getElementById('fm_vol').value = '1.0';
  document.getElementById('r_fm_mass').textContent = '-';
  document.getElementById('r_fm').textContent = '-';
  document.getElementById('r_fm_status').textContent = '-';
}

function calcSRTmain() {
  var mlss = parseFloat(document.getElementById('srt_mlss').value) || 0;
  var vol = parseFloat(document.getElementById('srt_vol').value) || 0;
  var was = parseFloat(document.getElementById('srt_was').value) || 0;
  var wasTss = parseFloat(document.getElementById('srt_was_tss').value) || 0;
  var eff = parseFloat(document.getElementById('srt_eff').value) || 0;
  var effTss = parseFloat(document.getElementById('srt_eff_tss').value) || 0;
  var solids = mlss * vol * 8.34;
  var wasted = (was * wasTss * 8.34) + (eff * effTss * 8.34);
  var srt = wasted > 0 ? solids / wasted : 0;
  document.getElementById('r_srt_solids').textContent = solids.toFixed(0);
  document.getElementById('r_srt_wasted').textContent = wasted.toFixed(0);
  document.getElementById('r_srt').textContent = srt.toFixed(1);
  document.getElementById('r_srt_status').textContent = srt >= 5 && srt <= 15 ? 'Optimal' : srt < 5 ? 'Low' : 'High';
}
function resetSRTmain() {
  document.getElementById('srt_mlss').value = '2500';
  document.getElementById('srt_vol').value = '1.2';
  document.getElementById('srt_was').value = '0.05';
  document.getElementById('srt_was_tss').value = '8000';
  document.getElementById('srt_eff').value = '5.0';
  document.getElementById('srt_eff_tss').value = '10';
  document.getElementById('r_srt_solids').textContent = '-';
  document.getElementById('r_srt_wasted').textContent = '-';
  document.getElementById('r_srt').textContent = '-';
  document.getElementById('r_srt_status').textContent = '-';
}

function calcHRT() {
  var vol = parseFloat(document.getElementById('hrt_vol').value) || 0;
  var flow = parseFloat(document.getElementById('hrt_flow').value) || 0;
  var hrt = flow > 0 ? (vol / (flow * 1000000)) * 24 : 0;
  document.getElementById('r_hrt').textContent = hrt.toFixed(2);
  document.getElementById('r_hrt_status').textContent = hrt >= 4 && hrt <= 8 ? 'Optimal' : hrt < 4 ? 'Low' : 'High';
}
function resetHRT() {
  document.getElementById('hrt_vol').value = '500000';
  document.getElementById('hrt_flow').value = '2.0';
  document.getElementById('r_hrt').textContent = '-';
  document.getElementById('r_hrt_status').textContent = '-';
}

function calcBODeff() {
  var bodIn = parseFloat(document.getElementById('bod_in').value) || 0;
  var bodOut = parseFloat(document.getElementById('bod_out').value) || 0;
  var removed = bodIn - bodOut;
  var eff = bodIn > 0 ? (removed / bodIn) * 100 : 0;
  document.getElementById('r_bod_removed').textContent = removed.toFixed(0);
  document.getElementById('r_bod_eff').textContent = eff.toFixed(1);
  document.getElementById('r_bod_status').textContent = eff >= 85 ? 'Good' : 'Low';
}
function resetBODeff() {
  document.getElementById('bod_in').value = '200';
  document.getElementById('bod_out').value = '10';
  document.getElementById('r_bod_removed').textContent = '-';
  document.getElementById('r_bod_eff').textContent = '-';
  document.getElementById('r_bod_status').textContent = '-';
}

function calcSVI() {
  var vol = parseFloat(document.getElementById('svi_vol').value) || 0;
  var mlss = parseFloat(document.getElementById('svi_mlss').value) || 0;
  var svi = mlss > 0 ? (vol * 1000) / mlss : 0;
  document.getElementById('r_svi').textContent = svi.toFixed(0);
  var status = 'Poor';
  if (svi <= 100) status = 'Excellent';
  else if (svi <= 150) status = 'Good';
  else if (svi <= 200) status = 'Fair';
  document.getElementById('r_svi_status').textContent = status;
}
function resetSVI() {
  document.getElementById('svi_vol').value = '250';
  document.getElementById('svi_mlss').value = '2500';
  document.getElementById('r_svi').textContent = '-';
  document.getElementById('r_svi_status').textContent = '-';
}

function calcWAS() {
  var srt = parseFloat(document.getElementById('was_srt').value) || 0;
  var mlss = parseFloat(document.getElementById('was_mlss').value) || 0;
  var vol = parseFloat(document.getElementById('was_vol').value) || 0;
  var conc = parseFloat(document.getElementById('was_conc').value) || 0;
  var solids = mlss * vol * 8.34;
  var wasteLb = srt > 0 ? solids / srt : 0;
  var wasFlow = conc > 0 ? (wasteLb / (conc * 8.34)) * 1000000 : 0;
  document.getElementById('r_was_flow').textContent = wasFlow.toFixed(0);
  document.getElementById('r_was_lb').textContent = wasteLb.toFixed(0);
}
function resetWAS() {
  document.getElementById('was_srt').value = '10';
  document.getElementById('was_mlss').value = '2500';
  document.getElementById('was_vol').value = '1.0';
  document.getElementById('was_conc').value = '8000';
  document.getElementById('r_was_flow').textContent = '-';
  document.getElementById('r_was_lb').textContent = '-';
}

function calcRAS() {
  var flow = parseFloat(document.getElementById('ras_flow').value) || 0;
  var mlss = parseFloat(document.getElementById('ras_mlss').value) || 0;
  var tss = parseFloat(document.getElementById('ras_tss').value) || 0;
  var ratio = tss > mlss ? (mlss / (tss - mlss)) * 100 : 0;
  var rasFlow = flow * (ratio / 100);
  document.getElementById('r_ras_ratio').textContent = ratio.toFixed(0);
  document.getElementById('r_ras_flow').textContent = rasFlow.toFixed(2);
}
function resetRAS() {
  document.getElementById('ras_flow').value = '5.0';
  document.getElementById('ras_mlss').value = '2500';
  document.getElementById('ras_tss').value = '8000';
  document.getElementById('r_ras_ratio').textContent = '-';
  document.getElementById('r_ras_flow').textContent = '-';
}

// Note: calcChlorine, calcPolymer defined later in Chemical Systems section

function calcPump() {
  var gpm = parseFloat(document.getElementById('pump_flow').value) || parseFloat(document.getElementById('pump_gpm').value) || 500;
  var tdh = parseFloat(document.getElementById('pump_tdh').value) || 50;
  var pEff = parseFloat(document.getElementById('pump_eff').value) || 70;
  var mEff = parseFloat(document.getElementById('motor_eff').value) || parseFloat(document.getElementById('pump_motor').value) || 90;
  var whp = (gpm * tdh) / 3960;
  var bhp = pEff > 0 ? whp / (pEff / 100) : 0;
  var mhp = mEff > 0 ? bhp / (mEff / 100) : 0;
  var kw = mhp * 0.746;
  document.getElementById('r_pump_whp').textContent = whp.toFixed(2);
  document.getElementById('r_pump_bhp').textContent = bhp.toFixed(2);
  document.getElementById('r_pump_mhp').textContent = mhp.toFixed(2);
  document.getElementById('r_pump_kw').textContent = kw.toFixed(2);
}
function resetPump() {
  var flowEl = document.getElementById('pump_flow');
  if (flowEl) flowEl.value = '500';
  var gpmEl = document.getElementById('pump_gpm');
  if (gpmEl) gpmEl.value = '500';
  document.getElementById('pump_tdh').value = '50';
  document.getElementById('pump_eff').value = '70';
  var motorEl = document.getElementById('motor_eff');
  if (motorEl) motorEl.value = '90';
  var motor2El = document.getElementById('pump_motor');
  if (motor2El) motor2El.value = '90';
  document.getElementById('r_pump_whp').textContent = '-';
  document.getElementById('r_pump_bhp').textContent = '-';
  document.getElementById('r_pump_mhp').textContent = '-';
  document.getElementById('r_pump_kw').textContent = '-';
}

// ========== END CALCULATOR FUNCTIONS ==========


const fmt={
n:(v,d=0)=>Number(v).toFixed(d).replace(/\B(?=(\d{3})+(?!\d))/g,','),
f:(v,d=2)=>Number(v).toFixed(d),
p:(v,d=1)=>(Number(v)*100).toFixed(d)+'%'
};

let state={
data:{},
plants:[],
alerts:[],
maintenance:[],
labTests:[],
charts:{},
aiChat:[],
issues:[],
symptoms:[]
};

// AI Knowledge Base
const knowledgeBase=[
{id:1,title:'High SVI Troubleshooting',category:'Sludge',content:'High Sludge Volume Index (SVI >150 mL/g) indicates bulking. Causes: filamentous bacteria, low DO, nutrient deficiency. Solutions: increase DO to 2.5+ mg/L, reduce F/M ratio, add selector zone, chlorinate RAS.',keywords:'svi bulking filamentous settling'},
{id:2,title:'Low DO Recovery',category:'Oxygen',content:'Dissolved oxygen not reaching target indicates insufficient aeration. Check: blower capacity, diffuser fouling, membrane damage. Solutions: clean diffusers, increase airflow, repair/replace damaged equipment.',keywords:'do oxygen aeration blower diffuser'},
{id:3,title:'Ammonia Breakthrough',category:'Nitrification',content:'High effluent ammonia (>2 mg/L) indicates nitrification failure. Causes: low temperature, insufficient MCRT, low DO, toxic shock. Solutions: increase MCRT to 8-12 days, maintain DO >2 mg/L, check alkalinity.',keywords:'ammonia nitrification tkn nitrogen'},
{id:4,title:'Rising Sludge',category:'Sludge',content:'Sludge rising in clarifier indicates denitrification. Causes: excessive RAS detention, low DO in clarifier. Solutions: increase RAS rate, reduce sludge blanket depth, improve aeration.',keywords:'rising sludge clarifier denitrification'},
{id:5,title:'Pin Floc Formation',category:'Sludge',content:'Small, dispersed floc particles indicate old sludge or toxic shock. Causes: extended MCRT, toxicity, low F/M. Solutions: reduce MCRT, increase WAS, investigate toxic discharge.',keywords:'floc pin particle dispersed'},
{id:6,title:'Foam & Scum',category:'Operations',content:'Excessive foam indicates presence of surfactants, NOx in sludge, or Nocardia growth. Solutions: spray foam with water, add antifoam agent, reduce MCRT, investigate industrial discharge.',keywords:'foam scum nocardia surfactant'},
{id:7,title:'Energy Consumption High',category:'Energy',content:'High energy use (>2000 kWh/MG) indicates inefficiency. Check: blower operation, VFD settings, DO setpoints, equipment staging. Solutions: optimize DO control, install VFDs, improve equipment staging.',keywords:'energy power consumption efficiency kwh'},
{id:8,title:'Phosphorus Removal',category:'Nutrients',content:'Biological P removal requires anaerobic zone, adequate VFAs, low DO. Chemical removal uses alum, ferric, or lime. Optimize: F/M ratio 0.3-0.5, anaerobic HRT 1-2 hours, maintain proper pH.',keywords:'phosphorus phosphate ebpr chemical'},
{id:9,title:'Septicity & Odors',category:'Operations',content:'Septic conditions and H2S odors from anaerobic conditions. Causes: long collection system detention, low DO. Solutions: pre-aeration, chemical addition (chlorine, peroxide), improved ventilation.',keywords:'septic odor h2s sulfide smell'},
{id:10,title:'Clarifier Performance',category:'Solids',content:'Poor clarifier performance: high effluent TSS, sludge blanket >50% depth. Causes: hydraulic overload, density currents, short-circuiting. Solutions: reduce flow, adjust RAS, improve baffling.',keywords:'clarifier settling tss effluent solids'}
];

// Common symptoms for troubleshooting
const symptoms=[
{id:'high_eff_bod',text:'High effluent BOD (>30 mg/L)',issues:['underloading','overloading','toxicity','low_do']},
{id:'high_eff_tss',text:'High effluent TSS (>30 mg/L)',issues:['bulking','pinfloc','clarifier_overload']},
{id:'high_eff_nh3',text:'High effluent ammonia',issues:['low_mcrt','low_do','low_temp','toxicity']},
{id:'high_svi',text:'High SVI (>150 mL/g)',issues:['bulking','filamentous']},
{id:'low_svi',text:'Low SVI (<80 mL/g)',issues:['pinfloc','old_sludge']},
{id:'low_do',text:'Low DO (<1.5 mg/L)',issues:['blower_failure','diffuser_fouling','overload']},
{id:'high_mlss',text:'MLSS too high (>4000 mg/L)',issues:['insufficient_was','clarifier_issue']},
{id:'low_mlss',text:'MLSS too low (<1500 mg/L)',issues:['excessive_was','washout']},
{id:'foam',text:'Excessive foam/scum',issues:['nocardia','surfactants','denitrification']},
{id:'odors',text:'Septic odors (H2S)',issues:['septicity','anaerobic']},
{id:'rising_sludge',text:'Rising sludge in clarifier',issues:['denitrification','gas_bubbles']},
{id:'poor_settling',text:'Poor sludge settling',issues:['bulking','temperature','toxicity']},
{id:'brown_foam',text:'Brown/tan foam',issues:['surfactants','young_sludge']},
{id:'white_foam',text:'White billowy foam',issues:['nocardia','actinomycetes']},
{id:'high_energy',text:'High energy consumption',issues:['inefficient_aeration','equipment_issues']}
];

// Issue database for tracking
const issueDatabase={
bulking:{
name:'Sludge Bulking',
severity:'high',
causes:['Filamentous bacteria overgrowth','Low DO (<1.5 mg/L)','Nutrient deficiency (N or P)','Low F/M ratio (<0.2)','Presence of readily biodegradable substrate'],
solutions:[
{step:1,action:'Check and record current SVI, MLSS, DO, F/M ratio'},
{step:2,action:'Perform microscopic exam to identify filament type'},
{step:3,action:'Increase DO to 2.5-3.0 mg/L throughout basin'},
{step:4,action:'If low F/M: reduce MLSS by increasing WAS or reduce aeration volume'},
{step:5,action:'Add selector zone or implement step-feed operation'},
{step:6,action:'Consider chlorination of RAS (5-10 mg/L for 15-30 min contact)'},
{step:7,action:'Monitor daily SVI until <120 mL/g achieved'}
],
prevention:['Maintain DO >2.0 mg/L','Keep F/M ratio 0.3-0.5','Ensure adequate nutrients (100:5:1)','Regular microscopic monitoring']
},
low_do:{
name:'Low Dissolved Oxygen',
severity:'high',
causes:['Blower capacity insufficient','Diffuser fouling/damage','Excessive organic loading','Equipment failure','Control system malfunction'],
solutions:[
{step:1,action:'Check all blowers - verify operation and amperage draw'},
{step:2,action:'Inspect diffusers for fouling, damage, or uneven distribution'},
{step:3,action:'Measure actual airflow with pitot tube or flow meter'},
{step:4,action:'Calculate oxygen requirement vs. delivery capability'},
{step:5,action:'Clean fouled diffusers (acid wash if needed)'},
{step:6,action:'Increase blower output or stage additional blower'},
{step:7,action:'If equipment failure: implement emergency bypass/repairs'},
{step:8,action:'Recalibrate DO probes and control system'}
],
prevention:['Regular diffuser inspection/cleaning (quarterly)','Preventive maintenance on blowers','Spare blower capacity (N+1)','Automated DO control with alarms']
},
high_eff_nh3:{
name:'Ammonia Breakthrough',
severity:'critical',
causes:['MCRT too short (<5 days)','Low DO in aerobic zones','Low temperature (<12¬∞C)','Insufficient alkalinity','Toxic shock load','Nitrifier washout'],
solutions:[
{step:1,action:'Immediately stop or reduce WAS to increase MCRT'},
{step:2,action:'Increase DO setpoint to 2.5-3.0 mg/L'},
{step:3,action:'Test alkalinity - add if <50 mg/L as CaCO3'},
{step:4,action:'Calculate and target MCRT of 10-15 days minimum'},
{step:5,action:'Reduce influent load if possible (equalization, bypass)'},
{step:6,action:'Check for toxic industrial discharge - investigate I/I'},
{step:7,action:'Monitor effluent NH3 daily until <1.0 mg/L'},
{step:8,action:'If chronic: consider bioaugmentation with nitrifiers'}
],
prevention:['Maintain MCRT >8 days year-round','Keep DO >2.0 mg/L','Monitor alkalinity weekly','Industrial pretreatment program','Temperature-based MCRT adjustment']
},
clarifier_overload:{
name:'Clarifier Overload',
severity:'medium',
causes:['Hydraulic overload (SOR >800 gpd/ft¬≤)','Solids overload (SLR >30 lb/ft¬≤/d)','Density currents','Short-circuiting','Equipment malfunction (rake, skimmer)'],
solutions:[
{step:1,action:'Calculate actual SOR and SLR vs. design'},
{step:2,action:'Reduce flow if possible (bypass, equalization)'},
{step:3,action:'Increase RAS rate to reduce sludge blanket'},
{step:4,action:'Check and adjust weir loading'},
{step:5,action:'Inspect baffles for proper positioning'},
{step:6,action:'Verify rake/skimmer operation'},
{step:7,action:'Add polymer for improved settling if needed'},
{step:8,action:'Consider temporary TSS limit variance if critical'}
],
prevention:['Size clarifiers for peak flows','Maintain sludge blanket <30% depth','Regular equipment maintenance','Flow equalization']
}
};

// Initialize
const today=new Date().toISOString().split('T')[0];
if($('calcDate'))$('calcDate').value=today;

// Load saved data
const saved=localStorage.getItem('wwtp_enhanced_data');
if(saved){
try{
const loaded=JSON.parse(saved);
if(loaded.plants)state.plants=loaded.plants;
if(loaded.maintenance)state.maintenance=loaded.maintenance;
if(loaded.alerts)state.alerts=loaded.alerts;
if(loaded.issues)state.issues=loaded.issues;
}catch(e){console.error('Load error:',e)}
}

// Tab switching - MOVED TO v9.9.16 TABLET FIX SECTION

function initTabs() { console.log("initTabs disabled"); }

// ==================== UNIT CONVERSION SYSTEM v9.6.0 ====================
var currentUnits = 'imperial'; // 'imperial' or 'metric'

// Conversion factors (imperial to metric multiplier)
var unitConversions = {
  // Volume flow
  'MGD': { metric: 'm¬≥/day', factor: 3785.41 },
  'GPM': { metric: 'L/min', factor: 3.78541 },
  'GPD': { metric: 'L/day', factor: 3.78541 },
  // Mass
  'lb': { metric: 'kg', factor: 0.453592 },
  'lb/day': { metric: 'kg/day', factor: 0.453592 },
  'lb/hr': { metric: 'kg/hr', factor: 0.453592 },
  'lb/DT': { metric: 'kg/DT', factor: 0.453592 },
  // Length
  'ft': { metric: 'm', factor: 0.3048 },
  'in': { metric: 'cm', factor: 2.54 },
  // Area
  'sf': { metric: 'm¬≤', factor: 0.092903 },
  'ft¬≤': { metric: 'm¬≤', factor: 0.092903 },
  'ac': { metric: 'ha', factor: 0.404686 },
  // Volume
  'gal': { metric: 'L', factor: 3.78541 },
  'MG': { metric: 'ML', factor: 3.78541 },
  'cf': { metric: 'm¬≥', factor: 0.0283168 },
  'cf/day': { metric: 'm¬≥/day', factor: 0.0283168 },
  'cf/lb VS': { metric: 'm¬≥/kg VS', factor: 0.0624 },
  // Pressure
  'psi': { metric: 'kPa', factor: 6.89476 },
  // Power
  'HP': { metric: 'kW', factor: 0.7457 },
  // Energy
  'kWh/yr': { metric: 'kWh/yr', factor: 1 },
  'BTU/day': { metric: 'MJ/day', factor: 0.001055 },
  // Loading rates
  'lb/1000 cf': { metric: 'kg/m¬≥', factor: 0.016018 },
  'lb/1000 cf/day': { metric: 'kg/m¬≥/day', factor: 0.016018 },
  'gpd/sf': { metric: 'L/m¬≤/day', factor: 40.7458 },
  'lb BOD/1000 cf/day': { metric: 'kg BOD/m¬≥/day', factor: 0.016018 },
  'SCFM': { metric: 'm¬≥/min', factor: 0.0283168 },
  // Velocity
  'fps': { metric: 'm/s', factor: 0.3048 },
  'ft/s': { metric: 'm/s', factor: 0.3048 }
};

// Map input IDs to their units (for value conversion)
var inputUnitMap = {
  // Flow inputs
  'olr_flow': 'MGD', 'fm_flow': 'MGD', 'srt_flow': 'MGD', 'mc_flow': 'MGD',
  'eff_flow': 'MGD', 'clar_flow': 'MGD', 'grit_flow': 'MGD', 'sed_flow': 'MGD',
  'hl_flow': 'MGD', 'weir_flow': 'MGD', 'pump_flow': 'GPM', 'bp_rate': 'GPM',
  'was_flow': 'GPD', 'ras_flow': 'GPD',
  // Volume inputs
  'olr_vol': 'MG', 'fm_vol': 'MG', 'srt_vol': 'MG', 'mc_vol': 'MG',
  // Length/depth inputs
  'clar_depth': 'ft', 'grit_depth': 'ft', 'grit_width': 'ft', 'sed_depth': 'ft',
  'sed_length': 'ft', 'sed_width': 'ft', 'weir_length': 'ft', 'hl_length': 'ft',
  'hl_diameter': 'in', 'pump_head': 'ft', 'blower_depth': 'ft',
  // Mass inputs
  'sludge_flow_lb': 'lb/day', 'gas_vs': 'lb/day', 'blower_o2': 'lb/day'
};

// Map result IDs to their units
var resultUnitMap = {
  'r_olr_load': 'lb/day', 'r_olr': 'lb/1000 cf/day',
  'r_sludge': 'lb/day', 'r_was': 'GPD',
  'r_clar_area': 'sf', 'r_clar_vol': 'MG',
  'r_grit_length': 'ft', 'r_grit_vol': 'cf',
  'r_sed_area': 'sf', 'r_sed_vol': 'gal', 'r_sed_dt': 'hr',
  'r_weir_rate': 'GPD', 'r_hl_vel': 'fps', 'r_hl_loss': 'ft',
  'r_pump_hp': 'HP', 'r_pump_kw': 'kW',
  'r_gas_total': 'cf/day', 'r_gas_ch4': 'cf/day', 'r_gas_kw': 'kW',
  'r_bp_dry': 'lb/hr', 'r_bp_cake': 'lb/hr', 'r_bp_polymer': 'lb/hr',
  'r_blower_air': 'SCFM', 'r_blower_hp': 'HP', 'r_blower_kwh': 'kWh/yr'
};

function toggleUnits() {
  var wasMetric = (currentUnits === 'metric');
  currentUnits = wasMetric ? 'imperial' : 'metric';
  var toMetric = !wasMetric;
  
  var btn = document.getElementById('unitToggleBtn');
  if (btn) {
    if (currentUnits === 'metric') {
      btn.innerHTML = 'üåç MET';
      btn.classList.add('metric');
      document.body.classList.add('metric-mode');
    } else {
      btn.innerHTML = 'üá∫üá∏ IMP';
      btn.classList.remove('metric');
      document.body.classList.remove('metric-mode');
    }
  }
  
  // Convert input values
  convertInputValues(toMetric);
  
  // Convert result values
  convertResultValues(toMetric);
  
  // Update all unit labels in UI
  updateAllUnitLabels(toMetric);
  
  // Save preference
  localStorage.setItem('wwtp_units', currentUnits);
  
  // Show toast
  showToast(currentUnits === 'metric' ? 'üåç Switched to Metric Units (values converted)' : 'üá∫üá∏ Switched to Imperial Units (values converted)', 'success');
  
  console.log('[v9.6.0] Units switched to:', currentUnits);
}

function convertInputValues(toMetric) {
  for (var inputId in inputUnitMap) {
    var input = document.getElementById(inputId);
    if (input && input.value) {
      var unitKey = inputUnitMap[inputId];
      var conv = unitConversions[unitKey];
      if (conv && conv.factor) {
        var oldVal = parseFloat(input.value);
        if (!isNaN(oldVal)) {
          var newVal = toMetric ? oldVal * conv.factor : oldVal / conv.factor;
          // Round appropriately based on magnitude
          if (newVal >= 100) {
            input.value = Math.round(newVal);
          } else if (newVal >= 1) {
            input.value = Math.round(newVal * 100) / 100;
          } else {
            input.value = Math.round(newVal * 10000) / 10000;
          }
        }
      }
    }
  }
}

function convertResultValues(toMetric) {
  for (var resultId in resultUnitMap) {
    var el = document.getElementById(resultId);
    if (el) {
      var text = el.textContent;
      if (text && text !== '-' && text !== 'N/A') {
        var numMatch = text.match(/^[\d,.]+/);
        if (numMatch) {
          var oldVal = parseFloat(numMatch[0].replace(/,/g, ''));
          var unitKey = resultUnitMap[resultId];
          var conv = unitConversions[unitKey];
          if (conv && conv.factor && !isNaN(oldVal)) {
            var newVal = toMetric ? oldVal * conv.factor : oldVal / conv.factor;
            // Format with commas
            if (newVal >= 100) {
              el.textContent = Math.round(newVal).toLocaleString();
            } else if (newVal >= 1) {
              el.textContent = (Math.round(newVal * 100) / 100).toLocaleString();
            } else {
              el.textContent = (Math.round(newVal * 10000) / 10000).toString();
            }
          }
        }
      }
    }
  }
}

function updateAllUnitLabels(toMetric) {
  // Update labels containing unit text in parentheses
  document.querySelectorAll('label').forEach(function(label) {
    var text = label.innerHTML;
    var changed = false;
    
    if (toMetric) {
      // Imperial to Metric
      for (var imp in unitConversions) {
        var regex = new RegExp('\\(' + escapeRegex(imp) + '\\)', 'g');
        if (regex.test(text)) {
          text = text.replace(regex, '(' + unitConversions[imp].metric + ')');
          changed = true;
        }
      }
    } else {
      // Metric to Imperial
      for (var imp in unitConversions) {
        var regex = new RegExp('\\(' + escapeRegex(unitConversions[imp].metric) + '\\)', 'g');
        if (regex.test(text)) {
          text = text.replace(regex, '(' + imp + ')');
          changed = true;
        }
      }
    }
    if (changed) label.innerHTML = text;
  });
  
  // Update table unit cells (3rd column typically)
  document.querySelectorAll('td').forEach(function(cell) {
    var text = cell.textContent.trim();
    if (toMetric) {
      if (unitConversions[text]) {
        cell.textContent = unitConversions[text].metric;
      }
    } else {
      for (var imp in unitConversions) {
        if (unitConversions[imp].metric === text) {
          cell.textContent = imp;
          break;
        }
      }
    }
  });
}

function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\\/]/g, '\\$&');
}

// Helper functions for calculations to get values in consistent units (imperial)
function getImperialValue(inputId) {
  var input = document.getElementById(inputId);
  if (!input) return 0;
  var val = parseFloat(input.value) || 0;
  
  if (currentUnits === 'metric') {
    var unitKey = inputUnitMap[inputId];
    if (unitKey && unitConversions[unitKey]) {
      val = val / unitConversions[unitKey].factor; // Convert metric to imperial
    }
  }
  return val;
}

function setResultDisplay(resultId, imperialValue) {
  var el = document.getElementById(resultId);
  if (!el) return;
  
  var displayVal = imperialValue;
  if (currentUnits === 'metric') {
    var unitKey = resultUnitMap[resultId];
    if (unitKey && unitConversions[unitKey]) {
      displayVal = imperialValue * unitConversions[unitKey].factor;
    }
  }
  
  // Format nicely
  if (displayVal >= 100) {
    el.textContent = Math.round(displayVal).toLocaleString();
  } else if (displayVal >= 1) {
    el.textContent = (Math.round(displayVal * 100) / 100).toLocaleString();
  } else if (displayVal > 0) {
    el.textContent = (Math.round(displayVal * 10000) / 10000).toString();
  } else {
    el.textContent = '0';
  }
}

// Initialize units on load
document.addEventListener('DOMContentLoaded', function() {
  var savedUnits = localStorage.getItem('wwtp_units');
  if (savedUnits === 'metric') {
    currentUnits = 'imperial'; // Set opposite so toggle switches to metric
    toggleUnits();
  }
});

// ==================== END UNIT CONVERSION SYSTEM ====================

// ==================== QUICK REFERENCE LIBRARY v9.6.0 ====================
function openQuickRef() {
  document.getElementById('quickRefModal').classList.add('active');
  document.body.style.overflow = 'hidden';
  console.log('[v9.6.0] Quick Reference opened');
}

function closeQuickRef() {
  document.getElementById('quickRefModal').classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById('qrefSearch').value = '';
  filterQuickRef(''); // Reset search
  console.log('[v9.6.0] Quick Reference closed');
}

function showQrefTab(tabName) {
  console.log('[v9.6.0] showQrefTab called with:', tabName);
  
  // Hide all tab contents
  var allContents = document.querySelectorAll('.qref-tab-content');
  allContents.forEach(function(content) {
    content.classList.add('qref-hidden');
    content.style.display = 'none';
  });
  
  // Deactivate all tabs
  document.querySelectorAll('.qref-tab').forEach(function(tab) {
    tab.classList.remove('active');
  });
  
  // Show selected tab content
  var contentId = 'qref-' + tabName;
  var content = document.getElementById(contentId);
  console.log('[v9.6.0] Looking for:', contentId, 'Found:', content ? 'YES' : 'NO');
  
  if (content) {
    content.classList.remove('qref-hidden');
    content.style.display = 'block';
    console.log('[v9.6.0] Content displayed for:', tabName);
  } else {
    console.error('[v9.6.0] Tab content not found:', contentId);
  }
  
  // Activate clicked tab
  document.querySelectorAll('.qref-tab').forEach(function(tab) {
    var onclick = tab.getAttribute('onclick') || '';
    if (onclick.indexOf("'" + tabName + "'") > -1) {
      tab.classList.add('active');
    }
  });
}

function filterQuickRef(searchTerm) {
  var term = searchTerm.toLowerCase().trim();
  
  // If empty, show all
  if (!term) {
    document.querySelectorAll('.qref-section, .qref-trouble').forEach(function(section) {
      section.style.display = '';
    });
    return;
  }
  
  // Filter sections
  document.querySelectorAll('.qref-section, .qref-trouble').forEach(function(section) {
    var searchData = section.getAttribute('data-search') || '';
    var textContent = section.textContent.toLowerCase();
    
    if (searchData.includes(term) || textContent.includes(term)) {
      section.style.display = '';
    } else {
      section.style.display = 'none';
    }
  });
  
  // Show all tabs when searching
  document.querySelectorAll('.qref-tab-content').forEach(function(content) {
    content.classList.remove('qref-hidden');
  });
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    var modal = document.getElementById('quickRefModal');
    if (modal && modal.classList.contains('active')) {
      closeQuickRef();
    }
  }
});

// ==================== END QUICK REFERENCE LIBRARY ====================

// v9.9.16 TABLET PANEL FIX - Simple approach
document.addEventListener('DOMContentLoaded', function() {
  console.log('[v9.9.16] Init');
  // Ensure only dashboard is active
  document.querySelectorAll('.panel').forEach(function(p) {
    if (p.id === 'dashboard') {
      p.classList.add('active');
    } else {
      p.classList.remove('active');
    }
  });
  
  // BLOCK PULL-TO-REFRESH
  var lastTouchY = 0;
  document.addEventListener('touchstart', function(e) {
    lastTouchY = e.touches[0].clientY;
  }, { passive: true });
  
  document.addEventListener('touchmove', function(e) {
    var touchY = e.touches[0].clientY;
    var scrollTop = window.scrollY || document.documentElement.scrollTop;
    
    // If at top of page and pulling down, prevent
    if (scrollTop === 0 && touchY > lastTouchY) {
      e.preventDefault();
    }
  }, { passive: false });
});

function switchPanel(panelId) {
  console.log('[v9.9.16] switchPanel:', panelId);
  
  // Remove active from all panels
  document.querySelectorAll('.panel').forEach(function(p) {
    p.classList.remove('active');
  });
  
  // Add active to target
  var target = document.getElementById(panelId);
  if (target) {
    target.classList.add('active');
  }
  
  // Update tabs
  document.querySelectorAll('.tab').forEach(function(t) {
    var isTarget = t.getAttribute('data-panel') === panelId;
    t.classList.toggle('active', isTarget);
    t.setAttribute('aria-selected', isTarget ? 'true' : 'false');
  });
  
  window.scrollTo(0, 0);
}

// Scroll to section within current panel
function scrollToSection(sectionId) {
  const section = document.getElementById(sectionId);
  if (section) {
    // Check if section is in a hidden panel - if so, switch panels first
    const parentPanel = section.closest('.panel');
    if (parentPanel && !parentPanel.classList.contains('active')) {
      // Switch to the panel containing this section
      const panelId = parentPanel.id;
      switchPanel(panelId);
      // Wait for panel switch animation, then scroll
      setTimeout(() => {
        doScrollToSection(section);
      }, 100);
    } else {
      // Section is in current panel, scroll directly
      doScrollToSection(section);
    }
  } else {
    console.warn('Section not found:', sectionId);
  }
}

function doScrollToSection(section) {
  // Get position and scroll with offset for header
  const yOffset = -20;
  const y = section.getBoundingClientRect().top + window.pageYOffset + yOffset;
  window.scrollTo({ top: y, behavior: 'smooth' });
  
  // Flash highlight effect
  section.style.transition = 'box-shadow 0.3s';
  section.style.boxShadow = '0 0 20px rgba(74, 222, 128, 0.6), inset 0 0 10px rgba(74, 222, 128, 0.1)';
  setTimeout(() => {
    section.style.boxShadow = 'none';
  }, 2000);
}

// Initialize tabs when DOM is ready - DISABLED
// if (document.readyState === 'loading') {
//   document.addEventListener('DOMContentLoaded', initTabs);
// } else {
//   initTabs();
// }

// Theme toggle - REMOVED (using toggleThemeWithMemory instead)
// Old duplicate code removed to prevent conflicts

// Toast notifications - using main showToast function defined later

// AI Assistant Functions

function openAIAssistant(){
$$('.tab[data-panel="ai"]')[0].click();
setTimeout(()=>$('aiInput').focus(),300);
}

function sendAIMessage(){
const input=$('aiInput');
const msg=input.value.trim();
if(!msg)return;

addAIMessage(msg,'user');
input.value='';
showAIThinking(true);

setTimeout(()=>{
const response=generateAIResponse(msg);
showAIThinking(false);
addAIMessage(response,'assistant');
},1500+Math.random()*1000);
}

function addAIMessage(text,sender){
const container=$('aiMessages');
const msg=document.createElement('div');
msg.className=`ai-message ${sender}`;
msg.innerHTML=text;
container.appendChild(msg);
scrollAIToBottom();

state.aiChat.push({text,sender,time:new Date()});
}

function scrollAIToBottom(){
const container=$('aiMessages');
setTimeout(()=>{
container.scrollTop=container.scrollHeight;
},100);
}

function showAIThinking(show){
$('aiThinking').classList.toggle('active',show);
}

// ========== AI-1: CONTEXT-AWARE AI ASSISTANT ==========

// Get current plant context for AI
function getPlantContext() {
  const ctx = {
    flow: parseFloat(document.getElementById('kpi-flow')?.textContent) || 0,
    do: parseFloat(document.getElementById('kpi-do')?.textContent) || 0,
    mlss: parseFloat(document.getElementById('kpi-mlss')?.textContent) || 0,
    fm: parseFloat(document.getElementById('kpi-fm')?.textContent) || 0,
    srt: parseFloat(document.getElementById('kpi-srt')?.textContent) || 0,
    svi: parseFloat(document.getElementById('kpi-svi')?.textContent) || 0,
    ph: parseFloat(document.getElementById('kpi-ph')?.textContent) || 7.0,
    issues: []
  };
  
  // Detect issues
  if (ctx.do < 1.5) ctx.issues.push('‚ö†Ô∏è LOW DO: ' + ctx.do + ' mg/L (target >2.0)');
  if (ctx.do > 4.0) ctx.issues.push('‚ö†Ô∏è HIGH DO: ' + ctx.do + ' mg/L (wasting energy)');
  if (ctx.svi > 150) ctx.issues.push('üî¥ HIGH SVI: ' + ctx.svi + ' mL/g (possible bulking)');
  if (ctx.fm < 0.15) ctx.issues.push('‚ö†Ô∏è LOW F/M: ' + ctx.fm + ' (extended aeration range)');
  if (ctx.fm > 0.5) ctx.issues.push('üî¥ HIGH F/M: ' + ctx.fm + ' (overloaded)');
  if (ctx.srt < 5) ctx.issues.push('‚ö†Ô∏è LOW SRT: ' + ctx.srt + ' days (nitrification at risk)');
  if (ctx.mlss < 1500) ctx.issues.push('‚ö†Ô∏è LOW MLSS: ' + ctx.mlss + ' mg/L');
  if (ctx.mlss > 5000) ctx.issues.push('‚ö†Ô∏è HIGH MLSS: ' + ctx.mlss + ' mg/L');
  
  return ctx;
}

// Generate context-aware greeting
function getAIGreeting() {
  const ctx = getPlantContext();
  let greeting = 'üëã <strong>WWTP AI Assistant</strong><br><br>';
  
  greeting += '<strong>Current Plant Status:</strong><br>';
  greeting += '‚Ä¢ Flow: ' + ctx.flow + ' MGD<br>';
  greeting += '‚Ä¢ DO: ' + ctx.do + ' mg/L<br>';
  greeting += '‚Ä¢ MLSS: ' + ctx.mlss + ' mg/L<br>';
  greeting += '‚Ä¢ F/M: ' + ctx.fm + '<br>';
  greeting += '‚Ä¢ SVI: ' + ctx.svi + ' mL/g<br><br>';
  
  if (ctx.issues.length > 0) {
    greeting += '<strong>‚ö†Ô∏è Issues Detected:</strong><br>';
    ctx.issues.forEach(issue => {
      greeting += issue + '<br>';
    });
    greeting += '<br>Ask me about any of these issues for troubleshooting help!';
  } else {
    greeting += '‚úÖ <strong>All parameters in normal range!</strong><br>How can I help you today?';
  }
  
  return greeting;
}

// Enhanced AI response with plant context
function generateContextAwareResponse(msg, baseResponse) {
  const ctx = getPlantContext();
  let response = baseResponse;
  
  // Add current values to relevant responses
  if (msg.toLowerCase().includes('do') || msg.toLowerCase().includes('oxygen')) {
    response += '<br><br><strong>üìä Your Current DO:</strong> ' + ctx.do + ' mg/L';
    if (ctx.do < 2.0) response += ' (‚ö†Ô∏è Below optimal)';
    else if (ctx.do > 3.0) response += ' (Consider reducing to save energy)';
    else response += ' (‚úÖ Good range)';
  }
  
  if (msg.toLowerCase().includes('svi') || msg.toLowerCase().includes('bulking') || msg.toLowerCase().includes('settling')) {
    response += '<br><br><strong>üìä Your Current SVI:</strong> ' + ctx.svi + ' mL/g';
    if (ctx.svi > 150) response += ' (üî¥ Bulking indicated)';
    else if (ctx.svi < 80) response += ' (‚ö†Ô∏è Possible pin floc)';
    else response += ' (‚úÖ Good settling)';
  }
  
  if (msg.toLowerCase().includes('f/m') || msg.toLowerCase().includes('food') || msg.toLowerCase().includes('loading')) {
    response += '<br><br><strong>üìä Your Current F/M:</strong> ' + ctx.fm + ' lb/lb/d';
    if (ctx.fm < 0.15) response += ' (Extended aeration mode)';
    else if (ctx.fm > 0.4) response += ' (‚ö†Ô∏è High rate - monitor closely)';
    else response += ' (‚úÖ Conventional range)';
  }
  
  if (msg.toLowerCase().includes('srt') || msg.toLowerCase().includes('mcrt') || msg.toLowerCase().includes('age')) {
    response += '<br><br><strong>üìä Your Current SRT:</strong> ' + ctx.srt + ' days';
    if (ctx.srt < 8) response += ' (‚ö†Ô∏è May impact nitrification)';
    else if (ctx.srt > 20) response += ' (Extended aeration - watch for pin floc)';
    else response += ' (‚úÖ Good for nitrification)';
  }
  
  return response;
}

// ========== END AI-1 ==========

// ========== AI-2: CALCULATOR INTEGRATION ==========

// AI can run calculations
const AICalcCommands = {
  'f/m': { fn: 'calcFM', panel: 'process-control', inputs: ['fm_bod', 'fm_mlvss', 'fm_vol'] },
  'srt': { fn: 'calcSRTmain', panel: 'process-control', inputs: ['srt_mlss', 'srt_vol', 'srt_was', 'srt_wasConc'] },
  'svi': { fn: 'calcSVI', panel: 'process-control', inputs: ['svi_settledVol', 'svi_mlss'] },
  'loading': { fn: 'calcLoading', panel: 'process-control', inputs: ['load_flow', 'load_bod'] },
  'oxygen': { fn: 'calcOxygen', panel: 'aeration', inputs: [] },
  'was': { fn: 'calcWAS', panel: 'solids', inputs: ['was_vol', 'was_mlss', 'was_srt'] },
  'chlorine': { fn: 'calcChlorine', panel: 'chemicals', inputs: ['cl_flow', 'cl_dose'] },
  'sludge': { fn: 'calcSludgeProduction', panel: 'solids', inputs: [] }
};

function aiRunCalculation(calcType) {
  const cmd = AICalcCommands[calcType.toLowerCase()];
  if (!cmd) {
    return `I don't recognize that calculator. Available: ${Object.keys(AICalcCommands).join(', ')}`;
  }
  
  // Switch to the right panel
  if (typeof switchPanel === 'function') {
    switchPanel(cmd.panel);
  }
  
  // Run the calculation
  setTimeout(() => {
    if (typeof window[cmd.fn] === 'function') {
      window[cmd.fn]();
      showToast('üßÆ ' + calcType.toUpperCase() + ' calculated!', 'success');
    }
  }, 300);
  
  return `‚úÖ Running <strong>${calcType.toUpperCase()}</strong> calculation...<br><br>I've switched to the ${cmd.panel} panel and executed the calculation. Check the results above!`;
}

// Parse numbers from user message
function extractNumbers(msg) {
  const numbers = msg.match(/[\d.]+/g);
  return numbers ? numbers.map(n => parseFloat(n)) : [];
}

// AI fills calculator inputs
function aiFillInputs(calcType, values) {
  const cmd = AICalcCommands[calcType.toLowerCase()];
  if (!cmd || !cmd.inputs.length) return false;
  
  cmd.inputs.forEach((inputId, idx) => {
    const el = document.getElementById(inputId);
    if (el && values[idx] !== undefined) {
      el.value = values[idx];
    }
  });
  
  return true;
}

// Check if message is a calculation request
function isCalcRequest(msg) {
  const lower = msg.toLowerCase();
  const calcKeywords = ['calculate', 'calc', 'compute', 'run', 'what is my', 'find my'];
  const hasCalcWord = calcKeywords.some(k => lower.includes(k));
  const hasCalcType = Object.keys(AICalcCommands).some(k => lower.includes(k));
  return hasCalcWord && hasCalcType;
}

// Get calculation type from message
function getCalcType(msg) {
  const lower = msg.toLowerCase();
  for (const calcType of Object.keys(AICalcCommands)) {
    if (lower.includes(calcType)) return calcType;
  }
  return null;
}

// Explain calculation results
function explainCalcResult(calcType) {
  const ctx = getPlantContext();
  
  const explanations = {
    'f/m': `<strong>F/M Ratio Explained:</strong><br>
Your F/M is <strong>${ctx.fm}</strong> lb BOD/lb MLVSS/day<br><br>
${ctx.fm < 0.15 ? 'üìâ <em>Extended aeration range</em> - Very stable but uses more energy' : 
  ctx.fm > 0.4 ? 'üìà <em>High rate</em> - Watch for settling issues' : 
  '‚úÖ <em>Conventional range</em> - Good balance of treatment and stability'}`,
    
    'svi': `<strong>SVI Explained:</strong><br>
Your SVI is <strong>${ctx.svi}</strong> mL/g<br><br>
${ctx.svi < 80 ? '‚ö†Ô∏è <em>Pin floc possible</em> - Sludge may be too old' : 
  ctx.svi > 150 ? 'üî¥ <em>Bulking indicated</em> - Check for filaments' : 
  '‚úÖ <em>Good settling</em> - Healthy floc'}`,
    
    'srt': `<strong>SRT Explained:</strong><br>
Your SRT is <strong>${ctx.srt}</strong> days<br><br>
${ctx.srt < 5 ? '‚ö†Ô∏è <em>Very short</em> - No nitrification possible' : 
  ctx.srt < 10 ? 'üìä <em>Moderate</em> - Partial nitrification' : 
  ctx.srt > 20 ? 'üìâ <em>Extended</em> - Good nitrification but watch for pin floc' :
  '‚úÖ <em>Optimal</em> - Full nitrification supported'}`
  };
  
  return explanations[calcType] || `Calculation complete! Check the results panel.`;
}

// ========== END AI-2 ==========

// ========== AI-3: PREDICTIVE ALERTS ==========

// Store historical data for trend analysis
const TrendTracker = {
  key: 'wwtp_trend_data',
  maxPoints: 30,
  
  add(param, value) {
    const data = this.getAll();
    const today = new Date().toISOString().split('T')[0];
    if (!data[param]) data[param] = [];
    
    const existing = data[param].find(d => d.date === today);
    if (existing) {
      existing.value = value;
    } else {
      data[param].push({ date: today, value: parseFloat(value) });
    }
    
    data[param] = data[param].slice(-this.maxPoints);
    localStorage.setItem(this.key, JSON.stringify(data));
  },
  
  getAll() {
    try {
      return JSON.parse(localStorage.getItem(this.key)) || {};
    } catch { return {}; }
  },
  
  get(param) {
    return this.getAll()[param] || [];
  },
  
  getTrend(param) {
    const data = this.get(param);
    if (data.length < 3) return { direction: 'unknown', change: 0, confidence: 0 };
    
    const recent = data.slice(-7);
    const first = recent[0].value;
    const last = recent[recent.length - 1].value;
    const change = ((last - first) / first * 100).toFixed(1);
    
    // Calculate trend direction and confidence
    let increasing = 0, decreasing = 0;
    for (let i = 1; i < recent.length; i++) {
      if (recent[i].value > recent[i-1].value) increasing++;
      else if (recent[i].value < recent[i-1].value) decreasing++;
    }
    
    const total = increasing + decreasing;
    const confidence = total > 0 ? Math.max(increasing, decreasing) / total * 100 : 0;
    const direction = increasing > decreasing ? 'increasing' : decreasing > increasing ? 'decreasing' : 'stable';
    
    return { direction, change: parseFloat(change), confidence: Math.round(confidence), data: recent };
  },
  
  clear() {
    localStorage.removeItem(this.key);
  }
};

// Permit limits for predictions
const PermitLimits = {
  tss: { daily: 30, weekly: 25, monthly: 20 },
  bod: { daily: 30, weekly: 25, monthly: 20 },
  ammonia: { daily: 5, weekly: 3, monthly: 2 },
  ph: { min: 6.0, max: 9.0 }
};

// Generate predictive alerts
function generatePredictiveAlerts() {
  const ctx = getPlantContext();
  const alerts = [];
  
  // DO trending low
  const doTrend = TrendTracker.getTrend('do');
  if (doTrend.direction === 'decreasing' && ctx.do < 2.5) {
    alerts.push({
      severity: 'warning',
      param: 'DO',
      message: `DO trending down ${Math.abs(doTrend.change)}% over 7 days`,
      prediction: ctx.do < 2.0 ? 'May drop below 1.5 mg/L within 2-3 days' : 'Monitor closely',
      action: 'Consider increasing aeration or checking blower performance',
      confidence: doTrend.confidence
    });
  }
  
  // SVI trending high (bulking)
  const sviTrend = TrendTracker.getTrend('svi');
  if (sviTrend.direction === 'increasing' && ctx.svi > 120) {
    const daysToLimit = ctx.svi < 150 ? Math.ceil((150 - ctx.svi) / (sviTrend.change / 7)) : 0;
    alerts.push({
      severity: ctx.svi > 150 ? 'critical' : 'warning',
      param: 'SVI',
      message: `SVI trending up ${sviTrend.change}% - possible bulking developing`,
      prediction: daysToLimit > 0 ? `May reach bulking threshold (150) in ~${daysToLimit} days` : 'Already in bulking range',
      action: 'Check DO distribution, perform microscopic exam, consider selector',
      confidence: sviTrend.confidence
    });
  }
  
  // MLSS trending
  const mlssTrend = TrendTracker.getTrend('mlss');
  if (mlssTrend.direction === 'increasing' && ctx.mlss > 4000) {
    alerts.push({
      severity: 'warning',
      param: 'MLSS',
      message: `MLSS rising ${mlssTrend.change}% - solids accumulating`,
      prediction: 'May cause clarifier issues if trend continues',
      action: 'Increase WAS rate to maintain target MLSS',
      confidence: mlssTrend.confidence
    });
  } else if (mlssTrend.direction === 'decreasing' && ctx.mlss < 2500) {
    alerts.push({
      severity: 'warning',
      param: 'MLSS',
      message: `MLSS dropping ${Math.abs(mlssTrend.change)}% - losing biomass`,
      prediction: 'Treatment capacity at risk if trend continues',
      action: 'Reduce WAS rate, check for toxic loading',
      confidence: mlssTrend.confidence
    });
  }
  
  // F/M out of range
  if (ctx.fm > 0.45) {
    alerts.push({
      severity: 'warning',
      param: 'F/M',
      message: `F/M ratio high at ${ctx.fm}`,
      prediction: 'May see settling issues in 1-2 days',
      action: 'Increase MLSS or reduce loading if possible',
      confidence: 80
    });
  }
  
  // SRT too low for nitrification
  if (ctx.srt < 8 && ctx.srt > 0) {
    alerts.push({
      severity: 'critical',
      param: 'SRT',
      message: `SRT at ${ctx.srt} days - below nitrification threshold`,
      prediction: 'Ammonia breakthrough likely within 3-5 days',
      action: 'STOP wasting immediately to build SRT',
      confidence: 90
    });
  }
  
  return alerts;
}

// Format alerts for AI display
function formatPredictiveAlerts() {
  const alerts = generatePredictiveAlerts();
  
  if (alerts.length === 0) {
    return `<strong>‚úÖ Predictive Analysis</strong><br><br>No concerning trends detected. All parameters appear stable.<br><br>
<em>Tip: The more you use the app, the better predictions become as trend data accumulates.</em>`;
  }
  
  let html = `<strong>‚ö†Ô∏è Predictive Alerts (${alerts.length})</strong><br><br>`;
  
  alerts.forEach((alert, idx) => {
    const icon = alert.severity === 'critical' ? 'üî¥' : 'üü°';
    html += `<div style="margin-bottom:15px;padding:10px;background:rgba(255,255,255,0.05);border-radius:8px;border-left:3px solid ${alert.severity === 'critical' ? '#ef4444' : '#f59e0b'}">
${icon} <strong>${alert.param}</strong><br>
${alert.message}<br>
<em>üìä Prediction:</em> ${alert.prediction}<br>
<em>üîß Action:</em> ${alert.action}<br>
<small style="opacity:0.7">Confidence: ${alert.confidence}%</small>
</div>`;
  });
  
  return html;
}

// Auto-save current values for trending
function autoSaveTrends() {
  const ctx = getPlantContext();
  if (ctx.do > 0) TrendTracker.add('do', ctx.do);
  if (ctx.mlss > 0) TrendTracker.add('mlss', ctx.mlss);
  if (ctx.svi > 0) TrendTracker.add('svi', ctx.svi);
  if (ctx.fm > 0) TrendTracker.add('fm', ctx.fm);
  if (ctx.srt > 0) TrendTracker.add('srt', ctx.srt);
  if (ctx.flow > 0) TrendTracker.add('flow', ctx.flow);
}

// Run auto-save on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(autoSaveTrends, 3000);
});

// ========== END AI-3 ==========

// ========== AI-4: VOICE INPUT/OUTPUT ==========

const VoiceAI = {
  recognition: null,
  synthesis: window.speechSynthesis,
  isListening: false,
  voiceEnabled: true,
  
  init() {
    // Check for browser support
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      this.recognition = new SpeechRecognition();
      this.recognition.continuous = false;
      this.recognition.interimResults = false;
      this.recognition.lang = 'en-US';
      
      this.recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        this.onVoiceInput(transcript);
      };
      
      this.recognition.onend = () => {
        this.isListening = false;
        this.updateMicButton();
      };
      
      this.recognition.onerror = (event) => {
        console.log('Voice recognition error:', event.error);
        this.isListening = false;
        this.updateMicButton();
        if (event.error === 'not-allowed') {
          showToast('üé§ Microphone access denied', 'error');
        }
      };
      
      return true;
    }
    return false;
  },
  
  toggleListening() {
    if (!this.recognition) {
      if (!this.init()) {
        showToast('üé§ Voice not supported in this browser', 'error');
        return;
      }
    }
    
    if (this.isListening) {
      this.recognition.stop();
      this.isListening = false;
    } else {
      this.recognition.start();
      this.isListening = true;
      showToast('üé§ Listening...', 'info');
    }
    this.updateMicButton();
  },
  
  onVoiceInput(transcript) {
    showToast('üé§ Heard: "' + transcript + '"', 'success');
    
    // Put text in AI input and send
    const input = document.getElementById('aiInput');
    if (input) {
      input.value = transcript;
      if (typeof sendAIMessage === 'function') {
        sendAIMessage();
      }
    }
  },
  
  speak(text) {
    if (!this.voiceEnabled || !this.synthesis) return;
    
    // Cancel any ongoing speech
    this.synthesis.cancel();
    
    // Strip HTML tags for speech
    const cleanText = text.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
    
    // Limit length for speech
    const shortText = cleanText.length > 500 ? cleanText.substring(0, 500) + '...' : cleanText;
    
    const utterance = new SpeechSynthesisUtterance(shortText);
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    this.synthesis.speak(utterance);
  },
  
  stopSpeaking() {
    if (this.synthesis) {
      this.synthesis.cancel();
    }
  },
  
  toggleVoiceOutput() {
    this.voiceEnabled = !this.voiceEnabled;
    showToast(this.voiceEnabled ? 'üîä Voice output ON' : 'üîá Voice output OFF', 'info');
    this.updateSpeakerButton();
  },
  
  updateMicButton() {
    const btn = document.getElementById('voiceMicBtn');
    if (btn) {
      btn.style.background = this.isListening ? '#ef4444' : '#10b981';
      btn.innerHTML = this.isListening ? 'üé§ Listening...' : 'üé§ Speak';
    }
  },
  
  updateSpeakerButton() {
    const btn = document.getElementById('voiceSpeakerBtn');
    if (btn) {
      btn.innerHTML = this.voiceEnabled ? 'üîä' : 'üîá';
    }
  }
};

// Hook into AI response to add speech
const originalAddAIMessage = typeof addAIMessage === 'function' ? addAIMessage : null;
function addAIMessageWithVoice(text, sender) {
  if (originalAddAIMessage) {
    originalAddAIMessage(text, sender);
  }
  
  // Speak assistant responses
  if (sender === 'assistant' && VoiceAI.voiceEnabled) {
    VoiceAI.speak(text);
  }
}

// Inject voice controls into AI chat
function injectVoiceControls() {
  const aiInput = document.getElementById('aiInput');
  if (!aiInput) return;
  
  const inputParent = aiInput.parentElement;
  if (!inputParent || document.getElementById('voiceMicBtn')) return;
  
  // Create voice button container
  const voiceDiv = document.createElement('div');
  voiceDiv.style.cssText = 'display:flex;gap:8px;margin-top:8px;';
  voiceDiv.innerHTML = `
    <button id="voiceMicBtn" onclick="VoiceAI.toggleListening()" class="btn" style="background:#10b981;color:white;flex:1">üé§ Speak</button>
    <button id="voiceSpeakerBtn" onclick="VoiceAI.toggleVoiceOutput()" class="btn" style="background:#6366f1;color:white;width:50px">üîä</button>
    <button onclick="VoiceAI.stopSpeaking()" class="btn" style="background:#ef4444;color:white;width:50px">‚èπÔ∏è</button>
  `;
  
  inputParent.appendChild(voiceDiv);
}

// Initialize voice on load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    VoiceAI.init();
    injectVoiceControls();
  }, 1000);
});

// ========== END AI-4 ==========

// ========== AI-5: REPORT GENERATION ==========

const AIReports = {
  
  generateShiftReport() {
    const ctx = getPlantContext();
    const now = new Date();
    const shift = now.getHours() < 8 ? 'Night' : now.getHours() < 16 ? 'Day' : 'Evening';
    
    let report = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       WWTP SHIFT REPORT - ${shift.toUpperCase()} SHIFT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Date: ${now.toLocaleDateString()}
Time: ${now.toLocaleTimeString()}
Generated by: WWTP AI Assistant

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
PROCESS PARAMETERS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Flow Rate:     ${ctx.flow} MGD
DO Level:      ${ctx.do} mg/L    ${ctx.do < 2.0 ? '‚ö†Ô∏è LOW' : '‚úì'}
MLSS:          ${ctx.mlss} mg/L  ${ctx.mlss < 2000 || ctx.mlss > 4500 ? '‚ö†Ô∏è' : '‚úì'}
F/M Ratio:     ${ctx.fm}         ${ctx.fm < 0.15 || ctx.fm > 0.5 ? '‚ö†Ô∏è' : '‚úì'}
SRT:           ${ctx.srt} days   ${ctx.srt < 8 ? '‚ö†Ô∏è LOW' : '‚úì'}
SVI:           ${ctx.svi} mL/g   ${ctx.svi > 150 ? '‚ö†Ô∏è HIGH' : '‚úì'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ISSUES & OBSERVATIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${ctx.issues.length > 0 ? ctx.issues.join('\n') : 'No issues detected - all parameters normal'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
RECOMMENDATIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${this.getRecommendations(ctx)}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
NOTES FOR NEXT SHIFT
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
[Add notes here]

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    END OF REPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;
    return report;
  },
  
  generateComplianceReport() {
    const ctx = getPlantContext();
    const now = new Date();
    
    let report = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        COMPLIANCE STATUS REPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Report Date: ${now.toLocaleDateString()}
Reporting Period: Weekly Summary

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
PERMIT PARAMETERS STATUS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Parameter      Current    Limit    Status
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BOD            --         30 mg/L  Monitoring
TSS            --         30 mg/L  Monitoring
NH3-N          --         5 mg/L   Monitoring
pH             ${ctx.ph || 7.0}       6.0-9.0  ${ctx.ph >= 6.0 && ctx.ph <= 9.0 ? '‚úì COMPLIANT' : '‚ö†Ô∏è CHECK'}
DO (effluent)  ${ctx.do} mg/L   >5 mg/L  ${ctx.do > 5 ? '‚úì COMPLIANT' : 'N/A - Process'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
PROCESS INDICATORS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SVI:           ${ctx.svi} mL/g   ${ctx.svi > 150 ? '‚ö†Ô∏è Settling issues may affect TSS' : '‚úì Good settling'}
F/M:           ${ctx.fm}         ${ctx.fm > 0.5 ? '‚ö†Ô∏è High loading' : '‚úì Normal'}
SRT:           ${ctx.srt} days   ${ctx.srt < 8 ? '‚ö†Ô∏è Nitrification at risk' : '‚úì Adequate'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
COMPLIANCE RISK ASSESSMENT
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${this.getComplianceRisks(ctx)}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
CORRECTIVE ACTIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${ctx.issues.length > 0 ? 'Required actions based on current conditions:\n' + this.getRecommendations(ctx) : 'No corrective actions required at this time.'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;
    return report;
  },
  
  generateDailySummary() {
    const ctx = getPlantContext();
    const alerts = generatePredictiveAlerts();
    const now = new Date();
    
    let report = `
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        DAILY OPERATIONS SUMMARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Date: ${now.toLocaleDateString()}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
KEY METRICS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Flow: ${ctx.flow} MGD
‚Ä¢ DO: ${ctx.do} mg/L
‚Ä¢ MLSS: ${ctx.mlss} mg/L
‚Ä¢ F/M: ${ctx.fm}
‚Ä¢ SRT: ${ctx.srt} days
‚Ä¢ SVI: ${ctx.svi} mL/g

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ALERTS (${alerts.length})
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${alerts.length > 0 ? alerts.map(a => `‚Ä¢ ${a.severity.toUpperCase()}: ${a.param} - ${a.message}`).join('\n') : '‚Ä¢ No alerts - system operating normally'}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TRENDING
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${this.getTrendingSummary()}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
`;
    return report;
  },
  
  getRecommendations(ctx) {
    let recs = [];
    if (ctx.do < 2.0) recs.push('‚Ä¢ Increase aeration - DO below optimal');
    if (ctx.svi > 150) recs.push('‚Ä¢ Investigate bulking - consider RAS chlorination');
    if (ctx.fm > 0.5) recs.push('‚Ä¢ High F/M - increase MLSS or reduce loading');
    if (ctx.srt < 8) recs.push('‚Ä¢ CRITICAL: Reduce wasting to increase SRT');
    if (ctx.mlss > 4500) recs.push('‚Ä¢ High MLSS - increase WAS rate');
    if (ctx.mlss < 2000) recs.push('‚Ä¢ Low MLSS - reduce WAS rate');
    return recs.length > 0 ? recs.join('\n') : '‚Ä¢ Continue normal operations';
  },
  
  getComplianceRisks(ctx) {
    let risks = [];
    if (ctx.svi > 150) risks.push('‚Ä¢ MEDIUM: High SVI may lead to TSS exceedance');
    if (ctx.srt < 8) risks.push('‚Ä¢ HIGH: Low SRT may cause ammonia violation');
    if (ctx.fm > 0.5) risks.push('‚Ä¢ MEDIUM: High F/M may affect BOD removal');
    return risks.length > 0 ? risks.join('\n') : '‚Ä¢ LOW: No significant compliance risks identified';
  },
  
  getTrendingSummary() {
    const params = ['do', 'mlss', 'svi', 'fm'];
    let summary = [];
    params.forEach(p => {
      const trend = TrendTracker.getTrend(p);
      if (trend.direction !== 'unknown') {
        const arrow = trend.direction === 'increasing' ? '‚Üë' : trend.direction === 'decreasing' ? '‚Üì' : '‚Üí';
        summary.push(`‚Ä¢ ${p.toUpperCase()}: ${arrow} ${trend.direction} (${trend.change}%)`);
      }
    });
    return summary.length > 0 ? summary.join('\n') : '‚Ä¢ Insufficient data for trend analysis';
  },
  
  downloadReport(type) {
    let content, filename;
    
    switch(type) {
      case 'shift':
        content = this.generateShiftReport();
        filename = 'WWTP-Shift-Report';
        break;
      case 'compliance':
        content = this.generateComplianceReport();
        filename = 'WWTP-Compliance-Report';
        break;
      case 'daily':
        content = this.generateDailySummary();
        filename = 'WWTP-Daily-Summary';
        break;
      default:
        content = this.generateShiftReport();
        filename = 'WWTP-Report';
    }
    
    const date = new Date().toISOString().split('T')[0];
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${filename}-${date}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    showToast('üìÑ Report downloaded!', 'success');
    return content;
  }
};

// Check for report requests in AI
function isReportRequest(msg) {
  const lower = msg.toLowerCase();
  return lower.includes('report') || lower.includes('summary') || lower.includes('generate');
}

function handleReportRequest(msg) {
  const lower = msg.toLowerCase();
  
  if (lower.includes('shift')) {
    const report = AIReports.downloadReport('shift');
    return `<strong>üìã Shift Report Generated!</strong><br><br>Report downloaded. Preview:<br><pre style="font-size:11px;background:#1a1a2e;padding:10px;border-radius:8px;overflow-x:auto;white-space:pre-wrap">${report.substring(0, 800)}...</pre>`;
  }
  
  if (lower.includes('compliance')) {
    const report = AIReports.downloadReport('compliance');
    return `<strong>üìã Compliance Report Generated!</strong><br><br>Report downloaded. Preview:<br><pre style="font-size:11px;background:#1a1a2e;padding:10px;border-radius:8px;overflow-x:auto;white-space:pre-wrap">${report.substring(0, 800)}...</pre>`;
  }
  
  if (lower.includes('daily') || lower.includes('summary')) {
    const report = AIReports.downloadReport('daily');
    return `<strong>üìã Daily Summary Generated!</strong><br><br>Report downloaded. Preview:<br><pre style="font-size:11px;background:#1a1a2e;padding:10px;border-radius:8px;overflow-x:auto;white-space:pre-wrap">${report.substring(0, 800)}...</pre>`;
  }
  
  return `<strong>üìÑ Available Reports:</strong><br><br>
‚Ä¢ <strong>"Generate shift report"</strong> - Current conditions & recommendations<br>
‚Ä¢ <strong>"Generate compliance report"</strong> - Permit status & risks<br>
‚Ä¢ <strong>"Generate daily summary"</strong> - Quick overview with trends<br><br>
Which report would you like?`;
}

// ========== END AI-5 ==========

// ========== AI-6: LEARNING SYSTEM ==========

const AILearning = {
  key: 'wwtp_ai_learning',
  
  // Get stored learning data
  getData() {
    try {
      return JSON.parse(localStorage.getItem(this.key)) || this.getDefaults();
    } catch { return this.getDefaults(); }
  },
  
  // Default plant profile
  getDefaults() {
    return {
      plantName: 'My Plant',
      plantType: 'conventional', // conventional, extended, sbr, mbr
      designFlow: 5.0,
      normalRanges: {
        do: { min: 2.0, max: 3.0, unit: 'mg/L' },
        mlss: { min: 2500, max: 4000, unit: 'mg/L' },
        svi: { min: 80, max: 150, unit: 'mL/g' },
        fm: { min: 0.2, max: 0.4, unit: 'lb/lb/d' },
        srt: { min: 8, max: 15, unit: 'days' },
        ph: { min: 6.8, max: 7.5, unit: '' }
      },
      corrections: [],
      preferences: {
        preferredUnits: 'imperial',
        alertLevel: 'normal', // relaxed, normal, strict
        focusAreas: [] // nitrification, energy, solids, etc.
      },
      lastUpdated: null
    };
  },
  
  // Save learning data
  save(data) {
    data.lastUpdated = new Date().toISOString();
    localStorage.setItem(this.key, JSON.stringify(data));
  },
  
  // Learn from user correction
  learnCorrection(param, userValue, aiSuggestion, context) {
    const data = this.getData();
    data.corrections.push({
      param,
      userValue,
      aiSuggestion,
      context,
      timestamp: new Date().toISOString()
    });
    // Keep last 50 corrections
    data.corrections = data.corrections.slice(-50);
    this.save(data);
  },
  
  // Update normal range based on user feedback
  updateNormalRange(param, min, max) {
    const data = this.getData();
    if (data.normalRanges[param]) {
      data.normalRanges[param].min = min;
      data.normalRanges[param].max = max;
      this.save(data);
      return true;
    }
    return false;
  },
  
  // Set plant profile
  setPlantProfile(name, type, flow) {
    const data = this.getData();
    data.plantName = name;
    data.plantType = type;
    data.designFlow = flow;
    
    // Adjust ranges based on plant type
    if (type === 'extended') {
      data.normalRanges.fm = { min: 0.05, max: 0.15, unit: 'lb/lb/d' };
      data.normalRanges.srt = { min: 15, max: 30, unit: 'days' };
    } else if (type === 'sbr') {
      data.normalRanges.srt = { min: 10, max: 20, unit: 'days' };
    } else if (type === 'mbr') {
      data.normalRanges.mlss = { min: 8000, max: 12000, unit: 'mg/L' };
      data.normalRanges.srt = { min: 15, max: 25, unit: 'days' };
    }
    
    this.save(data);
  },
  
  // Check if value is in learned normal range
  isNormal(param, value) {
    const data = this.getData();
    const range = data.normalRanges[param];
    if (!range) return { normal: true, message: '' };
    
    if (value < range.min) {
      return { normal: false, message: `Below your normal (${range.min}-${range.max} ${range.unit})` };
    }
    if (value > range.max) {
      return { normal: false, message: `Above your normal (${range.min}-${range.max} ${range.unit})` };
    }
    return { normal: true, message: `Within your normal range` };
  },
  
  // Get personalized recommendations
  getPersonalizedRecs() {
    const data = this.getData();
    const ctx = getPlantContext();
    let recs = [];
    
    // Check each parameter against learned ranges
    const checks = [
      { param: 'do', value: ctx.do, name: 'DO' },
      { param: 'mlss', value: ctx.mlss, name: 'MLSS' },
      { param: 'svi', value: ctx.svi, name: 'SVI' },
      { param: 'fm', value: ctx.fm, name: 'F/M' },
      { param: 'srt', value: ctx.srt, name: 'SRT' }
    ];
    
    checks.forEach(({ param, value, name }) => {
      const result = this.isNormal(param, value);
      if (!result.normal && value > 0) {
        recs.push(`${name}: ${value} - ${result.message}`);
      }
    });
    
    return recs;
  },
  
  // Get plant summary
  getPlantSummary() {
    const data = this.getData();
    return `<strong>üè≠ ${data.plantName}</strong><br>
Type: ${data.plantType.charAt(0).toUpperCase() + data.plantType.slice(1)}<br>
Design Flow: ${data.designFlow} MGD<br>
Last Updated: ${data.lastUpdated ? new Date(data.lastUpdated).toLocaleDateString() : 'Never'}`;
  }
};

// AI learning commands handler
function handleLearningCommand(msg) {
  const lower = msg.toLowerCase();
  
  // Set plant name
  if (lower.includes('plant name is') || lower.includes('my plant is called')) {
    const match = msg.match(/(?:plant name is|my plant is called)\s+(.+)/i);
    if (match) {
      const data = AILearning.getData();
      data.plantName = match[1].trim();
      AILearning.save(data);
      return `‚úÖ Got it! I'll remember your plant is called <strong>${match[1].trim()}</strong>`;
    }
  }
  
  // Set plant type
  if (lower.includes('plant type') || lower.includes('we have a') || lower.includes('we run')) {
    if (lower.includes('extended')) {
      AILearning.setPlantProfile(AILearning.getData().plantName, 'extended', AILearning.getData().designFlow);
      return `‚úÖ Set plant type to <strong>Extended Aeration</strong>. I've adjusted expected ranges for F/M (0.05-0.15) and SRT (15-30 days).`;
    }
    if (lower.includes('mbr')) {
      AILearning.setPlantProfile(AILearning.getData().plantName, 'mbr', AILearning.getData().designFlow);
      return `‚úÖ Set plant type to <strong>MBR</strong>. I've adjusted expected MLSS (8000-12000 mg/L) and SRT (15-25 days).`;
    }
    if (lower.includes('sbr')) {
      AILearning.setPlantProfile(AILearning.getData().plantName, 'sbr', AILearning.getData().designFlow);
      return `‚úÖ Set plant type to <strong>SBR</strong>. I've adjusted expected SRT range (10-20 days).`;
    }
    if (lower.includes('conventional')) {
      AILearning.setPlantProfile(AILearning.getData().plantName, 'conventional', AILearning.getData().designFlow);
      return `‚úÖ Set plant type to <strong>Conventional Activated Sludge</strong> with standard ranges.`;
    }
  }
  
  // Set normal range
  if (lower.includes('normal') && lower.includes('is')) {
    const params = ['do', 'mlss', 'svi', 'fm', 'srt'];
    for (const p of params) {
      if (lower.includes(p)) {
        const numbers = msg.match(/[\d.]+/g);
        if (numbers && numbers.length >= 2) {
          AILearning.updateNormalRange(p, parseFloat(numbers[0]), parseFloat(numbers[1]));
          return `‚úÖ Updated! Your normal ${p.toUpperCase()} range is now <strong>${numbers[0]} - ${numbers[1]}</strong>`;
        }
      }
    }
  }
  
  // Show learned profile
  if (lower.includes('what do you know') || lower.includes('my profile') || lower.includes('what have you learned')) {
    const data = AILearning.getData();
    let response = AILearning.getPlantSummary() + '<br><br><strong>Your Normal Ranges:</strong><br>';
    for (const [param, range] of Object.entries(data.normalRanges)) {
      response += `‚Ä¢ ${param.toUpperCase()}: ${range.min} - ${range.max} ${range.unit}<br>`;
    }
    if (data.corrections.length > 0) {
      response += `<br><em>I've learned from ${data.corrections.length} corrections you've made.</em>`;
    }
    return response;
  }
  
  // Reset learning
  if (lower.includes('forget') || lower.includes('reset learning')) {
    localStorage.removeItem(AILearning.key);
    return `üóëÔ∏è Learning data cleared. I'll start fresh with default ranges.`;
  }
  
  return null;
}

// Enhanced context with learning
function getEnhancedPlantContext() {
  const ctx = getPlantContext();
  const personalRecs = AILearning.getPersonalizedRecs();
  
  if (personalRecs.length > 0) {
    ctx.personalizedIssues = personalRecs;
  }
  
  return ctx;
}

// ========== END AI-6 ==========

// ========== TIER 1: FOUNDATIONAL AI INTELLIGENCE ==========

const AppBrain = {
  
  // ===== COMPLETE APP KNOWLEDGE BASE =====
  panels: {
    'dashboard': {
      name: 'Dashboard',
      icon: 'üìä',
      description: 'Main overview with KPIs, health score, AI recommendations, alarms, and quick actions',
      features: ['KPI cards', 'Health score', 'AI recommendations', 'Alarm system', 'Quick actions', 'Trends', 'Energy monitoring'],
      keywords: ['home', 'overview', 'main', 'kpi', 'summary', 'start']
    },
    'daily-ops': {
      name: 'Daily Operations',
      icon: 'üë∑',
      description: 'Daily rounds checklist, calculation wizards, operator training, and formula reference',
      features: ['Daily checklist', 'Morning/Midday/Evening rounds', 'Calculation wizards', 'Training modules', 'Formula reference'],
      keywords: ['daily', 'rounds', 'checklist', 'shift', 'operator', 'training', 'formulas']
    },
    'process-control': {
      name: 'Process Control',
      icon: '‚öôÔ∏è',
      description: 'Core process calculations: F/M, SRT, SVI, loading, BOD removal, WAS, RAS',
      features: ['F/M ratio', 'SRT/MCRT', 'SVI', 'Organic loading', 'BOD efficiency', 'WAS calculation', 'RAS calculation'],
      calculators: ['calcFM', 'calcSRTmain', 'calcSVI', 'calcLoading', 'calcBODeff', 'calcWAS', 'calcRAS', 'calcHRT'],
      keywords: ['process', 'fm', 'srt', 'mcrt', 'svi', 'loading', 'bod', 'was', 'ras', 'control', 'activated sludge']
    },
    'reactors': {
      name: 'Reactors',
      icon: 'üîÑ',
      description: 'SBR, MBR, and MBBR reactor calculations and troubleshooting',
      features: ['SBR cycle time', 'SBR aeration', 'SBR settling', 'MBR flux', 'MBR cleaning', 'MBBR media', 'MBBR nitrification', 'IFAS'],
      calculators: ['calcSBRCycle', 'calcSBRAeration', 'calcSBRSettle', 'calcMBRFlux', 'calcMBRCleaning', 'calcMBBRMedia', 'calcMBBRNitrif'],
      keywords: ['sbr', 'mbr', 'mbbr', 'ifas', 'reactor', 'sequencing batch', 'membrane', 'moving bed']
    },
    'hydraulics': {
      name: 'Hydraulics',
      icon: 'üìê',
      description: 'Pumping, flow, headloss, weirs, channels, clarifiers, and hydraulic calculations',
      features: ['Pump calculations', 'Headloss', 'Weir loading', 'Channel flow', 'Clarifier sizing', 'Hydraulic profile', 'Pipe sizing'],
      calculators: ['calcPump', 'calcHeadloss', 'calcWeir', 'calcChannelFlow', 'calcClarifier', 'calcHydraulicProfile'],
      keywords: ['pump', 'flow', 'head', 'weir', 'channel', 'pipe', 'hydraulic', 'clarifier', 'gpm', 'velocity']
    },
    'aeration': {
      name: 'Aeration & Energy',
      icon: 'üí®',
      description: 'Oxygen requirements, blower sizing, energy costs, diffuser performance',
      features: ['Oxygen demand', 'Blower sizing', 'Energy analysis', 'Diffuser performance', 'OTE calculations', 'VFD savings'],
      calculators: ['calcOxygen', 'calcBlower', 'calcEnergy', 'calcOTE', 'calcAir', 'calcVFDSavings'],
      keywords: ['aeration', 'oxygen', 'do', 'blower', 'diffuser', 'energy', 'air', 'scfm', 'ote']
    },
    'chemicals': {
      name: 'Chemical Systems',
      icon: 'üß™',
      description: 'Chemical dosing, chlorination, dechlorination, pH adjustment, polymer, nutrients',
      features: ['Chlorine dosing', 'Dechlorination', 'pH adjustment', 'Polymer dosing', 'Nutrient addition', 'Chemical costs'],
      calculators: ['calcChlorine', 'calcPolymer', 'calcDosing', 'calcPH', 'calcAlkalinity', 'calcCarbon', 'calcNutrients'],
      keywords: ['chemical', 'chlorine', 'polymer', 'ph', 'alkalinity', 'dose', 'sodium', 'ferric', 'alum']
    },
    'solids': {
      name: 'Solids Handling',
      icon: 'üóëÔ∏è',
      description: 'Sludge production, thickening, digestion, dewatering, biosolids, disposal',
      features: ['Sludge production', 'Thickening', 'Digester calculations', 'Dewatering', 'Belt press', 'Centrifuge', 'Biosolids', 'Disposal costs'],
      calculators: ['calcSludge', 'calcThickening', 'calcDigester', 'calcDewatering', 'calcBeltPress', 'calcBiosolids', 'calcBiogas'],
      keywords: ['sludge', 'solids', 'thickening', 'digester', 'dewatering', 'biosolids', 'cake', 'disposal', 'hauling']
    },
    'compliance': {
      name: 'Compliance & Lab',
      icon: 'üìã',
      description: 'TCEQ compliance, permit tracking, DMR generation, lab QA/QC, effluent limits',
      features: ['Lab sample entry', 'Permit info', 'Effluent limits', 'DMR generator', 'Compliance calendar', 'QA/QC status'],
      calculators: ['calculateDMRStats', 'calcGeoMean', 'calcRemoval'],
      keywords: ['compliance', 'permit', 'tceq', 'dmr', 'lab', 'sample', 'limit', 'violation', 'effluent']
    },
    'wizards': {
      name: 'Wizards & Diagnostics',
      icon: 'üß≠',
      description: 'Guided troubleshooting wizards, system diagnostics, health scoring',
      features: ['Troubleshooting wizards', 'Symptom checker', 'Knowledge base', 'Issue history', 'Health score'],
      keywords: ['wizard', 'troubleshoot', 'diagnose', 'problem', 'issue', 'help', 'guide']
    },
    'maintenance': {
      name: 'Maintenance',
      icon: 'üîß',
      description: 'Equipment maintenance tracking, schedules, and work orders',
      features: ['Maintenance schedules', 'Equipment tracking', 'Work orders', 'PM calendar'],
      keywords: ['maintenance', 'equipment', 'repair', 'pm', 'preventive', 'work order']
    },
    'reports': {
      name: 'Reports',
      icon: 'üìë',
      description: 'Report generation, data export, operational summaries',
      features: ['Shift reports', 'Monthly summaries', 'Data export', 'Custom reports'],
      keywords: ['report', 'export', 'summary', 'print', 'pdf']
    },
    'profiles': {
      name: 'Plant Profiles',
      icon: 'üè≠',
      description: 'Save and load plant configurations, import/export settings',
      features: ['Plant profiles', 'Configuration saving', 'Import/export', 'Default values'],
      keywords: ['profile', 'plant', 'save', 'load', 'configuration', 'settings']
    },
    'business': {
      name: 'Business & Consulting',
      icon: 'üíº',
      description: 'Client management, proposals, ROI calculator, time tracking, cost analysis',
      features: ['Client database', 'Proposal generator', 'ROI calculator', 'Time tracking', 'Cost analysis', 'Invoicing'],
      calculators: ['calculateROI', 'calcTreatmentCost', 'calculateAllCosts'],
      keywords: ['business', 'client', 'proposal', 'roi', 'cost', 'consulting', 'invoice', 'time']
    },
    'multiplant': {
      name: 'Multi-Plant',
      icon: 'üè≠',
      description: 'Fleet management for multiple treatment facilities',
      features: ['Plant comparison', 'Fleet overview', 'Cross-plant analytics'],
      keywords: ['multi', 'fleet', 'compare', 'plants', 'facilities']
    }
  },

  // ===== CALCULATOR KNOWLEDGE =====
  calculators: {
    // Process Control
    'fm': { fn: 'calcFM', panel: 'process-control', name: 'F/M Ratio', inputs: ['BOD load', 'MLVSS', 'Volume'], unit: 'lb/lb/d', keywords: ['food', 'microorganism', 'loading'] },
    'srt': { fn: 'calcSRTmain', panel: 'process-control', name: 'Solids Retention Time', inputs: ['MLSS', 'Volume', 'WAS flow', 'WAS concentration'], unit: 'days', keywords: ['mcrt', 'sludge age', 'mean cell'] },
    'svi': { fn: 'calcSVI', panel: 'process-control', name: 'Sludge Volume Index', inputs: ['Settled volume', 'MLSS'], unit: 'mL/g', keywords: ['settling', 'settleability', 'bulking'] },
    'loading': { fn: 'calcLoading', panel: 'process-control', name: 'Organic Loading', inputs: ['Flow', 'BOD'], unit: 'lb/day', keywords: ['bod loading', 'mass'] },
    'was': { fn: 'calcWAS', panel: 'process-control', name: 'Waste Activated Sludge', inputs: ['Volume', 'MLSS', 'Target SRT'], unit: 'GPD', keywords: ['wasting', 'sludge wasting'] },
    'ras': { fn: 'calcRAS', panel: 'process-control', name: 'Return Activated Sludge', inputs: ['Flow', 'SVI', 'MLSS'], unit: '%', keywords: ['return', 'recycle'] },
    
    // Aeration
    'oxygen': { fn: 'calcOxygen', panel: 'aeration', name: 'Oxygen Requirement', inputs: ['BOD removed', 'NH3 oxidized', 'Flow'], unit: 'lb O2/day', keywords: ['aor', 'sor', 'demand'] },
    'blower': { fn: 'calcBlower', panel: 'aeration', name: 'Blower Sizing', inputs: ['Air flow', 'Pressure', 'Efficiency'], unit: 'HP', keywords: ['air', 'scfm', 'pressure'] },
    'energy': { fn: 'calcEnergy', panel: 'aeration', name: 'Energy Cost', inputs: ['HP', 'Hours', 'Rate'], unit: '$/day', keywords: ['power', 'electricity', 'kwh'] },
    
    // Chemicals
    'chlorine': { fn: 'calcChlorine', panel: 'chemicals', name: 'Chlorine Dosing', inputs: ['Flow', 'Dose'], unit: 'lb/day', keywords: ['disinfection', 'cl2', 'hypochlorite'] },
    'polymer': { fn: 'calcPolymer', panel: 'chemicals', name: 'Polymer Dosing', inputs: ['Flow', 'Dose', 'Concentration'], unit: 'lb/day', keywords: ['flocculant', 'coagulant'] },
    'alkalinity': { fn: 'calcAlkalinity', panel: 'chemicals', name: 'Alkalinity Adjustment', inputs: ['Flow', 'Current alk', 'Target alk'], unit: 'lb/day', keywords: ['lime', 'caustic', 'soda ash'] },
    
    // Solids
    'sludge': { fn: 'calcSludge', panel: 'solids', name: 'Sludge Production', inputs: ['Flow', 'TSS removed', 'BOD removed'], unit: 'lb/day', keywords: ['production', 'yield'] },
    'dewatering': { fn: 'calcDewatering', panel: 'solids', name: 'Dewatering', inputs: ['Sludge flow', 'Feed solids', 'Cake solids'], unit: 'dry tons/day', keywords: ['belt press', 'centrifuge', 'cake'] },
    'digester': { fn: 'calcDigester', panel: 'solids', name: 'Digester Loading', inputs: ['Sludge volume', 'VS concentration', 'Digester volume'], unit: 'lb VS/cf/day', keywords: ['anaerobic', 'volatile solids'] },
    
    // Hydraulics
    'pump': { fn: 'calcPump', panel: 'hydraulics', name: 'Pump Power', inputs: ['Flow', 'Head', 'Efficiency'], unit: 'HP', keywords: ['pumping', 'tdh', 'brake'] },
    'headloss': { fn: 'calcHeadloss', panel: 'hydraulics', name: 'Pipe Headloss', inputs: ['Flow', 'Diameter', 'Length', 'C-factor'], unit: 'ft', keywords: ['friction', 'hazen williams'] },
    'weir': { fn: 'calcWeir', panel: 'hydraulics', name: 'Weir Loading', inputs: ['Flow', 'Weir length'], unit: 'GPM/ft', keywords: ['overflow', 'effluent'] },
    'clarifier': { fn: 'calcClarifier', panel: 'hydraulics', name: 'Clarifier Loading', inputs: ['Flow', 'Diameter'], unit: 'GPD/sf', keywords: ['surface loading', 'overflow rate', 'solids loading'] }
  },

  // ===== TROUBLESHOOTING KNOWLEDGE =====
  troubleshooting: {
    'high_svi': {
      symptoms: ['svi over 150', 'poor settling', 'bulking', 'rising sludge', 'floating sludge'],
      causes: ['Filamentous bacteria', 'Low DO', 'Low F/M', 'Nutrient deficiency', 'pH issues'],
      solutions: ['Check DO (maintain >2.0)', 'Verify F/M ratio', 'Microscopic exam', 'Consider RAS chlorination', 'Add selector zone'],
      calculators: ['calcSVI', 'calcFM', 'calcRAS']
    },
    'high_ammonia': {
      symptoms: ['ammonia in effluent', 'nitrification failure', 'nh3 breakthrough'],
      causes: ['Low SRT', 'Low DO', 'Low alkalinity', 'Cold temperature', 'Toxic loading'],
      solutions: ['Increase SRT to >8 days', 'Raise DO to >2.5', 'Add alkalinity', 'Reduce wasting', 'Check for toxics'],
      calculators: ['calcSRTmain', 'calcAlkalinity', 'calcNitrogen']
    },
    'high_tss': {
      symptoms: ['turbid effluent', 'high tss', 'solids carryover', 'cloudy effluent'],
      causes: ['Clarifier overload', 'Poor settling', 'Hydraulic surge', 'Denitrification', 'Short-circuiting'],
      solutions: ['Check clarifier loading', 'Verify SVI', 'Adjust RAS rate', 'Check for rising sludge', 'Inspect baffles'],
      calculators: ['calcClarifier', 'calcSVI', 'calcRAS']
    },
    'foam': {
      symptoms: ['foam', 'scum', 'brown foam', 'white foam', 'nocardia'],
      causes: ['Nocardia/Microthrix', 'Young sludge', 'Surfactants', 'Low F/M', 'Grease'],
      solutions: ['Increase wasting', 'Spray water', 'Remove grease', 'Check F/M', 'Microscopic ID'],
      calculators: ['calcFM', 'calcSRTmain', 'calcWAS']
    },
    'low_do': {
      symptoms: ['low do', 'oxygen depleted', 'black sludge', 'septic'],
      causes: ['Blower failure', 'High loading', 'Diffuser fouling', 'Undersized aeration'],
      solutions: ['Check blowers', 'Clean diffusers', 'Verify loading', 'Add temporary aeration'],
      calculators: ['calcOxygen', 'calcBlower', 'calcLoading']
    }
  },

  // ===== NAVIGATION FUNCTION =====
  navigate(panelId) {
    if (typeof switchPanel === 'function') {
      switchPanel(panelId);
      return true;
    }
    return false;
  },

  // ===== FIND PANEL BY KEYWORD =====
  findPanel(query) {
    const q = query.toLowerCase();
    for (const [id, panel] of Object.entries(this.panels)) {
      if (panel.keywords.some(k => q.includes(k)) || 
          panel.name.toLowerCase().includes(q) ||
          panel.description.toLowerCase().includes(q)) {
        return { id, ...panel };
      }
    }
    return null;
  },

  // ===== FIND CALCULATOR BY KEYWORD =====
  findCalculator(query) {
    const q = query.toLowerCase();
    for (const [key, calc] of Object.entries(this.calculators)) {
      if (key.includes(q) || 
          calc.name.toLowerCase().includes(q) ||
          calc.keywords.some(k => q.includes(k))) {
        return { key, ...calc };
      }
    }
    return null;
  },

  // ===== FIND TROUBLESHOOTING =====
  findTroubleshooting(query) {
    const q = query.toLowerCase();
    for (const [key, issue] of Object.entries(this.troubleshooting)) {
      if (issue.symptoms.some(s => q.includes(s)) ||
          key.replace('_', ' ').includes(q)) {
        return { key, ...issue };
      }
    }
    return null;
  },

  // ===== RUN CALCULATOR =====
  runCalculator(calcKey) {
    const calc = this.calculators[calcKey];
    if (calc && typeof window[calc.fn] === 'function') {
      this.navigate(calc.panel);
      setTimeout(() => {
        window[calc.fn]();
        showToast(`‚úì Calculated ${calc.name}`, 'success');
      }, 300);
      return true;
    }
    return false;
  },

  // ===== GET CURRENT PANEL =====
  getCurrentPanel() {
    const active = document.querySelector('.panel.active');
    if (active && this.panels[active.id]) {
      return { id: active.id, ...this.panels[active.id] };
    }
    return null;
  },

  // ===== CONTEXTUAL HELP =====
  getContextualHelp() {
    const panel = this.getCurrentPanel();
    if (!panel) return "I can't determine your current location. Try clicking a tab.";
    
    let help = `<strong>${panel.icon} ${panel.name}</strong><br><br>`;
    help += `${panel.description}<br><br>`;
    help += `<strong>Features here:</strong><br>`;
    panel.features.forEach(f => {
      help += `‚Ä¢ ${f}<br>`;
    });
    
    if (panel.calculators && panel.calculators.length > 0) {
      help += `<br><strong>Calculators:</strong><br>`;
      panel.calculators.forEach(c => {
        const calc = Object.values(this.calculators).find(x => x.fn === c);
        if (calc) help += `‚Ä¢ ${calc.name}<br>`;
      });
    }
    
    return help;
  },

  // ===== LIST ALL CALCULATORS =====
  listCalculators(panelId = null) {
    let list = [];
    for (const [key, calc] of Object.entries(this.calculators)) {
      if (!panelId || calc.panel === panelId) {
        list.push(`‚Ä¢ <strong>${calc.name}</strong> (${calc.unit}) - ${this.panels[calc.panel]?.icon || ''} ${this.panels[calc.panel]?.name || calc.panel}`);
      }
    }
    return list.join('<br>');
  },

  // ===== LIST ALL PANELS =====
  listPanels() {
    let list = [];
    for (const [id, panel] of Object.entries(this.panels)) {
      list.push(`‚Ä¢ ${panel.icon} <strong>${panel.name}</strong> - ${panel.description.substring(0, 50)}...`);
    }
    return list.join('<br>');
  }
};

// ===== ENHANCED AI RESPONSE WITH APP BRAIN =====
function generateSmartResponse(msg) {
  const lower = msg.toLowerCase();
  
  // Navigation requests
  if (lower.includes('go to') || lower.includes('take me to') || lower.includes('open') || lower.includes('show me') || lower.includes('navigate')) {
    const panel = AppBrain.findPanel(lower);
    if (panel) {
      AppBrain.navigate(panel.id);
      return `${panel.icon} Opening <strong>${panel.name}</strong>...<br><br>${panel.description}<br><br>What would you like to do here?`;
    }
  }
  
  // What's here / Help with current panel
  if (lower.includes('what can i do') || lower.includes("what's here") || lower.includes('help me') || lower.includes('where am i')) {
    return AppBrain.getContextualHelp();
  }
  
  // List panels
  if (lower.includes('what panels') || lower.includes('what tabs') || lower.includes('show all panels') || lower.includes('app sections')) {
    return `<strong>üì± App Panels:</strong><br><br>${AppBrain.listPanels()}`;
  }
  
  // List calculators
  if (lower.includes('what calculators') || lower.includes('list calculators') || lower.includes('available calculations')) {
    const panel = AppBrain.getCurrentPanel();
    if (lower.includes('all') || lower.includes('every')) {
      return `<strong>üßÆ All Calculators:</strong><br><br>${AppBrain.listCalculators()}`;
    } else if (panel) {
      const panelCalcs = AppBrain.listCalculators(panel.id);
      if (panelCalcs) {
        return `<strong>üßÆ Calculators in ${panel.name}:</strong><br><br>${panelCalcs}<br><br><em>Say "list all calculators" to see everything.</em>`;
      }
    }
    return `<strong>üßÆ All Calculators:</strong><br><br>${AppBrain.listCalculators()}`;
  }
  
  // Calculator requests
  if (lower.includes('calculate') || lower.includes('compute') || lower.includes('figure out') || lower.includes('what is my')) {
    const calc = AppBrain.findCalculator(lower);
    if (calc) {
      AppBrain.runCalculator(calc.key);
      return `üßÆ Running <strong>${calc.name}</strong> calculator...<br><br>I've navigated to ${AppBrain.panels[calc.panel]?.name || calc.panel} and started the calculation.<br><br><strong>Inputs needed:</strong><br>${calc.inputs.map(i => '‚Ä¢ ' + i).join('<br>')}<br><br>Fill in the values and the result will show in <strong>${calc.unit}</strong>.`;
    }
  }
  
  // Troubleshooting
  if (lower.includes('problem') || lower.includes('issue') || lower.includes('troubleshoot') || lower.includes('why is') || lower.includes('help with')) {
    const issue = AppBrain.findTroubleshooting(lower);
    if (issue) {
      let response = `<strong>üîß Troubleshooting: ${issue.key.replace('_', ' ').toUpperCase()}</strong><br><br>`;
      response += `<strong>Possible Causes:</strong><br>${issue.causes.map(c => '‚Ä¢ ' + c).join('<br>')}<br><br>`;
      response += `<strong>Solutions:</strong><br>${issue.solutions.map(s => '‚Ä¢ ' + s).join('<br>')}<br><br>`;
      response += `<strong>Helpful Calculators:</strong><br>${issue.calculators.map(c => '‚Ä¢ ' + (AppBrain.calculators[c.replace('calc', '').toLowerCase()]?.name || c)).join('<br>')}`;
      return response;
    }
  }
  
  // Where to find something
  if (lower.includes('where') || lower.includes('find') || lower.includes('how do i')) {
    const panel = AppBrain.findPanel(lower);
    if (panel) {
      return `You can find that in <strong>${panel.icon} ${panel.name}</strong>.<br><br>${panel.description}<br><br>Say "go to ${panel.name.toLowerCase()}" to navigate there.`;
    }
    const calc = AppBrain.findCalculator(lower);
    if (calc) {
      const panel = AppBrain.panels[calc.panel];
      return `The <strong>${calc.name}</strong> calculator is in <strong>${panel?.icon || ''} ${panel?.name || calc.panel}</strong>.<br><br>Say "calculate ${calc.key}" to run it.`;
    }
  }
  
  // What can you do
  if (lower.includes('what can you do') || lower.includes('help') || lower.includes('capabilities')) {
    return `<strong>ü§ñ WWTP AI Assistant - TIER 1 & 2</strong><br><br>
<strong>üìç Navigation:</strong><br>
‚Ä¢ "Go to process control"<br>
‚Ä¢ "Open chemicals panel"<br><br>
<strong>üßÆ Calculators:</strong><br>
‚Ä¢ "Calculate F/M ratio"<br>
‚Ä¢ "What calculators are available?"<br><br>
<strong>üîß Troubleshooting:</strong><br>
‚Ä¢ "Help with high SVI"<br>
‚Ä¢ "Troubleshoot ammonia"<br>
‚Ä¢ "Diagnose foam problem"<br><br>
<strong>üè≠ Plant Profile:</strong><br>
‚Ä¢ "My plant info"<br>
‚Ä¢ "Set plant name to [name]"<br>
‚Ä¢ "Set flow to 3.5 MGD"<br><br>
<strong>üìã Compliance:</strong><br>
‚Ä¢ "Check compliance status"<br>
‚Ä¢ "Any permit issues?"<br>
‚Ä¢ "When is DMR due?"<br><br>
<strong>üë∑ Shift Handoff:</strong><br>
‚Ä¢ "Generate shift handoff"<br>
‚Ä¢ "Log: [your note]"<br>
‚Ä¢ "Quick status"<br><br>
<em>I know ${Object.keys(AppBrain.panels).length} panels, ${Object.keys(AppBrain.calculators).length}+ calculators, and 5 troubleshooting guides!</em>`;
  }
  
  return null; // Fall through to existing AI handlers
}

// ========== END TIER 1 ==========

// ========== TIER 2: OPERATIONAL INTELLIGENCE ==========

const PlantProfile = {
  // Default profile structure
  defaults: {
    name: 'My Plant',
    type: 'conventional', // conventional, extended, sbr, mbr, mbbr
    designFlow: 5.0, // MGD
    actualFlow: 3.5, // MGD
    basins: 2,
    clarifiers: 2,
    aerationType: 'fine_bubble',
    
    // Design parameters
    designMLSS: 3000,
    designSRT: 10,
    designFM: 0.3,
    designDO: 2.0,
    
    // Current operating parameters
    currentMLSS: 3000,
    currentSRT: 10,
    currentFM: 0.29,
    currentDO: 2.1,
    currentSVI: 120,
    currentpH: 7.2,
    currentTemp: 20,
    
    // Permit limits
    permitBOD: 30,
    permitTSS: 30,
    permitNH3: 5,
    permitPhos: 1,
    permitFecal: 200,
    
    // Chemical systems
    hasChlorination: true,
    hasDechlorination: true,
    hasPhosphorus: false,
    hasNitrification: true,
    
    // Contact info
    operatorName: '',
    operatorPhone: '',
    permitNumber: ''
  },
  
  // Load profile from localStorage
  load() {
    const saved = localStorage.getItem('wwtp_plant_profile');
    if (saved) {
      return { ...this.defaults, ...JSON.parse(saved) };
    }
    return { ...this.defaults };
  },
  
  // Save profile to localStorage
  save(profile) {
    localStorage.setItem('wwtp_plant_profile', JSON.stringify(profile));
    showToast('‚úÖ Plant profile saved', 'success');
  },
  
  // Get current profile
  get() {
    return this.load();
  },
  
  // Update single field
  update(field, value) {
    const profile = this.load();
    profile[field] = value;
    this.save(profile);
    return profile;
  },
  
  // Get profile summary for AI
  getSummary() {
    const p = this.load();
    return `<strong>üè≠ ${p.name}</strong><br>
Type: ${p.type.charAt(0).toUpperCase() + p.type.slice(1)} Activated Sludge<br>
Design Flow: ${p.designFlow} MGD | Actual: ${p.actualFlow} MGD<br>
Basins: ${p.basins} | Clarifiers: ${p.clarifiers}<br>
MLSS: ${p.currentMLSS} mg/L | SRT: ${p.currentSRT} days<br>
F/M: ${p.currentFM} | DO: ${p.currentDO} mg/L<br>
SVI: ${p.currentSVI} mL/g | pH: ${p.currentpH}`;
  },
  
  // Auto-fill calculators with profile data
  autoFill(calcType) {
    const p = this.load();
    const mappings = {
      'fm': { 'fm_mlvss': p.currentMLSS * 0.8, 'fm_vol': p.designFlow * 1.0 },
      'srt': { 'srt_mlss': p.currentMLSS, 'srt_vol': p.designFlow * 1.0 },
      'svi': { 'svi_mlss': p.currentMLSS },
      'loading': { 'load_flow': p.actualFlow },
      'oxygen': { 'o2_flow': p.actualFlow },
      'chlorine': { 'cl_flow': p.actualFlow }
    };
    
    if (mappings[calcType]) {
      for (const [id, value] of Object.entries(mappings[calcType])) {
        const el = document.getElementById(id);
        if (el) el.value = value;
      }
      return true;
    }
    return false;
  }
};

// ===== TROUBLESHOOTING WIZARD =====
const TroubleshootWizard = {
  // Symptom categories
  categories: {
    settling: {
      name: 'üåÄ Settling Problems',
      symptoms: ['Poor settling', 'Bulking sludge', 'Rising sludge', 'Pin floc', 'Straggler floc']
    },
    effluent: {
      name: 'üíß Effluent Quality',
      symptoms: ['High TSS', 'High BOD', 'High ammonia', 'High phosphorus', 'Cloudy effluent']
    },
    foam: {
      name: 'ü´ß Foam & Scum',
      symptoms: ['Brown foam', 'White foam', 'Thick scum', 'Nocardia foam', 'Grease balls']
    },
    odor: {
      name: 'üëÉ Odor Issues',
      symptoms: ['Septic odor', 'Rotten egg smell', 'Musty odor', 'Chemical odor']
    },
    operational: {
      name: '‚öôÔ∏è Operational',
      symptoms: ['Low DO', 'High DO', 'pH swings', 'Temperature issues', 'Flow surges']
    }
  },
  
  // Diagnosis database
  diagnoses: {
    'Poor settling': {
      causes: [
        'Filamentous bacteria overgrowth',
        'Low DO in aeration basin',
        'Nutrient deficiency (N or P)',
        'Low F/M ratio',
        'Industrial discharge impact'
      ],
      tests: [
        'Microscopic examination for filaments',
        'Check DO profile across basin',
        'Test for nitrogen and phosphorus',
        'Calculate current F/M ratio',
        'Review industrial discharge records'
      ],
      solutions: [
        'If filaments: identify type, adjust conditions',
        'Maintain DO > 2.0 mg/L throughout basin',
        'Add nutrients if BOD:N:P not 100:5:1',
        'Increase wasting to raise F/M',
        'Implement source control program'
      ],
      calculators: ['calcSVI', 'calcFM', 'calcWAS']
    },
    'High ammonia': {
      causes: [
        'Insufficient SRT for nitrification',
        'Low DO inhibiting nitrifiers',
        'Low alkalinity',
        'Temperature too cold',
        'Toxic shock to nitrifiers'
      ],
      tests: [
        'Verify SRT > 8 days (>12 in winter)',
        'Check DO > 2.0 mg/L',
        'Test alkalinity (need >100 mg/L as CaCO3)',
        'Monitor temperature trend',
        'Check for industrial discharge'
      ],
      solutions: [
        'Reduce wasting to increase SRT',
        'Increase aeration capacity',
        'Add alkalinity (soda ash, lime)',
        'Consider covering basins in winter',
        'Implement toxic shock protection'
      ],
      calculators: ['calcSRTmain', 'calcAlkalinity', 'calcNitrogen']
    },
    'Brown foam': {
      causes: [
        'Nocardia or Microthrix bacteria',
        'Long SRT / old sludge',
        'Grease and oil accumulation',
        'Low F/M ratio'
      ],
      tests: [
        'Microscopic exam for branching filaments',
        'Calculate current SRT',
        'Check FOG levels in influent',
        'Calculate F/M ratio'
      ],
      solutions: [
        'Increase wasting rate significantly',
        'Target SRT 5-8 days',
        'Improve grease removal',
        'Add selector zone',
        'Spray chlorinated water on foam'
      ],
      calculators: ['calcSRTmain', 'calcFM', 'calcWAS']
    },
    'High TSS': {
      causes: [
        'Clarifier hydraulic overload',
        'Poor floc formation',
        'Denitrification in clarifier',
        'Short-circuiting',
        'Sludge blanket too high'
      ],
      tests: [
        'Check surface overflow rate',
        'Test SVI and settling',
        'Monitor DO in clarifier',
        'Dye test for short-circuiting',
        'Measure sludge blanket depth'
      ],
      solutions: [
        'Reduce flow or add clarifier capacity',
        'Optimize flocculation',
        'Increase RAS rate to prevent denitrification',
        'Repair baffles if damaged',
        'Increase sludge wasting'
      ],
      calculators: ['calcClarifier', 'calcSVI', 'calcRAS']
    },
    'Low DO': {
      causes: [
        'Blower capacity insufficient',
        'Diffuser fouling',
        'High organic loading',
        'Temperature increase',
        'Equipment failure'
      ],
      tests: [
        'Check blower output vs design',
        'Inspect diffusers for fouling',
        'Calculate current organic loading',
        'Monitor temperature trend',
        'Check all blowers operational'
      ],
      solutions: [
        'Add blower capacity',
        'Clean or replace diffusers',
        'Reduce loading if possible',
        'Add supplemental aeration',
        'Repair/replace failed equipment'
      ],
      calculators: ['calcOxygen', 'calcBlower', 'calcLoading']
    }
  },
  
  // Run diagnosis
  diagnose(symptom) {
    const diag = this.diagnoses[symptom];
    if (!diag) return null;
    
    let result = `<strong>üîç Diagnosis: ${symptom}</strong><br><br>`;
    
    result += `<strong>Possible Causes:</strong><br>`;
    diag.causes.forEach((c, i) => result += `${i+1}. ${c}<br>`);
    
    result += `<br><strong>Tests to Perform:</strong><br>`;
    diag.tests.forEach((t, i) => result += `${i+1}. ${t}<br>`);
    
    result += `<br><strong>Solutions:</strong><br>`;
    diag.solutions.forEach((s, i) => result += `${i+1}. ${s}<br>`);
    
    result += `<br><strong>Helpful Calculators:</strong><br>`;
    diag.calculators.forEach(c => {
      const calc = AppBrain.calculators[c.replace('calc', '').toLowerCase()];
      if (calc) result += `‚Ä¢ ${calc.name}<br>`;
    });
    
    return result;
  },
  
  // List all symptoms
  listSymptoms() {
    let list = '<strong>ü©∫ Troubleshooting Wizard</strong><br><br>';
    list += 'Tell me your symptom and I\'ll help diagnose:<br><br>';
    
    for (const [key, cat] of Object.entries(this.categories)) {
      list += `<strong>${cat.name}:</strong><br>`;
      cat.symptoms.forEach(s => list += `‚Ä¢ ${s}<br>`);
      list += '<br>';
    }
    
    return list;
  },
  
  // Find matching symptom
  findSymptom(query) {
    const q = query.toLowerCase();
    for (const symptom of Object.keys(this.diagnoses)) {
      if (q.includes(symptom.toLowerCase())) {
        return symptom;
      }
    }
    // Fuzzy matching
    if (q.includes('settling') || q.includes('bulking')) return 'Poor settling';
    if (q.includes('ammonia') || q.includes('nh3')) return 'High ammonia';
    if (q.includes('foam') || q.includes('nocardia')) return 'Brown foam';
    if (q.includes('tss') || q.includes('solids') || q.includes('turbid')) return 'High TSS';
    if (q.includes('do') && (q.includes('low') || q.includes('oxygen'))) return 'Low DO';
    return null;
  }
};

// ===== COMPLIANCE GUARDIAN =====
const ComplianceGuardian = {
  // Check compliance status
  checkStatus() {
    const profile = PlantProfile.get();
    const results = [];
    
    // Simulated current values (in real app, would come from data entry)
    const current = {
      BOD: 18,
      TSS: 22,
      NH3: 3.5,
      Phos: 0.8,
      Fecal: 45
    };
    
    // Check each parameter
    const params = [
      { name: 'BOD', current: current.BOD, limit: profile.permitBOD, unit: 'mg/L' },
      { name: 'TSS', current: current.TSS, limit: profile.permitTSS, unit: 'mg/L' },
      { name: 'Ammonia', current: current.NH3, limit: profile.permitNH3, unit: 'mg/L' },
      { name: 'Phosphorus', current: current.Phos, limit: profile.permitPhos, unit: 'mg/L' },
      { name: 'Fecal Coliform', current: current.Fecal, limit: profile.permitFecal, unit: 'CFU/100mL' }
    ];
    
    params.forEach(p => {
      const pct = (p.current / p.limit * 100).toFixed(0);
      let status = '‚úÖ';
      let risk = 'Low';
      
      if (pct > 90) { status = '‚ö†Ô∏è'; risk = 'HIGH'; }
      else if (pct > 75) { status = 'üü°'; risk = 'Medium'; }
      
      results.push({
        ...p,
        pct: pct,
        status: status,
        risk: risk
      });
    });
    
    return results;
  },
  
  // Generate compliance report
  getReport() {
    const results = this.checkStatus();
    const profile = PlantProfile.get();
    
    let report = `<strong>üìã Compliance Status Report</strong><br>`;
    report += `<em>${profile.name} | ${new Date().toLocaleDateString()}</em><br><br>`;
    
    results.forEach(r => {
      report += `${r.status} <strong>${r.name}:</strong> ${r.current} / ${r.limit} ${r.unit} (${r.pct}%)`;
      if (r.risk !== 'Low') report += ` <span style="color:${r.risk === 'HIGH' ? '#ef4444' : '#f59e0b'}">[${r.risk} Risk]</span>`;
      report += '<br>';
    });
    
    // Add recommendations
    const highRisk = results.filter(r => r.risk === 'HIGH');
    if (highRisk.length > 0) {
      report += '<br><strong>‚ö†Ô∏è Action Required:</strong><br>';
      highRisk.forEach(r => {
        report += `‚Ä¢ ${r.name} at ${r.pct}% of limit - investigate immediately<br>`;
      });
    }
    
    // DMR reminder
    const today = new Date();
    const daysToEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate() - today.getDate();
    if (daysToEnd <= 10) {
      report += `<br><strong>üìÖ DMR Reminder:</strong> Due in ${daysToEnd} days<br>`;
    }
    
    return report;
  },
  
  // Check for upcoming deadlines
  getDeadlines() {
    const today = new Date();
    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    const daysLeft = endOfMonth.getDate() - today.getDate();
    
    let deadlines = '<strong>üìÖ Upcoming Deadlines</strong><br><br>';
    
    // DMR due 28th
    const dmrDue = new Date(today.getFullYear(), today.getMonth(), 28);
    if (today < dmrDue) {
      const dmrDays = Math.ceil((dmrDue - today) / (1000 * 60 * 60 * 24));
      deadlines += `üìù <strong>DMR Submission:</strong> ${dmrDays} days (${dmrDue.toLocaleDateString()})<br>`;
    }
    
    // Monthly samples
    deadlines += `üß™ <strong>Monthly Samples:</strong> ${daysLeft} days left in month<br>`;
    
    // Quarterly items (if applicable)
    const quarter = Math.floor(today.getMonth() / 3);
    const quarterEnd = new Date(today.getFullYear(), (quarter + 1) * 3, 0);
    const quarterDays = Math.ceil((quarterEnd - today) / (1000 * 60 * 60 * 24));
    if (quarterDays <= 30) {
      deadlines += `üìä <strong>Quarterly Report:</strong> ${quarterDays} days<br>`;
    }
    
    return deadlines;
  }
};

// ===== SHIFT HANDOFF ASSISTANT =====
const ShiftHandoff = {
  // Current shift log
  log: [],
  
  // Add entry to shift log
  addEntry(type, message) {
    this.log.push({
      time: new Date().toLocaleTimeString(),
      type: type, // 'note', 'issue', 'reading', 'action'
      message: message
    });
    localStorage.setItem('wwtp_shift_log', JSON.stringify(this.log));
  },
  
  // Load shift log
  loadLog() {
    const saved = localStorage.getItem('wwtp_shift_log');
    if (saved) {
      this.log = JSON.parse(saved);
    }
    return this.log;
  },
  
  // Clear shift log
  clearLog() {
    this.log = [];
    localStorage.removeItem('wwtp_shift_log');
  },
  
  // Generate shift handoff report
  generateHandoff() {
    const profile = PlantProfile.get();
    const compliance = ComplianceGuardian.checkStatus();
    this.loadLog();
    
    let report = `<strong>üìã SHIFT HANDOFF REPORT</strong><br>`;
    report += `<em>${profile.name} | ${new Date().toLocaleString()}</em><br>`;
    report += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ<br><br>`;
    
    // Current conditions
    report += `<strong>‚öôÔ∏è CURRENT CONDITIONS:</strong><br>`;
    report += `Flow: ${profile.actualFlow} MGD (${((profile.actualFlow/profile.designFlow)*100).toFixed(0)}% of design)<br>`;
    report += `DO: ${profile.currentDO} mg/L | MLSS: ${profile.currentMLSS} mg/L<br>`;
    report += `SVI: ${profile.currentSVI} mL/g | pH: ${profile.currentpH}<br><br>`;
    
    // Compliance status
    report += `<strong>üìä COMPLIANCE STATUS:</strong><br>`;
    compliance.forEach(c => {
      report += `${c.status} ${c.name}: ${c.pct}% of limit<br>`;
    });
    report += '<br>';
    
    // Issues/Alerts
    const issues = compliance.filter(c => c.risk !== 'Low');
    if (issues.length > 0) {
      report += `<strong>‚ö†Ô∏è ACTIVE ISSUES:</strong><br>`;
      issues.forEach(i => {
        report += `‚Ä¢ ${i.name} at ${i.pct}% - monitor closely<br>`;
      });
      report += '<br>';
    }
    
    // Shift log
    if (this.log.length > 0) {
      report += `<strong>üìù SHIFT NOTES:</strong><br>`;
      this.log.forEach(entry => {
        const icon = entry.type === 'issue' ? '‚ö†Ô∏è' : entry.type === 'action' ? '‚úÖ' : 'üìå';
        report += `${icon} ${entry.time}: ${entry.message}<br>`;
      });
      report += '<br>';
    }
    
    // Recommendations for next shift
    report += `<strong>üëâ FOR NEXT SHIFT:</strong><br>`;
    if (issues.length > 0) {
      report += `‚Ä¢ Continue monitoring ${issues.map(i => i.name).join(', ')}<br>`;
    }
    report += `‚Ä¢ Check DO levels at shift start<br>`;
    report += `‚Ä¢ Verify blowers operating normally<br>`;
    
    report += `<br>‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ<br>`;
    report += `<em>Generated by WWTP AI Assistant</em>`;
    
    return report;
  },
  
  // Quick status for handoff
  quickStatus() {
    const profile = PlantProfile.get();
    return `<strong>Quick Status:</strong><br>
Flow: ${profile.actualFlow} MGD | DO: ${profile.currentDO} mg/L<br>
MLSS: ${profile.currentMLSS} mg/L | SVI: ${profile.currentSVI} mL/g<br>
All systems: ‚úÖ Normal`;
  }
};

// ===== TIER 2 AI RESPONSE HANDLER =====
function generateTier2Response(msg) {
  const lower = msg.toLowerCase();
  
  // Plant profile commands
  if (lower.includes('my plant') && (lower.includes('info') || lower.includes('profile') || lower.includes('about'))) {
    return PlantProfile.getSummary();
  }
  
  if (lower.includes('set plant') || lower.includes('plant name is') || lower.includes('my plant is')) {
    // Extract plant name
    const match = msg.match(/(?:plant name is|my plant is|called)\s+["']?([^"'\n]+)["']?/i);
    if (match) {
      PlantProfile.update('name', match[1].trim());
      return `‚úÖ Plant name set to <strong>${match[1].trim()}</strong>`;
    }
    return 'What is your plant name? Say "My plant is [name]"';
  }
  
  if (lower.includes('set flow') || lower.includes('flow is')) {
    const match = msg.match(/(\d+\.?\d*)\s*(?:mgd|million)/i);
    if (match) {
      PlantProfile.update('actualFlow', parseFloat(match[1]));
      return `‚úÖ Current flow set to <strong>${match[1]} MGD</strong>`;
    }
  }
  
  // Troubleshooting
  if (lower.includes('troubleshoot') || lower.includes('diagnose') || lower.includes('symptom')) {
    if (lower.includes('list') || lower.includes('what') || lower.includes('help')) {
      return TroubleshootWizard.listSymptoms();
    }
    const symptom = TroubleshootWizard.findSymptom(lower);
    if (symptom) {
      return TroubleshootWizard.diagnose(symptom);
    }
  }
  
  // Direct symptom mentions
  const symptomKeywords = ['settling', 'bulking', 'ammonia', 'foam', 'tss', 'solids', 'turbid', 'low do', 'odor'];
  for (const kw of symptomKeywords) {
    if (lower.includes(kw) && (lower.includes('problem') || lower.includes('issue') || lower.includes('high') || lower.includes('poor') || lower.includes('bad'))) {
      const symptom = TroubleshootWizard.findSymptom(lower);
      if (symptom) {
        return TroubleshootWizard.diagnose(symptom);
      }
    }
  }
  
  // Compliance
  if (lower.includes('compliance') || lower.includes('permit') || lower.includes('violation') || lower.includes('limit')) {
    if (lower.includes('deadline') || lower.includes('due') || lower.includes('when')) {
      return ComplianceGuardian.getDeadlines();
    }
    return ComplianceGuardian.getReport();
  }
  
  if (lower.includes('dmr')) {
    return ComplianceGuardian.getDeadlines();
  }
  
  // Shift handoff
  if (lower.includes('shift') && (lower.includes('handoff') || lower.includes('report') || lower.includes('end') || lower.includes('summary'))) {
    return ShiftHandoff.generateHandoff();
  }
  
  if (lower.includes('log') && (lower.includes('add') || lower.includes('note'))) {
    const noteMatch = msg.match(/(?:log|note|add)[:\s]+(.+)/i);
    if (noteMatch) {
      ShiftHandoff.addEntry('note', noteMatch[1].trim());
      return `‚úÖ Added to shift log: "${noteMatch[1].trim()}"`;
    }
    return 'What would you like to log? Say "Log: [your note]"';
  }
  
  if (lower.includes('quick status') || lower.includes('current status')) {
    return ShiftHandoff.quickStatus();
  }
  
  // Auto-fill calculators
  if (lower.includes('use my') && lower.includes('data') || lower.includes('auto fill') || lower.includes('use plant')) {
    const calc = AppBrain.findCalculator(lower);
    if (calc) {
      PlantProfile.autoFill(calc.key);
      return `‚úÖ Auto-filled ${calc.name} calculator with your plant data. Check the values and calculate!`;
    }
    return 'Which calculator would you like me to fill with your plant data?';
  }
  
  return null; // Fall through to TIER 1
}

// ========== END TIER 2 ==========

// ========== TIER 3: ADVANCED AI INTELLIGENCE ==========
// Optimization Coach, Predictive Operations, Training Mode

// ===== OPTIMIZATION COACH - ENHANCED v9.9.16 =====
const OptimizationCoach = {
  // Optimization categories with weights and thresholds
  categories: {
    energy: {
      name: '‚ö° Energy Optimization',
      icon: '‚ö°',
      color: '#fbbf24',
      weight: 0.25
    },
    process: {
      name: 'üî¨ Process Efficiency',
      icon: 'üî¨',
      color: '#4ade80',
      weight: 0.30
    },
    chemical: {
      name: 'üß™ Chemical Optimization',
      icon: 'üß™',
      color: '#a78bfa',
      weight: 0.20
    },
    compliance: {
      name: 'üìã Compliance Margin',
      icon: 'üìã',
      color: '#60a5fa',
      weight: 0.15
    },
    cost: {
      name: 'üí∞ Cost Reduction',
      icon: 'üí∞',
      color: '#34d399',
      weight: 0.10
    }
  },

  // Industry benchmarks for comparison
  benchmarks: {
    energy: {
      excellent: 1500,
      good: 1800,
      average: 2200,
      poor: 2800,
      unit: 'kWh/MG',
      name: 'Energy Use'
    },
    svi: {
      excellent: 80,
      good: 100,
      average: 150,
      poor: 200,
      unit: 'mL/g',
      name: 'SVI'
    },
    fm: {
      excellent: { min: 0.25, max: 0.40 },
      good: { min: 0.20, max: 0.50 },
      average: { min: 0.15, max: 0.60 },
      unit: 'lb/lb/d',
      name: 'F/M Ratio'
    },
    srt: {
      excellent: { min: 10, max: 15 },
      good: { min: 8, max: 20 },
      average: { min: 5, max: 25 },
      unit: 'days',
      name: 'SRT'
    },
    effluent_bod: {
      excellent: 10,
      good: 15,
      average: 25,
      poor: 30,
      unit: 'mg/L',
      name: 'Effluent BOD'
    },
    effluent_tss: {
      excellent: 10,
      good: 15,
      average: 25,
      poor: 30,
      unit: 'mg/L',
      name: 'Effluent TSS'
    }
  },

  // Score history storage
  scoreHistory: [],

  // Load score history
  loadScoreHistory() {
    const saved = localStorage.getItem('wwtp_optimization_scores');
    this.scoreHistory = saved ? JSON.parse(saved) : [];
    return this.scoreHistory;
  },

  // Save score to history
  saveScore(score) {
    this.loadScoreHistory();
    this.scoreHistory.push({
      timestamp: new Date().toISOString(),
      score: score,
      data: this.getPlantData()
    });
    // Keep last 90 days
    const cutoff = Date.now() - (90 * 24 * 60 * 60 * 1000);
    this.scoreHistory = this.scoreHistory.filter(h => new Date(h.timestamp).getTime() > cutoff);
    localStorage.setItem('wwtp_optimization_scores', JSON.stringify(this.scoreHistory));
  },

  // Get current plant data from KPIs and inputs
  getPlantData() {
    const getVal = (id) => {
      const el = document.getElementById(id);
      return el ? parseFloat(el.textContent || el.value) || 0 : 0;
    };
    
    return {
      flow: getVal('kpi-flow') || getVal('master_flow') || 3.5,
      do: getVal('kpi-do') || getVal('master_do') || 2.0,
      mlss: getVal('kpi-mlss') || getVal('master_mlss') || 3000,
      fm: getVal('kpi-fm') || 0.35,
      srt: getVal('kpi-srt') || getVal('master_srt') || 10,
      svi: getVal('kpi-svi') || 120,
      ph: getVal('kpi-ph') || 7.2,
      temp: getVal('kpi-temp') || 20,
      bod: getVal('kpi-bod') || 150,
      tss: getVal('kpi-tss') || 160,
      nh3: getVal('kpi-nh3') || 25,
      energy: getVal('kpi-energy') || 1850,
      ras: getVal('kpi-ras') || getVal('master_ras') || 50,
      was: getVal('kpi-was') || getVal('master_was') || 5000
    };
  },

  // Generate optimization recommendations
  generateRecommendations(customData) {
    const data = customData || this.getPlantData();
    const recommendations = [];
    let overallScore = 100;

    // Energy Analysis
    if (data.do > 2.5) {
      const savings = ((data.do - 2.0) / data.do * 15).toFixed(0);
      recommendations.push({
        category: 'energy',
        priority: 'high',
        title: 'Reduce DO Setpoint',
        current: `DO: ${data.do} mg/L`,
        target: 'Target: 2.0 mg/L',
        impact: `Est. ${savings}% blower energy savings`,
        action: 'Lower aeration setpoint gradually by 0.2 mg/L per week while monitoring effluent quality',
        savings: parseInt(savings)
      });
      overallScore -= 8;
    }

    if (data.energy > 2000) {
      recommendations.push({
        category: 'energy',
        priority: 'medium',
        title: 'Energy Consumption High',
        current: `${data.energy} kWh/MG`,
        target: 'Target: <1800 kWh/MG',
        impact: `Potential ${((data.energy - 1800) / data.energy * 100).toFixed(0)}% reduction`,
        action: 'Audit blower efficiency, check diffuser fouling, verify motor efficiency',
        savings: Math.round((data.energy - 1800) * data.flow * 0.10 * 365 / 1000)
      });
      overallScore -= 5;
    }

    // Process Efficiency
    if (data.fm < 0.2) {
      recommendations.push({
        category: 'process',
        priority: 'high',
        title: 'F/M Ratio Too Low',
        current: `F/M: ${data.fm} lb/lb/d`,
        target: 'Target: 0.3-0.5',
        impact: 'Risk of filamentous growth and poor settling',
        action: 'Increase WAS rate to reduce MLSS and raise F/M. Target MLSS reduction of 500 mg/L',
        savings: 0
      });
      overallScore -= 10;
    } else if (data.fm > 0.5) {
      recommendations.push({
        category: 'process',
        priority: 'medium',
        title: 'F/M Ratio High',
        current: `F/M: ${data.fm} lb/lb/d`,
        target: 'Target: 0.3-0.5',
        impact: 'Risk of incomplete treatment and high effluent BOD',
        action: 'Decrease WAS rate to build MLSS and lower F/M',
        savings: 0
      });
      overallScore -= 8;
    }

    if (data.svi > 150) {
      const severity = data.svi > 200 ? 'critical' : 'high';
      recommendations.push({
        category: 'process',
        priority: severity,
        title: 'Poor Sludge Settling',
        current: `SVI: ${data.svi} mL/g`,
        target: 'Target: <100 mL/g',
        impact: 'Clarifier performance affected, potential permit violation',
        action: 'Check for filaments via microscope. Verify DO >2.0 throughout basin. Consider selector installation.',
        savings: 0
      });
      overallScore -= (data.svi > 200 ? 15 : 10);
    }

    if (data.srt < 8) {
      recommendations.push({
        category: 'process',
        priority: 'high',
        title: 'SRT Too Short',
        current: `SRT: ${data.srt} days`,
        target: 'Target: 10-15 days',
        impact: 'Nitrification may be incomplete',
        action: 'Reduce WAS rate immediately. Monitor effluent ammonia daily.',
        savings: 0
      });
      overallScore -= 12;
    } else if (data.srt > 20) {
      recommendations.push({
        category: 'process',
        priority: 'low',
        title: 'SRT Very High',
        current: `SRT: ${data.srt} days`,
        target: 'Target: 10-15 days',
        impact: 'May cause Nocardia foaming and excess oxygen demand',
        action: 'Consider increasing wasting to reduce SRT gradually',
        savings: 0
      });
      overallScore -= 3;
    }

    // Chemical Optimization
    if (data.ph < 6.8) {
      recommendations.push({
        category: 'chemical',
        priority: 'high',
        title: 'Low pH Warning',
        current: `pH: ${data.ph}`,
        target: 'Target: 7.0-7.5',
        impact: 'Nitrification inhibited below pH 6.8',
        action: 'Add alkalinity (soda ash or lime). Check for industrial acid discharge.',
        savings: 0
      });
      overallScore -= 10;
    } else if (data.ph > 8.5) {
      recommendations.push({
        category: 'chemical',
        priority: 'medium',
        title: 'High pH Warning',
        current: `pH: ${data.ph}`,
        target: 'Target: 7.0-7.5',
        impact: 'May cause ammonia toxicity and poor floc formation',
        action: 'Check for caustic overdose or industrial discharge. Reduce alkalinity feed.',
        savings: 0
      });
      overallScore -= 5;
    }

    // Temperature impacts
    if (data.temp < 15) {
      recommendations.push({
        category: 'process',
        priority: 'medium',
        title: 'Low Temperature',
        current: `Temp: ${data.temp}¬∞C`,
        target: 'Optimal: 18-25¬∞C',
        impact: 'Nitrification rate reduced 50%+ below 15¬∞C. Longer SRT needed.',
        action: 'Increase SRT to 15-20 days. Monitor ammonia closely. Consider seasonal adjustments.',
        savings: 0
      });
      overallScore -= 5;
    } else if (data.temp > 30) {
      recommendations.push({
        category: 'process',
        priority: 'medium',
        title: 'High Temperature',
        current: `Temp: ${data.temp}¬∞C`,
        target: 'Optimal: 18-25¬∞C',
        impact: 'Lower DO saturation, potential filament growth, odor issues',
        action: 'Increase aeration. Monitor for Nocardia. Check for hot industrial discharges.',
        savings: 0
      });
      overallScore -= 5;
    }

    // High BOD loading
    if (data.bod > 250) {
      recommendations.push({
        category: 'process',
        priority: 'high',
        title: 'High Influent BOD',
        current: `BOD: ${data.bod} mg/L`,
        target: 'Typical: 150-200 mg/L',
        impact: 'Higher oxygen demand, may overload system',
        action: 'Increase aeration. Verify MLSS adequate for load. Check for industrial discharge.',
        savings: 0
      });
      overallScore -= 8;
    } else if (data.bod < 100) {
      recommendations.push({
        category: 'process',
        priority: 'low',
        title: 'Low Influent BOD',
        current: `BOD: ${data.bod} mg/L`,
        target: 'Typical: 150-200 mg/L',
        impact: 'May indicate I&I dilution or need for carbon source',
        action: 'Check for infiltration. May need supplemental carbon for denitrification.',
        savings: 0
      });
      overallScore -= 2;
    }

    // Compliance Margin Analysis
    const profile = typeof PlantProfile !== 'undefined' ? PlantProfile.get() : { permitBOD: 30, permitTSS: 30, permitNH3: 5 };
    
    const bodMargin = ((profile.permitBOD - (data.bod * 0.15)) / profile.permitBOD * 100).toFixed(0);
    const tssMargin = ((profile.permitTSS - (data.tss * 0.10)) / profile.permitTSS * 100).toFixed(0);
    
    if (parseInt(bodMargin) < 20) {
      recommendations.push({
        category: 'compliance',
        priority: 'high',
        title: 'Low BOD Compliance Margin',
        current: `${bodMargin}% safety margin`,
        target: 'Target: >30% margin',
        impact: 'At risk during upset conditions',
        action: 'Increase process buffer: higher MLSS or longer SRT',
        savings: 0
      });
      overallScore -= 8;
    }

    // Cost optimization
    if (data.mlss > 4000) {
      recommendations.push({
        category: 'cost',
        priority: 'low',
        title: 'Excess Biomass',
        current: `MLSS: ${data.mlss} mg/L`,
        target: 'Optimal: 2500-3500 mg/L',
        impact: 'Higher oxygen demand and disposal costs',
        action: 'Increase wasting to target optimal MLSS range',
        savings: Math.round((data.mlss - 3000) * data.flow * 8.34 * 0.02 / 100)
      });
      overallScore -= 3;
    }

    return {
      recommendations: recommendations.sort((a, b) => {
        const priorityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
        return priorityOrder[a.priority] - priorityOrder[b.priority];
      }),
      overallScore: Math.max(0, Math.min(100, overallScore)),
      timestamp: new Date().toLocaleString(),
      data: data
    };
  },

  // Get benchmark rating for a parameter
  getBenchmarkRating(param, value) {
    const bench = this.benchmarks[param];
    if (!bench) return { rating: 'unknown', color: '#94a3b8' };
    
    if (bench.excellent && typeof bench.excellent === 'object') {
      // Range-based benchmark (like F/M)
      if (value >= bench.excellent.min && value <= bench.excellent.max) return { rating: 'Excellent', color: '#4ade80' };
      if (value >= bench.good.min && value <= bench.good.max) return { rating: 'Good', color: '#22c55e' };
      if (value >= bench.average.min && value <= bench.average.max) return { rating: 'Average', color: '#fbbf24' };
      return { rating: 'Poor', color: '#ef4444' };
    } else {
      // Threshold-based benchmark
      const isLowerBetter = ['energy', 'svi', 'effluent_bod', 'effluent_tss'].includes(param);
      if (isLowerBetter) {
        if (value <= bench.excellent) return { rating: 'Excellent', color: '#4ade80' };
        if (value <= bench.good) return { rating: 'Good', color: '#22c55e' };
        if (value <= bench.average) return { rating: 'Average', color: '#fbbf24' };
        return { rating: 'Poor', color: '#ef4444' };
      } else {
        if (value >= bench.excellent) return { rating: 'Excellent', color: '#4ade80' };
        if (value >= bench.good) return { rating: 'Good', color: '#22c55e' };
        if (value >= bench.average) return { rating: 'Average', color: '#fbbf24' };
        return { rating: 'Poor', color: '#ef4444' };
      }
    }
  },

  // Display optimization dashboard
  showDashboard() {
    const results = this.generateRecommendations();
    this.saveScore(results.overallScore);
    
    const scoreColor = results.overallScore >= 80 ? '#4ade80' : 
                       results.overallScore >= 60 ? '#fbbf24' : '#ef4444';

    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <!-- Header with Score -->
        <div style="background:linear-gradient(135deg,#059669,#10b981);padding:24px;text-align:center">
          <div style="font-size:13px;color:rgba(255,255,255,0.9);margin-bottom:8px">PLANT OPTIMIZATION SCORE</div>
          <div style="font-size:64px;font-weight:800;color:white;text-shadow:0 4px 15px rgba(0,0,0,0.3)">${results.overallScore}</div>
          <div style="display:flex;justify-content:center;gap:4px;margin-top:12px">
            ${[...Array(10)].map((_, i) => `
              <div style="width:24px;height:8px;border-radius:4px;background:${i < results.overallScore/10 ? 'white' : 'rgba(255,255,255,0.3)'}"></div>
            `).join('')}
          </div>
          <div style="margin-top:12px;font-size:12px;opacity:0.9">
            ${results.recommendations.length} optimizations identified
          </div>
        </div>

        <!-- Tab Navigation -->
        <div style="display:flex;border-bottom:1px solid #2d4a6f">
          <button onclick="OptimizationCoach.showTab('recommendations')" id="opt-tab-recommendations" style="flex:1;padding:12px;background:rgba(255,255,255,0.1);border:none;color:white;font-weight:600;cursor:pointer;border-bottom:2px solid #10b981">üìã Recommendations</button>
          <button onclick="OptimizationCoach.showTab('benchmarks')" id="opt-tab-benchmarks" style="flex:1;padding:12px;background:transparent;border:none;color:#94a3b8;font-weight:600;cursor:pointer;border-bottom:2px solid transparent">üìä Benchmarks</button>
          <button onclick="OptimizationCoach.showTab('whatif')" id="opt-tab-whatif" style="flex:1;padding:12px;background:transparent;border:none;color:#94a3b8;font-weight:600;cursor:pointer;border-bottom:2px solid transparent">üîÆ What-If</button>
          <button onclick="OptimizationCoach.showTab('history')" id="opt-tab-history" style="flex:1;padding:12px;background:transparent;border:none;color:#94a3b8;font-weight:600;cursor:pointer;border-bottom:2px solid transparent">üìà History</button>
        </div>

        <!-- Tab Content -->
        <div id="opt-content-recommendations" style="padding:20px;max-height:350px;overflow-y:auto">
          ${results.recommendations.length === 0 ? `
            <div style="text-align:center;padding:40px;color:#94a3b8">
              <div style="font-size:48px;margin-bottom:16px">‚úÖ</div>
              <div style="font-size:16px;font-weight:600">Excellent Operation!</div>
              <div style="font-size:14px;opacity:0.8;margin-top:8px">No optimization opportunities identified</div>
            </div>
          ` : results.recommendations.map((rec, idx) => `
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;margin-bottom:12px;border-left:4px solid ${this.categories[rec.category].color}">
              <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
                <div>
                  <span style="background:${rec.priority === 'critical' ? '#ef4444' : rec.priority === 'high' ? '#f97316' : rec.priority === 'medium' ? '#fbbf24' : '#94a3b8'};color:${rec.priority === 'low' ? '#1f2937' : 'white'};font-size:10px;padding:3px 8px;border-radius:10px;font-weight:600;text-transform:uppercase">${rec.priority}</span>
                  <span style="margin-left:8px;font-size:12px;color:${this.categories[rec.category].color}">${this.categories[rec.category].icon} ${this.categories[rec.category].name}</span>
                </div>
              </div>
              <h4 style="color:white;margin:0 0 10px 0;font-size:15px">${rec.title}</h4>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;margin-bottom:10px">
                <div style="background:rgba(239,68,68,0.2);padding:8px 10px;border-radius:6px;color:#fca5a5">
                  <div style="font-size:10px;opacity:0.8;margin-bottom:2px">CURRENT</div>
                  ${rec.current}
                </div>
                <div style="background:rgba(74,222,128,0.2);padding:8px 10px;border-radius:6px;color:#86efac">
                  <div style="font-size:10px;opacity:0.8;margin-bottom:2px">TARGET</div>
                  ${rec.target}
                </div>
              </div>
              <div style="color:#94a3b8;font-size:13px;margin-bottom:8px">
                <strong style="color:#60a5fa">Impact:</strong> ${rec.impact}
              </div>
              <div style="background:rgba(96,165,250,0.1);padding:10px;border-radius:8px;font-size:13px;color:#93c5fd">
                <strong>üí° Action:</strong> ${rec.action}
              </div>
              ${rec.savings > 0 ? `
                <div style="margin-top:10px;color:#4ade80;font-size:13px;font-weight:600">
                  üí∞ Potential savings: $${rec.savings.toLocaleString()}/year
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>

        <!-- Benchmarks Tab (hidden initially) -->
        <div id="opt-content-benchmarks" style="display:none;padding:20px;max-height:350px;overflow-y:auto">
          ${this.renderBenchmarks(results.data)}
        </div>

        <!-- What-If Tab (hidden initially) -->
        <div id="opt-content-whatif" style="display:none;padding:20px;max-height:350px;overflow-y:auto">
          ${this.renderWhatIf(results.data)}
        </div>

        <!-- History Tab (hidden initially) -->
        <div id="opt-content-history" style="display:none;padding:20px;max-height:350px;overflow-y:auto">
          ${this.renderHistory()}
        </div>

        <!-- Footer Actions -->
        <div style="padding:16px 20px;border-top:1px solid #2d4a6f;display:flex;gap:10px;flex-wrap:wrap">
          <button onclick="OptimizationCoach.exportReport()" class="btn" style="flex:1;background:linear-gradient(135deg,#4ade80,#22c55e);color:#052e16;font-weight:600">
            üìä Export Report
          </button>
          <button onclick="OptimizationCoach.scheduleReview()" class="btn" style="flex:1;background:#374151;color:white">
            üìÖ Schedule Review
          </button>
        </div>
      </div>
    `;

    showModal('üéØ Optimization Coach', html, { width: '600px' });
    showToast('üéØ Optimization analysis complete', 'success');
    return results;
  },

  // Tab switching
  showTab(tabName) {
    const tabs = ['recommendations', 'benchmarks', 'whatif', 'history'];
    tabs.forEach(tab => {
      const tabBtn = document.getElementById(`opt-tab-${tab}`);
      const content = document.getElementById(`opt-content-${tab}`);
      if (tabBtn && content) {
        if (tab === tabName) {
          tabBtn.style.background = 'rgba(255,255,255,0.1)';
          tabBtn.style.color = 'white';
          tabBtn.style.borderBottom = '2px solid #10b981';
          content.style.display = 'block';
        } else {
          tabBtn.style.background = 'transparent';
          tabBtn.style.color = '#94a3b8';
          tabBtn.style.borderBottom = '2px solid transparent';
          content.style.display = 'none';
        }
      }
    });
  },

  // Render benchmarks comparison
  renderBenchmarks(data) {
    const benchmarkItems = [
      { key: 'energy', value: data.energy, label: 'Energy Use' },
      { key: 'svi', value: data.svi, label: 'SVI' },
      { key: 'fm', value: data.fm, label: 'F/M Ratio' },
      { key: 'srt', value: data.srt, label: 'SRT' }
    ];

    return `
      <div style="margin-bottom:20px">
        <h4 style="color:white;margin:0 0 16px 0;font-size:15px">üìä Industry Benchmark Comparison</h4>
        <p style="color:#94a3b8;font-size:13px;margin-bottom:20px">Compare your plant performance against industry standards</p>
        
        ${benchmarkItems.map(item => {
          const bench = this.benchmarks[item.key];
          const rating = this.getBenchmarkRating(item.key, item.value);
          return `
            <div style="background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;margin-bottom:12px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <span style="color:white;font-weight:600">${item.label}</span>
                <span style="background:${rating.color};color:${rating.rating === 'Average' || rating.rating === 'Poor' ? '#1f2937' : 'white'};padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600">${rating.rating}</span>
              </div>
              <div style="display:flex;align-items:center;gap:12px">
                <div style="flex:1">
                  <div style="height:8px;background:#374151;border-radius:4px;overflow:hidden;position:relative">
                    ${typeof bench.excellent === 'object' ? `
                      <div style="position:absolute;left:${bench.excellent.min/bench.average.max*100}%;width:${(bench.excellent.max-bench.excellent.min)/bench.average.max*100}%;height:100%;background:#4ade80;opacity:0.3"></div>
                    ` : `
                      <div style="position:absolute;left:0;width:${bench.excellent/(bench.poor||bench.average)*100}%;height:100%;background:#4ade80;opacity:0.3"></div>
                    `}
                    <div style="position:absolute;left:${typeof bench.excellent === 'object' ? (item.value/bench.average.max*100) : (item.value/(bench.poor||bench.average)*100)}%;width:4px;height:100%;background:${rating.color};border-radius:2px;transform:translateX(-50%)"></div>
                  </div>
                </div>
                <div style="min-width:80px;text-align:right">
                  <span style="color:white;font-weight:700">${item.value}</span>
                  <span style="color:#94a3b8;font-size:12px;margin-left:4px">${bench.unit}</span>
                </div>
              </div>
              <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:#94a3b8">
                <span>Excellent: ${typeof bench.excellent === 'object' ? `${bench.excellent.min}-${bench.excellent.max}` : `<${bench.excellent}`}</span>
                <span>Good: ${typeof bench.good === 'object' ? `${bench.good.min}-${bench.good.max}` : `<${bench.good}`}</span>
                <span>Average: ${typeof bench.average === 'object' ? `${bench.average.min}-${bench.average.max}` : `<${bench.average}`}</span>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  },

  // Render What-If scenario tool
  renderWhatIf(currentData) {
    return `
      <div>
        <h4 style="color:white;margin:0 0 8px 0;font-size:15px">üîÆ What-If Scenario Analysis</h4>
        <p style="color:#94a3b8;font-size:13px;margin-bottom:20px">Adjust parameters to see how changes affect your optimization score</p>
        
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:20px">
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">DO (mg/L)</label>
            <input type="number" id="whatif-do" value="${currentData.do}" step="0.1" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">MLSS (mg/L)</label>
            <input type="number" id="whatif-mlss" value="${currentData.mlss}" step="100" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">F/M Ratio</label>
            <input type="number" id="whatif-fm" value="${currentData.fm}" step="0.05" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">SRT (days)</label>
            <input type="number" id="whatif-srt" value="${currentData.srt}" step="1" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">SVI (mL/g)</label>
            <input type="number" id="whatif-svi" value="${currentData.svi}" step="10" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Energy (kWh/MG)</label>
            <input type="number" id="whatif-energy" value="${currentData.energy}" step="50" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">RAS Rate (%)</label>
            <input type="number" id="whatif-ras" value="${currentData.ras}" step="5" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">WAS (gpd)</label>
            <input type="number" id="whatif-was" value="${currentData.was}" step="500" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">pH</label>
            <input type="number" id="whatif-ph" value="${currentData.ph}" step="0.1" min="5" max="9" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Temp (¬∞C)</label>
            <input type="number" id="whatif-temp" value="${currentData.temp}" step="1" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Inf BOD (mg/L)</label>
            <input type="number" id="whatif-bod" value="${currentData.bod}" step="10" style="width:100%;padding:8px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px" onchange="OptimizationCoach.runWhatIf()">
          </div>
        </div>

        <div id="whatif-result" style="background:rgba(16,185,129,0.1);border:1px solid #10b981;border-radius:12px;padding:20px;text-align:center">
          <div style="font-size:12px;color:#94a3b8;margin-bottom:8px">PROJECTED SCORE</div>
          <div style="font-size:48px;font-weight:800;color:#4ade80" id="whatif-score">${this.generateRecommendations(currentData).overallScore}</div>
          <div style="font-size:13px;color:#94a3b8;margin-top:8px" id="whatif-change">No change from current</div>
        </div>

        <!-- Why Explanation Section -->
        <div id="whatif-explanation" style="margin-top:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:12px;border:1px solid #374151">
          <div style="font-size:13px;font-weight:600;color:white;margin-bottom:12px">üìã Why This Score?</div>
          <div id="whatif-issues" style="font-size:13px;color:#94a3b8">
            Adjust parameters above to see projected issues and improvements.
          </div>
        </div>

        <!-- RAS/WAS Impact Info -->
        <div id="whatif-ras-was-info" style="margin-top:12px;padding:12px;background:rgba(96,165,250,0.1);border-radius:8px;font-size:13px;color:#93c5fd">
          <strong>üí° RAS/WAS Effects:</strong><br>
          <span style="color:#94a3b8">‚Ä¢ ‚Üë RAS = Lower sludge blanket, faster solids return</span><br>
          <span style="color:#94a3b8">‚Ä¢ ‚Üë WAS = Lower MLSS, shorter SRT, higher F/M</span>
        </div>

        <button onclick="OptimizationCoach.resetWhatIf()" style="width:100%;margin-top:16px;padding:12px;background:#374151;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600">üîÑ Reset to Current Values</button>
      </div>
    `;
  },

  // Run What-If calculation
  runWhatIf() {
    const currentData = this.getPlantData();
    const wasInput = parseFloat(document.getElementById('whatif-was')?.value) || currentData.was;
    const rasInput = parseFloat(document.getElementById('whatif-ras')?.value) || currentData.ras;
    
    // Calculate derived effects from RAS/WAS changes
    const wasRatio = wasInput / (currentData.was || 5000);
    const rasRatio = rasInput / (currentData.ras || 50);
    
    // WAS affects MLSS and SRT inversely
    let adjustedMlss = parseFloat(document.getElementById('whatif-mlss')?.value) || currentData.mlss;
    let adjustedSrt = parseFloat(document.getElementById('whatif-srt')?.value) || currentData.srt;
    let adjustedFm = parseFloat(document.getElementById('whatif-fm')?.value) || currentData.fm;
    
    // If WAS changed from current, estimate effect on MLSS/SRT
    if (Math.abs(wasRatio - 1) > 0.05) {
      // Higher WAS = lower MLSS, lower SRT, higher F/M
      const mlssEffect = 1 / Math.sqrt(wasRatio); // Inverse relationship
      adjustedMlss = Math.round(currentData.mlss * mlssEffect);
      adjustedSrt = Math.round(currentData.srt / wasRatio * 10) / 10;
      adjustedFm = Math.round(currentData.fm * wasRatio * 100) / 100;
    }
    
    const whatIfData = {
      ...currentData,
      do: parseFloat(document.getElementById('whatif-do')?.value) || currentData.do,
      mlss: adjustedMlss,
      fm: adjustedFm,
      srt: adjustedSrt,
      svi: parseFloat(document.getElementById('whatif-svi')?.value) || currentData.svi,
      energy: parseFloat(document.getElementById('whatif-energy')?.value) || currentData.energy,
      ras: rasInput,
      was: wasInput,
      ph: parseFloat(document.getElementById('whatif-ph')?.value) || currentData.ph,
      temp: parseFloat(document.getElementById('whatif-temp')?.value) || currentData.temp,
      bod: parseFloat(document.getElementById('whatif-bod')?.value) || currentData.bod
    };

    const currentResults = this.generateRecommendations(currentData);
    const whatIfResults = this.generateRecommendations(whatIfData);
    const currentScore = currentResults.overallScore;
    const whatIfScore = whatIfResults.overallScore;
    const diff = whatIfScore - currentScore;

    const scoreEl = document.getElementById('whatif-score');
    const changeEl = document.getElementById('whatif-change');
    const resultEl = document.getElementById('whatif-result');
    const infoEl = document.getElementById('whatif-ras-was-info');
    const explainEl = document.getElementById('whatif-issues');

    if (scoreEl) {
      scoreEl.textContent = whatIfScore;
      scoreEl.style.color = whatIfScore >= 80 ? '#4ade80' : whatIfScore >= 60 ? '#fbbf24' : '#ef4444';
    }
    if (changeEl) {
      if (diff > 0) {
        changeEl.innerHTML = `<span style="color:#4ade80">‚Üë +${diff} points improvement</span>`;
      } else if (diff < 0) {
        changeEl.innerHTML = `<span style="color:#ef4444">‚Üì ${diff} points decrease</span>`;
      } else {
        changeEl.textContent = 'No change from current';
      }
    }
    if (resultEl) {
      resultEl.style.borderColor = diff > 0 ? '#4ade80' : diff < 0 ? '#ef4444' : '#10b981';
      resultEl.style.background = diff > 0 ? 'rgba(74,222,128,0.1)' : diff < 0 ? 'rgba(239,68,68,0.1)' : 'rgba(16,185,129,0.1)';
    }
    
    // Build explanation of why score changed
    if (explainEl) {
      const currentIssues = currentResults.recommendations.map(r => r.title);
      const whatIfIssues = whatIfResults.recommendations.map(r => r.title);
      
      // Find resolved issues (were in current, not in whatif)
      const resolved = currentIssues.filter(i => !whatIfIssues.includes(i));
      // Find new issues (in whatif, not in current)
      const newIssues = whatIfIssues.filter(i => !currentIssues.includes(i));
      // Remaining issues
      const remaining = whatIfIssues.filter(i => currentIssues.includes(i));
      
      let explainHtml = '';
      
      if (resolved.length > 0) {
        explainHtml += `<div style="margin-bottom:10px">
          <span style="color:#4ade80;font-weight:600">‚úÖ Issues Resolved:</span>
          ${resolved.map(r => `<div style="margin-left:16px;color:#86efac">‚Ä¢ ${r}</div>`).join('')}
        </div>`;
      }
      
      if (newIssues.length > 0) {
        explainHtml += `<div style="margin-bottom:10px">
          <span style="color:#ef4444;font-weight:600">‚ö†Ô∏è New Issues Created:</span>
          ${newIssues.map(r => `<div style="margin-left:16px;color:#fca5a5">‚Ä¢ ${r}</div>`).join('')}
        </div>`;
      }
      
      if (remaining.length > 0) {
        explainHtml += `<div style="margin-bottom:10px">
          <span style="color:#fbbf24;font-weight:600">‚è≥ Remaining Issues:</span>
          ${remaining.map(r => `<div style="margin-left:16px;color:#fcd34d">‚Ä¢ ${r}</div>`).join('')}
        </div>`;
      }
      
      if (whatIfIssues.length === 0) {
        explainHtml = `<div style="color:#4ade80;text-align:center;padding:10px">
          <span style="font-size:24px">‚úÖ</span><br>
          <strong>Excellent!</strong> No optimization issues with these settings.
        </div>`;
      }
      
      if (resolved.length === 0 && newIssues.length === 0 && diff === 0) {
        explainHtml = `<div style="color:#94a3b8;text-align:center;padding:10px">
          Adjust parameters above to see how changes affect your plant optimization score.
        </div>`;
      }
      
      explainEl.innerHTML = explainHtml;
    }
    
    // Update RAS/WAS impact info
    if (infoEl && Math.abs(wasRatio - 1) > 0.05) {
      infoEl.innerHTML = `
        <strong>üìä Projected WAS Impact:</strong><br>
        <span style="color:#fbbf24">‚Ä¢ MLSS: ${currentData.mlss} ‚Üí ${adjustedMlss} mg/L</span><br>
        <span style="color:#fbbf24">‚Ä¢ SRT: ${currentData.srt} ‚Üí ${adjustedSrt} days</span><br>
        <span style="color:#fbbf24">‚Ä¢ F/M: ${currentData.fm} ‚Üí ${adjustedFm} lb/lb/d</span>
      `;
    } else if (infoEl) {
      infoEl.innerHTML = `
        <strong>üí° RAS/WAS Effects:</strong><br>
        <span style="color:#94a3b8">‚Ä¢ ‚Üë RAS = Lower sludge blanket, faster solids return</span><br>
        <span style="color:#94a3b8">‚Ä¢ ‚Üë WAS = Lower MLSS, shorter SRT, higher F/M</span>
      `;
    }
  },

  // Reset What-If to current values
  resetWhatIf() {
    const currentData = this.getPlantData();
    document.getElementById('whatif-do').value = currentData.do;
    document.getElementById('whatif-mlss').value = currentData.mlss;
    document.getElementById('whatif-fm').value = currentData.fm;
    document.getElementById('whatif-srt').value = currentData.srt;
    document.getElementById('whatif-svi').value = currentData.svi;
    document.getElementById('whatif-energy').value = currentData.energy;
    document.getElementById('whatif-ras').value = currentData.ras;
    document.getElementById('whatif-was').value = currentData.was;
    document.getElementById('whatif-ph').value = currentData.ph;
    document.getElementById('whatif-temp').value = currentData.temp;
    document.getElementById('whatif-bod').value = currentData.bod;
    this.runWhatIf();
  },

  // Render score history
  renderHistory() {
    this.loadScoreHistory();
    
    if (this.scoreHistory.length === 0) {
      return `
        <div style="text-align:center;padding:40px;color:#94a3b8">
          <div style="font-size:48px;margin-bottom:16px">üìà</div>
          <div style="font-size:16px;font-weight:600">No History Yet</div>
          <div style="font-size:14px;opacity:0.8;margin-top:8px">Score history will appear here as you use the Optimization Coach</div>
        </div>
      `;
    }

    const recentScores = this.scoreHistory.slice(-10).reverse();
    const avgScore = Math.round(this.scoreHistory.reduce((a, b) => a + b.score, 0) / this.scoreHistory.length);
    const trend = this.scoreHistory.length > 1 ? 
      (this.scoreHistory[this.scoreHistory.length - 1].score - this.scoreHistory[0].score) : 0;

    return `
      <div>
        <h4 style="color:white;margin:0 0 16px 0;font-size:15px">üìà Score History</h4>
        
        <!-- Summary Stats -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
          <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;text-align:center">
            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">CURRENT</div>
            <div style="font-size:24px;font-weight:700;color:white">${recentScores[0]?.score || '-'}</div>
          </div>
          <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;text-align:center">
            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">AVERAGE</div>
            <div style="font-size:24px;font-weight:700;color:#60a5fa">${avgScore}</div>
          </div>
          <div style="background:rgba(255,255,255,0.05);padding:16px;border-radius:12px;text-align:center">
            <div style="font-size:11px;color:#94a3b8;margin-bottom:4px">TREND</div>
            <div style="font-size:24px;font-weight:700;color:${trend >= 0 ? '#4ade80' : '#ef4444'}">${trend >= 0 ? '+' : ''}${trend}</div>
          </div>
        </div>

        <!-- Visual History Bar -->
        <div style="display:flex;align-items:end;gap:4px;height:100px;margin-bottom:20px;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px">
          ${recentScores.reverse().map((entry, i) => `
            <div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:4px">
              <div style="width:100%;height:${entry.score}px;max-height:80px;background:${entry.score >= 80 ? '#4ade80' : entry.score >= 60 ? '#fbbf24' : '#ef4444'};border-radius:4px 4px 0 0;transition:height 0.3s"></div>
              <div style="font-size:10px;color:#94a3b8">${new Date(entry.timestamp).toLocaleDateString().slice(0,5)}</div>
            </div>
          `).join('')}
        </div>

        <!-- Recent Entries List -->
        <div style="font-size:13px">
          ${recentScores.reverse().slice(0, 5).map(entry => `
            <div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #2d4a6f">
              <span style="color:#94a3b8">${new Date(entry.timestamp).toLocaleString()}</span>
              <span style="font-weight:600;color:${entry.score >= 80 ? '#4ade80' : entry.score >= 60 ? '#fbbf24' : '#ef4444'}">${entry.score}</span>
            </div>
          `).join('')}
        </div>

        <button onclick="OptimizationCoach.clearHistory()" style="width:100%;margin-top:16px;padding:10px;background:rgba(239,68,68,0.2);color:#fca5a5;border:1px solid #ef4444;border-radius:8px;cursor:pointer;font-size:13px">üóëÔ∏è Clear History</button>
      </div>
    `;
  },

  // Clear score history
  clearHistory() {
    if (confirm('Clear all optimization score history?')) {
      localStorage.removeItem('wwtp_optimization_scores');
      this.scoreHistory = [];
      showToast('üóëÔ∏è History cleared', 'info');
      this.showDashboard();
    }
  },

  // Export report
  exportReport() {
    const results = this.generateRecommendations();
    let text = 'WWTP OPTIMIZATION REPORT\n';
    text += '========================\n';
    text += `Generated: ${results.timestamp}\n`;
    text += `Overall Score: ${results.overallScore}/100\n\n`;

    text += 'CURRENT PARAMETERS\n';
    text += '------------------\n';
    const data = results.data;
    text += `Flow: ${data.flow} MGD\n`;
    text += `DO: ${data.do} mg/L\n`;
    text += `MLSS: ${data.mlss} mg/L\n`;
    text += `F/M: ${data.fm} lb/lb/d\n`;
    text += `SRT: ${data.srt} days\n`;
    text += `SVI: ${data.svi} mL/g\n`;
    text += `Energy: ${data.energy} kWh/MG\n\n`;

    text += 'RECOMMENDATIONS\n';
    text += '---------------\n';
    results.recommendations.forEach((rec, i) => {
      text += `${i+1}. [${rec.priority.toUpperCase()}] ${rec.title}\n`;
      text += `   ${rec.current} ‚Üí ${rec.target}\n`;
      text += `   Action: ${rec.action}\n`;
      if (rec.savings > 0) text += `   Est. Savings: $${rec.savings}/year\n`;
      text += '\n';
    });

    text += 'BENCHMARK COMPARISON\n';
    text += '--------------------\n';
    ['energy', 'svi', 'fm', 'srt'].forEach(key => {
      const val = data[key];
      const rating = this.getBenchmarkRating(key, val);
      text += `${this.benchmarks[key].name}: ${val} ${this.benchmarks[key].unit} - ${rating.rating}\n`;
    });

    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `WWTP-Optimization-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('üìä Report exported', 'success');
  },

  // Schedule review reminder
  scheduleReview() {
    const nextReview = new Date();
    nextReview.setDate(nextReview.getDate() + 7);
    localStorage.setItem('wwtp_next_optimization_review', nextReview.toISOString());
    showToast(`üìÖ Review scheduled for ${nextReview.toLocaleDateString()}`, 'success');
  }
};

// ===== KPI SPARKLINES SYSTEM =====
const KPISparklines = {
  storageKey: 'wwtp_kpi_history',
  maxDays: 7,
  
  // KPI definitions
  kpis: {
    flow: { name: 'Flow Rate', unit: 'MGD', color: '#3b82f6', min: 0, max: 10 },
    do: { name: 'DO Level', unit: 'mg/L', color: '#22c55e', min: 0, max: 5 },
    mlss: { name: 'MLSS', unit: 'mg/L', color: '#f59e0b', min: 1000, max: 5000 },
    fm: { name: 'F/M Ratio', unit: 'lb/lb/d', color: '#ec4899', min: 0, max: 1 },
    energy: { name: 'Energy Use', unit: 'kWh/MG', color: '#8b5cf6', min: 1000, max: 3000 },
    cost: { name: 'Daily Cost', unit: '$/day', color: '#14b8a6', min: 2000, max: 8000 }
  },

  // Get history from storage
  getHistory() {
    const saved = localStorage.getItem(this.storageKey);
    return saved ? JSON.parse(saved) : {};
  },

  // Save current KPI values to history
  recordCurrentValues() {
    const history = this.getHistory();
    const today = new Date().toISOString().split('T')[0];
    
    // Get current values from DOM
    const values = {
      flow: parseFloat(document.getElementById('kpi-flow')?.textContent) || 0,
      do: parseFloat(document.getElementById('kpi-do')?.textContent) || 0,
      mlss: parseFloat(document.getElementById('kpi-mlss')?.textContent) || 0,
      fm: parseFloat(document.getElementById('kpi-fm')?.textContent) || 0,
      energy: parseFloat(document.getElementById('kpi-energy')?.textContent) || 0,
      cost: parseFloat(document.getElementById('kpi-cost')?.textContent?.replace(/[$,]/g, '')) || 0
    };

    // Store with timestamp
    history[today] = { ...values, timestamp: Date.now() };

    // Keep only last 7 days
    const cutoff = Date.now() - (this.maxDays * 24 * 60 * 60 * 1000);
    Object.keys(history).forEach(date => {
      if (history[date].timestamp < cutoff) delete history[date];
    });

    localStorage.setItem(this.storageKey, JSON.stringify(history));
    this.updateAllSparklines();
  },

  // Get data points for a KPI (last 7 days)
  getDataPoints(kpiKey) {
    const history = this.getHistory();
    const dates = Object.keys(history).sort();
    const points = dates.map(date => history[date][kpiKey] || 0);
    
    // If less than 7 points, generate some demo data
    if (points.length < 3) {
      const currentVal = parseFloat(document.getElementById('kpi-' + kpiKey)?.textContent?.replace(/[$,]/g, '')) || this.kpis[kpiKey].min;
      const variance = (this.kpis[kpiKey].max - this.kpis[kpiKey].min) * 0.1;
      return Array(7).fill(0).map((_, i) => 
        currentVal + (Math.random() - 0.5) * variance * (1 - i/10)
      );
    }
    
    return points.slice(-7);
  },

  // Generate SVG sparkline
  generateSparkline(kpiKey) {
    const kpi = this.kpis[kpiKey];
    const data = this.getDataPoints(kpiKey);
    if (data.length < 2) return '';

    const width = 100;
    const height = 28;
    const padding = 2;
    
    const min = Math.min(...data) * 0.95;
    const max = Math.max(...data) * 1.05;
    const range = max - min || 1;
    
    // Generate points
    const points = data.map((val, i) => {
      const x = padding + (i / (data.length - 1)) * (width - padding * 2);
      const y = height - padding - ((val - min) / range) * (height - padding * 2);
      return `${x},${y}`;
    }).join(' ');

    // Determine trend color
    const trend = data[data.length - 1] - data[0];
    const trendColor = trend > 0 ? '#4ade80' : trend < 0 ? '#f87171' : '#94a3b8';
    
    // Create gradient
    const gradientId = `gradient-${kpiKey}`;
    
    return `
      <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="none">
        <defs>
          <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:${kpi.color};stop-opacity:0.3"/>
            <stop offset="100%" style="stop-color:${kpi.color};stop-opacity:0"/>
          </linearGradient>
        </defs>
        <polygon points="${padding},${height - padding} ${points} ${width - padding},${height - padding}" fill="url(#${gradientId})"/>
        <polyline points="${points}" fill="none" stroke="${kpi.color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="${width - padding}" cy="${height - padding - ((data[data.length-1] - min) / range) * (height - padding * 2)}" r="3" fill="${kpi.color}"/>
      </svg>
    `;
  },

  // Update all sparklines
  updateAllSparklines() {
    Object.keys(this.kpis).forEach(kpiKey => {
      const container = document.getElementById('spark-' + kpiKey);
      if (container) {
        container.innerHTML = this.generateSparkline(kpiKey);
      }
      this.updateTrend(kpiKey);
    });
  },

  // Update trend indicator
  updateTrend(kpiKey) {
    const data = this.getDataPoints(kpiKey);
    if (data.length < 2) return;

    const trendEl = document.getElementById('trend-' + kpiKey);
    if (!trendEl) return;

    const first = data[0];
    const last = data[data.length - 1];
    const change = first !== 0 ? ((last - first) / first * 100).toFixed(1) : 0;

    if (Math.abs(change) < 1) {
      trendEl.className = 'trend stable';
      trendEl.textContent = '‚Üí Stable';
    } else if (change > 0) {
      trendEl.className = 'trend up';
      trendEl.textContent = `‚Üë ${change}%`;
    } else {
      trendEl.className = 'trend down';
      trendEl.textContent = `‚Üì ${Math.abs(change)}%`;
    }
  },

  // Show detailed view for a KPI
  showDetail(kpiKey) {
    const kpi = this.kpis[kpiKey];
    const data = this.getDataPoints(kpiKey);
    const history = this.getHistory();
    const dates = Object.keys(history).sort().slice(-7);

    const currentVal = parseFloat(document.getElementById('kpi-' + kpiKey)?.textContent?.replace(/[$,]/g, '')) || 0;
    const avg = data.reduce((a, b) => a + b, 0) / data.length;
    const min = Math.min(...data);
    const max = Math.max(...data);

    const html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;padding:20px">
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px">${kpi.name}</div>
          <div style="font-size:42px;font-weight:800;color:${kpi.color};margin:8px 0">${kpiKey === 'cost' ? '$' : ''}${currentVal.toLocaleString()}</div>
          <div style="font-size:13px;color:#64748b">${kpi.unit}</div>
        </div>

        <!-- Large sparkline -->
        <div style="height:80px;margin:20px 0;background:rgba(255,255,255,0.02);border-radius:8px;padding:10px">
          ${this.generateLargeSparkline(kpiKey)}
        </div>

        <!-- Stats -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px">
          <div style="background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;text-align:center">
            <div style="font-size:10px;color:#94a3b8;margin-bottom:4px">7-DAY AVG</div>
            <div style="font-size:18px;font-weight:700;color:white">${avg.toFixed(kpiKey === 'fm' ? 2 : 0)}</div>
          </div>
          <div style="background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;text-align:center">
            <div style="font-size:10px;color:#94a3b8;margin-bottom:4px">MIN</div>
            <div style="font-size:18px;font-weight:700;color:#60a5fa">${min.toFixed(kpiKey === 'fm' ? 2 : 0)}</div>
          </div>
          <div style="background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;text-align:center">
            <div style="font-size:10px;color:#94a3b8;margin-bottom:4px">MAX</div>
            <div style="font-size:18px;font-weight:700;color:#f59e0b">${max.toFixed(kpiKey === 'fm' ? 2 : 0)}</div>
          </div>
        </div>

        <!-- History table -->
        <div style="font-size:12px;color:#94a3b8">
          <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #2d4a6f;font-weight:600;color:white">
            <span>Date</span>
            <span>Value</span>
          </div>
          ${data.map((val, i) => `
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #1e3a5f">
              <span>${dates[i] || 'Day ' + (i + 1)}</span>
              <span style="color:${kpi.color};font-weight:600">${kpiKey === 'cost' ? '$' : ''}${val.toFixed(kpiKey === 'fm' ? 2 : 0)}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;

    showModal(`üìä ${kpi.name} Trend`, html, { width: '380px' });
  },

  // Generate larger sparkline for detail view
  generateLargeSparkline(kpiKey) {
    const kpi = this.kpis[kpiKey];
    const data = this.getDataPoints(kpiKey);
    if (data.length < 2) return '<div style="text-align:center;color:#64748b">No data</div>';

    const width = 300;
    const height = 60;
    const padding = 5;
    
    const min = Math.min(...data) * 0.95;
    const max = Math.max(...data) * 1.05;
    const range = max - min || 1;
    
    const points = data.map((val, i) => {
      const x = padding + (i / (data.length - 1)) * (width - padding * 2);
      const y = height - padding - ((val - min) / range) * (height - padding * 2);
      return `${x},${y}`;
    }).join(' ');

    const gradientId = `gradient-large-${kpiKey}`;
    
    return `
      <svg viewBox="0 0 ${width} ${height}" style="width:100%;height:100%">
        <defs>
          <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:${kpi.color};stop-opacity:0.4"/>
            <stop offset="100%" style="stop-color:${kpi.color};stop-opacity:0"/>
          </linearGradient>
        </defs>
        <polygon points="${padding},${height - padding} ${points} ${width - padding},${height - padding}" fill="url(#${gradientId})"/>
        <polyline points="${points}" fill="none" stroke="${kpi.color}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        ${data.map((val, i) => {
          const x = padding + (i / (data.length - 1)) * (width - padding * 2);
          const y = height - padding - ((val - min) / range) * (height - padding * 2);
          return `<circle cx="${x}" cy="${y}" r="4" fill="${kpi.color}" stroke="#0d1b2a" stroke-width="2"/>`;
        }).join('')}
      </svg>
    `;
  },

  // Initialize
  init() {
    this.updateAllSparklines();
    // Record values on init
    this.recordCurrentValues();
    // Update sparklines every 5 minutes
    setInterval(() => this.updateAllSparklines(), 300000);
  }
};

// Initialize sparklines on page load
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => KPISparklines.init(), 600);
});

// ===== ALARM LOG SYSTEM =====
const AlarmLog = {
  storageKey: 'wwtp_alarm_log',
  maxEntries: 50,

  // Alarm types with styling
  types: {
    critical: { icon: 'üö®', color: '#ef4444', bg: 'rgba(239,68,68,0.15)', label: 'CRITICAL' },
    warning: { icon: '‚ö†Ô∏è', color: '#f59e0b', bg: 'rgba(245,158,11,0.15)', label: 'WARNING' },
    info: { icon: '‚ÑπÔ∏è', color: '#3b82f6', bg: 'rgba(59,130,246,0.15)', label: 'INFO' },
    success: { icon: '‚úÖ', color: '#22c55e', bg: 'rgba(34,197,94,0.15)', label: 'OK' },
    action: { icon: 'üìù', color: '#8b5cf6', bg: 'rgba(139,92,246,0.15)', label: 'ACTION' }
  },

  // Get all alarms
  getAlarms() {
    const saved = localStorage.getItem(this.storageKey);
    return saved ? JSON.parse(saved) : [];
  },

  // Add alarm entry
  addAlarm(type, message, source = 'System') {
    const alarms = this.getAlarms();
    alarms.unshift({
      id: Date.now(),
      type: type,
      message: message,
      source: source,
      timestamp: new Date().toISOString(),
      acknowledged: false
    });
    // Keep max entries
    while (alarms.length > this.maxEntries) alarms.pop();
    localStorage.setItem(this.storageKey, JSON.stringify(alarms));
    this.updateDisplay();
  },

  // Acknowledge alarm
  acknowledgeAlarm(id) {
    const alarms = this.getAlarms();
    const alarm = alarms.find(a => a.id === id);
    if (alarm) {
      alarm.acknowledged = true;
      alarm.acknowledgedAt = new Date().toISOString();
      localStorage.setItem(this.storageKey, JSON.stringify(alarms));
      this.updateDisplay();
    }
  },

  // Clear all alarms
  clearAll() {
    if (confirm('Clear all alarm history?')) {
      localStorage.removeItem(this.storageKey);
      this.updateDisplay();
      showToast('üóëÔ∏è Alarm history cleared', 'info');
    }
  },

  // Format time ago
  timeAgo(timestamp) {
    const seconds = Math.floor((Date.now() - new Date(timestamp).getTime()) / 1000);
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
  },

  // Update dashboard display
  updateDisplay() {
    const container = document.getElementById('alarmLogList');
    if (!container) return;

    const alarms = this.getAlarms().slice(0, 10); // Show last 10 on dashboard

    if (alarms.length === 0) {
      container.innerHTML = `
        <div style="text-align:center;padding:20px;color:#64748b;font-size:13px">
          <span style="font-size:24px">‚úÖ</span><br>
          No recent alarms
        </div>
      `;
      return;
    }

    container.innerHTML = alarms.map(alarm => {
      const type = this.types[alarm.type] || this.types.info;
      return `
        <div style="display:flex;align-items:flex-start;gap:10px;padding:10px;background:${type.bg};border-left:3px solid ${type.color};border-radius:0 8px 8px 0;${alarm.acknowledged ? 'opacity:0.6;' : ''}" onclick="AlarmLog.acknowledgeAlarm(${alarm.id})">
          <span style="font-size:16px">${type.icon}</span>
          <div style="flex:1;min-width:0">
            <div style="font-size:12px;font-weight:600;color:${type.color};display:flex;justify-content:space-between;align-items:center">
              <span>${type.label}</span>
              <span style="font-size:10px;color:#64748b;font-weight:400">${this.timeAgo(alarm.timestamp)}</span>
            </div>
            <div style="font-size:12px;color:var(--text);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${alarm.message}</div>
            <div style="font-size:10px;color:#64748b;margin-top:2px">${alarm.source}${alarm.acknowledged ? ' ‚Ä¢ Acknowledged' : ''}</div>
          </div>
        </div>
      `;
    }).join('');
  },

  // Show full log modal
  showFullLog() {
    const alarms = this.getAlarms();
    
    const html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid #2d4a6f">
          <div>
            <span style="font-size:14px;font-weight:600;color:white">üìã Full Alarm History</span>
            <span style="font-size:12px;color:#64748b;margin-left:8px">${alarms.length} entries</span>
          </div>
          <button onclick="AlarmLog.clearAll()" style="background:rgba(239,68,68,0.2);border:1px solid #ef4444;padding:6px 12px;border-radius:6px;color:#fca5a5;font-size:11px;cursor:pointer">üóëÔ∏è Clear All</button>
        </div>
        
        <div style="max-height:400px;overflow-y:auto;padding:12px">
          ${alarms.length === 0 ? `
            <div style="text-align:center;padding:40px;color:#64748b">
              <span style="font-size:32px">‚úÖ</span><br>
              <div style="margin-top:8px">No alarm history</div>
            </div>
          ` : alarms.map(alarm => {
            const type = this.types[alarm.type] || this.types.info;
            return `
              <div style="display:flex;align-items:flex-start;gap:10px;padding:12px;background:${type.bg};border-left:3px solid ${type.color};border-radius:0 8px 8px 0;margin-bottom:8px;${alarm.acknowledged ? 'opacity:0.6;' : ''}">
                <span style="font-size:18px">${type.icon}</span>
                <div style="flex:1">
                  <div style="font-size:12px;font-weight:600;color:${type.color};display:flex;justify-content:space-between">
                    <span>${type.label}</span>
                    <span style="font-size:11px;color:#64748b;font-weight:400">${new Date(alarm.timestamp).toLocaleString()}</span>
                  </div>
                  <div style="font-size:13px;color:white;margin-top:4px">${alarm.message}</div>
                  <div style="font-size:11px;color:#64748b;margin-top:4px">Source: ${alarm.source}${alarm.acknowledged ? ' ‚Ä¢ Acknowledged at ' + new Date(alarm.acknowledgedAt).toLocaleTimeString() : ''}</div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
        
        <div style="padding:12px;border-top:1px solid #2d4a6f;display:flex;gap:8px">
          <button onclick="AlarmLog.addTestAlarms()" style="flex:1;padding:10px;background:#374151;border:none;border-radius:8px;color:white;font-size:12px;cursor:pointer">üß™ Add Test Alarms</button>
          <button onclick="AlarmLog.exportLog()" style="flex:1;padding:10px;background:#374151;border:none;border-radius:8px;color:white;font-size:12px;cursor:pointer">üì§ Export Log</button>
        </div>
      </div>
    `;
    
    showModal('üö® Alarm History', html, { width: '500px' });
  },

  // Add some test alarms for demo
  addTestAlarms() {
    this.addAlarm('critical', 'Blower #2 high temperature alarm - 185¬∞F', 'Blower Room');
    this.addAlarm('warning', 'Clarifier #1 sludge blanket at 4.5ft (high)', 'Clarifier');
    this.addAlarm('info', 'Daily backup completed successfully', 'System');
    this.addAlarm('action', 'Operator logged reading: DO 2.1 mg/L', 'Quick Actions');
    this.addAlarm('success', 'Permit limit check passed - all parameters in range', 'Compliance');
    showToast('üß™ Test alarms added', 'info');
    this.showFullLog();
  },

  // Export log to text file
  exportLog() {
    const alarms = this.getAlarms();
    let text = 'WWTP ALARM LOG EXPORT\n';
    text += '=====================\n';
    text += `Generated: ${new Date().toLocaleString()}\n`;
    text += `Total Entries: ${alarms.length}\n\n`;
    
    alarms.forEach((alarm, i) => {
      const type = this.types[alarm.type] || this.types.info;
      text += `${i + 1}. [${type.label}] ${new Date(alarm.timestamp).toLocaleString()}\n`;
      text += `   ${alarm.message}\n`;
      text += `   Source: ${alarm.source}\n`;
      if (alarm.acknowledged) text += `   Acknowledged: ${new Date(alarm.acknowledgedAt).toLocaleString()}\n`;
      text += '\n';
    });

    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `WWTP-Alarm-Log-${new Date().toISOString().split('T')[0]}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('üì§ Alarm log exported', 'success');
  },

  // Initialize - load and display
  init() {
    this.updateDisplay();
    // Auto-refresh every 30 seconds
    setInterval(() => this.updateDisplay(), 30000);
  }
};

// Initialize alarm log on page load
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => AlarmLog.init(), 500);
});

// ===== QUICK ACTIONS =====
const QuickActions = {
  // Storage key for logs
  storageKey: 'wwtp_quick_logs',

  // Get all logs
  getLogs() {
    const saved = localStorage.getItem(this.storageKey);
    return saved ? JSON.parse(saved) : [];
  },

  // Save a log entry
  saveLog(type, data) {
    const logs = this.getLogs();
    logs.unshift({
      id: Date.now(),
      type: type,
      timestamp: new Date().toISOString(),
      data: data
    });
    // Keep last 100 entries
    if (logs.length > 100) logs.pop();
    localStorage.setItem(this.storageKey, JSON.stringify(logs));
  },

  // Log Reading - quick entry for common readings
  logReading() {
    const now = new Date();
    const html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;padding:20px">
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:13px;color:#94a3b8">üìù Quick Log Entry</div>
          <div style="font-size:11px;color:#64748b;margin-top:4px">${now.toLocaleString()}</div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">DO (mg/L)</label>
            <input type="number" id="qlog-do" step="0.1" placeholder="2.0" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">pH</label>
            <input type="number" id="qlog-ph" step="0.1" placeholder="7.2" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Temp (¬∞C)</label>
            <input type="number" id="qlog-temp" step="0.5" placeholder="20" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Flow (MGD)</label>
            <input type="number" id="qlog-flow" step="0.1" placeholder="3.5" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
          </div>
        </div>
        
        <div style="margin-bottom:16px">
          <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Notes (optional)</label>
          <textarea id="qlog-notes" rows="2" placeholder="Any observations..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px;resize:none"></textarea>
        </div>
        
        <button onclick="QuickActions.submitReading()" style="width:100%;padding:14px;background:linear-gradient(135deg,#3b82f6,#1d4ed8);border:none;border-radius:10px;color:white;font-weight:600;font-size:14px;cursor:pointer">
          üíæ Save Reading
        </button>
      </div>
    `;
    showModal('üìù Log Reading', html, { width: '400px' });
  },

  submitReading() {
    const data = {
      do: document.getElementById('qlog-do')?.value || '',
      ph: document.getElementById('qlog-ph')?.value || '',
      temp: document.getElementById('qlog-temp')?.value || '',
      flow: document.getElementById('qlog-flow')?.value || '',
      notes: document.getElementById('qlog-notes')?.value || ''
    };
    this.saveLog('reading', data);
    // Add to alarm log
    const summary = [data.do && `DO:${data.do}`, data.ph && `pH:${data.ph}`, data.temp && `${data.temp}¬∞C`, data.flow && `${data.flow}MGD`].filter(Boolean).join(', ');
    AlarmLog.addAlarm('action', `Reading logged: ${summary || 'No values'}`, 'Operator');
    closeModal();
    showToast('üìù Reading logged successfully', 'success');
  },

  // Log WAS - waste activated sludge logging
  logWAS() {
    const html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;padding:20px">
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:13px;color:#94a3b8">üöø WAS Log Entry</div>
          <div style="font-size:11px;color:#64748b;margin-top:4px">${new Date().toLocaleString()}</div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">WAS Rate (GPM)</label>
            <input type="number" id="qwas-rate" step="1" placeholder="50" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Duration (min)</label>
            <input type="number" id="qwas-duration" step="5" placeholder="60" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">WAS Conc (mg/L)</label>
            <input type="number" id="qwas-conc" step="100" placeholder="8000" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Destination</label>
            <select id="qwas-dest" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
              <option value="digester">Digester</option>
              <option value="thickener">Thickener</option>
              <option value="holding">Holding Tank</option>
              <option value="hauled">Hauled Off-site</option>
            </select>
          </div>
        </div>
        
        <div id="qwas-calc" style="background:rgba(139,92,246,0.1);border:1px solid #8b5cf6;border-radius:8px;padding:12px;margin-bottom:16px;text-align:center">
          <div style="font-size:11px;color:#94a3b8">ESTIMATED VOLUME</div>
          <div style="font-size:24px;font-weight:700;color:#a78bfa" id="qwas-volume">-- gal</div>
        </div>
        
        <button onclick="QuickActions.submitWAS()" style="width:100%;padding:14px;background:linear-gradient(135deg,#8b5cf6,#6d28d9);border:none;border-radius:10px;color:white;font-weight:600;font-size:14px;cursor:pointer">
          üíæ Log WAS Event
        </button>
      </div>
    `;
    showModal('üöø Log WAS', html, { width: '400px' });
    
    // Add live calculation
    setTimeout(() => {
      const calcVolume = () => {
        const rate = parseFloat(document.getElementById('qwas-rate')?.value) || 0;
        const duration = parseFloat(document.getElementById('qwas-duration')?.value) || 0;
        const volume = rate * duration;
        document.getElementById('qwas-volume').textContent = volume > 0 ? volume.toLocaleString() + ' gal' : '-- gal';
      };
      document.getElementById('qwas-rate')?.addEventListener('input', calcVolume);
      document.getElementById('qwas-duration')?.addEventListener('input', calcVolume);
    }, 100);
  },

  submitWAS() {
    const rate = parseFloat(document.getElementById('qwas-rate')?.value) || 0;
    const duration = parseFloat(document.getElementById('qwas-duration')?.value) || 0;
    const data = {
      rate: rate,
      duration: duration,
      volume: rate * duration,
      concentration: document.getElementById('qwas-conc')?.value || '',
      destination: document.getElementById('qwas-dest')?.value || ''
    };
    this.saveLog('was', data);
    // Add to alarm log
    AlarmLog.addAlarm('action', `WAS event: ${data.volume.toLocaleString()} gal to ${data.destination}`, 'Operator');
    closeModal();
    showToast('üöø WAS event logged: ' + (data.volume).toLocaleString() + ' gallons', 'success');
  },

  // Settleometer test logging
  settleometer() {
    const html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;padding:20px">
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:13px;color:#94a3b8">üî¨ Settleometer Test</div>
          <div style="font-size:11px;color:#64748b;margin-top:4px">${new Date().toLocaleString()}</div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">30-min Settled (mL/L)</label>
            <input type="number" id="qsettle-30" step="10" placeholder="250" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">MLSS (mg/L)</label>
            <input type="number" id="qsettle-mlss" step="100" placeholder="3000" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Location</label>
            <select id="qsettle-loc" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
              <option value="aeration1">Aeration Basin 1</option>
              <option value="aeration2">Aeration Basin 2</option>
              <option value="ras">RAS Line</option>
              <option value="effluent">Clarifier Effluent</option>
            </select>
          </div>
          <div>
            <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Appearance</label>
            <select id="qsettle-appear" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
              <option value="good">Good - Compact</option>
              <option value="fair">Fair - Fluffy</option>
              <option value="poor">Poor - Billowing</option>
              <option value="bulking">Bulking</option>
            </select>
          </div>
        </div>
        
        <div id="qsettle-svi" style="background:rgba(16,185,129,0.1);border:1px solid #10b981;border-radius:8px;padding:12px;margin-bottom:16px;text-align:center">
          <div style="font-size:11px;color:#94a3b8">CALCULATED SVI</div>
          <div style="font-size:24px;font-weight:700;color:#4ade80" id="qsettle-svi-value">-- mL/g</div>
          <div style="font-size:11px;color:#94a3b8;margin-top:4px" id="qsettle-svi-rating">Enter values above</div>
        </div>
        
        <button onclick="QuickActions.submitSettle()" style="width:100%;padding:14px;background:linear-gradient(135deg,#10b981,#059669);border:none;border-radius:10px;color:white;font-weight:600;font-size:14px;cursor:pointer">
          üíæ Save Test Results
        </button>
      </div>
    `;
    showModal('üî¨ Settleometer', html, { width: '400px' });
    
    // Add live SVI calculation
    setTimeout(() => {
      const calcSVI = () => {
        const settled = parseFloat(document.getElementById('qsettle-30')?.value) || 0;
        const mlss = parseFloat(document.getElementById('qsettle-mlss')?.value) || 0;
        if (settled > 0 && mlss > 0) {
          const svi = (settled / mlss) * 1000;
          document.getElementById('qsettle-svi-value').textContent = svi.toFixed(0) + ' mL/g';
          let rating = '', color = '';
          if (svi < 80) { rating = '‚úÖ Excellent settling'; color = '#4ade80'; }
          else if (svi < 120) { rating = '‚úÖ Good settling'; color = '#22c55e'; }
          else if (svi < 150) { rating = '‚ö†Ô∏è Fair settling'; color = '#fbbf24'; }
          else if (svi < 200) { rating = '‚ö†Ô∏è Poor settling'; color = '#f97316'; }
          else { rating = 'üö® Bulking conditions'; color = '#ef4444'; }
          document.getElementById('qsettle-svi-rating').innerHTML = `<span style="color:${color}">${rating}</span>`;
          document.getElementById('qsettle-svi-value').style.color = color;
        } else {
          document.getElementById('qsettle-svi-value').textContent = '-- mL/g';
          document.getElementById('qsettle-svi-rating').textContent = 'Enter values above';
        }
      };
      document.getElementById('qsettle-30')?.addEventListener('input', calcSVI);
      document.getElementById('qsettle-mlss')?.addEventListener('input', calcSVI);
    }, 100);
  },

  submitSettle() {
    const settled = parseFloat(document.getElementById('qsettle-30')?.value) || 0;
    const mlss = parseFloat(document.getElementById('qsettle-mlss')?.value) || 0;
    const svi = mlss > 0 ? ((settled / mlss) * 1000).toFixed(0) : 0;
    const data = {
      settled30: settled,
      mlss: mlss,
      svi: svi,
      location: document.getElementById('qsettle-loc')?.value || '',
      appearance: document.getElementById('qsettle-appear')?.value || ''
    };
    this.saveLog('settleometer', data);
    // Add to alarm log with appropriate type based on SVI
    const alarmType = svi > 150 ? 'warning' : 'action';
    AlarmLog.addAlarm(alarmType, `Settleometer: SVI = ${svi} mL/g at ${data.location}`, 'Operator');
    closeModal();
    showToast('üî¨ Settleometer logged: SVI = ' + svi + ' mL/g', 'success');
  },

  // Report Issue
  reportIssue() {
    const html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;padding:20px">
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:13px;color:#94a3b8">‚ö†Ô∏è Report Issue</div>
          <div style="font-size:11px;color:#64748b;margin-top:4px">${new Date().toLocaleString()}</div>
        </div>
        
        <div style="margin-bottom:16px">
          <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Priority</label>
          <div style="display:flex;gap:8px">
            <button type="button" onclick="QuickActions.setPriority('low')" id="pri-low" style="flex:1;padding:10px;border:2px solid #374151;border-radius:8px;background:transparent;color:#94a3b8;cursor:pointer">üü¢ Low</button>
            <button type="button" onclick="QuickActions.setPriority('medium')" id="pri-medium" style="flex:1;padding:10px;border:2px solid #f59e0b;border-radius:8px;background:rgba(245,158,11,0.2);color:#fbbf24;cursor:pointer">üü° Medium</button>
            <button type="button" onclick="QuickActions.setPriority('high')" id="pri-high" style="flex:1;padding:10px;border:2px solid #374151;border-radius:8px;background:transparent;color:#94a3b8;cursor:pointer">üî¥ High</button>
          </div>
        </div>
        
        <div style="margin-bottom:16px">
          <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Category</label>
          <select id="qissue-cat" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
            <option value="equipment">Equipment Malfunction</option>
            <option value="process">Process Issue</option>
            <option value="safety">Safety Concern</option>
            <option value="compliance">Compliance Issue</option>
            <option value="odor">Odor Complaint</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div style="margin-bottom:16px">
          <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Location</label>
          <input type="text" id="qissue-loc" placeholder="e.g., Blower Room, Clarifier 2" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
        </div>
        
        <div style="margin-bottom:16px">
          <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Description</label>
          <textarea id="qissue-desc" rows="3" placeholder="Describe the issue..." style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px;resize:none"></textarea>
        </div>
        
        <input type="hidden" id="qissue-priority" value="medium">
        
        <button onclick="QuickActions.submitIssue()" style="width:100%;padding:14px;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;border-radius:10px;color:white;font-weight:600;font-size:14px;cursor:pointer">
          üì§ Submit Issue Report
        </button>
      </div>
    `;
    showModal('‚ö†Ô∏è Report Issue', html, { width: '400px' });
  },

  setPriority(level) {
    document.getElementById('qissue-priority').value = level;
    ['low', 'medium', 'high'].forEach(l => {
      const btn = document.getElementById('pri-' + l);
      if (l === level) {
        btn.style.borderColor = l === 'low' ? '#22c55e' : l === 'medium' ? '#f59e0b' : '#ef4444';
        btn.style.background = l === 'low' ? 'rgba(34,197,94,0.2)' : l === 'medium' ? 'rgba(245,158,11,0.2)' : 'rgba(239,68,68,0.2)';
        btn.style.color = l === 'low' ? '#4ade80' : l === 'medium' ? '#fbbf24' : '#fca5a5';
      } else {
        btn.style.borderColor = '#374151';
        btn.style.background = 'transparent';
        btn.style.color = '#94a3b8';
      }
    });
  },

  submitIssue() {
    const data = {
      priority: document.getElementById('qissue-priority')?.value || 'medium',
      category: document.getElementById('qissue-cat')?.value || '',
      location: document.getElementById('qissue-loc')?.value || '',
      description: document.getElementById('qissue-desc')?.value || ''
    };
    this.saveLog('issue', data);
    // Add to alarm log with appropriate type based on priority
    const alarmType = data.priority === 'high' ? 'critical' : data.priority === 'medium' ? 'warning' : 'info';
    AlarmLog.addAlarm(alarmType, `Issue reported: ${data.category} - ${data.description?.substring(0, 50) || 'No description'}`, data.location || 'Unknown');
    closeModal();
    const priorityEmoji = data.priority === 'high' ? 'üî¥' : data.priority === 'medium' ? 'üü°' : 'üü¢';
    showToast(`${priorityEmoji} Issue reported: ${data.category}`, 'warning');
  },

  // Shift Handoff
  shiftHandoff() {
    // Get recent logs for this shift (last 8 hours)
    const logs = this.getLogs();
    const eightHoursAgo = Date.now() - (8 * 60 * 60 * 1000);
    const shiftLogs = logs.filter(l => new Date(l.timestamp).getTime() > eightHoursAgo);
    
    const readings = shiftLogs.filter(l => l.type === 'reading').length;
    const wasEvents = shiftLogs.filter(l => l.type === 'was').length;
    const settleTests = shiftLogs.filter(l => l.type === 'settleometer').length;
    const issues = shiftLogs.filter(l => l.type === 'issue');
    
    const html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;padding:20px">
        <div style="text-align:center;margin-bottom:20px">
          <div style="font-size:13px;color:#94a3b8">üìã Shift Handoff Report</div>
          <div style="font-size:11px;color:#64748b;margin-top:4px">${new Date().toLocaleString()}</div>
        </div>
        
        <!-- Shift Summary -->
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px">
          <div style="background:rgba(59,130,246,0.2);padding:12px;border-radius:8px;text-align:center">
            <div style="font-size:20px;font-weight:700;color:#60a5fa">${readings}</div>
            <div style="font-size:10px;color:#94a3b8">Readings</div>
          </div>
          <div style="background:rgba(139,92,246,0.2);padding:12px;border-radius:8px;text-align:center">
            <div style="font-size:20px;font-weight:700;color:#a78bfa">${wasEvents}</div>
            <div style="font-size:10px;color:#94a3b8">WAS Events</div>
          </div>
          <div style="background:rgba(16,185,129,0.2);padding:12px;border-radius:8px;text-align:center">
            <div style="font-size:20px;font-weight:700;color:#4ade80">${settleTests}</div>
            <div style="font-size:10px;color:#94a3b8">Settle Tests</div>
          </div>
          <div style="background:rgba(245,158,11,0.2);padding:12px;border-radius:8px;text-align:center">
            <div style="font-size:20px;font-weight:700;color:#fbbf24">${issues.length}</div>
            <div style="font-size:10px;color:#94a3b8">Issues</div>
          </div>
        </div>
        
        ${issues.length > 0 ? `
        <div style="margin-bottom:16px">
          <div style="font-size:12px;color:#94a3b8;margin-bottom:8px">‚ö†Ô∏è Open Issues This Shift:</div>
          ${issues.map(i => `
            <div style="background:rgba(245,158,11,0.1);border-left:3px solid ${i.data.priority === 'high' ? '#ef4444' : i.data.priority === 'medium' ? '#f59e0b' : '#22c55e'};padding:8px 12px;border-radius:0 8px 8px 0;margin-bottom:6px;font-size:12px">
              <strong style="color:white">${i.data.category}</strong> - ${i.data.location}<br>
              <span style="color:#94a3b8">${i.data.description?.substring(0, 50)}${i.data.description?.length > 50 ? '...' : ''}</span>
            </div>
          `).join('')}
        </div>
        ` : ''}
        
        <div style="margin-bottom:16px">
          <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Handoff Notes for Next Shift</label>
          <textarea id="qhandoff-notes" rows="4" placeholder="What does the next shift need to know?" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:13px;resize:none"></textarea>
        </div>
        
        <div style="margin-bottom:16px">
          <label style="color:#94a3b8;font-size:11px;display:block;margin-bottom:4px">Operator Name</label>
          <input type="text" id="qhandoff-name" placeholder="Your name" style="width:100%;padding:10px;border-radius:8px;border:1px solid #374151;background:#1e3a5f;color:white;font-size:14px">
        </div>
        
        <button onclick="QuickActions.submitHandoff()" style="width:100%;padding:14px;background:linear-gradient(135deg,#ec4899,#be185d);border:none;border-radius:10px;color:white;font-weight:600;font-size:14px;cursor:pointer">
          ‚úÖ Complete Shift Handoff
        </button>
      </div>
    `;
    showModal('üìã Shift Handoff', html, { width: '420px' });
  },

  submitHandoff() {
    const data = {
      notes: document.getElementById('qhandoff-notes')?.value || '',
      operator: document.getElementById('qhandoff-name')?.value || 'Unknown',
      shiftEnd: new Date().toISOString()
    };
    this.saveLog('handoff', data);
    closeModal();
    showToast('‚úÖ Shift handoff completed by ' + data.operator, 'success');
  }
};

// ===== PREDICTIVE OPERATIONS =====
const PredictiveOps = {
  // Historical data storage
  history: [],

  // Load history from localStorage
  loadHistory() {
    const saved = localStorage.getItem('wwtp_predictive_history');
    this.history = saved ? JSON.parse(saved) : [];
    return this.history;
  },

  // Save data point
  saveDataPoint(data) {
    this.loadHistory();
    this.history.push({
      timestamp: new Date().toISOString(),
      ...data
    });
    // Keep last 90 days of data
    const cutoff = Date.now() - (90 * 24 * 60 * 60 * 1000);
    this.history = this.history.filter(h => new Date(h.timestamp).getTime() > cutoff);
    localStorage.setItem('wwtp_predictive_history', JSON.stringify(this.history));
  },

  // Auto-collect current data
  collectCurrentData() {
    const data = OptimizationCoach.getPlantData();
    this.saveDataPoint(data);
    return data;
  },

  // Calculate trend (simple linear regression)
  calculateTrend(values) {
    if (values.length < 3) return { slope: 0, direction: 'stable', confidence: 0 };
    
    const n = values.length;
    const sumX = values.reduce((a, _, i) => a + i, 0);
    const sumY = values.reduce((a, v) => a + v, 0);
    const sumXY = values.reduce((a, v, i) => a + i * v, 0);
    const sumX2 = values.reduce((a, _, i) => a + i * i, 0);
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
    const avgY = sumY / n;
    const relativeSlope = slope / (avgY || 1);
    
    let direction = 'stable';
    if (relativeSlope > 0.02) direction = 'increasing';
    if (relativeSlope < -0.02) direction = 'decreasing';
    
    return {
      slope,
      direction,
      confidence: Math.min(100, values.length * 10)
    };
  },

  // Generate predictions
  generatePredictions() {
    this.loadHistory();
    const predictions = [];
    
    if (this.history.length < 3) {
      return {
        predictions: [],
        message: 'Not enough historical data. Continue logging daily readings to enable predictions.',
        dataPoints: this.history.length
      };
    }

    // Analyze each parameter
    const parameters = [
      { key: 'svi', name: 'SVI', unit: 'mL/g', warnHigh: 150, criticalHigh: 200 },
      { key: 'do', name: 'DO', unit: 'mg/L', warnLow: 1.5, criticalLow: 1.0 },
      { key: 'mlss', name: 'MLSS', unit: 'mg/L', warnHigh: 4500, warnLow: 2000 },
      { key: 'fm', name: 'F/M', unit: 'lb/lb/d', warnHigh: 0.5, warnLow: 0.2 },
      { key: 'ph', name: 'pH', unit: '', warnHigh: 8.5, warnLow: 6.5, criticalLow: 6.0 },
      { key: 'srt', name: 'SRT', unit: 'days', warnLow: 6, criticalLow: 4 }
    ];

    parameters.forEach(param => {
      const values = this.history.map(h => h[param.key]).filter(v => v && !isNaN(v));
      if (values.length < 3) return;

      const trend = this.calculateTrend(values);
      const current = values[values.length - 1];
      const predicted = current + (trend.slope * 7); // 7-day prediction

      let alert = null;
      
      // Check if trending toward warning/critical
      if (param.warnHigh && predicted > param.warnHigh && current <= param.warnHigh) {
        alert = {
          type: 'warning',
          message: `${param.name} predicted to exceed ${param.warnHigh} ${param.unit} within 7 days`
        };
      }
      if (param.criticalHigh && predicted > param.criticalHigh) {
        alert = {
          type: 'critical',
          message: `${param.name} predicted to reach critical level (${param.criticalHigh} ${param.unit}) soon`
        };
      }
      if (param.warnLow && predicted < param.warnLow && current >= param.warnLow) {
        alert = {
          type: 'warning',
          message: `${param.name} predicted to drop below ${param.warnLow} ${param.unit} within 7 days`
        };
      }
      if (param.criticalLow && predicted < param.criticalLow) {
        alert = {
          type: 'critical',
          message: `${param.name} predicted to reach critical low (${param.criticalLow} ${param.unit}) soon`
        };
      }

      if (alert || trend.direction !== 'stable') {
        predictions.push({
          parameter: param.name,
          unit: param.unit,
          current: current.toFixed(param.key === 'ph' || param.key === 'fm' ? 2 : 0),
          predicted: predicted.toFixed(param.key === 'ph' || param.key === 'fm' ? 2 : 0),
          trend: trend.direction,
          confidence: trend.confidence,
          alert
        });
      }
    });

    return {
      predictions: predictions.sort((a, b) => {
        if (a.alert?.type === 'critical' && b.alert?.type !== 'critical') return -1;
        if (b.alert?.type === 'critical' && a.alert?.type !== 'critical') return 1;
        if (a.alert && !b.alert) return -1;
        if (b.alert && !a.alert) return 1;
        return 0;
      }),
      dataPoints: this.history.length,
      dateRange: this.history.length > 0 ? {
        start: new Date(this.history[0].timestamp).toLocaleDateString(),
        end: new Date(this.history[this.history.length - 1].timestamp).toLocaleDateString()
      } : null
    };
  },

  // Show predictions dashboard
  showDashboard() {
    const results = this.generatePredictions();
    
    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <!-- Header -->
        <div style="background:linear-gradient(135deg,#7c3aed,#a855f7);padding:20px;text-align:center">
          <div style="font-size:36px;margin-bottom:8px">üîÆ</div>
          <div style="font-size:18px;font-weight:700;color:white">Predictive Operations</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.8);margin-top:4px">
            7-Day Forecast ‚Ä¢ ${results.dataPoints} data points
          </div>
        </div>

        <div style="padding:20px;max-height:400px;overflow-y:auto">
          ${results.predictions.length === 0 ? `
            <div style="text-align:center;padding:30px;color:#94a3b8">
              ${results.message ? `<p>${results.message}</p>` : '<p>All parameters trending stable. No alerts predicted.</p>'}
              <button onclick="PredictiveOps.collectCurrentData();showToast('üìä Data point recorded','success')" class="btn" style="margin-top:16px;background:#4ade80;color:#052e16">
                üìä Log Current Reading
              </button>
            </div>
          ` : `
            <!-- Alerts Section -->
            ${results.predictions.filter(p => p.alert).map(pred => `
              <div style="background:${pred.alert.type === 'critical' ? 'rgba(239,68,68,0.2)' : 'rgba(251,191,36,0.2)'};border:1px solid ${pred.alert.type === 'critical' ? '#ef4444' : '#fbbf24'};border-radius:12px;padding:16px;margin-bottom:12px">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
                  <span style="font-size:24px">${pred.alert.type === 'critical' ? 'üö®' : '‚ö†Ô∏è'}</span>
                  <div>
                    <div style="font-weight:700;color:${pred.alert.type === 'critical' ? '#fca5a5' : '#fde047'}">${pred.parameter} Alert</div>
                    <div style="font-size:13px;color:#94a3b8">${pred.alert.message}</div>
                  </div>
                </div>
                <div style="display:flex;justify-content:space-between;padding:10px;background:rgba(0,0,0,0.2);border-radius:8px;font-size:14px">
                  <div style="color:#94a3b8">Current: <strong style="color:white">${pred.current}</strong> ${pred.unit}</div>
                  <div style="color:${pred.trend === 'increasing' ? '#ef4444' : pred.trend === 'decreasing' ? '#4ade80' : '#94a3b8'}">
                    ${pred.trend === 'increasing' ? 'üìà' : pred.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è'}
                  </div>
                  <div style="color:#94a3b8">Predicted: <strong style="color:${pred.alert.type === 'critical' ? '#fca5a5' : '#fde047'}">${pred.predicted}</strong> ${pred.unit}</div>
                </div>
              </div>
            `).join('')}

            <!-- All Trends -->
            <div style="margin-top:20px">
              <h4 style="color:#94a3b8;font-size:13px;margin-bottom:12px;text-transform:uppercase;letter-spacing:1px">All Parameter Trends</h4>
              <div style="display:grid;gap:8px">
                ${results.predictions.map(pred => `
                  <div style="display:flex;align-items:center;justify-content:space-between;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px">
                    <div style="font-weight:500;color:white">${pred.parameter}</div>
                    <div style="display:flex;align-items:center;gap:16px">
                      <span style="color:#94a3b8;font-size:13px">${pred.current} ‚Üí ${pred.predicted} ${pred.unit}</span>
                      <span style="font-size:18px">${pred.trend === 'increasing' ? 'üìà' : pred.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è'}</span>
                      <span style="font-size:11px;color:#94a3b8;opacity:0.7">${pred.confidence}%</span>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `}
        </div>

        <!-- Footer -->
        <div style="padding:16px 20px;border-top:1px solid #2d4a6f;display:flex;gap:10px">
          <button onclick="PredictiveOps.collectCurrentData();PredictiveOps.showDashboard()" class="btn" style="flex:1;background:#7c3aed;color:white">
            üìä Update & Refresh
          </button>
          <button onclick="PredictiveOps.clearHistory()" class="btn" style="background:#374151;color:#94a3b8">
            üóëÔ∏è Clear
          </button>
        </div>
      </div>
    `;

    showModal('üîÆ Predictive Operations', html, { width: '500px' });
  },

  // Clear history
  clearHistory() {
    if (confirm('Clear all predictive history data?')) {
      localStorage.removeItem('wwtp_predictive_history');
      this.history = [];
      showToast('üóëÔ∏è Predictive history cleared', 'info');
      this.showDashboard();
    }
  }
};

// ===== SOP LIBRARY =====
const SOPLibrary = {
  // SOP Categories and procedures
  procedures: {
    daily: {
      id: 'daily',
      name: 'Daily Operations',
      icon: 'üìã',
      color: '#3b82f6',
      sops: [
        {
          id: 'sop-daily-rounds',
          title: 'Daily Plant Rounds',
          estimatedTime: '45-60 min',
          frequency: 'Every shift',
          steps: [
            { step: 1, action: 'Check in at control room', detail: 'Review logbook entries from previous shift. Note any issues or concerns.', critical: false },
            { step: 2, action: 'Verify SCADA alarms', detail: 'Check for active alarms. Acknowledge and investigate any new alarms.', critical: true },
            { step: 3, action: 'Headworks inspection', detail: 'Check bar screens, grit removal. Note debris accumulation. Record flow rate.', critical: false },
            { step: 4, action: 'Primary clarifiers', detail: 'Check scum and sludge pumps. Observe surface for floating solids. Check weirs.', critical: false },
            { step: 5, action: 'Aeration basins', detail: 'Observe foam/scum (color, amount). Check DO readings. Listen for unusual sounds.', critical: true },
            { step: 6, action: 'Secondary clarifiers', detail: 'Check sludge blanket depth. Observe effluent clarity. Check weirs for algae.', critical: true },
            { step: 7, action: 'Disinfection system', detail: 'Check chlorine residual. Verify chemical feed rates. Check contact time.', critical: true },
            { step: 8, action: 'Blower room', detail: 'Check blower status, pressures, temperatures. Listen for unusual noise/vibration.', critical: false },
            { step: 9, action: 'Chemical storage', detail: 'Check tank levels. Look for leaks. Verify secondary containment integrity.', critical: false },
            { step: 10, action: 'Complete logbook entry', detail: 'Record all observations, readings, and any actions taken.', critical: true }
          ],
          safety: ['Wear appropriate PPE for each area', 'Follow confined space procedures', 'Watch for slip/trip hazards'],
          notes: 'Adjust route based on plant layout. Report any unusual conditions immediately.'
        },
        {
          id: 'sop-do-check',
          title: 'Dissolved Oxygen Check',
          estimatedTime: '15-20 min',
          frequency: 'Every 4 hours',
          steps: [
            { step: 1, action: 'Gather equipment', detail: 'Portable DO meter, calibration solutions, logsheet, pen.', critical: false },
            { step: 2, action: 'Calibrate meter', detail: 'Use air-saturated water or air calibration method per manufacturer instructions.', critical: true },
            { step: 3, action: 'Measure Basin 1', detail: 'Submerge probe 12-18 inches. Wait for reading to stabilize. Record DO and temperature.', critical: false },
            { step: 4, action: 'Measure Basin 2', detail: 'Repeat measurement. Compare to Basin 1.', critical: false },
            { step: 5, action: 'Check additional points', detail: 'Measure at inlet, middle, and outlet of each basin if required.', critical: false },
            { step: 6, action: 'Compare to setpoint', detail: 'Target: 1.5-2.5 mg/L. Adjust blowers if outside range.', critical: true },
            { step: 7, action: 'Record results', detail: 'Log all readings with date, time, location, and operator initials.', critical: true },
            { step: 8, action: 'Clean and store meter', detail: 'Rinse probe with DI water. Store properly.', critical: false }
          ],
          safety: ['Watch footing near basins', 'Do not lean over handrails'],
          notes: 'If DO consistently outside range, notify supervisor. Check diffusers if low DO persists.'
        },
        {
          id: 'sop-settleability',
          title: 'Settleability Test (SVI)',
          estimatedTime: '35-40 min',
          frequency: 'Daily',
          steps: [
            { step: 1, action: 'Gather equipment', detail: '1-liter graduated cylinder, timer, sample container, calculator.', critical: false },
            { step: 2, action: 'Collect sample', detail: 'Get fresh mixed liquor from aeration basin. Sample from well-mixed location.', critical: true },
            { step: 3, action: 'Fill cylinder', detail: 'Pour sample to 1000 mL mark. Start timer immediately.', critical: true },
            { step: 4, action: 'Record 5-min reading', detail: 'Optional: Note settled volume at 5 minutes for trend analysis.', critical: false },
            { step: 5, action: 'Record 30-min reading', detail: 'Read settled sludge volume at exactly 30 minutes. Record in mL/L.', critical: true },
            { step: 6, action: 'Calculate SVI', detail: 'SVI = (Settled Volume √ó 1000) √∑ MLSS concentration', critical: true },
            { step: 7, action: 'Interpret results', detail: 'SVI < 100: Excellent | 100-150: Good | 150-200: Fair | >200: Poor/Bulking', critical: false },
            { step: 8, action: 'Record and report', detail: 'Log results. Report SVI > 150 to supervisor.', critical: true }
          ],
          safety: ['Handle glassware carefully', 'Wash hands after handling samples'],
          notes: 'Always use fresh sample. Old samples give false results. Note any unusual sludge appearance.'
        }
      ]
    },
    weekly: {
      id: 'weekly',
      name: 'Weekly Tasks',
      icon: 'üìÖ',
      color: '#8b5cf6',
      sops: [
        {
          id: 'sop-clarifier-blanket',
          title: 'Clarifier Sludge Blanket Survey',
          estimatedTime: '30-45 min',
          frequency: 'Weekly',
          steps: [
            { step: 1, action: 'Gather equipment', detail: 'Sludge judge or core sampler, measuring tape, logsheet.', critical: false },
            { step: 2, action: 'Safety check', detail: 'Ensure handrails secure. Use fall protection if required.', critical: true },
            { step: 3, action: 'Lower sludge judge', detail: 'Slowly lower to bottom of clarifier. Allow to settle.', critical: false },
            { step: 4, action: 'Read blanket depth', detail: 'Pull up slowly. Read where clear water meets sludge.', critical: true },
            { step: 5, action: 'Take multiple readings', detail: 'Measure at center, halfway, and near wall. Average results.', critical: false },
            { step: 6, action: 'Check all clarifiers', detail: 'Repeat for each secondary clarifier.', critical: false },
            { step: 7, action: 'Compare to limits', detail: 'Target: 1-3 feet. Adjust RAS/WAS if outside range.', critical: true },
            { step: 8, action: 'Document results', detail: 'Record all measurements. Note any visual observations.', critical: true }
          ],
          safety: ['Use fall protection', 'Do not lean over handrails', 'Watch for slippery surfaces'],
          notes: 'Blanket > 4 ft: Increase RAS or WAS. Blanket < 1 ft: Decrease WAS.'
        },
        {
          id: 'sop-blower-inspection',
          title: 'Blower Room Weekly Inspection',
          estimatedTime: '30 min',
          frequency: 'Weekly',
          steps: [
            { step: 1, action: 'Check inlet filters', detail: 'Inspect for dirt/debris. Replace if ŒîP > limit or visually dirty.', critical: true },
            { step: 2, action: 'Record pressures', detail: 'Log inlet, discharge, and differential pressures for each blower.', critical: false },
            { step: 3, action: 'Check temperatures', detail: 'Record bearing temps, motor temps, discharge air temp.', critical: true },
            { step: 4, action: 'Listen for abnormal sounds', detail: 'Unusual noise, vibration, or rattling indicates problems.', critical: true },
            { step: 5, action: 'Check oil levels', detail: 'Verify oil is at proper level. Note color and condition.', critical: false },
            { step: 6, action: 'Inspect belts (if equipped)', detail: 'Check for wear, cracks, proper tension.', critical: false },
            { step: 7, action: 'Verify VFD operation', detail: 'Check VFD display for faults. Note speed settings.', critical: false },
            { step: 8, action: 'Log amp readings', detail: 'Record motor amperage. Compare to nameplate.', critical: false }
          ],
          safety: ['Wear hearing protection', 'Do not touch rotating equipment', 'Follow LOTO if opening panels'],
          notes: 'Report bearing temps > 180¬∞F or unusual vibration immediately.'
        }
      ]
    },
    monthly: {
      id: 'monthly',
      name: 'Monthly Tasks',
      icon: 'üìÜ',
      color: '#f59e0b',
      sops: [
        {
          id: 'sop-safety-equipment',
          title: 'Safety Equipment Inspection',
          estimatedTime: '45-60 min',
          frequency: 'Monthly',
          steps: [
            { step: 1, action: 'Eyewash stations', detail: 'Test flow. Run for 3 minutes. Check temperature (60-100¬∞F).', critical: true },
            { step: 2, action: 'Safety showers', detail: 'Test activation. Check flow pattern covers body. Verify drain.', critical: true },
            { step: 3, action: 'Fire extinguishers', detail: 'Check charge/pressure. Verify inspection tag current. Note location.', critical: true },
            { step: 4, action: 'First aid kits', detail: 'Check supplies. Replace expired items. Restock as needed.', critical: false },
            { step: 5, action: 'Emergency lighting', detail: 'Test operation. Replace burned out bulbs.', critical: false },
            { step: 6, action: 'Gas monitors', detail: 'Verify calibration current. Test alarm function. Check battery.', critical: true },
            { step: 7, action: 'Fall protection equipment', detail: 'Inspect harnesses, lanyards for wear/damage.', critical: true },
            { step: 8, action: 'Document inspection', detail: 'Complete checklist. Report deficiencies immediately.', critical: true }
          ],
          safety: ['Replace defective equipment immediately', 'Tag out-of-service equipment'],
          notes: 'Non-functional safety equipment is a serious violation. Repair or replace ASAP.'
        },
        {
          id: 'sop-diffuser-inspection',
          title: 'Diffuser Inspection',
          estimatedTime: '2-4 hours',
          frequency: 'Monthly/Quarterly',
          steps: [
            { step: 1, action: 'Review air distribution', detail: 'Check for uneven bubbling patterns in basins.', critical: false },
            { step: 2, action: 'Lower basin (if possible)', detail: 'Drain basin or lower level for visual inspection.', critical: false },
            { step: 3, action: 'Inspect diffuser membranes', detail: 'Look for tears, fouling, calcium buildup.', critical: true },
            { step: 4, action: 'Check connections', detail: 'Verify air piping connections are tight.', critical: false },
            { step: 5, action: 'Clean diffusers if needed', detail: 'Use approved cleaning method (acid wash, brushing).', critical: false },
            { step: 6, action: 'Test airflow', detail: 'Verify uniform distribution across grid.', critical: true },
            { step: 7, action: 'Calculate OTE', detail: 'Compare to baseline. Note any decline in efficiency.', critical: false },
            { step: 8, action: 'Schedule replacements', detail: 'Plan replacement of worn diffusers.', critical: false }
          ],
          safety: ['Follow confined space procedures if entering basin', 'Ensure proper ventilation'],
          notes: 'Fouled diffusers increase energy use 20-40%. Regular cleaning extends life.'
        }
      ]
    },
    emergency: {
      id: 'emergency',
      name: 'Emergency Procedures',
      icon: 'üö®',
      color: '#ef4444',
      sops: [
        {
          id: 'sop-chlorine-leak',
          title: 'Chlorine Gas Leak Response',
          estimatedTime: 'Immediate',
          frequency: 'As needed',
          steps: [
            { step: 1, action: 'EVACUATE area immediately', detail: 'Move upwind and uphill. Chlorine is heavier than air.', critical: true },
            { step: 2, action: 'Sound alarm', detail: 'Activate emergency alarm. Notify control room.', critical: true },
            { step: 3, action: 'Account for personnel', detail: 'Ensure all staff evacuated. Do not re-enter.', critical: true },
            { step: 4, action: 'Call 911', detail: 'Report chlorine leak. Give location and wind direction.', critical: true },
            { step: 5, action: 'Don SCBA if trained', detail: 'Only trained responders with SCBA may approach.', critical: true },
            { step: 6, action: 'Isolate source', detail: 'If safe, close cylinder valve or switch to backup.', critical: false },
            { step: 7, action: 'Establish perimeter', detail: 'Keep unauthorized persons at least 300 feet away.', critical: true },
            { step: 8, action: 'Document incident', detail: 'Complete incident report. Report to regulatory agency if required.', critical: true }
          ],
          safety: ['NEVER enter chlorine atmosphere without SCBA', 'Ammonia will NOT neutralize chlorine safely', 'Evacuate first, assess later'],
          notes: 'Chlorine exposure: Move to fresh air. Seek medical attention. Even minor exposure requires evaluation.'
        },
        {
          id: 'sop-power-failure',
          title: 'Power Failure Response',
          estimatedTime: 'Immediate',
          frequency: 'As needed',
          steps: [
            { step: 1, action: 'Verify power loss', detail: 'Check if utility power lost or internal issue.', critical: false },
            { step: 2, action: 'Confirm generator start', detail: 'Verify backup generator started automatically.', critical: true },
            { step: 3, action: 'Check critical loads', detail: 'Ensure essential equipment is running: UV/chlorine, blowers, RAS pumps.', critical: true },
            { step: 4, action: 'Notify utility', detail: 'Report outage. Get estimated restoration time.', critical: false },
            { step: 5, action: 'Reduce loads if needed', detail: 'Shed non-essential loads to conserve generator capacity.', critical: false },
            { step: 6, action: 'Monitor fuel level', detail: 'Check generator fuel. Arrange delivery if extended outage.', critical: true },
            { step: 7, action: 'Document timeline', detail: 'Record all events, actions, and times.', critical: true },
            { step: 8, action: 'Prepare for restoration', detail: 'Sequence equipment restart to avoid overloads.', critical: false }
          ],
          safety: ['Do not enter electrical rooms during outage', 'Watch for equipment auto-restart'],
          notes: 'Report bypass/overflow to regulatory agency if treatment interrupted > 24 hours.'
        },
        {
          id: 'sop-high-flow',
          title: 'High Flow / Storm Event',
          estimatedTime: 'Duration of event',
          frequency: 'As needed',
          steps: [
            { step: 1, action: 'Monitor influent flow', detail: 'Track flow rate vs. plant capacity.', critical: true },
            { step: 2, action: 'Increase RAS rate', detail: 'Prevent solids washout by increasing return rate.', critical: true },
            { step: 3, action: 'Start standby equipment', detail: 'Bring online backup pumps, blowers as needed.', critical: false },
            { step: 4, action: 'Check clarifier blankets', detail: 'Watch for rising blankets. Increase WAS if needed.', critical: true },
            { step: 5, action: 'Monitor effluent quality', detail: 'Increase sampling frequency during event.', critical: true },
            { step: 6, action: 'Prepare for equalization', detail: 'Use EQ basin if available to level flow.', critical: false },
            { step: 7, action: 'Document peak flows', detail: 'Record maximum flows and times.', critical: false },
            { step: 8, action: 'Post-storm assessment', detail: 'Inspect plant after event. Note any damage or issues.', critical: true }
          ],
          safety: ['Avoid flooded areas', 'Watch for debris in flow'],
          notes: 'If flow exceeds capacity, contact supervisor and regulatory agency regarding potential bypass.'
        }
      ]
    },
    chemical: {
      id: 'chemical',
      name: 'Chemical Handling',
      icon: '‚öóÔ∏è',
      color: '#14b8a6',
      sops: [
        {
          id: 'sop-chemical-delivery',
          title: 'Chemical Delivery Receiving',
          estimatedTime: '30-45 min',
          frequency: 'As delivered',
          steps: [
            { step: 1, action: 'Verify delivery', detail: 'Confirm truck, driver, and product match order.', critical: true },
            { step: 2, action: 'Check PPE', detail: 'Don appropriate PPE for chemical type (gloves, goggles, apron).', critical: true },
            { step: 3, action: 'Inspect truck', detail: 'Check for leaks, damage, proper placards.', critical: true },
            { step: 4, action: 'Verify tank capacity', detail: 'Ensure receiving tank has room. Prevent overflow.', critical: true },
            { step: 5, action: 'Connect hoses', detail: 'Ensure proper connections. Ground tank truck if required.', critical: true },
            { step: 6, action: 'Monitor transfer', detail: 'Stay with delivery. Watch for leaks or spills.', critical: true },
            { step: 7, action: 'Verify quantity', detail: 'Check final volume matches delivery ticket.', critical: false },
            { step: 8, action: 'Sign paperwork', detail: 'Sign delivery receipt. File with chemical records.', critical: false }
          ],
          safety: ['Review SDS before delivery', 'Know location of spill kit and eyewash', 'Never leave delivery unattended'],
          notes: 'Refuse delivery if any safety concerns. Document refusal and notify supervisor.'
        },
        {
          id: 'sop-polymer-makeup',
          title: 'Polymer Solution Makeup',
          estimatedTime: '45-60 min',
          frequency: 'As needed',
          steps: [
            { step: 1, action: 'Calculate amount needed', detail: 'Determine dry polymer weight for target concentration (typically 0.25-0.5%).', critical: true },
            { step: 2, action: 'Fill tank with water', detail: 'Add approximately 80% of final volume. Start mixer.', critical: false },
            { step: 3, action: 'Slowly add polymer', detail: 'Add polymer gradually to vortex. NEVER dump all at once.', critical: true },
            { step: 4, action: 'Continue mixing', detail: 'Mix for 30-60 minutes until fully hydrated.', critical: true },
            { step: 5, action: 'Top off water level', detail: 'Add remaining water to reach final volume.', critical: false },
            { step: 6, action: 'Age solution', detail: 'Let stand 30-60 minutes before use.', critical: false },
            { step: 7, action: 'Test viscosity', detail: 'Check that solution is smooth, not lumpy.', critical: false },
            { step: 8, action: 'Label tank', detail: 'Record date, time, concentration, operator.', critical: true }
          ],
          safety: ['Polymer is EXTREMELY slippery - clean spills immediately', 'Use non-skid footwear', 'Avoid dust inhalation'],
          notes: 'Solution should be used within 24-48 hours. Overdiluted polymer wastes money and reduces effectiveness.'
        }
      ]
    }
  },

  // Show SOP Library dashboard
  showDashboard() {
    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <!-- Header -->
        <div style="background:linear-gradient(135deg,#059669,#10b981);padding:24px;text-align:center">
          <div style="font-size:40px;margin-bottom:8px">üìñ</div>
          <div style="font-size:20px;font-weight:700;color:white">SOP Library</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.9);margin-top:6px">
            Standard Operating Procedures
          </div>
        </div>

        <!-- Categories -->
        <div style="padding:20px">
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:12px">
    `;

    Object.values(this.procedures).forEach(category => {
      const sopCount = category.sops.length;
      html += `
        <div onclick="SOPLibrary.showCategory('${category.id}')" style="background:rgba(255,255,255,0.05);border:2px solid ${category.color};border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s;text-align:center" onmouseover="this.style.transform='translateY(-3px)';this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.transform='translateY(0)';this.style.background='rgba(255,255,255,0.05)'">
          <div style="font-size:28px;margin-bottom:8px">${category.icon}</div>
          <div style="font-size:13px;font-weight:600;color:white">${category.name}</div>
          <div style="font-size:11px;color:${category.color};margin-top:4px">${sopCount} procedure${sopCount > 1 ? 's' : ''}</div>
        </div>
      `;
    });

    html += `
          </div>

          <!-- Quick Access -->
          <div style="margin-top:20px;padding-top:20px;border-top:1px solid #2d4a6f">
            <div style="font-size:13px;color:#94a3b8;margin-bottom:12px">‚ö° Quick Access - Most Used</div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <div onclick="SOPLibrary.showSOP('daily', 'sop-daily-rounds')" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(59,130,246,0.1);border-radius:8px;cursor:pointer" onmouseover="this.style.background='rgba(59,130,246,0.2)'" onmouseout="this.style.background='rgba(59,130,246,0.1)'">
                <span style="font-size:20px">üìã</span>
                <div>
                  <div style="font-size:13px;font-weight:600;color:white">Daily Plant Rounds</div>
                  <div style="font-size:11px;color:#94a3b8">10 steps ‚Ä¢ 45-60 min</div>
                </div>
              </div>
              <div onclick="SOPLibrary.showSOP('emergency', 'sop-chlorine-leak')" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(239,68,68,0.1);border-radius:8px;cursor:pointer" onmouseover="this.style.background='rgba(239,68,68,0.2)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'">
                <span style="font-size:20px">üö®</span>
                <div>
                  <div style="font-size:13px;font-weight:600;color:white">Chlorine Leak Response</div>
                  <div style="font-size:11px;color:#94a3b8">Emergency ‚Ä¢ 8 steps</div>
                </div>
              </div>
              <div onclick="SOPLibrary.showSOP('daily', 'sop-settleability')" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(20,184,166,0.1);border-radius:8px;cursor:pointer" onmouseover="this.style.background='rgba(20,184,166,0.2)'" onmouseout="this.style.background='rgba(20,184,166,0.1)'">
                <span style="font-size:20px">üß™</span>
                <div>
                  <div style="font-size:13px;font-weight:600;color:white">Settleability Test (SVI)</div>
                  <div style="font-size:11px;color:#94a3b8">Daily ‚Ä¢ 8 steps</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    showModal('üìñ SOP Library', html, { width: '500px' });
  },

  // Show category with list of SOPs
  showCategory(categoryId) {
    const category = this.procedures[categoryId];
    if (!category) return;

    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <!-- Header -->
        <div style="background:${category.color};padding:20px;text-align:center">
          <div style="font-size:36px;margin-bottom:8px">${category.icon}</div>
          <div style="font-size:18px;font-weight:700;color:white">${category.name}</div>
        </div>

        <!-- SOP List -->
        <div style="padding:20px">
          <div style="display:flex;flex-direction:column;gap:10px">
    `;

    category.sops.forEach(sop => {
      html += `
        <div onclick="SOPLibrary.showSOP('${categoryId}', '${sop.id}')" style="display:flex;align-items:center;gap:12px;padding:14px;background:rgba(255,255,255,0.05);border-radius:10px;cursor:pointer;border:1px solid transparent;transition:all 0.2s" onmouseover="this.style.borderColor='${category.color}';this.style.background='rgba(255,255,255,0.08)'" onmouseout="this.style.borderColor='transparent';this.style.background='rgba(255,255,255,0.05)'">
          <div style="width:40px;height:40px;background:${category.color};border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;color:white">${sop.steps.length}</div>
          <div style="flex:1">
            <div style="font-size:14px;font-weight:600;color:white">${sop.title}</div>
            <div style="font-size:12px;color:#94a3b8;margin-top:2px">${sop.frequency} ‚Ä¢ ${sop.estimatedTime}</div>
          </div>
          <div style="color:#64748b;font-size:18px">‚Üí</div>
        </div>
      `;
    });

    html += `
          </div>
          
          <button onclick="SOPLibrary.showDashboard()" style="width:100%;margin-top:16px;padding:12px;background:#374151;border:none;border-radius:8px;color:white;font-size:13px;cursor:pointer">
            ‚Üê Back to Library
          </button>
        </div>
      </div>
    `;

    showModal(`${category.icon} ${category.name}`, html, { width: '450px' });
  },

  // Show individual SOP with steps
  showSOP(categoryId, sopId) {
    const category = this.procedures[categoryId];
    const sop = category?.sops.find(s => s.id === sopId);
    if (!sop) return;

    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <!-- Header -->
        <div style="background:${category.color};padding:16px 20px">
          <div style="font-size:16px;font-weight:700;color:white">${sop.title}</div>
          <div style="font-size:12px;color:rgba(255,255,255,0.8);margin-top:4px">
            ${sop.frequency} ‚Ä¢ ${sop.estimatedTime} ‚Ä¢ ${sop.steps.length} steps
          </div>
        </div>

        <!-- Safety Box -->
        <div style="margin:16px;padding:12px;background:rgba(239,68,68,0.1);border:1px solid #ef4444;border-radius:8px">
          <div style="font-size:12px;font-weight:600;color:#fca5a5;margin-bottom:6px">‚ö†Ô∏è SAFETY REQUIREMENTS</div>
          <ul style="margin:0;padding-left:20px;font-size:12px;color:#fca5a5">
            ${sop.safety.map(s => `<li>${s}</li>`).join('')}
          </ul>
        </div>

        <!-- Steps -->
        <div style="padding:0 16px 16px">
          <div style="font-size:13px;font-weight:600;color:white;margin-bottom:12px">üìã Procedure Steps</div>
          
          <div style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto">
    `;

    sop.steps.forEach(step => {
      const criticalBadge = step.critical ? '<span style="background:#ef4444;color:white;font-size:9px;padding:2px 6px;border-radius:4px;margin-left:8px">CRITICAL</span>' : '';
      html += `
        <div style="display:flex;gap:12px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border-left:3px solid ${step.critical ? '#ef4444' : category.color}">
          <div style="width:28px;height:28px;background:${step.critical ? '#ef4444' : category.color};border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:white;flex-shrink:0">${step.step}</div>
          <div style="flex:1">
            <div style="font-size:13px;font-weight:600;color:white">${step.action}${criticalBadge}</div>
            <div style="font-size:12px;color:#94a3b8;margin-top:4px;line-height:1.4">${step.detail}</div>
          </div>
        </div>
      `;
    });

    html += `
          </div>

          <!-- Notes -->
          <div style="margin-top:16px;padding:12px;background:rgba(59,130,246,0.1);border-radius:8px">
            <div style="font-size:12px;font-weight:600;color:#60a5fa;margin-bottom:4px">üìù Notes</div>
            <div style="font-size:12px;color:#94a3b8">${sop.notes}</div>
          </div>

          <!-- Buttons -->
          <div style="display:flex;gap:8px;margin-top:16px">
            <button onclick="SOPLibrary.showCategory('${categoryId}')" style="flex:1;padding:12px;background:#374151;border:none;border-radius:8px;color:white;font-size:13px;cursor:pointer">
              ‚Üê Back
            </button>
            <button onclick="SOPLibrary.printSOP('${categoryId}', '${sopId}')" style="flex:1;padding:12px;background:${category.color};border:none;border-radius:8px;color:white;font-size:13px;font-weight:600;cursor:pointer">
              üñ®Ô∏è Print
            </button>
          </div>
        </div>
      </div>
    `;

    showModal(`üìñ ${sop.title}`, html, { width: '480px' });
  },

  // Print SOP
  printSOP(categoryId, sopId) {
    const category = this.procedures[categoryId];
    const sop = category?.sops.find(s => s.id === sopId);
    if (!sop) return;

    let printContent = `
      <html>
      <head>
        <title>${sop.title}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
          h1 { color: #1e3a5f; border-bottom: 2px solid #059669; padding-bottom: 10px; }
          .meta { color: #666; margin-bottom: 20px; }
          .safety { background: #fef2f2; border: 1px solid #ef4444; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
          .safety h3 { color: #dc2626; margin-top: 0; }
          .step { display: flex; gap: 15px; padding: 15px; border-bottom: 1px solid #e5e7eb; }
          .step-num { width: 30px; height: 30px; background: #059669; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
          .step.critical .step-num { background: #dc2626; }
          .step-content h4 { margin: 0 0 5px 0; }
          .step-content p { margin: 0; color: #666; }
          .critical-badge { background: #dc2626; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 8px; }
          .notes { background: #eff6ff; padding: 15px; border-radius: 8px; margin-top: 20px; }
          @media print { body { padding: 0; } }
        </style>
      </head>
      <body>
        <h1>${sop.title}</h1>
        <div class="meta">${sop.frequency} ‚Ä¢ ${sop.estimatedTime} ‚Ä¢ ${sop.steps.length} steps</div>
        
        <div class="safety">
          <h3>‚ö†Ô∏è Safety Requirements</h3>
          <ul>
            ${sop.safety.map(s => `<li>${s}</li>`).join('')}
          </ul>
        </div>

        <h2>Procedure Steps</h2>
        ${sop.steps.map(step => `
          <div class="step ${step.critical ? 'critical' : ''}">
            <div class="step-num">${step.step}</div>
            <div class="step-content">
              <h4>${step.action}${step.critical ? '<span class="critical-badge">CRITICAL</span>' : ''}</h4>
              <p>${step.detail}</p>
            </div>
          </div>
        `).join('')}

        <div class="notes">
          <strong>üìù Notes:</strong> ${sop.notes}
        </div>

        <p style="margin-top: 30px; color: #999; font-size: 12px;">
          Generated from WWTP Command Center ‚Ä¢ ${new Date().toLocaleDateString()}
        </p>
      </body>
      </html>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
  }
};

// ===== TRAINING MODE =====
const TrainingMode = {
  // Training state
  active: false,
  currentModule: null,
  progress: {},

  // Training modules - EXPANDED v9.9.16
  modules: {
    basics: {
      id: 'basics',
      name: 'WWTP Fundamentals',
      icon: 'üìö',
      description: 'Core concepts of wastewater treatment',
      lessons: [
        {
          id: 'basics-1',
          title: 'Activated Sludge Process',
          content: `<h4>What is Activated Sludge?</h4>
            <p>Activated sludge is a biological wastewater treatment process that uses microorganisms to break down organic matter.</p>
            <h4>Key Components:</h4>
            <ul>
              <li><strong>Aeration Basin:</strong> Where microorganisms consume organic matter in the presence of oxygen</li>
              <li><strong>Secondary Clarifier:</strong> Separates treated water from biomass (sludge)</li>
              <li><strong>Return Activated Sludge (RAS):</strong> Returns biomass to maintain treatment</li>
              <li><strong>Waste Activated Sludge (WAS):</strong> Removes excess biomass to maintain balance</li>
            </ul>
            <h4>The Process Flow:</h4>
            <p>Influent ‚Üí Primary Treatment ‚Üí Aeration Basin ‚Üí Secondary Clarifier ‚Üí Effluent</p>
            <p>The "activated" part refers to the active, living microorganisms that do the work of treatment.</p>`,
          quiz: [
            {
              question: 'What is the purpose of the aeration basin?',
              options: ['Store wastewater', 'Allow microorganisms to consume organic matter', 'Disinfect water', 'Remove grit'],
              correct: 1
            },
            {
              question: 'What does RAS stand for?',
              options: ['Rapid Aeration System', 'Return Activated Sludge', 'Recirculated Air Supply', 'Residual Ammonia Sampling'],
              correct: 1
            },
            {
              question: 'What makes sludge "activated"?',
              options: ['Chemical treatment', 'Living microorganisms', 'Electrical charge', 'High temperature'],
              correct: 1
            }
          ]
        },
        {
          id: 'basics-2',
          title: 'Understanding MLSS',
          content: `<h4>Mixed Liquor Suspended Solids (MLSS)</h4>
            <p>MLSS represents the concentration of microorganisms in the aeration basin. It's one of the most important parameters to control.</p>
            <h4>Typical Ranges:</h4>
            <ul>
              <li>Conventional: 2,000-3,500 mg/L</li>
              <li>Extended Aeration: 3,000-6,000 mg/L</li>
              <li>High-Rate: 1,500-2,500 mg/L</li>
            </ul>
            <h4>Control Methods:</h4>
            <p>MLSS is controlled by adjusting the Waste Activated Sludge (WAS) rate:</p>
            <ul>
              <li>‚Üë WAS = ‚Üì MLSS (wasting more removes more solids)</li>
              <li>‚Üì WAS = ‚Üë MLSS (wasting less allows solids to build)</li>
            </ul>
            <h4>Why It Matters:</h4>
            <p>Too low MLSS = not enough bugs to treat the waste. Too high = oxygen problems and settling issues.</p>`,
          quiz: [
            {
              question: 'What is the typical MLSS range for conventional activated sludge?',
              options: ['500-1,000 mg/L', '2,000-3,500 mg/L', '8,000-10,000 mg/L', '100-500 mg/L'],
              correct: 1
            },
            {
              question: 'To decrease MLSS, you should:',
              options: ['Decrease WAS rate', 'Increase WAS rate', 'Add chemicals', 'Stop aeration'],
              correct: 1
            },
            {
              question: 'What does MLSS measure?',
              options: ['Water clarity', 'Microorganism concentration', 'Oxygen level', 'pH'],
              correct: 1
            }
          ]
        },
        {
          id: 'basics-3',
          title: 'BOD and COD Explained',
          content: `<h4>Biochemical Oxygen Demand (BOD)</h4>
            <p>BOD measures the amount of oxygen microorganisms need to break down organic matter in 5 days (BOD‚ÇÖ).</p>
            <h4>Chemical Oxygen Demand (COD)</h4>
            <p>COD measures ALL oxidizable material using a strong chemical oxidant. It's faster than BOD testing.</p>
            <h4>Typical Values:</h4>
            <ul>
              <li>Raw Sewage BOD: 200-300 mg/L</li>
              <li>Raw Sewage COD: 400-600 mg/L</li>
              <li>Effluent BOD: <20 mg/L (permit dependent)</li>
              <li>BOD:COD Ratio: ~0.5 for domestic wastewater</li>
            </ul>
            <h4>Relationship:</h4>
            <p>COD is always higher than BOD because it measures both biodegradable AND non-biodegradable organics.</p>`,
          quiz: [
            {
              question: 'BOD‚ÇÖ measures oxygen demand over how many days?',
              options: ['1 day', '3 days', '5 days', '7 days'],
              correct: 2
            },
            {
              question: 'Which is typically higher - BOD or COD?',
              options: ['BOD', 'COD', 'They are equal', 'It varies randomly'],
              correct: 1
            },
            {
              question: 'What is typical raw sewage BOD?',
              options: ['50-100 mg/L', '200-300 mg/L', '500-700 mg/L', '1000+ mg/L'],
              correct: 1
            }
          ]
        },
        {
          id: 'basics-4',
          title: 'Dissolved Oxygen (DO)',
          content: `<h4>What is Dissolved Oxygen?</h4>
            <p>DO is the amount of oxygen dissolved in water, measured in mg/L. Microorganisms need oxygen to survive and treat waste.</p>
            <h4>Target Ranges:</h4>
            <ul>
              <li>Aeration Basin: 1.5-3.0 mg/L</li>
              <li>For Nitrification: >2.0 mg/L</li>
              <li>Anoxic Zones: <0.5 mg/L</li>
              <li>Effluent: >4.0 mg/L (typical permit)</li>
            </ul>
            <h4>DO Control:</h4>
            <p>DO is controlled by adjusting:</p>
            <ul>
              <li>Blower output (airflow)</li>
              <li>Number of blowers running</li>
              <li>Diffuser condition</li>
              <li>VFD speed settings</li>
            </ul>
            <h4>Problems:</h4>
            <ul>
              <li>Low DO: Poor treatment, filaments, odors</li>
              <li>High DO: Wasted energy, pin floc</li>
            </ul>`,
          quiz: [
            {
              question: 'What is the target DO range in an aeration basin?',
              options: ['0.5-1.0 mg/L', '1.5-3.0 mg/L', '5.0-7.0 mg/L', '10+ mg/L'],
              correct: 1
            },
            {
              question: 'What happens if DO is too low?',
              options: ['Better settling', 'Poor treatment and filaments', 'Lower energy use', 'Faster nitrification'],
              correct: 1
            },
            {
              question: 'Minimum DO for nitrification is typically:',
              options: ['0.5 mg/L', '1.0 mg/L', '2.0 mg/L', '4.0 mg/L'],
              correct: 2
            }
          ]
        }
      ]
    },
    process: {
      id: 'process',
      name: 'Process Control',
      icon: '‚öôÔ∏è',
      description: 'Master key process parameters',
      lessons: [
        {
          id: 'process-1',
          title: 'F/M Ratio',
          content: `<h4>Food to Microorganism Ratio</h4>
            <p>The F/M ratio compares the amount of food (BOD) to the amount of microorganisms (MLVSS).</p>
            <h4>Formula:</h4>
            <code style="background:#374151;padding:8px 12px;border-radius:6px;display:block;margin:10px 0">F/M = (Flow √ó BOD √ó 8.34) / (Volume √ó MLVSS √ó 8.34)</code>
            <h4>Typical Ranges:</h4>
            <ul>
              <li>Conventional: 0.2-0.5 lb/lb/d</li>
              <li>Extended Aeration: 0.05-0.15 lb/lb/d</li>
              <li>High-Rate: 0.5-1.5 lb/lb/d</li>
            </ul>
            <h4>Effects:</h4>
            <ul>
              <li><strong>Low F/M:</strong> Good effluent, stable process, but higher O2 demand</li>
              <li><strong>High F/M:</strong> Poor settling, filaments, higher effluent BOD</li>
            </ul>`,
          quiz: [
            {
              question: 'A low F/M ratio typically results in:',
              options: ['Poor settling', 'Better effluent quality', 'Lower oxygen demand', 'Filamentous growth'],
              correct: 1
            },
            {
              question: 'What is the F/M range for extended aeration?',
              options: ['0.5-1.5', '0.2-0.5', '0.05-0.15', '1.0-2.0'],
              correct: 2
            },
            {
              question: 'High F/M ratio can cause:',
              options: ['Great settling', 'Filamentous growth', 'Low effluent BOD', 'Excess oxygen'],
              correct: 1
            }
          ]
        },
        {
          id: 'process-2',
          title: 'Solids Retention Time (SRT)',
          content: `<h4>What is SRT?</h4>
            <p>SRT (also called MCRT or Sludge Age) is the average time microorganisms spend in the system.</p>
            <h4>Formula:</h4>
            <code style="background:#374151;padding:8px 12px;border-radius:6px;display:block;margin:10px 0">SRT = (Volume √ó MLSS) / [(WAS Flow √ó WAS Conc) + (Effluent Flow √ó Effluent TSS)]</code>
            <h4>Why It Matters:</h4>
            <ul>
              <li><strong>Nitrification:</strong> Requires SRT > 8-10 days (longer in cold weather)</li>
              <li><strong>Sludge Settling:</strong> Affected by SRT - both too high and too low cause problems</li>
              <li><strong>Treatment Quality:</strong> Longer SRT = more complete treatment</li>
            </ul>
            <h4>Typical Values:</h4>
            <ul>
              <li>Conventional: 5-15 days</li>
              <li>Extended Aeration: 20-30 days</li>
              <li>Nitrification: 10-20 days</li>
            </ul>`,
          quiz: [
            {
              question: 'What minimum SRT is typically needed for nitrification?',
              options: ['2-3 days', '5-6 days', '8-10 days', '30+ days'],
              correct: 2
            },
            {
              question: 'SRT is controlled by adjusting:',
              options: ['Aeration rate', 'WAS flow rate', 'Influent flow', 'Chemical dosing'],
              correct: 1
            },
            {
              question: 'Another name for SRT is:',
              options: ['Detention time', 'MCRT or Sludge Age', 'Retention ratio', 'Contact time'],
              correct: 1
            }
          ]
        },
        {
          id: 'process-3',
          title: 'Sludge Volume Index (SVI)',
          content: `<h4>What is SVI?</h4>
            <p>SVI measures how well sludge settles. It's the volume occupied by 1 gram of sludge after 30 minutes of settling.</p>
            <h4>Formula:</h4>
            <code style="background:#374151;padding:8px 12px;border-radius:6px;display:block;margin:10px 0">SVI = (Settled Volume mL/L √ó 1000) / MLSS mg/L</code>
            <h4>Interpreting SVI:</h4>
            <ul>
              <li><strong>&lt;80 mL/g:</strong> Excellent settling (old sludge, possible pin floc)</li>
              <li><strong>80-120 mL/g:</strong> Good settling (optimal)</li>
              <li><strong>120-150 mL/g:</strong> Fair settling (monitor closely)</li>
              <li><strong>&gt;150 mL/g:</strong> Poor settling (bulking sludge)</li>
              <li><strong>&gt;200 mL/g:</strong> Severe bulking (immediate action needed)</li>
            </ul>
            <h4>How to Perform the Test:</h4>
            <ol>
              <li>Collect sample from aeration basin</li>
              <li>Fill 1L or 2L settleometer</li>
              <li>Let settle for 30 minutes</li>
              <li>Read settled volume in mL/L</li>
              <li>Calculate SVI using formula</li>
            </ol>`,
          quiz: [
            {
              question: 'What SVI range indicates good settling?',
              options: ['<50 mL/g', '80-120 mL/g', '150-200 mL/g', '>200 mL/g'],
              correct: 1
            },
            {
              question: 'SVI >150 mL/g indicates:',
              options: ['Excellent settling', 'Bulking sludge', 'Young sludge', 'Low MLSS'],
              correct: 1
            },
            {
              question: 'How long should sludge settle for the SVI test?',
              options: ['5 minutes', '15 minutes', '30 minutes', '60 minutes'],
              correct: 2
            }
          ]
        },
        {
          id: 'process-4',
          title: 'RAS and WAS Control',
          content: `<h4>Return Activated Sludge (RAS)</h4>
            <p>RAS returns settled sludge from the clarifier back to the aeration basin to maintain MLSS.</p>
            <h4>RAS Rate Guidelines:</h4>
            <ul>
              <li>Typical: 25-100% of influent flow</li>
              <li>Higher RAS = lower sludge blanket in clarifier</li>
              <li>Adjust based on sludge blanket depth</li>
            </ul>
            <h4>Waste Activated Sludge (WAS)</h4>
            <p>WAS removes excess biomass to maintain target SRT and MLSS.</p>
            <h4>WAS Control Methods:</h4>
            <ul>
              <li><strong>Constant MLSS:</strong> Adjust WAS to maintain target MLSS</li>
              <li><strong>Constant SRT:</strong> Calculate daily WAS based on SRT formula</li>
              <li><strong>Constant F/M:</strong> Adjust WAS to maintain target F/M</li>
            </ul>
            <h4>Key Point:</h4>
            <p>Small changes in WAS have big effects! Adjust gradually (10-15% max change per day).</p>`,
          quiz: [
            {
              question: 'What is the typical RAS rate range?',
              options: ['5-10%', '25-100%', '150-200%', '300-400%'],
              correct: 1
            },
            {
              question: 'Increasing WAS rate will:',
              options: ['Increase MLSS', 'Decrease MLSS', 'Increase DO', 'Decrease flow'],
              correct: 1
            },
            {
              question: 'What is the maximum recommended daily WAS change?',
              options: ['5%', '10-15%', '50%', '100%'],
              correct: 1
            }
          ]
        }
      ]
    },
    nitrification: {
      id: 'nitrification',
      name: 'Nitrification & Denitrification',
      icon: 'üß¨',
      description: 'Biological nutrient removal processes',
      lessons: [
        {
          id: 'nit-1',
          title: 'Nitrification Basics',
          content: `<h4>What is Nitrification?</h4>
            <p>Nitrification is the biological conversion of ammonia (NH‚ÇÉ) to nitrate (NO‚ÇÉ‚Åª) by specialized bacteria.</p>
            <h4>The Two-Step Process:</h4>
            <ol>
              <li><strong>Step 1 - Nitrosomonas:</strong> NH‚ÇÑ‚Å∫ ‚Üí NO‚ÇÇ‚Åª (ammonia to nitrite)</li>
              <li><strong>Step 2 - Nitrobacter:</strong> NO‚ÇÇ‚Åª ‚Üí NO‚ÇÉ‚Åª (nitrite to nitrate)</li>
            </ol>
            <h4>Requirements for Nitrification:</h4>
            <ul>
              <li><strong>DO:</strong> >2.0 mg/L (nitrifiers need lots of oxygen)</li>
              <li><strong>SRT:</strong> >8-10 days (nitrifiers are slow growers)</li>
              <li><strong>pH:</strong> 7.0-8.0 (optimal is 7.2-7.8)</li>
              <li><strong>Alkalinity:</strong> 7.1 mg/L CaCO‚ÇÉ per mg/L NH‚ÇÉ-N oxidized</li>
              <li><strong>Temperature:</strong> >10¬∞C (rate drops significantly in cold)</li>
            </ul>
            <h4>Key Point:</h4>
            <p>Nitrification CONSUMES alkalinity. Monitor and supplement if needed!</p>`,
          quiz: [
            {
              question: 'What bacteria converts ammonia to nitrite?',
              options: ['Nitrobacter', 'Nitrosomonas', 'E. coli', 'Nocardia'],
              correct: 1
            },
            {
              question: 'Minimum DO for nitrification is:',
              options: ['0.5 mg/L', '1.0 mg/L', '2.0 mg/L', '5.0 mg/L'],
              correct: 2
            },
            {
              question: 'How much alkalinity is consumed per mg/L NH‚ÇÉ-N?',
              options: ['1.0 mg/L', '3.5 mg/L', '7.1 mg/L', '15 mg/L'],
              correct: 2
            }
          ]
        },
        {
          id: 'nit-2',
          title: 'Denitrification Process',
          content: `<h4>What is Denitrification?</h4>
            <p>Denitrification converts nitrate (NO‚ÇÉ‚Åª) to nitrogen gas (N‚ÇÇ), which escapes to the atmosphere.</p>
            <h4>The Process:</h4>
            <p>NO‚ÇÉ‚Åª ‚Üí NO‚ÇÇ‚Åª ‚Üí NO ‚Üí N‚ÇÇO ‚Üí N‚ÇÇ (gas)</p>
            <h4>Requirements:</h4>
            <ul>
              <li><strong>Anoxic conditions:</strong> DO <0.5 mg/L (no free oxygen)</li>
              <li><strong>Carbon source:</strong> BOD or methanol as electron donor</li>
              <li><strong>Nitrate present:</strong> From nitrification or recycle</li>
              <li><strong>pH:</strong> 7.0-8.0</li>
            </ul>
            <h4>Benefits of Denitrification:</h4>
            <ul>
              <li>Removes nitrogen from effluent</li>
              <li>Recovers alkalinity (3.57 mg/L per mg/L NO‚ÇÉ-N)</li>
              <li>Reduces oxygen demand</li>
            </ul>
            <h4>Warning:</h4>
            <p>Denitrification in the clarifier causes rising sludge! Keep sludge blanket low.</p>`,
          quiz: [
            {
              question: 'Denitrification requires:',
              options: ['High DO', 'Anoxic conditions (low DO)', 'Aerobic conditions', 'Chlorine'],
              correct: 1
            },
            {
              question: 'What is the end product of denitrification?',
              options: ['Ammonia', 'Nitrite', 'Nitrogen gas', 'Nitrate'],
              correct: 2
            },
            {
              question: 'Denitrification in the clarifier causes:',
              options: ['Better settling', 'Rising sludge', 'Lower pH', 'More foam'],
              correct: 1
            }
          ]
        },
        {
          id: 'nit-3',
          title: 'Troubleshooting Nitrification',
          content: `<h4>High Effluent Ammonia - Common Causes</h4>
            <ul>
              <li><strong>Low SRT:</strong> Nitrifiers washed out - reduce WAS immediately</li>
              <li><strong>Low DO:</strong> Increase aeration to >2.0 mg/L</li>
              <li><strong>Low pH:</strong> Add alkalinity (soda ash or lime)</li>
              <li><strong>Cold Temperature:</strong> Increase SRT in winter</li>
              <li><strong>Toxic shock:</strong> Industrial discharge killed nitrifiers</li>
            </ul>
            <h4>Recovery Time:</h4>
            <p>After losing nitrification, recovery takes 1-3 weeks depending on temperature and cause.</p>
            <h4>Monitoring Tips:</h4>
            <ul>
              <li>Track NH‚ÇÉ, NO‚ÇÇ, NO‚ÇÉ to see where process is failing</li>
              <li>If NO‚ÇÇ accumulates, Nitrobacter is stressed (check pH, temp)</li>
              <li>Monitor alkalinity daily during nitrification problems</li>
            </ul>
            <h4>Prevention:</h4>
            <p>Maintain adequate SRT buffer (2-3 days above minimum) especially before winter.</p>`,
          quiz: [
            {
              question: 'First action when nitrification fails:',
              options: ['Add chlorine', 'Reduce WAS rate', 'Increase WAS rate', 'Add polymer'],
              correct: 1
            },
            {
              question: 'Nitrite accumulation indicates:',
              options: ['Nitrosomonas stressed', 'Nitrobacter stressed', 'Complete failure', 'Good operation'],
              correct: 1
            },
            {
              question: 'How long does nitrification recovery typically take?',
              options: ['1-2 days', '1-3 weeks', '3-6 months', '1 year'],
              correct: 1
            }
          ]
        }
      ]
    },
    clarifier: {
      id: 'clarifier',
      name: 'Clarifier Operations',
      icon: 'üåÄ',
      description: 'Secondary clarifier management',
      lessons: [
        {
          id: 'clar-1',
          title: 'Clarifier Fundamentals',
          content: `<h4>Purpose of Secondary Clarifiers</h4>
            <p>Secondary clarifiers separate treated water (effluent) from biomass (sludge) through gravity settling.</p>
            <h4>Key Design Parameters:</h4>
            <ul>
              <li><strong>Surface Overflow Rate (SOR):</strong> Flow √∑ Surface Area</li>
              <li><strong>Solids Loading Rate (SLR):</strong> (Flow √ó MLSS) √∑ Surface Area</li>
              <li><strong>Weir Overflow Rate (WOR):</strong> Flow √∑ Weir Length</li>
            </ul>
            <h4>Typical Limits:</h4>
            <ul>
              <li>SOR: 400-800 gpd/sf (average), 1000-1200 gpd/sf (peak)</li>
              <li>SLR: 20-30 lb/sf/day</li>
              <li>WOR: 10,000-20,000 gpd/ft</li>
            </ul>
            <h4>Components:</h4>
            <ul>
              <li>Center feed well - distributes flow evenly</li>
              <li>Rake mechanism - moves sludge to center</li>
              <li>Sludge hopper - collects settled sludge</li>
              <li>Weirs - control effluent discharge</li>
              <li>Scum baffle and skimmer - remove floating material</li>
            </ul>`,
          quiz: [
            {
              question: 'What does SOR stand for?',
              options: ['Sludge Overflow Rate', 'Surface Overflow Rate', 'Solids Operating Ratio', 'Standard Operation Rate'],
              correct: 1
            },
            {
              question: 'Typical average SOR limit is:',
              options: ['100-200 gpd/sf', '400-800 gpd/sf', '2000-3000 gpd/sf', '5000+ gpd/sf'],
              correct: 1
            },
            {
              question: 'The rake mechanism moves sludge to the:',
              options: ['Weirs', 'Center hopper', 'Outside wall', 'Scum baffle'],
              correct: 1
            }
          ]
        },
        {
          id: 'clar-2',
          title: 'Sludge Blanket Management',
          content: `<h4>What is the Sludge Blanket?</h4>
            <p>The sludge blanket is the layer of settling solids in the clarifier. Proper management is critical.</p>
            <h4>Target Depth:</h4>
            <ul>
              <li>Normal: 1-3 feet from bottom</li>
              <li>Never exceed 50% of side water depth</li>
              <li>Keep at least 2-3 feet of clear water above blanket</li>
            </ul>
            <h4>Measurement Methods:</h4>
            <ul>
              <li>Core sampler (Sludge Judge)</li>
              <li>Portable sonar/ultrasonic</li>
              <li>Fixed blanket level sensors</li>
            </ul>
            <h4>Control:</h4>
            <ul>
              <li><strong>Blanket too high:</strong> Increase RAS rate</li>
              <li><strong>Blanket too low:</strong> Decrease RAS rate</li>
              <li><strong>Rising sludge:</strong> Denitrification occurring - increase RAS</li>
            </ul>
            <h4>Frequency:</h4>
            <p>Check sludge blanket at least once per shift, more often during high flows.</p>`,
          quiz: [
            {
              question: 'Target sludge blanket depth is typically:',
              options: ['0-6 inches', '1-3 feet', '5-8 feet', '10+ feet'],
              correct: 1
            },
            {
              question: 'To lower a high sludge blanket:',
              options: ['Decrease RAS', 'Increase RAS', 'Stop WAS', 'Add polymer'],
              correct: 1
            },
            {
              question: 'How often should sludge blanket be checked?',
              options: ['Weekly', 'Daily', 'At least once per shift', 'Monthly'],
              correct: 2
            }
          ]
        },
        {
          id: 'clar-3',
          title: 'Clarifier Troubleshooting',
          content: `<h4>Common Clarifier Problems</h4>
            <h4>1. Rising Sludge (Clumping/Floating)</h4>
            <ul>
              <li><strong>Cause:</strong> Denitrification producing N‚ÇÇ gas</li>
              <li><strong>Solution:</strong> Increase RAS, reduce blanket depth, add anoxic zone upstream</li>
            </ul>
            <h4>2. Billowing/Rolling Sludge</h4>
            <ul>
              <li><strong>Cause:</strong> Density currents, hydraulic overload</li>
              <li><strong>Solution:</strong> Check for short-circuiting, adjust baffles</li>
            </ul>
            <h4>3. High Effluent TSS</h4>
            <ul>
              <li><strong>Causes:</strong> Bulking sludge, hydraulic overload, pin floc</li>
              <li><strong>Solutions:</strong> Address SVI issues, verify SOR within limits</li>
            </ul>
            <h4>4. Scum Accumulation</h4>
            <ul>
              <li><strong>Cause:</strong> FOG, Nocardia foam, inadequate skimming</li>
              <li><strong>Solution:</strong> Increase skimmer frequency, check scum beach</li>
            </ul>
            <h4>5. Torque Alarms</h4>
            <ul>
              <li><strong>Cause:</strong> Heavy sludge, debris, mechanical issues</li>
              <li><strong>Solution:</strong> Increase RAS, check for rags/debris</li>
            </ul>`,
          quiz: [
            {
              question: 'Rising sludge in clarifier is usually caused by:',
              options: ['High BOD', 'Denitrification', 'Low MLSS', 'High pH'],
              correct: 1
            },
            {
              question: 'High clarifier torque may indicate:',
              options: ['Good operation', 'Heavy sludge or debris', 'Low RAS', 'Clean clarifier'],
              correct: 1
            },
            {
              question: 'First response to rising sludge:',
              options: ['Add chlorine', 'Increase RAS rate', 'Stop aeration', 'Add polymer'],
              correct: 1
            }
          ]
        }
      ]
    },
    chemical: {
      id: 'chemical',
      name: 'Chemical Systems',
      icon: 'üß™',
      description: 'Chemical handling and dosing',
      lessons: [
        {
          id: 'chem-1',
          title: 'Chlorine Disinfection',
          content: `<h4>Chlorine Disinfection</h4>
            <p>Chlorine kills pathogens in effluent before discharge.</p>
            <h4>Forms of Chlorine:</h4>
            <ul>
              <li><strong>Gas (Cl‚ÇÇ):</strong> Most economical but most hazardous</li>
              <li><strong>Sodium Hypochlorite (NaOCl):</strong> 12-15% liquid bleach</li>
              <li><strong>Calcium Hypochlorite:</strong> Solid tablets or granules</li>
            </ul>
            <h4>Dosing Calculation:</h4>
            <code style="background:#374151;padding:8px 12px;border-radius:6px;display:block;margin:10px 0">lb/day = Flow (MGD) √ó Dose (mg/L) √ó 8.34</code>
            <h4>Key Parameters:</h4>
            <ul>
              <li><strong>Contact Time (CT):</strong> Residual √ó Time (typically 15-30 min)</li>
              <li><strong>Residual:</strong> 0.5-2.0 mg/L after contact time</li>
              <li><strong>Breakpoint:</strong> Dose where all ammonia is oxidized</li>
            </ul>
            <h4>Safety:</h4>
            <p>‚ö†Ô∏è NEVER mix chlorine with ammonia or acids - produces toxic gases!</p>`,
          quiz: [
            {
              question: 'Most economical but hazardous form of chlorine:',
              options: ['Sodium hypochlorite', 'Calcium hypochlorite', 'Chlorine gas', 'Chlorine dioxide'],
              correct: 2
            },
            {
              question: 'Typical chlorine contact time is:',
              options: ['1-2 minutes', '15-30 minutes', '2-4 hours', '24 hours'],
              correct: 1
            },
            {
              question: 'Never mix chlorine with:',
              options: ['Water', 'Ammonia or acids', 'Air', 'Sludge'],
              correct: 1
            }
          ]
        },
        {
          id: 'chem-2',
          title: 'pH and Alkalinity Control',
          content: `<h4>pH Control</h4>
            <p>pH affects biological treatment efficiency. Target: 6.5-8.5 (optimal 7.0-7.5).</p>
            <h4>To Raise pH (add alkalinity):</h4>
            <ul>
              <li><strong>Sodium Hydroxide (NaOH):</strong> Fast acting, expensive</li>
              <li><strong>Lime (Ca(OH)‚ÇÇ):</strong> Economical, adds hardness</li>
              <li><strong>Soda Ash (Na‚ÇÇCO‚ÇÉ):</strong> Moderate cost, good buffer</li>
              <li><strong>Magnesium Hydroxide:</strong> Safe, slow release</li>
            </ul>
            <h4>To Lower pH:</h4>
            <ul>
              <li><strong>Sulfuric Acid (H‚ÇÇSO‚ÇÑ):</strong> Most common</li>
              <li><strong>Carbon Dioxide:</strong> Safer, forms carbonic acid</li>
            </ul>
            <h4>Alkalinity:</h4>
            <p>Buffer capacity measured as mg/L CaCO‚ÇÉ. Minimum 50-100 mg/L for stable operation.</p>
            <h4>Key Relationship:</h4>
            <p>Nitrification consumes 7.1 mg/L alkalinity per mg/L NH‚ÇÉ-N oxidized!</p>`,
          quiz: [
            {
              question: 'Optimal pH range for activated sludge:',
              options: ['5.0-6.0', '7.0-7.5', '9.0-10.0', '4.0-5.0'],
              correct: 1
            },
            {
              question: 'Which chemical is used to raise pH?',
              options: ['Sulfuric acid', 'Sodium hydroxide', 'Carbon dioxide', 'Chlorine'],
              correct: 1
            },
            {
              question: 'Minimum alkalinity for stable operation:',
              options: ['10-20 mg/L', '50-100 mg/L', '200-300 mg/L', '500+ mg/L'],
              correct: 1
            }
          ]
        },
        {
          id: 'chem-3',
          title: 'Phosphorus Removal',
          content: `<h4>Chemical Phosphorus Removal</h4>
            <p>Metal salts precipitate phosphorus as insoluble compounds.</p>
            <h4>Common Chemicals:</h4>
            <ul>
              <li><strong>Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ):</strong> Most common, effective</li>
              <li><strong>Ferric Chloride (FeCl‚ÇÉ):</strong> Also removes H‚ÇÇS</li>
              <li><strong>Ferrous Sulfate (FeSO‚ÇÑ):</strong> Economical, needs oxygen</li>
              <li><strong>Poly Aluminum Chloride (PAC):</strong> Pre-hydrolyzed, less pH impact</li>
            </ul>
            <h4>Dosing Ratios:</h4>
            <ul>
              <li>Alum: 1.5-3.0 mole Al per mole P (typically 15-25:1 by weight)</li>
              <li>Iron: 1.5-2.5 mole Fe per mole P</li>
            </ul>
            <h4>Feed Points:</h4>
            <ul>
              <li><strong>Primary:</strong> Helps settling, higher dose needed</li>
              <li><strong>Secondary:</strong> Most efficient for low effluent P</li>
              <li><strong>Tertiary:</strong> Polishing for very low limits</li>
            </ul>
            <h4>Side Effects:</h4>
            <p>Increases sludge production 20-30%. May lower pH and alkalinity.</p>`,
          quiz: [
            {
              question: 'Most common chemical for P removal:',
              options: ['Chlorine', 'Alum', 'Polymer', 'Lime'],
              correct: 1
            },
            {
              question: 'Typical alum dose ratio (Al:P by weight):',
              options: ['1:1', '5:1', '15-25:1', '100:1'],
              correct: 2
            },
            {
              question: 'Chemical P removal increases sludge production by:',
              options: ['0%', '5-10%', '20-30%', '100%'],
              correct: 2
            }
          ]
        },
        {
          id: 'chem-4',
          title: 'Polymer Applications',
          content: `<h4>What are Polymers?</h4>
            <p>Polymers are long-chain molecules that help particles stick together (flocculation).</p>
            <h4>Types:</h4>
            <ul>
              <li><strong>Cationic (+):</strong> Most common for sludge - attracts negative particles</li>
              <li><strong>Anionic (-):</strong> Used with metal coagulants</li>
              <li><strong>Nonionic:</strong> Specialty applications</li>
            </ul>
            <h4>Applications:</h4>
            <ul>
              <li><strong>Dewatering:</strong> Belt press, centrifuge (8-15 lb/DT)</li>
              <li><strong>Thickening:</strong> DAF, gravity belt (2-5 lb/DT)</li>
              <li><strong>Clarifier aid:</strong> Improve settling (0.5-2 mg/L)</li>
            </ul>
            <h4>Mixing Tips:</h4>
            <ul>
              <li>Always add polymer to water (not water to polymer)</li>
              <li>Mix gently - high shear breaks polymer chains</li>
              <li>Age solution 30-60 minutes before use</li>
              <li>Use within 24-48 hours</li>
            </ul>
            <h4>Jar Testing:</h4>
            <p>Always jar test to optimize dose - overdosing wastes money and can cause problems!</p>`,
          quiz: [
            {
              question: 'Most common polymer type for sludge dewatering:',
              options: ['Anionic', 'Cationic', 'Nonionic', 'Neutral'],
              correct: 1
            },
            {
              question: 'Typical polymer dose for belt press:',
              options: ['0.5-1 lb/DT', '8-15 lb/DT', '50-100 lb/DT', '200+ lb/DT'],
              correct: 1
            },
            {
              question: 'Polymer solution should be used within:',
              options: ['1 hour', '24-48 hours', '1 week', '1 month'],
              correct: 1
            }
          ]
        }
      ]
    },
    troubleshoot: {
      id: 'troubleshoot',
      name: 'Troubleshooting',
      icon: 'üîß',
      description: 'Diagnose and solve common problems',
      lessons: [
        {
          id: 'trouble-1',
          title: 'Bulking Sludge',
          content: `<h4>Identifying Bulking Sludge</h4>
            <p>Bulking occurs when filamentous bacteria overgrow, causing poor settling.</p>
            <h4>Symptoms:</h4>
            <ul>
              <li>SVI > 150 mL/g</li>
              <li>Rising sludge blanket in clarifier</li>
              <li>Effluent TSS increasing</li>
              <li>Poor compaction of settled sludge</li>
            </ul>
            <h4>Common Causes:</h4>
            <ul>
              <li>Low DO (< 1.5 mg/L)</li>
              <li>Low F/M ratio</li>
              <li>Nutrient deficiency (N or P)</li>
              <li>Septic conditions in collection system</li>
              <li>Industrial discharge</li>
            </ul>
            <h4>Solutions:</h4>
            <ul>
              <li>Increase DO to 2.0-2.5 mg/L</li>
              <li>Adjust F/M (increase wasting)</li>
              <li>Add nutrients if needed</li>
              <li>Chlorinate RAS (5-10 mg/L) as last resort</li>
            </ul>
            <h4>Long-term Fix:</h4>
            <p>Install selector zone to favor floc-formers over filaments.</p>`,
          quiz: [
            {
              question: 'What SVI level indicates bulking sludge?',
              options: ['< 50 mL/g', '50-100 mL/g', '> 150 mL/g', '100-120 mL/g'],
              correct: 2
            },
            {
              question: 'Which is NOT a common cause of bulking?',
              options: ['Low DO', 'Low F/M', 'High alkalinity', 'Nutrient deficiency'],
              correct: 2
            },
            {
              question: 'RAS chlorination dose for bulking control:',
              options: ['0.5-1 mg/L', '5-10 mg/L', '50-100 mg/L', '200+ mg/L'],
              correct: 1
            }
          ]
        },
        {
          id: 'trouble-2',
          title: 'Foam and Scum Problems',
          content: `<h4>Types of Foam</h4>
            <h4>1. White Billowy Foam</h4>
            <ul>
              <li><strong>Cause:</strong> Young sludge, low MLSS, surfactants</li>
              <li><strong>Solution:</strong> Build MLSS, check for detergent discharge</li>
            </ul>
            <h4>2. Brown/Tan Thick Foam (Nocardia)</h4>
            <ul>
              <li><strong>Cause:</strong> Long SRT, warm temps, FOG</li>
              <li><strong>Solution:</strong> Reduce SRT to 5-8 days, improve FOG removal</li>
            </ul>
            <h4>3. Dark Brown/Black Foam</h4>
            <ul>
              <li><strong>Cause:</strong> Old/septic sludge, Microthrix</li>
              <li><strong>Solution:</strong> Increase wasting, check for septic inputs</li>
            </ul>
            <h4>Control Methods:</h4>
            <ul>
              <li>Water spray to break foam</li>
              <li>Chlorine spray (dilute)</li>
              <li>Anti-foam chemicals</li>
              <li>Adjust SRT (most effective)</li>
            </ul>
            <h4>Key Point:</h4>
            <p>Identify the foam type first! Different foams need different solutions.</p>`,
          quiz: [
            {
              question: 'Nocardia foam is typically:',
              options: ['White and thin', 'Brown/tan and thick', 'Clear', 'Green'],
              correct: 1
            },
            {
              question: 'Best long-term solution for Nocardia:',
              options: ['Add chlorine', 'Reduce SRT', 'Increase aeration', 'Add polymer'],
              correct: 1
            },
            {
              question: 'White billowy foam usually indicates:',
              options: ['Old sludge', 'Young sludge or surfactants', 'Good operation', 'High SRT'],
              correct: 1
            }
          ]
        },
        {
          id: 'trouble-3',
          title: 'High Effluent TSS',
          content: `<h4>Causes of High Effluent TSS</h4>
            <h4>1. Hydraulic Problems</h4>
            <ul>
              <li>Flow exceeds clarifier capacity (check SOR)</li>
              <li>Short-circuiting in clarifier</li>
              <li>Uneven weir levels</li>
            </ul>
            <h4>2. Biological Problems</h4>
            <ul>
              <li>Bulking sludge (high SVI)</li>
              <li>Pin floc (over-aeration or toxicity)</li>
              <li>Rising sludge (denitrification)</li>
              <li>Straggler floc (incomplete flocculation)</li>
            </ul>
            <h4>3. Operational Problems</h4>
            <ul>
              <li>High sludge blanket</li>
              <li>Improper RAS rate</li>
              <li>Rake mechanism issues</li>
            </ul>
            <h4>Diagnostic Steps:</h4>
            <ol>
              <li>Check SVI - is sludge settling properly?</li>
              <li>Measure sludge blanket depth</li>
              <li>Verify clarifier SOR is within limits</li>
              <li>Look at effluent under microscope</li>
              <li>Check for rising/floating sludge</li>
            </ol>`,
          quiz: [
            {
              question: 'First thing to check with high effluent TSS:',
              options: ['Add polymer', 'Check SVI and settling', 'Increase WAS', 'Add chlorine'],
              correct: 1
            },
            {
              question: 'Pin floc can be caused by:',
              options: ['Under-aeration', 'Over-aeration or toxicity', 'Low F/M', 'High MLSS'],
              correct: 1
            },
            {
              question: 'Rising sludge in clarifier indicates:',
              options: ['Good settling', 'Denitrification', 'Low SRT', 'High F/M'],
              correct: 1
            }
          ]
        }
      ]
    },
    safety: {
      id: 'safety',
      name: 'Safety & Compliance',
      icon: '‚ö†Ô∏è',
      description: 'Stay safe and meet regulations',
      lessons: [
        {
          id: 'safe-1',
          title: 'Confined Space Entry',
          content: `<h4>Confined Space Hazards</h4>
            <p>WWTPs have many confined spaces: tanks, manholes, wet wells, digesters.</p>
            <h4>Before Entry - ALWAYS:</h4>
            <ol>
              <li>Get confined space permit signed</li>
              <li>Test atmosphere: O‚ÇÇ, LEL, H‚ÇÇS, CO</li>
              <li>Ventilate space continuously</li>
              <li>Have trained attendant at entry</li>
              <li>Rescue plan and equipment ready</li>
              <li>Lock out/tag out all equipment</li>
            </ol>
            <h4>Atmospheric Hazards:</h4>
            <ul>
              <li><strong>O‚ÇÇ:</strong> Must be 19.5-23.5% (normal is 20.9%)</li>
              <li><strong>H‚ÇÇS:</strong> <10 ppm (immediately dangerous at 100 ppm)</li>
              <li><strong>LEL:</strong> <10% of lower explosive limit</li>
              <li><strong>CO:</strong> <25 ppm</li>
            </ul>
            <h4>Key Rule:</h4>
            <p>‚ö†Ô∏è NEVER enter a confined space without proper training, equipment, and procedures!</p>`,
          quiz: [
            {
              question: 'Safe oxygen level range is:',
              options: ['10-15%', '19.5-23.5%', '25-30%', '30-40%'],
              correct: 1
            },
            {
              question: 'H‚ÇÇS immediately dangerous level:',
              options: ['10 ppm', '50 ppm', '100 ppm', '500 ppm'],
              correct: 2
            },
            {
              question: 'Before confined space entry, you must:',
              options: ['Just look inside', 'Test atmosphere and get permit', 'Only need flashlight', 'Enter quickly'],
              correct: 1
            }
          ]
        },
        {
          id: 'safe-2',
          title: 'Chemical Safety',
          content: `<h4>Chemical Handling Safety</h4>
            <h4>Before Handling Any Chemical:</h4>
            <ul>
              <li>Read the SDS (Safety Data Sheet)</li>
              <li>Wear proper PPE</li>
              <li>Know location of eyewash/shower</li>
              <li>Understand emergency procedures</li>
            </ul>
            <h4>Common WWTP Chemical Hazards:</h4>
            <ul>
              <li><strong>Chlorine gas:</strong> Toxic, requires SCBA for response</li>
              <li><strong>Sodium hypochlorite:</strong> Corrosive, never mix with acids</li>
              <li><strong>Sulfuric acid:</strong> Severe burns, add acid to water (not water to acid)</li>
              <li><strong>Sodium hydroxide:</strong> Caustic burns, slippery when wet</li>
              <li><strong>Polymer:</strong> Extremely slippery, fall hazard</li>
            </ul>
            <h4>Incompatible Chemicals:</h4>
            <ul>
              <li>Chlorine + Ammonia = Toxic chloramine gas</li>
              <li>Chlorine + Acid = Toxic chlorine gas</li>
              <li>Oxidizers + Organics = Fire/explosion risk</li>
            </ul>
            <h4>Spill Response:</h4>
            <p>Know your plant's spill response procedures before you need them!</p>`,
          quiz: [
            {
              question: 'Before handling chemicals, first:',
              options: ['Just start working', 'Read the SDS', 'Ask a coworker', 'Smell it'],
              correct: 1
            },
            {
              question: 'When diluting acid:',
              options: ['Add water to acid', 'Add acid to water', 'Mix equally', 'Heat first'],
              correct: 1
            },
            {
              question: 'Chlorine mixed with ammonia produces:',
              options: ['Clean water', 'Toxic chloramine gas', 'Salt', 'Oxygen'],
              correct: 1
            }
          ]
        }
      ]
    },
    // NEW MODULE: Advanced Certification Prep
    certification: {
      id: 'certification',
      name: 'Certification Prep',
      icon: 'üèÜ',
      description: 'Prepare for state operator certification exams',
      lessons: [
        {
          id: 'cert-1',
          title: 'Exam Overview & Study Tips',
          content: `<h4>Certification Levels</h4>
            <p>Most states have 4 levels of wastewater operator certification:</p>
            <ul>
              <li><strong>Class D/I:</strong> Entry level - small systems, basic operations</li>
              <li><strong>Class C/II:</strong> Intermediate - medium systems, routine decisions</li>
              <li><strong>Class B/III:</strong> Advanced - large systems, complex decisions</li>
              <li><strong>Class A/IV:</strong> Expert - any system, supervisory roles</li>
            </ul>
            <h4>Exam Format:</h4>
            <ul>
              <li>Multiple choice questions (50-150 depending on level)</li>
              <li>Math calculations (25-40% of exam)</li>
              <li>Process knowledge questions</li>
              <li>Regulations and safety</li>
            </ul>
            <h4>Study Tips:</h4>
            <ul>
              <li>Start 3-6 months before exam date</li>
              <li>Focus on YOUR state's specific requirements</li>
              <li>Practice math problems daily</li>
              <li>Review actual plant data and logs</li>
              <li>Take practice exams under timed conditions</li>
            </ul>
            <h4>Required Experience:</h4>
            <p>Each level typically requires 1-4 years of operating experience. Check your state's specific requirements.</p>`,
          quiz: [
            {
              question: 'What percentage of certification exams is typically math?',
              options: ['5-10%', '25-40%', '60-75%', '90-100%'],
              correct: 1
            },
            {
              question: 'How far in advance should you start studying?',
              options: ['1 week', '3-6 months', '1 day', '5 years'],
              correct: 1
            },
            {
              question: 'Which is the highest certification level?',
              options: ['Class D', 'Class C', 'Class B', 'Class A'],
              correct: 3
            }
          ]
        },
        {
          id: 'cert-2',
          title: 'Essential Math Formulas',
          content: `<h4>Must-Know Formulas for Certification</h4>
            <h4>Flow Calculations:</h4>
            <ul>
              <li><strong>Flow (MGD)</strong> = Volume (gal) √∑ Time (days)</li>
              <li><strong>Detention Time (hr)</strong> = Volume (gal) √ó 24 √∑ Flow (gpd)</li>
              <li><strong>Surface Overflow Rate</strong> = Flow (gpd) √∑ Area (sq ft)</li>
            </ul>
            <h4>Loading Calculations:</h4>
            <ul>
              <li><strong>lbs/day</strong> = Flow (MGD) √ó Conc (mg/L) √ó 8.34</li>
              <li><strong>F/M Ratio</strong> = BOD Load (lb/d) √∑ MLSS (lb)</li>
              <li><strong>MCRT (days)</strong> = MLSS (lb) √∑ WAS (lb/day)</li>
            </ul>
            <h4>Solids Calculations:</h4>
            <ul>
              <li><strong>SVI</strong> = Settled Volume (mL/L) √ó 1000 √∑ MLSS (mg/L)</li>
              <li><strong>% Solids</strong> = Dry Weight √∑ Total Weight √ó 100</li>
              <li><strong>Sludge Volume Index</strong> = mL settled in 30 min √∑ MLSS (g)</li>
            </ul>
            <h4>Chemical Dosing:</h4>
            <ul>
              <li><strong>Dose (lb/day)</strong> = Flow (MGD) √ó Dose (mg/L) √ó 8.34</li>
              <li><strong>Feed Rate (gpd)</strong> = lb/day √∑ (8.34 √ó solution strength)</li>
            </ul>
            <h4>Key Number: 8.34 lb/gal = weight of 1 gallon of water</h4>`,
          quiz: [
            {
              question: 'What is the weight of one gallon of water?',
              options: ['6.24 lb', '7.48 lb', '8.34 lb', '10.0 lb'],
              correct: 2
            },
            {
              question: 'F/M ratio equals BOD load divided by:',
              options: ['Flow', 'Volume', 'MLSS mass', 'Time'],
              correct: 2
            },
            {
              question: 'To calculate lbs/day: Flow (MGD) √ó Conc (mg/L) √ó ___',
              options: ['7.48', '8.34', '3.785', '62.4'],
              correct: 1
            }
          ]
        },
        {
          id: 'cert-3',
          title: 'Regulations & Permits',
          content: `<h4>Clean Water Act (CWA)</h4>
            <p>The foundation of US water quality regulations, establishing the NPDES permit system.</p>
            <h4>NPDES Permits:</h4>
            <ul>
              <li>National Pollutant Discharge Elimination System</li>
              <li>Required for any discharge to surface water</li>
              <li>Sets effluent limits (daily max, monthly average)</li>
              <li>Requires monitoring and reporting (DMRs)</li>
              <li>Renewed every 5 years</li>
            </ul>
            <h4>Common Permit Limits:</h4>
            <ul>
              <li><strong>BOD‚ÇÖ:</strong> 30 mg/L monthly avg (secondary treatment)</li>
              <li><strong>TSS:</strong> 30 mg/L monthly avg</li>
              <li><strong>pH:</strong> 6.0-9.0 range</li>
              <li><strong>Ammonia:</strong> Site-specific, often seasonal</li>
              <li><strong>Chlorine residual:</strong> Often <0.1 mg/L</li>
            </ul>
            <h4>Reporting Requirements:</h4>
            <ul>
              <li>DMRs (Discharge Monitoring Reports) - monthly/quarterly</li>
              <li>SSO (Sanitary Sewer Overflow) reports - within 24 hours</li>
              <li>Bypass/upset reports - within 24 hours</li>
              <li>Annual reports</li>
            </ul>
            <h4>Penalties:</h4>
            <p>Violations can result in fines up to $50,000/day and criminal charges for willful violations.</p>`,
          quiz: [
            {
              question: 'NPDES permits are renewed every:',
              options: ['1 year', '3 years', '5 years', '10 years'],
              correct: 2
            },
            {
              question: 'Secondary treatment BOD limit is typically:',
              options: ['10 mg/L', '30 mg/L', '100 mg/L', '200 mg/L'],
              correct: 1
            },
            {
              question: 'SSO reports must be filed within:',
              options: ['1 hour', '24 hours', '7 days', '30 days'],
              correct: 1
            }
          ]
        },
        {
          id: 'cert-4',
          title: 'Practice Math Problems',
          content: `<h4>Work Through These Problems</h4>
            <h4>Problem 1: Detention Time</h4>
            <p>A tank has a volume of 500,000 gallons and receives a flow of 2.0 MGD. What is the detention time in hours?</p>
            <p><strong>Solution:</strong> DT = (500,000 gal √ó 24 hr) √∑ 2,000,000 gpd = <strong>6 hours</strong></p>
            
            <h4>Problem 2: Chemical Dosing</h4>
            <p>Calculate lbs/day of chlorine needed to dose 3.5 MGD at 2.0 mg/L.</p>
            <p><strong>Solution:</strong> lbs/day = 3.5 √ó 2.0 √ó 8.34 = <strong>58.4 lbs/day</strong></p>
            
            <h4>Problem 3: SVI Calculation</h4>
            <p>A settleability test shows 250 mL/L after 30 minutes. MLSS is 2,500 mg/L. Calculate SVI.</p>
            <p><strong>Solution:</strong> SVI = (250 √ó 1000) √∑ 2500 = <strong>100 mL/g</strong></p>
            
            <h4>Problem 4: F/M Ratio</h4>
            <p>BOD load is 4,500 lbs/day. Aeration tank MLSS is 15,000 lbs. Calculate F/M.</p>
            <p><strong>Solution:</strong> F/M = 4500 √∑ 15000 = <strong>0.30 lb BOD/lb MLSS/day</strong></p>
            
            <h4>Problem 5: WAS Rate</h4>
            <p>Target SRT is 10 days. Total MLSS inventory is 80,000 lbs. Calculate daily WAS.</p>
            <p><strong>Solution:</strong> WAS = 80,000 √∑ 10 = <strong>8,000 lbs/day</strong></p>`,
          quiz: [
            {
              question: 'A 1.0 MG tank with 3.0 MGD flow has what detention time?',
              options: ['3 hours', '6 hours', '8 hours', '12 hours'],
              correct: 2
            },
            {
              question: '2.0 MGD √ó 5.0 mg/L √ó 8.34 = ?',
              options: ['10.0 lbs/day', '41.7 lbs/day', '83.4 lbs/day', '167 lbs/day'],
              correct: 2
            },
            {
              question: 'MLSS 3000 mg/L, settled 300 mL/L. SVI = ?',
              options: ['50 mL/g', '100 mL/g', '150 mL/g', '300 mL/g'],
              correct: 1
            }
          ]
        }
      ]
    },
    // NEW MODULE: Advanced Process Control
    advanced: {
      id: 'advanced',
      name: 'Advanced Control',
      icon: 'üéõÔ∏è',
      description: 'Advanced process control strategies',
      lessons: [
        {
          id: 'adv-1',
          title: 'Biological Nutrient Removal',
          content: `<h4>BNR Process Overview</h4>
            <p>Biological Nutrient Removal targets nitrogen and phosphorus beyond basic treatment.</p>
            <h4>Nitrogen Removal:</h4>
            <ul>
              <li><strong>Nitrification:</strong> NH‚ÇÉ ‚Üí NO‚ÇÇ ‚Üí NO‚ÇÉ (requires oxygen)</li>
              <li><strong>Denitrification:</strong> NO‚ÇÉ ‚Üí N‚ÇÇ gas (requires anoxic conditions)</li>
            </ul>
            <h4>Nitrification Requirements:</h4>
            <ul>
              <li>DO > 2.0 mg/L</li>
              <li>pH 7.0-8.5 (optimal 7.5)</li>
              <li>Temperature > 15¬∞C</li>
              <li>SRT > 10 days (longer in cold weather)</li>
              <li>Alkalinity > 100 mg/L as CaCO‚ÇÉ</li>
            </ul>
            <h4>Denitrification Requirements:</h4>
            <ul>
              <li>DO < 0.5 mg/L (anoxic)</li>
              <li>Carbon source (BOD or methanol)</li>
              <li>Internal recycle to bring NO‚ÇÉ back</li>
            </ul>
            <h4>Phosphorus Removal (Bio-P):</h4>
            <ul>
              <li>Requires anaerobic zone (no O‚ÇÇ or NO‚ÇÉ)</li>
              <li>PAO bacteria store phosphorus</li>
              <li>Release P in anaerobic, uptake in aerobic</li>
              <li>Wasting P-rich sludge removes P from system</li>
            </ul>`,
          quiz: [
            {
              question: 'Nitrification converts ammonia to:',
              options: ['Nitrogen gas', 'Nitrate', 'Phosphorus', 'Methane'],
              correct: 1
            },
            {
              question: 'Minimum DO for nitrification:',
              options: ['0.5 mg/L', '1.0 mg/L', '2.0 mg/L', '5.0 mg/L'],
              correct: 2
            },
            {
              question: 'Bio-P requires what type of zone?',
              options: ['Aerobic', 'Anoxic', 'Anaerobic', 'High DO'],
              correct: 2
            }
          ]
        },
        {
          id: 'adv-2',
          title: 'Process Control Strategies',
          content: `<h4>Advanced Control Approaches</h4>
            <h4>SRT-Based Control:</h4>
            <ul>
              <li>Most stable long-term control method</li>
              <li>Calculates daily WAS to maintain target SRT</li>
              <li>WAS (lb/d) = Total MLSS (lb) √∑ Target SRT (days)</li>
              <li>Adjusts automatically for load changes</li>
            </ul>
            <h4>MLSS-Based Control:</h4>
            <ul>
              <li>Targets specific MLSS concentration</li>
              <li>Good for plants with consistent loading</li>
              <li>Requires more frequent adjustments</li>
            </ul>
            <h4>F/M-Based Control:</h4>
            <ul>
              <li>Targets food-to-microorganism ratio</li>
              <li>Best for variable loading conditions</li>
              <li>Requires BOD measurement or estimation</li>
            </ul>
            <h4>Cascade Control:</h4>
            <ul>
              <li>DO setpoint controls blowers</li>
              <li>Ammonia setpoint adjusts DO setpoint</li>
              <li>Provides automatic response to load changes</li>
            </ul>
            <h4>Feed-Forward Control:</h4>
            <ul>
              <li>Measures influent load</li>
              <li>Adjusts process before impact occurs</li>
              <li>Prevents upsets from load spikes</li>
            </ul>`,
          quiz: [
            {
              question: 'Most stable long-term wasting control method:',
              options: ['MLSS-based', 'F/M-based', 'SRT-based', 'DO-based'],
              correct: 2
            },
            {
              question: 'Feed-forward control measures:',
              options: ['Effluent quality', 'Influent load', 'Tank level', 'Weather'],
              correct: 1
            },
            {
              question: 'Cascade control uses what to adjust DO setpoint?',
              options: ['pH', 'Temperature', 'Ammonia', 'Flow'],
              correct: 2
            }
          ]
        },
        {
          id: 'adv-3',
          title: 'Energy Optimization',
          content: `<h4>Reducing Energy Costs</h4>
            <p>Aeration typically represents 50-60% of plant energy use.</p>
            <h4>Aeration Optimization:</h4>
            <ul>
              <li>Lower DO setpoint (1.5-2.0 vs 2.5-3.0 mg/L)</li>
              <li>DO-based blower control</li>
              <li>Most open valve (MOV) strategy</li>
              <li>Diffuser maintenance (clean/replace)</li>
              <li>Blower efficiency monitoring</li>
            </ul>
            <h4>Pumping Optimization:</h4>
            <ul>
              <li>Match pump to actual needs (avoid oversizing)</li>
              <li>VFDs on large pumps</li>
              <li>Optimize pump scheduling</li>
              <li>Maintain pumps (impeller wear, seals)</li>
            </ul>
            <h4>Load Shifting:</h4>
            <ul>
              <li>Run equipment during off-peak hours</li>
              <li>Equalization to level load through day</li>
              <li>Time-of-use rate awareness</li>
            </ul>
            <h4>Energy Metrics:</h4>
            <ul>
              <li><strong>kWh/MG:</strong> Energy per million gallons treated</li>
              <li><strong>kWh/lb BOD:</strong> Energy per pound BOD removed</li>
              <li>Typical range: 1,500-2,500 kWh/MG</li>
            </ul>`,
          quiz: [
            {
              question: 'Aeration typically represents what % of plant energy?',
              options: ['10-20%', '30-40%', '50-60%', '80-90%'],
              correct: 2
            },
            {
              question: 'Typical energy use range for WWTPs:',
              options: ['500-1000 kWh/MG', '1500-2500 kWh/MG', '5000-8000 kWh/MG', '10000+ kWh/MG'],
              correct: 1
            },
            {
              question: 'Load shifting means running equipment during:',
              options: ['Peak hours', 'Off-peak hours', 'Any time', 'Never'],
              correct: 1
            }
          ]
        }
      ]
    },
    // NEW MODULE: Laboratory & Sampling
    laboratory: {
      id: 'laboratory',
      name: 'Lab & Sampling',
      icon: 'üß™',
      description: 'Laboratory procedures and sampling techniques',
      lessons: [
        {
          id: 'lab-1',
          title: 'Proper Sampling Techniques',
          content: `<h4>Sampling Fundamentals</h4>
            <p>A test result is only as good as the sample collected.</p>
            <h4>Types of Samples:</h4>
            <ul>
              <li><strong>Grab:</strong> Single point in time - for pH, DO, chlorine, bacteria</li>
              <li><strong>Composite:</strong> Multiple grabs combined - for BOD, TSS, nutrients</li>
              <li><strong>Time-composite:</strong> Equal volumes at set intervals</li>
              <li><strong>Flow-proportional:</strong> Volume based on flow rate</li>
            </ul>
            <h4>Sample Preservation:</h4>
            <ul>
              <li><strong>BOD:</strong> 4¬∞C, analyze within 48 hours</li>
              <li><strong>TSS:</strong> 4¬∞C, analyze within 7 days</li>
              <li><strong>Ammonia:</strong> H‚ÇÇSO‚ÇÑ to pH<2, 4¬∞C, 28 days</li>
              <li><strong>Metals:</strong> HNO‚ÇÉ to pH<2, 6 months</li>
              <li><strong>Bacteria:</strong> 4¬∞C, analyze within 6-24 hours</li>
            </ul>
            <h4>Chain of Custody:</h4>
            <ul>
              <li>Document who collected sample</li>
              <li>Record date, time, location</li>
              <li>Note sample conditions</li>
              <li>Track everyone who handles sample</li>
            </ul>
            <h4>Common Errors:</h4>
            <ul>
              <li>Wrong container type</li>
              <li>Improper preservation</li>
              <li>Exceeding holding time</li>
              <li>Sample contamination</li>
            </ul>`,
          quiz: [
            {
              question: 'BOD samples should be analyzed within:',
              options: ['6 hours', '24 hours', '48 hours', '7 days'],
              correct: 2
            },
            {
              question: 'Which sample type is used for bacteria testing?',
              options: ['Composite', 'Flow-proportional', 'Grab', 'Time-composite'],
              correct: 2
            },
            {
              question: 'Ammonia samples are preserved with:',
              options: ['HCl', 'H‚ÇÇSO‚ÇÑ', 'NaOH', 'Nothing'],
              correct: 1
            }
          ]
        },
        {
          id: 'lab-2',
          title: 'Process Control Testing',
          content: `<h4>Daily Process Tests</h4>
            <h4>Settleability Test (SVI):</h4>
            <ol>
              <li>Fill 1L graduated cylinder with mixed liquor</li>
              <li>Record settled volume at 30 minutes</li>
              <li>SVI = (Settled Vol √ó 1000) √∑ MLSS</li>
              <li>Good settling: SVI 80-120 mL/g</li>
            </ol>
            <h4>Dissolved Oxygen:</h4>
            <ul>
              <li>Calibrate meter daily</li>
              <li>Measure at multiple points</li>
              <li>Record temperature with DO</li>
              <li>Target: 1.5-3.0 mg/L in aeration</li>
            </ul>
            <h4>pH Testing:</h4>
            <ul>
              <li>Calibrate with 7.0 and 4.0 (or 10.0) buffers</li>
              <li>Rinse probe between samples</li>
              <li>Target: 6.8-7.5 for activated sludge</li>
            </ul>
            <h4>Microscopic Exam:</h4>
            <ul>
              <li>Check floc structure (compact vs diffuse)</li>
              <li>Look for filaments</li>
              <li>Identify protozoa (indicator organisms)</li>
              <li>Note any unusual organisms</li>
            </ul>
            <h4>Centrifuge Test:</h4>
            <ul>
              <li>Quick estimate of solids concentration</li>
              <li>Spin 15 mL for 15 minutes</li>
              <li>Read % solids on tube</li>
            </ul>`,
          quiz: [
            {
              question: 'Settleability test reading is taken at:',
              options: ['5 minutes', '15 minutes', '30 minutes', '60 minutes'],
              correct: 2
            },
            {
              question: 'Good settling SVI range:',
              options: ['20-50 mL/g', '80-120 mL/g', '200-300 mL/g', '400+ mL/g'],
              correct: 1
            },
            {
              question: 'pH meter should be calibrated with:',
              options: ['One buffer only', 'Two buffers', 'DI water', 'Tap water'],
              correct: 1
            }
          ]
        },
        {
          id: 'lab-3',
          title: 'QA/QC in the Lab',
          content: `<h4>Quality Assurance / Quality Control</h4>
            <h4>QC Sample Types:</h4>
            <ul>
              <li><strong>Blank:</strong> DI water - checks for contamination</li>
              <li><strong>Duplicate:</strong> Same sample run twice - checks precision</li>
              <li><strong>Spike:</strong> Sample with known amount added - checks accuracy</li>
              <li><strong>Standard:</strong> Known concentration - checks calibration</li>
            </ul>
            <h4>Frequency Requirements:</h4>
            <ul>
              <li>Blank: 1 per batch or 10%</li>
              <li>Duplicate: 1 per batch or 10%</li>
              <li>Spike: 1 per batch or 5%</li>
            </ul>
            <h4>Acceptance Criteria:</h4>
            <ul>
              <li>Blank: < detection limit</li>
              <li>Duplicate RPD: typically < 20%</li>
              <li>Spike recovery: typically 80-120%</li>
            </ul>
            <h4>Documentation:</h4>
            <ul>
              <li>Record all QC results in lab notebook</li>
              <li>Flag out-of-control results</li>
              <li>Document corrective actions</li>
              <li>Maintain control charts</li>
            </ul>
            <h4>RPD Formula:</h4>
            <p>RPD = |Result1 - Result2| √∑ ((Result1 + Result2) √∑ 2) √ó 100</p>`,
          quiz: [
            {
              question: 'A blank sample uses:',
              options: ['Tap water', 'DI water', 'Effluent', 'Influent'],
              correct: 1
            },
            {
              question: 'Typical spike recovery acceptance range:',
              options: ['50-70%', '80-120%', '100% exactly', '150-200%'],
              correct: 1
            },
            {
              question: 'Duplicate RPD should typically be less than:',
              options: ['5%', '10%', '20%', '50%'],
              correct: 2
            }
          ]
        }
      ]
    }
  },

  // Load progress
  loadProgress() {
    const saved = localStorage.getItem('wwtp_training_progress');
    this.progress = saved ? JSON.parse(saved) : {};
    return this.progress;
  },

  // Save progress
  saveProgress() {
    localStorage.setItem('wwtp_training_progress', JSON.stringify(this.progress));
  },

  // Get module completion percentage
  getModuleProgress(moduleId) {
    this.loadProgress();
    const module = this.modules[moduleId];
    if (!module) return 0;
    
    let completed = 0;
    module.lessons.forEach(lesson => {
      if (this.progress[lesson.id]?.completed) completed++;
    });
    return Math.round((completed / module.lessons.length) * 100);
  },

  // Show training dashboard
  showDashboard() {
    this.loadProgress();
    
    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <!-- Header -->
        <div style="background:linear-gradient(135deg,#f97316,#fb923c);padding:24px;text-align:center">
          <div style="font-size:40px;margin-bottom:8px">üéì</div>
          <div style="font-size:20px;font-weight:700;color:white">WWTP Training Academy</div>
          <div style="font-size:13px;color:rgba(255,255,255,0.9);margin-top:6px">
            Interactive learning for operators
          </div>
        </div>

        <!-- Overall Progress -->
        <div style="padding:20px;border-bottom:1px solid #2d4a6f">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
            <span style="color:#94a3b8;font-size:13px">Overall Progress</span>
            <span style="color:#4ade80;font-weight:600">${this.getOverallProgress()}%</span>
          </div>
          <div style="height:8px;background:#374151;border-radius:4px;overflow:hidden">
            <div style="height:100%;width:${this.getOverallProgress()}%;background:linear-gradient(90deg,#4ade80,#22c55e);transition:width 0.5s"></div>
          </div>
        </div>

        <!-- Modules -->
        <div style="padding:20px;max-height:350px;overflow-y:auto">
          ${Object.values(this.modules).map(module => {
            const progress = this.getModuleProgress(module.id);
            return `
              <div onclick="TrainingMode.showModule('${module.id}')" style="background:rgba(255,255,255,0.05);border-radius:12px;padding:16px;margin-bottom:12px;cursor:pointer;transition:all 0.2s;border:1px solid transparent" onmouseover="this.style.borderColor='#4ade80'" onmouseout="this.style.borderColor='transparent'">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                  <span style="font-size:28px">${module.icon}</span>
                  <div style="flex:1">
                    <div style="font-weight:600;color:white;font-size:15px">${module.name}</div>
                    <div style="font-size:12px;color:#94a3b8">${module.description}</div>
                  </div>
                  <div style="text-align:right">
                    <div style="font-size:18px;font-weight:700;color:${progress === 100 ? '#4ade80' : '#94a3b8'}">${progress}%</div>
                    <div style="font-size:11px;color:#94a3b8">${module.lessons.length} lessons</div>
                  </div>
                </div>
                <div style="height:4px;background:#374151;border-radius:2px;overflow:hidden">
                  <div style="height:100%;width:${progress}%;background:${progress === 100 ? '#4ade80' : '#f97316'}"></div>
                </div>
              </div>
            `;
          }).join('')}
        </div>

        <!-- Footer -->
        <div style="padding:16px 20px;border-top:1px solid #2d4a6f;display:flex;gap:10px">
          <button onclick="TrainingMode.resetProgress()" class="btn" style="background:#374151;color:#94a3b8">
            üîÑ Reset Progress
          </button>
          <button onclick="TrainingMode.showCertificates()" class="btn" style="flex:1;background:linear-gradient(135deg,#f97316,#fb923c);color:white;font-weight:600">
            üèÜ View Certificates
          </button>
        </div>
      </div>
    `;

    showModal('üéì Training Mode', html, { width: '480px' });
  },

  // Show specific module
  showModule(moduleId) {
    const module = this.modules[moduleId];
    if (!module) return;
    
    this.loadProgress();
    
    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <div style="background:linear-gradient(135deg,#f97316,#fb923c);padding:16px 20px;display:flex;align-items:center;gap:12px">
          <span style="font-size:28px">${module.icon}</span>
          <div>
            <div style="font-weight:700;color:white;font-size:16px">${module.name}</div>
            <div style="font-size:12px;color:rgba(255,255,255,0.8)">${module.lessons.length} lessons</div>
          </div>
        </div>

        <div style="padding:20px;max-height:400px;overflow-y:auto">
          ${module.lessons.map((lesson, idx) => {
            const completed = this.progress[lesson.id]?.completed;
            const score = this.progress[lesson.id]?.score;
            return `
              <div onclick="TrainingMode.showLesson('${moduleId}', ${idx})" style="display:flex;align-items:center;gap:12px;padding:14px;background:rgba(255,255,255,0.05);border-radius:10px;margin-bottom:10px;cursor:pointer;border:1px solid ${completed ? '#4ade80' : 'transparent'}" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                <div style="width:32px;height:32px;border-radius:50%;background:${completed ? '#4ade80' : '#374151'};display:flex;align-items:center;justify-content:center;font-weight:700;color:${completed ? '#052e16' : '#94a3b8'}">
                  ${completed ? '‚úì' : idx + 1}
                </div>
                <div style="flex:1">
                  <div style="font-weight:500;color:white;font-size:14px">${lesson.title}</div>
                  ${completed ? `<div style="font-size:11px;color:#4ade80">Completed ‚Ä¢ Score: ${score}%</div>` : ''}
                </div>
                <span style="color:#94a3b8">‚Üí</span>
              </div>
            `;
          }).join('')}
        </div>

        <div style="padding:16px 20px;border-top:1px solid #2d4a6f">
          <button onclick="TrainingMode.showDashboard()" class="btn" style="width:100%;background:#374151;color:white">
            ‚Üê Back to Training
          </button>
        </div>
      </div>
    `;

    showModal(`${module.icon} ${module.name}`, html, { width: '450px' });
  },

  // Show lesson
  showLesson(moduleId, lessonIdx) {
    const module = this.modules[moduleId];
    if (!module) return;
    const lesson = module.lessons[lessonIdx];
    if (!lesson) return;

    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <div style="background:linear-gradient(135deg,#3b82f6,#60a5fa);padding:16px 20px">
          <div style="font-size:12px;color:rgba(255,255,255,0.8);margin-bottom:4px">${module.name} ‚Ä¢ Lesson ${lessonIdx + 1}</div>
          <div style="font-weight:700;color:white;font-size:17px">${lesson.title}</div>
        </div>

        <div style="padding:20px;max-height:350px;overflow-y:auto;color:#e0e7ff;font-size:14px;line-height:1.7" id="lessonContent">
          ${lesson.content}
        </div>

        <div style="padding:16px 20px;border-top:1px solid #2d4a6f;display:flex;gap:10px">
          <button onclick="TrainingMode.showModule('${moduleId}')" class="btn" style="background:#374151;color:#94a3b8">
            ‚Üê Back
          </button>
          <button onclick="TrainingMode.startQuiz('${moduleId}', ${lessonIdx})" class="btn" style="flex:1;background:linear-gradient(135deg,#4ade80,#22c55e);color:#052e16;font-weight:600">
            üìù Take Quiz
          </button>
        </div>
      </div>
    `;

    showModal('üìñ ' + lesson.title, html, { width: '550px' });
  },

  // Start quiz
  startQuiz(moduleId, lessonIdx) {
    const module = this.modules[moduleId];
    const lesson = module.lessons[lessonIdx];
    
    this.currentQuiz = {
      moduleId,
      lessonIdx,
      questionIdx: 0,
      correct: 0,
      answers: []
    };

    this.showQuestion();
  },

  // Show quiz question
  showQuestion() {
    const quiz = this.currentQuiz;
    const module = this.modules[quiz.moduleId];
    const lesson = module.lessons[quiz.lessonIdx];
    const question = lesson.quiz[quiz.questionIdx];

    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <div style="background:linear-gradient(135deg,#7c3aed,#a855f7);padding:16px 20px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-size:13px;color:rgba(255,255,255,0.9)">Question ${quiz.questionIdx + 1} of ${lesson.quiz.length}</div>
            <div style="font-size:13px;color:rgba(255,255,255,0.9)">Score: ${quiz.correct}/${quiz.questionIdx}</div>
          </div>
          <div style="height:4px;background:rgba(255,255,255,0.3);border-radius:2px;margin-top:10px;overflow:hidden">
            <div style="height:100%;width:${((quiz.questionIdx + 1) / lesson.quiz.length) * 100}%;background:white"></div>
          </div>
        </div>

        <div style="padding:24px">
          <div style="font-size:16px;color:white;font-weight:500;margin-bottom:20px;line-height:1.5">${question.question}</div>
          
          <div style="display:grid;gap:10px">
            ${question.options.map((opt, idx) => `
              <button onclick="TrainingMode.answerQuestion(${idx})" style="width:100%;padding:14px 16px;background:rgba(255,255,255,0.05);border:2px solid #374151;border-radius:10px;color:white;font-size:14px;text-align:left;cursor:pointer;transition:all 0.2s" onmouseover="this.style.borderColor='#7c3aed';this.style.background='rgba(124,58,237,0.2)'" onmouseout="this.style.borderColor='#374151';this.style.background='rgba(255,255,255,0.05)'">
                <span style="display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;background:#374151;margin-right:12px;font-weight:600;font-size:12px">${String.fromCharCode(65 + idx)}</span>
                ${opt}
              </button>
            `).join('')}
          </div>
        </div>
      </div>
    `;

    showModal('üìù Quiz', html, { width: '500px' });
  },

  // Answer question
  answerQuestion(answerIdx) {
    const quiz = this.currentQuiz;
    const module = this.modules[quiz.moduleId];
    const lesson = module.lessons[quiz.lessonIdx];
    const question = lesson.quiz[quiz.questionIdx];

    quiz.answers.push(answerIdx);
    if (answerIdx === question.correct) {
      quiz.correct++;
      showToast('‚úÖ Correct!', 'success');
    } else {
      showToast(`‚ùå Incorrect. The answer was: ${question.options[question.correct]}`, 'error');
    }

    quiz.questionIdx++;

    if (quiz.questionIdx >= lesson.quiz.length) {
      this.finishQuiz();
    } else {
      setTimeout(() => this.showQuestion(), 800);
    }
  },

  // Finish quiz
  finishQuiz() {
    const quiz = this.currentQuiz;
    const module = this.modules[quiz.moduleId];
    const lesson = module.lessons[quiz.lessonIdx];
    const score = Math.round((quiz.correct / lesson.quiz.length) * 100);
    const passed = score >= 70;

    // Save progress
    this.loadProgress();
    this.progress[lesson.id] = {
      completed: passed,
      score,
      timestamp: new Date().toISOString()
    };
    this.saveProgress();

    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden;text-align:center">
        <div style="background:linear-gradient(135deg,${passed ? '#4ade80,#22c55e' : '#ef4444,#dc2626'});padding:32px">
          <div style="font-size:56px;margin-bottom:12px">${passed ? 'üéâ' : 'üìö'}</div>
          <div style="font-size:24px;font-weight:700;color:white">${passed ? 'Congratulations!' : 'Keep Learning!'}</div>
        </div>

        <div style="padding:24px">
          <div style="font-size:48px;font-weight:800;color:${passed ? '#4ade80' : '#ef4444'}">${score}%</div>
          <div style="color:#94a3b8;margin-top:8px">${quiz.correct} of ${lesson.quiz.length} correct</div>
          
          <div style="margin-top:20px;padding:16px;background:rgba(255,255,255,0.05);border-radius:10px">
            <div style="color:white;font-weight:500">${lesson.title}</div>
            <div style="color:${passed ? '#4ade80' : '#fbbf24'};font-size:13px;margin-top:4px">
              ${passed ? '‚úì Lesson completed!' : 'Score 70% or higher to complete'}
            </div>
          </div>
        </div>

        <div style="padding:16px 20px;border-top:1px solid #2d4a6f;display:flex;gap:10px">
          ${!passed ? `
            <button onclick="TrainingMode.showLesson('${quiz.moduleId}', ${quiz.lessonIdx})" class="btn" style="flex:1;background:#374151;color:white">
              üìñ Review Lesson
            </button>
            <button onclick="TrainingMode.startQuiz('${quiz.moduleId}', ${quiz.lessonIdx})" class="btn" style="flex:1;background:#f97316;color:white">
              üîÑ Retry Quiz
            </button>
          ` : `
            <button onclick="TrainingMode.showModule('${quiz.moduleId}')" class="btn" style="flex:1;background:linear-gradient(135deg,#4ade80,#22c55e);color:#052e16;font-weight:600">
              ‚úì Continue Learning
            </button>
          `}
        </div>
      </div>
    `;

    showModal(passed ? 'üèÜ Quiz Complete!' : 'üìù Quiz Results', html, { width: '400px' });
  },

  // Get overall progress
  getOverallProgress() {
    this.loadProgress();
    let total = 0;
    let completed = 0;
    
    Object.values(this.modules).forEach(module => {
      module.lessons.forEach(lesson => {
        total++;
        if (this.progress[lesson.id]?.completed) completed++;
      });
    });
    
    return total > 0 ? Math.round((completed / total) * 100) : 0;
  },

  // Reset progress
  resetProgress() {
    if (confirm('Reset all training progress? This cannot be undone.')) {
      localStorage.removeItem('wwtp_training_progress');
      this.progress = {};
      showToast('üîÑ Progress reset', 'info');
      this.showDashboard();
    }
  },

  // Show certificates
  showCertificates() {
    this.loadProgress();
    const completedModules = Object.values(this.modules).filter(m => this.getModuleProgress(m.id) === 100);

    let html = `
      <div style="background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:16px;overflow:hidden">
        <div style="background:linear-gradient(135deg,#fbbf24,#f97316);padding:24px;text-align:center">
          <div style="font-size:40px;margin-bottom:8px">üèÜ</div>
          <div style="font-size:18px;font-weight:700;color:white">Certificates</div>
        </div>

        <div style="padding:20px;min-height:200px">
          ${completedModules.length === 0 ? `
            <div style="text-align:center;padding:30px;color:#94a3b8">
              <div style="font-size:32px;margin-bottom:12px">üìú</div>
              <p>Complete training modules to earn certificates!</p>
            </div>
          ` : completedModules.map(module => `
            <div style="background:linear-gradient(135deg,#fbbf24,#f97316);border-radius:12px;padding:20px;margin-bottom:12px;text-align:center">
              <div style="font-size:32px;margin-bottom:8px">üèÖ</div>
              <div style="font-weight:700;color:#052e16;font-size:15px">${module.name}</div>
              <div style="font-size:12px;color:rgba(0,0,0,0.6);margin-top:4px">Certificate of Completion</div>
            </div>
          `).join('')}
        </div>

        <div style="padding:16px 20px;border-top:1px solid #2d4a6f">
          <button onclick="TrainingMode.showDashboard()" class="btn" style="width:100%;background:#374151;color:white">
            ‚Üê Back to Training
          </button>
        </div>
      </div>
    `;

    showModal('üèÜ Certificates', html, { width: '400px' });
  }
};

// ===== TIER 3 RESPONSE HANDLER =====
function generateTier3Response(msg) {
  const lower = msg.toLowerCase();

  // Optimization Coach triggers
  if (lower.includes('optimize') || lower.includes('optimization') || lower.includes('improve') && (lower.includes('plant') || lower.includes('operation') || lower.includes('efficiency'))) {
    setTimeout(() => OptimizationCoach.showDashboard(), 100);
    return 'üéØ Opening Optimization Coach... Analyzing your plant for improvement opportunities.';
  }
  
  if (lower.includes('recommend') || lower.includes('suggestion') || lower.includes('what should i')) {
    const results = OptimizationCoach.generateRecommendations();
    if (results.recommendations.length > 0) {
      const top = results.recommendations[0];
      return `<strong>üéØ Top Recommendation:</strong><br><br>
        <strong>${top.title}</strong> (${top.priority} priority)<br>
        Current: ${top.current}<br>
        Target: ${top.target}<br><br>
        <strong>Action:</strong> ${top.action}<br><br>
        <em>Say "show optimization" for full analysis with ${results.recommendations.length} recommendations.</em>`;
    }
    return '‚úÖ Your plant is operating efficiently! No immediate optimization needed.';
  }

  // Predictive Operations triggers
  if (lower.includes('predict') || lower.includes('forecast') || lower.includes('trend') || lower.includes('what will happen')) {
    setTimeout(() => PredictiveOps.showDashboard(), 100);
    return 'üîÆ Opening Predictive Operations... Analyzing trends and forecasting issues.';
  }

  if (lower.includes('alert') && (lower.includes('future') || lower.includes('upcoming') || lower.includes('predict'))) {
    const results = PredictiveOps.generatePredictions();
    const alerts = results.predictions.filter(p => p.alert);
    if (alerts.length > 0) {
      return `<strong>üîÆ Predicted Alerts:</strong><br><br>` +
        alerts.map(a => `${a.alert.type === 'critical' ? 'üö®' : '‚ö†Ô∏è'} ${a.alert.message}`).join('<br>') +
        `<br><br><em>Say "show predictions" for detailed forecast.</em>`;
    }
    return 'üîÆ No issues predicted in the next 7 days. All parameters trending stable.';
  }

  // Training Mode triggers
  if (lower.includes('train') || lower.includes('learn') || lower.includes('tutorial') || lower.includes('course') || lower.includes('academy')) {
    setTimeout(() => TrainingMode.showDashboard(), 100);
    return 'üéì Opening Training Academy... Interactive courses for WWTP operators.';
  }

  if (lower.includes('quiz') || lower.includes('test my')) {
    setTimeout(() => TrainingMode.showDashboard(), 100);
    return 'üìù Opening Training Academy... Select a module to take a quiz!';
  }

  // TIER 3 help
  if (lower.includes('tier 3') || lower.includes('advanced ai') || lower.includes('ai features')) {
    return `<strong>üß† TIER 3 AI Features:</strong><br><br>
      <strong>üéØ Optimization Coach</strong><br>
      Analyzes your plant and provides actionable recommendations for efficiency, energy, and compliance.<br>
      <em>Try: "optimize my plant" or "show recommendations"</em><br><br>
      
      <strong>üîÆ Predictive Operations</strong><br>
      Forecasts issues 7 days ahead based on parameter trends.<br>
      <em>Try: "predict problems" or "show forecast"</em><br><br>
      
      <strong>üéì Training Mode</strong><br>
      Interactive lessons and quizzes for operator development.<br>
      <em>Try: "start training" or "take a quiz"</em>`;
  }

  return null; // Fall through to lower tiers
}

// ========== END TIER 3 ==========

function generateAIResponse(msg){
const lower=msg.toLowerCase();

// TIER 3: Advanced AI (Optimization, Prediction, Training)
if (typeof generateTier3Response === 'function') {
  const tier3Response = generateTier3Response(msg);
  if (tier3Response) {
    return tier3Response;
  }
}

// TIER 2: Operational Intelligence (check first - plant profile, troubleshooting, compliance)
if (typeof generateTier2Response === 'function') {
  const tier2Response = generateTier2Response(msg);
  if (tier2Response) {
    return tier2Response;
  }
}

// TIER 1: Smart App-Aware Response
const smartResponse = generateSmartResponse(msg);
if (smartResponse) {
  return smartResponse;
}

// Check for calculation requests (AI-2)
if(isCalcRequest(msg)) {
  const calcType = getCalcType(msg);
  if (calcType) {
    const numbers = extractNumbers(msg);
    if (numbers.length > 0) {
      aiFillInputs(calcType, numbers);
    }
    const runResult = aiRunCalculation(calcType);
    setTimeout(() => {
      const explanation = explainCalcResult(calcType);
      addAIMessage(explanation, 'assistant');
    }, 1500);
    return runResult;
  }
}

// Check for "explain" requests (AI-2)
if(lower.includes('explain') && (lower.includes('result') || lower.includes('calculation'))) {
  const calcType = getCalcType(msg);
  if (calcType) {
    return explainCalcResult(calcType);
  }
}

// Check for learning commands (AI-6)
const learningResponse = handleLearningCommand(msg);
if (learningResponse) {
  return learningResponse;
}

// Check for report requests (AI-5)
if(isReportRequest(msg)) {
  return handleReportRequest(msg);
}

// Check for prediction/alert requests (AI-3)
if(lower.includes('predict') || lower.includes('forecast') || lower.includes('trend') || lower.includes('alert') || lower.includes('warning')) {
  return formatPredictiveAlerts();
}

// Check for status/context request
if(lower.includes('status') || lower.includes('how is') || lower.includes('plant') || lower.includes('check')) {
  return getAIGreeting();
}

// Pattern matching for common questions
if(lower.includes('high svi')||lower.includes('bulking')){
let response = `<strong>Sludge Bulking Diagnosis</strong><br><br>High SVI indicates bulking sludge, typically caused by filamentous bacteria. Here's what to check:<br><br>
<strong>Immediate Actions:</strong><br>
1. Verify current SVI value and trend<br>
2. Check DO levels - should be >2.0 mg/L throughout basin<br>
3. Perform microscopic exam to identify filament type<br>
4. Calculate F/M ratio - target 0.3-0.5 lb/lb/d<br><br>
<strong>Solutions:</strong><br>
‚Ä¢ Increase DO to 2.5-3.0 mg/L<br>
‚Ä¢ Consider RAS chlorination (5-10 mg/L)<br>
‚Ä¢ Add selector zone if possible<br>
‚Ä¢ Reduce F/M if >0.5<br><br>
Would you like detailed step-by-step instructions?`;
return generateContextAwareResponse(msg, response);
}

if(lower.includes('ammonia')||lower.includes('nitrification')){
let response = `<strong>Ammonia/Nitrification Issues</strong><br><br>High effluent ammonia indicates nitrification problems. Key factors:<br><br>
<strong>Critical Parameters:</strong><br>
‚Ä¢ MCRT: Must be >8 days (>12 days if temp <15¬∞C)<br>
‚Ä¢ DO: Maintain >2.0 mg/L in aerobic zones<br>
‚Ä¢ Alkalinity: Need ~50 mg/L minimum as CaCO3<br>
‚Ä¢ Temperature: Below 12¬∞C severely impacts rate<br><br>
<strong>Quick Fixes:</strong><br>
1. STOP wasting sludge immediately to increase MCRT<br>
2. Increase aeration/DO setpoint<br>
3. Check for toxic industrial discharge<br>
4. Test and supplement alkalinity if needed<br><br>
Recovery typically takes 1-2 weeks. Monitor daily!`;
return generateContextAwareResponse(msg, response);
}

if(lower.includes('do')||lower.includes('oxygen')||lower.includes('aeration')){
let response = `<strong>Dissolved Oxygen Management</strong><br><br>
<strong>Target Ranges:</strong><br>
‚Ä¢ Conventional activated sludge: 1.5-3.0 mg/L<br>
‚Ä¢ Nitrification: 2.0-3.0 mg/L<br>
‚Ä¢ Extended aeration: 2.5-4.0 mg/L<br><br>
<strong>Troubleshooting Low DO:</strong><br>
1. Check blower amperage and operation<br>
2. Inspect diffusers for fouling or damage<br>
3. Verify airflow measurement<br>
4. Calculate oxygen transfer rate vs requirement<br>
5. Clean diffusers if OTE has dropped<br><br>
<strong>Energy Optimization:</strong><br>
‚Ä¢ Use DO control with VFDs<br>
‚Ä¢ Vary setpoint based on load<br>
‚Ä¢ Consider fine bubble vs coarse<br><br>
Need help calculating oxygen requirements?`;
return generateContextAwareResponse(msg, response);
}

if(lower.includes('energy')||lower.includes('cost')||lower.includes('power')){
return `<strong>Energy Optimization Strategies</strong><br><br>
Aeration typically represents 50-60% of total plant energy. Here's how to optimize:<br><br>
<strong>Quick Wins:</strong><br>
1. Install VFDs on blowers (15-25% savings)<br>
2. Optimize DO setpoints (reduce excess DO)<br>
3. Use time-of-day scheduling<br>
4. Improve process control<br><br>
<strong>Maintenance:</strong><br>
‚Ä¢ Clean diffusers regularly<br>
‚Ä¢ Fix air leaks<br>
‚Ä¢ Optimize equipment staging<br>
‚Ä¢ Monitor motor efficiency<br><br>
<strong>Benchmark:</strong><br>
Good performance: <1800 kWh/MG<br>
Average: 1800-2200 kWh/MG<br>
Needs improvement: >2200 kWh/MG<br><br>
Your current usage: ${$('kpi-energy')?.textContent||'1850'} kWh/MG`;
}

if(lower.includes('f/m')||lower.includes('food to microorganism')){
return `<strong>F/M Ratio Management</strong><br><br>
The Food-to-Microorganism ratio controls treatment performance:<br><br>
<strong>Typical Ranges:</strong><br>
‚Ä¢ Conventional AS: 0.2-0.5 lb BOD/lb MLVSS/d<br>
‚Ä¢ Extended aeration: 0.05-0.15<br>
‚Ä¢ High-rate: 0.5-1.5<br><br>
<strong>Effects of F/M:</strong><br>
‚Ä¢ Low F/M (<0.2): Better effluent, more stable, higher O2<br>
‚Ä¢ High F/M (>0.5): Poor settling, higher BOD, bulking risk<br><br>
<strong>Adjustment:</strong><br>
To decrease F/M: Increase MLSS or reduce load<br>
To increase F/M: Decrease MLSS (waste more) or accept more load<br><br>
Your current F/M: ${$('kpi-fm')?.textContent||'0.35'} lb/lb/d - Optimal range!`;
}

if(lower.includes('foam')||lower.includes('scum')){
return `<strong>Foam & Scum Troubleshooting</strong><br><br>
<strong>Types of Foam:</strong><br><br>
1. <strong>White billowy foam</strong> (Nocardia/Actinomycetes)<br>
   ‚Ä¢ Caused by: High MCRT, warm temps, fats/oils<br>
   ‚Ä¢ Solution: Reduce MCRT to 5-8 days, spray foam, chlorinate<br><br>
2. <strong>Brown/tan foam</strong> (Young sludge/Surfactants)<br>
   ‚Ä¢ Caused by: Low MCRT, detergents, startup<br>
   ‚Ä¢ Solution: Normal - will improve as sludge matures<br><br>
3. <strong>Thick foam</strong> (Denitrification in clarifier)<br>
   ‚Ä¢ Caused by: Rising sludge, N2 gas<br>
   ‚Ä¢ Solution: Increase RAS rate, reduce sludge blanket<br><br>
<strong>Control Methods:</strong><br>
‚Ä¢ Water spray<br>
‚Ä¢ Anti-foam chemicals<br>
‚Ä¢ Adjust MCRT<br>
‚Ä¢ Investigate industrial FOG sources`;
}

if(lower.includes('help')||lower.includes('what can you')){
return `I can assist with a wide range of wastewater treatment topics:<br><br>
<strong>üîç Diagnostics:</strong> Identify root causes of problems<br>
<strong>ü©∫ Troubleshooting:</strong> Step-by-step solutions<br>
<strong>üìä Calculations:</strong> Loading, F/M, MCRT, oxygen, etc.<br>
<strong>‚öôÔ∏è Operations:</strong> Process control and optimization<br>
<strong>üß´ Biology:</strong> Microbiology and sludge health<br>
<strong>üìã Compliance:</strong> Permit limits and reporting<br>
<strong>‚ö° Energy:</strong> Efficiency and cost reduction<br>
<strong>üîß Maintenance:</strong> Equipment and preventive care<br><br>
Try asking me:<br>
‚Ä¢ "Why is my SVI high?"<br>
‚Ä¢ "How do I improve nitrification?"<br>
‚Ä¢ "What's causing high effluent TSS?"<br>
‚Ä¢ "How can I reduce energy costs?"<br>
‚Ä¢ "Calculate my oxygen requirements"`;
}

// Default response with suggestions
return `I understand you're asking about: "${msg}"<br><br>I can provide detailed guidance on this topic. To give you the most accurate help, could you provide more details such as:<br><br>
‚Ä¢ Current operating parameters (MLSS, DO, F/M, etc.)<br>
‚Ä¢ Specific symptoms or measurements<br>
‚Ä¢ Recent changes in operations<br>
‚Ä¢ Lab results or trends<br><br>
Or try asking a more specific question like:<br>
‚Ä¢ "Why is my [parameter] high/low?"<br>
‚Ä¢ "How do I troubleshoot [issue]?"<br>
‚Ä¢ "What causes [problem]?"<br>
‚Ä¢ "Calculate [parameter]"<br><br>
You can also use the <strong>Full System Diagnostic</strong> button above for a comprehensive analysis!`;
}

function showQuickQuestions(){
addAIMessage(`<strong>Quick Questions - Click to Ask:</strong><br><br>
<div style="display:grid;gap:8px;margin-top:12px">
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('Why is my SVI high?')">‚ùì Why is my SVI high?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('How do I improve nitrification?')">‚ùì How do I improve nitrification?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('What causes high effluent TSS?')">‚ùì What causes high effluent TSS?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('How can I reduce energy costs?')">‚ùì How can I reduce energy costs?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('What is the optimal F/M ratio?')">‚ùì What is the optimal F/M ratio?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('How do I fix poor settling?')">‚ùì How do I fix poor settling?</button>
</div>`,'assistant');
}

function askQuick(question){
$('aiInput').value=question;
sendAIMessage();
}

function clearAIChat(){
if(confirm('Clear all chat history?')){
$('aiMessages').innerHTML=`<div class="ai-message assistant">
Chat cleared! How can I assist you today?
</div>`;
state.aiChat=[];
showToast('Chat history cleared','success');
}
}

function runSystemDiagnostic(){
showToast('Running comprehensive system diagnostic...','info');
showAIThinking(true);

setTimeout(()=>{
showAIThinking(false);
$('diagnosticResults').style.display='block';
$('diagnosticContent').innerHTML=generateDiagnosticReport();
showToast('Diagnostic complete - see results below','success');

// Scroll to results
setTimeout(()=>{
$('diagnosticResults').scrollIntoView({behavior:'smooth',block:'start'});
},300);
},2500);
}

function generateDiagnosticReport(){
// Get current data
const flow=parseFloat($('kpi-flow')?.textContent||3.5);
const doVal=parseFloat($('kpi-do')?.textContent||2.1);
const mlss=parseInt($('kpi-mlss')?.textContent||2500);
const fm=parseFloat($('kpi-fm')?.textContent||0.35);
const energy=parseInt($('kpi-energy')?.textContent||1850);

let issues=[];
let recommendations=[];

// Analyze parameters
if(doVal<1.5){
issues.push({severity:'high',title:'Low Dissolved Oxygen',desc:`Current DO (${doVal} mg/L) is below minimum requirement of 1.5 mg/L. This will impact BOD removal and nitrification.`,action:'Increase aeration immediately'});
}else if(doVal>3.5){
issues.push({severity:'medium',title:'Excessive Dissolved Oxygen',desc:`DO (${doVal} mg/L) is higher than necessary. This wastes energy.`,action:'Reduce aeration to save energy'});
}

if(fm<0.2){
issues.push({severity:'low',title:'Low F/M Ratio',desc:`F/M ratio (${fm}) indicates underloading. While effluent quality is likely excellent, energy efficiency may be poor.`,action:'Consider reducing aeration volume or accepting more load'});
}else if(fm>0.5){
issues.push({severity:'medium',title:'High F/M Ratio',desc:`F/M ratio (${fm}) is elevated. Risk of poor settling and effluent quality issues.`,action:'Increase MLSS or reduce organic loading'});
}

if(mlss<1800){
issues.push({severity:'medium',title:'Low MLSS',desc:`MLSS (${mlss} mg/L) is below typical operating range. Risk of washout and poor effluent quality.`,action:'Reduce WAS rate to build inventory'});
}else if(mlss>4000){
issues.push({severity:'medium',title:'High MLSS',desc:`MLSS (${mlss} mg/L) is elevated. Increased oxygen demand and settling issues possible.`,action:'Increase WAS rate or check clarifier performance'});
}

if(energy>2000){
issues.push({severity:'medium',title:'High Energy Consumption',desc:`Energy intensity (${energy} kWh/MG) exceeds industry benchmark of 2000 kWh/MG.`,action:'Review aeration efficiency and equipment staging'});
}

// Generate recommendations
if(doVal>=1.5&&doVal<=3.0&&fm>=0.2&&fm<=0.5&&mlss>=2000&&mlss<=3500){
recommendations.push('‚úì Process is operating within optimal parameters');
recommendations.push('‚Ä¢ Consider fine-tuning DO setpoint for energy savings');
recommendations.push('‚Ä¢ Implement automated DO control if not already in place');
}

if(issues.length===0){
recommendations.push('‚úì No critical issues detected');
recommendations.push('‚Ä¢ Continue current monitoring protocols');
recommendations.push('‚Ä¢ Schedule routine maintenance as planned');
}

let html=`
<div class="kpi-grid">
<div class="kpi-card">
<h4>Issues Found</h4>
<p style="color:${issues.length===0?'var(--ok)':issues.some(i=>i.severity==='high')?'var(--bad)':'var(--warn)'}">${issues.length}</p>
</div>
<div class="kpi-card">
<h4>System Health</h4>
<p style="color:${issues.length===0?'var(--ok)':issues.length<=2?'var(--warn)':'var(--bad)'}">
${issues.length===0?'Excellent':issues.length<=2?'Good':'Needs Attention'}
</p>
</div>
<div class="kpi-card">
<h4>Confidence</h4>
<p style="color:var(--info)">92%</p>
<div class="small">Based on current data</div>
</div>
</div>

<h4 style="margin:24px 0 16px 0">Diagnostic Results:</h4>
`;

if(issues.length>0){
issues.forEach(issue=>{
html+=`
<div class="diagnostic-card">
<span class="severity ${issue.severity}">${issue.severity.toUpperCase()} PRIORITY</span>
<h3>${issue.title}</h3>
<p style="color:var(--text-unit);margin:12px 0">${issue.desc}</p>
<div class="solution-step">
<h5>Recommended Action:</h5>
<p>${issue.action}</p>
</div>
</div>
`;
});
}else{
html+=`
<div class="note success">
<strong>‚úì System Operating Normally</strong><br>
No critical issues detected. All parameters are within acceptable ranges. Continue standard monitoring and maintenance procedures.
</div>
`;
}

if(recommendations.length>0){
html+=`
<h4 style="margin:24px 0 16px 0">Recommendations:</h4>
<div class="note info">
${recommendations.map(r=>`${r}<br>`).join('')}
</div>
`;
}

html+=`
<div style="margin-top:24px">
<strong>Diagnostic Report Generated:</strong> ${new Date().toLocaleString()}<br>
<strong>Data Quality:</strong> Good<br>
<strong>Analysis Method:</strong> AI-Powered Multi-Parameter Assessment
</div>
`;

return html;
}

function showSymptomChecker(){
$('symptomCheckerSection').style.display='block';
$('knowledgeBaseSection').style.display='none';
$('issueHistorySection').style.display='none';

const container=$('symptomChecker');
container.innerHTML=symptoms.map(s=>`
<div class="symptom-option">
<input type="checkbox" id="sym_${s.id}" value="${s.id}"/>
<label for="sym_${s.id}" style="cursor:pointer;flex:1">${s.text}</label>
</div>
`).join('');

setTimeout(()=>{
$('symptomCheckerSection').scrollIntoView({behavior:'smooth',block:'start'});
},100);
}

function analyzeSymptoms(){
const checked=[];
symptoms.forEach(s=>{
if($(`sym_${s.id}`)?.checked){
checked.push(s);
}
});

if(checked.length===0){
showToast('Please select at least one symptom','warning');
return;
}

showAIThinking(true);
setTimeout(()=>{
showAIThinking(false);
const analysis=performSymptomAnalysis(checked);
addAIMessage(analysis,'assistant');
$$('.tab[data-panel="ai"]')[0].click();
},1500);
}

function performSymptomAnalysis(symptoms){
let issueCount={};
symptoms.forEach(s=>{
s.issues.forEach(i=>{
issueCount[i]=(issueCount[i]||0)+1;
});
});

const sorted=Object.entries(issueCount).sort((a,b)=>b[1]-a[1]);
const topIssue=sorted[0][0];

let response=`<strong>ü©∫ Symptom Analysis Results</strong><br><br>`;
response+=`You selected ${symptoms.length} symptom${symptoms.length>1?'s':''}:<br>`;
symptoms.forEach(s=>{
response+=`‚Ä¢ ${s.text}<br>`;
});

response+=`<br><strong>Most Likely Cause:</strong><br><br>`;

// Map issue codes to full diagnoses
const issueMap={
bulking:'<strong>Sludge Bulking</strong><br>Filamentous bacteria causing poor settling',
underloading:'<strong>Underloading</strong><br>F/M ratio too low, insufficient organic load',
overloading:'<strong>Overloading</strong><br>Organic or hydraulic load exceeds capacity',
toxicity:'<strong>Toxic Shock</strong><br>Industrial discharge or toxic compounds',
low_do:'<strong>Low Dissolved Oxygen</strong><br>Insufficient aeration or blower issues',
low_mcrt:'<strong>MCRT Too Short</strong><br>Insufficient sludge age for nitrification',
low_temp:'<strong>Low Temperature</strong><br>Reduced biological activity',
pinfloc:'<strong>Pin Floc</strong><br>Old sludge or dispersed floc particles',
old_sludge:'<strong>Old Sludge</strong><br>Extended MCRT causing floc degradation',
clarifier_overload:'<strong>Clarifier Overload</strong><br>Hydraulic or solids overload',
nocardia:'<strong>Nocardia Foam</strong><br>Actinomycetes causing white billowy foam',
septicity:'<strong>Septic Conditions</strong><br>Anaerobic conditions producing H2S',
denitrification:'<strong>Denitrification</strong><br>Nitrogen gas causing rising sludge'
};

response+=issueMap[topIssue]||'Unknown issue';
response+=`<br><br><strong>Recommended Actions:</strong><br>`;

// Get detailed solution for top issue
if(issueDatabase[topIssue]){
const issue=issueDatabase[topIssue];
issue.solutions.slice(0,5).forEach(sol=>{
response+=`${sol.step}. ${sol.action}<br>`;
});
response+=`<br><em>For complete troubleshooting guide, ask me: "How do I fix ${topIssue}?"</em>`;
}else{
response+=`For detailed guidance, please describe your symptoms in the chat.`;
}

return response;
}

function resetSymptomChecker(){
symptoms.forEach(s=>{
const cb=$(`sym_${s.id}`);
if(cb)cb.checked=false;
});
showToast('Symptom checker reset','info');
}

function showKnowledgeBase(){
$('symptomCheckerSection').style.display='none';
$('knowledgeBaseSection').style.display='block';
$('issueHistorySection').style.display='none';

populateKnowledgeBase();

setTimeout(()=>{
$('knowledgeBaseSection').scrollIntoView({behavior:'smooth',block:'start'});
},100);
}

function populateKnowledgeBase(filter=''){
const container=$('knowledgeBaseContent');
const filtered=filter?knowledgeBase.filter(kb=>
kb.title.toLowerCase().includes(filter.toLowerCase())||
kb.keywords.toLowerCase().includes(filter.toLowerCase())||
kb.content.toLowerCase().includes(filter.toLowerCase())
):knowledgeBase;

container.innerHTML=filtered.map(kb=>`
<div class="knowledge-item" onclick="showKBArticle(${kb.id})">
<h4>${kb.title}</h4>
<p>${kb.content.substring(0,150)}...</p>
<div style="margin-top:8px">
<span class="tag info">${kb.category}</span>
</div>
</div>
`).join('');

if(filtered.length===0){
container.innerHTML=`
<div class="empty-state">
<div class="empty-state-icon">üîç</div>
<div class="empty-state-title">No Articles Found</div>
<div class="empty-state-message">Try different search terms</div>
</div>
`;
}
}

function searchKnowledgeBase(){
const query=$('kbSearch').value;
populateKnowledgeBase(query);
}

function showKBArticle(id){
const article=knowledgeBase.find(kb=>kb.id===id);
if(!article)return;

$$('.tab[data-panel="ai"]')[0].click();
addAIMessage(`<strong>üìö Knowledge Base: ${article.title}</strong><br><br>
<strong>Category:</strong> ${article.category}<br><br>
${article.content}<br><br>
<em>Need more specific guidance? Describe your situation and I can provide tailored advice.</em>`,'assistant');
}

function showIssueHistory(){
$('symptomCheckerSection').style.display='none';
$('knowledgeBaseSection').style.display='none';
$('issueHistorySection').style.display='block';

populateIssueHistory();

setTimeout(()=>{
$('issueHistorySection').scrollIntoView({behavior:'smooth',block:'start'});
},100);
}

function populateIssueHistory(){
const container=$('issueHistoryContent');

// Sample issue history (in real app, this would come from database)
const sampleIssues=[
{date:'2025-11-01',title:'High SVI (165 mL/g)',desc:'Filamentous bulking. Increased DO to 2.8 mg/L and added chlorine to RAS. SVI reduced to 128 mL/g within 5 days.',resolved:true},
{date:'2025-10-28',title:'Ammonia Breakthrough',desc:'Effluent NH3 spiked to 3.2 mg/L. Stopped WAS and increased MCRT. Industrial pretreatment violation identified as cause.',resolved:true},
{date:'2025-10-15',title:'Blower #2 Failure',desc:'Blower tripped on high vibration. Bearing replacement required. Operating on backup blower.',resolved:true},
{date:'2025-11-04',title:'High Effluent TSS',desc:'TSS at 38 mg/L. Investigating clarifier performance. Sludge blanket at 60% depth. Increased RAS rate.',resolved:false},
{date:'2025-11-05',title:'Low DO in Basin 2',desc:'DO dropped to 1.2 mg/L. Diffuser inspection scheduled. Currently using backup aeration zones.',resolved:false}
];

const combined=[...sampleIssues,...(state.issues||[])];

if(combined.length===0){
container.innerHTML=`
<div class="empty-state">
<div class="empty-state-icon">üìã</div>
<div class="empty-state-title">No Issues Logged</div>
<div class="empty-state-message">Start tracking issues to build your operational history</div>
</div>
`;
return;
}

container.innerHTML=combined.map(issue=>`
<div class="issue-history-item ${issue.resolved?'resolved':''}">
<div class="issue-date">üìÖ ${issue.date} ${issue.resolved?'<span class="tag success">RESOLVED</span>':'<span class="tag warning">ACTIVE</span>'}</div>
<div class="issue-title">${issue.title}</div>
<div class="issue-desc">${issue.desc}</div>
</div>
`).join('');
}

function addNewIssue(){
const title=prompt('Issue Title:');
if(!title)return;
const desc=prompt('Description:');
if(!desc)return;

const issue={
date:new Date().toISOString().split('T')[0],
title:title,
desc:desc,
resolved:false
};

state.issues=state.issues||[];
state.issues.unshift(issue);

showToast('Issue logged successfully','success');
populateIssueHistory();
}

function exportDiagnostic(){
showToast('Exporting diagnostic report...','info');
setTimeout(()=>{
showToast('‚úì Diagnostic report exported','success');
},1000);
}

// Loading calculations (abbreviated)
function calcLoading(){
const flow=Number($('flow').value);
const bod=Number($('bod').value);
const tss=Number($('tss').value);
const tkn=Number($('tkn').value);
const tp=Number($('tp').value);
const cod=Number($('cod').value);
const mgd2lbd=8.34;

const bodLoad=flow*bod*mgd2lbd;
const tssLoad=flow*tss*mgd2lbd;
const tknLoad=flow*tkn*mgd2lbd;
const tpLoad=flow*tp*mgd2lbd;
const codLoad=flow*cod*mgd2lbd;

$('r_bodLoad').textContent=fmt.n(bodLoad,0);
$('r_tssLoad').textContent=fmt.n(tssLoad,0);
$('r_tknLoad').textContent=fmt.n(tknLoad,0);
$('r_tpLoad').textContent=fmt.n(tpLoad,0);
$('r_codLoad').textContent=fmt.n(codLoad,0);

$('avg_bodLoad').textContent=fmt.n(bodLoad*0.95,0);
$('avg_tssLoad').textContent=fmt.n(tssLoad*0.98,0);
$('avg_tknLoad').textContent=fmt.n(tknLoad*1.02,0);
$('avg_tpLoad').textContent=fmt.n(tpLoad*0.97,0);
$('avg_codLoad').textContent=fmt.n(codLoad*0.96,0);

$('trend_bodLoad').textContent='‚Üë 5%';
$('trend_tssLoad').textContent='‚Üí Stable';
$('trend_tknLoad').textContent='‚Üì 2%';
$('trend_tpLoad').textContent='‚Üí Stable';
$('trend_codLoad').textContent='‚Üë 4%';

$('s_bodLoad').textContent=bodLoad<8000?'‚úì Normal':'‚ö† High';
$('s_bodLoad').className=bodLoad<8000?'status ok':'status warn';
$('s_tssLoad').textContent=tssLoad<9000?'‚úì Normal':'‚ö† High';
$('s_tssLoad').className=tssLoad<9000?'status ok':'status warn';
$('s_tknLoad').textContent='‚úì Normal';
$('s_tknLoad').className='status ok';
$('s_tpLoad').textContent='‚úì Normal';
$('s_tpLoad').className='status ok';
$('s_codLoad').textContent='‚úì Normal';
$('s_codLoad').className='status ok';

const mlvss=2000;
const aerVol=1.2;
const olr=bodLoad/(mlvss*aerVol*8.34);
$('stat_olr').textContent=fmt.f(olr,2);
$('stat_volLoad').textContent=fmt.f(bodLoad/(aerVol*7.48*1000),1);
$('stat_ratio').textContent=`100:${Math.round(tkn/bod*100)}:${Math.round(tp/bod*100)}`;

state.data={bodLoad,tssLoad,tknLoad,tpLoad,codLoad,flow,bod};
if($('kpi-flow'))$('kpi-flow').textContent=flow.toFixed(2);

showToast('Loading calculated successfully','success');
return state.data;
}

function resetLoading(){
$('flow').value='3.5';
$('bod').value='200';
$('tss').value='220';
$('tkn').value='40';
$('tp').value='8';
$('cod').value='450';
$('r_bodLoad').textContent='-';
$('r_tssLoad').textContent='-';
$('r_tknLoad').textContent='-';
$('r_tpLoad').textContent='-';
$('r_codLoad').textContent='-';
if($('s_bodLoad')){$('s_bodLoad').textContent='-';$('s_bodLoad').className='status';}
if($('s_tssLoad')){$('s_tssLoad').textContent='-';$('s_tssLoad').className='status';}
if($('s_tknLoad')){$('s_tknLoad').textContent='-';$('s_tknLoad').className='status';}
if($('s_tpLoad')){$('s_tpLoad').textContent='-';$('s_tpLoad').className='status';}
if($('s_codLoad')){$('s_codLoad').textContent='-';$('s_codLoad').className='status';}
showToast('Loading reset','info');
}

function compareHistorical(){
showToast('Comparing with 30-day historical average...','info');
setTimeout(()=>{
showToast('Current BOD load 5.2% above 30-day average','warning');
},1500);
}

function calcAll(){
calcLoading();
showToast('‚ú® All calculations complete!','success');
}

// Sludge calculations
function calcSludge(){
const base=state.data.bodLoad?state.data:calcLoading();
const flow=Number($('flow').value);
const mlss=Number($('mlss').value);
const mlvss=Number($('mlvss').value);
const aerVol=Number($('aerVol').value);
const rasFlow=Number($('rasFlow').value);
const wasFlow=Number($('wasFlow').value);
const wasTss=Number($('wasTss').value);

const fm=base.bodLoad/(mlvss*aerVol*8.34);
const mlssInv=mlss*aerVol*8.34;
const wasSolids=wasFlow*wasTss*8.34;
const mcrt=mlssInv/wasSolids;
const rasRate=(rasFlow/flow)*100;
const svi=120;

// Update results
$('r_fm_dash').textContent=fmt.f(fm,2);
$('r_mcrt_dash').textContent=fmt.f(mcrt,1);
$('r_svi_dash').textContent=fmt.f(svi,0);
if($('r_mlss_inv'))$('r_mlss_inv').textContent=fmt.f(mlssInv,0);
if($('r_was_solids'))$('r_was_solids').textContent=fmt.f(wasSolids,0);
if($('r_ras_rate'))$('r_ras_rate').textContent=fmt.f(rasRate,1);

// Update status indicators
$('s_fm').textContent=fm>=0.2&&fm<=0.5?'‚úì Optimal':'‚ö† Adjust';
$('s_fm').className=fm>=0.2&&fm<=0.5?'status ok':'status warn';
$('s_mcrt').textContent=mcrt>=6&&mcrt<=10?'‚úì Good':'‚ö† Review';
$('s_mcrt').className=mcrt>=6&&mcrt<=10?'status ok':'status warn';
$('s_svi').textContent=svi<150?'‚úì Good':'‚ö† High';
$('s_svi').className=svi<150?'status ok':'status warn';
if($('s_mlss_inv'))$('s_mlss_inv').textContent='‚úì Calculated';
if($('s_mlss_inv'))$('s_mlss_inv').className='status ok';
if($('s_was_solids'))$('s_was_solids').textContent=wasSolids>0?'‚úì Good':'‚ö† Check';
if($('s_was_solids'))$('s_was_solids').className=wasSolids>0?'status ok':'status warn';
if($('s_ras_rate'))$('s_ras_rate').textContent=rasRate>=25&&rasRate<=75?'‚úì Normal':'‚ö† Review';
if($('s_ras_rate'))$('s_ras_rate').className=rasRate>=25&&rasRate<=75?'status ok':'status warn';

if($('kpi-mlss'))$('kpi-mlss').textContent=mlss;
if($('kpi-fm'))$('kpi-fm').textContent=fmt.f(fm,2);

showToast('Sludge parameters calculated','success');
}

function resetSludge(){
$('mlss').value='2500';
$('mlvss').value='2000';
$('aerVol').value='1.2';
$('rasFlow').value='1.5';
$('wasFlow').value='0.05';
$('wasTss').value='8000';
$('r_fm').textContent='-';
$('r_mcrt').textContent='-';
$('r_svi').textContent='-';
if($('s_fm')){$('s_fm').textContent='-';$('s_fm').className='status';}
if($('s_mcrt')){$('s_mcrt').textContent='-';$('s_mcrt').className='status';}
if($('s_svi')){$('s_svi').textContent='-';$('s_svi').className='status';}
showToast('Sludge reset','info');
}

// Oxygen calculations
function calcOxygen(){
const base=state.data.bodLoad?state.data:calcLoading();
const peakFactor=Number($('peakFactor').value)||1.5;

const o2req=base.bodLoad*1.5;
const o2peak=o2req/24*peakFactor;
const airflow=o2peak*60/0.5;

$('r_o2req').textContent=fmt.n(o2req,0);
$('r_o2peak').textContent=fmt.n(o2peak,0);
$('r_airflow').textContent=fmt.n(airflow,0);

showToast('Oxygen requirements calculated','success');
}

function resetOxygen(){
$('doNow').value='2.0';
$('doTarget').value='2.5';
$('peakFactor').value='1.5';
$('r_o2req').textContent='-';
$('r_o2peak').textContent='-';
$('r_airflow').textContent='-';
showToast('Oxygen reset','info');
}

// Energy calculations
function calcEnergy(){
const base=state.data.flow?state.data:{flow:3.5};
const blowerHp=Number($('blowerHp').value);
const pumpHp=Number($('pumpHp').value);
const otherHp=Number($('otherHp').value);
const elecRate=Number($('elecRate').value);

const totPower=blowerHp+pumpHp+otherHp;
const dailyEnergy=totPower*0.746*24;
const monthCost=dailyEnergy*30*elecRate;
const kwhMg=dailyEnergy/base.flow;

$('r_dailyEnergy').textContent=fmt.n(dailyEnergy,0);
$('r_monthCost').textContent='$'+fmt.n(monthCost,0);
$('r_kwhMg').textContent=fmt.n(kwhMg,0);

if($('kpi-energy'))$('kpi-energy').textContent=fmt.n(kwhMg,0);

showToast('Energy analysis complete','success');
}

function resetEnergy(){
$('blowerHp').value='200';
$('pumpHp').value='100';
$('otherHp').value='50';
$('elecRate').value='0.12';
$('r_dailyEnergy').textContent='-';
$('r_monthCost').textContent='-';
$('r_kwhMg').textContent='-';
showToast('Energy reset','info');
}

function calcCosts(){
showToast('Cost analysis calculated','success');
}

function generateReport(type){
showToast(`Generating ${type} report...`,'info');
setTimeout(()=>showToast(`‚úì ${type.toUpperCase()} report generated`,'success'),1500);
}

function saveProfile(){
showToast('‚úì Profile saved successfully','success');
}

function loadProfile(){
showToast('Profile load functionality - use file selector','info');
}

function exportFullReport(){
showToast('‚úì Full report exported successfully','success');
}

function refreshDashboard(){
showToast('‚úì Dashboard refreshed','success');
}

function runOptimization(){
showToast('Running optimization analysis...','info');
setTimeout(()=>showToast('Optimization complete','success'),2000);
}

function predictTrends(){
showToast('üîÆ Predicting performance trends...','info');
}

// Sludge Age (SRT) Calculator
function calcSRT(){
  const mlss = parseFloat($('srt_mlss').value);
  const volume = parseFloat($('srt_volume').value);
  const effTSS = parseFloat($('srt_eff_tss').value);
  const effFlow = parseFloat($('srt_eff_flow').value);
  const wasteFlow = parseFloat($('srt_waste_flow').value);
  const wasteTSS = parseFloat($('srt_waste_tss').value);
  if(!mlss || !volume || !effTSS || !effFlow || !wasteFlow || !wasteTSS){
    $('srt_result').textContent='-';
    return;
  }
  const numerator = mlss * volume;
  const denominator = effFlow * effTSS + wasteFlow * wasteTSS;
  const srt = denominator === 0 ? 0 : numerator / denominator;
  $('srt_result').textContent = fmt.f(srt,2);
}

function resetSRT(){
  $('srt_mlss').value = 2500;
  $('srt_volume').value = 1.2;
  $('srt_eff_tss').value = 15;
  $('srt_eff_flow').value = 3.5;
  $('srt_waste_flow').value = 0.1;
  $('srt_waste_tss').value = 8000;
  $('srt_result').textContent = '-';
}

// BOD Removal Efficiency Calculator
function calcBODEff(){
  const influent = parseFloat($('bod_eff_in').value);
  const effluent = parseFloat($('bod_eff_out').value);
  if(!influent || influent === 0){
    $('bod_eff_result').textContent = '-';
    return;
  }
  const removal = ((influent - effluent) / influent) * 100;
  $('bod_eff_result').textContent = fmt.f(removal,1);
}

function resetBODEff(){
  $('bod_eff_in').value = 200;
  $('bod_eff_out').value = 10;
  $('bod_eff_result').textContent = '-';
}

// Sludge Volume Index (SVI) Calculator


// ==================== MISSING ORIGINAL CALCULATOR FUNCTIONS ====================

// Clarifier Calculator
// ==================== CLARIFIER CALCULATOR ====================
function calcClarifier() {
  // Get inputs - auto-fill from loading tab if empty
  let flow = Number($('clar_flow').value);
  let mlss = Number($('clar_mlss').value);
  
  // Auto-fill from state if available
  if (!flow && state.data && state.data.flow) {
    flow = state.data.flow;
    $('clar_flow').value = flow;
  }
  if (!mlss) {
    mlss = 2500; // Default MLSS
    $('clar_mlss').value = mlss;
  }
  
  const diam = Number($('clar_diam').value) || 65;
  const rasFlow = Number($('clar_ras_flow').value) || 1.0;
  const weirLength = Number($('clar_weir').value) || 204;
  
  // Calculations
  const area = Math.PI * Math.pow(diam/2, 2); // ft¬≤
  const sor = (flow * 1000000) / area; // gpd/ft¬≤
  
  // SLR = (Q + Qr) √ó MLSS √ó 8.34 / Area / 24 hr
  const totalFlow = flow + rasFlow; // MGD
  const slr = (totalFlow * mlss * 8.34) / area / 24; // lb/hr/ft¬≤
  
  // WOR = Flow / Weir Length
  const wor = (flow * 1000000) / weirLength; // gpd/ft
  
  // Display results
  $('r_sor').textContent = fmt.n(sor, 0);
  $('r_slr').textContent = fmt.f(slr, 1);
  $('r_wor').textContent = fmt.n(wor, 0);
  
  // Status indicators
  if (sor >= 400 && sor <= 800) {
    $('s_sor').textContent = '‚úì Normal';
    $('s_sor').className = 'status ok';
  } else if (sor < 400) {
    $('s_sor').textContent = '‚ö† Low';
    $('s_sor').className = 'status warn';
  } else {
    $('s_sor').textContent = '‚úó High';
    $('s_sor').className = 'status bad';
  }
  
  if (slr < 50) {
    $('s_slr').textContent = '‚úì Normal';
    $('s_slr').className = 'status ok';
  } else {
    $('s_slr').textContent = '‚úó Overloaded';
    $('s_slr').className = 'status bad';
  }
  
  if (wor < 15000) {
    $('s_wor').textContent = '‚úì Normal';
    $('s_wor').className = 'status ok';
  } else if (wor < 20000) {
    $('s_wor').textContent = '‚ö† High';
    $('s_wor').className = 'status warn';
  } else {
    $('s_wor').textContent = '‚úó Overloaded';
    $('s_wor').className = 'status bad';
  }
  
  showToast('Clarifier calculation complete', 'success');
}

function resetClarifier() {
  $('clar_flow').value = '';
  $('clar_diam').value = '65';
  $('clar_mlss').value = '';
  $('clar_ras_flow').value = '1.0';
  $('clar_weir').value = '204';
  
  // Clear results
  $('r_sor').textContent = '-';
  $('r_wor').textContent = '-';
  
  // Clear status
  if ($('s_sor')) { $('s_sor').textContent = '-'; $('s_sor').className = 'status'; }
  if ($('s_wor')) { $('s_wor').textContent = '-'; $('s_wor').className = 'status'; }
  
  showToast('Clarifier reset', 'info');
}

// ==================== NUTRIENTS CALCULATOR ====================
function calcNutrients() {
  // Get flow from loading tab if available
  let flow = state.data && state.data.flow ? state.data.flow : 3.5;
  
  const nh3In = Number($('nh3In').value) || 30;
  const nh3Out = Number($('nh3Out').value) || 1;
  
  // Calculate NH3-N removed (lb/d)
  const nh3Removed = (nh3In - nh3Out) * flow * 8.34;
  
  // Calculate % removal
  const pctRemoval = ((nh3In - nh3Out) / nh3In) * 100;
  
  // Display results
  $('r_nitrif').textContent = fmt.n(nh3Removed, 0);
  $('r_nitrifPct').textContent = fmt.f(pctRemoval, 1) + '%';
  
  showToast('Nutrients calculation complete', 'success');
}

// ==================== DISINFECTION CALCULATOR ====================
function calcDisinfection() {
  // Get flow - auto-fill from loading tab
  let flow = Number($('dis_flow').value);
  if (!flow && state.data && state.data.flow) {
    flow = state.data.flow;
    $('dis_flow').value = flow;
  }
  
  const vol = Number($('dis_vol').value) || 70000; // gallons
  const dose = Number($('dis_dose').value) || 8.0; // mg/L
  const residual = Number($('dis_residual').value) || 1.5; // mg/L
  
  // Detention Time = Volume / Flow (minutes)
  const detentionTime = vol / (flow * 1000000 / 1440); // minutes
  
  // Chlorine Demand = Dose - Residual
  const cl2Demand = dose - residual;
  
  // CT Value = Residual √ó Detention Time
  const ctValue = residual * detentionTime;
  
  // Display results
  $('r_detention_time').textContent = fmt.f(detentionTime, 1);
  $('r_cl2_demand').textContent = fmt.f(cl2Demand, 1);
  $('r_ct_value').textContent = fmt.f(ctValue, 1);
  
  // Status indicators
  if (detentionTime >= 30) {
    $('s_detention_time').textContent = '‚úì Adequate';
    $('s_detention_time').className = 'status ok';
  } else if (detentionTime >= 20) {
    $('s_detention_time').textContent = '‚ö† Low';
    $('s_detention_time').className = 'status warn';
  } else {
    $('s_detention_time').textContent = '‚úó Inadequate';
    $('s_detention_time').className = 'status bad';
  }
  
  if (ctValue >= 40) {
    $('s_ct_value').textContent = '‚úì Adequate';
    $('s_ct_value').className = 'status ok';
  } else if (ctValue >= 30) {
    $('s_ct_value').textContent = '‚ö† Low';
    $('s_ct_value').className = 'status warn';
  } else {
    $('s_ct_value').textContent = '‚úó Inadequate';
    $('s_ct_value').className = 'status bad';
  }
  
  showToast('Disinfection calculation complete', 'success');
}

function resetDisinfection() {
  $('dis_flow').value = '';
  $('dis_vol').value = '70000';
  $('dis_dose').value = '8.0';
  $('dis_residual').value = '1.5';
  
  $('r_detention_time').textContent = '-';
  $('r_cl2_demand').textContent = '-';
  $('r_ct_value').textContent = '-';
  if($('s_detention_time')){$('s_detention_time').textContent='-';$('s_detention_time').className='status';}
  if($('s_ct_value')){$('s_ct_value').textContent='-';$('s_ct_value').className='status';}
  
  showToast('Disinfection reset', 'info');
}

// ==================== DOSING CALCULATOR ====================
function calcDosing() {
  // Get flow - auto-fill from loading tab
  let flow = Number($('dosing_flow').value);
  if (!flow && state.data && state.data.flow) {
    flow = state.data.flow;
    $('dosing_flow').value = flow;
  }
  if (!flow) flow = 3.5; // Default
  
  // FERRIC CHLORIDE CALCULATIONS
  const feDose = Number($('fe_dose').value) || 40;
  const fePct = Number($('fe_pct').value) || 38;
  const feSG = Number($('fe_sg').value) || 1.4;
  const fePumpMax = Number($('fe_pump_max').value) || 20;
  const feStock = Number($('fe_stock_gal').value) || 5000;
  
  // Solution weight (lb/gal) = % √ó SG √ó 8.34
  const feSolWgt = (fePct / 100) * feSG * 8.34;
  
  // Chemical feed (lb/day) = Flow √ó Dose √ó 8.34
  const feChemFeed = flow * feDose * 8.34;
  
  // Solution feed (gal/day) = Chemical feed / Solution weight
  const feGPD = feChemFeed / feSolWgt;
  const feGPH = feGPD / 24;
  const feMLMin = feGPH * 3785.41 / 60; // Convert gph to mL/min
  
  // Pump setting % = (Required gph / Max gph) √ó 100
  const fePumpPct = (feGPH / fePumpMax) * 100;
  
  // Inventory
  const feUsageGPD = feGPD;
  const feDaysLeft = feStock / feUsageGPD;
  
  // Display Ferric results
  $('r_fe_sol_wgt').textContent = fmt.f(feSolWgt, 2);
  $('r_fe_chem_feed').textContent = fmt.n(feChemFeed, 0);
  $('r_fe_gpd').textContent = fmt.n(feGPD, 0);
  $('r_fe_gph').textContent = fmt.f(feGPH, 1);
  $('r_fe_ml_min').textContent = fmt.n(feMLMin, 0);
  $('r_fe_pump_pct').textContent = fmt.f(fePumpPct, 1);
  $('r_fe_usage_gpd').textContent = fmt.n(feUsageGPD, 0);
  $('r_fe_days_left').textContent = fmt.f(feDaysLeft, 1);
  
  if (feDaysLeft > 14) {
    $('s_fe_status').textContent = '‚úì Good';
    $('s_fe_status').className = 'status ok';
  } else if (feDaysLeft > 7) {
    $('s_fe_status').textContent = '‚ö† Low';
    $('s_fe_status').className = 'status warn';
  } else {
    $('s_fe_status').textContent = '‚úó Critical';
    $('s_fe_status').className = 'status bad';
  }
  
  // ALUMINUM SULFATE CALCULATIONS
  const alDose = Number($('al_dose').value) || 100;
  const alPct = Number($('al_pct').value) || 48.5;
  const alSG = Number($('al_sg').value) || 1.33;
  const alPumpMax = Number($('al_pump_max').value) || 40;
  const alStock = Number($('al_stock_gal').value) || 8000;
  
  const alSolWgt = (alPct / 100) * alSG * 8.34;
  const alChemFeed = flow * alDose * 8.34;
  const alGPD = alChemFeed / alSolWgt;
  const alGPH = alGPD / 24;
  const alMLMin = alGPH * 3785.41 / 60;
  const alPumpPct = (alGPH / alPumpMax) * 100;
  const alUsageGPD = alGPD;
  const alDaysLeft = alStock / alUsageGPD;
  
  // Display Alum results
  $('r_al_sol_wgt').textContent = fmt.f(alSolWgt, 2);
  $('r_al_chem_feed').textContent = fmt.n(alChemFeed, 0);
  $('r_al_gpd').textContent = fmt.n(alGPD, 0);
  $('r_al_gph').textContent = fmt.f(alGPH, 1);
  $('r_al_ml_min').textContent = fmt.n(alMLMin, 0);
  $('r_al_pump_pct').textContent = fmt.f(alPumpPct, 1);
  $('r_al_usage_gpd').textContent = fmt.n(alUsageGPD, 0);
  $('r_al_days_left').textContent = fmt.f(alDaysLeft, 1);
  
  if (alDaysLeft > 14) {
    $('s_al_status').textContent = '‚úì Good';
    $('s_al_status').className = 'status ok';
  } else if (alDaysLeft > 7) {
    $('s_al_status').textContent = '‚ö† Low';
    $('s_al_status').className = 'status warn';
  } else {
    $('s_al_status').textContent = '‚úó Critical';
    $('s_al_status').className = 'status bad';
  }
  
  showToast('Dosing calculation complete', 'success');
}

function resetDosing() {
  $('dosing_flow').value = '';
  $('fe_dose').value = '40';
  $('fe_pct').value = '38';
  $('fe_sg').value = '1.4';
  $('fe_pump_max').value = '20';
  $('fe_stock_gal').value = '5000';
  $('al_dose').value = '100';
  $('al_pct').value = '48.5';
  $('al_sg').value = '1.33';
  $('al_pump_max').value = '40';
  $('al_stock_gal').value = '8000';
  
  // Clear Ferric results
  $('r_fe_sol_wgt').textContent = '-';
  $('r_fe_chem_feed').textContent = '-';
  $('r_fe_gpd').textContent = '-';
  $('r_fe_gph').textContent = '-';
  $('r_fe_ml_min').textContent = '-';
  $('r_fe_pump_pct').textContent = '-';
  $('r_fe_days_left').textContent = '-';
  if ($('s_fe_pump')) { $('s_fe_pump').textContent = '-'; $('s_fe_pump').className = 'status'; }
  if ($('s_fe_stock')) { $('s_fe_stock').textContent = '-'; $('s_fe_stock').className = 'status'; }
  
  // Clear Alum results
  $('r_al_sol_wgt').textContent = '-';
  $('r_al_chem_feed').textContent = '-';
  $('r_al_gpd').textContent = '-';
  $('r_al_gph').textContent = '-';
  $('r_al_ml_min').textContent = '-';
  $('r_al_pump_pct').textContent = '-';
  $('r_al_days_left').textContent = '-';
  if ($('s_al_pump')) { $('s_al_pump').textContent = '-'; $('s_al_pump').className = 'status'; }
  if ($('s_al_stock')) { $('s_al_stock').textContent = '-'; $('s_al_stock').className = 'status'; }
  
  showToast('Dosing reset', 'info');
}

// ==================== DIGESTER CALCULATOR ====================


// ==================== DEWATERING CALCULATOR ====================
function calcDewatering() {
  const feedFlow = Number($('dew_feed_flow').value) || 100; // gpm
  const feedSolids = Number($('dew_feed_solids').value) || 3.0; // %
  const polyFlow = Number($('dew_poly_flow').value) || 20; // gph
  const polyConc = Number($('dew_poly_conc').value) || 0.5; // %
  const cakeSolids = Number($('dew_cake_solids').value) || 18; // %
  const filtrateTSS = Number($('dew_filtrate_tss').value) || 500; // mg/L
  
  // Dry Solids In (lb/hr)
  const drySolidsIn = feedFlow * 60 * 8.34 * (feedSolids / 100);
  
  // Polymer Dose (lb/ton)
  const polyLbHr = polyFlow * 8.34 * (polyConc / 100); // lb polymer/hr
  const polyDose = (polyLbHr / (drySolidsIn / 2000)) * 1; // lb polymer/ton dry solids
  
  // Solids Capture Rate (%)
  // Solids out in cake vs total solids in
  const totalSolidsLbHr = drySolidsIn;
  const filtrateLbHr = (feedFlow * 60 * 8.34 * filtrateTSS) / 1000000; // Convert mg/L to lb/hr
  const capturedSolids = totalSolidsLbHr - filtrateLbHr;
  const captureRate = (capturedSolids / totalSolidsLbHr) * 100;
  
  // Cake Production (wet ton/day)
  const cakeLbDay = (drySolidsIn * 24) / (cakeSolids / 100);
  const cakeTonDay = cakeLbDay / 2000;
  
  // Display results
  $('r_dry_solids_in').textContent = fmt.n(drySolidsIn, 0);
  $('r_poly_dose').textContent = fmt.f(polyDose, 1);
  $('r_solids_capture').textContent = fmt.f(captureRate, 1);
  $('r_cake_prod').textContent = fmt.f(cakeTonDay, 1);
  
  // Status indicators
  if (polyDose >= 15 && polyDose <= 30) {
    $('s_poly_dose').textContent = '‚úì Normal';
    $('s_poly_dose').className = 'status ok';
  } else if (polyDose < 15) {
    $('s_poly_dose').textContent = '‚ö† Low';
    $('s_poly_dose').className = 'status warn';
  } else {
    $('s_poly_dose').textContent = '‚ö† High';
    $('s_poly_dose').className = 'status warn';
  }
  
  if (captureRate >= 95) {
    $('s_solids_capture').textContent = '‚úì Excellent';
    $('s_solids_capture').className = 'status ok';
  } else if (captureRate >= 90) {
    $('s_solids_capture').textContent = '‚ö† Fair';
    $('s_solids_capture').className = 'status warn';
  } else {
    $('s_solids_capture').textContent = '‚úó Poor';
    $('s_solids_capture').className = 'status bad';
  }
  
  showToast('Dewatering calculation complete', 'success');
}

function resetDewatering() {
  $('dew_feed_flow').value = '100';
  $('dew_feed_solids').value = '3.0';
  $('dew_poly_flow').value = '20';
  $('dew_poly_conc').value = '0.5';
  $('dew_cake_solids').value = '18';
  $('dew_filtrate_tss').value = '500';
  
  $('r_dry_solids_in').textContent = '-';
  $('r_poly_dose').textContent = '-';
  $('r_cake_prod').textContent = '-';
  $('r_solids_capture').textContent = '-';
  if($('s_poly_dose')){$('s_poly_dose').textContent='-';$('s_poly_dose').className='status';}
  if($('s_solids_capture')){$('s_solids_capture').textContent='-';$('s_solids_capture').className='status';}
  
  showToast('Dewatering reset', 'info');
}

// ==================== PUMPING CALCULATOR ====================
function calcPumping() {
  const flow = Number($('pump_flow').value) || 1000; // gpm
  const head = Number($('pump_head').value) || 50; // ft
  const pumpEff = Number($('pump_eff').value) || 75; // %
  const motorEff = Number($('motor_eff').value) || 90; // %
  const costPerKWH = 0.12; // $/kWh - typical utility rate
  
  // Water Horsepower (WHP) = (Flow √ó Head √ó SG) / 3960
  const whp = (flow * head * 1.0) / 3960;
  
  // Brake Horsepower (BHP) = WHP / Pump Efficiency
  const bhp = whp / (pumpEff / 100);
  
  // Wire-to-Water HP = WHP / (Pump Eff √ó Motor Eff)
  const wireHP = whp / ((pumpEff / 100) * (motorEff / 100));
  
  // Power Consumption (kW) = HP √ó 0.746
  const powerKW = wireHP * 0.746;
  
  // Daily Energy Cost = kW √ó 24 hours √ó cost per kWh
  const dailyCost = powerKW * 24 * costPerKWH;
  
  // Display results
  $('r_whp').textContent = fmt.f(whp, 2);
  $('r_bhp').textContent = fmt.f(bhp, 2);
  $('r_wire_hp').textContent = fmt.f(wireHP, 2);
  $('r_power_kw').textContent = fmt.f(powerKW, 2);
  $('r_pump_cost').textContent = '$' + fmt.f(dailyCost, 2);
  
  showToast('Pumping calculation complete', 'success');
}

function resetPumping() {
  $('pump_flow').value = '1000';
  $('pump_head').value = '50';
  $('pump_eff').value = '75';
  $('motor_eff').value = '90';
  
  $('r_whp').textContent = '-';
  $('r_bhp').textContent = '-';
  $('r_wire_hp').textContent = '-';
  $('r_power_kw').textContent = '-';
  $('r_pump_cost').textContent = '-';
  
  showToast('Pumping reset', 'info');
}

// ==================== NEW ADVANCED CALCULATOR FUNCTIONS ====================

// 1. OLR Calculator


// 2. VLR Calculator
function calcVLR() {
  const bod = parseFloat($('vlr_bod').value);
  const flow = parseFloat($('vlr_flow').value);
  const volume = parseFloat($('vlr_volume').value);
  
  if (!bod || !flow || !volume) {
    $('vlr_result').textContent = '-';
    return;
  }
  
  const vlr = (bod * flow * 8.34) / volume;
  
  $('vlr_result').textContent = fmt.n(vlr, 0);
  showToast('VLR calculated successfully', 'success');
}

function resetVLR() {
  $('vlr_bod').value = 180;
  $('vlr_flow').value = 3.5;
  $('vlr_volume').value = 1.0;
  $('vlr_result').textContent = '-';
}

// 3. RAS Calculator


// 4. Detention Time Calculator
function calcDetention() {
  const volume = parseFloat($('dt_volume').value);
  const flow = parseFloat($('dt_flow').value);
  
  if (!volume || !flow) {
    $('dt_result_hours').textContent = '-';
    $('dt_result_days').textContent = '-';
    return;
  }
  
  const detentionDays = volume / flow;
  const detentionHours = detentionDays * 24;
  
  $('dt_result_hours').textContent = fmt.f(detentionHours, 1);
  $('dt_result_days').textContent = fmt.f(detentionDays, 2);
  showToast('Detention time calculated', 'success');
}

function resetDetention() {
  $('dt_volume').value = 1.2;
  $('dt_flow').value = 3.5;
  $('dt_result_hours').textContent = '-';
  $('dt_result_days').textContent = '-';
}

// 5. WOR Calculator


// 6. SLR Calculator


// 7. Alkalinity Calculator
function calcAlkalinity() {
  var tkn = parseFloat(document.getElementById('alk_tkn').value) || 0;
  var flow = parseFloat(document.getElementById('alk_flow').value) || 0;
  var consumed = tkn * 7.14; // 7.14 mg alk per mg NH3-N oxidized
  var daily = consumed * flow * 8.34;
  document.getElementById('r_alk_consumed').textContent = consumed.toFixed(1);
  document.getElementById('r_alk_daily').textContent = daily.toFixed(0);
}

function resetAlkalinity() {
  document.getElementById('alk_tkn').value = '25';
  document.getElementById('alk_flow').value = '5.0';
  document.getElementById('r_alk_consumed').textContent = '-';
  document.getElementById('r_alk_daily').textContent = '-';
}

// 8. Oxygen Requirements Calculator
function calcOxygenReq() {
  const bodRemoved = parseFloat($('o2_bod').value);
  const nh3Oxidized = parseFloat($('o2_nh3').value);
  const endoFactor = parseFloat($('o2_endo').value);
  const mlss = parseFloat($('o2_mlss').value);
  const volume = parseFloat($('o2_volume').value);
  
  if (!bodRemoved) {
    $('o2_total').textContent = '-';
    $('o2_rate').textContent = '-';
    return;
  }
  
  const biomassProd = bodRemoved * 0.5;
  const endoResp = mlss && volume ? endoFactor * mlss * volume * 8.34 : 0;
  const o2Total = bodRemoved + (4.57 * nh3Oxidized) - (1.42 * biomassProd) + endoResp;
  const o2Rate = o2Total / 24;
  
  $('o2_total').textContent = fmt.n(o2Total, 0);
  $('o2_rate').textContent = fmt.f(o2Rate, 1);
  showToast('Oxygen requirements calculated', 'success');
}

function resetOxygenReq() {
  $('o2_bod').value = 5835;
  $('o2_nh3').value = 730;
  $('o2_endo').value = 0.12;
  $('o2_mlss').value = 2500;
  $('o2_volume').value = 1.2;
  $('o2_total').textContent = '-';
  $('o2_rate').textContent = '-';
}

// 9. Air Requirements Calculator
function calcAir() {
  const o2Required = parseFloat($('air_o2').value);
  const ote = parseFloat($('air_ote').value);
  const depth = parseFloat($('air_depth').value);
  
  if (!o2Required || !ote) {
    $('air_scfm').textContent = '-';
    $('air_hp').textContent = '-';
    return;
  }
  
  const airLbMin = o2Required / 60 / (0.232 * ote / 100);
  const airSCFM = airLbMin / 0.075;
  
  const pressurePsi = 14.7 + (depth * 0.433);
  const pressureRatio = pressurePsi / 14.7;
  const efficiency = 0.7;
  const hp = (airSCFM * pressureRatio) / (efficiency * 229);
  
  $('air_scfm').textContent = fmt.n(airSCFM, 0);
  $('air_hp').textContent = fmt.f(hp, 1);
  showToast('Air requirements calculated', 'success');
}

function resetAir() {
  $('air_o2').value = 450;
  $('air_ote').value = 12;
  $('air_depth').value = 15;
  $('air_temp').value = 20;
  $('air_scfm').textContent = '-';
  $('air_hp').textContent = '-';
}

// 10. Polymer Dosage Calculator


// 11. pH Adjustment Calculator
function calcPH() {
  const flow = parseFloat($('ph_flow').value);
  const current = parseFloat($('ph_current').value);
  const target = parseFloat($('ph_target').value);
  const chemical = $('ph_chemical').value;
  const strength = parseFloat($('ph_strength').value);
  
  if (!flow || !current || !target || !strength) {
    $('ph_feed').textContent = '-';
    $('ph_daily').textContent = '-';
    return;
  }
  
  const pHChange = Math.abs(target - current);
  const alkChange = pHChange * 100;
  
  const factors = {naoh: 1.25, lime: 1.79, h2so4: 1.02, hcl: 1.37};
  const chemicalNeeded = alkChange * factors[chemical];
  const chemicalLbDay = flow * chemicalNeeded * 8.34;
  
  const sg = {naoh: 1.5, lime: 1.2, h2so4: 1.8, hcl: 1.2};
  const feedGPD = chemicalLbDay / ((strength / 100) * 8.34 * sg[chemical]);
  
  $('ph_feed').textContent = fmt.f(feedGPD, 1);
  $('ph_daily').textContent = fmt.n(chemicalLbDay, 0);
  showToast('pH adjustment calculated (jar test recommended)', 'warning');
}

function resetPH() {
  $('ph_flow').value = 3.5;
  $('ph_current').value = 5.8;
  $('ph_target').value = 7.0;
  $('ph_chemical').value = 'naoh';
  $('ph_strength').value = 50;
  $('ph_feed').textContent = '-';
  $('ph_daily').textContent = '-';
}

// 12. Chlorine Dosage Calculator


// 13. Enhanced SRT Calculator
function calcSRTEnhanced() {
  const mlss = parseFloat($('srt_enh_mlss').value);
  const volume = parseFloat($('srt_enh_volume').value);
  const effTSS = parseFloat($('srt_enh_eff_tss').value);
  const effFlow = parseFloat($('srt_enh_eff_flow').value);
  const wasteFlow = parseFloat($('srt_enh_waste_flow').value);
  const wasteTSS = parseFloat($('srt_enh_waste_tss').value);
  
  if (!mlss || !volume || !effFlow || !wasteFlow) {
    $('srt_enh_result').textContent = '-';
    $('srt_classification').textContent = '-';
    return;
  }
  
  const numerator = mlss * volume;
  const denominator = effTSS * effFlow + wasteTSS * wasteFlow;
  const srt = denominator > 0 ? numerator / denominator : 0;
  
  $('srt_enh_result').textContent = fmt.f(srt, 1);
  
  let classification = '';
  if (srt < 2) classification = 'High-Rate';
  else if (srt < 5) classification = 'Conventional (Short)';
  else if (srt < 15) classification = 'Conventional';
  else if (srt < 20) classification = 'Extended Aeration';
  else classification = 'Extended Aeration (Long)';
  
  $('srt_classification').textContent = classification;
  showToast('Enhanced SRT calculated', 'success');
}

function resetSRTEnhanced() {
  $('srt_enh_mlss').value = 2500;
  $('srt_enh_volume').value = 1.2;
  $('srt_enh_eff_tss').value = 15;
  $('srt_enh_eff_flow').value = 3.5;
  $('srt_enh_waste_flow').value = 0.1;
  $('srt_enh_waste_tss').value = 8000;
  $('srt_enh_result').textContent = '-';
  $('srt_classification').textContent = '-';
}

// 14. BOD Efficiency Calculator
function calcBODEfficiency() {
  const bodIn = parseFloat($('bodeff_in').value);
  const bodOut = parseFloat($('bodeff_out').value);
  const flow = parseFloat($('bodeff_flow').value);
  
  if (!bodIn || bodIn === 0) {
    $('bodeff_percent').textContent = '-';
    $('bodeff_removed').textContent = '-';
    $('bodeff_status').textContent = '-';
    return;
  }
  
  const efficiency = ((bodIn - bodOut) / bodIn) * 100;
  const bodRemoved = (bodIn - bodOut) * flow * 8.34;
  
  $('bodeff_percent').textContent = fmt.f(efficiency, 1);
  $('bodeff_removed').textContent = fmt.n(bodRemoved, 0);
  
  let status = '';
  if (efficiency >= 95) status = '‚úì Excellent (Tertiary)';
  else if (efficiency >= 90) status = '‚úì Very Good (Advanced)';
  else if (efficiency >= 85) status = '‚úì Good (Secondary)';
  else if (efficiency >= 75) status = '‚ö† Marginal';
  else status = '‚úó Poor';
  
  $('bodeff_status').textContent = status;
  showToast('BOD efficiency calculated', 'success');
}

function resetBODEfficiency() {
  $('bodeff_in').value = 200;
  $('bodeff_out').value = 10;
  $('bodeff_flow').value = 3.5;
  $('bodeff_percent').textContent = '-';
  $('bodeff_removed').textContent = '-';
  $('bodeff_status').textContent = '-';
}

// 15. SVI Calculator Enhanced
function calcSVICalc() {
  const volume = parseFloat($('svi_vol').value);
  const mlss = parseFloat($('svi_mlss_calc').value);
  
  if (!volume || !mlss || mlss === 0) {
    $('svi_calc_result').textContent = '-';
    $('svi_quality').textContent = '-';
    return;
  }
  
  const svi = (volume * 1000) / mlss;
  
  $('svi_calc_result').textContent = fmt.f(svi, 1);
  
  let quality = '';
  if (svi < 50) quality = '‚úó Very Poor Settling';
  else if (svi < 100) quality = '‚úì Excellent';
  else if (svi < 150) quality = '‚úì Good';
  else if (svi < 200) quality = '‚ö† Fair';
  else quality = '‚úó Poor (Bulking)';
  
  $('svi_quality').textContent = quality;
  showToast('SVI calculated', 'success');
}

function resetSVICalc() {
  $('svi_vol').value = 150;
  $('svi_mlss_calc').value = 3000;
  $('svi_calc_result').textContent = '-';
  $('svi_quality').textContent = '-';
}

// 16. Nitrogen Balance Calculator
function calcNitrogen() {
  const tknIn = parseFloat($('n_tkn_in').value);
  const nh3In = parseFloat($('n_nh3_in').value);
  const tknOut = parseFloat($('n_tkn_out').value);
  const nh3Out = parseFloat($('n_nh3_out').value);
  const no3Out = parseFloat($('n_no3_out').value);
  const flow = parseFloat($('n_flow').value);
  
  if (!tknIn || tknIn === 0) {
    $('n_tkn_eff').textContent = '-';
    $('n_nh3_eff').textContent = '-';
    $('n_total_removed').textContent = '-';
    $('n_denit_eff').textContent = '-';
    return;
  }
  
  const tknEff = ((tknIn - tknOut) / tknIn) * 100;
  const nh3Eff = nh3In > 0 ? ((nh3In - nh3Out) / nh3In) * 100 : 0;
  const totalNRemoved = (tknIn - tknOut - no3Out) * flow * 8.34;
  
  const nh3Oxidized = nh3In - nh3Out;
  const potentialNO3 = nh3Oxidized;
  const denitEff = potentialNO3 > 0 ? ((potentialNO3 - no3Out) / potentialNO3) * 100 : 0;
  
  $('n_tkn_eff').textContent = fmt.f(tknEff, 1);
  $('n_nh3_eff').textContent = fmt.f(nh3Eff, 1);
  $('n_total_removed').textContent = fmt.n(totalNRemoved, 0);
  $('n_denit_eff').textContent = fmt.f(denitEff, 1);
  showToast('Nitrogen balance calculated', 'success');
}

function resetNitrogen() {
  $('n_tkn_in').value = 35;
  $('n_nh3_in').value = 25;
  $('n_tkn_out').value = 2;
  $('n_nh3_out').value = 0.5;
  $('n_no3_out').value = 8;
  $('n_flow').value = 3.5;
  $('n_tkn_eff').textContent = '-';
  $('n_nh3_eff').textContent = '-';
  $('n_total_removed').textContent = '-';
  $('n_denit_eff').textContent = '-';
}

// ==================== PROCESS CALCULATIONS ENHANCEMENTS ====================

// Calculation tracking
let calculationStats = {
  completed: 0,
  inRange: 0,
  warnings: 0,
  critical: 0,
  history: []
};

// Calculate All Process Calculators
function calculateAllProcess() {
  showToast('üöÄ Running all process calculations...', 'info');
  
  const calculators = [
    'calcOLR', 'calcVLR', 'calcBODEfficiency',
    'calcDetention', 'calcWOR', 'calcSLR', 'calcRAS',
    'calcClarifier',
    'calcSRTEnhanced', 'calcSVICalc', 'calcNitrogen', 'calcNutrients',
    'calcAlkalinity', 'calcPH', 'calcPolymer', 'calcDosing', 'calcChlorine',
    'calcOxygenReq', 'calcAir',
    'calcDigester', 'calcDewatering',
    'calcDisinfection',
    'calcPumping'
  ];
  
  let completed = 0;
  calculators.forEach((calc, index) => {
    setTimeout(() => {
      if (window[calc]) {
        try {
          window[calc]();
          completed++;
          updateProcessSummary();
        } catch(e) {
          console.log(`Calculator ${calc} not available`);
        }
      }
      if (index === calculators.length - 1) {
        setTimeout(() => {
          showToast(`‚úÖ Completed ${completed} calculations!`, 'success');
          generateCalculationSummary();
        }, 500);
      }
    }, index * 100);
  });
}

// Expand All Categories
function expandAllCategories() {
  $$('.calc-category').forEach(cat => {
    cat.classList.remove('collapsed');
  });
  showToast('üìÇ All categories expanded', 'info');
}

// Collapse All Categories
function collapseAllCategories() {
  $$('.calc-category').forEach(cat => {
    cat.classList.add('collapsed');
  });
  showToast('üìÅ All categories collapsed', 'info');
}

// Toggle Category Collapse
function toggleCategory(element) {
  const category = element.closest('.calc-category');
  if (category) {
    category.classList.toggle('collapsed');
  }
}

// Add click handlers to category headers
setTimeout(() => {
  $$('.calc-category-header').forEach(header => {
    header.style.cursor = 'pointer';
    header.onclick = function() {
      toggleCategory(this);
    };
  });
}, 1000);

// Update Process Summary Cards
function updateProcessSummary() {
  // Count status indicators
  let inRange = 0, warnings = 0, critical = 0;
  
  $$('.status.ok').forEach(() => inRange++);
  $$('.status.warn').forEach(() => warnings++);
  $$('.status.bad').forEach(() => critical++);
  
  // Count completed calculations (any result not "-")
  let completed = 0;
  $$('#process-calcs .result').forEach(el => {
    if (el.textContent !== '-' && el.textContent.trim() !== '') {
      completed++;
    }
  });
  
  // Update cards
  if ($('completed-calcs')) $('completed-calcs').textContent = Math.min(completed, 25);
  if ($('in-range-calcs')) $('in-range-calcs').textContent = inRange;
  if ($('warning-calcs')) $('warning-calcs').textContent = warnings;
  if ($('critical-calcs')) $('critical-calcs').textContent = critical;
  
  calculationStats.completed = completed;
  calculationStats.inRange = inRange;
  calculationStats.warnings = warnings;
  calculationStats.critical = critical;
}

// Generate Calculation Summary
function generateCalculationSummary() {
  const summary = {
    timestamp: new Date().toISOString(),
    stats: calculationStats,
    plantName: $('plantName') ? $('plantName').value : 'Unknown',
    operator: $('operatorName') ? $('operatorName').value : 'Unknown'
  };
  
  calculationStats.history.push(summary);
  
  // Keep only last 10 summaries
  if (calculationStats.history.length > 10) {
    calculationStats.history.shift();
  }
  
  // Store in localStorage
  try {
    localStorage.setItem('wwtp_calc_history', JSON.stringify(calculationStats.history));
  } catch(e) {
    console.log('Could not save history');
  }
}

// Show Calculation History
function showCalculationHistory() {
  if (calculationStats.history.length === 0) {
    showToast('üìä No calculation history yet', 'info');
    return;
  }
  
  let historyHTML = '<div style="max-height:400px;overflow-y:auto">';
  historyHTML += '<h3 style="margin-bottom:15px">üìä Calculation History</h3>';
  historyHTML += '<table class="enhanced-table"><thead><tr><th>Timestamp</th><th>Completed</th><th>‚úì In Range</th><th>‚ö† Warnings</th><th>üî¥ Critical</th></tr></thead><tbody>';
  
  calculationStats.history.slice().reverse().forEach(entry => {
    const date = new Date(entry.timestamp);
    historyHTML += `<tr>
      <td>${date.toLocaleString()}</td>
      <td>${entry.stats.completed}</td>
      <td style="color:var(--ok)">${entry.stats.inRange}</td>
      <td style="color:var(--warn)">${entry.stats.warnings}</td>
      <td style="color:var(--bad)">${entry.stats.critical}</td>
    </tr>`;
  });
  
  historyHTML += '</tbody></table></div>';
  
  // Show in a modal or alert
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-container);padding:30px;border-radius:12px;box-shadow:var(--shadow-xl);z-index:10000;max-width:800px;width:90%';
  modal.innerHTML = historyHTML + '<br><button class="btn gray" onclick="this.parentElement.remove()">Close</button>';
  
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999';
  overlay.onclick = () => {
    modal.remove();
    overlay.remove();
  };
  
  document.body.appendChild(overlay);
  document.body.appendChild(modal);
}

// Export Process Report
function exportProcessReport() {
  showToast('üìÑ Generating process calculations report...', 'info');
  
  // Collect all calculation results
  let reportData = {
    plantName: $('plantName') ? $('plantName').value : 'WWTP',
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString(),
    operator: $('operatorName') ? $('operatorName').value : '',
    calculations: []
  };
  
  // Gather data from all calculators
  $$('#process-calcs .calc-item').forEach(item => {
    const title = item.querySelector('.calc-item-title, .section-h');
    if (title) {
      const calcData = {
        name: title.textContent,
        results: []
      };
      
      item.querySelectorAll('.result').forEach(result => {
        const label = result.closest('tr')?.querySelector('.rowh')?.textContent || 
                     result.closest('p')?.textContent.split(':')[0] || 'Result';
        const value = result.textContent;
        if (value !== '-') {
          calcData.results.push({ label, value });
        }
      });
      
      if (calcData.results.length > 0) {
        reportData.calculations.push(calcData);
      }
    }
  });
  
  // Generate HTML report
  let reportHTML = `
<!DOCTYPE html>
<html>
<head>
  <title>WWTP Command Center v9.9.16</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { color: #2c5aa0; border-bottom: 3px solid #2c5aa0; padding-bottom: 10px; }
    h2 { color: #667eea; margin-top: 30px; }
    .header-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 30px; }
    .calc-section { margin-bottom: 25px; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6; }
    th { background: #e3f2fd; font-weight: 600; }
    .footer { margin-top: 50px; text-align: center; color: #6c757d; font-size: 12px; }
  </style>
</head>
<body>
  <h1>üßÆ WWTP Process Calculations Report</h1>
  <div class="header-info">
    <strong>Plant:</strong> ${reportData.plantName}<br>
    <strong>Date:</strong> ${reportData.date}<br>
    <strong>Time:</strong> ${reportData.time}<br>
    <strong>Operator:</strong> ${reportData.operator}<br>
    <strong>Total Calculations:</strong> ${reportData.calculations.length}
  </div>
`;

  reportData.calculations.forEach(calc => {
    reportHTML += `<div class="calc-section">
      <h2>${calc.name}</h2>
      <table>
        <thead><tr><th>Parameter</th><th>Value</th></tr></thead>
        <tbody>`;
    
    calc.results.forEach(result => {
      reportHTML += `<tr><td>${result.label}</td><td><strong>${result.value}</strong></td></tr>`;
    });
    
    reportHTML += '</tbody></table></div>';
  });
  
  reportHTML += `
  <div class="footer">
    <p>Generated by WWTP Command Center Professional Edition</p>
    <p>Report generated on ${new Date().toLocaleString()}</p>
  </div>


<\/body>\n<\/html>`;
  
  // Open in new window for download/print
  const reportWindow = window.open('', '_blank');
  reportWindow.document.write(reportHTML);
  reportWindow.document.close();
  
  showToast('‚úÖ Report generated! Opening in new window...', 'success');
  
  // Auto-trigger print dialog after a short delay
  setTimeout(() => {
    reportWindow.print();
  }, 500);
}

// Print Process Calculations
function printProcessCalcs() {
  showToast('üñ®Ô∏è Preparing print view...', 'info');
  window.print();
}

// Enhanced Status Update Function
function updateCalculatorStatus(resultId, value, targetMin, targetMax, unit = '') {
  const resultElement = $(resultId);
  const statusElement = $(resultId.replace('r_', 's_'));
  
  if (!resultElement) return;
  
  resultElement.textContent = value + (unit ? ' ' + unit : '');
  
  if (statusElement && targetMin !== undefined && targetMax !== undefined) {
    if (value >= targetMin && value <= targetMax) {
      statusElement.innerHTML = '<span class="status-badge good">‚úì Normal</span>';
      statusElement.className = 'status ok';
    } else if (value < targetMin * 0.8 || value > targetMax * 1.2) {
      statusElement.innerHTML = '<span class="status-badge critical">‚úó Critical</span>';
      statusElement.className = 'status bad';
    } else {
      statusElement.innerHTML = '<span class="status-badge warning">‚ö† Warning</span>';
      statusElement.className = 'status warn';
    }
  }
  
  updateProcessSummary();
}

// Load calculation history from localStorage on startup
setTimeout(() => {
  try {
    const stored = localStorage.getItem('wwtp_calc_history');
    if (stored) {
      calculationStats.history = JSON.parse(stored);
    }
  } catch(e) {
    console.log('Could not load history');
  }
  
  // Update summary on load
  updateProcessSummary();
}, 1000);

// Input Validation Helper
function validateInput(inputId, min, max, defaultValue) {
  const input = $(inputId);
  if (!input) return defaultValue;
  
  let value = Number(input.value);
  
  if (isNaN(value) || value < min || value > max) {
    input.style.borderColor = 'var(--bad)';
    input.title = `Please enter a value between ${min} and ${max}`;
    return defaultValue;
  } else {
    input.style.borderColor = 'var(--border-input)';
    input.title = '';
    return value;
  }
}

// Progress Bar Helper
function createProgressBar(percentage, className = 'good') {
  return `
    <div class="progress-bar-container">
      <div class="progress-bar ${className}" style="width:${percentage}%">
        ${percentage.toFixed(0)}%
      </div>
    </div>
  `;
}

// Auto-save functionality
let autoSaveTimer;
function enableAutoSave() {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => {
    try {
      const data = {
        timestamp: Date.now(),
        inputs: {}
      };
      
      $$('#process-calcs input[type="number"]').forEach(input => {
        if (input.id && input.value) {
          data.inputs[input.id] = input.value;
        }
      });
      
      localStorage.setItem('wwtp_autosave', JSON.stringify(data));
      console.log('Auto-saved at', new Date().toLocaleTimeString());
    } catch(e) {
      console.log('Auto-save failed');
    }
  }, 5000);
}

// Monitor input changes for auto-save
$$('#process-calcs input').forEach(input => {
  input.addEventListener('change', enableAutoSave);
});


// Toggle collapsible sections
function toggleCollapsible(header) {
  const content = header.nextElementSibling;
  const icon = header.querySelector('span');
  if (content.classList.contains('active')) {
    content.classList.remove('active');
    icon.textContent = '‚ñº';
  } else {
    content.classList.add('active');
    icon.textContent = '‚ñ≤';
  }
}

// Generate AI Recommendations
function generateOptimizationRecommendations() {
  const recommendations = [];
  
  // Check various parameters and generate recommendations
  
  // F/M Ratio check
  const mlss = state.data && state.data.mlss ? state.data.mlss : 2500;
  const bod = state.data && state.data.bod ? state.data.bod : 200;
  const fm = state.data && state.data.fm ? state.data.fm : 0.3;
  
  if (fm > 0.5) {
    recommendations.push({
      priority: 'high',
      icon: '‚ö†Ô∏è',
      title: 'High F/M Ratio Detected',
      description: `Current F/M: ${fm.toFixed(2)}. Consider increasing MLSS or reducing WAS rate to improve settling.`,
      action: 'Reduce WAS by 10-15% or increase aeration basin volume utilization'
    });
  } else if (fm < 0.15) {
    recommendations.push({
      priority: 'medium',
      icon: 'üí°',
      title: 'Low F/M Ratio - Potential for Nitrification',
      description: `Current F/M: ${fm.toFixed(2)}. System is suitable for nitrification. Consider optimizing for nitrogen removal.`,
      action: 'Maintain longer SRT (15-20 days) and DO > 2 mg/L for nitrification'
    });
  }
  
  // Energy optimization
  const kwhPerMG = 2000; // Example value
  if (kwhPerMG > 1800) {
    recommendations.push({
      priority: 'medium',
      icon: '‚ö°',
      title: 'Energy Consumption Above Industry Average',
      description: `Current usage: ${kwhPerMG} kWh/MG. Industry average: 1400-1600 kWh/MG.`,
      action: 'Implement VFD controls on blowers, optimize DO setpoints (1.5-2.5 mg/L), check for air leaks'
    });
  }
  
  // Chemical dosing optimization
  recommendations.push({
    priority: 'low',
    icon: 'üß™',
    title: 'Chemical Dosing Optimization Available',
    description: 'Review chemical inventory levels and dosing rates for potential cost savings.',
    action: 'Conduct jar tests to optimize polymer and coagulant dosing'
  });
  
  // SVI recommendation
  const svi = 150; // Example
  if (svi > 150) {
    recommendations.push({
      priority: 'high',
      icon: 'üî¥',
      title: 'Sludge Bulking Detected',
      description: `SVI: ${svi} mL/g (target: <150). Poor settling indicated.`,
      action: 'Increase DO to 2.5+ mg/L, reduce F/M ratio, consider selector zone or chlorination'
    });
  }
  
  // Display recommendations
  const container = $('#recommendations-list');
  if (container && recommendations.length > 0) {
    let html = '';
    recommendations.forEach(rec => {
      const priorityColor = rec.priority === 'high' ? 'var(--bad)' : 
                           rec.priority === 'medium' ? 'var(--warn)' : 'var(--info)';
      html += `
        <div style="margin-bottom:20px;padding:15px;background:var(--bg-card);border-left:4px solid ${priorityColor};border-radius:8px">
          <div style="display:flex;align-items:start;gap:10px">
            <span style="font-size:18px">${rec.icon}</span>
            <div style="flex:1">
              <h4 style="margin:0 0 8px 0;color:var(--text-accent)">${rec.title}</h4>
              <p style="margin:0 0 8px 0;color:var(--text)">${rec.description}</p>
              <div style="padding:10px;background:var(--bg-section);border-radius:6px;font-size:14px">
                <strong>Action:</strong> ${rec.action}
              </div>
            </div>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }
}

// Update compliance indicators
function updateComplianceStatus() {
  // Example compliance checks (would use actual permit limits in production)
  const bodLimit = 30; // mg/L
  const tssLimit = 30; // mg/L
  const nh3Limit = 5; // mg/L
  const doMin = 2.0; // mg/L
  
  // Get current values (these would come from actual measurements)
  // For demo, showing compliance
  if ($('compliance-bod')) $('compliance-bod').textContent = '‚úì 98%';
  if ($('compliance-tss')) $('compliance-tss').textContent = '‚úì 97%';
  if ($('compliance-nh3')) $('compliance-nh3').textContent = '‚úì 99%';
  if ($('compliance-do')) $('compliance-do').textContent = '‚úì Yes';
}

// Run optimization check after calculations
setTimeout(() => {
  generateOptimizationRecommendations();
  updateComplianceStatus();
}, 2000);






// ==================== ABSOLUTE APEX EDITION FEATURES ====================

// Global APEX state
let apexState = {
  ai: {
    active: false,
    conversation: [],
    model: 'GPT-4-WWTP-Specialist'
  },
  voice: {
    listening: false,
    recognition: null,
    synthesis: null
  },
  digitalTwin: {
    components: [],
    simulation: null
  },
  ml: {
    insights: [],
    learning: true,
    accuracy: 94.7
  },
  blockchain: {
    blocks: [],
    verified: true
  },
  iot: {
    sensors: [],
    connected: true
  },
  quantum: {
    enabled: false,
    qubits: 8
  }
};

// ==================== AI COPILOT SYSTEM ====================

function initAICopilot() {
  // Create AI copilot interface
  const copilot = document.createElement('div');
  copilot.className = 'ai-copilot';
  copilot.id = 'ai-copilot';
  copilot.innerHTML = `
    <div class="ai-header">
      <div style="display:flex;align-items:center;gap:15px">
        <div class="ai-avatar">ü§ñ</div>
        <div>
          <div style="font-weight:700;font-size:16px">WWTP AI Copilot</div>
          <div style="font-size:12px;opacity:0.8">Powered by Advanced ML</div>
        </div>
      </div>
      <button onclick="toggleAICopilot()" style="background:none;border:none;color:white;font-size:18px;cursor:pointer">√ó</button>
    </div>
    <div class="ai-chat" id="ai-chat">
      <div class="ai-message bot">
        üëã Hello! I'm your AI Copilot. I can help you with:
        <br>‚Ä¢ Process optimization
        <br>‚Ä¢ Troubleshooting issues
        <br>‚Ä¢ Predicting trends
        <br>‚Ä¢ Regulatory compliance
        <br>‚Ä¢ Best practices
        <br><br>What would you like to know?
      </div>
    </div>
    <div class="ai-input-area">
      <input type="text" class="ai-input" id="ai-input" placeholder="Ask me anything about WWTP operations..." onkeypress="if(event.key==='Enter')sendAIMessage()">
      <button class="ai-send-btn" onclick="sendAIMessage()">Send üöÄ</button>
    </div>
  `;
  document.body.appendChild(copilot);
}

function toggleAICopilot() {
  const copilot = $('ai-copilot');
  apexState.ai.active = !apexState.ai.active;
  if (apexState.ai.active) {
    copilot.classList.add('active');
  } else {
    copilot.classList.remove('active');
  }
}

function sendAIMessage() {
  const input = $('ai-input') || $('ai-input-2');
  const chat = $('ai-chat');
  if (!input || !chat) return;
  
  const message = input.value.trim();
  if (!message) return;
  
  // Add user message
  const userMsg = document.createElement('div');
  userMsg.className = 'ai-message user';
  userMsg.textContent = message;
  chat.appendChild(userMsg);
  
  input.value = '';
  chat.scrollTop = chat.scrollHeight;
  
  // Use the main AI response generator (with TIER 1 intelligence)
  setTimeout(() => {
    const botMsg = document.createElement('div');
    botMsg.className = 'ai-message bot';
    // Try generateAIResponse from main AI system first
    if (typeof generateAIResponse === 'function') {
      botMsg.innerHTML = generateAIResponse(message);
    } else {
      botMsg.innerHTML = "I'm having trouble processing that. Please try again.";
    }
    chat.appendChild(botMsg);
    chat.scrollTop = chat.scrollHeight;
  }, 500);
  
  if (typeof apexState !== 'undefined' && apexState.ai) {
    apexState.ai.conversation.push({user: message, timestamp: new Date()});
  }
}

// ==================== VOICE CONTROL SYSTEM ====================













// ==================== DIGITAL TWIN SYSTEM ====================

function showDigitalTwin() {
  const html = `
    <div class="digital-twin" style="max-width:1200px">
      <h2 style="margin-bottom:10px">üè≠ Digital Twin Simulation</h2>
      <p style="opacity:0.9;margin-bottom:20px">Real-time virtual model of your treatment plant</p>
      
      <div class="twin-container">
        <div class="twin-component" onclick="showComponentDetail('influent')">
          <div style="font-size:36px;margin-bottom:10px">üåä</div>
          <div style="font-size:16px;font-weight:700">Influent</div>
          <div style="font-size:18px;margin:10px 0">2.5 MGD</div>
          <div class="twin-status">
            <span style="font-size:13px">Flow Rate</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
        
        <div class="twin-component" onclick="showComponentDetail('primary')">
          <div style="font-size:36px;margin-bottom:10px">‚öôÔ∏è</div>
          <div style="font-size:16px;font-weight:700">Primary</div>
          <div style="font-size:18px;margin:10px 0">65% TSS</div>
          <div class="twin-status">
            <span style="font-size:13px">Removal</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
        
        <div class="twin-component" onclick="showComponentDetail('aeration')">
          <div style="font-size:36px;margin-bottom:10px">üí®</div>
          <div style="font-size:16px;font-weight:700">Aeration</div>
          <div style="font-size:18px;margin:10px 0">2.2 mg/L</div>
          <div class="twin-status">
            <span style="font-size:13px">DO Level</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
        
        <div class="twin-component" onclick="showComponentDetail('clarifier')">
          <div style="font-size:36px;margin-bottom:10px">üîÑ</div>
          <div style="font-size:16px;font-weight:700">Clarifier</div>
          <div style="font-size:18px;margin:10px 0">125 SVI</div>
          <div class="twin-status">
            <span style="font-size:13px">Settling</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
        
        <div class="twin-component" onclick="showComponentDetail('ras')">
          <div style="font-size:36px;margin-bottom:10px">‚ôªÔ∏è</div>
          <div style="font-size:16px;font-weight:700">RAS</div>
          <div style="font-size:18px;margin:10px 0">65%</div>
          <div class="twin-status">
            <span style="font-size:13px">Return Rate</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
        
        <div class="twin-component" onclick="showComponentDetail('effluent')">
          <div style="font-size:36px;margin-bottom:10px">‚úÖ</div>
          <div style="font-size:16px;font-weight:700">Effluent</div>
          <div style="font-size:18px;margin:10px 0">5 mg/L</div>
          <div class="twin-status">
            <span style="font-size:13px">BOD</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:12px">
        <h4 style="margin-bottom:15px">üéØ Twin Simulation Controls</h4>
        <div style="display:flex;gap:15px;flex-wrap:wrap">
          <button class="btn green" onclick="runSimulation()">‚ñ∂Ô∏è Run Simulation</button>
          <button class="btn blue" onclick="adjustParameters()">‚öôÔ∏è Adjust Parameters</button>
          <button class="btn" style="background:var(--warn);color:white" onclick="testScenario()">üß™ Test Scenario</button>
          <button class="btn" style="background:var(--purple);color:white" onclick="exportTwinData()">üíæ Export Data</button>
        </div>
      </div>
    </div>
  `;
  
  showModal('üè≠ Digital Twin', html);
}

function showComponentDetail(component) {
  showNotification('Component Details', `Viewing ${component} component analytics`, 'info');
}

function runDigitalTwinSimulation() {
  showNotification('Simulation Running', 'Digital twin simulation in progress...', 'info');
  setTimeout(() => {
    showNotification('Simulation Complete', 'All parameters within optimal range', 'success');
  }, 2000);
}

function adjustParameters() {
  showNotification('Parameter Adjustment', 'Opening parameter controls...', 'info');
}

function testScenario() {
  showNotification('Scenario Testing', 'What-if analysis initiated', 'info');
}

function exportTwinData() {
  showNotification('Exporting Twin Data', 'Digital twin data exported', 'success');
}

// ==================== MACHINE LEARNING INSIGHTS ====================

function showMLInsights() {
  const html = `
    <div class="ml-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">üß† Machine Learning Insights</h2>
      <p style="opacity:0.9;margin-bottom:20px">AI-powered pattern recognition and optimization</p>
      
      <div style="margin-bottom:25px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <span>Model Accuracy</span>
          <span class="ml-confidence">${apexState.ml.accuracy}%</span>
        </div>
        <div class="learning-indicator">
          <div class="learning-progress" style="--progress:${apexState.ml.accuracy}%"></div>
        </div>
      </div>
      
      <div class="ml-insight">
        <strong>üìà Pattern Detected:</strong> Your F/M ratio follows a predictable weekly cycle, peaking on Mondays (0.42) and lowest on Fridays (0.28). ML model suggests this is due to industrial discharge patterns.
        <span class="ml-confidence">92% confidence</span>
      </div>
      
      <div class="ml-insight">
        <strong>‚ö° Energy Optimization:</strong> ML analysis identifies 3 high-impact opportunities saving 18% energy ($6,200/month) with zero process risk.
        <span class="ml-confidence">96% confidence</span>
      </div>
      
      <div class="ml-insight">
        <strong>üîÆ Predictive Maintenance:</strong> Blower #2 showing early wear patterns. ML predicts 78% probability of failure within 45-60 days. Schedule maintenance now to prevent emergency.
        <span class="ml-confidence">89% confidence</span>
      </div>
      
      <div class="ml-insight">
        <strong>üéØ Process Optimization:</strong> By adjusting RAS rate to 62% (from 65%) during 10am-2pm daily, ML models show 8% energy savings with improved settling.
        <span class="ml-confidence">94% confidence</span>
      </div>
      
      <div class="ml-insight">
        <strong>üìä Anomaly Detection:</strong> Influent BOD varies 35% more on Mondays than other days. ML recommends equalization basin improvements for cost savings.
        <span class="ml-confidence">91% confidence</span>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">üéì Model Training Status</h4>
        <div style="font-size:14px;line-height:1.8">
          ‚Ä¢ Training Data Points: <strong>45,890</strong><br>
          ‚Ä¢ Models Deployed: <strong>12</strong><br>
          ‚Ä¢ Predictions Made: <strong>3,247</strong><br>
          ‚Ä¢ Average Accuracy: <strong>94.7%</strong><br>
          ‚Ä¢ Last Training: <strong>2 hours ago</strong>
        </div>
      </div>
    </div>
  `;
  
  showModal('üß† Machine Learning', html);
}

// ==================== BLOCKCHAIN AUDIT TRAIL ====================

function showBlockchainAudit() {
  const html = `
    <div class="blockchain-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">üîó Blockchain Audit Trail</h2>
      <p style="opacity:0.9;margin-bottom:20px">Immutable record of all operations and changes</p>
      
      <div class="block-chain">
        <div class="block">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
            <div>
              <strong>Block #8472</strong>
              <div style="font-size:13px;opacity:0.8;margin-top:4px">${new Date().toLocaleString()}</div>
            </div>
            <span class="verified-badge">VERIFIED ‚úì</span>
          </div>
          <div style="font-size:14px;margin-bottom:8px">
            <strong>Action:</strong> Process calculations updated<br>
            <strong>User:</strong> Operator AK<br>
            <strong>Changes:</strong> F/M 0.35, SVI 125, DO 2.2
          </div>
          <div class="block-hash">
            Hash: 0x7d8f4e2a9c1b5f3e8d2a6c4b9e7f1d3a5c8b2e4d6f9a1c3e5b7d9f2a4c6e8
          </div>
        </div>
        
        <div class="block">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
            <div>
              <strong>Block #8471</strong>
              <div style="font-size:13px;opacity:0.8;margin-top:4px">${new Date(Date.now() - 3600000).toLocaleString()}</div>
            </div>
            <span class="verified-badge">VERIFIED ‚úì</span>
          </div>
          <div style="font-size:14px;margin-bottom:8px">
            <strong>Action:</strong> Automation rule triggered<br>
            <strong>Rule:</strong> Daily report export<br>
            <strong>Status:</strong> Completed successfully
          </div>
          <div class="block-hash">
            Hash: 0x3a5c7e9b2d4f6a8c1e3b5d7f9a2c4e6b8d1f3a5c7e9b2d4f6a8c1e3b5d7f9
          </div>
        </div>
        
        <div class="block">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
            <div>
              <strong>Block #8470</strong>
              <div style="font-size:13px;opacity:0.8;margin-top:4px">${new Date(Date.now() - 7200000).toLocaleString()}</div>
            </div>
            <span class="verified-badge">VERIFIED ‚úì</span>
          </div>
          <div style="font-size:14px;margin-bottom:8px">
            <strong>Action:</strong> Compliance check passed<br>
            <strong>Parameters:</strong> BOD, TSS, NH3-N<br>
            <strong>Result:</strong> All within limits
          </div>
          <div class="block-hash">
            Hash: 0x9f2a4c6e8b1d3f5a7c9e2b4d6f8a1c3e5b7d9f2a4c6e8b1d3f5a7c9e2b4d6
          </div>
        </div>
      </div>
      
      <div style="margin-top:30px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">üìä Blockchain Statistics</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;text-align:center">
          <div>
            <div style="font-size:20px;font-weight:700">8,472</div>
            <div style="font-size:13px;opacity:0.8">Total Blocks</div>
          </div>
          <div>
            <div style="font-size:20px;font-weight:700">100%</div>
            <div style="font-size:13px;opacity:0.8">Verified</div>
          </div>
          <div>
            <div style="font-size:20px;font-weight:700">0</div>
            <div style="font-size:13px;opacity:0.8">Tampered</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showModal('üîó Blockchain Audit', html);
}

// ==================== IOT SENSOR DASHBOARD ====================

function showIOTDashboard() {
  const html = `
    <div style="max-width:1200px">
      <h2 style="margin-bottom:10px">üì° IoT Sensor Dashboard</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Real-time data from connected sensors</p>
      
      <div class="iot-dashboard">
        <div class="sensor-card">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">Influent pH</div>
              <div class="sensor-value">7.2</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live ‚Ä¢ Updated 2s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üß™</div>
          </div>
        </div>
        
        <div class="sensor-card" style="background:linear-gradient(135deg,#4facfe,#00f2fe)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">DO Basin 1</div>
              <div class="sensor-value">2.2</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live ‚Ä¢ Updated 1s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üí®</div>
          </div>
        </div>
        
        <div class="sensor-card" style="background:linear-gradient(135deg,#fa709a,#fee140)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9;color:#000">MLSS</div>
              <div class="sensor-value" style="color:#000">3,450</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px;color:#000">Live ‚Ä¢ Updated 5s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üî¨</div>
          </div>
        </div>
        
        <div class="sensor-card" style="background:linear-gradient(135deg,#30cfd0,#330867)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">Flow Rate</div>
              <div class="sensor-value">2.5</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live ‚Ä¢ Updated 3s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üåä</div>
          </div>
        </div>
        
        <div class="sensor-card" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">Temperature</div>
              <div class="sensor-value">18¬∞C</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live ‚Ä¢ Updated 4s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üå°Ô∏è</div>
          </div>
        </div>
        
        <div class="sensor-card" style="background:linear-gradient(135deg,#a8edea,#fed6e3)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9;color:#000">Turbidity</div>
              <div class="sensor-value" style="color:#000">8 NTU</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px;color:#000">Live ‚Ä¢ Updated 6s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üíß</div>
          </div>
        </div>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:var(--bg-section);border-radius:12px">
        <h4 style="margin-bottom:15px">üìä IoT Network Status</h4>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;text-align:center">
          <div>
            <div style="font-size:18px;font-weight:700;color:var(--ok)">24</div>
            <div style="font-size:13px;color:var(--text-unit)">Sensors Online</div>
          </div>
          <div>
            <div style="font-size:18px;font-weight:700;color:var(--ok)">98.7%</div>
            <div style="font-size:13px;color:var(--text-unit)">Uptime</div>
          </div>
          <div>
            <div style="font-size:18px;font-weight:700;color:var(--info)">2.4s</div>
            <div style="font-size:13px;color:var(--text-unit)">Avg Latency</div>
          </div>
          <div>
            <div style="font-size:18px;font-weight:700;color:var(--info)">1.2M</div>
            <div style="font-size:13px;color:var(--text-unit)">Data Points</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showModal('üì° IoT Sensors', html);
}

// ==================== NATURAL LANGUAGE PROCESSING ====================

function showNLQuery() {
  const html = `
    <div class="nl-query-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">üí¨ Natural Language Query</h2>
      <p style="opacity:0.9;margin-bottom:20px">Ask questions in plain English - no technical knowledge required!</p>
      
      <div class="nl-input-wrapper">
        <input type="text" class="nl-input" id="nl-query-input" placeholder="e.g., What's my sludge age? or How much energy can I save?">
        <button class="nl-submit" onclick="processNLQuery()">Ask üöÄ</button>
      </div>
      
      <div style="margin-top:20px">
        <div style="font-size:14px;opacity:0.9;margin-bottom:10px">üí° Try these examples:</div>
        <div class="nl-examples">
          <div class="nl-example" onclick="setNLQuery('What is my current F/M ratio?')">What is my current F/M ratio?</div>
          <div class="nl-example" onclick="setNLQuery('How can I save energy?')">How can I save energy?</div>
          <div class="nl-example" onclick="setNLQuery('Is my plant operating efficiently?')">Is my plant operating efficiently?</div>
          <div class="nl-example" onclick="setNLQuery('What should I adjust today?')">What should I adjust today?</div>
          <div class="nl-example" onclick="setNLQuery('Show me compliance status')">Show me compliance status</div>
          <div class="nl-example" onclick="setNLQuery('Predict next week performance')">Predict next week performance</div>
        </div>
      </div>
    </div>
  `;
  
  showModal('üí¨ Natural Language Query', html);
}

function setNLQuery(query) {
  $('nl-query-input').value = query;
}

function processNLQuery() {
  const query = $('nl-query-input').value;
  if (!query) return;
  
  showNotification('Processing Query', 'Analyzing your question...', 'info');
  
  setTimeout(() => {
    // Simulate NLP processing
    const answer = generateNLAnswer(query);
    showModal('üí¨ Answer', `
      <div style="max-width:700px">
        <h3 style="color:var(--text-accent);margin-bottom:15px">Your Question:</h3>
        <p style="background:var(--bg-section);padding:15px;border-radius:10px;margin-bottom:20px">"${query}"</p>
        
        <h3 style="color:var(--text-accent);margin-bottom:15px">Answer:</h3>
        <div style="background:var(--bg-section);padding:20px;border-radius:10px;line-height:1.8">
          ${answer}
        </div>
        
        <div style="margin-top:20px;text-align:center">
          <button class="btn blue" onclick="showNLQuery()">Ask Another Question</button>
        </div>
      </div>
    `);
  }, 1500);
}

function generateNLAnswer(query) {
  const q = query.toLowerCase();
  
  if (q.includes('f/m')) {
    return `Your current <strong>Food-to-Microorganism (F/M) ratio is 0.35</strong>, which is in the optimal range of 0.2-0.4 for conventional activated sludge. This indicates a healthy balance between food availability and bacterial population. ‚úÖ`;
  }
  
  if (q.includes('energy') || q.includes('save')) {
    return `Based on current data, you can save approximately <strong>$4,500/month</strong> through:<br>
      ‚Ä¢ Reducing RAS rate by 5% (saves 120 kWh/day)<br>
      ‚Ä¢ Optimizing DO to 2.0 mg/L (saves 80 kWh/day)<br>
      ‚Ä¢ Implementing VFD controls (saves 50 kWh/day)<br><br>
      Total potential: <strong>250 kWh/day savings</strong> ‚ö°`;
  }
  
  if (q.includes('efficient') || q.includes('operating')) {
    return `Yes! Your plant is operating <strong>very efficiently</strong>. Key indicators:<br>
      ‚Ä¢ BOD removal: <strong>95%</strong> (excellent)<br>
      ‚Ä¢ F/M ratio: <strong>0.35</strong> (optimal)<br>
      ‚Ä¢ SVI: <strong>125 mL/g</strong> (good settling)<br>
      ‚Ä¢ Compliance: <strong>98%</strong> (exceeding standards)<br><br>
      Overall grade: <strong>A+ (Excellent)</strong> üåü`;
  }
  
  return `I understand your question about "${query}". Based on current data, everything looks good! Your plant is operating within optimal parameters. Would you like specific recommendations for optimization?`;
}

// ==================== QUANTUM ANALYTICS (FUTURE-READY) ====================

function showQuantumAnalytics() {
  const html = `
    <div class="quantum-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">‚öõÔ∏è Quantum Analytics (Future-Ready)</h2>
      <p style="opacity:0.9;margin-bottom:20px">Next-generation computing for ultra-complex optimization</p>
      
      <div style="background:rgba(255,255,255,0.1);padding:25px;border-radius:12px;margin-bottom:20px;text-align:center">
        <div style="font-size:48px;margin-bottom:15px">‚öõÔ∏è</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:10px">Quantum Computing Ready</div>
        <div style="font-size:14px;opacity:0.9">This system is prepared for quantum computing integration when technology becomes commercially available</div>
      </div>
      
      <div class="quantum-grid">
        ${Array(16).fill(0).map((_, i) => `<div class="quantum-bit">${['0','1'][Math.floor(Math.random()*2)]}</div>`).join('')}
      </div>
      
      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">üöÄ Quantum Capabilities (When Available)</h4>
        <ul style="line-height:2;font-size:14px">
          <li>‚úÖ Process optimization across 1000+ variables simultaneously</li>
          <li>‚úÖ Real-time molecular-level treatment modeling</li>
          <li>‚úÖ Ultra-precise energy optimization (quantum annealing)</li>
          <li>‚úÖ Instant complex scenario testing (Grover's algorithm)</li>
          <li>‚úÖ Perfect predictive analytics (quantum machine learning)</li>
        </ul>
      </div>
    </div>
  `;
  
  showModal('‚öõÔ∏è Quantum Analytics', html);
}

// Initialize APEX features
setTimeout(() => {
  initAICopilot();
  console.log('üëë ABSOLUTE APEX Edition Loaded!');
  console.log('   ‚Ä¢ AI Copilot System');
  console.log('   ‚Ä¢ Voice Control');
  console.log('   ‚Ä¢ Digital Twin');
  console.log('   ‚Ä¢ Machine Learning');
  console.log('   ‚Ä¢ Blockchain Audit');
  console.log('   ‚Ä¢ IoT Dashboard');
  console.log('   ‚Ä¢ Natural Language Query');
  console.log('   ‚Ä¢ Quantum-Ready Analytics');
  console.log('   ‚Ä¢ Plus all SUPREME features');
}, 2500);

// ==================== SUPREME EDITION FEATURES ====================

// Global SUPREME state
let supremeState = {
  realtime: {
    connected: true,
    lastSync: new Date(),
    syncInterval: null
  },
  automation: {
    rules: [],
    triggers: []
  },
  alerts: [],
  performance: {
    loadTime: 0,
    calculations: 0,
    averageTime: 0
  },
  dashboard: {
    widgets: [],
    layout: 'default'
  },
  offline: false
};

// ==================== REAL-TIME SYNC SYSTEM ====================

function initRealTimeSync() {
  // Simulate real-time connection
  updateSyncStatus('online');
  
  // Check connection periodically
  supremeState.realtime.syncInterval = setInterval(() => {
    if (navigator.onLine) {
      if (supremeState.offline) {
        supremeState.offline = false;
        updateSyncStatus('online');
        showNotification('Back Online', 'Connection restored', 'success');
      }
      simulateDataSync();
    } else {
      if (!supremeState.offline) {
        supremeState.offline = true;
        updateSyncStatus('offline');
        showNotification('Offline Mode', 'Working offline - changes will sync when online', 'warning');
      }
    }
  }, 5000);
}

function updateSyncStatus(status) {
  const badge = document.getElementById('headerOnlineStatus');
  if (!badge) return;
  
  if (status === 'online') {
    badge.innerHTML = 'üü¢ Online';
    badge.style.background = '#10b981';
  } else if (status === 'syncing') {
    badge.innerHTML = 'üîÑ Syncing';
    badge.style.background = '#3b82f6';
  } else if (status === 'offline') {
    badge.innerHTML = 'üî¥ Offline';
    badge.style.background = '#ef4444';
  }
}

function simulateDataSync() {
  // Simulate background sync
  supremeState.realtime.lastSync = new Date();
  
  // Randomly trigger sync animation
  if (Math.random() > 0.8) {
    updateSyncStatus('syncing');
    setTimeout(() => updateSyncStatus('online'), 1000);
  }
}

// ==================== AUTOMATION RULES ENGINE ====================

function showAutomationRules() {
  const rules = getDefaultAutomationRules();
  
  const html = `
    <div style="max-width:900px">
      <h2 style="margin-bottom:20px">‚öôÔ∏è Automation Rules Engine</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Configure automatic actions based on process conditions</p>
      
      <div style="margin-bottom:20px">
        <button class="btn green" onclick="createNewRule()">‚ûï Create New Rule</button>
        <button class="btn blue" onclick="loadRuleTemplates()" style="margin-left:10px">üìã Load Templates</button>
      </div>
      
      <div id="rules-container">
        ${rules.map(rule => `
          <div class="rule-card">
            <div style="display:flex;justify-content:space-between;align-items:start">
              <div style="flex:1">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                  <strong style="font-size:16px">${rule.name}</strong>
                  <span class="rule-status ${rule.active ? 'active' : 'inactive'}">
                    ${rule.active ? 'Active' : 'Inactive'}
                  </span>
                </div>
                <div style="color:var(--text-unit);font-size:13px;margin-bottom:8px">
                  <strong>IF:</strong> ${rule.condition}
                </div>
                <div style="color:var(--text-unit);font-size:13px">
                  <strong>THEN:</strong> ${rule.action}
                </div>
                <div style="margin-top:10px;font-size:12px;color:var(--text-unit)">
                  Triggered: ${rule.triggerCount} times
                </div>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn small" onclick="toggleRule('${rule.id}')" style="padding:6px 12px">
                  ${rule.active ? 'Disable' : 'Enable'}
                </button>
                <button class="btn small" onclick="editRule('${rule.id}')" style="padding:6px 12px">Edit</button>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  
  showModal('‚öôÔ∏è Automation Rules', html);
}

function getDefaultAutomationRules() {
  return [
    {
      id: 'rule1',
      name: 'High F/M Alert',
      condition: 'F/M Ratio > 0.5',
      action: 'Send alert and log to history',
      active: true,
      triggerCount: 12
    },
    {
      id: 'rule2',
      name: 'Low DO Warning',
      condition: 'DO < 1.5 mg/L',
      action: 'Notify operator and increase aeration',
      active: true,
      triggerCount: 5
    },
    {
      id: 'rule3',
      name: 'Auto Export Daily Report',
      condition: 'Every day at 6:00 AM',
      action: 'Generate and email daily report',
      active: true,
      triggerCount: 42
    },
    {
      id: 'rule4',
      name: 'Bulking Detection',
      condition: 'SVI > 150 for 3 consecutive readings',
      action: 'Alert supervisor and log incident',
      active: true,
      triggerCount: 3
    },
    {
      id: 'rule5',
      name: 'Energy Optimization',
      condition: 'Energy > 1800 kWh/MG',
      action: 'Suggest RAS reduction and log opportunity',
      active: false,
      triggerCount: 0
    }
  ];
}

function toggleRule(ruleId) {
  showNotification('Rule Updated', `Rule ${ruleId} toggled`, 'success');
  showAutomationRules();
}

function editRule(ruleId) {
  showNotification('Edit Rule', 'Rule editor coming soon!', 'info');
}

function createNewRule() {
  showNotification('Create Rule', 'Rule creator coming soon!', 'info');
}

function loadRuleTemplates() {
  showNotification('Templates', 'Loading rule templates...', 'info');
}

// ==================== SMART ALERT SYSTEM ====================

function initSmartAlerts() {
  // Create alert panel if it doesn't exist
  if (!$('alert-panel')) {
    const panel = document.createElement('div');
    panel.id = 'alert-panel';
    panel.className = 'alert-panel';
    document.body.appendChild(panel);
  }
  
  // Simulate smart alerts periodically
  setInterval(() => {
    if (Math.random() > 0.95) {
      triggerSmartAlert();
    }
  }, 30000); // Check every 30 seconds
}

function triggerSmartAlert() {
  const alerts = [
    {
      type: 'warning',
      title: 'Process Alert',
      message: 'F/M ratio approaching high limit (0.48)',
      actions: ['View Details', 'Dismiss']
    },
    {
      type: 'info',
      title: 'Optimization Opportunity',
      message: 'Energy usage 12% above target - reduce RAS?',
      actions: ['View Recommendation', 'Dismiss']
    },
    {
      type: 'critical',
      title: 'Critical Parameter',
      message: 'DO reading below 1.0 mg/L in basin 2',
      actions: ['Investigate', 'Acknowledge']
    }
  ];
  
  const alert = alerts[Math.floor(Math.random() * alerts.length)];
  showSmartAlert(alert);
}

function showSmartAlert(alert) {
  const panel = $('alert-panel');
  if (!panel) return;
  
  const alertEl = document.createElement('div');
  alertEl.className = `alert-item ${alert.type}`;
  alertEl.innerHTML = `
    <div class="alert-header">
      <div class="alert-title">${alert.title}</div>
      <div class="alert-time">${new Date().toLocaleTimeString()}</div>
    </div>
    <div class="alert-body">${alert.message}</div>
    <div class="alert-actions">
      ${alert.actions.map(action => `
        <button class="alert-btn ${action === 'Dismiss' ? 'secondary' : 'primary'}" 
                onclick="this.closest('.alert-item').remove()">
          ${action}
        </button>
      `).join('')}
    </div>
  `;
  
  panel.appendChild(alertEl);
  
  // Auto-remove after 30 seconds
  setTimeout(() => alertEl.remove(), 30000);
  
  // Update alert count
  supremeState.alerts.push(alert);
}

// ==================== PERFORMANCE MONITORING ====================

function showPerformanceMonitor() {
  const perf = calculatePerformanceMetrics();
  
  const html = `
    <div class="performance-panel">
      <h2 style="margin-bottom:20px">‚ö° Performance Monitor</h2>
      <p style="opacity:0.9;margin-bottom:20px">Real-time system performance metrics</p>
      
      <div class="perf-metric">
        <div>
          <div class="perf-label">Page Load Time</div>
          <div class="perf-value">${perf.loadTime}ms</div>
        </div>
        <div class="perf-indicator">‚ö°</div>
      </div>
      
      <div class="perf-metric">
        <div>
          <div class="perf-label">Calculations Performed</div>
          <div class="perf-value">${perf.calculations}</div>
        </div>
        <div class="perf-indicator">üßÆ</div>
      </div>
      
      <div class="perf-metric">
        <div>
          <div class="perf-label">Average Calc Time</div>
          <div class="perf-value">${perf.avgCalcTime}ms</div>
        </div>
        <div class="perf-indicator">‚è±Ô∏è</div>
      </div>
      
      <div class="perf-metric">
        <div>
          <div class="perf-label">Memory Usage</div>
          <div class="perf-value">${perf.memoryUsage}MB</div>
        </div>
        <div class="perf-indicator">üíæ</div>
      </div>
      
      <div class="perf-metric">
        <div>
          <div class="perf-label">Storage Used</div>
          <div class="perf-value">${perf.storageUsed}KB</div>
        </div>
        <div class="perf-indicator">üì¶</div>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">üìä System Health</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;text-align:center">
          <div>
            <div style="font-size:32px;margin-bottom:5px">‚úÖ</div>
            <div style="font-size:14px">Excellent</div>
          </div>
          <div>
            <div style="font-size:32px;margin-bottom:5px">‚ö°</div>
            <div style="font-size:14px">Fast</div>
          </div>
          <div>
            <div style="font-size:32px;margin-bottom:5px">üíØ</div>
            <div style="font-size:14px">100% Uptime</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showModal('‚ö° Performance Monitor', html);
}

function calculatePerformanceMetrics() {
  const loadTime = performance.now();
  const memory = performance.memory ? (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1) : 'N/A';
  
  // Calculate storage used
  let storageUsed = 0;
  try {
    for (let key in localStorage) {
      if (localStorage.hasOwnProperty(key)) {
        storageUsed += localStorage[key].length + key.length;
      }
    }
    storageUsed = (storageUsed / 1024).toFixed(1);
  } catch(e) {
    storageUsed = 'N/A';
  }
  
  return {
    loadTime: loadTime.toFixed(0),
    calculations: supremeState.performance.calculations,
    avgCalcTime: supremeState.performance.averageTime.toFixed(2),
    memoryUsage: memory,
    storageUsed: storageUsed
  };
}

// ==================== ADVANCED DASHBOARD ====================

function showAdvancedDashboard() {
  const html = `
    <div style="max-width:1200px">
      <h2 style="margin-bottom:20px">üìä Advanced Dashboard</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <p style="color:var(--text-unit);margin:0">Customizable real-time operations dashboard</p>
        <div>
          <button class="btn green" onclick="addDashboardWidget()">‚ûï Add Widget</button>
          <button class="btn blue" onclick="saveDashboardLayout()" style="margin-left:8px">üíæ Save Layout</button>
        </div>
      </div>
      
      <div class="dashboard-grid" id="dashboard-grid">
        ${generateDashboardWidgets()}
      </div>
    </div>
  `;
  
  showModal('üìä Advanced Dashboard', html);
}

function generateDashboardWidgets() {
  const widgets = [
    { icon: 'üéØ', title: 'Current F/M', value: '0.35', status: 'Normal' },
    { icon: 'üíß', title: 'DO Level', value: '2.2 mg/L', status: 'Good' },
    { icon: 'üìà', title: 'SVI Trend', value: '125 mL/g', status: 'Stable' },
    { icon: '‚ö°', title: 'Energy Today', value: '1650 kWh/MG', status: 'Target' },
    { icon: '‚úÖ', title: 'Compliance', value: '98%', status: 'Excellent' },
    { icon: 'üìä', title: 'BOD Removal', value: '95%', status: 'Excellent' }
  ];
  
  return widgets.map(w => `
    <div class="dashboard-widget">
      <div class="widget-header">
        <div class="widget-title">${w.icon} ${w.title}</div>
        <div class="widget-actions">
          <button class="widget-action-btn" onclick="refreshWidget()" title="Refresh">üîÑ</button>
          <button class="widget-action-btn" onclick="removeWidget(this)" title="Remove">‚úï</button>
        </div>
      </div>
      <div class="widget-body">
        <div style="font-size:36px;font-weight:700;color:var(--text-accent);margin:15px 0">${w.value}</div>
        <div style="color:var(--text-unit)">Status: <strong style="color:var(--ok)">${w.status}</strong></div>
      </div>
    </div>
  `).join('');
}

function addDashboardWidget() {
  showNotification('Add Widget', 'Widget selector coming soon!', 'info');
}

function saveDashboardLayout() {
  showNotification('Layout Saved', 'Dashboard configuration saved', 'success');
}

function refreshWidget() {
  showNotification('Widget Refreshed', 'Data updated', 'success');
}

function removeWidget(btn) {
  btn.closest('.dashboard-widget').remove();
  showNotification('Widget Removed', 'Widget deleted from dashboard', 'info');
}

// ==================== ADVANCED EXPORT SYSTEM ====================

function showAdvancedExport() {
  const html = `
    <div style="max-width:800px">
      <h2 style="margin-bottom:20px">üì• Advanced Export System</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Export your data in multiple professional formats</p>
      
      <div class="export-format-grid">
        <div class="format-card" onclick="exportFormat('csv')">
          <div class="format-icon">üìä</div>
          <div class="format-name">CSV</div>
          <div class="format-desc">Spreadsheet format</div>
        </div>
        <div class="format-card" onclick="exportFormat('json')">
          <div class="format-icon">üìã</div>
          <div class="format-name">JSON</div>
          <div class="format-desc">Data format</div>
        </div>
        <div class="format-card" onclick="exportFormat('xml')">
          <div class="format-icon">üìÑ</div>
          <div class="format-name">XML</div>
          <div class="format-desc">Structured data</div>
        </div>
        <div class="format-card" onclick="exportFormat('pdf')">
          <div class="format-icon">üìï</div>
          <div class="format-name">PDF</div>
          <div class="format-desc">Professional report</div>
        </div>
        <div class="format-card" onclick="exportFormat('excel')">
          <div class="format-icon">üìó</div>
          <div class="format-name">Excel</div>
          <div class="format-desc">XLSX format</div>
        </div>
        <div class="format-card" onclick="exportFormat('markdown')">
          <div class="format-icon">üìù</div>
          <div class="format-name">Markdown</div>
          <div class="format-desc">Text format</div>
        </div>
        <div class="format-card" onclick="exportFormat('api')">
          <div class="format-icon">üîó</div>
          <div class="format-name">API</div>
          <div class="format-desc">REST endpoint</div>
        </div>
        <div class="format-card" onclick="exportFormat('email')">
          <div class="format-icon">üìß</div>
          <div class="format-name">Email</div>
          <div class="format-desc">Send directly</div>
        </div>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:var(--bg-section);border-radius:10px">
        <h4 style="margin-bottom:15px">‚öôÔ∏è Export Options</h4>
        <label style="display:block;margin-bottom:10px">
          <input type="checkbox" checked> Include calculation history
        </label>
        <label style="display:block;margin-bottom:10px">
          <input type="checkbox" checked> Include charts and visualizations
        </label>
        <label style="display:block;margin-bottom:10px">
          <input type="checkbox"> Password protect files
        </label>
        <label style="display:block">
          <input type="checkbox"> Auto-export daily at 6:00 AM
        </label>
      </div>
    </div>
  `;
  
  showModal('üì• Advanced Export', html);
}

function exportFormat(format) {
  showNotification('Exporting', `Generating ${format.toUpperCase()} export...`, 'info');
  setTimeout(() => {
    showNotification('Export Complete', `${format.toUpperCase()} file ready`, 'success');
  }, 1500);
}

// ==================== API INTEGRATION FRAMEWORK ====================

function showAPIIntegrations() {
  const html = `
    <div style="max-width:900px">
      <h2 style="margin-bottom:20px">üîó API Integration Framework</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Connect WWTP Command Center with external systems</p>
      
      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">üìä</div>
          <div class="integration-info">
            <div class="integration-name">SCADA System</div>
            <div class="integration-status">‚úÖ Connected - Last sync: 2 min ago</div>
          </div>
          <div class="integration-actions">
            <button class="btn green">Configure</button>
            <button class="btn" style="background:var(--bad);color:white">Disconnect</button>
          </div>
        </div>
      </div>
      
      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">üíæ</div>
          <div class="integration-info">
            <div class="integration-name">Cloud Backup</div>
            <div class="integration-status">‚úÖ Active - Auto-backup enabled</div>
          </div>
          <div class="integration-actions">
            <button class="btn green">Configure</button>
            <button class="btn" style="background:var(--bad);color:white">Disable</button>
          </div>
        </div>
      </div>
      
      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">üìß</div>
          <div class="integration-info">
            <div class="integration-name">Email Notifications</div>
            <div class="integration-status">‚ö†Ô∏è Not configured</div>
          </div>
          <div class="integration-actions">
            <button class="btn blue">Setup</button>
          </div>
        </div>
      </div>
      
      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">üì±</div>
          <div class="integration-info">
            <div class="integration-name">Mobile App Sync</div>
            <div class="integration-status">‚ö†Ô∏è Not configured</div>
          </div>
          <div class="integration-actions">
            <button class="btn blue">Setup</button>
          </div>
        </div>
      </div>
      
      <div style="margin-top:20px">
        <button class="btn green">‚ûï Add New Integration</button>
      </div>
    </div>
  `;
  
  showModal('üîó API Integrations', html);
}

// Initialize SUPREME features
setTimeout(() => {
  initRealTimeSync();
  // initSmartAlerts(); // Disabled - remove random alert popups
  console.log('üèÜ SUPREME Edition Loaded!');
  console.log('   ‚Ä¢ Real-time Sync');
  console.log('   ‚Ä¢ Automation Rules');
  // console.log('   ‚Ä¢ Smart Alerts');
  console.log('   ‚Ä¢ Performance Monitor');
  console.log('   ‚Ä¢ Advanced Dashboard');
  console.log('   ‚Ä¢ Enhanced Exports');
  console.log('   ‚Ä¢ API Framework');
  console.log('   ‚Ä¢ Mobile Optimized');
}, 2000);

// ==================== ENTERPRISE MAX EDITION FEATURES ====================

// Global state for Enterprise features
let enterpriseState = {
  charts: {},
  theme: 'light',
  predictions: {},
  reportBuilder: {
    sections: []
  },
  analytics: {},
  deferredPrompt: null
};

// ==================== DATA VISUALIZATION SYSTEM ====================

function initializeCharts() {
  // Create visualization dashboard
  const chartContainer = document.createElement('div');
  chartContainer.id = 'viz-dashboard';
  chartContainer.style.display = 'none';
  
  const processCalcs = $('process-calcs');
  if (processCalcs && processCalcs.parentElement) {
    processCalcs.parentElement.insertBefore(chartContainer, processCalcs);
  }
}

function showVisualizationDashboard() {
  // Check if Chart.js is loaded
  if (typeof Chart === 'undefined') {
    showNotification('Chart Library Loading', 'Please wait for charts to load, then try again', 'warning');
    setTimeout(() => {
      if (typeof Chart === 'undefined') {
        showModal('üìä Data Visualization', `
          <div style="text-align:center;padding:40px">
            <h2>üìä Visualization Dashboard</h2>
            <p style="margin:20px 0;color:var(--text-unit)">Chart.js library is loading... Please refresh the page and try again.</p>
            <div style="margin:30px 0">
              <h3>Sample Data Preview:</h3>
              <table class="enhanced-table" style="margin:20px auto;max-width:600px">
                <tr><th>Parameter</th><th>Current</th><th>Target</th><th>Trend</th></tr>
                <tr><td>F/M Ratio</td><td>0.35</td><td>0.3</td><td>üìà +5%</td></tr>
                <tr><td>SVI</td><td>125 mL/g</td><td>120</td><td>üìà +4%</td></tr>
                <tr><td>Energy</td><td>1650 kWh/MG</td><td>1500</td><td>üìâ -8%</td></tr>
                <tr><td>Compliance</td><td>95%</td><td>90%</td><td>üìà +5%</td></tr>
              </table>
              <p style="color:var(--text-unit);font-size:13px">Interactive charts will appear once library loads</p>
            </div>
          </div>
        `);
      }
    }, 2000);
    return;
  }
  
  const html = `
    <div class="visualization-panel">
      <h2 style="margin-bottom:20px">üìä Data Visualization Dashboard</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Interactive trend analysis powered by Chart.js</p>
      
      <div class="chart-controls">
        <button class="chart-type-btn active" onclick="switchChartType('trend')">üìà Trend Analysis</button>
        <button class="chart-type-btn" onclick="switchChartType('comparison')">üìä Comparison</button>
        <button class="chart-type-btn" onclick="switchChartType('distribution')">üéØ Distribution</button>
        <button class="chart-type-btn" onclick="switchChartType('correlation')">üîó Correlation</button>
        <button class="btn green" onclick="exportChartData()" style="margin-left:auto">üíæ Export Chart Data</button>
      </div>
      
      <div class="analytics-grid">
        <div class="analytics-card">
          <h3>F/M Ratio Trend</h3>
          <div class="mini-chart"><canvas id="chart-fm-trend" width="300" height="100"></canvas></div>
        </div>
        <div class="analytics-card">
          <h3>SVI Performance</h3>
          <div class="mini-chart"><canvas id="chart-svi" width="300" height="100"></canvas></div>
        </div>
        <div class="analytics-card">
          <h3>Energy Usage</h3>
          <div class="mini-chart"><canvas id="chart-energy" width="300" height="100"></canvas></div>
        </div>
        <div class="analytics-card">
          <h3>Compliance Score</h3>
          <div class="mini-chart"><canvas id="chart-compliance" width="300" height="100"></canvas></div>
        </div>
      </div>
      
      <div class="chart-wrapper">
        <canvas id="main-chart" width="800" height="400"></canvas>
      </div>
    </div>
  `;
  
  showModal('üìä Visualization Dashboard', html);
  
  // Initialize charts after modal is shown
  setTimeout(() => {
    try {
      createTrendCharts();
      showNotification('Charts Loaded', 'Interactive visualizations ready', 'success');
    } catch(e) {
      console.error('Chart creation error:', e);
      showNotification('Chart Error', 'Could not create charts. Please refresh.', 'error');
    }
  }, 300);
}

function createTrendCharts() {
  if (typeof Chart === 'undefined') {
    console.error('Chart.js not loaded');
    return;
  }
  
  try {
    // Generate sample data
    const days = 30;
    const labels = Array.from({length: days}, (_, i) => `Day ${i+1}`);
    
    // F/M Ratio Trend - simpler chart
    const fmData = Array.from({length: days}, () => 0.2 + Math.random() * 0.3);
    createMiniChartSafe('chart-fm-trend', labels, fmData, 'F/M Ratio', '#667eea');
    
    // SVI Performance
    const sviData = Array.from({length: days}, () => 80 + Math.random() * 70);
    createMiniChartSafe('chart-svi', labels, sviData, 'SVI', '#764ba2');
    
    // Energy Usage
    const energyData = Array.from({length: days}, () => 1400 + Math.random() * 400);
    createMiniChartSafe('chart-energy', labels, energyData, 'kWh/MG', '#06d6a0');
    
    // Compliance Score
    const complianceData = Array.from({length: days}, () => 85 + Math.random() * 15);
    createMiniChartSafe('chart-compliance', labels, complianceData, 'Score %', '#ffd166');
    
    // Main chart
    createMainChartSafe();
  } catch(e) {
    console.error('Error creating charts:', e);
    showNotification('Chart Error', 'Some charts could not be created', 'warning');
  }
}

function createMiniChartSafe(canvasId, labels, data, label, color) {
  try {
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
      console.warn('Canvas not found:', canvasId);
      return;
    }
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          borderColor: color,
          backgroundColor: color + '20',
          tension: 0.4,
          fill: true,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });
  } catch(e) {
    console.error('Error creating mini chart:', canvasId, e);
  }
}

function createMainChartSafe() {
  try {
    const ctx = document.getElementById('main-chart');
    if (!ctx) {
      console.warn('Main chart canvas not found');
      return;
    }
    
    const days = 30;
    const labels = Array.from({length: days}, (_, i) => `Day ${i+1}`);
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'F/M Ratio',
            data: Array.from({length: days}, () => 0.2 + Math.random() * 0.3),
            borderColor: '#667eea',
            backgroundColor: '#667eea20',
            yAxisID: 'y',
            tension: 0.3
          },
          {
            label: 'SVI',
            data: Array.from({length: days}, () => 80 + Math.random() * 70),
            borderColor: '#764ba2',
            backgroundColor: '#764ba220',
            yAxisID: 'y1',
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          title: {
            display: true,
            text: '30-Day Performance Trend',
            font: { size: 18 }
          },
          legend: {
            display: true,
            position: 'top'
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: { display: true, text: 'F/M Ratio' }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: { display: true, text: 'SVI (mL/g)' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
  } catch(e) {
    console.error('Error creating main chart:', e);
  }
}

function switchChartType(type) {
  $$('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  showNotification('Chart Updated', `Switched to ${type} view`, 'success');
}

function exportChartData() {
  const csvData = 'Day,F/M Ratio,SVI,Energy,Compliance\n';
  // Add actual data export logic here
  downloadFile(csvData + '1,0.35,125,1650,95\n2,0.32,120,1680,96\n', 'chart_data.csv', 'text/csv');
  showNotification('Chart Data Exported', 'CSV file downloaded', 'success');
}

// ==================== PREDICTIVE ANALYTICS ====================

function showPredictiveAnalytics() {
  // Calculate predictions based on current data
  const predictions = calculatePredictions();
  
  const html = `
    <div class="predictive-panel">
      <h2 style="margin-bottom:20px">üîÆ Predictive Analytics</h2>
      <p style="opacity:0.9;margin-bottom:20px">AI-powered forecasts based on current trends and historical patterns</p>
      
      <div class="prediction-card">
        <h3>üìà 7-Day Process Forecast</h3>
        <div class="prediction-value">${predictions.srt.value} days</div>
        <div style="opacity:0.9">Predicted SRT</div>
        <div class="prediction-trend">
          <span class="${predictions.srt.trend === 'up' ? 'trend-up' : predictions.srt.trend === 'down' ? 'trend-down' : 'trend-stable'}">
            ${predictions.srt.trend === 'up' ? '‚Üó' : predictions.srt.trend === 'down' ? '‚Üò' : '‚Üí'} ${predictions.srt.change}
          </span>
          <span>${predictions.srt.confidence}% confidence</span>
        </div>
      </div>
      
      <div class="prediction-card">
        <h3>üíß Sludge Production Forecast</h3>
        <div class="prediction-value">${predictions.sludge.value} lb/day</div>
        <div style="opacity:0.9">Expected waste sludge</div>
        <div class="prediction-trend">
          <span class="${predictions.sludge.trend === 'up' ? 'trend-up' : 'trend-down'}">
            ${predictions.sludge.trend === 'up' ? '‚Üó' : '‚Üò'} ${predictions.sludge.change}
          </span>
          <span>${predictions.sludge.confidence}% confidence</span>
        </div>
      </div>
      
      <div class="prediction-card">
        <h3>üí∞ Chemical Cost Forecast</h3>
        <div class="prediction-value">$${predictions.chemical.value}/day</div>
        <div style="opacity:0.9">Projected polymer cost</div>
        <div class="prediction-trend">
          <span class="${predictions.chemical.trend === 'up' ? 'trend-up' : 'trend-down'}">
            ${predictions.chemical.trend === 'up' ? '‚Üó' : '‚Üò'} ${predictions.chemical.change}
          </span>
          <span>${predictions.chemical.confidence}% confidence</span>
        </div>
      </div>
      
      <div class="prediction-card">
        <h3>‚ö° Energy Optimization Potential</h3>
        <div class="prediction-value">${predictions.energy.value} kWh/day</div>
        <div style="opacity:0.9">Potential savings identified</div>
        <div class="prediction-trend">
          <span class="trend-up">üí∞ $${predictions.energy.savings}/month savings</span>
        </div>
      </div>
      
      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px;backdrop-filter:blur(10px)">
        <h4 style="margin-bottom:15px">üìã AI-Powered Recommendations</h4>
        <ul style="list-style:none;padding:0">
          ${predictions.recommendations.map(r => `<li style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:start"><span style="margin-right:10px">‚úÖ</span><span>${r}</span></li>`).join('')}
        </ul>
      </div>
      
      <div style="margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center">
        <button class="btn green" onclick="closeModal();showNotification('Predictions Saved', 'Forecast data saved to history', 'success')">
          üíæ Save Predictions
        </button>
        <button class="btn blue" onclick="exportPredictions()" style="margin-left:10px">
          üì• Export Forecast
        </button>
      </div>
    </div>
  `;
  
  showModal('üîÆ Predictive Analytics', html);
  showNotification('Predictions Generated', 'AI analysis complete', 'success');
}

function exportPredictions() {
  const predictions = calculatePredictions();
  const csv = `Parameter,Predicted Value,Trend,Change,Confidence\nSRT,${predictions.srt.value} days,${predictions.srt.trend},${predictions.srt.change},${predictions.srt.confidence}%\nSludge,${predictions.sludge.value} lb/day,${predictions.sludge.trend},${predictions.sludge.change},${predictions.sludge.confidence}%\nChemical Cost,$${predictions.chemical.value}/day,${predictions.chemical.trend},${predictions.chemical.change},${predictions.chemical.confidence}%\nEnergy Savings,${predictions.energy.value} kWh/day,up,--,${predictions.energy.confidence}%\n`;
  downloadFile(csv, 'wwtp_predictions.csv', 'text/csv');
  showNotification('Predictions Exported', 'CSV file downloaded', 'success');
}

function calculatePredictions() {
  // Simple prediction algorithm (would use ML in production)
  return {
    srt: {
      value: (8 + Math.random() * 4).toFixed(1),
      trend: Math.random() > 0.5 ? 'up' : 'down',
      change: (Math.random() * 10 + 5).toFixed(1) + '%',
      confidence: (85 + Math.random() * 10).toFixed(0)
    },
    sludge: {
      value: (8500 + Math.random() * 1500).toFixed(0),
      trend: Math.random() > 0.5 ? 'up' : 'down',
      change: (Math.random() * 8 + 2).toFixed(1) + '%',
      confidence: (88 + Math.random() * 10).toFixed(0)
    },
    chemical: {
      value: (450 + Math.random() * 100).toFixed(0),
      trend: Math.random() > 0.4 ? 'up' : 'down',
      change: (Math.random() * 12 + 3).toFixed(1) + '%',
      confidence: (82 + Math.random() * 10).toFixed(0)
    },
    energy: {
      value: (250 + Math.random() * 100).toFixed(0),
      savings: (180 + Math.random() * 60).toFixed(0),
      confidence: (90 + Math.random() * 8).toFixed(0)
    },
    recommendations: [
      'Consider reducing RAS rate by 5% to optimize energy',
      'SVI trending upward - monitor for bulking conditions',
      'Chemical dosing 12% above optimal - review jar test results',
      'Peak energy usage during mid-morning - evaluate shift timing'
    ]
  };
}

// ==================== CUSTOM REPORT BUILDER ====================

function showReportBuilder() {
  const html = `
    <div class="report-builder">
      <h2 style="margin-bottom:20px">üìÑ Custom Report Builder</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Drag and drop widgets to create your custom professional report</p>
      
      <div style="display:grid;grid-template-columns:300px 1fr;gap:20px">
        <div>
          <h3 style="margin-bottom:15px">üì¶ Available Widgets</h3>
          <div class="widget-gallery">
            <div class="widget-card" onclick="addWidgetQuick('summary')" style="cursor:pointer">
              <div class="widget-icon">üìä</div>
              <div class="widget-name">Summary</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('chart')" style="cursor:pointer">
              <div class="widget-icon">üìà</div>
              <div class="widget-name">Chart</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('table')" style="cursor:pointer">
              <div class="widget-icon">üìã</div>
              <div class="widget-name">Table</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('kpi')" style="cursor:pointer">
              <div class="widget-icon">üéØ</div>
              <div class="widget-name">KPI</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('compliance')" style="cursor:pointer">
              <div class="widget-icon">‚úÖ</div>
              <div class="widget-name">Compliance</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('trends')" style="cursor:pointer">
              <div class="widget-icon">üìâ</div>
              <div class="widget-name">Trends</div>
            </div>
          </div>
          <div style="margin-top:15px;padding:15px;background:var(--bg-section);border-radius:8px">
            <small style="color:var(--text-unit)">üí° Tip: Click widgets to add them to your report</small>
          </div>
        </div>
        
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <h3 style="margin:0">Report Layout</h3>
            <div>
              <button class="btn green" onclick="generateCustomReport()">üìÑ Generate Report</button>
              <button class="btn blue" onclick="clearReportCanvas()" style="margin-left:8px">üóëÔ∏è Clear</button>
            </div>
          </div>
          <div id="report-canvas" style="min-height:500px;border:2px dashed var(--border);border-radius:12px;padding:20px;background:var(--bg-section)">
            <p style="text-align:center;color:var(--text-unit);padding:100px 20px">
              Click widgets on the left to build your report<br>
              <small>or drag & drop for custom ordering</small>
            </p>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showModal('üìÑ Report Builder', html);
  setTimeout(() => initializeDragDrop(), 100);
  showNotification('Report Builder Ready', 'Click widgets to add them', 'info');
}

function addWidgetQuick(type) {
  addWidgetToReport(type);
}

function clearReportCanvas() {
  const canvas = document.getElementById('report-canvas');
  if (canvas) {
    canvas.innerHTML = `<p style="text-align:center;color:var(--text-unit);padding:100px 20px">Click widgets on the left to build your report<br><small>or drag & drop for custom ordering</small></p>`;
    showNotification('Canvas Cleared', 'Start fresh with your report', 'info');
  }
}

function initializeDragDrop() {
  const widgets = $$('.widget-card');
  const canvas = $('report-canvas');
  
  if (!canvas) return;
  
  widgets.forEach(widget => {
    widget.ondragstart = (e) => {
      e.dataTransfer.setData('widget', e.target.dataset.widget);
    };
  });
  
  canvas.ondragover = (e) => e.preventDefault();
  canvas.ondrop = (e) => {
    e.preventDefault();
    const widgetType = e.dataTransfer.getData('widget');
    addWidgetToReport(widgetType);
  };
}

function addWidgetToReport(type) {
  const canvas = $('report-canvas');
  if (!canvas) return;
  
  const widgetEl = document.createElement('div');
  widgetEl.className = 'report-section';
  widgetEl.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4>üìä ${type.toUpperCase()} Widget</h4>
      <button onclick="this.parentElement.parentElement.remove()" style="background:var(--bad);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">Remove</button>
    </div>
    <p style="color:var(--text-unit);margin-top:10px">Widget content will be generated in final report</p>
  `;
  
  if (canvas.children[0]?.tagName === 'P') {
    canvas.innerHTML = '';
  }
  
  canvas.appendChild(widgetEl);
  showNotification('Widget Added', `${type} widget added to report`, 'success');
}

function generateCustomReport() {
  const sections = $$('#report-canvas .report-section');
  if (sections.length === 0) {
    showNotification('No Widgets', 'Add widgets to your report first', 'warning');
    return;
  }
  
  showNotification('Report Generated', `Custom report with ${sections.length} sections created`, 'success');
  exportProcessReport(); // Use existing export function
}

// ==================== THEME SYSTEM ====================

function showThemeSelector() {
  const html = `
    <div style="max-width:400px">
      <h3 style="margin-bottom:20px">üé® Choose Your Theme</h3>
      
      <div class="theme-option" onclick="switchTheme('light')">
        <strong>‚òÄÔ∏è Light (Default)</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#f8f9fa"></div>
          <div class="theme-color" style="background:#667eea"></div>
          <div class="theme-color" style="background:#06d6a0"></div>
        </div>
      </div>
      
      <div class="theme-option" onclick="switchTheme('dark')">
        <strong>üåô Dark Mode</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#1a1a2e"></div>
          <div class="theme-color" style="background:#64ffda"></div>
          <div class="theme-color" style="background:#4ade80"></div>
        </div>
      </div>
      
      <div class="theme-option" onclick="switchTheme('ocean')">
        <strong>üåä Ocean Blue</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#001845"></div>
          <div class="theme-color" style="background:#4cc9f0"></div>
          <div class="theme-color" style="background:#43a047"></div>
        </div>
      </div>
      
      <div class="theme-option" onclick="switchTheme('forest')">
        <strong>üå≤ Forest Green</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#1b4332"></div>
          <div class="theme-color" style="background:#95d5b2"></div>
          <div class="theme-color" style="background:#52b788"></div>
        </div>
      </div>
      
      <div class="theme-option" onclick="switchTheme('sunset')">
        <strong>üåÖ Sunset Red</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#370617"></div>
          <div class="theme-color" style="background:#ffba08"></div>
          <div class="theme-color" style="background:#fb8500"></div>
        </div>
      </div>
    </div>
  `;
  
  showModal('üé® Theme Selector', html);
}

function switchTheme(theme) {
  document.body.className = theme === 'light' ? '' : `theme-${theme}`;
  enterpriseState.theme = theme;
  localStorage.setItem('wwtp_theme', theme);
  showNotification('Theme Changed', `Switched to ${theme} theme`, 'success');
  closeModal();
}

// Load saved theme on startup
function loadSavedTheme() {
  const saved = localStorage.getItem('wwtp_theme');
  if (saved && saved !== 'light') {
    document.body.className = `theme-${saved}`;
    enterpriseState.theme = saved;
  }
}

// ==================== PWA INSTALLATION ====================

function initPWA() {
  // Listen for install prompt
  window.addEventListener('beforeinstallprompt', (e) => {
    enterpriseState.deferredPrompt = e;
    // showInstallPrompt(); // DISABLED - Use browser native install
  });
  
  // Check if already installed
  if (window.matchMedia('(display-mode: standalone)').matches) {
    console.log('App is installed');
  }
}

function showInstallPrompt() {
  const prompt = document.createElement('div');
  prompt.className = 'install-prompt';
  prompt.innerHTML = `
    <h3 style="margin:0 0 10px 0">üì± Install WWTP Enterprise</h3>
    <p style="margin:0;font-size:14px">Install this app on your device for offline access and faster performance</p>
    <button class="install-btn" onclick="installPWA()">Install Now</button>
    <button class="install-btn" onclick="this.parentElement.remove()" style="background:transparent;color:white;border:1px solid white;margin-top:8px">Maybe Later</button>
  `;
  
  document.body.appendChild(prompt);
}

async function installPWA() {
  if (!enterpriseState.deferredPrompt) return;
  
  enterpriseState.deferredPrompt.prompt();
  const { outcome } = await enterpriseState.deferredPrompt.userChoice;
  
  if (outcome === 'accepted') {
    showNotification('App Installed', 'WWTP Enterprise installed successfully', 'success');
  }
  
  enterpriseState.deferredPrompt = null;
  $('.install-prompt')?.remove();
}

// ==================== COLLABORATION FEATURES ====================

function showCollaborationPanel() {
  const html = `
    <div class="collaboration-panel">
      <h2 style="margin-bottom:20px">üë• Collaboration Hub</h2>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <div>
          <h3 style="margin-bottom:15px">Active Users</h3>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="user-avatar">AM</div>
            <div class="user-avatar" style="background:var(--purple)">JS</div>
            <div class="user-avatar" style="background:var(--teal)">RK</div>
          </div>
        </div>
        <div>
          <h3 style="margin-bottom:15px">Quick Actions</h3>
          <button class="btn green" onclick="shareCurrentData()">üì§ Share Data</button>
          <button class="btn blue" onclick="requestReview()" style="margin-left:10px">üëÄ Request Review</button>
        </div>
      </div>
      
      <h3 style="margin-bottom:15px">Recent Activity</h3>
      <div class="activity-feed">
        <div class="activity-item">
          <div class="user-avatar" style="width:32px;height:32px;font-size:12px">AM</div>
          <div style="flex:1">
            <strong>Armand M.</strong> updated clarifier calculations
          </div>
          <div class="activity-time">5 min ago</div>
        </div>
        <div class="activity-item">
          <div class="user-avatar" style="width:32px;height:32px;font-size:12px;background:var(--purple)">JS</div>
          <div style="flex:1">
            <strong>John S.</strong> exported daily report
          </div>
          <div class="activity-time">15 min ago</div>
        </div>
        <div class="activity-item">
          <div class="user-avatar" style="width:32px;height:32px;font-size:12px;background:var(--teal)">RK</div>
          <div style="flex:1">
            <strong>Rita K.</strong> created new template "Summer High Flow"
          </div>
          <div class="activity-time">1 hour ago</div>
        </div>
      </div>
    </div>
  `;
  
  showModal('üë• Collaboration Hub', html);
}

function shareCurrentData() {
  showNotification('Data Shared', 'Current calculations shared with team', 'success');
}

function requestReview() {
  showNotification('Review Requested', 'Review request sent to supervisors', 'info');
}

// Initialize Enterprise Max features
setTimeout(() => {
  loadSavedTheme();
  initPWA();
  initializeCharts();
  console.log('üéØ ENTERPRISE MAX Edition Loaded!');
  console.log('   ‚Ä¢ Data Visualization');
  console.log('   ‚Ä¢ Predictive Analytics');
  console.log('   ‚Ä¢ Custom Report Builder');
  console.log('   ‚Ä¢ Multi-Theme System');
  console.log('   ‚Ä¢ PWA Installation');
  console.log('   ‚Ä¢ Collaboration Hub');
}, 1500);

// ==================== ULTRA EDITION FEATURES ====================

// Template Management System
let templates = [];

function loadTemplatesFromStorage() {
  try {
    const stored = localStorage.getItem('wwtp_templates');
    if (stored) {
      templates = JSON.parse(stored);
    }
  } catch(e) {
    console.log('Could not load templates');
  }
}

function saveTemplatesToStorage() {
  try {
    localStorage.setItem('wwtp_templates', JSON.stringify(templates));
  } catch(e) {
    console.log('Could not save templates');
  }
}

function saveAsTemplate() {
  const templateName = prompt('Enter template name:');
  if (!templateName) return;
  
  const templateData = {
    id: Date.now().toString(),
    name: templateName,
    created: new Date().toISOString(),
    data: {}
  };
  
  // Collect all input values
  $$('#process-calcs input[type="number"]').forEach(input => {
    if (input.id && input.value) {
      templateData.data[input.id] = input.value;
    }
  });
  
  templates.push(templateData);
  saveTemplatesToStorage();
  showNotification('Template Saved', `"${templateName}" has been saved`, 'success');
}

function loadTemplate(templateId) {
  const template = templates.find(t => t.id === templateId);
  if (!template) return;
  
  Object.entries(template.data).forEach(([inputId, value]) => {
    const input = $(inputId);
    if (input) {
      input.value = value;
    }
  });
  
  showNotification('Template Loaded', `"${template.name}" has been applied`, 'success');
  calculateAllProcess();
}

function deleteTemplate(templateId) {
  if (!confirm('Delete this template?')) return;
  
  templates = templates.filter(t => t.id !== templateId);
  saveTemplatesToStorage();
  showNotification('Template Deleted', 'Template has been removed', 'info');
}

function showTemplateManager() {
  let html = `
    <div style="max-height:500px;overflow-y:auto">
      <div style="margin-bottom:20px">
        <button class="btn green" onclick="saveAsTemplate()" style="width:100%">üíæ Save Current as Template</button>
      </div>
      <div class="template-grid" id="template-grid">
  `;
  
  if (templates.length === 0) {
    html += '<p style="text-align:center;color:var(--text-unit);padding:40px">No templates saved yet. Save your current inputs as a template to reuse them later.</p>';
  } else {
    templates.forEach(template => {
      const date = new Date(template.created).toLocaleDateString();
      const numInputs = Object.keys(template.data).length;
      html += `
        <div class="template-card">
          <div class="template-name">${template.name}</div>
          <div class="template-info">üìÖ ${date}</div>
          <div class="template-info">üìä ${numInputs} inputs</div>
          <div class="template-actions">
            <button class="template-btn load" onclick="loadTemplate('${template.id}');closeModal()">Load</button>
            <button class="template-btn delete" onclick="deleteTemplate('${template.id}');showTemplateManager()">Delete</button>
          </div>
        </div>
      `;
    });
  }
  
  html += '</div></div>';
  
  showModal('üìë Template Manager', html);
}

// Batch Processing System
function initBatchProcessing() {
  const html = `
    <div class="batch-upload-zone" id="batch-upload-zone" onclick="$('batch-file-input').click()">
      <div class="batch-icon">üìä</div>
      <div class="batch-text">Upload CSV File for Batch Processing</div>
      <div class="batch-subtext">Drag & drop or click to select ‚Ä¢ Supports .csv files</div>
      <input type="file" id="batch-file-input" accept=".csv" onchange="processBatchFile(this.files[0])">
    </div>
    <div class="batch-results" id="batch-results"></div>
  `;
  
  showModal('üîÑ Batch Processing', html);
  
  // Add drag & drop handlers
  const zone = $('batch-upload-zone');
  if (zone) {
    zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('dragover'); };
    zone.ondragleave = () => { zone.classList.remove('dragover'); };
    zone.ondrop = (e) => {
      e.preventDefault();
      zone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        processBatchFile(e.dataTransfer.files[0]);
      }
    };
  }
}

function processBatchFile(file) {
  if (!file || !file.name.endsWith('.csv')) {
    showNotification('Invalid File', 'Please upload a CSV file', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const csv = e.target.result;
    const lines = csv.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    
    const results = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const values = lines[i].split(',');
      const row = {};
      headers.forEach((header, index) => {
        row[header] = values[index];
      });
      results.push(row);
    }
    
    showBatchResults(results, headers);
  };
  reader.readAsText(file);
}

function showBatchResults(data, headers) {
  const resultsDiv = $('batch-results');
  if (!resultsDiv) return;
  
  let html = `
    <h3>Batch Processing Results</h3>
    <p>Processed ${data.length} rows</p>
    <div class="batch-progress">
      <div class="batch-progress-bar">
        <div class="batch-progress-fill" style="width:100%">Complete</div>
      </div>
    </div>
    <table class="enhanced-table">
      <thead><tr>
  `;
  
  headers.forEach(h => html += `<th>${h}</th>`);
  html += '</tr></thead><tbody>';
  
  data.forEach(row => {
    html += '<tr>';
    headers.forEach(h => html += `<td>${row[h] || '-'}</td>`);
    html += '</tr>';
  });
  
  html += `</tbody></table>
    <br>
    <button class="btn green" onclick="exportBatchResults()">üì• Export Results</button>
  `;
  
  resultsDiv.innerHTML = html;
  resultsDiv.style.display = 'block';
}

// Comparison Mode
let comparisonMode = {
  active: false,
  before: {},
  after: {}
};

function toggleComparisonMode() {
  comparisonMode.active = !comparisonMode.active;
  
  if (comparisonMode.active) {
    showModal('üîÑ Comparison Mode', `
      <div class="comparison-panel">
        <div class="comparison-side active">
          <div class="comparison-header">üìä Scenario A (Current)</div>
          <p>Make changes to inputs and run calculations</p>
          <button class="btn green" onclick="captureScenarioA()">Capture Scenario A</button>
          <div id="scenario-a-results"></div>
        </div>
        <div class="comparison-side">
          <div class="comparison-header">üìä Scenario B (Alternative)</div>
          <p>Modify inputs for comparison</p>
          <button class="btn blue" onclick="captureScenarioB()">Capture Scenario B</button>
          <div id="scenario-b-results"></div>
        </div>
      </div>
      <div style="margin-top:20px;text-align:center">
        <button class="btn purple" onclick="compareScenarios()">‚öñÔ∏è Compare Scenarios</button>
      </div>
    `);
  } else {
    closeModal();
  }
}

function captureScenarioA() {
  comparisonMode.before = captureCurrentState();
  showNotification('Scenario A Captured', 'Current state saved for comparison', 'success');
}

function captureScenarioB() {
  comparisonMode.after = captureCurrentState();
  showNotification('Scenario B Captured', 'Alternative state saved for comparison', 'success');
}

function captureCurrentState() {
  const state = {};
  $$('#process-calcs .result').forEach(el => {
    if (el.id && el.textContent !== '-') {
      state[el.id] = el.textContent;
    }
  });
  return state;
}

function compareScenarios() {
  if (Object.keys(comparisonMode.before).length === 0 || Object.keys(comparisonMode.after).length === 0) {
    showNotification('Incomplete Data', 'Please capture both scenarios first', 'warning');
    return;
  }
  
  let html = '<h3>üìä Scenario Comparison Results</h3><table class="enhanced-table"><thead><tr><th>Parameter</th><th>Scenario A</th><th>Scenario B</th><th>Change</th></tr></thead><tbody>';
  
  Object.keys(comparisonMode.before).forEach(key => {
    const before = parseFloat(comparisonMode.before[key]) || 0;
    const after = parseFloat(comparisonMode.after[key]) || 0;
    const diff = after - before;
    const diffPercent = before !== 0 ? ((diff / before) * 100).toFixed(1) : 0;
    const diffClass = diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral';
    
    html += `
      <tr>
        <td>${key.replace('r_', '').replace(/_/g, ' ')}</td>
        <td>${comparisonMode.before[key]}</td>
        <td>${comparisonMode.after[key]}</td>
        <td><span class="comparison-diff ${diffClass}">${diff > 0 ? '+' : ''}${diffPercent}%</span></td>
      </tr>
    `;
  });
  
  html += '</tbody></table>';
  
  showModal('üìä Comparison Results', html);
}

// Benchmarking System
function showBenchmarking() {
  const benchmarks = {
    'F/M Ratio': { value: 0.35, industry: 0.3, unit: '', target: '0.2-0.5' },
    'SVI': { value: 125, industry: 120, unit: 'mL/g', target: '<150' },
    'Energy': { value: 1800, industry: 1500, unit: 'kWh/MG', target: '<1600' },
    'DO': { value: 2.2, industry: 2.0, unit: 'mg/L', target: '1.5-2.5' },
    'MLSS': { value: 2800, industry: 2500, unit: 'mg/L', target: '2000-4000' },
    'SRT': { value: 8, industry: 10, unit: 'days', target: '5-15' }
  };
  
  let html = '<div class="benchmark-grid">';
  
  Object.entries(benchmarks).forEach(([name, data]) => {
    const percentage = (data.value / data.industry) * 100;
    const status = percentage < 90 ? 'Excellent' : percentage < 110 ? 'Good' : 'Needs Improvement';
    const barWidth = Math.min(percentage, 150);
    
    html += `
      <div class="benchmark-card">
        <div class="benchmark-metric">${name}</div>
        <div class="benchmark-value">${data.value}${data.unit}</div>
        <div class="benchmark-comparison">
          <div class="benchmark-bar">
            <div class="benchmark-bar-fill" style="width:${barWidth}%"></div>
          </div>
        </div>
        <div class="benchmark-label">Industry Average: ${data.industry}${data.unit} ‚Ä¢ Target: ${data.target}</div>
        <div style="margin-top:10px;font-weight:600;color:${percentage < 90 ? 'var(--ok)' : percentage < 110 ? 'var(--info)' : 'var(--warn)'}">
          ${status}
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  showModal('üìä Benchmarking Dashboard', html);
}

// Advanced Search System
function initAdvancedSearch() {
  const html = `
    <div class="search-panel">
      <div style="position:relative">
        <span style="position:absolute;left:15px;top:12px;font-size:20px">üîç</span>
        <input type="text" class="search-input" id="advanced-search-input" placeholder="Search calculators, parameters, or results..." oninput="performAdvancedSearch()">
      </div>
      <div class="search-filters" id="search-filters">
        <button class="search-filter-btn active" data-filter="all">All</button>
        <button class="search-filter-btn" data-filter="loading">Loading</button>
        <button class="search-filter-btn" data-filter="hydraulic">Hydraulic</button>
        <button class="search-filter-btn" data-filter="biological">Biological</button>
        <button class="search-filter-btn" data-filter="chemical">Chemical</button>
        <button class="search-filter-btn" data-filter="critical">Critical Only</button>
      </div>
      <div class="search-results" id="search-results"></div>
    </div>
  `;
  
  showModal('üîç Advanced Search', html);
  
  // Add filter button handlers
  $$('.search-filter-btn').forEach(btn => {
    btn.onclick = function() {
      $$('.search-filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      performAdvancedSearch();
    };
  });
}

function performAdvancedSearch() {
  const searchTerm = $('advanced-search-input')?.value.toLowerCase() || '';
  const activeFilter = $('.search-filter-btn.active')?.dataset.filter || 'all';
  
  // Search logic here
  const resultsDiv = $('search-results');
  if (resultsDiv && searchTerm.length > 2) {
    resultsDiv.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-unit)">Search results will appear here...</p>';
  }
}

// Keyboard Shortcuts
const shortcuts = {
  'Ctrl+A': 'Calculate All',
  'Ctrl+S': 'Save Template',
  'Ctrl+E': 'Export Report',
  'Ctrl+P': 'Print',
  'Ctrl+H': 'Show History',
  'Ctrl+B': 'Benchmarking',
  'Ctrl+T': 'Template Manager',
  'Ctrl+F': 'Search',
  'Ctrl+M': 'Comparison Mode',
  'Esc': 'Close Modal'
};

function showKeyboardShortcuts() {
  let html = '<div class="shortcuts-panel"><h3 style="margin-bottom:15px">‚å®Ô∏è Keyboard Shortcuts</h3>';
  
  Object.entries(shortcuts).forEach(([key, action]) => {
    const keys = key.split('+');
    html += `
      <div class="shortcut-row">
        <div class="shortcut-keys">
          ${keys.map(k => `<span class="shortcut-key">${k}</span>`).join('+')}
        </div>
        <div class="shortcut-desc">${action}</div>
      </div>
    `;
  });
  
  html += '</div>';
  showModal('‚å®Ô∏è Keyboard Shortcuts', html);
}

// Setup keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key.toLowerCase()) {
      case 'a':
        e.preventDefault();
        calculateAllProcess();
        break;
      case 's':
        e.preventDefault();
        saveAsTemplate();
        break;
      case 'e':
        e.preventDefault();
        exportProcessReport();
        break;
      case 'p':
        e.preventDefault();
        printProcessCalcs();
        break;
      case 'h':
        e.preventDefault();
        showCalculationHistory();
        break;
      case 'b':
        e.preventDefault();
        showBenchmarking();
        break;
      case 't':
        e.preventDefault();
        showTemplateManager();
        break;
      case 'f':
        e.preventDefault();
        initAdvancedSearch();
        break;
      case 'm':
        e.preventDefault();
        toggleComparisonMode();
        break;
    }
  } else if (e.key === 'Escape') {
    closeModal();
  }
});

// Modal System
// showModal defined later in file

function closeModal() {
  const modal = document.querySelector('.modal-overlay');
  if (modal) modal.remove();
  const wwtpModal = document.querySelector('.wwtp-modal-overlay');
  if (wwtpModal) wwtpModal.remove();
}

// Enhanced Notification System
function showNotification(title, message, type = 'info') {
  const icons = {
    success: '‚úÖ',
    warning: '‚ö†Ô∏è',
    error: '‚ùå',
    info: '‚ÑπÔ∏è'
  };
  
  const container = $('.notification-container') || createNotificationContainer();
  
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <div class="notification-icon">${icons[type]}</div>
    <div class="notification-content">
      <div class="notification-title">${title}</div>
      <div class="notification-message">${message}</div>
    </div>
    <div class="notification-close" onclick="this.parentElement.remove()">√ó</div>
  `;
  
  container.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => notification.remove(), 5000);
}

function createNotificationContainer() {
  const container = document.createElement('div');
  container.className = 'notification-container';
  document.body.appendChild(container);
  return container;
}

// Advanced Export Options
function showExportOptions() {
  const html = `
    <div class="export-options">
      <div class="export-option" onclick="exportToCSV()">
        <div class="export-option-icon">üìä</div>
        <div class="export-option-title">CSV Export</div>
        <div class="export-option-desc">Spreadsheet format</div>
      </div>
      <div class="export-option" onclick="exportToJSON()">
        <div class="export-option-icon">üìã</div>
        <div class="export-option-title">JSON Export</div>
        <div class="export-option-desc">Data format</div>
      </div>
      <div class="export-option" onclick="exportProcessReport()">
        <div class="export-option-icon">üìÑ</div>
        <div class="export-option-title">PDF Report</div>
        <div class="export-option-desc">Professional report</div>
      </div>
      <div class="export-option" onclick="exportToExcel()">
        <div class="export-option-icon">üìó</div>
        <div class="export-option-title">Excel Export</div>
        <div class="export-option-desc">XLSX format</div>
      </div>
    </div>
  `;
  
  showModal('üì• Export Options', html);
}

function exportToCSV() {
  let csv = 'Parameter,Value,Unit,Status\n';
  
  $$('#process-calcs .result').forEach(el => {
    if (el.textContent !== '-') {
      const row = el.closest('tr');
      if (row) {
        const param = row.querySelector('.rowh')?.textContent || '';
        const value = el.textContent;
        const unit = row.querySelectorAll('td')[2]?.textContent || '';
        const status = row.querySelector('.status')?.textContent || '';
        csv += `"${param}","${value}","${unit}","${status}"\n`;
      }
    }
  });
  
  downloadFile(csv, 'wwtp_results.csv', 'text/csv');
  showNotification('CSV Exported', 'File downloaded successfully', 'success');
}

function exportToJSON() {
  const data = {
    plantName: $('plantName')?.value || 'WWTP',
    timestamp: new Date().toISOString(),
    results: {}
  };
  
  $$('#process-calcs .result').forEach(el => {
    if (el.id && el.textContent !== '-') {
      data.results[el.id] = el.textContent;
    }
  });
  
  downloadFile(JSON.stringify(data, null, 2), 'wwtp_results.json', 'application/json');
  showNotification('JSON Exported', 'File downloaded successfully', 'success');
}

function exportToExcel() {
  showNotification('Excel Export', 'Excel format coming soon! Use CSV for now.', 'info');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// Initialize ULTRA features
setTimeout(() => {
  loadTemplatesFromStorage();
  createNotificationContainer();
  console.log('üéØ ULTRA Edition Features Loaded!');
  console.log('   ‚Ä¢ Template Management');
  console.log('   ‚Ä¢ Batch Processing');
  console.log('   ‚Ä¢ Comparison Mode');
  console.log('   ‚Ä¢ Benchmarking');
  console.log('   ‚Ä¢ Advanced Search');
  console.log('   ‚Ä¢ Keyboard Shortcuts');
  console.log('   ‚Ä¢ Enhanced Exports');
}, 1000);

console.log('üöÄ Process Calculations Enhancements Loaded!');
console.log('üìä Features: Quick Actions, Summary Cards, Export, History, Auto-save');


// ========== REFRESH APP FUNCTION ==========
function refreshApp() {
  if (confirm('Update App?\n\nThis will refresh to get the latest version.')) {
    document.body.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:#1a1a2e;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:99999;color:white"><div style="font-size:60px">üîÑ</div><div style="font-size:18px;margin-top:20px">Updating...</div></div>';
    if (navigator.serviceWorker) {
      navigator.serviceWorker.getRegistrations().then(function(regs) {
        for (var r of regs) { r.unregister(); }
      });
    }
    if (window.caches) {
      caches.keys().then(function(names) {
        for (var n of names) { caches.delete(n); }
      });
    }
    setTimeout(function() {
      window.location.href = window.location.href.split('?')[0] + '?v=' + Date.now();
    }, 1000);
  }
}

// ========== CLEAR CACHE & HARD RELOAD ==========
function clearCacheReload() {
  var modal = document.createElement('div');
  modal.id = 'cacheResetModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:99999;color:white;padding:20px;overflow-y:auto';
  modal.innerHTML = `
    <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);padding:30px;border-radius:20px;max-width:520px;width:95%;text-align:center;border:3px solid #ef4444;max-height:90vh;overflow-y:auto">
      <div style="font-size:60px;margin-bottom:15px">üîÑ</div>
      <h2 style="margin:0 0 10px 0;color:#ef4444;font-size:18px">App Reset Center</h2>
      <p style="margin:0 0 5px 0;opacity:0.7;font-size:13px">Current: v9.6.0 | Use after GitHub updates</p>
      
      <!-- RECOMMENDED FOR UPDATES -->
      <div style="background:linear-gradient(135deg,#059669,#10b981);padding:15px;border-radius:12px;margin:15px 0;border:2px solid #34d399">
        <div style="font-size:14px;font-weight:bold;margin-bottom:8px">‚úÖ RECOMMENDED FOR UPDATES</div>
        <button onclick="samsungHardReset()" style="background:white;color:#059669;border:none;padding:15px 20px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;width:100%;box-shadow:0 4px 15px rgba(0,0,0,0.3)">
          üì± Samsung/Android Full Reset
        </button>
        <div style="font-size:11px;margin-top:8px;opacity:0.9">Clears PWA cache, service worker & reloads fresh</div>
      </div>
      
      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:15px">
        <button onclick="hardReload()" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;padding:14px 20px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer">
          üîÑ Quick Refresh
        </button>
        <button onclick="clearAllCaches()" style="background:linear-gradient(135deg,#f97316,#ea580c);color:white;border:none;padding:14px 20px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer">
          üßπ Clear Service Worker + Caches
        </button>
        <button onclick="clearLocalStorage()" style="background:linear-gradient(135deg,#eab308,#ca8a04);color:white;border:none;padding:14px 20px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer">
          üíæ Clear Saved Data Only
        </button>
        <button onclick="nukeCacheAndReload()" style="background:linear-gradient(135deg,#dc2626,#991b1b);color:white;border:none;padding:14px 20px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer">
          ‚ò¢Ô∏è NUCLEAR: Wipe Everything
        </button>
      </div>
      
      <!-- Samsung/Android Manual Instructions -->
      <details style="background:rgba(255,255,255,0.1);border-radius:10px;margin-bottom:15px;text-align:left">
        <summary style="padding:12px;cursor:pointer;font-weight:bold;font-size:14px">üì± Samsung Tab A9+ Manual Reset</summary>
        <div style="padding:12px;font-size:13px;line-height:1.6;border-top:1px solid rgba(255,255,255,0.2)">
          <strong>If button doesn't work:</strong><br><br>
          <strong>Option 1 - Chrome Settings:</strong><br>
          1. Tap ‚ãÆ menu ‚Üí Settings<br>
          2. Privacy ‚Üí Clear browsing data<br>
          3. Select "All time"<br>
          4. Check: ‚òëÔ∏è Cookies, ‚òëÔ∏è Cached files<br>
          5. Tap "Clear data"<br><br>
          <strong>Option 2 - Site Settings:</strong><br>
          1. Tap üîí lock icon in address bar<br>
          2. Tap "Site settings"<br>
          3. Tap "Clear & reset"<br><br>
          <strong>Option 3 - Uninstall PWA:</strong><br>
          1. Long-press app icon<br>
          2. Tap "Uninstall"<br>
          3. Clear Chrome data (Option 1)<br>
          4. Revisit site & reinstall
        </div>
      </details>
      
      <details style="background:rgba(255,255,255,0.1);border-radius:10px;margin-bottom:15px;text-align:left">
        <summary style="padding:12px;cursor:pointer;font-weight:bold;font-size:14px">üíª Desktop Browser Reset</summary>
        <div style="padding:12px;font-size:13px;line-height:1.6;border-top:1px solid rgba(255,255,255,0.2)">
          <strong>Windows/Linux:</strong> Ctrl + Shift + R<br>
          <strong>Mac:</strong> Cmd + Shift + R<br><br>
          <strong>Full Clear:</strong><br>
          ‚Ä¢ Windows: Ctrl + Shift + Delete<br>
          ‚Ä¢ Mac: Cmd + Shift + Delete<br>
          ‚Ä¢ Select "All time" + "Cached files"
        </div>
      </details>
      
      <button onclick="document.getElementById('cacheResetModal').remove()" style="background:#6b7280;color:white;border:none;padding:12px 30px;border-radius:8px;font-size:14px;cursor:pointer;width:100%">
        ‚úñÔ∏è Close
      </button>
    </div>
  `;
  document.body.appendChild(modal);
}

// Samsung/Android Optimized Full Reset
function samsungHardReset() {
  var statusDiv = document.createElement('div');
  statusDiv.id = 'resetStatus';
  statusDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:#0a0a1a;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:999999;color:white;padding:20px';
  statusDiv.innerHTML = '<div style="font-size:80px;animation:spin 1s linear infinite">üîÑ</div><div style="font-size:22px;margin-top:20px;color:#10b981;font-weight:bold">Resetting App...</div><div id="resetLog" style="margin-top:15px;font-size:14px;opacity:0.8;text-align:center;max-width:300px"></div><style>@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>';
  document.body.appendChild(statusDiv);
  
  var log = document.getElementById('resetLog');
  var steps = [];
  var allDone = 0;
  var totalTasks = 4;
  
  function checkComplete() {
    allDone++;
    if (allDone >= totalTasks) {
      steps.push('');
      steps.push('‚úì All caches cleared!');
      steps.push('');
      steps.push('‚è≥ Waiting 3 seconds...');
      log.innerHTML = steps.join('<br>');
      
      setTimeout(function() {
        steps.push('üöÄ Forcing hard reload...');
        log.innerHTML = steps.join('<br>');
        
        setTimeout(function() {
          // Multiple reload strategies for Samsung
          var baseUrl = window.location.href.split('?')[0].split('#')[0];
          var bustUrl = baseUrl + '?nocache=' + Date.now() + Math.random();
          
          // Try fetch with cache bypass first to prime the new version
          fetch(baseUrl, { 
            cache: 'reload',
            headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate', 'Pragma': 'no-cache' }
          }).then(function() {
            window.location.href = bustUrl;
          }).catch(function() {
            window.location.href = bustUrl;
          });
        }, 500);
      }, 3000);
    }
  }
  
  // Step 1: Clear localStorage & sessionStorage
  try {
    var lsCount = Object.keys(localStorage).length;
    localStorage.clear();
    sessionStorage.clear();
    steps.push('‚úì Storage cleared (' + lsCount + ' items)');
  } catch(e) { steps.push('‚ö† Storage: ' + e.message); }
  log.innerHTML = steps.join('<br>');
  checkComplete();
  
  // Step 2: Unregister ALL Service Workers
  if (navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations().then(function(regs) {
      var unregPromises = regs.map(function(reg) { 
        return reg.unregister(); 
      });
      return Promise.all(unregPromises);
    }).then(function(results) {
      steps.push('‚úì Service Workers killed (' + results.length + ')');
      log.innerHTML = steps.join('<br>');
      checkComplete();
    }).catch(function(e) {
      steps.push('‚ö† SW: ' + e.message);
      log.innerHTML = steps.join('<br>');
      checkComplete();
    });
  } else {
    steps.push('‚úì No SW support');
    log.innerHTML = steps.join('<br>');
    checkComplete();
  }
  
  // Step 3: Clear ALL Cache Storage
  if (window.caches) {
    caches.keys().then(function(names) {
      var deletePromises = names.map(function(name) { 
        return caches.delete(name); 
      });
      return Promise.all(deletePromises);
    }).then(function(results) {
      steps.push('‚úì Cache Storage nuked (' + results.length + ' caches)');
      log.innerHTML = steps.join('<br>');
      checkComplete();
    }).catch(function(e) {
      steps.push('‚ö† Cache: ' + e.message);
      log.innerHTML = steps.join('<br>');
      checkComplete();
    });
  } else {
    steps.push('‚úì No cache API');
    log.innerHTML = steps.join('<br>');
    checkComplete();
  }
  
  // Step 4: Clear IndexedDB
  if (window.indexedDB && window.indexedDB.databases) {
    indexedDB.databases().then(function(dbs) {
      dbs.forEach(function(db) { 
        try { indexedDB.deleteDatabase(db.name); } catch(e) {}
      });
      steps.push('‚úì IndexedDB cleared (' + dbs.length + ')');
      log.innerHTML = steps.join('<br>');
      checkComplete();
    }).catch(function() {
      steps.push('‚úì IndexedDB check done');
      log.innerHTML = steps.join('<br>');
      checkComplete();
    });
  } else {
    steps.push('‚úì No IndexedDB');
    log.innerHTML = steps.join('<br>');
    checkComplete();
  }
}

function hardReload() {
  location.reload(true);
}

function clearAllCaches() {
  var cleared = [];
  
  // Unregister service workers
  if (navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations().then(function(regs) {
      regs.forEach(function(reg) { reg.unregister(); });
      cleared.push('Service Workers');
    });
  }
  
  // Clear Cache API
  if (window.caches) {
    caches.keys().then(function(names) {
      names.forEach(function(name) { caches.delete(name); });
      cleared.push('Cache Storage');
    });
  }
  
  setTimeout(function() {
    alert('Cleared: ' + (cleared.length ? cleared.join(', ') : 'No caches found') + '\n\nPage will now reload...');
    window.location.href = window.location.href.split('?')[0] + '?cleared=' + Date.now();
  }, 500);
}

function clearLocalStorage() {
  var keys = Object.keys(localStorage);
  var count = keys.length;
  localStorage.clear();
  sessionStorage.clear();
  alert('Cleared ' + count + ' items from Local Storage!\n\n‚ö†Ô∏è Note: Your saved calculations and settings have been removed.');
}

function nukeCacheAndReload() {
  if (!confirm('‚ò¢Ô∏è NUCLEAR OPTION ‚ò¢Ô∏è\n\nThis will:\n‚Ä¢ Clear ALL cached files\n‚Ä¢ Clear ALL local storage\n‚Ä¢ Unregister service workers\n‚Ä¢ Force complete reload\n\nYour saved data will be LOST!\n\nContinue?')) return;
  
  document.body.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:#1a1a2e;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:99999;color:white"><div style="font-size:80px">‚ò¢Ô∏è</div><div style="font-size:18px;margin-top:20px;color:#ef4444">NUKING CACHE...</div><div style="margin-top:10px;opacity:0.7">Please wait...</div></div>';
  
  // Clear everything
  localStorage.clear();
  sessionStorage.clear();
  
  if (navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations().then(function(regs) {
      regs.forEach(function(reg) { reg.unregister(); });
    });
  }
  
  if (window.caches) {
    caches.keys().then(function(names) {
      names.forEach(function(name) { caches.delete(name); });
    });
  }
  
  // Delete IndexedDB databases
  if (window.indexedDB) {
    indexedDB.databases().then(function(dbs) {
      dbs.forEach(function(db) { indexedDB.deleteDatabase(db.name); });
    }).catch(function() {});
  }
  
  setTimeout(function() {
    window.location.href = window.location.href.split('?')[0] + '?nuked=' + Date.now();
  }, 1500);
}

// ========== F/M RATIO CALCULATOR ==========



// ========== MISSING CALCULATOR FUNCTIONS ==========

// SRT Calculator


// HRT Calculator


// BOD Efficiency Calculator


// WAS Calculator


</script>

<script>
// PWA Installation and Service Worker Registration
let deferredPrompt;
let pwaInstallButton;

// Register Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/wwtp-app/service-worker.js')
      .then((registration) => {
        console.log('üëë APEX PWA: Service Worker registered!', registration.scope);
        
        // Check for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          console.log('üîÑ APEX PWA: Update found!');
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New service worker installed, show update notification
              showUpdateNotification();
            }
          });
        });
      })
      .catch((error) => {
        console.error('‚ùå APEX PWA: Service Worker registration failed:', error);
      });
  });
}

// Listen for beforeinstallprompt event
window.addEventListener('beforeinstallprompt', (e) => {
  console.log('üì± APEX PWA: Install prompt available');
  
  // Prevent the mini-infobar from appearing
  
  // Save the event for later use
  deferredPrompt = e;
  
  // Show custom install button
  // showInstallPrompt(); // DISABLED - Use browser native install
});

// Listen for app installed event
window.addEventListener('appinstalled', () => {
  console.log('‚úÖ APEX PWA: App installed successfully!');
  deferredPrompt = null;
  hideInstallPrompt();
  
  // Show success message
  console.log('üéâ APEX WWTP installed successfully!');
});

// Function to show install prompt
function showInstallPrompt() {
  // Create install button if it doesn't exist
  if (!pwaInstallButton) {
    pwaInstallButton = document.createElement('button');
    pwaInstallButton.innerHTML = 'üì± Install APEX App';
    pwaInstallButton.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 999999;
      animation: pulse 2s infinite;
    `;
    
    pwaInstallButton.addEventListener('click', installPWA);
    document.body.appendChild(pwaInstallButton);
    
    // Add animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes pulse {
        0%, 100% { transform: translateX(-50%) scale(1); }
        50% { transform: translateX(-50%) scale(1.05); }
      }
    `;
    document.head.appendChild(style);
  }
}

// Function to hide install prompt
function hideInstallPrompt() {
  if (pwaInstallButton) {
    pwaInstallButton.remove();
    pwaInstallButton = null;
  }
}

// Function to install PWA
async function installPWA() {
  if (!deferredPrompt) {
    console.log('‚ùå APEX PWA: Install prompt not available');
    return;
  }
  
  // Show the install prompt
  deferredPrompt.prompt();
  
  // Wait for the user's response
  const { outcome } = await deferredPrompt.userChoice;
  console.log(`üì± APEX PWA: User response: ${outcome}`);
  
  // Clear the deferred prompt
  deferredPrompt = null;
  
  // Hide the install button
  hideInstallPrompt();
}

// Function to show update notification
function showUpdateNotification() {
  const updateBanner = document.createElement('div');
  updateBanner.innerHTML = `
    <div style="position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#667eea;color:white;padding:15px 30px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:999999;text-align:center">
      <div style="font-weight:bold;margin-bottom:10px">üîÑ Update Available!</div>
      <div style="font-size:14px;margin-bottom:10px">A new version of APEX is ready.</div>
      <button onclick="window.location.reload()" style="background:white;color:#667eea;border:none;padding:8px 20px;border-radius:5px;font-weight:bold;cursor:pointer">
        Update Now
      </button>
      <button onclick="this.parentElement.parentElement.remove()" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:8px 20px;border-radius:5px;margin-left:10px;cursor:pointer">
        Later
      </button>
    </div>
  `;
  document.body.appendChild(updateBanner);
}

// Check if running as PWA
function isPWA() {
  return window.matchMedia('(display-mode: standalone)').matches || 
         window.navigator.standalone || 
         document.referrer.includes('android-app://');
}

// Show PWA status
if (isPWA()) {
  console.log('‚úÖ APEX PWA: Running as installed app!');
} else {
  console.log('üåê APEX PWA: Running in browser');
}

// Handle offline/online status
window.addEventListener('online', () => {
  console.log('üåê APEX PWA: Back online!');
  const banner = document.createElement('div');
  banner.textContent = '‚úÖ Back Online!';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 3000);
});

window.addEventListener('offline', () => {
  console.log('üìµ APEX PWA: Offline mode');
  const banner = document.createElement('div');
  banner.textContent = 'üìµ Offline Mode - Limited Functionality';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff9800;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
});

console.log('üëë APEX PWA: Installation script loaded');

</script>

<div class="notification-container"></div>

<!-- PWA SERVICE WORKER REGISTRATION -->
<script>
// PWA Service Worker Registration
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/wwtp-app/service-worker.js')
      .then(registration => {
        console.log('‚úÖ PWA: Service Worker registered successfully');
        console.log('‚úÖ PWA: Offline mode enabled');
        
        // Check for updates
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              console.log('üîÑ PWA: New version available');
              if (confirm('New version available! Reload to update?')) {
                window.location.reload();
              }
            }
          });
        });
      })
      .catch(error => {
        console.log('‚ö†Ô∏è PWA: Service Worker registration failed (app still works):', error);
      });
  });
}

// PWA Install - Use browser's native install in address bar (no popup button)
window.addEventListener('beforeinstallprompt', (e) => {
  // Don't prevent default - let browser show its native install UI
  console.log('üì± PWA installable - use browser install button in address bar');
});

// PWA installed event
window.addEventListener('appinstalled', () => {
  console.log('‚úÖ APEX WWTP PWA installed successfully!');
});

// Online/Offline status
window.addEventListener('online', () => {
  console.log('üåê Back online');
  const banner = document.createElement('div');
  banner.textContent = '‚úÖ Back Online!';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 3000);
});

window.addEventListener('offline', () => {
  console.log('üìµ Offline mode - Limited functionality');
  const banner = document.createElement('div');
  banner.textContent = 'üìµ Offline Mode - All calculators still work!';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff9800;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
});

console.log('üëë APEX WWTP - COMPLETE PWA EDITION LOADED');
console.log('‚úÖ All original features preserved');
console.log('‚úÖ PWA functionality added');
console.log('‚úÖ Ready for installation');






// ========== MULTI-PLANT FLEET MANAGEMENT ==========

// ========== ENHANCED MULTI-PLANT SYSTEM v5.1.0 ==========

let selectedPlantId = null;
let fleetChart = null;

// Plant data storage
let plantData = JSON.parse(localStorage.getItem('wwtp-plants') || 'null') || [
  { id: 1, name: "North Regional WWTP", location: "Houston, TX", capacity: 5.0, flow: 4.2, efficiency: 94.5, status: "online" },
  { id: 2, name: "South Municipal Plant", location: "Pearland, TX", capacity: 3.5, flow: 2.8, efficiency: 92.1, status: "online" },
  { id: 3, name: "East Industrial WWTP", location: "Pasadena, TX", capacity: 8.0, flow: 6.5, efficiency: 89.7, status: "maintenance" },
  { id: 4, name: "West Community Plant", location: "Katy, TX", capacity: 2.0, flow: 1.6, efficiency: 96.2, status: "online" }
];

function savePlantData() {
  localStorage.setItem('wwtp-plants', JSON.stringify(plantData));
}

function selectPlant(id) {
  selectedPlantId = id;
  document.querySelectorAll('.plant-card').forEach(card => {
    card.style.boxShadow = card.dataset.plantId == id ? '0 0 0 3px var(--info)' : 'none';
  });
  console.log('Selected plant:', id);
}

function addNewPlant() {
  const name = prompt('Plant Name:', 'New Treatment Plant');
  if (!name) return;
  const location = prompt('Location:', 'City, State');
  const capacity = parseFloat(prompt('Capacity (MGD):', '5.0')) || 5.0;
  const flow = parseFloat(prompt('Current Flow (MGD):', '3.5')) || 3.5;
  const efficiency = parseFloat(prompt('Efficiency (%):', '90')) || 90;
  
  const newPlant = {
    id: Date.now(),
    name: name,
    location: location || 'Unknown',
    capacity: capacity,
    flow: flow,
    efficiency: efficiency,
    status: 'online'
  };
  
  plantData.push(newPlant);
  savePlantData();
  renderPlantCards();
  updateFleetKPIs();
  alert('‚úì Plant added successfully!');
}

function editPlant(id) {
  const plant = plantData.find(p => p.id === id);
  if (!plant) return;
  
  const name = prompt('Plant Name:', plant.name);
  if (!name) return;
  plant.name = name;
  plant.location = prompt('Location:', plant.location) || plant.location;
  plant.capacity = parseFloat(prompt('Capacity (MGD):', plant.capacity)) || plant.capacity;
  plant.flow = parseFloat(prompt('Current Flow (MGD):', plant.flow)) || plant.flow;
  plant.efficiency = parseFloat(prompt('Efficiency (%):', plant.efficiency)) || plant.efficiency;
  plant.status = prompt('Status (online/maintenance/offline):', plant.status) || plant.status;
  
  savePlantData();
  renderPlantCards();
  updateFleetKPIs();
  alert('‚úì Plant updated!');
}

function editSelectedPlant() {
  if (!selectedPlantId) {
    alert('Please select a plant first by clicking on it.');
    return;
  }
  editPlant(selectedPlantId);
}

function deleteSelectedPlant() {
  if (!selectedPlantId) {
    alert('Please select a plant first by clicking on it.');
    return;
  }
  const plant = plantData.find(p => p.id === selectedPlantId);
  if (confirm('Delete "' + plant.name + '"? This cannot be undone.')) {
    plantData = plantData.filter(p => p.id !== selectedPlantId);
    savePlantData();
    selectedPlantId = null;
    renderPlantCards();
    updateFleetKPIs();
    alert('‚úì Plant deleted.');
  }
}

function viewPlantDetails(id) {
  const plant = plantData.find(p => p.id === id);
  if (!plant) return;
  
  const load = ((plant.flow / plant.capacity) * 100).toFixed(0);
  const details = `
üè≠ ${plant.name}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìç Location: ${plant.location}
üìä Capacity: ${plant.capacity} MGD
üíß Current Flow: ${plant.flow} MGD
üìà Efficiency: ${plant.efficiency}%
‚ö° Load: ${load}%
üîò Status: ${plant.status.toUpperCase()}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  `;
  alert(details);
}

function exportPlantData() {
  let csv = 'ID,Name,Location,Capacity_MGD,Flow_MGD,Efficiency_Percent,Status\n';
  plantData.forEach(p => {
    csv += `${p.id},"${p.name}","${p.location}",${p.capacity},${p.flow},${p.efficiency},${p.status}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fleet_data_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  alert('‚úì Fleet data exported to CSV!');
}

function importPlantData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv,.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        if (file.name.endsWith('.json')) {
          const imported = JSON.parse(event.target.result);
          plantData = imported;
        } else {
          // Simple CSV parse
          const lines = event.target.result.split('\n');
          const newPlants = [];
          for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',');
            if (cols.length >= 6) {
              newPlants.push({
                id: Date.now() + i,
                name: cols[1].replace(/"/g, ''),
                location: cols[2].replace(/"/g, ''),
                capacity: parseFloat(cols[3]),
                flow: parseFloat(cols[4]),
                efficiency: parseFloat(cols[5]),
                status: cols[6] ? cols[6].trim() : 'online'
              });
            }
          }
          plantData = newPlants;
        }
        savePlantData();
        renderPlantCards();
        updateFleetKPIs();
        alert('‚úì Data imported successfully! ' + plantData.length + ' plants loaded.');
      } catch (err) {
        alert('Error importing: ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function comparePlants() {
  if (plantData.length < 2) {
    alert('Need at least 2 plants to compare.');
    return;
  }
  
  let html = '<h3>‚öñÔ∏è Plant Comparison</h3>';
  html += '<table style="width:100%;border-collapse:collapse;font-size:14px">';
  html += '<tr style="background:var(--info);color:white"><th style="padding:10px">Plant</th><th>Capacity</th><th>Flow</th><th>Efficiency</th><th>Load</th><th>Status</th></tr>';
  
  plantData.forEach((p, i) => {
    const load = ((p.flow / p.capacity) * 100).toFixed(0);
    const bg = i % 2 === 0 ? 'var(--bg-section)' : 'var(--bg-card)';
    html += `<tr style="background:${bg}">
      <td style="padding:10px;font-weight:bold">${p.name}</td>
      <td style="padding:10px">${p.capacity} MGD</td>
      <td style="padding:10px">${p.flow} MGD</td>
      <td style="padding:10px;color:${p.efficiency >= 90 ? '#06d6a0' : '#ffd166'}">${p.efficiency}%</td>
      <td style="padding:10px">${load}%</td>
      <td style="padding:10px"><span class="status ${p.status === 'online' ? 'ok' : 'warn'}">${p.status.toUpperCase()}</span></td>
    </tr>`;
  });
  html += '</table>';
  
  // Add best/worst summary
  const bestEff = plantData.reduce((a, b) => a.efficiency > b.efficiency ? a : b);
  const worstEff = plantData.reduce((a, b) => a.efficiency < b.efficiency ? a : b);
  html += `<div style="margin-top:16px;padding:12px;background:var(--bg-section);border-radius:8px">
    <strong>üèÜ Best Efficiency:</strong> ${bestEff.name} (${bestEff.efficiency}%)<br>
    <strong>‚ö†Ô∏è Needs Attention:</strong> ${worstEff.name} (${worstEff.efficiency}%)
  </div>`;
  
  const modal = document.createElement('div');
  modal.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:9999" onclick="this.remove()"><div style="background:var(--bg-card);padding:24px;border-radius:16px;max-width:700px;width:95%;max-height:80vh;overflow:auto" onclick="event.stopPropagation()">' + html + '<br><button class="btn gray" onclick="this.closest(\'div\').parentElement.remove()">Close</button></div></div>';
  document.body.appendChild(modal);
}

function showFleetAnalytics() {
  const totalCap = plantData.reduce((sum, p) => sum + p.capacity, 0);
  const totalFlow = plantData.reduce((sum, p) => sum + p.flow, 0);
  const avgEff = (plantData.reduce((sum, p) => sum + p.efficiency, 0) / plantData.length).toFixed(1);
  const online = plantData.filter(p => p.status === 'online').length;
  
  const html = `
    <h3>üìä Fleet Analytics</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0">
      <div style="padding:20px;background:linear-gradient(135deg,#667eea20,#667eea10);border-radius:12px;text-align:center">
        <div style="font-size:36px;font-weight:bold;color:#667eea">${plantData.length}</div>
        <div>Total Plants</div>
      </div>
      <div style="padding:20px;background:linear-gradient(135deg,#06d6a020,#06d6a010);border-radius:12px;text-align:center">
        <div style="font-size:36px;font-weight:bold;color:#06d6a0">${online}</div>
        <div>Online</div>
      </div>
      <div style="padding:20px;background:linear-gradient(135deg,#0077b620,#0077b610);border-radius:12px;text-align:center">
        <div style="font-size:36px;font-weight:bold;color:#0077b6">${totalCap.toFixed(1)}</div>
        <div>Total Capacity (MGD)</div>
      </div>
      <div style="padding:20px;background:linear-gradient(135deg,#ffd16620,#ffd16610);border-radius:12px;text-align:center">
        <div style="font-size:36px;font-weight:bold;color:#ffd166">${totalFlow.toFixed(1)}</div>
        <div>Current Flow (MGD)</div>
      </div>
    </div>
    <div style="padding:16px;background:var(--bg-section);border-radius:12px;margin-top:16px">
      <strong>üìà Key Metrics:</strong><br>
      ‚Ä¢ Average Efficiency: <strong>${avgEff}%</strong><br>
      ‚Ä¢ Capacity Utilization: <strong>${((totalFlow/totalCap)*100).toFixed(0)}%</strong><br>
      ‚Ä¢ Plants Online: <strong>${online}/${plantData.length}</strong>
    </div>
  `;
  
  const modal = document.createElement('div');
  modal.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:9999" onclick="this.remove()"><div style="background:var(--bg-card);padding:24px;border-radius:16px;max-width:500px;width:95%" onclick="event.stopPropagation()">' + html + '<br><button class="btn gray" onclick="this.closest(\'div\').parentElement.remove()">Close</button></div></div>';
  document.body.appendChild(modal);
}

function renderPlantCards() {
  const container = document.getElementById('plant-cards');
  if (!container) return;
  
  if (plantData.length === 0) {
    container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;background:var(--bg-section);border-radius:12px"><div style="font-size:48px;margin-bottom:16px">üè≠</div><p>No plants added yet.</p><button class="btn green" onclick="addNewPlant()">‚ûï Add Your First Plant</button></div>';
    return;
  }
  
  let html = '';
  plantData.forEach(p => {
    const load = ((p.flow / p.capacity) * 100).toFixed(0);
    const statusClass = p.status === 'online' ? 'ok' : (p.status === 'maintenance' ? 'warn' : 'error');
    const borderColor = p.status === 'online' ? 'var(--ok)' : (p.status === 'maintenance' ? 'var(--warn)' : 'var(--error)');
    const effColor = p.efficiency >= 90 ? '#06d6a0' : (p.efficiency >= 80 ? '#ffd166' : '#ef4444');
    
    html += `
    <div class="plant-card" data-plant-id="${p.id}" onclick="selectPlant(${p.id})" style="background:var(--bg-section);padding:20px;border-radius:12px;border-left:4px solid ${borderColor};cursor:pointer;transition:all 0.3s">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>${p.name}</strong>
        <span class="status ${statusClass}">${p.status.toUpperCase()}</span>
      </div>
      <div style="color:var(--text-unit);font-size:14px;margin-bottom:12px">üìç ${p.location}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
        <div>Capacity: <strong>${p.capacity} MGD</strong></div>
        <div>Flow: <strong>${p.flow} MGD</strong></div>
        <div>Efficiency: <strong style="color:${effColor}">${p.efficiency}%</strong></div>
        <div>Load: <strong>${load}%</strong></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn small blue" onclick="event.stopPropagation();viewPlantDetails(${p.id})">View</button>
        <button class="btn small orange" onclick="event.stopPropagation();editPlant(${p.id})">Edit</button>
      </div>
    </div>`;
  });
  
  container.innerHTML = html;
}

function updateFleetKPIs() {
  const totalPlants = plantData.length;
  const totalCap = plantData.reduce((sum, p) => sum + p.capacity, 0);
  const totalFlow = plantData.reduce((sum, p) => sum + p.flow, 0);
  const online = plantData.filter(p => p.status === 'online').length;
  const avgEff = totalPlants > 0 ? (plantData.reduce((sum, p) => sum + p.efficiency, 0) / totalPlants).toFixed(1) : 0;
  const avgLoad = totalCap > 0 ? ((totalFlow / totalCap) * 100).toFixed(0) : 0;
  
  const el = (id, val) => { const e = document.getElementById(id); if(e) e.textContent = val; };
  el('fleet-plants', totalPlants);
  el('fleet-capacity', totalCap.toFixed(1) + ' MGD');
  el('fleet-online', online);
  el('fleet-eff', avgEff + '%');
  el('fleet-flow', totalFlow.toFixed(1) + ' MGD');
  el('fleet-load', avgLoad + '%');
}

// Initialize fleet chart
function initFleetChart() {
  const ctx = document.getElementById('fleetComparisonChart');
  if (!ctx) return;
  
  if (fleetChart) fleetChart.destroy();
  
  fleetChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: plantData.map(p => p.name.split(' ')[0]),
      datasets: [
        {
          label: 'Capacity (MGD)',
          data: plantData.map(p => p.capacity),
          backgroundColor: 'rgba(102, 126, 234, 0.7)'
        },
        {
          label: 'Flow (MGD)',
          data: plantData.map(p => p.flow),
          backgroundColor: 'rgba(16, 185, 129, 0.7)'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'MGD' } }
      }
    }
  });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  renderPlantCards();
  updateFleetKPIs();
  setTimeout(initFleetChart, 500);
});





// ========== NEW CALCULATORS v5.1.0 ==========

// Surface Overflow Rate
function calcSOR() {
  var flow = parseFloat(document.getElementById('sor_flow').value) || 0;
  var area = parseFloat(document.getElementById('sor_area').value) || 0;
  var sor = area > 0 ? (flow * 1000000) / area : 0;
  document.getElementById('r_sor').textContent = sor.toFixed(0);
  var status = sor <= 800 ? 'Excellent' : sor <= 1200 ? 'Good' : 'High';
  document.getElementById('r_sor_status').textContent = status;
}
function resetSOR() {
  document.getElementById('sor_flow').value = '5.0';
  document.getElementById('sor_area').value = '5000';
  document.getElementById('r_sor').textContent = '-';
  document.getElementById('r_sor_status').textContent = '-';
}

// Weir Overflow Rate
function calcWOR() {
  var flow = parseFloat(document.getElementById('wor_flow').value) || 0;
  var length = parseFloat(document.getElementById('wor_length').value) || 0;
  var wor = length > 0 ? (flow * 1000000) / length : 0;
  document.getElementById('r_wor').textContent = wor.toFixed(0);
  var status = wor <= 20000 ? 'Excellent' : wor <= 30000 ? 'Good' : 'High';
  document.getElementById('r_wor_status').textContent = status;
}
function resetWOR() {
  document.getElementById('wor_flow').value = '5.0';
  document.getElementById('wor_length').value = '150';
  document.getElementById('r_wor').textContent = '-';
  document.getElementById('r_wor_status').textContent = '-';
}

// Solids Loading Rate
function calcSLR() {
  var flow = parseFloat(document.getElementById('slr_flow').value) || 0;
  var mlss = parseFloat(document.getElementById('slr_mlss').value) || 0;
  var ras = parseFloat(document.getElementById('slr_ras').value) || 0;
  var area = parseFloat(document.getElementById('slr_area').value) || 0;
  var totalFlow = flow + ras;
  var slr = area > 0 ? (totalFlow * mlss * 8.34) / area : 0;
  document.getElementById('r_slr').textContent = slr.toFixed(2);
  var status = slr <= 25 ? 'Excellent' : slr <= 35 ? 'Good' : 'High';
  document.getElementById('r_slr_status').textContent = status;
}
function resetSLR() {
  document.getElementById('slr_flow').value = '5.0';
  document.getElementById('slr_mlss').value = '3000';
  document.getElementById('slr_ras').value = '2.0';
  document.getElementById('slr_area').value = '5000';
  document.getElementById('r_slr').textContent = '-';
  document.getElementById('r_slr_status').textContent = '-';
}

// MCRT Calculator
function calcMCRT() {
  var vol = parseFloat(document.getElementById('mcrt_vol').value) || 0;
  var mlss = parseFloat(document.getElementById('mcrt_mlss').value) || 0;
  var was = parseFloat(document.getElementById('mcrt_was').value) || 0;
  var wasTss = parseFloat(document.getElementById('mcrt_was_tss').value) || 0;
  var eff = parseFloat(document.getElementById('mcrt_eff').value) || 0;
  var effTss = parseFloat(document.getElementById('mcrt_eff_tss').value) || 0;
  var solids = vol * mlss * 8.34;
  var wasted = (was * wasTss * 8.34) + (eff * effTss * 8.34);
  var mcrt = wasted > 0 ? solids / wasted : 0;
  document.getElementById('r_mcrt_solids').textContent = solids.toFixed(0);
  document.getElementById('r_mcrt_wasted').textContent = wasted.toFixed(0);
  document.getElementById('r_mcrt').textContent = mcrt.toFixed(1);
  var status = mcrt >= 5 && mcrt <= 15 ? 'Optimal' : mcrt < 5 ? 'Low' : 'High';
  document.getElementById('r_mcrt_status').textContent = status;
}
function resetMCRT() {
  document.getElementById('mcrt_vol').value = '1.5';
  document.getElementById('mcrt_mlss').value = '3000';
  document.getElementById('mcrt_was').value = '0.05';
  document.getElementById('mcrt_was_tss').value = '8000';
  document.getElementById('mcrt_eff').value = '5.0';
  document.getElementById('mcrt_eff_tss').value = '10';
  ['r_mcrt_solids','r_mcrt_wasted','r_mcrt','r_mcrt_status'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Oxygen Uptake Rate
function calcOUR() {
  var do1 = parseFloat(document.getElementById('our_do1').value) || 0;
  var do2 = parseFloat(document.getElementById('our_do2').value) || 0;
  var time = parseFloat(document.getElementById('our_time').value) || 0;
  var mlvss = parseFloat(document.getElementById('our_mlvss').value) || 0;
  var our = time > 0 ? ((do1 - do2) / time) * 60 : 0;
  var sour = mlvss > 0 ? (our / mlvss) * 1000 : 0;
  document.getElementById('r_our').textContent = our.toFixed(1);
  document.getElementById('r_sour').textContent = sour.toFixed(1);
  var status = sour >= 8 && sour <= 20 ? 'Normal' : sour < 8 ? 'Low Activity' : 'High Activity';
  document.getElementById('r_our_status').textContent = status;
}
function resetOUR() {
  document.getElementById('our_do1').value = '6.0';
  document.getElementById('our_do2').value = '2.0';
  document.getElementById('our_time').value = '15';
  document.getElementById('our_mlvss').value = '2000';
  ['r_our','r_sour','r_our_status'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Ammonia Removal
function calcNH3() {
  var nh3In = parseFloat(document.getElementById('nh3_in').value) || 0;
  var nh3Out = parseFloat(document.getElementById('nh3_out').value) || 0;
  var flow = parseFloat(document.getElementById('nh3_flow').value) || 0;
  var removed = nh3In - nh3Out;
  var eff = nh3In > 0 ? (removed / nh3In) * 100 : 0;
  var mass = removed * flow * 8.34;
  var alk = mass * 7.14; // 7.14 lb alk per lb NH3-N
  document.getElementById('r_nh3_removed').textContent = removed.toFixed(1);
  document.getElementById('r_nh3_eff').textContent = eff.toFixed(1);
  document.getElementById('r_nh3_mass').textContent = mass.toFixed(0);
  document.getElementById('r_nh3_alk').textContent = alk.toFixed(0);
}
function resetNH3() {
  document.getElementById('nh3_in').value = '25';
  document.getElementById('nh3_out').value = '1.0';
  document.getElementById('nh3_flow').value = '5.0';
  ['r_nh3_removed','r_nh3_eff','r_nh3_mass','r_nh3_alk'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Phosphorus Removal
function calcPhos() {
  var pIn = parseFloat(document.getElementById('phos_in').value) || 0;
  var pOut = parseFloat(document.getElementById('phos_out').value) || 0;
  var flow = parseFloat(document.getElementById('phos_flow').value) || 0;
  var chem = document.getElementById('phos_chem').value;
  var removed = pIn - pOut;
  var eff = pIn > 0 ? (removed / pIn) * 100 : 0;
  var massP = removed * flow * 8.34;
  // Molar ratios: Alum ~2.5 mol Al/mol P, Ferric ~1.8 mol Fe/mol P
  var ratio = chem === 'alum' ? 2.5 : 1.8;
  var chemMW = chem === 'alum' ? 594 : 162.2; // Alum or FeCl3
  var pMW = 31;
  var dose = massP * (ratio * chemMW / pMW);
  document.getElementById('r_phos_removed').textContent = removed.toFixed(1);
  document.getElementById('r_phos_eff').textContent = eff.toFixed(1);
  document.getElementById('r_phos_dose').textContent = dose.toFixed(0);
  document.getElementById('r_phos_ratio').textContent = ratio.toFixed(1);
}
function resetPhos() {
  document.getElementById('phos_in').value = '6.0';
  document.getElementById('phos_out').value = '0.5';
  document.getElementById('phos_flow').value = '5.0';
  document.getElementById('phos_chem').value = 'alum';
  ['r_phos_removed','r_phos_eff','r_phos_dose','r_phos_ratio'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// TSS/VSS Removal
function calcTSS() {
  var tssIn = parseFloat(document.getElementById('tss_in').value) || 0;
  var tssOut = parseFloat(document.getElementById('tss_out').value) || 0;
  var vssIn = parseFloat(document.getElementById('vss_in').value) || 0;
  var vssOut = parseFloat(document.getElementById('vss_out').value) || 0;
  var tssEff = tssIn > 0 ? ((tssIn - tssOut) / tssIn) * 100 : 0;
  var vssEff = vssIn > 0 ? ((vssIn - vssOut) / vssIn) * 100 : 0;
  var ratioIn = tssIn > 0 ? vssIn / tssIn : 0;
  var ratioOut = tssOut > 0 ? vssOut / tssOut : 0;
  document.getElementById('r_tss_eff').textContent = tssEff.toFixed(1);
  document.getElementById('r_vss_eff').textContent = vssEff.toFixed(1);
  document.getElementById('r_vss_tss_in').textContent = ratioIn.toFixed(2);
  document.getElementById('r_vss_tss_out').textContent = ratioOut.toFixed(2);
}
function resetTSS() {
  document.getElementById('tss_in').value = '250';
  document.getElementById('tss_out').value = '10';
  document.getElementById('vss_in').value = '200';
  document.getElementById('vss_out').value = '8';
  ['r_tss_eff','r_vss_eff','r_vss_tss_in','r_vss_tss_out'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Grit Chamber
function calcGrit() {
  var flow = parseFloat(document.getElementById('grit_flow').value) || 0;
  var dt = parseFloat(document.getElementById('grit_dt').value) || 0;
  var depth = parseFloat(document.getElementById('grit_depth').value) || 0;
  var width = parseFloat(document.getElementById('grit_width').value) || 0;
  var flowCfm = (flow * 1000000) / (24 * 60 * 7.48);
  var vol = flowCfm * dt;
  var area = depth > 0 ? vol / depth : 0;
  var length = width > 0 ? area / width : 0;
  var vel = (width * depth) > 0 ? flowCfm / (width * depth) : 0;
  document.getElementById('r_grit_vol').textContent = vol.toFixed(0);
  document.getElementById('r_grit_length').textContent = length.toFixed(1);
  document.getElementById('r_grit_area').textContent = area.toFixed(0);
  document.getElementById('r_grit_vel').textContent = vel.toFixed(2);
}
function resetGrit() {
  document.getElementById('grit_flow').value = '10.0';
  document.getElementById('grit_dt').value = '3';
  document.getElementById('grit_depth').value = '10';
  document.getElementById('grit_width').value = '8';
  ['r_grit_vol','r_grit_length','r_grit_area','r_grit_vel'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Digester Loading
function calcDigester() {
  var vol = parseFloat(document.getElementById('dig_vol').value) || 0;
  var solids = parseFloat(document.getElementById('dig_solids').value) || 0;
  var vsRatio = parseFloat(document.getElementById('dig_vs').value) || 0;
  var tank = parseFloat(document.getElementById('dig_tank').value) || 0;
  var vsLoad = vol * 8.34 * (solids / 100) * vsRatio;
  var vlr = tank > 0 ? vsLoad / tank : 0;
  var hrt = vol > 0 ? (tank * 7.48) / vol : 0;
  document.getElementById('r_dig_vs').textContent = vsLoad.toFixed(0);
  document.getElementById('r_dig_vlr').textContent = vlr.toFixed(3);
  document.getElementById('r_dig_hrt').textContent = hrt.toFixed(1);
  var status = vlr <= 0.1 ? 'Good' : vlr <= 0.2 ? 'Moderate' : 'High';
  document.getElementById('r_dig_status').textContent = status;
}
function resetDigester() {
  document.getElementById('dig_vol').value = '50000';
  document.getElementById('dig_solids').value = '5';
  document.getElementById('dig_vs').value = '0.75';
  document.getElementById('dig_tank').value = '50000';
  ['r_dig_vs','r_dig_vlr','r_dig_hrt','r_dig_status'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// ========== END NEW CALCULATORS ==========




// ========== MORE CALCULATORS v5.1.0 ==========

// Headloss Calculator (Hazen-Williams)
function calcHeadloss() {
  var flow = parseFloat(document.getElementById('hl_flow').value) || 0;
  var dia = parseFloat(document.getElementById('hl_dia').value) || 0;
  var length = parseFloat(document.getElementById('hl_length').value) || 0;
  var c = parseFloat(document.getElementById('hl_c').value) || 120;
  var areaFt2 = Math.PI * Math.pow(dia/12/2, 2);
  var flowCfs = flow / 448.8;
  var vel = areaFt2 > 0 ? flowCfs / areaFt2 : 0;
  // Hazen-Williams: hf = 10.67 * L * Q^1.852 / (C^1.852 * D^4.87)
  var hf = 10.67 * length * Math.pow(flow/448.8, 1.852) / (Math.pow(c, 1.852) * Math.pow(dia/12, 4.87));
  var hf100 = length > 0 ? (hf / length) * 100 : 0;
  document.getElementById('r_hl_vel').textContent = vel.toFixed(2);
  document.getElementById('r_hl_loss').textContent = hf.toFixed(2);
  document.getElementById('r_hl_100').textContent = hf100.toFixed(3);
}
function resetHeadloss() {
  document.getElementById('hl_flow').value = '1000';
  document.getElementById('hl_dia').value = '8';
  document.getElementById('hl_length').value = '500';
  document.getElementById('hl_c').value = '120';
  ['r_hl_vel','r_hl_loss','r_hl_100'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Blower Air Requirements
function calcBlower() {
  var o2 = parseFloat(document.getElementById('blower_o2').value) || 0;
  var eff = parseFloat(document.getElementById('blower_eff').value) || 25;
  var depth = parseFloat(document.getElementById('blower_depth').value) || 15;
  // Air is 23.2% O2 by weight, density ~0.075 lb/cf
  var airLb = o2 / (eff / 100);
  var airScfm = (airLb / 0.075) / 1440;
  // Blower HP estimate: HP = SCFM * (discharge pressure) / (229 * efficiency)
  var psi = depth * 0.433 + 1; // approximate discharge pressure
  var hp = airScfm * psi / (229 * 0.70);
  var kwh = hp * 0.746 * 8760;
  document.getElementById('r_blower_air').textContent = airScfm.toFixed(0);
  document.getElementById('r_blower_hp').textContent = hp.toFixed(1);
  document.getElementById('r_blower_kwh').textContent = kwh.toFixed(0);
}
function resetBlower() {
  document.getElementById('blower_o2').value = '5000';
  document.getElementById('blower_eff').value = '25';
  document.getElementById('blower_depth').value = '15';
  ['r_blower_air','r_blower_hp','r_blower_kwh'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// UV Disinfection
function calcUV() {
  var flow = parseFloat(document.getElementById('uv_flow').value) || 0;
  var dose = parseFloat(document.getElementById('uv_dose').value) || 40;
  var uvt = parseFloat(document.getElementById('uv_uvt').value) || 65;
  var log = parseFloat(document.getElementById('uv_log').value) || 4;
  var gpm = flow * 1000000 / 1440;
  // Rough estimates based on typical UV systems
  var lampsPerMGD = 15 + (100 - uvt) * 0.5 + (log - 3) * 5;
  var lamps = Math.ceil(flow * lampsPerMGD);
  var power = lamps * 0.3; // ~300W per lamp average
  document.getElementById('r_uv_channel').textContent = gpm.toFixed(0);
  document.getElementById('r_uv_lamps').textContent = lamps;
  document.getElementById('r_uv_power').textContent = power.toFixed(1);
}
function resetUV() {
  document.getElementById('uv_flow').value = '5.0';
  document.getElementById('uv_dose').value = '40';
  document.getElementById('uv_uvt').value = '65';
  document.getElementById('uv_log').value = '4';
  ['r_uv_channel','r_uv_lamps','r_uv_power'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Sludge Thickening
function calcThickening() {
  var flow = parseFloat(document.getElementById('thick_flow').value) || 0;
  var feed = parseFloat(document.getElementById('thick_feed').value) || 0;
  var out = parseFloat(document.getElementById('thick_out').value) || 0;
  var capture = parseFloat(document.getElementById('thick_capture').value) || 95;
  var dryIn = flow * 60 * 8.34 * (feed / 100);
  var captured = dryIn * (capture / 100);
  var flowOut = out > 0 ? captured / (8.34 * (out / 100) * 60) : 0;
  var reduction = flow > 0 ? ((flow - flowOut) / flow) * 100 : 0;
  document.getElementById('r_thick_in').textContent = dryIn.toFixed(0);
  document.getElementById('r_thick_flowout').textContent = flowOut.toFixed(1);
  document.getElementById('r_thick_captured').textContent = captured.toFixed(0);
  document.getElementById('r_thick_reduction').textContent = reduction.toFixed(1);
}
function resetThickening() {
  document.getElementById('thick_flow').value = '100';
  document.getElementById('thick_feed').value = '0.8';
  document.getElementById('thick_out').value = '5.0';
  document.getElementById('thick_capture').value = '95';
  ['r_thick_in','r_thick_flowout','r_thick_captured','r_thick_reduction'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Equalization Basin
function calcEQ() {
  var peak = parseFloat(document.getElementById('eq_peak').value) || 0;
  var avg = parseFloat(document.getElementById('eq_avg').value) || 0;
  var duration = parseFloat(document.getElementById('eq_duration').value) || 0;
  var excess = peak - avg;
  var vol = (excess * duration) / 24;
  var gal = vol * 1000000;
  var ratio = avg > 0 ? peak / avg : 0;
  document.getElementById('r_eq_vol').textContent = vol.toFixed(3);
  document.getElementById('r_eq_gal').textContent = gal.toFixed(0);
  document.getElementById('r_eq_ratio').textContent = ratio.toFixed(2);
}
function resetEQ() {
  document.getElementById('eq_peak').value = '8.0';
  document.getElementById('eq_avg').value = '5.0';
  document.getElementById('eq_duration').value = '4';
  ['r_eq_vol','r_eq_gal','r_eq_ratio'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Chemical Feed Rate
function calcChemFeed() {
  var flow = parseFloat(document.getElementById('chem_flow').value) || 0;
  var dose = parseFloat(document.getElementById('chem_dose').value) || 0;
  var strength = parseFloat(document.getElementById('chem_strength').value) || 0;
  var sg = parseFloat(document.getElementById('chem_sg').value) || 1.0;
  var dryLb = flow * dose * 8.34;
  var galDay = strength > 0 ? dryLb / (8.34 * sg * (strength / 100)) : 0;
  var gph = galDay / 24;
  var mlmin = gph * 63.09;
  document.getElementById('r_chem_dry').textContent = dryLb.toFixed(0);
  document.getElementById('r_chem_gal').textContent = galDay.toFixed(1);
  document.getElementById('r_chem_gph').textContent = gph.toFixed(2);
  document.getElementById('r_chem_mlmin').textContent = mlmin.toFixed(1);
}
function resetChemFeed() {
  document.getElementById('chem_flow').value = '5.0';
  document.getElementById('chem_dose').value = '50';
  document.getElementById('chem_strength').value = '50';
  document.getElementById('chem_sg').value = '1.2';
  ['r_chem_dry','r_chem_gal','r_chem_gph','r_chem_mlmin'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Screenings & Grit
function calcScreenings() {
  var flow = parseFloat(document.getElementById('screen_flow').value) || 0;
  var opening = parseFloat(document.getElementById('screen_opening').value) || 0.25;
  var pop = parseFloat(document.getElementById('screen_pop').value) || 0;
  // Typical values: 0.5-3 cf/MG for fine screens
  var screenFactor = opening < 0.25 ? 2.5 : opening < 0.5 ? 1.5 : 0.8;
  var screenVol = flow * screenFactor;
  var screenCY = (screenVol * 30) / 27;
  // Grit: typically 0.5-3 cf/MG
  var gritVol = flow * 1.5;
  var gritCY = (gritVol * 30) / 27;
  document.getElementById('r_screen_vol').textContent = screenVol.toFixed(1);
  document.getElementById('r_screen_cy').textContent = screenCY.toFixed(1);
  document.getElementById('r_grit_vol2').textContent = gritVol.toFixed(1);
  document.getElementById('r_grit_cy').textContent = gritCY.toFixed(1);
}
function resetScreenings() {
  document.getElementById('screen_flow').value = '5.0';
  document.getElementById('screen_opening').value = '0.25';
  document.getElementById('screen_pop').value = '50000';
  ['r_screen_vol','r_screen_cy','r_grit_vol2','r_grit_cy'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Primary Clarifier
function calcPrimary() {
  var bodIn = parseFloat(document.getElementById('prim_bod_in').value) || 0;
  var tssIn = parseFloat(document.getElementById('prim_tss_in').value) || 0;
  var sor = parseFloat(document.getElementById('prim_sor').value) || 800;
  // Typical removal based on SOR
  var bodRem = 25 + (1200 - sor) * 0.02;
  bodRem = Math.min(40, Math.max(20, bodRem));
  var tssRem = 45 + (1200 - sor) * 0.03;
  tssRem = Math.min(70, Math.max(40, tssRem));
  var bodOut = bodIn * (1 - bodRem/100);
  var tssOut = tssIn * (1 - tssRem/100);
  document.getElementById('r_prim_bod_rem').textContent = bodRem.toFixed(0);
  document.getElementById('r_prim_tss_rem').textContent = tssRem.toFixed(0);
  document.getElementById('r_prim_bod_out').textContent = bodOut.toFixed(0);
  document.getElementById('r_prim_tss_out').textContent = tssOut.toFixed(0);
}
function resetPrimary() {
  document.getElementById('prim_bod_in').value = '250';
  document.getElementById('prim_tss_in').value = '300';
  document.getElementById('prim_sor').value = '800';
  ['r_prim_bod_rem','r_prim_tss_rem','r_prim_bod_out','r_prim_tss_out'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Trickling Filter
function calcTF() {
  var flow = parseFloat(document.getElementById('tf_flow').value) || 0;
  var bod = parseFloat(document.getElementById('tf_bod').value) || 0;
  var vol = parseFloat(document.getElementById('tf_vol').value) || 0;
  var recirc = parseFloat(document.getElementById('tf_recirc').value) || 0;
  var bodLoad = flow * bod * 8.34;
  var olr = vol > 0 ? (bodLoad / vol) * 1000 : 0;
  var surfArea = Math.pow(vol / 6, 0.667) * 6; // estimate for 6ft depth
  var hlr = surfArea > 0 ? ((flow + flow * recirc) * 1000000) / surfArea : 0;
  // NRC formula approximation for removal
  var removal = 100 / (1 + 0.0044 * Math.sqrt(olr));
  document.getElementById('r_tf_olr').textContent = olr.toFixed(1);
  document.getElementById('r_tf_hlr').textContent = hlr.toFixed(0);
  document.getElementById('r_tf_removal').textContent = removal.toFixed(0);
}
function resetTF() {
  document.getElementById('tf_flow').value = '2.0';
  document.getElementById('tf_bod').value = '150';
  document.getElementById('tf_vol').value = '50000';
  document.getElementById('tf_recirc').value = '1.0';
  ['r_tf_olr','r_tf_hlr','r_tf_removal'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Biosolids Land Application
function calcBiosolids() {
  var tons = parseFloat(document.getElementById('bio_tons').value) || 0;
  var nPct = parseFloat(document.getElementById('bio_n').value) || 0;
  var rate = parseFloat(document.getElementById('bio_rate').value) || 0;
  var avail = parseFloat(document.getElementById('bio_avail').value) || 0;
  var totalN = tons * 2000 * (nPct / 100);
  var availN = totalN * (avail / 100);
  var acres = rate > 0 ? availN / rate : 0;
  var tonsPerAc = acres > 0 ? tons / acres : 0;
  document.getElementById('r_bio_total_n').textContent = totalN.toFixed(0);
  document.getElementById('r_bio_avail_n').textContent = availN.toFixed(0);
  document.getElementById('r_bio_acres').textContent = acres.toFixed(0);
  document.getElementById('r_bio_tons_ac').textContent = tonsPerAc.toFixed(2);
}
function resetBiosolids() {
  document.getElementById('bio_tons').value = '500';
  document.getElementById('bio_n').value = '4';
  document.getElementById('bio_rate').value = '150';
  document.getElementById('bio_avail').value = '40';
  ['r_bio_total_n','r_bio_avail_n','r_bio_acres','r_bio_tons_ac'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// ========== END MORE CALCULATORS ==========










// ========== OPERATOR TOOLS v5.1.0 ==========

// Daily Rounds Checklist
function saveChecklist() {
  var checkboxes = document.querySelectorAll('#dailyChecklist input[type="checkbox"]');
  var data = {};
  var completed = 0;
  checkboxes.forEach(function(cb) {
    data[cb.id] = cb.checked;
    if (cb.checked) completed++;
  });
  data._date = new Date().toDateString();
  localStorage.setItem('wwtp_checklist', JSON.stringify(data));
  updateChecklistProgress(completed, checkboxes.length);
}

function loadChecklist() {
  var saved = localStorage.getItem('wwtp_checklist');
  if (saved) {
    var data = JSON.parse(saved);
    if (data._date === new Date().toDateString()) {
      var completed = 0;
      var total = 0;
      Object.keys(data).forEach(function(id) {
        if (id.startsWith('chk_')) {
          var cb = document.getElementById(id);
          if (cb) {
            cb.checked = data[id];
            if (data[id]) completed++;
            total++;
          }
        }
      });
      updateChecklistProgress(completed, total);
    }
  }
}

function resetDailyChecklist() {
  if (confirm('Reset all checklist items for today?')) {
    var checkboxes = document.querySelectorAll('#dailyChecklist input[type="checkbox"]');
    checkboxes.forEach(function(cb) { cb.checked = false; });
    localStorage.removeItem('wwtp_checklist');
    updateChecklistProgress(0, checkboxes.length);
    showToast('Checklist reset!', 'info');
  }
}

function updateChecklistProgress(completed, total) {
  var pct = total > 0 ? Math.round((completed / total) * 100) : 0;
  document.getElementById('checklistProgress').textContent = completed + ' / ' + total + ' (' + pct + '%)';
  document.getElementById('checklistBar').style.width = pct + '%';
  if (pct === 100) {
    showToast('üéâ Daily rounds complete!', 'success');
  }
}

// Load checklist on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(loadChecklist, 500);
});

// Calculation Wizards
var wizardSteps = {
  fm: [
    { title: 'Step 1: Get BOD Concentration', input: 'wizard_bod', label: 'Enter influent BOD (mg/L)', default: 200, hint: 'Check lab results or use typical value of 150-250 mg/L' },
    { title: 'Step 2: Get Flow Rate', input: 'wizard_flow', label: 'Enter daily flow (MGD)', default: 5.0, hint: 'Read from plant flow meter' },
    { title: 'Step 3: Calculate BOD Loading', calc: true, formula: 'BOD Load = BOD √ó Flow √ó 8.34', result: 'wizard_bodload' },
    { title: 'Step 4: Get MLVSS', input: 'wizard_mlvss', label: 'Enter MLVSS (mg/L)', default: 2000, hint: 'MLVSS = MLSS √ó 0.7 to 0.8 typically' },
    { title: 'Step 5: Get Aeration Volume', input: 'wizard_vol', label: 'Enter aeration volume (MG)', default: 1.0, hint: 'Check plant design specs' },
    { title: 'Step 6: Calculate F/M Ratio', calc: true, formula: 'F/M = BOD Load / (MLVSS √ó Volume √ó 8.34)', result: 'wizard_fm', final: true }
  ],
  srt: [
    { title: 'Step 1: Get MLSS', input: 'wizard_srt_mlss', label: 'Enter MLSS (mg/L)', default: 3000, hint: 'From settleometer or lab analysis' },
    { title: 'Step 2: Get Aeration Volume', input: 'wizard_srt_vol', label: 'Enter aeration volume (MG)', default: 1.5, hint: 'Total aeration basin volume' },
    { title: 'Step 3: Calculate System Solids', calc: true, formula: 'System Solids = MLSS √ó Volume √ó 8.34', result: 'wizard_srt_solids' },
    { title: 'Step 4: Get WAS Flow', input: 'wizard_srt_was', label: 'Enter WAS flow (MGD)', default: 0.05, hint: 'Daily waste sludge volume' },
    { title: 'Step 5: Get WAS TSS', input: 'wizard_srt_wastss', label: 'Enter WAS TSS (mg/L)', default: 8000, hint: 'Concentration of waste sludge' },
    { title: 'Step 6: Calculate SRT', calc: true, formula: 'SRT = System Solids / (WAS Flow √ó WAS TSS √ó 8.34)', result: 'wizard_srt', final: true }
  ],
  was: [
    { title: 'Step 1: Current MLSS', input: 'wizard_was_mlss', label: 'Enter current MLSS (mg/L)', default: 3500, hint: 'Your current concentration' },
    { title: 'Step 2: Target MLSS', input: 'wizard_was_target', label: 'Enter target MLSS (mg/L)', default: 3000, hint: 'Desired concentration' },
    { title: 'Step 3: Aeration Volume', input: 'wizard_was_vol', label: 'Enter volume (MG)', default: 1.0, hint: 'Basin volume' },
    { title: 'Step 4: Calculate WAS Needed', calc: true, formula: 'WAS = (Current - Target) √ó Volume √ó 8.34 / WAS Concentration', result: 'wizard_was_result', final: true }
  ],
  chlorine: [
    { title: 'Step 1: Get Flow Rate', input: 'wizard_cl_flow', label: 'Enter flow (MGD)', default: 5.0, hint: 'Daily flow rate' },
    { title: 'Step 2: Target Dose', input: 'wizard_cl_dose', label: 'Enter target dose (mg/L)', default: 5.0, hint: 'Typical 2-10 mg/L' },
    { title: 'Step 3: Solution Strength', input: 'wizard_cl_str', label: 'Enter solution strength (%)', default: 12.5, hint: 'Check chemical label' },
    { title: 'Step 4: Calculate Feed Rate', calc: true, formula: 'Feed = (Flow √ó Dose √ó 8.34) / (Strength √ó 8.34)', result: 'wizard_cl_result', final: true }
  ],

  svi: [
    { title: 'Step 1: Get Settled Volume', input: 'wizard_svi_vol', label: 'Enter 30-min settled volume (mL/L)', default: 250, hint: 'Use 1L graduated cylinder, let settle 30 min' },
    { title: 'Step 2: Get MLSS', input: 'wizard_svi_mlss', label: 'Enter MLSS (mg/L)', default: 3000, hint: 'From lab analysis or portable meter' },
    { title: 'Step 3: Calculate SVI', calc: true, formula: 'SVI = (Settled Volume √ó 1000) / MLSS', result: 'wizard_svi', final: true }
  ],
  bod_removal: [
    { title: 'Step 1: Get Influent BOD', input: 'wizard_bod_in', label: 'Enter influent BOD (mg/L)', default: 200, hint: 'From lab analysis, typical 150-300 mg/L' },
    { title: 'Step 2: Get Effluent BOD', input: 'wizard_bod_out', label: 'Enter effluent BOD (mg/L)', default: 15, hint: 'From lab analysis, permit limit typically <30 mg/L' },
    { title: 'Step 3: Get Flow Rate', input: 'wizard_bod_flow', label: 'Enter flow rate (MGD)', default: 5.0, hint: 'Daily average flow' },
    { title: 'Step 4: Calculate Removal', calc: true, formula: '% Removal = ((In - Out) / In) √ó 100', result: 'wizard_bod_removal', final: true }
  ],
  ras: [
    { title: 'Step 1: Get Influent Flow', input: 'wizard_ras_flow', label: 'Enter influent flow (MGD)', default: 5.0, hint: 'Current plant flow rate' },
    { title: 'Step 2: Get MLSS', input: 'wizard_ras_mlss', label: 'Enter aeration MLSS (mg/L)', default: 3000, hint: 'Mixed liquor concentration' },
    { title: 'Step 3: Get RAS TSS', input: 'wizard_ras_tss', label: 'Enter RAS TSS (mg/L)', default: 8000, hint: 'Return sludge concentration, typically 6000-12000' },
    { title: 'Step 4: Calculate RAS Rate', calc: true, formula: 'RAS Rate = (MLSS √ó Q) / (RAS TSS - MLSS)', result: 'wizard_ras_rate', final: true }
  ],
  detention: [
    { title: 'Step 1: Get Tank Volume', input: 'wizard_det_vol', label: 'Enter tank volume (gallons)', default: 500000, hint: 'Total basin volume' },
    { title: 'Step 2: Get Flow Rate', input: 'wizard_det_flow', label: 'Enter flow rate (GPM)', default: 3500, hint: 'Current flow in gallons per minute' },
    { title: 'Step 3: Calculate Detention Time', calc: true, formula: 'DT = Volume / Flow', result: 'wizard_det_time', final: true }
  ],
  sor: [
    { title: 'Step 1: Get Flow Rate', input: 'wizard_sor_flow', label: 'Enter flow rate (GPD)', default: 5000000, hint: 'Daily flow in gallons' },
    { title: 'Step 2: Get Clarifier Area', input: 'wizard_sor_area', label: 'Enter surface area (sq ft)', default: 5000, hint: 'œÄ √ó r¬≤ for circular clarifier' },
    { title: 'Step 3: Calculate SOR', calc: true, formula: 'SOR = Flow / Area', result: 'wizard_sor', final: true }
  ],
  polymer: [
    { title: 'Step 1: Get Sludge Flow', input: 'wizard_poly_flow', label: 'Enter sludge flow (GPM)', default: 100, hint: 'Feed rate to dewatering' },
    { title: 'Step 2: Get Sludge Solids', input: 'wizard_poly_solids', label: 'Enter feed solids (%)', default: 3.0, hint: 'Percent solids in feed sludge' },
    { title: 'Step 3: Get Target Dose', input: 'wizard_poly_dose', label: 'Enter target dose (lb/ton)', default: 15, hint: 'Typical 10-25 lb/dry ton' },
    { title: 'Step 4: Get Polymer Strength', input: 'wizard_poly_str', label: 'Enter solution strength (%)', default: 0.5, hint: 'Neat polymer is typically 0.25-0.5%' },
    { title: 'Step 5: Calculate Feed Rate', calc: true, formula: 'Polymer GPM = (Sludge GPM √ó %Solids √ó Dose) / (%Strength √ó 8.34 √ó 2000)', result: 'wizard_poly_rate', final: true }
  ],
  blower: [
    { title: 'Step 1: Get BOD Load', input: 'wizard_air_bod', label: 'Enter BOD load (lb/day)', default: 8340, hint: 'From BOD √ó Flow √ó 8.34' },
    { title: 'Step 2: Get O2 Ratio', input: 'wizard_air_ratio', label: 'Enter O2/BOD ratio', default: 1.5, hint: 'Typical 1.1-1.5 for carbonaceous, 2.0+ for nitrification' },
    { title: 'Step 3: Get Transfer Efficiency', input: 'wizard_air_eff', label: 'Enter transfer efficiency (%)', default: 8, hint: 'Fine bubble: 6-12%, Coarse: 4-8%' },
    { title: 'Step 4: Get Diffuser Depth', input: 'wizard_air_depth', label: 'Enter diffuser depth (ft)', default: 15, hint: 'Depth below water surface' },
    { title: 'Step 5: Calculate Air Required', calc: true, formula: 'SCFM = (O2 Required √ó 100) / (%Eff √ó 0.0173 √ó Depth)', result: 'wizard_air_scfm', final: true }
  ],
  ct: [
    { title: 'Step 1: Get Contact Time', input: 'wizard_ct_time', label: 'Enter contact time T10 (min)', default: 30, hint: 'Time for 10% of flow to pass through tank' },
    { title: 'Step 2: Get Chlorine Residual', input: 'wizard_ct_cl', label: 'Enter chlorine residual (mg/L)', default: 0.5, hint: 'Free or total chlorine at outlet' },
    { title: 'Step 3: Get Required CT', input: 'wizard_ct_req', label: 'Enter required CT (mg¬∑min/L)', default: 15, hint: 'From permit or tables based on pathogen' },
    { title: 'Step 4: Calculate CT Ratio', calc: true, formula: 'CT Ratio = (Residual √ó Time) / Required CT', result: 'wizard_ct_ratio', final: true }
  ]

};

var currentWizard = null;
var currentStep = 0;
var wizardData = {};

// ==================== SPC/SQC CONTROL CHARTS v9.9.16 ====================
var SPCCharts = {
  currentParam: 'do',
  chart: null,
  
  // Parameter configurations with permit limits
  params: {
    do: { name: 'DO', unit: 'mg/L', lsl: 1.0, usl: 4.0, target: 2.0, decimals: 2 },
    mlss: { name: 'MLSS', unit: 'mg/L', lsl: 1500, usl: 4500, target: 3000, decimals: 0 },
    ph: { name: 'pH', unit: '', lsl: 6.0, usl: 9.0, target: 7.0, decimals: 2 },
    svi: { name: 'SVI', unit: 'mL/g', lsl: 50, usl: 200, target: 120, decimals: 0 },
    tss: { name: 'Eff TSS', unit: 'mg/L', lsl: 0, usl: 30, target: 15, decimals: 1 },
    nh3: { name: 'Eff NH‚ÇÉ', unit: 'mg/L', lsl: 0, usl: 5, target: 2, decimals: 2 }
  },
  
  // Data storage (localStorage)
  getData: function(param) {
    var key = 'spc_data_' + param;
    var data = localStorage.getItem(key);
    return data ? JSON.parse(data) : [];
  },
  
  setData: function(param, data) {
    var key = 'spc_data_' + param;
    localStorage.setItem(key, JSON.stringify(data));
  },
  
  // Statistical calculations
  calcStats: function(values) {
    if (values.length === 0) return { mean: 0, stdDev: 0, min: 0, max: 0 };
    var sum = values.reduce(function(a, b) { return a + b; }, 0);
    var mean = sum / values.length;
    var sqDiffs = values.map(function(v) { return Math.pow(v - mean, 2); });
    var avgSqDiff = sqDiffs.reduce(function(a, b) { return a + b; }, 0) / values.length;
    var stdDev = Math.sqrt(avgSqDiff);
    return {
      mean: mean,
      stdDev: stdDev,
      min: Math.min.apply(null, values),
      max: Math.max.apply(null, values)
    };
  },
  
  // Calculate control limits
  calcLimits: function(stats) {
    return {
      ucl: stats.mean + (3 * stats.stdDev),
      uwl: stats.mean + (2 * stats.stdDev),
      cl: stats.mean,
      lwl: stats.mean - (2 * stats.stdDev),
      lcl: stats.mean - (3 * stats.stdDev)
    };
  },
  
  // Calculate Cp and Cpk
  calcCapability: function(stats, param) {
    var config = this.params[param];
    var cp = (config.usl - config.lsl) / (6 * stats.stdDev);
    var cpupper = (config.usl - stats.mean) / (3 * stats.stdDev);
    var cplower = (stats.mean - config.lsl) / (3 * stats.stdDev);
    var cpk = Math.min(cpupper, cplower);
    return { cp: cp, cpk: cpk };
  },
  
  // Check Western Electric Rules
  checkRules: function(data, limits) {
    var values = data.map(function(d) { return d.value; });
    var results = { rule1: [], rule2: [], rule3: [], rule4: [] };
    var sigma = (limits.ucl - limits.cl) / 3;
    
    for (var i = 0; i < values.length; i++) {
      // Rule 1: Beyond 3œÉ
      if (values[i] > limits.ucl || values[i] < limits.lcl) {
        results.rule1.push(i);
      }
      
      // Rule 2: 2 of 3 beyond 2œÉ (same side)
      if (i >= 2) {
        var above2s = 0, below2s = 0;
        for (var j = i - 2; j <= i; j++) {
          if (values[j] > limits.uwl) above2s++;
          if (values[j] < limits.lwl) below2s++;
        }
        if (above2s >= 2 || below2s >= 2) results.rule2.push(i);
      }
      
      // Rule 3: 4 of 5 beyond 1œÉ (same side)
      if (i >= 4) {
        var above1s = 0, below1s = 0;
        var uwl1 = limits.cl + sigma;
        var lwl1 = limits.cl - sigma;
        for (var j = i - 4; j <= i; j++) {
          if (values[j] > uwl1) above1s++;
          if (values[j] < lwl1) below1s++;
        }
        if (above1s >= 4 || below1s >= 4) results.rule3.push(i);
      }
      
      // Rule 4: 8 consecutive same side of CL
      if (i >= 7) {
        var aboveCL = 0, belowCL = 0;
        for (var j = i - 7; j <= i; j++) {
          if (values[j] > limits.cl) aboveCL++;
          if (values[j] < limits.cl) belowCL++;
        }
        if (aboveCL === 8 || belowCL === 8) results.rule4.push(i);
      }
    }
    
    return results;
  },
  
  // Show chart for parameter
  showChart: function(param) {
    this.currentParam = param;
    var config = this.params[param];
    
    // Update button states
    document.querySelectorAll('.spc-param-btn').forEach(function(btn) {
      btn.style.background = 'transparent';
      btn.style.color = '#06b6d4';
    });
    var activeBtn = document.getElementById('spc-btn-' + param);
    if (activeBtn) {
      activeBtn.style.background = '#06b6d4';
      activeBtn.style.color = 'white';
    }
    
    // Update title
    document.getElementById('spcChartTitle').textContent = 'üìä ' + config.name + ' Control Chart';
    
    // Get data and calculate
    var data = this.getData(param);
    this.renderChart(data, param);
    this.updateStats(data, param);
  },
  
  // Render the control chart
  renderChart: function(data, param) {
    var config = this.params[param];
    var canvas = document.getElementById('spcChartCanvas');
    var ctx = canvas.getContext('2d');
    
    // Destroy existing chart
    if (this.chart) {
      this.chart.destroy();
    }
    
    // Prepare data
    var values = data.map(function(d) { return d.value; });
    var labels = data.map(function(d, i) { return d.date || ('Point ' + (i + 1)); });
    
    // Calculate limits
    var stats = this.calcStats(values);
    var limits = this.calcLimits(stats);
    
    // Check rules to color points
    var ruleResults = this.checkRules(data, limits);
    var oocIndices = new Set();
    Object.values(ruleResults).forEach(function(arr) {
      arr.forEach(function(idx) { oocIndices.add(idx); });
    });
    
    var pointColors = values.map(function(v, i) {
      if (oocIndices.has(i)) return '#ef4444';
      if (v > limits.uwl || v < limits.lwl) return '#f59e0b';
      return '#22c55e';
    });
    
    // Create chart
    this.chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: config.name,
            data: values,
            borderColor: '#22d3ee',
            backgroundColor: 'rgba(34, 211, 238, 0.1)',
            borderWidth: 2,
            pointBackgroundColor: pointColors,
            pointBorderColor: pointColors,
            pointRadius: 6,
            pointHoverRadius: 8,
            fill: false,
            tension: 0.1
          },
          {
            label: 'UCL',
            data: Array(values.length).fill(limits.ucl),
            borderColor: '#ef4444',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false
          },
          {
            label: 'UWL',
            data: Array(values.length).fill(limits.uwl),
            borderColor: '#f59e0b',
            borderWidth: 1,
            borderDash: [3, 3],
            pointRadius: 0,
            fill: false
          },
          {
            label: 'CL',
            data: Array(values.length).fill(limits.cl),
            borderColor: '#22c55e',
            borderWidth: 2,
            pointRadius: 0,
            fill: false
          },
          {
            label: 'LWL',
            data: Array(values.length).fill(limits.lwl),
            borderColor: '#f59e0b',
            borderWidth: 1,
            borderDash: [3, 3],
            pointRadius: 0,
            fill: false
          },
          {
            label: 'LCL',
            data: Array(values.length).fill(limits.lcl),
            borderColor: '#ef4444',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: { color: '#94a3b8', font: { size: 11 } }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                if (context.datasetIndex === 0) {
                  return config.name + ': ' + context.parsed.y.toFixed(config.decimals) + ' ' + config.unit;
                }
                return context.dataset.label + ': ' + context.parsed.y.toFixed(config.decimals);
              }
            }
          }
        },
        scales: {
          x: {
            grid: { color: '#1e293b' },
            ticks: { color: '#64748b', maxRotation: 45 }
          },
          y: {
            grid: { color: '#1e293b' },
            ticks: { color: '#64748b' }
          }
        }
      }
    });
  },
  
  // Update statistics display
  updateStats: function(data, param) {
    var config = this.params[param];
    var values = data.map(function(d) { return d.value; });
    var stats = this.calcStats(values);
    var limits = this.calcLimits(stats);
    var capability = this.calcCapability(stats, param);
    var ruleResults = this.checkRules(data, limits);
    
    // Count OOC points
    var oocSet = new Set();
    Object.values(ruleResults).forEach(function(arr) {
      arr.forEach(function(idx) { oocSet.add(idx); });
    });
    var oocCount = oocSet.size;
    
    // Update display
    document.getElementById('spcUCL').textContent = limits.ucl.toFixed(config.decimals);
    document.getElementById('spcUWL').textContent = limits.uwl.toFixed(config.decimals);
    document.getElementById('spcCL').textContent = limits.cl.toFixed(config.decimals);
    document.getElementById('spcLWL').textContent = limits.lwl.toFixed(config.decimals);
    document.getElementById('spcLCL').textContent = limits.lcl.toFixed(config.decimals);
    document.getElementById('spcStdDev').textContent = stats.stdDev.toFixed(config.decimals);
    document.getElementById('spcDataPoints').textContent = data.length;
    document.getElementById('spcOOC').textContent = oocCount;
    document.getElementById('spcCp').textContent = isFinite(capability.cp) ? capability.cp.toFixed(2) : 'N/A';
    document.getElementById('spcCpk').textContent = isFinite(capability.cpk) ? capability.cpk.toFixed(2) : 'N/A';
    
    // Update status
    var statusEl = document.getElementById('spcStatus');
    if (oocCount > 0) {
      statusEl.textContent = '‚ö†Ô∏è Out of Control (' + oocCount + ')';
      statusEl.style.background = '#dc2626';
    } else {
      statusEl.textContent = '‚úì In Control';
      statusEl.style.background = '#059669';
    }
    
    // Update rule indicators
    document.getElementById('spcRule1').innerHTML = ruleResults.rule1.length > 0 ? 
      '<span style="color:#ef4444">‚úó FAIL (' + ruleResults.rule1.length + ' points)</span>' : 
      '<span style="color:#22c55e">‚úì Pass</span>';
    document.getElementById('spcRule2').innerHTML = ruleResults.rule2.length > 0 ? 
      '<span style="color:#ef4444">‚úó FAIL (' + ruleResults.rule2.length + ' triggers)</span>' : 
      '<span style="color:#22c55e">‚úì Pass</span>';
    document.getElementById('spcRule3').innerHTML = ruleResults.rule3.length > 0 ? 
      '<span style="color:#ef4444">‚úó FAIL (' + ruleResults.rule3.length + ' triggers)</span>' : 
      '<span style="color:#22c55e">‚úì Pass</span>';
    document.getElementById('spcRule4').innerHTML = ruleResults.rule4.length > 0 ? 
      '<span style="color:#ef4444">‚úó FAIL (' + ruleResults.rule4.length + ' triggers)</span>' : 
      '<span style="color:#22c55e">‚úì Pass</span>';
  },
  
  // Add data point
  addDataPoint: function() {
    var date = document.getElementById('spcDataDate').value;
    var time = document.getElementById('spcDataTime').value;
    var value = parseFloat(document.getElementById('spcDataValue').value);
    var notes = document.getElementById('spcDataNotes').value;
    
    if (isNaN(value)) {
      showToast('Please enter a valid value', 'error');
      return;
    }
    
    var data = this.getData(this.currentParam);
    data.push({
      date: date || new Date().toISOString().split('T')[0],
      time: time || '08:00',
      value: value,
      notes: notes,
      timestamp: Date.now()
    });
    
    this.setData(this.currentParam, data);
    this.showChart(this.currentParam);
    
    // Clear inputs
    document.getElementById('spcDataValue').value = '';
    document.getElementById('spcDataNotes').value = '';
    
    showToast('Data point added successfully', 'success');
  },
  
  // Generate sample data
  generateSampleData: function() {
    var config = this.params[this.currentParam];
    var data = [];
    var baseValue = config.target;
    var variation = (config.usl - config.lsl) / 10;
    
    for (var i = 0; i < 30; i++) {
      var date = new Date();
      date.setDate(date.getDate() - (29 - i));
      
      // Normal variation with occasional outliers
      var value = baseValue + (Math.random() - 0.5) * variation * 2;
      
      // Add some trend for realism
      if (i > 20) value += variation * 0.3;
      
      // Occasional outlier
      if (i === 15) value = baseValue + variation * 2.5;
      
      data.push({
        date: date.toISOString().split('T')[0],
        time: '08:00',
        value: Math.round(value * 100) / 100,
        notes: '',
        timestamp: date.getTime()
      });
    }
    
    this.setData(this.currentParam, data);
    this.showChart(this.currentParam);
    showToast('Sample data generated for ' + config.name, 'success');
  },
  
  // Clear data
  clearData: function() {
    if (confirm('Clear all ' + this.params[this.currentParam].name + ' data?')) {
      this.setData(this.currentParam, []);
      this.showChart(this.currentParam);
      showToast('Data cleared', 'success');
    }
  },
  
  // Export data
  exportData: function() {
    var data = this.getData(this.currentParam);
    var config = this.params[this.currentParam];
    
    var csv = 'Date,Time,Value (' + config.unit + '),Notes\n';
    data.forEach(function(d) {
      csv += d.date + ',' + d.time + ',' + d.value + ',"' + (d.notes || '') + '"\n';
    });
    
    var blob = new Blob([csv], { type: 'text/csv' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'SPC_' + config.name + '_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    URL.revokeObjectURL(url);
    showToast('SPC data exported', 'success');
  },
  
  // Initialize on page load
  init: function() {
    // Set today's date
    var today = new Date().toISOString().split('T')[0];
    var dateInput = document.getElementById('spcDataDate');
    if (dateInput) dateInput.value = today;
    
    // Load default chart
    this.showChart('do');
  }
};

// Initialize SPC Charts when page loads
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    SPCCharts.init();
  }, 1000);
});

// ==================== EQUIPMENT PM TRACKER v9.9.16 ====================
var EquipmentPM = {
  currentFilter: 'all',
  editingId: null,
  
  // Interval days mapping
  intervals: {
    weekly: 7,
    biweekly: 14,
    monthly: 30,
    quarterly: 90,
    semi_annual: 180,
    annual: 365,
    runtime: 0  // Uses runtime hours instead
  },
  
  // Category icons
  categoryIcons: {
    blowers: 'üåÄ',
    pumps: 'üîÑ',
    clarifiers: 'üîµ',
    uv: 'üí°',
    chemical: '‚öóÔ∏è',
    solids: 'üóëÔ∏è',
    electrical: '‚ö°',
    instrumentation: 'üì°',
    other: 'üîß'
  },
  
  // Get equipment data from localStorage
  getData: function() {
    var data = localStorage.getItem('equipment_pm_data');
    return data ? JSON.parse(data) : [];
  },
  
  // Save equipment data
  setData: function(data) {
    localStorage.setItem('equipment_pm_data', JSON.stringify(data));
  },
  
  // Get maintenance history
  getHistory: function() {
    var data = localStorage.getItem('pm_history_data');
    return data ? JSON.parse(data) : [];
  },
  
  // Save maintenance history
  setHistory: function(data) {
    localStorage.setItem('pm_history_data', JSON.stringify(data));
  },
  
  // Calculate next due date
  calcNextDue: function(equipment) {
    if (equipment.interval === 'runtime') {
      // Runtime-based: check hours since last PM
      var hoursSincePM = equipment.currentRuntime - equipment.lastPMRuntime;
      var hoursRemaining = equipment.runtimeInterval - hoursSincePM;
      return { type: 'runtime', hoursRemaining: hoursRemaining };
    } else {
      // Time-based
      var lastDate = new Date(equipment.lastPMDate);
      var intervalDays = this.intervals[equipment.interval];
      var nextDate = new Date(lastDate);
      nextDate.setDate(nextDate.getDate() + intervalDays);
      var today = new Date();
      today.setHours(0, 0, 0, 0);
      var daysRemaining = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
      return { type: 'date', nextDate: nextDate, daysRemaining: daysRemaining };
    }
  },
  
  // Get status based on due calculation
  getStatus: function(equipment) {
    var due = this.calcNextDue(equipment);
    if (due.type === 'runtime') {
      if (due.hoursRemaining <= 0) return 'overdue';
      if (due.hoursRemaining <= equipment.runtimeInterval * 0.1) return 'due_soon';
      return 'ok';
    } else {
      if (due.daysRemaining < 0) return 'overdue';
      if (due.daysRemaining <= 7) return 'due_soon';
      return 'ok';
    }
  },
  
  // Render equipment table
  renderTable: function() {
    var equipment = this.getData();
    var tbody = document.getElementById('equipmentPMBody');
    var self = this;
    
    // Filter equipment
    var filtered = equipment.filter(function(eq) {
      if (self.currentFilter === 'all') return true;
      if (self.currentFilter === 'overdue') return self.getStatus(eq) === 'overdue';
      if (self.currentFilter === 'due_soon') return self.getStatus(eq) === 'due_soon';
      return eq.category === self.currentFilter;
    });
    
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:30px;color:#64748b">' +
        '<span style="font-size:32px">üîß</span><br>No equipment found. Click "Add Equipment" to get started.</td></tr>';
      this.updateKPIs(equipment);
      return;
    }
    
    var html = '';
    filtered.forEach(function(eq) {
      var status = self.getStatus(eq);
      var due = self.calcNextDue(eq);
      var icon = self.categoryIcons[eq.category] || 'üîß';
      
      var statusClass = status === 'overdue' ? 'bad' : (status === 'due_soon' ? 'warn' : 'good');
      var statusText = status === 'overdue' ? 'OVERDUE' : (status === 'due_soon' ? 'Due Soon' : 'OK');
      
      var dueDisplay = '';
      if (due.type === 'runtime') {
        dueDisplay = due.hoursRemaining <= 0 ? 
          '<span style="color:#ef4444">' + Math.abs(due.hoursRemaining) + ' hrs over</span>' :
          due.hoursRemaining + ' hrs';
      } else {
        dueDisplay = due.daysRemaining < 0 ?
          '<span style="color:#ef4444">' + Math.abs(due.daysRemaining) + ' days over</span>' :
          due.nextDate.toLocaleDateString();
      }
      
      html += '<tr style="border-bottom:1px solid #334155">' +
        '<td style="padding:12px"><strong>' + icon + ' ' + eq.name + '</strong>' +
        (eq.location ? '<br><span style="font-size:11px;color:#64748b">üìç ' + eq.location + '</span>' : '') + '</td>' +
        '<td style="padding:12px;text-align:center">' + eq.category + '</td>' +
        '<td style="padding:12px;text-align:center;font-family:monospace">' + eq.currentRuntime.toLocaleString() + '</td>' +
        '<td style="padding:12px;text-align:center">' + eq.lastPMDate + '</td>' +
        '<td style="padding:12px;text-align:center">' + eq.interval + (eq.interval === 'runtime' ? ' (' + eq.runtimeInterval + ' hrs)' : '') + '</td>' +
        '<td style="padding:12px;text-align:center">' + dueDisplay + '</td>' +
        '<td style="padding:12px;text-align:center"><span class="status ' + statusClass + '">' + statusText + '</span></td>' +
        '<td style="padding:12px;text-align:center">' +
        '<button onclick="EquipmentPM.completePM(\'' + eq.id + '\')" style="background:#22c55e;border:none;color:white;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px;margin:2px" title="Record PM">‚úÖ</button>' +
        '<button onclick="EquipmentPM.editEquipment(\'' + eq.id + '\')" style="background:#3b82f6;border:none;color:white;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px;margin:2px" title="Edit">‚úèÔ∏è</button>' +
        '<button onclick="EquipmentPM.deleteEquipment(\'' + eq.id + '\')" style="background:#ef4444;border:none;color:white;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px;margin:2px" title="Delete">üóëÔ∏è</button>' +
        '</td></tr>';
    });
    
    tbody.innerHTML = html;
    this.updateKPIs(equipment);
    this.renderHistory();
  },
  
  // Update KPI cards
  updateKPIs: function(equipment) {
    var self = this;
    var overdue = 0, dueSoon = 0, ok = 0;
    
    equipment.forEach(function(eq) {
      var status = self.getStatus(eq);
      if (status === 'overdue') overdue++;
      else if (status === 'due_soon') dueSoon++;
      else ok++;
    });
    
    document.getElementById('pm_overdue').textContent = overdue;
    document.getElementById('pm_due_soon').textContent = dueSoon;
    document.getElementById('pm_ok').textContent = ok;
    
    // Calculate YTD cost from history
    var history = this.getHistory();
    var ytdCost = 0;
    var currentYear = new Date().getFullYear();
    history.forEach(function(h) {
      if (new Date(h.date).getFullYear() === currentYear) {
        ytdCost += (h.partsCost || 0);
      }
    });
    document.getElementById('pm_ytd_cost').textContent = '$' + ytdCost.toLocaleString();
  },
  
  // Render maintenance history
  renderHistory: function() {
    var history = this.getHistory();
    var container = document.getElementById('pmHistoryList');
    
    if (history.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:30px;color:#64748b">' +
        '<span style="font-size:32px">üìã</span><br>No maintenance history yet</div>';
      return;
    }
    
    // Sort by date descending and take last 10
    history.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
    var recent = history.slice(0, 10);
    
    var html = '';
    recent.forEach(function(h) {
      var conditionColor = h.condition === 'good' ? '#22c55e' : 
        (h.condition === 'fair' ? '#f59e0b' : '#ef4444');
      html += '<div style="background:#1e293b;padding:12px;border-radius:8px;margin-bottom:8px;border-left:4px solid ' + conditionColor + '">' +
        '<div style="display:flex;justify-content:space-between;align-items:center">' +
        '<strong style="color:#e2e8f0">' + h.equipmentName + '</strong>' +
        '<span style="font-size:12px;color:#64748b">' + h.date + '</span>' +
        '</div>' +
        '<div style="font-size:13px;color:#94a3b8;margin-top:6px">' + (h.workPerformed || 'PM completed') + '</div>' +
        '<div style="font-size:11px;color:#64748b;margin-top:4px">' +
        'üë§ ' + (h.performedBy || 'N/A') + ' | ‚è±Ô∏è ' + (h.laborHours || 0) + ' hrs | üí∞ $' + (h.partsCost || 0) +
        '</div></div>';
    });
    
    container.innerHTML = html;
  },
  
  // Filter equipment
  filterEquipment: function(filter) {
    this.currentFilter = filter;
    
    // Update button styles
    document.querySelectorAll('.pm-filter-btn').forEach(function(btn) {
      btn.style.background = 'transparent';
      btn.style.color = '#a855f7';
    });
    var activeBtn = document.getElementById('pm-filter-' + filter);
    if (activeBtn) {
      activeBtn.style.background = '#a855f7';
      activeBtn.style.color = 'white';
    }
    
    this.renderTable();
  },
  
  // Show add equipment form
  showAddForm: function() {
    this.editingId = null;
    document.getElementById('pmFormTitle').textContent = '‚ûï Add Equipment';
    document.getElementById('pmFormContainer').style.display = 'block';
    document.getElementById('pm_name').value = '';
    document.getElementById('pm_category').value = 'blowers';
    document.getElementById('pm_location').value = '';
    document.getElementById('pm_interval').value = 'monthly';
    document.getElementById('pm_runtime_interval').value = '';
    document.getElementById('pm_current_runtime').value = '0';
    document.getElementById('pm_last_date').value = new Date().toISOString().split('T')[0];
    document.getElementById('pm_last_runtime').value = '0';
    document.getElementById('pm_install_date').value = '';
    document.getElementById('pm_model').value = '';
    document.getElementById('pm_manufacturer').value = '';
    document.getElementById('pm_replacement_cost').value = '';
    document.getElementById('pm_tasks').value = '';
    document.getElementById('pm_notes').value = '';
  },
  
  // Hide form
  hideForm: function() {
    document.getElementById('pmFormContainer').style.display = 'none';
    this.editingId = null;
  },
  
  // Save equipment
  saveEquipment: function() {
    var name = document.getElementById('pm_name').value.trim();
    if (!name) {
      showToast('Please enter equipment name', 'error');
      return;
    }
    
    var equipment = this.getData();
    var newEquip = {
      id: this.editingId || 'eq_' + Date.now(),
      name: name,
      category: document.getElementById('pm_category').value,
      location: document.getElementById('pm_location').value,
      interval: document.getElementById('pm_interval').value,
      runtimeInterval: parseFloat(document.getElementById('pm_runtime_interval').value) || 2000,
      currentRuntime: parseFloat(document.getElementById('pm_current_runtime').value) || 0,
      lastPMDate: document.getElementById('pm_last_date').value,
      lastPMRuntime: parseFloat(document.getElementById('pm_last_runtime').value) || 0,
      installDate: document.getElementById('pm_install_date').value,
      model: document.getElementById('pm_model').value,
      manufacturer: document.getElementById('pm_manufacturer').value,
      replacementCost: parseFloat(document.getElementById('pm_replacement_cost').value) || 0,
      tasks: document.getElementById('pm_tasks').value,
      notes: document.getElementById('pm_notes').value
    };
    
    if (this.editingId) {
      // Update existing
      var index = equipment.findIndex(function(e) { return e.id === newEquip.id; });
      if (index !== -1) equipment[index] = newEquip;
    } else {
      // Add new
      equipment.push(newEquip);
    }
    
    this.setData(equipment);
    this.hideForm();
    this.renderTable();
    showToast('Equipment saved successfully', 'success');
  },
  
  // Edit equipment
  editEquipment: function(id) {
    var equipment = this.getData();
    var eq = equipment.find(function(e) { return e.id === id; });
    if (!eq) return;
    
    this.editingId = id;
    document.getElementById('pmFormTitle').textContent = '‚úèÔ∏è Edit Equipment';
    document.getElementById('pmFormContainer').style.display = 'block';
    document.getElementById('pm_name').value = eq.name;
    document.getElementById('pm_category').value = eq.category;
    document.getElementById('pm_location').value = eq.location || '';
    document.getElementById('pm_interval').value = eq.interval;
    document.getElementById('pm_runtime_interval').value = eq.runtimeInterval || '';
    document.getElementById('pm_current_runtime').value = eq.currentRuntime || 0;
    document.getElementById('pm_last_date').value = eq.lastPMDate;
    document.getElementById('pm_last_runtime').value = eq.lastPMRuntime || 0;
    document.getElementById('pm_install_date').value = eq.installDate || '';
    document.getElementById('pm_model').value = eq.model || '';
    document.getElementById('pm_manufacturer').value = eq.manufacturer || '';
    document.getElementById('pm_replacement_cost').value = eq.replacementCost || '';
    document.getElementById('pm_tasks').value = eq.tasks || '';
    document.getElementById('pm_notes').value = eq.notes || '';
  },
  
  // Delete equipment
  deleteEquipment: function(id) {
    if (!confirm('Delete this equipment? This cannot be undone.')) return;
    
    var equipment = this.getData();
    equipment = equipment.filter(function(e) { return e.id !== id; });
    this.setData(equipment);
    this.renderTable();
    showToast('Equipment deleted', 'success');
  },
  
  // Show complete PM form
  completePM: function(id) {
    var equipment = this.getData();
    var eq = equipment.find(function(e) { return e.id === id; });
    if (!eq) return;
    
    document.getElementById('pm_complete_id').value = id;
    document.getElementById('pm_complete_equipment').value = eq.name;
    document.getElementById('pm_complete_date').value = new Date().toISOString().split('T')[0];
    document.getElementById('pm_complete_runtime').value = eq.currentRuntime;
    document.getElementById('pm_complete_by').value = '';
    document.getElementById('pm_complete_labor').value = '1';
    document.getElementById('pm_complete_parts').value = '0';
    document.getElementById('pm_complete_work').value = eq.tasks || '';
    document.getElementById('pm_complete_condition').value = 'good';
    document.getElementById('pmCompleteFormContainer').style.display = 'block';
  },
  
  // Hide PM complete form
  hidePMCompleteForm: function() {
    document.getElementById('pmCompleteFormContainer').style.display = 'none';
  },
  
  // Save PM completion
  savePMCompletion: function() {
    var id = document.getElementById('pm_complete_id').value;
    var equipment = this.getData();
    var eqIndex = equipment.findIndex(function(e) { return e.id === id; });
    if (eqIndex === -1) return;
    
    var completionDate = document.getElementById('pm_complete_date').value;
    var completionRuntime = parseFloat(document.getElementById('pm_complete_runtime').value) || 0;
    
    // Update equipment record
    equipment[eqIndex].lastPMDate = completionDate;
    equipment[eqIndex].lastPMRuntime = completionRuntime;
    this.setData(equipment);
    
    // Add to history
    var history = this.getHistory();
    history.push({
      id: 'pm_' + Date.now(),
      equipmentId: id,
      equipmentName: equipment[eqIndex].name,
      date: completionDate,
      runtime: completionRuntime,
      performedBy: document.getElementById('pm_complete_by').value,
      laborHours: parseFloat(document.getElementById('pm_complete_labor').value) || 0,
      partsCost: parseFloat(document.getElementById('pm_complete_parts').value) || 0,
      workPerformed: document.getElementById('pm_complete_work').value,
      condition: document.getElementById('pm_complete_condition').value
    });
    this.setHistory(history);
    
    this.hidePMCompleteForm();
    this.renderTable();
    showToast('PM recorded successfully!', 'success');
  },
  
  // Log runtime form
  logRuntime: function() {
    var equipment = this.getData();
    var select = document.getElementById('runtime_equipment');
    select.innerHTML = '<option value="">-- Select Equipment --</option>';
    equipment.forEach(function(eq) {
      select.innerHTML += '<option value="' + eq.id + '">' + eq.name + ' (' + eq.currentRuntime + ' hrs)</option>';
    });
    document.getElementById('runtime_date').value = new Date().toISOString().split('T')[0];
    document.getElementById('runtime_hours').value = '24';
    document.getElementById('runtimeFormContainer').style.display = 'block';
  },
  
  // Hide runtime form
  hideRuntimeForm: function() {
    document.getElementById('runtimeFormContainer').style.display = 'none';
  },
  
  // Save runtime
  saveRuntime: function() {
    var id = document.getElementById('runtime_equipment').value;
    var hours = parseFloat(document.getElementById('runtime_hours').value) || 0;
    
    if (!id) {
      showToast('Please select equipment', 'error');
      return;
    }
    
    var equipment = this.getData();
    var eqIndex = equipment.findIndex(function(e) { return e.id === id; });
    if (eqIndex === -1) return;
    
    equipment[eqIndex].currentRuntime += hours;
    this.setData(equipment);
    this.hideRuntimeForm();
    this.renderTable();
    showToast('Runtime logged: +' + hours + ' hours', 'success');
  },
  
  // Export report
  exportReport: function() {
    var equipment = this.getData();
    var self = this;
    
    var csv = 'Equipment PM Report - Generated ' + new Date().toLocaleString() + '\n\n';
    csv += 'Equipment,Category,Location,Runtime (hrs),Last PM,Interval,Next Due,Status\n';
    
    equipment.forEach(function(eq) {
      var status = self.getStatus(eq);
      var due = self.calcNextDue(eq);
      var dueStr = due.type === 'runtime' ? (due.hoursRemaining + ' hrs') : due.nextDate.toLocaleDateString();
      csv += '"' + eq.name + '",' + eq.category + ',"' + (eq.location || '') + '",' +
        eq.currentRuntime + ',' + eq.lastPMDate + ',' + eq.interval + ',' + dueStr + ',' + status + '\n';
    });
    
    var blob = new Blob([csv], { type: 'text/csv' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'Equipment_PM_Report_' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    URL.revokeObjectURL(url);
    showToast('PM report exported', 'success');
  },
  
  // Show maintenance calendar (modal)
  showMaintenanceCalendar: function() {
    var equipment = this.getData();
    var self = this;
    
    // Build calendar view for next 30 days
    var html = '<div style="max-height:70vh;overflow-y:auto">';
    html += '<h4 style="color:#a855f7;margin:0 0 15px 0">üìÖ Upcoming PM Schedule (Next 30 Days)</h4>';
    
    var upcoming = [];
    equipment.forEach(function(eq) {
      var due = self.calcNextDue(eq);
      if (due.type === 'date' && due.daysRemaining <= 30) {
        upcoming.push({ equipment: eq, due: due });
      } else if (due.type === 'runtime' && due.hoursRemaining <= eq.runtimeInterval * 0.2) {
        upcoming.push({ equipment: eq, due: due });
      }
    });
    
    upcoming.sort(function(a, b) {
      if (a.due.type === 'date' && b.due.type === 'date') {
        return a.due.daysRemaining - b.due.daysRemaining;
      }
      return a.due.hoursRemaining - b.due.hoursRemaining;
    });
    
    if (upcoming.length === 0) {
      html += '<div style="text-align:center;padding:30px;color:#64748b">‚úÖ No PM due in the next 30 days!</div>';
    } else {
      upcoming.forEach(function(item) {
        var status = self.getStatus(item.equipment);
        var color = status === 'overdue' ? '#ef4444' : (status === 'due_soon' ? '#f59e0b' : '#22c55e');
        var icon = self.categoryIcons[item.equipment.category] || 'üîß';
        
        html += '<div style="background:#1e293b;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid ' + color + '">' +
          '<div style="display:flex;justify-content:space-between;align-items:center">' +
          '<strong>' + icon + ' ' + item.equipment.name + '</strong>';
        
        if (item.due.type === 'date') {
          html += '<span style="color:' + color + '">' + 
            (item.due.daysRemaining < 0 ? Math.abs(item.due.daysRemaining) + ' days overdue' : 
            (item.due.daysRemaining === 0 ? 'Due TODAY' : item.due.daysRemaining + ' days')) + '</span>';
        } else {
          html += '<span style="color:' + color + '">' + item.due.hoursRemaining + ' hrs remaining</span>';
        }
        
        html += '</div>';
        if (item.equipment.tasks) {
          html += '<div style="font-size:12px;color:#94a3b8;margin-top:8px">' + item.equipment.tasks.split('\n').slice(0,2).join(', ') + '</div>';
        }
        html += '</div>';
      });
    }
    
    html += '</div>';
    showModal('üìÖ PM Calendar', html);
  },
  
  // Show full history
  showFullHistory: function() {
    var history = this.getHistory();
    history.sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
    
    var html = '<div style="max-height:70vh;overflow-y:auto">';
    
    if (history.length === 0) {
      html += '<div style="text-align:center;padding:30px;color:#64748b">No maintenance history yet</div>';
    } else {
      history.forEach(function(h) {
        var conditionColor = h.condition === 'good' ? '#22c55e' : 
          (h.condition === 'fair' ? '#f59e0b' : '#ef4444');
        html += '<div style="background:#1e293b;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid ' + conditionColor + '">' +
          '<div style="display:flex;justify-content:space-between;align-items:center">' +
          '<strong style="color:#e2e8f0">' + h.equipmentName + '</strong>' +
          '<span style="font-size:12px;color:#64748b">' + h.date + '</span>' +
          '</div>' +
          '<div style="font-size:13px;color:#94a3b8;margin-top:6px">' + (h.workPerformed || 'PM completed') + '</div>' +
          '<div style="font-size:11px;color:#64748b;margin-top:4px">' +
          'üë§ ' + (h.performedBy || 'N/A') + ' | ‚è±Ô∏è ' + (h.laborHours || 0) + ' hrs | üí∞ $' + (h.partsCost || 0) + ' | Runtime: ' + (h.runtime || 0) + ' hrs' +
          '</div></div>';
      });
    }
    
    html += '</div>';
    showModal('üìú Full Maintenance History', html);
  },
  
  // Generate sample data
  generateSampleData: function() {
    var sampleEquipment = [
      { id: 'eq_1', name: 'Blower #1', category: 'blowers', location: 'Blower Building', interval: 'monthly', runtimeInterval: 2000, currentRuntime: 12450, lastPMDate: '2024-11-15', lastPMRuntime: 12200, manufacturer: 'Aerzen', model: 'GM 25S', replacementCost: 45000, tasks: 'Check belt tension\nGrease bearings\nCheck oil level\nInspect inlet filter' },
      { id: 'eq_2', name: 'Blower #2', category: 'blowers', location: 'Blower Building', interval: 'monthly', runtimeInterval: 2000, currentRuntime: 11800, lastPMDate: '2024-11-20', lastPMRuntime: 11600, manufacturer: 'Aerzen', model: 'GM 25S', replacementCost: 45000, tasks: 'Check belt tension\nGrease bearings\nCheck oil level\nInspect inlet filter' },
      { id: 'eq_3', name: 'RAS Pump #1', category: 'pumps', location: 'Clarifier #1', interval: 'quarterly', runtimeInterval: 4000, currentRuntime: 8200, lastPMDate: '2024-10-01', lastPMRuntime: 7800, manufacturer: 'Gorman-Rupp', model: 'T6A60-B', replacementCost: 18000, tasks: 'Check packing/seals\nInspect impeller\nGrease bearings\nCheck vibration' },
      { id: 'eq_4', name: 'RAS Pump #2', category: 'pumps', location: 'Clarifier #2', interval: 'quarterly', runtimeInterval: 4000, currentRuntime: 7950, lastPMDate: '2024-10-15', lastPMRuntime: 7600, manufacturer: 'Gorman-Rupp', model: 'T6A60-B', replacementCost: 18000, tasks: 'Check packing/seals\nInspect impeller\nGrease bearings\nCheck vibration' },
      { id: 'eq_5', name: 'Clarifier #1 Drive', category: 'clarifiers', location: 'Secondary Clarifier', interval: 'semi_annual', runtimeInterval: 8000, currentRuntime: 24500, lastPMDate: '2024-09-01', lastPMRuntime: 23800, manufacturer: 'Walker Process', model: '?"', replacementCost: 35000, tasks: 'Check gear oil\nInspect drive chain\nCheck torque settings\nInspect rake arms' },
      { id: 'eq_6', name: 'UV System Bank A', category: 'uv', location: 'UV Building', interval: 'monthly', runtimeInterval: 1000, currentRuntime: 5600, lastPMDate: '2024-11-01', lastPMRuntime: 5400, manufacturer: 'Trojan', model: 'UV3000+', replacementCost: 85000, tasks: 'Clean quartz sleeves\nCheck lamp intensity\nInspect wipers\nVerify UVT readings' },
      { id: 'eq_7', name: 'Influent Pump #1', category: 'pumps', location: 'Headworks', interval: 'monthly', runtimeInterval: 2000, currentRuntime: 15200, lastPMDate: '2024-12-01', lastPMRuntime: 15000, manufacturer: 'Flygt', model: 'NP 3153', replacementCost: 28000, tasks: 'Check seals\nInspect impeller\nMeg motor\nCheck cable' }
    ];
    
    this.setData(sampleEquipment);
    this.renderTable();
    showToast('Sample equipment data loaded', 'success');
  },
  
  // Initialize
  init: function() {
    this.renderTable();
    
    // Set today's date on forms
    var today = new Date().toISOString().split('T')[0];
    var dateInputs = ['pm_last_date', 'runtime_date', 'pm_complete_date'];
    dateInputs.forEach(function(id) {
      var el = document.getElementById(id);
      if (el) el.value = today;
    });
  }
};

// Initialize Equipment PM when page loads
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    EquipmentPM.init();
  }, 1200);
});

// ==================== WHAT-IF SCENARIO SIMULATOR ====================
var whatIfScenarios = {
  flow_increase: {
    title: 'üìà Flow Increase (+25%)',
    description: 'Simulating 25% increase in influent flow rate',
    impacts: {
      hrt: { value: -20, unit: '%', label: 'HRT', status: 'warning' },
      sor: { value: +25, unit: '%', label: 'SOR', status: 'warning' },
      slr: { value: +25, unit: '%', label: 'SLR', status: 'warning' },
      fm: { value: +25, unit: '%', label: 'F/M', status: 'caution' },
      effluent: { value: +15, unit: '%', label: 'Eff TSS Risk', status: 'warning' }
    },
    analysis: [
      'Hydraulic Retention Time decreases from ~6 hrs to ~4.8 hrs',
      'Secondary clarifier surface overflow rate increases significantly',
      'Solids loading rate approaches design limits',
      'F/M ratio increases - may see improved BOD removal short-term',
      'Risk of solids washout increases if sustained'
    ],
    actions: [
      'Bring additional clarifier online if available',
      'Increase RAS rate to maintain blanket depth',
      'Monitor effluent TSS closely - sample every 2 hours',
      'Reduce WAS temporarily to build MLSS inventory',
      'Increase blower output to maintain DO > 2.0 mg/L'
    ]
  },
  storm_event: {
    title: 'üåßÔ∏è Storm Event (2x Peak Flow)',
    description: 'Simulating wet weather with double normal flow',
    impacts: {
      hrt: { value: -50, unit: '%', label: 'HRT', status: 'danger' },
      sor: { value: +100, unit: '%', label: 'SOR', status: 'danger' },
      mlss: { value: -30, unit: '%', label: 'MLSS Dilution', status: 'warning' },
      do: { value: -25, unit: '%', label: 'DO', status: 'warning' },
      effluent: { value: +40, unit: '%', label: 'Eff TSS Risk', status: 'danger' }
    },
    analysis: [
      'CRITICAL: Flow exceeds design capacity',
      'Clarifier SOR likely exceeds 1200 gpd/ft¬≤ - high washout risk',
      'Mixed liquor dilution reduces treatment efficiency',
      'I&I may introduce grit and debris',
      'Blending or bypass may be required'
    ],
    actions: [
      'Activate wet weather protocol immediately',
      'Open all available clarifiers',
      'Maximize RAS pumping to both clarifiers',
      'Stop WAS completely during peak',
      'Document all actions for regulatory reporting',
      'Monitor for CSO/SSO conditions'
    ]
  },
  blower_failure: {
    title: 'üåÄ Blower Failure (-33% Capacity)',
    description: 'Simulating loss of one blower from a 3-blower system',
    impacts: {
      do: { value: -40, unit: '%', label: 'DO', status: 'danger' },
      nitrification: { value: -60, unit: '%', label: 'Nitrification', status: 'danger' },
      energy: { value: +20, unit: '%', label: 'kW/unit', status: 'caution' },
      effluent: { value: +50, unit: '%', label: 'Eff NH3 Risk', status: 'danger' }
    },
    analysis: [
      'Aeration capacity reduced by 1/3',
      'DO will drop below 1.0 mg/L - nitrification stops',
      'Remaining blowers running at maximum - risk of overheating',
      'Ammonia breakthrough expected within 4-6 hours',
      'Filamentous growth may be triggered if sustained'
    ],
    actions: [
      'Start standby blower immediately',
      'Reduce organic loading if possible (hold septage)',
      'Increase WAS to reduce oxygen demand',
      'Monitor DO continuously - target minimum 1.5 mg/L',
      'Contact maintenance for emergency repair',
      'Notify permit authority if > 24 hours'
    ]
  },
  clarifier_offline: {
    title: 'üîß Clarifier Offline (1 Unit Down)',
    description: 'Simulating maintenance on one of two clarifiers',
    impacts: {
      sor: { value: +100, unit: '%', label: 'SOR', status: 'danger' },
      slr: { value: +100, unit: '%', label: 'SLR', status: 'danger' },
      blanket: { value: +50, unit: '%', label: 'Blanket Depth', status: 'warning' },
      effluent: { value: +35, unit: '%', label: 'Eff TSS Risk', status: 'warning' }
    },
    analysis: [
      'Remaining clarifier receives 100% of flow',
      'Surface overflow rate doubles - critical threshold',
      'Solids loading may exceed 35 lb/ft¬≤/day',
      'Sludge blanket will rise - monitor frequently',
      'Extended maintenance should be scheduled for low-flow periods'
    ],
    actions: [
      'Reduce influent flow if possible',
      'Lower MLSS by increasing WAS before maintenance',
      'Increase RAS rate to remaining clarifier',
      'Check blanket depth every 2 hours',
      'Limit maintenance window to 4-6 hours if possible'
    ]
  },
  high_loading: {
    title: 'üí™ High BOD Load (+50%)',
    description: 'Simulating industrial discharge or septage receiving',
    impacts: {
      fm: { value: +50, unit: '%', label: 'F/M', status: 'warning' },
      do: { value: -30, unit: '%', label: 'DO Demand', status: 'warning' },
      sludge: { value: +40, unit: '%', label: 'Sludge Prod', status: 'caution' },
      alkalinity: { value: -25, unit: '%', label: 'Alkalinity', status: 'caution' }
    },
    analysis: [
      'F/M ratio increases from 0.15 to 0.22',
      'Oxygen demand increases significantly',
      'Additional sludge production expected',
      'Alkalinity consumption increases with nitrification',
      'May see temporary BOD removal improvement'
    ],
    actions: [
      'Increase aeration to maintain DO > 2.0 mg/L',
      'Monitor alkalinity - may need supplementation',
      'Plan for increased WAS volume',
      'Sample influent to verify loading',
      'Consider holding septage if sustained'
    ]
  },
  cold_weather: {
    title: '‚ùÑÔ∏è Cold Weather (-10¬∞C)',
    description: 'Simulating winter temperature drop',
    impacts: {
      nitrification: { value: -40, unit: '%', label: 'Nitrification', status: 'warning' },
      srt: { value: +50, unit: '%', label: 'SRT Needed', status: 'caution' },
      settling: { value: +15, unit: '%', label: 'Settling', status: 'good' },
      do: { value: +10, unit: '%', label: 'DO Sat', status: 'good' }
    },
    analysis: [
      'Biological activity slows significantly',
      'Nitrification rate drops ~8% per degree C',
      'Longer SRT required to maintain nitrification',
      'DO saturation increases - good for aeration',
      'Settling typically improves in cold weather'
    ],
    actions: [
      'Reduce WAS to increase SRT to 15-20 days',
      'Target higher MLSS (3500-4000 mg/L)',
      'Monitor ammonia more frequently',
      'May be able to reduce blower speed (higher DO sat)',
      'Check for ice buildup on clarifier mechanisms'
    ]
  },
  toxic_shock: {
    title: '‚ò†Ô∏è Toxic Shock (Industrial Slug)',
    description: 'Simulating toxic industrial discharge',
    impacts: {
      biology: { value: -70, unit: '%', label: 'Biology', status: 'danger' },
      nitrification: { value: -90, unit: '%', label: 'Nitrification', status: 'danger' },
      settling: { value: -50, unit: '%', label: 'Settling', status: 'danger' },
      recovery: { value: 14, unit: 'days', label: 'Recovery', status: 'warning' }
    },
    analysis: [
      'CRITICAL: Severe biological upset',
      'Nitrifiers most sensitive - first to die',
      'May see deflocculation and pin floc',
      'Recovery time: 2-4 weeks for full nitrification',
      'Source identification critical'
    ],
    actions: [
      'Divert influent if possible',
      'Stop WAS immediately - preserve biomass',
      'Increase RAS to maintain blanket',
      'Sample influent for metals, pH, solvents',
      'Contact industrial users',
      'Document everything for enforcement',
      'Consider bioaugmentation for recovery'
    ]
  },
  power_outage: {
    title: '‚ö° Power Outage (Generator Only)',
    description: 'Simulating operation on backup power',
    impacts: {
      aeration: { value: -60, unit: '%', label: 'Aeration', status: 'danger' },
      pumping: { value: -50, unit: '%', label: 'Pumping', status: 'warning' },
      treatment: { value: -40, unit: '%', label: 'Treatment', status: 'warning' },
      duration: { value: 4, unit: 'hrs', label: 'Safe Duration', status: 'caution' }
    },
    analysis: [
      'Generator typically only powers critical equipment',
      'Limited aeration capacity available',
      'RAS pumping may be reduced',
      'DO will drop - prioritize aeration',
      'Septage/hauled waste should be held'
    ],
    actions: [
      'Verify generator is running properly',
      'Prioritize: Influent pumps > Blowers > RAS > Chlorine',
      'Reduce WAS to zero',
      'Hold all outside waste',
      'Contact utility for restoration estimate',
      'Document outage for permit reporting'
    ]
  },
  srt_change: {
    title: 'üìÖ Increase SRT (+5 days)',
    description: 'Simulating longer solids retention time',
    impacts: {
      nitrification: { value: +20, unit: '%', label: 'Nitrification', status: 'good' },
      mlss: { value: +25, unit: '%', label: 'MLSS', status: 'caution' },
      svi: { value: +15, unit: '%', label: 'SVI Risk', status: 'caution' },
      sludge: { value: -10, unit: '%', label: 'Sludge Vol', status: 'good' }
    },
    analysis: [
      'Nitrification improves with longer SRT',
      'MLSS will gradually increase',
      'More stable process, better upset recovery',
      'Risk of old sludge and filament growth',
      'Less WAS volume but more stabilized'
    ],
    actions: [
      'Reduce WAS rate by 20-25%',
      'Monitor MLSS weekly - target increase',
      'Watch SVI - treat if > 150',
      'May need to adjust RAS to handle higher MLSS',
      'Check clarifier blanket depth more frequently'
    ]
  },
  mlss_increase: {
    title: 'ü¶† Raise MLSS (+1000 mg/L)',
    description: 'Simulating increase in mixed liquor concentration',
    impacts: {
      fm: { value: -25, unit: '%', label: 'F/M', status: 'good' },
      slr: { value: +33, unit: '%', label: 'SLR', status: 'warning' },
      do_demand: { value: +25, unit: '%', label: 'O2 Demand', status: 'caution' },
      settling: { value: -10, unit: '%', label: 'Settling', status: 'caution' }
    },
    analysis: [
      'F/M ratio decreases - more conservative operation',
      'Better BOD/ammonia removal capacity',
      'Clarifier solids loading increases',
      'Oxygen demand increases proportionally',
      'Thicker blanket - monitor closely'
    ],
    actions: [
      'Reduce WAS rate to allow MLSS buildup',
      'Increase aeration to maintain DO',
      'Increase RAS rate proportionally',
      'Monitor clarifier blanket daily',
      'Gradual change over 1-2 weeks recommended'
    ]
  },
  reduce_was: {
    title: 'üöø Reduce WAS (-25%)',
    description: 'Simulating decreased wasting rate',
    impacts: {
      srt: { value: +33, unit: '%', label: 'SRT', status: 'good' },
      mlss: { value: +20, unit: '%', label: 'MLSS', status: 'caution' },
      nitrification: { value: +15, unit: '%', label: 'Nitrification', status: 'good' },
      disposal: { value: -25, unit: '%', label: 'Disposal Cost', status: 'good' }
    },
    analysis: [
      'SRT will increase over 1-2 weeks',
      'MLSS will gradually climb',
      'Nitrification should improve',
      'Less sludge to dewater/haul',
      'Watch for old sludge issues'
    ],
    actions: [
      'Reduce WAS pump runtime or speed',
      'Monitor MLSS 2-3x per week',
      'Track SRT calculation weekly',
      'Watch SVI trend',
      'Adjust after 2 weeks based on response'
    ]
  },
  increase_ras: {
    title: 'üîÑ Increase RAS (+20%)',
    description: 'Simulating higher return sludge rate',
    impacts: {
      blanket: { value: -20, unit: '%', label: 'Blanket', status: 'good' },
      hrt: { value: -8, unit: '%', label: 'Aeration HRT', status: 'caution' },
      ras_tss: { value: -15, unit: '%', label: 'RAS TSS', status: 'caution' },
      settling: { value: +10, unit: '%', label: 'Clarity', status: 'good' }
    },
    analysis: [
      'Clarifier blanket depth decreases',
      'RAS concentration will decrease (dilution)',
      'More flow returning to aeration basin',
      'Better clarifier effluent quality',
      'Slightly reduced aeration HRT'
    ],
    actions: [
      'Increase RAS pump speed or runtime',
      'Monitor blanket depth - target 1-2 ft',
      'Track RAS TSS concentration',
      'May need to adjust WAS location/timing',
      'Watch for hydraulic overload of aeration'
    ]
  },
  
  // ===== NEW SCENARIOS v9.9.16 =====
  
  uv_failure: {
    title: 'üí° UV System Failure',
    description: 'Simulating UV disinfection system offline',
    impacts: {
      ecoli: { value: +500, unit: '%', label: 'E.coli Risk', status: 'danger' },
      compliance: { value: -100, unit: '%', label: 'Permit', status: 'danger' },
      chlorine: { value: +200, unit: '%', label: 'Cl2 Needed', status: 'warning' },
      contact: { value: +50, unit: '%', label: 'CT Required', status: 'caution' }
    },
    analysis: [
      'CRITICAL: Disinfection capacity eliminated',
      'E.coli/fecal coliform limits will be exceeded',
      'Must switch to backup chlorination immediately',
      'Contact time requirements increase significantly',
      'Permit violation likely within 24 hours'
    ],
    actions: [
      'Activate backup chlorination system immediately',
      'Increase chlorine dose to achieve 0.5+ mg/L residual',
      'Verify contact tank baffling and T10 time',
      'Sample effluent every 4 hours for fecal coliform',
      'Notify permit authority within 24 hours',
      'Document all actions and UV maintenance history'
    ]
  },
  
  digester_upset: {
    title: 'üî• Digester Upset (pH Drop)',
    description: 'Simulating anaerobic digester acid phase imbalance',
    impacts: {
      gas_prod: { value: -70, unit: '%', label: 'Gas Prod', status: 'danger' },
      vfa: { value: +300, unit: '%', label: 'VFA', status: 'danger' },
      ph: { value: -1.5, unit: 'pH', label: 'pH Drop', status: 'danger' },
      recovery: { value: 21, unit: 'days', label: 'Recovery', status: 'warning' }
    },
    analysis: [
      'CRITICAL: Methanogen population stressed',
      'Volatile fatty acids accumulating rapidly',
      'pH below 6.8 - methanogens inhibited',
      'Gas production will drop significantly',
      'Recovery time: 2-4 weeks minimum'
    ],
    actions: [
      'Stop or reduce sludge feed immediately',
      'Add alkalinity (lime, soda ash) to raise pH > 6.8',
      'Monitor VFA/Alkalinity ratio - target < 0.3',
      'Increase mixing to distribute alkalinity',
      'Consider seeding with healthy digester sludge',
      'Resume feed slowly once pH stabilizes > 7.0'
    ]
  },
  
  filament_outbreak: {
    title: 'üï∏Ô∏è Filament Outbreak (Bulking)',
    description: 'Simulating filamentous bulking conditions',
    impacts: {
      svi: { value: +150, unit: '%', label: 'SVI', status: 'danger' },
      settling: { value: -60, unit: '%', label: 'Settling', status: 'danger' },
      blanket: { value: +100, unit: '%', label: 'Blanket', status: 'warning' },
      effluent: { value: +80, unit: '%', label: 'Eff TSS', status: 'danger' }
    },
    analysis: [
      'SVI exceeds 200 mL/g - severe bulking',
      'Filaments extending from floc causing poor settling',
      'Clarifier blanket rising toward weirs',
      'Common causes: low DO, low F/M, nutrient deficiency',
      'Recovery: 2-4 weeks with proper treatment'
    ],
    actions: [
      'Identify filament type via microscopy',
      'For Nocardia/M.parvicella: reduce SRT, add chlorine to RAS',
      'For Type 021N: increase DO > 2.5 mg/L',
      'For Thiothrix: check for septicity in collection system',
      'Add polymer to clarifier for temporary relief',
      'Consider RAS chlorination (2-5 mg/L)',
      'Increase WAS to reduce SRT if F/M is low'
    ]
  },
  
  pump_station_failure: {
    title: 'üö∞ Lift Station Failure',
    description: 'Simulating main influent pump station down',
    impacts: {
      flow: { value: -75, unit: '%', label: 'Flow', status: 'danger' },
      sso_risk: { value: +500, unit: '%', label: 'SSO Risk', status: 'danger' },
      biology: { value: -20, unit: '%', label: 'Biology', status: 'caution' },
      response: { value: 2, unit: 'hrs', label: 'Response', status: 'warning' }
    },
    analysis: [
      'CRITICAL: Sewage backing up in collection system',
      'Sanitary Sewer Overflow (SSO) imminent',
      'Aeration basin will be under-loaded',
      'Biological process may become nutrient limited',
      'Emergency response required within 2 hours'
    ],
    actions: [
      'Dispatch crew to lift station immediately',
      'Deploy portable bypass pumping if available',
      'Notify downstream pump stations',
      'Alert regulatory agency of potential SSO',
      'Reduce WAS to preserve biomass',
      'Document wet well levels every 30 minutes',
      'Prepare SSO report if overflow occurs'
    ]
  },
  
  nutrient_spike: {
    title: 'üß™ Phosphorus Spike (+200%)',
    description: 'Simulating high phosphorus industrial discharge',
    impacts: {
      effluent_p: { value: +180, unit: '%', label: 'Eff P', status: 'danger' },
      chemical: { value: +150, unit: '%', label: 'Chem Cost', status: 'warning' },
      sludge: { value: +40, unit: '%', label: 'Sludge Vol', status: 'caution' },
      compliance: { value: -50, unit: '%', label: 'P Limit', status: 'danger' }
    },
    analysis: [
      'Phosphorus loading exceeds treatment capacity',
      'Chemical precipitation demand increases sharply',
      'Biological P removal (if present) overwhelmed',
      'Additional chemical sludge production',
      'Permit exceedance likely without intervention'
    ],
    actions: [
      'Increase alum/ferric dose by 50-100%',
      'Target effluent P < permit limit',
      'Sample influent to identify source',
      'Contact industrial users for P reduction',
      'Monitor pH - may need adjustment with increased chemicals',
      'Plan for increased sludge handling'
    ]
  },
  
  summer_loading: {
    title: '‚òÄÔ∏è Summer Peak Season',
    description: 'Simulating seasonal high loading (resort/tourism area)',
    impacts: {
      flow: { value: +40, unit: '%', label: 'Flow', status: 'warning' },
      bod: { value: +35, unit: '%', label: 'BOD Load', status: 'warning' },
      temp: { value: +8, unit: '¬∞C', label: 'Temp Rise', status: 'caution' },
      do_demand: { value: +45, unit: '%', label: 'O2 Demand', status: 'warning' }
    },
    analysis: [
      'Seasonal population increase = higher loading',
      'Warmer temperatures increase biological activity',
      'Oxygen demand increases due to temp + load',
      'DO saturation decreases in warm water',
      'Nitrification improves but needs more oxygen'
    ],
    actions: [
      'Pre-season: increase MLSS inventory',
      'Maximize blower capacity during peak hours',
      'Monitor DO continuously - may need 24/7 aeration',
      'Adjust WAS to maintain target SRT (may decrease)',
      'Consider step-feed for load distribution',
      'Schedule maintenance for shoulder seasons'
    ]
  },
  
  grease_loading: {
    title: 'üçî FOG Event (Grease Slug)',
    description: 'Simulating high fats/oils/grease discharge',
    impacts: {
      scum: { value: +400, unit: '%', label: 'Scum', status: 'danger' },
      settling: { value: -35, unit: '%', label: 'Settling', status: 'warning' },
      do: { value: -20, unit: '%', label: 'DO', status: 'caution' },
      foam: { value: +200, unit: '%', label: 'Foam', status: 'warning' }
    },
    analysis: [
      'FOG accumulating at water surface',
      'Grease can coat diffusers, reducing transfer',
      'Scum blanket forming on clarifiers',
      'May trigger Nocardia/foam-forming organisms',
      'Source: restaurant, food processor, or illegal dump'
    ],
    actions: [
      'Increase surface skimming at clarifiers',
      'Manually remove scum mats if necessary',
      'Check diffuser performance - may need cleaning',
      'Trace source via collection system inspection',
      'Issue NOV to source if identified',
      'Add defoamer if foam becomes problematic',
      'Watch for filament growth over next 2 weeks'
    ]
  },
  
  low_flow: {
    title: 'üìâ Low Flow Period (-40%)',
    description: 'Simulating drought or water conservation conditions',
    impacts: {
      hrt: { value: +67, unit: '%', label: 'HRT', status: 'good' },
      strength: { value: +50, unit: '%', label: 'Strength', status: 'warning' },
      septicity: { value: +40, unit: '%', label: 'Septicity', status: 'caution' },
      fm: { value: -25, unit: '%', label: 'F/M', status: 'caution' }
    },
    analysis: [
      'Lower flow = higher concentration wastewater',
      'Extended retention in sewers causes septicity',
      'More H2S, odor complaints, and corrosion',
      'F/M ratio decreases - risk of old sludge',
      'Better treatment performance if managed properly'
    ],
    actions: [
      'Reduce blower output to match lower loading',
      'Increase WAS to prevent over-aged sludge',
      'Monitor for H2S at headworks',
      'Consider sewer flushing if odors increase',
      'Take advantage of spare capacity for maintenance',
      'Adjust chemical feeds proportionally'
    ]
  }
};

function runWhatIfScenario(scenarioKey) {
  var scenario = whatIfScenarios[scenarioKey];
  if (!scenario) return;
  
  var resultsPanel = document.getElementById('whatIfResultsPanel');
  document.getElementById('whatIfTitle').innerHTML = scenario.title;
  
  // Build impacts grid
  var impactsHtml = '';
  for (var key in scenario.impacts) {
    var impact = scenario.impacts[key];
    var color = impact.status === 'danger' ? '#ef4444' : impact.status === 'warning' ? '#f59e0b' : impact.status === 'caution' ? '#fbbf24' : '#22c55e';
    var arrow = impact.value > 0 ? '‚Üë' : impact.value < 0 ? '‚Üì' : '‚Üí';
    impactsHtml += '<div style="background:#0f172a;padding:12px;border-radius:8px;text-align:center;border-left:3px solid ' + color + '">' +
      '<div style="font-size:11px;color:#94a3b8">' + impact.label + '</div>' +
      '<div style="font-size:20px;font-weight:bold;color:' + color + '">' + arrow + ' ' + Math.abs(impact.value) + impact.unit + '</div>' +
    '</div>';
  }
  document.getElementById('whatIfImpacts').innerHTML = impactsHtml;
  
  // Build analysis
  var analysisHtml = '<h5 style="margin:0 0 10px 0;color:#60a5fa">üìã Impact Analysis</h5><ul style="margin:0;padding-left:20px;color:#e2e8f0">';
  scenario.analysis.forEach(function(item) {
    var color = item.includes('CRITICAL') ? '#ef4444' : '#e2e8f0';
    analysisHtml += '<li style="margin-bottom:6px;color:' + color + '">' + item + '</li>';
  });
  analysisHtml += '</ul>';
  document.getElementById('whatIfAnalysis').innerHTML = analysisHtml;
  
  // Build actions
  var actionsHtml = '';
  scenario.actions.forEach(function(action) {
    actionsHtml += '<li style="margin-bottom:6px">' + action + '</li>';
  });
  document.getElementById('whatIfActionsList').innerHTML = actionsHtml;
  
  resultsPanel.style.display = 'block';
  resultsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function runCustomScenario() {
  var flowChange = parseFloat(document.getElementById('custom_flow').value) || 0;
  var bodChange = parseFloat(document.getElementById('custom_bod').value) || 0;
  var tempChange = parseFloat(document.getElementById('custom_temp').value) || 0;
  var airChange = parseFloat(document.getElementById('custom_air').value) || 0;
  var mlssChange = parseFloat(document.getElementById('custom_mlss').value) || 0;
  var srtChange = parseFloat(document.getElementById('custom_srt').value) || 0;
  var rasChange = parseFloat(document.getElementById('custom_ras').value) || 0;
  var wasChange = parseFloat(document.getElementById('custom_was').value) || 0;
  
  // Calculate derived impacts
  var hrtImpact = -flowChange;
  var sorImpact = flowChange;
  var fmImpact = flowChange + bodChange - (mlssChange / 30);
  var doImpact = airChange - (bodChange * 0.5) - (flowChange * 0.3);
  var srtImpact = srtChange - wasChange * 0.4;
  var nitrImpact = srtImpact * 2 + tempChange * 4 + doImpact * 0.5;
  
  var resultsPanel = document.getElementById('whatIfResultsPanel');
  document.getElementById('whatIfTitle').innerHTML = 'üõ†Ô∏è Custom Scenario Results';
  
  // Build impacts
  var impacts = [
    { label: 'HRT', value: hrtImpact, unit: '%' },
    { label: 'SOR', value: sorImpact, unit: '%' },
    { label: 'F/M', value: fmImpact, unit: '%' },
    { label: 'DO Effect', value: doImpact, unit: '%' },
    { label: 'SRT Effect', value: srtImpact, unit: 'days' },
    { label: 'Nitrification', value: nitrImpact, unit: '%' }
  ];
  
  var impactsHtml = '';
  impacts.forEach(function(impact) {
    var status = Math.abs(impact.value) > 30 ? 'danger' : Math.abs(impact.value) > 15 ? 'warning' : 'good';
    var color = status === 'danger' ? '#ef4444' : status === 'warning' ? '#f59e0b' : '#22c55e';
    var arrow = impact.value > 0 ? '‚Üë' : impact.value < 0 ? '‚Üì' : '‚Üí';
    impactsHtml += '<div style="background:#0f172a;padding:12px;border-radius:8px;text-align:center;border-left:3px solid ' + color + '">' +
      '<div style="font-size:11px;color:#94a3b8">' + impact.label + '</div>' +
      '<div style="font-size:20px;font-weight:bold;color:' + color + '">' + arrow + ' ' + Math.abs(impact.value).toFixed(0) + impact.unit + '</div>' +
    '</div>';
  });
  document.getElementById('whatIfImpacts').innerHTML = impactsHtml;
  
  // Generate analysis
  var analysis = [];
  if (Math.abs(flowChange) > 0) analysis.push('Flow change of ' + flowChange + '% will affect HRT and clarifier loading');
  if (Math.abs(bodChange) > 0) analysis.push('BOD change of ' + bodChange + '% will affect oxygen demand and F/M ratio');
  if (Math.abs(tempChange) > 0) analysis.push('Temperature change of ' + tempChange + '¬∞C affects biological kinetics (' + (tempChange * 8).toFixed(0) + '% activity change)');
  if (Math.abs(airChange) > 0) analysis.push('Aeration change of ' + airChange + '% directly impacts DO levels');
  if (Math.abs(mlssChange) > 0) analysis.push('MLSS change of ' + mlssChange + ' mg/L affects F/M, settling, and oxygen demand');
  if (Math.abs(srtChange) > 0) analysis.push('SRT change of ' + srtChange + ' days affects nitrification and sludge characteristics');
  if (analysis.length === 0) analysis.push('No significant changes detected');
  
  var analysisHtml = '<h5 style="margin:0 0 10px 0;color:#60a5fa">üìã Impact Analysis</h5><ul style="margin:0;padding-left:20px;color:#e2e8f0">';
  analysis.forEach(function(item) {
    analysisHtml += '<li style="margin-bottom:6px">' + item + '</li>';
  });
  analysisHtml += '</ul>';
  document.getElementById('whatIfAnalysis').innerHTML = analysisHtml;
  
  // Generate recommendations
  var actions = [];
  if (doImpact < -20) actions.push('Increase aeration to maintain adequate DO');
  if (fmImpact > 30) actions.push('Consider increasing MLSS to reduce F/M ratio');
  if (sorImpact > 25) actions.push('Monitor clarifier performance closely');
  if (nitrImpact < -20) actions.push('Extend SRT to protect nitrification');
  if (actions.length === 0) actions.push('Changes are within normal operating range');
  actions.push('Monitor process response and adjust as needed');
  
  document.getElementById('whatIfActionsList').innerHTML = actions.map(function(a) { return '<li style="margin-bottom:6px">' + a + '</li>'; }).join('');
  
  resultsPanel.style.display = 'block';
  resultsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function resetCustomScenario() {
  document.getElementById('custom_flow').value = '0';
  document.getElementById('custom_bod').value = '0';
  document.getElementById('custom_temp').value = '0';
  document.getElementById('custom_air').value = '0';
  document.getElementById('custom_mlss').value = '0';
  document.getElementById('custom_srt').value = '0';
  document.getElementById('custom_ras').value = '0';
  document.getElementById('custom_was').value = '0';
  document.getElementById('whatIfResultsPanel').style.display = 'none';
}

function startWizardModal(type) {
  currentWizard = type;
  currentStep = 0;
  wizardData = {};
  showWizardStep();
  document.getElementById('wizardModal').style.display = 'flex';
}

function showWizardStep() {
  var steps = wizardSteps[currentWizard];
  var step = steps[currentStep];
  var html = '<h3 style="color:#4ade80;margin:0 0 20px 0">' + step.title + '</h3>';
  
  if (step.calc) {
    html += '<div style="background:#0c1929;padding:15px;border-radius:8px;margin-bottom:15px">';
    html += '<div style="color:#60a5fa;font-family:monospace">' + step.formula + '</div>';
    html += '</div>';
    
    var result = calculateWizardStep(currentWizard, currentStep);
    wizardData[step.result] = result;
    
    html += '<div style="background:#06d6a0;color:white;padding:20px;border-radius:8px;text-align:center;font-size:18px;font-weight:bold">';
    html += result.toFixed(2);
    html += '</div>';
    
    if (step.final) {
      html += '<div style="margin-top:15px;padding:15px;background:#0c1929;border-radius:8px">';
      html += '<strong style="color:#ffd166">Interpretation:</strong>';
      html += '<p style="color:#e0f2fe;margin:10px 0 0 0">' + getWizardInterpretation(currentWizard, result) + '</p>';
      html += '</div>';
    }
  } else {
    html += '<label style="color:#e0f2fe;display:block;margin-bottom:10px">' + step.label + '</label>';
    html += '<input type="number" id="' + step.input + '" value="' + step.default + '" style="width:100%;padding:15px;font-size:18px;border-radius:8px;border:2px solid #243b55;background:#0c1929;color:white">';
    html += '<p style="color:#94a3b8;margin-top:10px;font-size:14px">üí° ' + step.hint + '</p>';
  }
  
  html += '<div style="display:flex;gap:10px;margin-top:20px">';
  if (currentStep > 0) {
    html += '<button onclick="prevWizardStep()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;cursor:pointer">‚Üê Back</button>';
  }
  if (currentStep < steps.length - 1) {
    html += '<button onclick="nextWizardStep()" style="flex:1;padding:12px;background:#0077b6;color:white;border:none;border-radius:8px;cursor:pointer">Next ‚Üí</button>';
  } else {
    html += '<button onclick="closeWizard()" style="flex:1;padding:12px;background:#06d6a0;color:white;border:none;border-radius:8px;cursor:pointer">‚úì Done</button>';
  }
  html += '</div>';
  html += '<button onclick="closeWizard()" style="width:100%;padding:10px;background:transparent;color:#94a3b8;border:1px solid #243b55;border-radius:8px;cursor:pointer;margin-top:10px">Cancel</button>';
  
  document.getElementById('wizardContent').innerHTML = html;
}

function nextWizardStep() {
  var steps = wizardSteps[currentWizard];
  var step = steps[currentStep];
  if (step.input) {
    wizardData[step.input] = parseFloat(document.getElementById(step.input).value) || 0;
  }
  currentStep++;
  showWizardStep();
}

function prevWizardStep() {
  currentStep--;
  showWizardStep();
}

function closeWizard() {
  document.getElementById('wizardModal').style.display = 'none';
  currentWizard = null;
}

function calculateWizardStep(type, step) {
  if (type === 'fm') {
    if (step === 2) {
      return wizardData.wizard_bod * wizardData.wizard_flow * 8.34;
    } else if (step === 5) {
      var bodLoad = wizardData.wizard_bod * wizardData.wizard_flow * 8.34;
      var biomass = wizardData.wizard_mlvss * wizardData.wizard_vol * 8.34;
      return biomass > 0 ? bodLoad / biomass : 0;
    }
  } else if (type === 'srt') {
    if (step === 2) {
      return wizardData.wizard_srt_mlss * wizardData.wizard_srt_vol * 8.34;
    } else if (step === 5) {
      var solids = wizardData.wizard_srt_mlss * wizardData.wizard_srt_vol * 8.34;
      var wasted = wizardData.wizard_srt_was * wizardData.wizard_srt_wastss * 8.34;
      return wasted > 0 ? solids / wasted : 0;
    }
  } else if (type === 'was') {
    if (step === 3) {
      var diff = wizardData.wizard_was_mlss - wizardData.wizard_was_target;
      return diff * wizardData.wizard_was_vol * 8.34 / 8000;
    }
  } else if (type === 'chlorine') {
    if (step === 3) {
      return (wizardData.wizard_cl_flow * wizardData.wizard_cl_dose * 8.34) / (wizardData.wizard_cl_str / 100 * 8.34);
    }
  } else if (type === 'svi') {
    if (step === 2) {
      return (wizardData.wizard_svi_vol * 1000) / wizardData.wizard_svi_mlss;
    }
  } else if (type === 'bod_removal') {
    if (step === 3) {
      var removed = wizardData.wizard_bod_in - wizardData.wizard_bod_out;
      return (removed / wizardData.wizard_bod_in) * 100;
    }
  } else if (type === 'ras') {
    if (step === 3) {
      var numerator = wizardData.wizard_ras_mlss * wizardData.wizard_ras_flow;
      var denominator = wizardData.wizard_ras_tss - wizardData.wizard_ras_mlss;
      return denominator > 0 ? numerator / denominator : 0;
    }
  } else if (type === 'detention') {
    if (step === 2) {
      return wizardData.wizard_det_vol / wizardData.wizard_det_flow;
    }
  } else if (type === 'sor') {
    if (step === 2) {
      return wizardData.wizard_sor_flow / wizardData.wizard_sor_area;
    }
  } else if (type === 'polymer') {
    if (step === 4) {
      var dryTonsPerMin = (wizardData.wizard_poly_flow * 8.34 * wizardData.wizard_poly_solids / 100) / 2000;
      var lbPolyPerMin = dryTonsPerMin * wizardData.wizard_poly_dose;
      var polyGPM = lbPolyPerMin / (wizardData.wizard_poly_str / 100 * 8.34);
      return polyGPM;
    }
  } else if (type === 'blower') {
    if (step === 4) {
      var o2Required = wizardData.wizard_air_bod * wizardData.wizard_air_ratio;
      var scfm = (o2Required * 100) / (wizardData.wizard_air_eff * 0.0173 * wizardData.wizard_air_depth * 60);
      return scfm;
    }
  } else if (type === 'ct') {
    if (step === 3) {
      var actualCT = wizardData.wizard_ct_cl * wizardData.wizard_ct_time;
      return actualCT / wizardData.wizard_ct_req;
    }
  }
  return 0;
}

function getWizardInterpretation(type, value) {
  if (type === 'fm') {
    if (value < 0.15) return 'F/M is LOW - Extended aeration mode. May see nitrification but risk of pin floc.';
    if (value <= 0.5) return 'F/M is OPTIMAL - Good balance of treatment and settling.';
    return 'F/M is HIGH - May see poor settling and incomplete treatment. Consider wasting less.';
  } else if (type === 'srt') {
    if (value < 5) return 'SRT is LOW - Risk of washout. Reduce wasting rate.';
    if (value <= 15) return 'SRT is OPTIMAL - Good for conventional activated sludge.';
    return 'SRT is HIGH - Old sludge, may see pin floc. Increase wasting.';
  } else if (type === 'was') {
    return 'Waste approximately ' + value.toFixed(2) + ' MG of sludge to reach target MLSS.';
  } else if (type === 'chlorine') {
    return 'Feed ' + value.toFixed(1) + ' gallons per day of chlorine solution.';
  } else if (type === 'svi') {
    if (value < 80) return 'SVI is LOW (' + value.toFixed(0) + ') - May indicate pin floc or old sludge. Consider reducing SRT.';
    if (value <= 150) return 'SVI is OPTIMAL (' + value.toFixed(0) + ') - Good settling characteristics.';
    return 'SVI is HIGH (' + value.toFixed(0) + ') - Bulking sludge! Check for filaments, low DO, or nutrient deficiency.';
  } else if (type === 'bod_removal') {
    if (value >= 85) return 'BOD Removal: ' + value.toFixed(1) + '% - Excellent! Meeting typical permit requirements.';
    if (value >= 75) return 'BOD Removal: ' + value.toFixed(1) + '% - Acceptable but could improve.';
    return 'BOD Removal: ' + value.toFixed(1) + '% - LOW! Check process parameters and biomass health.';
  } else if (type === 'ras') {
    return 'RAS Rate: ' + value.toFixed(2) + ' MGD (' + (value / wizardData.wizard_ras_flow * 100).toFixed(0) + '% of influent flow). Typical range: 25-75% of influent.';
  } else if (type === 'detention') {
    var hours = value / 60;
    return 'Detention Time: ' + value.toFixed(1) + ' minutes (' + hours.toFixed(2) + ' hours). Aeration basins typically need 4-8 hours.';
  } else if (type === 'sor') {
    if (value <= 800) return 'SOR: ' + value.toFixed(0) + ' gpd/sf - Excellent for secondary clarifier (design <800-1000).';
    if (value <= 1200) return 'SOR: ' + value.toFixed(0) + ' gpd/sf - Acceptable for primary or peak conditions.';
    return 'SOR: ' + value.toFixed(0) + ' gpd/sf - HIGH! May cause solids carryover. Consider flow equalization.';
  } else if (type === 'polymer') {
    return 'Polymer Feed Rate: ' + value.toFixed(2) + ' GPM of prepared solution. Verify with jar testing.';
  } else if (type === 'blower') {
    return 'Air Required: ' + value.toFixed(0) + ' SCFM. At standard conditions (1 atm, 68¬∞F). Add 10-20% safety factor.';
  } else if (type === 'ct') {
    if (value >= 1.0) return 'CT Ratio: ' + value.toFixed(2) + ' - COMPLIANT! Adequate disinfection achieved.';
    return 'CT Ratio: ' + value.toFixed(2) + ' - NON-COMPLIANT! Increase chlorine dose or contact time.';
  }
  return '';
}

// Training Modules

// ========== SAFETY MODULE FUNCTIONS v9.9.27 ==========

// Toggle between Safety and Videos sections in Training panel
function showTrainingSection(section) {
  const safetySection = document.getElementById('training-safety-section');
  const videosSection = document.getElementById('training-videos-section');
  const safetyTab = document.getElementById('training-tab-safety');
  const videosTab = document.getElementById('training-tab-videos');
  
  if (section === 'safety') {
    safetySection.style.display = 'block';
    videosSection.style.display = 'none';
    safetyTab.style.background = 'linear-gradient(135deg,#dc2626,#b91c1c)';
    safetyTab.style.color = 'white';
    videosTab.style.background = 'linear-gradient(145deg,#1e293b,#0f172a)';
    videosTab.style.color = '#c4b5fd';
  } else {
    safetySection.style.display = 'none';
    videosSection.style.display = 'block';
    videosTab.style.background = 'linear-gradient(135deg,#7c3aed,#6d28d9)';
    videosTab.style.color = 'white';
    safetyTab.style.background = 'linear-gradient(145deg,#1e293b,#0f172a)';
    safetyTab.style.color = '#fca5a5';
  }
  window.scrollTo(0, 0);
}

function clearSafetyChecklist(checklistId) {
  const checklist = document.getElementById(checklistId);
  if (checklist) {
    const checkboxes = checklist.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = false);
    showToast('Checklist reset', 'info');
  }
}

function showSafetyCard(cardType) {
  const cards = {
    loto: {
      title: 'üîí LOTO Quick Reference',
      content: `
        <div style="text-align:left;font-size:13px;line-height:1.8">
          <div style="font-weight:700;color:#f87171;margin-bottom:12px">8-Step LOTO Procedure:</div>
          <ol style="margin:0 0 0 20px;padding:0;color:#e2e8f0">
            <li><strong>Prepare</strong> - Identify all energy sources</li>
            <li><strong>Notify</strong> - Alert affected employees</li>
            <li><strong>Shutdown</strong> - Normal operating controls</li>
            <li><strong>Isolate</strong> - Disconnect all energy sources</li>
            <li><strong>Apply LOTO</strong> - Personal lock and tag</li>
            <li><strong>Release Energy</strong> - Bleed/discharge stored energy</li>
            <li><strong>Verify</strong> - Try to start, confirm zero energy</li>
            <li><strong>Perform Work</strong> - Maintain LOTO until complete</li>
          </ol>
          <div style="margin-top:16px;padding:12px;background:rgba(239,68,68,0.2);border-radius:8px;color:#fca5a5">
            ‚ö†Ô∏è NEVER remove another person's lock!
          </div>
        </div>
      `
    },
    cse: {
      title: 'üöß CSE Quick Reference',
      content: `
        <div style="text-align:left;font-size:13px;line-height:1.8">
          <div style="font-weight:700;color:#fb923c;margin-bottom:12px">Atmospheric Limits:</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">
            <div style="background:rgba(59,130,246,0.2);padding:8px;border-radius:6px;text-align:center">
              <div style="color:#60a5fa;font-weight:700">O‚ÇÇ</div>
              <div style="color:white">19.5-23.5%</div>
            </div>
            <div style="background:rgba(239,68,68,0.2);padding:8px;border-radius:6px;text-align:center">
              <div style="color:#f87171;font-weight:700">LEL</div>
              <div style="color:white">&lt;10%</div>
            </div>
            <div style="background:rgba(234,179,8,0.2);padding:8px;border-radius:6px;text-align:center">
              <div style="color:#fbbf24;font-weight:700">H‚ÇÇS</div>
              <div style="color:white">&lt;10 ppm</div>
            </div>
            <div style="background:rgba(168,85,247,0.2);padding:8px;border-radius:6px;text-align:center">
              <div style="color:#c084fc;font-weight:700">CO</div>
              <div style="color:white">&lt;35 ppm</div>
            </div>
          </div>
          <div style="color:#e2e8f0">
            <strong>Required Personnel:</strong><br>
            ‚Ä¢ Entry Supervisor<br>
            ‚Ä¢ Attendant (outside)<br>
            ‚Ä¢ Authorized Entrant
          </div>
        </div>
      `
    },
    h2s: {
      title: '‚ò†Ô∏è H‚ÇÇS Quick Reference',
      content: `
        <div style="text-align:left;font-size:13px;line-height:1.8">
          <div style="font-weight:700;color:#fbbf24;margin-bottom:12px">Exposure Levels:</div>
          <div style="color:#e2e8f0">
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #374151">
              <span>0.01-0.3 ppm</span><span style="color:#4ade80">Odor threshold</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #374151">
              <span>10 ppm</span><span style="color:#fbbf24">OSHA PEL</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #374151">
              <span>100 ppm</span><span style="color:#ef4444">IDLH - Can't smell!</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:4px 0">
              <span>700+ ppm</span><span style="color:#dc2626">Immediately fatal</span>
            </div>
          </div>
          <div style="margin-top:16px;padding:12px;background:rgba(220,38,38,0.2);border-radius:8px;color:#fca5a5">
            ‚ö†Ô∏è H‚ÇÇS is the #1 killer in wastewater!
          </div>
        </div>
      `
    },
    emergency: {
      title: 'üö® Emergency Quick Reference',
      content: `
        <div style="text-align:left;font-size:13px;line-height:1.8">
          <div style="font-weight:700;color:#f87171;margin-bottom:12px">Emergency Contacts:</div>
          <div style="display:grid;gap:8px;margin-bottom:16px">
            <div style="background:rgba(239,68,68,0.2);padding:10px;border-radius:6px;text-align:center">
              <div style="font-size:24px;font-weight:700;color:#f87171">911</div>
              <div style="font-size:11px;color:#94a3b8">Emergency Services</div>
            </div>
            <div style="background:rgba(234,179,8,0.2);padding:10px;border-radius:6px;text-align:center">
              <div style="font-size:18px;font-weight:700;color:#fbbf24">1-800-222-1222</div>
              <div style="font-size:11px;color:#94a3b8">Poison Control</div>
            </div>
            <div style="background:rgba(59,130,246,0.2);padding:10px;border-radius:6px;text-align:center">
              <div style="font-size:18px;font-weight:700;color:#60a5fa">1-800-424-9300</div>
              <div style="font-size:11px;color:#94a3b8">CHEMTREC</div>
            </div>
          </div>
          <div style="color:#fca5a5;font-weight:600">
            CSE Rescue: NEVER enter without SCBA!
          </div>
        </div>
      `
    }
  };
  
  const card = cards[cardType];
  if (card) {
    showModal(card.title, card.content, { width: '360px' });
  }
}

function printCSEPermit() {
  showToast('Opening printable CSE permit...', 'info');
  // Could implement actual print functionality
}

function printDailySafetyChecklist() {
  showToast('Opening printable safety checklist...', 'info');
}

// ========== VIDEO LIBRARY FUNCTIONS v9.9.27 ==========

function filterVideos() {
  const searchTerm = document.getElementById('video-search')?.value.toLowerCase() || '';
  const categoryFilter = document.getElementById('video-category-filter')?.value || 'all';
  
  const videoCategories = document.querySelectorAll('.video-category');
  
  videoCategories.forEach(category => {
    const categoryType = category.dataset.category;
    const categoryMatches = categoryFilter === 'all' || categoryType === categoryFilter;
    
    if (!categoryMatches) {
      category.style.display = 'none';
      return;
    }
    
    const videoCards = category.querySelectorAll('.video-card');
    let hasVisibleVideos = false;
    
    videoCards.forEach(card => {
      const title = card.textContent.toLowerCase();
      const matchesSearch = searchTerm === '' || title.includes(searchTerm);
      
      if (matchesSearch) {
        card.style.display = 'block';
        hasVisibleVideos = true;
      } else {
        card.style.display = 'none';
      }
    });
    
    category.style.display = hasVisibleVideos ? 'block' : 'none';
  });
}

var completedModules = JSON.parse(localStorage.getItem('wwtp_training') || '[]');

function startTraining(moduleNum) {
  var content = document.getElementById('training' + moduleNum + 'Content');
  if (content.style.display === 'none') {
    content.style.display = 'block';
  } else {
    content.style.display = 'none';
  }
}

function completeModule(moduleNum) {
  if (!completedModules.includes(moduleNum)) {
    completedModules.push(moduleNum);
    localStorage.setItem('wwtp_training', JSON.stringify(completedModules));
  }
  updateTrainingProgress();
  showToast('Module ' + moduleNum + ' completed! üéâ', 'success');
  document.getElementById('training' + moduleNum + 'Content').style.display = 'none';
}

function updateTrainingProgress() {
  document.getElementById('trainingProgress').textContent = completedModules.length + ' / 3 modules';
  if (completedModules.length === 3) {
    document.getElementById('trainingProgress').innerHTML = '3 / 3 modules <span style="color:#06d6a0">‚úì CERTIFIED!</span>';
  }
}

// Load training progress on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(updateTrainingProgress, 600);
});

// Formula Reference
var formulaDetails = {
  fm: {
    title: '‚öñÔ∏è F/M Ratio (Food to Microorganism)',
    formula: 'F/M = (BOD √ó Flow √ó 8.34) / (MLVSS √ó Volume √ó 8.34)',
    explanation: 'The F/M ratio represents the amount of food (BOD) available per unit of microorganisms (MLVSS) per day.',
    variables: [
      'BOD = Influent BOD concentration (mg/L)',
      'Flow = Daily flow rate (MGD)',
      'MLVSS = Mixed Liquor Volatile Suspended Solids (mg/L)',
      'Volume = Aeration basin volume (MG)',
      '8.34 = Conversion factor (lb/gal)'
    ],
    typical: 'Conventional: 0.2-0.5 lb BOD/lb MLVSS/day | Extended Aeration: 0.05-0.15',
    notes: 'Low F/M = old sludge, nitrification | High F/M = young sludge, may have settling issues'
  },
  srt: {
    title: '‚è±Ô∏è SRT (Solids Retention Time)',
    formula: 'SRT = (MLSS √ó Volume √ó 8.34) / [(WAS √ó TSS √ó 8.34) + (Eff √ó TSS √ó 8.34)]',
    explanation: 'SRT represents the average time that solids (microorganisms) remain in the system.',
    variables: [
      'MLSS = Mixed Liquor Suspended Solids (mg/L)',
      'Volume = Aeration volume (MG)',
      'WAS = Waste Activated Sludge flow (MGD)',
      'TSS = Total Suspended Solids concentrations (mg/L)',
      'Eff = Effluent flow (MGD)'
    ],
    typical: 'Conventional: 5-15 days | Extended Aeration: 20-30 days | Nitrification: >10 days',
    notes: 'Longer SRT = older sludge, better nitrification but may have settling issues'
  },
  svi: {
    title: 'üß™ SVI (Sludge Volume Index)',
    formula: 'SVI = (Settled Volume mL/L √ó 1000) / MLSS mg/L',
    explanation: 'SVI indicates the settling characteristics of activated sludge.',
    variables: [
      'Settled Volume = Volume of sludge after 30 minutes settling (mL/L)',
      'MLSS = Mixed Liquor Suspended Solids (mg/L)'
    ],
    typical: 'Good settling: 80-150 mL/g | Bulking sludge: >150 mL/g | Pin floc: <50 mL/g',
    notes: 'High SVI indicates bulking (filamentous bacteria). Low SVI may indicate old sludge or pin floc.'
  },
  bod: {
    title: 'üìä BOD Loading',
    formula: 'BOD Load (lb/day) = BOD (mg/L) √ó Flow (MGD) √ó 8.34',
    explanation: 'Calculates the mass of BOD entering the plant per day.',
    variables: [
      'BOD = Biochemical Oxygen Demand concentration (mg/L)',
      'Flow = Daily flow rate (MGD)',
      '8.34 = Conversion factor (lb/gal)'
    ],
    typical: 'Varies by plant size. Used to calculate organic loading rate and F/M ratio.',
    notes: 'The 8.34 factor converts mg/L √ó MG to pounds.'
  },
  removal: {
    title: 'üìâ Percent Removal',
    formula: '% Removal = ((Influent - Effluent) / Influent) √ó 100',
    explanation: 'Calculates the efficiency of any treatment process.',
    variables: [
      'Influent = Concentration entering process (mg/L)',
      'Effluent = Concentration leaving process (mg/L)'
    ],
    typical: 'BOD: 85-95% | TSS: 85-95% | Ammonia: 90-99% (if nitrifying)',
    notes: 'Can be applied to any parameter. Essential for permit compliance tracking.'
  },
  detention: {
    title: '‚è∞ Detention Time',
    formula: 'DT (hours) = (Volume gal √ó 24) / (Flow GPD)',
    explanation: 'The theoretical time water spends in a tank or basin.',
    variables: [
      'Volume = Tank volume (gallons)',
      'Flow = Flow rate (GPD)',
      '24 = Hours per day'
    ],
    typical: 'Aeration: 4-8 hours | Primary clarifier: 1.5-2.5 hours | Secondary clarifier: 2-4 hours',
    notes: 'Also called Hydraulic Retention Time (HRT). Actual retention time varies due to short-circuiting.'
  },
  sor: {
    title: 'üåä Surface Overflow Rate',
    formula: 'SOR = Flow (GPD) / Surface Area (sq ft)',
    explanation: 'The hydraulic loading rate on a clarifier surface.',
    variables: [
      'Flow = Daily flow rate (GPD)',
      'Surface Area = Clarifier surface area (sq ft)'
    ],
    typical: 'Primary: 800-1200 gpd/sf | Secondary: 400-800 gpd/sf',
    notes: 'Lower SOR = better settling. Peak flow SOR should not exceed design limits.'
  },
  ct: {
    title: 'üß™ CT (Disinfection)',
    formula: 'CT = Chlorine Residual (mg/L) √ó Contact Time (minutes)',
    explanation: 'CT concept ensures adequate disinfection by considering both dose and time.',
    variables: [
      'Chlorine Residual = Free or total chlorine remaining (mg/L)',
      'Contact Time = Time in contact chamber at peak flow (minutes)'
    ],
    typical: 'Required CT varies by pathogen and temperature. Typical >15 mg¬∑min/L for bacteria.',
    notes: 'Higher temperature = lower CT required. Must use T10 (time for 10% of flow to pass).'
  }
};

function showFormulaDetail(formula) {
  var detail = formulaDetails[formula];
  var html = '<h3 style="color:#4ade80;margin:0 0 20px 0">' + detail.title + '</h3>';
  html += '<div style="background:#0c1929;padding:15px;border-radius:8px;margin-bottom:15px">';
  html += '<div style="color:#e0f2fe;font-family:monospace;font-size:16px">' + detail.formula + '</div>';
  html += '</div>';
  html += '<h4 style="color:#60a5fa;margin:15px 0 10px 0">Explanation:</h4>';
  html += '<p style="color:#e0f2fe;line-height:1.6">' + detail.explanation + '</p>';
  html += '<h4 style="color:#60a5fa;margin:15px 0 10px 0">Variables:</h4>';
  html += '<ul style="color:#e0f2fe;line-height:1.8">';
  detail.variables.forEach(function(v) {
    html += '<li>' + v + '</li>';
  });
  html += '</ul>';
  html += '<h4 style="color:#60a5fa;margin:15px 0 10px 0">Typical Values:</h4>';
  html += '<p style="color:#06d6a0">' + detail.typical + '</p>';
  html += '<h4 style="color:#ffd166;margin:15px 0 10px 0">Notes:</h4>';
  html += '<p style="color:#94a3b8">' + detail.notes + '</p>';
  
  document.getElementById('formulaDetail').innerHTML = html;
  document.getElementById('formulaModal').style.display = 'flex';
}

function closeFormulaModal() {
  document.getElementById('formulaModal').style.display = 'none';
}

// ========== END OPERATOR TOOLS ==========


// ========== QUICK WIN ENHANCEMENTS v5.1.0 ==========

// CT Calculation
function calcCT() {
  var cl = parseFloat(document.getElementById('ct_cl').value) || 0;
  var time = parseFloat(document.getElementById('ct_time').value) || 0;
  var required = parseFloat(document.getElementById('ct_required').value) || 0;
  var actual = cl * time;
  var ratio = required > 0 ? actual / required : 0;
  document.getElementById('r_ct_actual').textContent = actual.toFixed(1);
  document.getElementById('r_ct_ratio').textContent = ratio.toFixed(2);
  var status = ratio >= 1.0 ? '‚úì Compliant' : '‚úó Non-Compliant';
  document.getElementById('r_ct_status').textContent = status;
  document.getElementById('r_ct_status').style.color = ratio >= 1.0 ? '#06d6a0' : '#ef4444';
}
function resetCT() {
  document.getElementById('ct_cl').value = '0.5';
  document.getElementById('ct_time').value = '30';
  document.getElementById('ct_required').value = '15';
  ['r_ct_actual','r_ct_ratio','r_ct_status'].forEach(id => { 
    document.getElementById(id).textContent = '-';
    document.getElementById(id).style.color = '';
  });
}

// Geometric Mean
function calcGeoMean() {
  var input = document.getElementById('geomean_values').value;
  var values = input.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v) && v > 0);
  if (values.length === 0) return;
  var count = values.length;
  var arith = values.reduce((a,b) => a+b, 0) / count;
  var logSum = values.reduce((a,b) => a + Math.log(b), 0);
  var geoMean = Math.exp(logSum / count);
  var logMean = logSum / count;
  document.getElementById('r_geo_count').textContent = count;
  document.getElementById('r_geo_arith').textContent = arith.toFixed(1);
  document.getElementById('r_geo_mean').textContent = geoMean.toFixed(1);
  document.getElementById('r_geo_log').textContent = logMean.toFixed(3);
}
function resetGeoMean() {
  document.getElementById('geomean_values').value = '100,200,150,180,120';
  ['r_geo_count','r_geo_arith','r_geo_mean','r_geo_log'].forEach(id => document.getElementById(id).textContent = '-');
}

// Dilution Calculator (Lab version)
function calcDilution_Lab() {
  var c1 = parseFloat(document.getElementById('dil_c1').value) || 0;
  var c2 = parseFloat(document.getElementById('dil_c2').value) || 0;
  var v2 = parseFloat(document.getElementById('dil_v2').value) || 0;
  var v1 = c1 > 0 ? (c2 * v2) / c1 : 0;
  var diluent = v2 - v1;
  var factor = c2 > 0 ? c1 / c2 : 0;
  document.getElementById('r_dil_v1').textContent = v1.toFixed(2);
  document.getElementById('r_dil_diluent').textContent = diluent.toFixed(2);
  document.getElementById('r_dil_factor').textContent = factor.toFixed(1);
}
function resetDilution_Lab() {
  document.getElementById('dil_c1').value = '1000';
  document.getElementById('dil_c2').value = '100';
  document.getElementById('dil_v2').value = '1000';
  ['r_dil_v1','r_dil_diluent','r_dil_factor'].forEach(id => document.getElementById(id).textContent = '-');
}

// Sludge Judge Calculator
function calcSludgeJudge() {
  var vol = parseFloat(document.getElementById('sj_vol').value) || 0;
  var mlss = parseFloat(document.getElementById('sj_mlss').value) || 0;
  var depth = parseFloat(document.getElementById('sj_depth').value) || 0;
  var blanket = parseFloat(document.getElementById('sj_blanket').value) || 0;
  var svi = mlss > 0 ? (vol * 1000) / mlss : 0;
  var sdi = svi > 0 ? 100 / svi : 0;
  var pct = depth > 0 ? (blanket / depth) * 100 : 0;
  document.getElementById('r_sj_svi').textContent = svi.toFixed(0);
  document.getElementById('r_sj_sdi').textContent = sdi.toFixed(2);
  document.getElementById('r_sj_pct').textContent = pct.toFixed(1);
  var status = pct < 25 ? '‚úì Good' : pct < 40 ? '‚ö† Watch' : '‚úó High';
  document.getElementById('r_sj_status').textContent = status;
}
function resetSludgeJudge() {
  document.getElementById('sj_vol').value = '250';
  document.getElementById('sj_mlss').value = '3000';
  document.getElementById('sj_depth').value = '12';
  document.getElementById('sj_blanket').value = '3';
  ['r_sj_svi','r_sj_sdi','r_sj_pct','r_sj_status'].forEach(id => document.getElementById(id).textContent = '-');
}

// Mass Balance
function calcMassBalance() {
  var flowIn = parseFloat(document.getElementById('mb_flow_in').value) || 0;
  var concIn = parseFloat(document.getElementById('mb_conc_in').value) || 0;
  var flowOut = parseFloat(document.getElementById('mb_flow_out').value) || 0;
  var concOut = parseFloat(document.getElementById('mb_conc_out').value) || 0;
  var sludge = parseFloat(document.getElementById('mb_sludge').value) || 0;
  var massIn = flowIn * concIn * 8.34;
  var massOut = flowOut * concOut * 8.34;
  var removed = massIn - massOut;
  var error = removed > 0 ? ((removed - sludge) / removed) * 100 : 0;
  document.getElementById('r_mb_in').textContent = massIn.toFixed(0);
  document.getElementById('r_mb_out').textContent = massOut.toFixed(0);
  document.getElementById('r_mb_removed').textContent = removed.toFixed(0);
  document.getElementById('r_mb_error').textContent = error.toFixed(1);
}
function resetMassBalance() {
  document.getElementById('mb_flow_in').value = '5.0';
  document.getElementById('mb_conc_in').value = '200';
  document.getElementById('mb_flow_out').value = '4.95';
  document.getElementById('mb_conc_out').value = '10';
  document.getElementById('mb_sludge').value = '7500';
  ['r_mb_in','r_mb_out','r_mb_removed','r_mb_error'].forEach(id => document.getElementById(id).textContent = '-');
}

// ========== DATA PERSISTENCE ==========

// Save all input values to localStorage
function saveAllData() {
  try {
    var data = {};
    var inputs = document.querySelectorAll('input[id], select[id]');
    inputs.forEach(function(el) {
      if (el.id && el.id !== '') {
        data[el.id] = el.value;
      }
    });
    data._timestamp = new Date().toISOString();
    data._version = APP_VERSION;
    localStorage.setItem('wwtp_saved_data', JSON.stringify(data));
    showToast('All data saved! (' + Object.keys(data).length + ' values)', 'success');
    return true;
  } catch(e) {
    showToast('Error saving data', 'error');
    return false;
  }
}

// Load saved data from localStorage
function loadSavedData() {
  try {
    var saved = localStorage.getItem('wwtp_saved_data');
    if (!saved) {
      // Silently return - no toast on boot
      return false;
    }
    var data = JSON.parse(saved);
    var count = 0;
    Object.keys(data).forEach(function(id) {
      if (id.startsWith('_')) return;
      var el = document.getElementById(id);
      if (el) {
        el.value = data[id];
        count++;
      }
    });
    var timestamp = data._timestamp ? new Date(data._timestamp).toLocaleString() : 'Unknown';
    showToast('Loaded ' + count + ' values (saved: ' + timestamp + ')', 'success');
    return true;
  } catch(e) {
    showToast('Error loading data', 'error');
    return false;
  }
}

// Clear saved data
function clearSavedData() {
  if (confirm('Clear all saved data? This cannot be undone.')) {
    localStorage.removeItem('wwtp_saved_data');
    showToast('Saved data cleared', 'info');
  }
}

// Export configuration as JSON file
function exportConfig() {
  var data = {};
  var inputs = document.querySelectorAll('input[id], select[id]');
  inputs.forEach(function(el) {
    if (el.id) data[el.id] = el.value;
  });
  data._exported = new Date().toISOString();
  data._version = APP_VERSION;
  var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_config_' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Configuration exported!', 'success');
}

// Import configuration from JSON file
function importConfig() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function(e) {
    var file = e.target.files[0];
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = JSON.parse(e.target.result);
        var count = 0;
        Object.keys(data).forEach(function(id) {
          if (id.startsWith('_')) return;
          var el = document.getElementById(id);
          if (el) {
            el.value = data[id];
            count++;
          }
        });
        showToast('Imported ' + count + ' values', 'success');
      } catch(err) {
        showToast('Invalid configuration file', 'error');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// Auto-save every 5 minutes
var autoSaveInterval = null;
function enableAutoSave() {
  if (autoSaveInterval) clearInterval(autoSaveInterval);
  autoSaveInterval = setInterval(function() {
    saveAllData();
    console.log('Auto-saved at ' + new Date().toLocaleTimeString());
  }, 300000); // 5 minutes
  showToast('Auto-save enabled (every 5 min)', 'info');
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.shiftKey) {
    switch(e.key.toLowerCase()) {
      case 's':
        e.preventDefault();
        saveAllData();
        break;
      case 'l':
        e.preventDefault();
        loadSavedData();
        break;
      case 'e':
        e.preventDefault();
        exportConfig();
        break;
    }
  }
});

// ========== END QUICK WIN ENHANCEMENTS ==========


// ========== ENHANCED CALCULATORS v5.1.0 ==========

// Detention Time (General)
function calcDetention() {
  var vol = parseFloat(document.getElementById('det_vol').value) || 0;
  var gpm = parseFloat(document.getElementById('det_gpm').value) || 0;
  var minutes = gpm > 0 ? vol / gpm : 0;
  var hours = minutes / 60;
  document.getElementById('r_det_min').textContent = minutes.toFixed(1);
  document.getElementById('r_det_hr').textContent = hours.toFixed(2);
}
function resetDetention() {
  document.getElementById('det_vol').value = '500000';
  document.getElementById('det_gpm').value = '3500';
  document.getElementById('r_det_min').textContent = '-';
  document.getElementById('r_det_hr').textContent = '-';
}

// Population Equivalent
function calcPE() {
  var bod = parseFloat(document.getElementById('pe_bod').value) || 0;
  var flow = parseFloat(document.getElementById('pe_flow').value) || 0;
  var peBod = bod / 0.17; // 0.17 lb BOD/person/day
  var peFlow = (flow * 1000000) / 100; // 100 gpd/person typical
  var gpd = peBod > 0 ? (flow * 1000000) / peBod : 0;
  document.getElementById('r_pe_bod').textContent = Math.round(peBod).toLocaleString();
  document.getElementById('r_pe_flow').textContent = Math.round(peFlow).toLocaleString();
  document.getElementById('r_pe_gpd').textContent = gpd.toFixed(0);
}
function resetPE() {
  document.getElementById('pe_bod').value = '5000';
  document.getElementById('pe_flow').value = '5.0';
  ['r_pe_bod','r_pe_flow','r_pe_gpd'].forEach(id => document.getElementById(id).textContent = '-');
}

// Sludge Age (Simple)
function calcSludgeAge() {
  var mlss = parseFloat(document.getElementById('sa_mlss').value) || 0;
  var was = parseFloat(document.getElementById('sa_was').value) || 0;
  var age = was > 0 ? mlss / was : 0;
  document.getElementById('r_sa').textContent = age.toFixed(1);
  var status = age >= 5 && age <= 15 ? 'Optimal' : age < 5 ? 'Too Low' : 'Too High';
  document.getElementById('r_sa_status').textContent = status;
}
function resetSludgeAge() {
  document.getElementById('sa_mlss').value = '25000';
  document.getElementById('sa_was').value = '2500';
  document.getElementById('r_sa').textContent = '-';
  document.getElementById('r_sa_status').textContent = '-';
}

// Percent Removal (Universal)
function calcRemoval() {
  var inf = parseFloat(document.getElementById('rem_in').value) || 0;
  var eff = parseFloat(document.getElementById('rem_out').value) || 0;
  var amt = inf - eff;
  var pct = inf > 0 ? (amt / inf) * 100 : 0;
  document.getElementById('r_rem_amt').textContent = amt.toFixed(1);
  document.getElementById('r_rem_pct').textContent = pct.toFixed(1);
}
function resetRemoval() {
  document.getElementById('rem_in').value = '200';
  document.getElementById('rem_out').value = '20';
  document.getElementById('r_rem_amt').textContent = '-';
  document.getElementById('r_rem_pct').textContent = '-';
}

// Flow Unit Converter
function calcFlowConv() {
  var value = parseFloat(document.getElementById('conv_flow').value) || 0;
  var unit = document.getElementById('conv_unit').value;
  var mgd;
  // Convert to MGD first
  switch(unit) {
    case 'mgd': mgd = value; break;
    case 'gpm': mgd = value * 1440 / 1000000; break;
    case 'gpd': mgd = value / 1000000; break;
    case 'cfs': mgd = value * 0.6463; break;
    case 'm3d': mgd = value / 3785.41; break;
    case 'lps': mgd = value * 0.0228; break;
    default: mgd = value;
  }
  // Convert from MGD to all units
  document.getElementById('r_conv_mgd').textContent = mgd.toFixed(4);
  document.getElementById('r_conv_gpm').textContent = (mgd * 1000000 / 1440).toFixed(1);
  document.getElementById('r_conv_gpd').textContent = (mgd * 1000000).toFixed(0);
  document.getElementById('r_conv_cfs').textContent = (mgd / 0.6463).toFixed(3);
  document.getElementById('r_conv_m3d').textContent = (mgd * 3785.41).toFixed(1);
  document.getElementById('r_conv_lps').textContent = (mgd / 0.0228).toFixed(2);
}
function resetFlowConv() {
  document.getElementById('conv_flow').value = '5.0';
  document.getElementById('conv_unit').value = 'mgd';
  ['r_conv_mgd','r_conv_gpm','r_conv_gpd','r_conv_cfs','r_conv_m3d','r_conv_lps'].forEach(id => document.getElementById(id).textContent = '-');
}

// Blower Noise Estimation
function calcNoise() {
  var hp = parseFloat(document.getElementById('noise_hp').value) || 0;
  var dist = parseFloat(document.getElementById('noise_dist').value) || 50;
  var num = parseFloat(document.getElementById('noise_num').value) || 1;
  // Rough estimate: base 85 dB at 3ft for 100HP, +3dB per doubling of HP
  var baseDb = 85 + 10 * Math.log10(hp / 100);
  // Distance attenuation: -6dB per doubling of distance from 3ft
  var distDb = baseDb - 20 * Math.log10(dist / 3);
  // Multiple sources: +3dB per doubling
  var totalDb = distDb + 10 * Math.log10(num);
  document.getElementById('r_noise_db').textContent = totalDb.toFixed(1);
  var status = totalDb < 65 ? 'Acceptable' : totalDb < 85 ? 'Caution - Hearing Protection' : 'Dangerous';
  document.getElementById('r_noise_status').textContent = status;
}
function resetNoise() {
  document.getElementById('noise_hp').value = '100';
  document.getElementById('noise_dist').value = '50';
  document.getElementById('noise_num').value = '2';
  document.getElementById('r_noise_db').textContent = '-';
  document.getElementById('r_noise_status').textContent = '-';
}

// Carbon Footprint Estimator
function calcCarbon() {
  var kwh = parseFloat(document.getElementById('carbon_kwh').value) || 0;
  var chem = parseFloat(document.getElementById('carbon_chem').value) || 0;
  var biogas = parseFloat(document.getElementById('carbon_biogas').value) || 0;
  // Energy: ~1.0 lb CO2/kWh (varies by grid)
  var energyCO2 = kwh * 1.0;
  // Chemicals: estimate ~0.5 lb CO2/lb chemical
  var chemCO2 = chem * 0.5;
  // Biogas offset: ~0.12 lb CO2/cf methane avoided
  var offsetCO2 = biogas * 0.6 * 0.12; // 60% methane
  var netCO2 = energyCO2 + chemCO2 - offsetCO2;
  document.getElementById('r_carbon_energy').textContent = energyCO2.toFixed(0);
  document.getElementById('r_carbon_chem').textContent = chemCO2.toFixed(0);
  document.getElementById('r_carbon_offset').textContent = offsetCO2.toFixed(0);
  document.getElementById('r_carbon_net').textContent = netCO2.toFixed(0);
}
function resetCarbon() {
  document.getElementById('carbon_kwh').value = '5000';
  document.getElementById('carbon_chem').value = '500';
  document.getElementById('carbon_biogas').value = '10000';
  ['r_carbon_energy','r_carbon_chem','r_carbon_offset','r_carbon_net'].forEach(id => document.getElementById(id).textContent = '-');
}

// Treatment Cost Analysis
function calcTreatmentCost() {
  var flow = parseFloat(document.getElementById('cost_flow').value) || 0;
  var energy = parseFloat(document.getElementById('cost_energy').value) || 0;
  var chem = parseFloat(document.getElementById('cost_chem').value) || 0;
  var labor = parseFloat(document.getElementById('cost_labor').value) || 0;
  var sludge = parseFloat(document.getElementById('cost_sludge').value) || 0;
  var total = energy + chem + labor + sludge;
  var perMG = flow > 0 ? total / flow : 0;
  var perKgal = perMG / 1000;
  var monthly = total * 30;
  var yearly = total * 365;
  document.getElementById('r_cost_total').textContent = '$' + total.toFixed(0);
  document.getElementById('r_cost_mg').textContent = '$' + perMG.toFixed(2);
  document.getElementById('r_cost_kgal').textContent = '$' + perKgal.toFixed(3);
  document.getElementById('r_cost_month').textContent = '$' + monthly.toLocaleString();
  document.getElementById('r_cost_year').textContent = '$' + yearly.toLocaleString();
}
function resetTreatmentCost() {
  document.getElementById('cost_flow').value = '5.0';
  document.getElementById('cost_energy').value = '1500';
  document.getElementById('cost_chem').value = '800';
  document.getElementById('cost_labor').value = '2000';
  document.getElementById('cost_sludge').value = '500';
  ['r_cost_total','r_cost_mg','r_cost_kgal','r_cost_month','r_cost_year'].forEach(id => document.getElementById(id).textContent = '-');
}

// ========== END ENHANCED CALCULATORS ==========


// ========== MASTER SYNC FUNCTIONS - See v9.6.0 syncMasterToAll below ==========
// Old sync functions removed - using consolidated version

// ========== GUIDED WIZARDS SYSTEM v9.6.0 ==========

var wizardData = {
  tss: {
    title: 'üî¥ High Effluent TSS Troubleshooting',
    color: '#dc2626',
    steps: {
      start: {
        question: 'Is the effluent TSS consistently high (>30 mg/L) or intermittently high?',
        answers: [
          { text: 'Consistently high (every day)', next: 'tss_consistent' },
          { text: 'Intermittent (spikes periodically)', next: 'tss_intermittent' }
        ]
      },
      tss_consistent: {
        question: 'What does the secondary clarifier look like?',
        answers: [
          { text: 'Sludge blanket is high (>3 ft)', next: 'tss_high_blanket' },
          { text: 'Floating/rising sludge observed', next: 'tss_rising' },
          { text: 'Billowing/bulking sludge', next: 'result_severe_bulking' },
          { text: 'Clarifier looks normal', next: 'tss_clarifier_ok' }
        ]
      },
      tss_intermittent: {
        question: 'When do the TSS spikes occur?',
        answers: [
          { text: 'During high flow events', next: 'result_hydraulic_overload' },
          { text: 'After RAS/WAS changes', next: 'result_ras_changes' },
          { text: 'Random/no pattern', next: 'result_toxic_load' },
          { text: 'Morning/startup periods', next: 'result_overnight_buildup' }
        ]
      },
      tss_high_blanket: {
        question: 'What is your current SRT (Sludge Retention Time)?',
        answers: [
          { text: 'SRT > 15 days (high)', next: 'result_increase_was' },
          { text: 'SRT 8-15 days (normal)', next: 'result_increase_ras' },
          { text: 'SRT < 8 days (low)', next: 'result_young_sludge' }
        ]
      },
      tss_rising: {
        question: 'Is nitrogen gas (denitrification) causing the rising sludge?',
        answers: [
          { text: 'Yes - bubbles visible, sludge floats then sinks', next: 'result_denitrification' },
          { text: 'No - sludge stays floating, greasy/foamy', next: 'result_septicity' }
        ]
      },
      tss_clarifier_ok: {
        question: 'Check the aeration basin. What do you observe?',
        answers: [
          { text: 'Foaming on surface', next: 'result_nocardia' },
          { text: 'Dark/black mixed liquor', next: 'result_septicity_basin' },
          { text: 'Light tan/brown, looks healthy', next: 'result_check_weirs' },
          { text: 'Very light color, thin floc', next: 'result_young_sludge' }
        ]
      }
    },
    results: {
      result_increase_was: { diagnosis: 'Excessive Sludge Inventory', cause: 'SRT is too high, causing excessive solids inventory. The clarifier cannot handle the solids load.', actions: ['Increase WAS rate by 10-15% incrementally', 'Target SRT of 8-12 days for conventional AS', 'Monitor sludge blanket daily until <2 ft', 'Verify WAS pumps and flow meters accurate'], severity: 'moderate' },
      result_young_sludge: { diagnosis: 'Young Sludge / Low SRT', cause: 'SRT is too low, resulting in young, poorly-settling sludge with dispersed growth.', actions: ['Reduce WAS rate immediately by 25-50%', 'Target MLSS of 2500-3500 mg/L', 'Allow 1-2 SRTs for sludge to mature', 'Consider adding polymer temporarily'], severity: 'high' },
      result_denitrification: { diagnosis: 'Denitrification in Clarifier', cause: 'Nitrate-rich sludge sitting too long in clarifier, releasing nitrogen gas.', actions: ['Increase RAS rate to reduce detention time', 'Target sludge blanket < 2 ft', 'Consider adding anoxic zone before clarifier', 'Check for septicity in collection system'], severity: 'moderate' },
      result_septicity: { diagnosis: 'Septic Conditions', cause: 'Anaerobic conditions developing in clarifier or sludge, causing gas production.', actions: ['Increase RAS pumping rate immediately', 'Check for sludge buildup in pipes/channels', 'Verify clarifier collector is working', 'May need to waste heavily and rebuild'], severity: 'high' },
      result_severe_bulking: { diagnosis: 'Severe Filamentous Bulking', cause: 'Excessive filamentous bacteria causing severe settling problems.', actions: ['Run Filamentous Bulking Wizard for detailed diagnosis', 'Consider chlorinating RAS (2-5 mg/L Cl‚ÇÇ)', 'Add polymer to clarifier (0.5-2 mg/L)', 'Address F/M ratio and selector zones'], severity: 'critical' },
      result_hydraulic_overload: { diagnosis: 'Hydraulic Overload', cause: 'Clarifier surface overflow rate exceeds design capacity during high flows.', actions: ['Equalize flows if possible', 'Bring additional clarifiers online', 'Review flow splitting between clarifiers', 'Evaluate clarifier capacity expansion'], severity: 'high' },
      result_ras_changes: { diagnosis: 'RAS/WAS Adjustment Impact', cause: 'Recent RAS or WAS changes have disrupted sludge balance.', actions: ['Review recent operational changes', 'Gradually return to previous settings', 'Monitor blanket depth response', 'Make changes incrementally in future'], severity: 'moderate' },
      result_toxic_load: { diagnosis: 'Toxic/Industrial Upset', cause: 'Industrial discharge has upset biological process, causing floc breakup.', actions: ['Identify and stop toxic source', 'Reduce WAS to preserve healthy biomass', 'Consider adding PAC', 'Monitor recovery over 1-3 SRTs'], severity: 'critical' },
      result_overnight_buildup: { diagnosis: 'Overnight Sludge Blanket Buildup', cause: 'RAS rate during low-flow periods not maintaining blanket control.', actions: ['Increase nighttime RAS rate', 'Consider RAS pacing based on time', 'Verify RAS pumps operate continuously', 'Check for timer or control issues'], severity: 'moderate' },
      result_increase_ras: { diagnosis: 'Low RAS Rate', cause: 'RAS rate insufficient to return solids and maintain proper blanket level.', actions: ['Increase RAS rate to 50-75% of influent', 'Monitor blanket depth response', 'Verify RAS pumps have adequate capacity', 'Check for air binding in RAS lines'], severity: 'moderate' },
      result_nocardia: { diagnosis: 'Nocardia/Foam-Causing Organisms', cause: 'Nocardia or similar foam-causing filaments present.', actions: ['Reduce SRT to 8-10 days', 'Improve grease/scum removal', 'Spray water or defoamer on foam', 'Consider chlorine spray on foam'], severity: 'moderate' },
      result_septicity_basin: { diagnosis: 'Septic Mixed Liquor', cause: 'Aeration basin has gone septic due to insufficient oxygen.', actions: ['Check all blowers and diffusers immediately', 'Verify DO > 2.0 mg/L throughout basin', 'Check for plugged diffusers', 'May need to increase air flow significantly'], severity: 'critical' },
      result_check_weirs: { diagnosis: 'Effluent Weir Issues', cause: 'Uneven or dirty weirs may be causing carryover.', actions: ['Level all weirs to within 1/8 inch', 'Clean weirs of algae and debris', 'Check weir loading rate', 'Consider V-notch weirs for better distribution'], severity: 'low' }
    }
  },
  bulking: {
    title: 'üü† Filamentous Bulking Troubleshooting',
    color: '#d97706',
    steps: {
      start: {
        question: 'What is your current SVI (Sludge Volume Index)?',
        answers: [
          { text: 'SVI > 250 (severe bulking)', next: 'bulk_severe' },
          { text: 'SVI 150-250 (moderate bulking)', next: 'bulk_moderate' },
          { text: 'SVI 100-150 (borderline)', next: 'result_bulk_monitor' },
          { text: 'Don\'t know - need to test', next: 'result_bulk_test_svi' }
        ]
      },
      bulk_severe: {
        question: 'Have you identified the filament type microscopically?',
        answers: [
          { text: 'Yes - Nocardia/foam formers', next: 'result_bulk_nocardia' },
          { text: 'Yes - Type 021N (sulfide)', next: 'result_bulk_sulfide' },
          { text: 'Yes - Type 1701 (low DO)', next: 'result_bulk_low_do' },
          { text: 'No - haven\'t identified', next: 'bulk_check_conditions' }
        ]
      },
      bulk_moderate: {
        question: 'What is your current F/M ratio?',
        answers: [
          { text: 'F/M < 0.15 (very low)', next: 'result_bulk_low_fm' },
          { text: 'F/M 0.15-0.5 (normal range)', next: 'bulk_check_do' },
          { text: 'F/M > 0.5 (high)', next: 'result_bulk_high_fm' }
        ]
      },
      bulk_check_conditions: {
        question: 'What is your typical DO level in the aeration basin?',
        answers: [
          { text: 'DO < 1.0 mg/L (low)', next: 'result_bulk_low_do' },
          { text: 'DO 1.0-2.0 mg/L', next: 'bulk_check_nutrients' },
          { text: 'DO > 2.0 mg/L (good)', next: 'bulk_check_nutrients' }
        ]
      },
      bulk_check_do: {
        question: 'What is your DO level throughout the aeration basin?',
        answers: [
          { text: 'DO < 1.0 mg/L anywhere', next: 'result_bulk_low_do' },
          { text: 'DO consistently > 1.5 mg/L', next: 'bulk_check_nutrients' }
        ]
      },
      bulk_check_nutrients: {
        question: 'Is there septic wastewater or sulfide in your influent?',
        answers: [
          { text: 'Yes - septic odors, black color', next: 'result_bulk_sulfide' },
          { text: 'No - typical municipal wastewater', next: 'result_bulk_selector' }
        ]
      }
    },
    results: {
      result_bulk_test_svi: { diagnosis: 'SVI Testing Required', cause: 'Cannot diagnose bulking without SVI data.', actions: ['Perform settleability test (30 min)', 'Calculate SVI = (Settled Vol √ó 1000) / MLSS', 'Normal SVI: 80-150 mL/g', 'Test daily until trend established'], severity: 'low' },
      result_bulk_nocardia: { diagnosis: 'Nocardia/Foam-Forming Filaments', cause: 'Associated with high SRT and fats/grease. Causes thick brown foam.', actions: ['Reduce SRT to 8-10 days', 'Improve FOG removal at headworks', 'Spray foam with water/chlorine', 'Ensure complete scum removal'], severity: 'high' },
      result_bulk_sulfide: { diagnosis: 'Sulfide-Related Bulking', cause: 'Sulfide-oxidizing filaments (Type 021N, Thiothrix) thrive with sulfide.', actions: ['Add ferric chloride at headworks (20-50 mg/L)', 'Eliminate septic conditions', 'Aerate collection system', 'Monitor influent for sulfide'], severity: 'high' },
      result_bulk_low_do: { diagnosis: 'Low DO Filamentous Bulking', cause: 'Insufficient DO favors filamentous bacteria (Type 1701, S. natans).', actions: ['Increase DO to > 2.0 mg/L everywhere', 'Check for plugged diffusers', 'Verify blower capacity', 'Eliminate dead zones'], severity: 'high' },
      result_bulk_monitor: { diagnosis: 'Borderline SVI - Monitor', cause: 'SVI is borderline but stable. Vigilance needed.', actions: ['Continue daily SVI monitoring', 'Document any process changes', 'Watch for upward trend', 'Maintain current conditions'], severity: 'low' },
      result_bulk_low_fm: { diagnosis: 'Low F/M Ratio Bulking', cause: 'Low F/M favors slow-growing filamentous bacteria.', actions: ['Reduce MLSS by increasing WAS', 'Target F/M of 0.2-0.4', 'Consider step-feed or selector', 'Takes 2-3 SRTs to improve'], severity: 'moderate' },
      result_bulk_high_fm: { diagnosis: 'High F/M - Unusual with Bulking', cause: 'High F/M is unusual with bulking. Check measurements.', actions: ['Verify MLSS and BOD measurements', 'Recalculate F/M ratio', 'Check for nutrient deficiency', 'Consider dispersed growth issues'], severity: 'low' },
      result_bulk_selector: { diagnosis: 'Consider Selector Zone', cause: 'Completely mixed systems favor filamentous growth.', actions: ['Evaluate space for selector', 'Design for F/M > 3 in selector', 'Consider anaerobic selector', 'Short-term: try step-feed'], severity: 'moderate' }
    }
  },
  ammonia: {
    title: 'üîµ High Effluent Ammonia Troubleshooting',
    color: '#2563eb',
    steps: {
      start: {
        question: 'How high is your effluent ammonia compared to permit?',
        answers: [
          { text: 'Significantly over (>5 mg/L excess)', next: 'nh3_severe' },
          { text: 'Moderately over (1-5 mg/L excess)', next: 'nh3_moderate' },
          { text: 'Slightly over or trending up', next: 'nh3_trending' }
        ]
      },
      nh3_severe: {
        question: 'Is this a sudden increase or gradual decline?',
        answers: [
          { text: 'Sudden - happened within days', next: 'nh3_sudden' },
          { text: 'Gradual - increasing over weeks', next: 'nh3_gradual' }
        ]
      },
      nh3_moderate: {
        question: 'What is your current SRT?',
        answers: [
          { text: 'SRT < 8 days', next: 'result_nh3_low_srt' },
          { text: 'SRT 8-15 days', next: 'nh3_check_do' },
          { text: 'SRT > 15 days', next: 'nh3_check_do' }
        ]
      },
      nh3_trending: {
        question: 'What seasonal conditions exist?',
        answers: [
          { text: 'Winter/cold temperatures', next: 'result_nh3_cold' },
          { text: 'Summer/warm temperatures', next: 'nh3_check_do' },
          { text: 'No significant temp change', next: 'nh3_check_do' }
        ]
      },
      nh3_sudden: {
        question: 'Have there been any toxic loads or industrial upsets?',
        answers: [
          { text: 'Yes - known toxic event', next: 'result_nh3_toxic' },
          { text: 'Possible - suspicious influent', next: 'result_nh3_toxic' },
          { text: 'No - influent appears normal', next: 'nh3_check_operations' }
        ]
      },
      nh3_gradual: {
        question: 'Has influent ammonia loading increased?',
        answers: [
          { text: 'Yes - higher NH‚ÇÉ loading', next: 'result_nh3_overload' },
          { text: 'No - loading is stable', next: 'nh3_check_do' }
        ]
      },
      nh3_check_do: {
        question: 'What DO level in nitrification zone?',
        answers: [
          { text: 'DO < 1.5 mg/L', next: 'result_nh3_low_do' },
          { text: 'DO 1.5-3.0 mg/L', next: 'nh3_check_alk' },
          { text: 'DO > 3.0 mg/L', next: 'nh3_check_alk' }
        ]
      },
      nh3_check_operations: {
        question: 'Any recent operational changes?',
        answers: [
          { text: 'Increased wasting (higher WAS)', next: 'result_nh3_overwaste' },
          { text: 'Changed aeration pattern', next: 'result_nh3_low_do' },
          { text: 'No changes made', next: 'nh3_check_alk' }
        ]
      },
      nh3_check_alk: {
        question: 'What is your effluent alkalinity?',
        answers: [
          { text: 'Alkalinity < 50 mg/L as CaCO‚ÇÉ', next: 'result_nh3_low_alk' },
          { text: 'Alkalinity 50-100 mg/L', next: 'result_nh3_comprehensive' },
          { text: 'Alkalinity > 100 mg/L', next: 'result_nh3_comprehensive' }
        ]
      }
    },
    results: {
      result_nh3_low_srt: { diagnosis: 'SRT Too Low for Nitrification', cause: 'Nitrifiers grow slowly. SRT must prevent washout, especially when cold.', actions: ['Reduce WAS rate to increase SRT', 'Target: 10 days at 20¬∞C, 20+ days at 10¬∞C', 'Monitor MLSS - allow to increase', 'May take 2-4 weeks to establish nitrifiers'], severity: 'high' },
      result_nh3_cold: { diagnosis: 'Cold Temperature Inhibition', cause: 'Nitrification rate decreases ~50% for every 10¬∞C drop.', actions: ['Increase SRT significantly (20-30 days at <15¬∞C)', 'Reduce WAS rate', 'Accept longer recovery time in spring', 'Monitor closely during temp transitions'], severity: 'high' },
      result_nh3_toxic: { diagnosis: 'Toxic Load - Nitrifier Kill', cause: 'Toxic event has killed/inhibited nitrifying bacteria.', actions: ['Stop or divert toxic source', 'Reduce WAS to preserve remaining nitrifiers', 'Expect 2-6 weeks recovery', 'Consider temporary permit variance'], severity: 'critical' },
      result_nh3_overload: { diagnosis: 'Ammonia Overload', cause: 'Influent ammonia load exceeds nitrification capacity.', actions: ['Increase SRT if possible', 'Increase aeration capacity', 'Investigate source of increased loading', 'Consider flow equalization'], severity: 'high' },
      result_nh3_low_do: { diagnosis: 'Low DO Inhibiting Nitrification', cause: 'Nitrifiers require DO > 2.0 mg/L for optimal activity.', actions: ['Increase DO to > 2.0 mg/L', 'May need 3-4 mg/L if heavily loaded', 'Check blower capacity', 'Clean or replace diffusers'], severity: 'high' },
      result_nh3_overwaste: { diagnosis: 'Excessive Wasting', cause: 'Increased WAS has reduced SRT below nitrifier needs.', actions: ['Reduce WAS rate immediately', 'Calculate new SRT', 'Target SRT > 10 days', 'Allow 2-4 weeks for recovery'], severity: 'high' },
      result_nh3_low_alk: { diagnosis: 'Alkalinity Limitation', cause: 'Nitrification consumes ~7.1 mg alk per mg NH‚ÇÉ-N oxidized.', actions: ['Add alkalinity (lime, soda ash, bicarb)', 'Target effluent alk > 50 mg/L', 'Calculate: 7.1 √ó NH‚ÇÉ removed', 'Monitor pH and alkalinity daily'], severity: 'high' },
      result_nh3_comprehensive: { diagnosis: 'Comprehensive Analysis Needed', cause: 'No single obvious cause. Multiple factors may be involved.', actions: ['Perform complete nitrification audit', 'Profile DO, pH, temp throughout system', 'Review all operational data trends', 'Consider process consultant'], severity: 'moderate' }
    }
  },
  lowdo: {
    title: 'üü¢ Low DO Troubleshooting',
    color: '#059669',
    steps: {
      start: {
        question: 'Where is the DO problem occurring?',
        answers: [
          { text: 'Entire basin uniformly low', next: 'do_all_low' },
          { text: 'Only certain zones low', next: 'do_zones_low' },
          { text: 'DO fluctuates widely', next: 'do_fluctuating' },
          { text: 'Cannot reach setpoint at max air', next: 'do_max_air' }
        ]
      },
      do_all_low: {
        question: 'Is the blower at full capacity?',
        answers: [
          { text: 'Yes - blower at 100%', next: 'do_blower_maxed' },
          { text: 'No - has more capacity', next: 'result_do_controls' }
        ]
      },
      do_zones_low: {
        question: 'Which zones have low DO?',
        answers: [
          { text: 'First zone / head of basin', next: 'result_do_high_loading' },
          { text: 'Last zone or middle zones', next: 'do_check_diffusers' },
          { text: 'Random/scattered areas', next: 'result_do_diffuser_pattern' }
        ]
      },
      do_fluctuating: {
        question: 'What pattern does the DO follow?',
        answers: [
          { text: 'Follows diurnal flow pattern', next: 'result_do_diurnal' },
          { text: 'Correlates with blower cycling', next: 'result_do_blower_cycling' },
          { text: 'Random with no pattern', next: 'result_do_calibrate' }
        ]
      },
      do_max_air: {
        question: 'What changed to increase oxygen demand?',
        answers: [
          { text: 'Higher influent BOD/loading', next: 'result_do_overloaded' },
          { text: 'Increased MLSS concentration', next: 'result_do_high_mlss' },
          { text: 'Warmer temperatures', next: 'result_do_temperature' },
          { text: 'No changes - always been this way', next: 'do_check_diffusers' }
        ]
      },
      do_blower_maxed: {
        question: 'Are all blowers online and operational?',
        answers: [
          { text: 'Yes - all blowers running', next: 'do_check_diffusers' },
          { text: 'No - one or more down', next: 'result_do_blower_down' }
        ]
      },
      do_check_diffusers: {
        question: 'When were diffusers last inspected/cleaned?',
        answers: [
          { text: 'Within last year', next: 'result_do_distribution' },
          { text: '1-3 years ago', next: 'result_do_clean_diffusers' },
          { text: 'More than 3 years / never', next: 'result_do_replace_diffusers' }
        ]
      }
    },
    results: {
      result_do_controls: { diagnosis: 'DO Control System Issue', cause: 'Controls not calling for more air despite low DO.', actions: ['Check DO sensor calibration', 'Verify controller setpoint', 'Check control valve/VFD operation', 'Switch to manual temporarily'], severity: 'moderate' },
      result_do_high_loading: { diagnosis: 'High Oxygen Demand - First Zone', cause: 'First zone receives highest loading. Normal for lower DO.', actions: ['Redistribute air to first zone', 'Consider step-feed operation', 'First zone DO > 0.5 mg/L often acceptable', 'Evaluate tapered aeration'], severity: 'moderate' },
      result_do_diffuser_pattern: { diagnosis: 'Diffuser Distribution Problem', cause: 'Random low DO areas indicate uneven air distribution.', actions: ['Walk basin looking for dead zones', 'Listen for uneven bubbling', 'Check for damaged drop pipes', 'May need drain and inspect'], severity: 'moderate' },
      result_do_diurnal: { diagnosis: 'Diurnal Load Variation', cause: 'DO drops during peak loading periods.', actions: ['Normal operation - adjust DO strategy', 'Increase blower capacity during peaks', 'Flow equalization can help', 'Consider MOV control'], severity: 'low' },
      result_do_blower_cycling: { diagnosis: 'Blower Control Issues', cause: 'DO fluctuates as blowers cycle on/off.', actions: ['Review blower staging logic', 'Adjust PID control parameters', 'Consider VFD for smoother operation', 'Check blower turndown ratio'], severity: 'moderate' },
      result_do_calibrate: { diagnosis: 'DO Sensor Calibration Needed', cause: 'Sensor may be reading incorrectly.', actions: ['Calibrate DO sensor immediately', 'Use air-saturated water', 'Check membrane condition', 'Establish regular calibration schedule'], severity: 'moderate' },
      result_do_overloaded: { diagnosis: 'Organic Overload', cause: 'BOD loading exceeds oxygen transfer capacity.', actions: ['Verify loading increase', 'Maximize aeration capacity', 'Consider reducing MLSS', 'Identify loading source'], severity: 'high' },
      result_do_high_mlss: { diagnosis: 'High MLSS Oxygen Demand', cause: 'Elevated MLSS increases endogenous respiration demand.', actions: ['Increase WAS to reduce MLSS', 'Target appropriate MLSS', 'Higher MLSS = higher O‚ÇÇ demand', 'May take several days to see effect'], severity: 'moderate' },
      result_do_temperature: { diagnosis: 'Temperature Effect on DO', cause: 'Warm temps increase demand and decrease solubility.', actions: ['Normal summer condition', 'Increase blower output', 'May need to reduce MLSS in summer', 'Monitor during transition periods'], severity: 'moderate' },
      result_do_blower_down: { diagnosis: 'Insufficient Blower Capacity', cause: 'Remaining blower capacity is insufficient.', actions: ['Prioritize blower repair', 'Consider rental blower', 'Reduce MLSS to lower demand', 'Document for compliance'], severity: 'critical' },
      result_do_distribution: { diagnosis: 'Air Distribution Problem', cause: 'Normal pressure but air not reaching where needed.', actions: ['Check air flow to zones', 'Balance distribution valves', 'Look for air piping leaks', 'Check for hydraulic short-circuiting'], severity: 'moderate' },
      result_do_clean_diffusers: { diagnosis: 'Diffuser Fouling Likely', cause: 'Diffusers foul over time, reducing efficiency.', actions: ['Plan diffuser cleaning', 'Consider in-situ acid cleaning', 'Typical interval: 1-3 years', 'Monitor pressure trend after cleaning'], severity: 'moderate' },
      result_do_replace_diffusers: { diagnosis: 'Diffuser Replacement Needed', cause: 'Diffusers beyond useful life.', actions: ['Plan replacement project', 'Consider upgrading to high-efficiency', 'Typical life: 10-15 years', 'Evaluate alternative technologies'], severity: 'high' }
    }
  },
  foam: {
    title: 'üü§ Foam/Scum Troubleshooting',
    color: '#92400e',
    steps: {
      start: {
        question: 'What type of foam are you experiencing?',
        answers: [
          { text: 'Thick brown/tan foam (greasy, doesn\'t break)', next: 'foam_nocardia' },
          { text: 'White/gray billowing foam', next: 'foam_white' },
          { text: 'Dark black foam', next: 'foam_black' },
          { text: 'Scum accumulation on clarifier', next: 'foam_scum' }
        ]
      },
      foam_nocardia: {
        question: 'What is your current SRT (Sludge Retention Time)?',
        answers: [
          { text: 'SRT > 15 days', next: 'result_foam_high_srt' },
          { text: 'SRT 10-15 days', next: 'foam_check_fog' },
          { text: 'SRT < 10 days', next: 'foam_check_fog' }
        ]
      },
      foam_check_fog: {
        question: 'Do you have significant FOG (Fats, Oil, Grease) in influent?',
        answers: [
          { text: 'Yes - grease visible, FOG program issues', next: 'result_foam_fog' },
          { text: 'No - FOG under control', next: 'result_foam_microthrix' }
        ]
      },
      foam_white: {
        question: 'When did the white foam start?',
        answers: [
          { text: 'After plant startup or upset', next: 'result_foam_young_sludge' },
          { text: 'During high loading periods', next: 'result_foam_surfactants' },
          { text: 'Gradually increased over time', next: 'result_foam_detergents' }
        ]
      },
      foam_black: {
        question: 'Is there a septic odor associated with the foam?',
        answers: [
          { text: 'Yes - strong H‚ÇÇS smell', next: 'result_foam_septic' },
          { text: 'No - just dark color', next: 'result_foam_old_sludge' }
        ]
      },
      foam_scum: {
        question: 'What does the clarifier scum look like?',
        answers: [
          { text: 'Greasy, thick, tan/brown', next: 'result_foam_nocardia_clarifier' },
          { text: 'Floating sludge clumps', next: 'result_foam_denitrification' },
          { text: 'Algae/green growth', next: 'result_foam_algae' }
        ]
      }
    },
    results: {
      result_foam_high_srt: { diagnosis: 'Nocardia/High SRT Foam', cause: 'Nocardia and similar organisms thrive at high SRTs. They produce stable foam that traps grease.', actions: ['Reduce SRT to 8-10 days', 'Increase WAS rate gradually', 'Spray foam with water jets', 'Consider chlorine spray (10-20 mg/L) on foam', 'Improve surface wasting'], severity: 'high' },
      result_foam_fog: { diagnosis: 'FOG-Related Foaming', cause: 'Excess fats, oils, and grease provide substrate for foam-forming bacteria.', actions: ['Enforce FOG program with dischargers', 'Improve grease trap inspections', 'Add DAF or FOG removal at headworks', 'Consider enzyme addition', 'Reduce SRT if also elevated'], severity: 'high' },
      result_foam_microthrix: { diagnosis: 'Microthrix parvicella Foam', cause: 'This filament causes foam at lower SRTs, especially with fats present.', actions: ['Improve primary treatment for FOG', 'Consider anoxic selector', 'Maintain DO > 2 mg/L', 'Aluminum salt addition can help', 'Target SRT 8-12 days'], severity: 'moderate' },
      result_foam_young_sludge: { diagnosis: 'Young Sludge / Startup Foam', cause: 'New or upset sludge produces light billowing foam due to surfactants and dispersed growth.', actions: ['Allow time for sludge to mature', 'Reduce WAS rate temporarily', 'Add polymer if severe', 'Foam will reduce as MLSS increases', 'Normal during startup - 2-4 weeks'], severity: 'low' },
      result_foam_surfactants: { diagnosis: 'Surfactant/Detergent Loading', cause: 'Industrial or domestic surfactants causing foam during high loading.', actions: ['Identify source of surfactants', 'Contact industrial users', 'Consider defoamers temporarily', 'Improve equalization', 'Usually self-correcting'], severity: 'moderate' },
      result_foam_detergents: { diagnosis: 'Chronic Detergent Foam', cause: 'Ongoing surfactant loading from service area.', actions: ['Survey industrial dischargers', 'Consider ordinance enforcement', 'Mechanical defoaming', 'Spray bars over aeration', 'May need pretreatment'], severity: 'moderate' },
      result_foam_septic: { diagnosis: 'Septic Foam', cause: 'Anaerobic conditions producing gases and dark foam.', actions: ['Increase aeration immediately', 'Check for dead zones', 'Verify DO throughout basin', 'May indicate serious process upset', 'Address root cause of septicity'], severity: 'critical' },
      result_foam_old_sludge: { diagnosis: 'Old Sludge Foam', cause: 'Very old, dark sludge can produce foam as cells lyse.', actions: ['Increase wasting rate', 'Reduce SRT to target range', 'Check for return sludge issues', 'Monitor MLSS trend', 'Usually clears with younger sludge'], severity: 'moderate' },
      result_foam_nocardia_clarifier: { diagnosis: 'Nocardia Scum on Clarifier', cause: 'Nocardia foam accumulates on clarifier surface.', actions: ['Improve scum removal system', 'Check scum baffles and beach', 'Increase scum pumping', 'Address Nocardia at source (reduce SRT)', 'Chlorinate scum beach area'], severity: 'high' },
      result_foam_denitrification: { diagnosis: 'Denitrification Floating Sludge', cause: 'Nitrogen gas from denitrification floating sludge.', actions: ['Increase RAS rate', 'Reduce clarifier detention time', 'Add anoxic zone before clarifier', 'Check for septicity', 'See TSS Wizard for more'], severity: 'moderate' },
      result_foam_algae: { diagnosis: 'Algae Growth on Clarifier', cause: 'Sunlight promoting algae growth on clarifier surfaces.', actions: ['Consider clarifier covers', 'Increase scum removal', 'Brush weirs regularly', 'Chlorinate if severe', 'Mostly aesthetic issue'], severity: 'low' }
    }
  },
  odor: {
    title: 'üëÉ Odor Control Troubleshooting',
    color: '#7c2d12',
    steps: {
      start: {
        question: 'Where is the odor originating?',
        answers: [
          { text: 'Headworks/influent', next: 'odor_headworks' },
          { text: 'Primary clarifiers', next: 'odor_primary' },
          { text: 'Aeration basins', next: 'odor_aeration' },
          { text: 'Secondary clarifiers', next: 'odor_secondary' },
          { text: 'Solids handling/digesters', next: 'odor_solids' },
          { text: 'Throughout plant', next: 'odor_widespread' }
        ]
      },
      odor_headworks: {
        question: 'What type of odor at headworks?',
        answers: [
          { text: 'Rotten egg (H‚ÇÇS)', next: 'result_odor_h2s_headworks' },
          { text: 'Musty/earthy', next: 'result_odor_musty' },
          { text: 'Chemical/solvent', next: 'result_odor_industrial' }
        ]
      },
      odor_primary: {
        question: 'Is primary sludge being removed regularly?',
        answers: [
          { text: 'No - sludge builds up', next: 'result_odor_primary_sludge' },
          { text: 'Yes - still have odors', next: 'result_odor_primary_septic' }
        ]
      },
      odor_aeration: {
        question: 'What is the DO level in aeration?',
        answers: [
          { text: 'DO < 0.5 mg/L (very low)', next: 'result_odor_low_do' },
          { text: 'DO 0.5-1.5 mg/L (low)', next: 'result_odor_marginal_do' },
          { text: 'DO > 2.0 mg/L (good)', next: 'result_odor_other_source' }
        ]
      },
      odor_secondary: {
        question: 'Is there rising/floating sludge in secondary?',
        answers: [
          { text: 'Yes - sludge floating', next: 'result_odor_denit' },
          { text: 'No - sludge settles normally', next: 'result_odor_scum' }
        ]
      },
      odor_solids: {
        question: 'What solids process has the odor?',
        answers: [
          { text: 'Thickener', next: 'result_odor_thickener' },
          { text: 'Digester', next: 'result_odor_digester' },
          { text: 'Dewatering', next: 'result_odor_dewatering' },
          { text: 'Sludge storage', next: 'result_odor_storage' }
        ]
      },
      odor_widespread: {
        question: 'When are odors worst?',
        answers: [
          { text: 'Early morning', next: 'result_odor_inversion' },
          { text: 'During rain events', next: 'result_odor_wet_weather' },
          { text: 'All the time', next: 'result_odor_systemic' }
        ]
      }
    },
    results: {
      result_odor_h2s_headworks: { diagnosis: 'Hydrogen Sulfide from Collection System', cause: 'Septic conditions in sewers producing H‚ÇÇS which off-gasses at headworks.', actions: ['Add ferric chloride in collection system', 'Aerate force mains at discharge', 'Add bioxide or nitrate to sewers', 'Cover headworks and scrub air', 'Investigate long detention times in collection'], severity: 'high' },
      result_odor_musty: { diagnosis: 'Musty/Earthy Odors', cause: 'Often caused by actinomycetes or algae. Less offensive than H‚ÇÇS.', actions: ['Usually biological origin', 'Check for stagnant water areas', 'Improve housekeeping', 'Generally not a health concern', 'Address any algae growth'], severity: 'low' },
      result_odor_industrial: { diagnosis: 'Industrial Chemical Odors', cause: 'Illegal or improper industrial discharge.', actions: ['Sample and analyze influent', 'Investigate industrial users', 'May need enforcement action', 'Document for pretreatment program', 'Consider activated carbon if severe'], severity: 'high' },
      result_odor_primary_sludge: { diagnosis: 'Septic Primary Sludge', cause: 'Infrequent sludge pumping allows primary sludge to go septic.', actions: ['Increase primary sludge pumping frequency', 'Target < 24 hour detention', 'Check sludge pumps operation', 'Consider continuous pumping', 'Monitor sludge blanket depth'], severity: 'high' },
      result_odor_primary_septic: { diagnosis: 'Septic Influent to Primaries', cause: 'Influent arrives septic from collection system.', actions: ['Add aeration/oxidation at headworks', 'Ferric chloride addition', 'Improve collection system', 'Cover and treat primary air', 'Reduce detention in primaries'], severity: 'high' },
      result_odor_low_do: { diagnosis: 'Septic Aeration Basin', cause: 'Severely low DO causing anaerobic conditions and H‚ÇÇS production.', actions: ['Increase aeration immediately', 'Check blowers and diffusers', 'This is emergency situation', 'Reduce loading if possible', 'Process upset likely'], severity: 'critical' },
      result_odor_marginal_do: { diagnosis: 'Marginal DO Causing Odors', cause: 'DO not quite low enough for full septicity but allowing some odor.', actions: ['Increase DO to > 2 mg/L', 'Check for dead zones', 'May have localized septicity', 'Verify DO profile throughout', 'Clean diffusers if needed'], severity: 'moderate' },
      result_odor_other_source: { diagnosis: 'Odor Source Not Aeration', cause: 'DO is adequate. Odor source is elsewhere.', actions: ['Check upwind sources', 'Investigate solids handling', 'Check for spills or illegal dumps', 'May be collection system', 'Systematic odor survey needed'], severity: 'moderate' },
      result_odor_denit: { diagnosis: 'Denitrification Odors', cause: 'Rising sludge releasing trapped gases.', actions: ['Increase RAS rate', 'Reduce clarifier detention', 'Add anoxic zone upstream', 'See TSS Wizard', 'Usually not as offensive as H‚ÇÇS'], severity: 'moderate' },
      result_odor_scum: { diagnosis: 'Scum Accumulation Odors', cause: 'Scum accumulating and going septic on clarifier.', actions: ['Improve scum removal', 'Check scum pumps and baffles', 'Manual removal if needed', 'Regular cleaning schedule', 'Address foam-forming organisms'], severity: 'moderate' },
      result_odor_thickener: { diagnosis: 'Thickener Odors', cause: 'Sludge going septic in thickener.', actions: ['Reduce thickener detention time', 'Pump more frequently', 'Consider chemical addition', 'Cover thickener', 'Dilute if needed'], severity: 'moderate' },
      result_odor_digester: { diagnosis: 'Digester Odors', cause: 'Gas leaks, upset digester, or poor mixing.', actions: ['Check gas system for leaks', 'Verify digester mixing', 'Monitor pH and alkalinity', 'Check gas flare operation', 'May need digester recovery'], severity: 'high' },
      result_odor_dewatering: { diagnosis: 'Dewatering Odors', cause: 'Sludge becoming septic during dewatering or storage.', actions: ['Process sludge more quickly', 'Add lime or polymer', 'Ventilate dewatering area', 'Cover dumpsters/bins', 'More frequent hauling'], severity: 'moderate' },
      result_odor_storage: { diagnosis: 'Sludge Storage Odors', cause: 'Stored sludge going septic.', actions: ['Reduce storage time', 'Add lime for stabilization', 'Cover storage areas', 'More frequent disposal', 'Consider additional treatment'], severity: 'moderate' },
      result_odor_inversion: { diagnosis: 'Weather Inversion Trapping Odors', cause: 'Morning temperature inversions trap odors near ground.', actions: ['Odors worse in early AM, improve by mid-day', 'Address sources but timing is weather-related', 'Focus on covered/treated sources', 'Community communication', 'Normal meteorological phenomenon'], severity: 'low' },
      result_odor_wet_weather: { diagnosis: 'Wet Weather Odors', cause: 'I&I causing septic conditions or resuspension.', actions: ['I&I brings septic water', 'Increase aeration during storms', 'May flush debris and septicity', 'Investigate I&I reduction', 'Usually temporary'], severity: 'moderate' },
      result_odor_systemic: { diagnosis: 'Systemic Plant Odors', cause: 'Multiple sources contributing to plant-wide odors.', actions: ['Comprehensive odor survey needed', 'Prioritize sources by severity', 'May need odor control study', 'Consider covered processes', 'Chemical scrubbers may help'], severity: 'high' }
    }
  },
  nutrient: {
    title: 'üü£ Nutrient Removal Troubleshooting',
    color: '#7e22ce',
    steps: {
      start: {
        question: 'Which nutrient is the problem?',
        answers: [
          { text: 'High phosphorus (TP)', next: 'nutrient_phos' },
          { text: 'High total nitrogen (TN)', next: 'nutrient_tn' },
          { text: 'Both phosphorus and nitrogen', next: 'nutrient_both' }
        ]
      },
      nutrient_phos: {
        question: 'Do you have biological phosphorus removal (Bio-P)?',
        answers: [
          { text: 'Yes - Bio-P/EBPR process', next: 'phos_biop' },
          { text: 'No - chemical removal only', next: 'phos_chem' },
          { text: 'No - no P removal process', next: 'result_phos_add_process' }
        ]
      },
      phos_biop: {
        question: 'What is happening with Bio-P?',
        answers: [
          { text: 'P release in anaerobic zone is low', next: 'result_phos_no_release' },
          { text: 'P release OK but poor uptake in aerobic', next: 'result_phos_poor_uptake' },
          { text: 'Good removal but secondary release', next: 'result_phos_secondary_release' }
        ]
      },
      phos_chem: {
        question: 'What chemical are you using?',
        answers: [
          { text: 'Ferric chloride/sulfate', next: 'phos_chem_ferric' },
          { text: 'Alum', next: 'phos_chem_alum' },
          { text: 'Not enough chemical being added', next: 'result_phos_increase_dose' }
        ]
      },
      phos_chem_ferric: {
        question: 'Where is ferric being added?',
        answers: [
          { text: 'Primary - but P still high', next: 'result_phos_move_feed' },
          { text: 'Secondary - but P still high', next: 'result_phos_check_dose' },
          { text: 'Tertiary - but P still high', next: 'result_phos_tertiary_issue' }
        ]
      },
      phos_chem_alum: {
        question: 'What is your effluent pH?',
        answers: [
          { text: 'pH < 6.0', next: 'result_phos_ph_low' },
          { text: 'pH 6.0-7.5', next: 'result_phos_check_alum_dose' },
          { text: 'pH > 7.5', next: 'result_phos_check_alum_dose' }
        ]
      },
      nutrient_tn: {
        question: 'Which nitrogen species is elevated?',
        answers: [
          { text: 'Ammonia (NH‚ÇÉ-N)', next: 'result_tn_ammonia' },
          { text: 'Nitrate (NO‚ÇÉ-N)', next: 'tn_nitrate' },
          { text: 'Both ammonia and nitrate', next: 'result_tn_both' }
        ]
      },
      tn_nitrate: {
        question: 'Do you have an anoxic zone for denitrification?',
        answers: [
          { text: 'Yes - dedicated anoxic zone', next: 'tn_anoxic' },
          { text: 'No - fully aerobic', next: 'result_tn_need_anoxic' }
        ]
      },
      tn_anoxic: {
        question: 'What is the DO in your anoxic zone?',
        answers: [
          { text: 'DO > 0.5 mg/L (too high)', next: 'result_tn_anoxic_do' },
          { text: 'DO < 0.3 mg/L (good)', next: 'tn_carbon' }
        ]
      },
      tn_carbon: {
        question: 'Is there adequate carbon source for denitrification?',
        answers: [
          { text: 'BOD/TKN ratio > 4', next: 'result_tn_imlr' },
          { text: 'BOD/TKN ratio < 4 (low carbon)', next: 'result_tn_add_carbon' }
        ]
      },
      nutrient_both: {
        question: 'What type of BNR process do you have?',
        answers: [
          { text: 'A2O or similar', next: 'result_bnr_a2o' },
          { text: 'Bardenpho (4 or 5 stage)', next: 'result_bnr_bardenpho' },
          { text: 'SBR with BNR', next: 'result_bnr_sbr' },
          { text: 'No BNR - need to add', next: 'result_bnr_needed' }
        ]
      }
    },
    results: {
      result_phos_add_process: { diagnosis: 'No P Removal Process', cause: 'Plant has no phosphorus removal capability.', actions: ['Add chemical feed system', 'Ferric chloride most common', 'Dose at 1.5-2 molar ratio to P', 'Consider Bio-P if permit tightens', 'Start with tertiary addition'], severity: 'high' },
      result_phos_no_release: { diagnosis: 'Poor P Release in Anaerobic Zone', cause: 'PAOs not releasing phosphorus due to nitrate or DO intrusion.', actions: ['Check for DO in anaerobic zone', 'Check for nitrate recycle to anaerobic', 'May need larger anaerobic zone', 'Verify VFA availability', 'Consider supplemental VFA'], severity: 'high' },
      result_phos_poor_uptake: { diagnosis: 'Poor Aerobic P Uptake', cause: 'PAOs not taking up phosphorus in aerobic zone.', actions: ['Verify DO > 2 mg/L in aerobic', 'Check for toxic conditions', 'Verify SRT adequate (>5 days)', 'May need supplemental chemical', 'Check for GAO competition'], severity: 'high' },
      result_phos_secondary_release: { diagnosis: 'Secondary P Release', cause: 'Phosphorus released in clarifier or sludge handling.', actions: ['Reduce clarifier detention time', 'Increase RAS rate', 'Minimize sludge storage', 'Add ferric to RAS line', 'Keep sludge aerobic'], severity: 'moderate' },
      result_phos_move_feed: { diagnosis: 'Optimize Chemical Feed Point', cause: 'Primary addition may not be optimal location.', actions: ['Try tertiary addition', 'Split dosing - primary and tertiary', 'Tertiary gives better control', 'Monitor effluent TSS impact', 'Jar test to optimize'], severity: 'moderate' },
      result_phos_check_dose: { diagnosis: 'Check Chemical Dose', cause: 'May not be adding enough chemical for P load.', actions: ['Calculate molar ratio Fe:P or Al:P', 'Target 1.5-2.5 molar ratio', 'Jar test to optimize', 'Verify chemical is active', 'Check feed pump calibration'], severity: 'moderate' },
      result_phos_tertiary_issue: { diagnosis: 'Tertiary Treatment Issue', cause: 'Filter or final polishing not removing precipitate.', actions: ['Check filter operation', 'May need polymer addition', 'Verify adequate mixing', 'Check floc formation', 'Consider different chemical'], severity: 'moderate' },
      result_phos_ph_low: { diagnosis: 'pH Too Low for Alum', cause: 'Low pH reduces alum effectiveness.', actions: ['Add lime or caustic with alum', 'Optimal pH 6.0-7.0 for alum', 'Consider switching to ferric', 'Monitor alkalinity consumption', 'pH adjustment critical'], severity: 'moderate' },
      result_phos_check_alum_dose: { diagnosis: 'Verify Alum Dosing', cause: 'Alum dose may need adjustment.', actions: ['Jar test to optimize dose', 'Al:P ratio typically 1.5-3', 'Check for interfering substances', 'Verify mixing and contact time', 'Consider feed point optimization'], severity: 'moderate' },
      result_tn_ammonia: { diagnosis: 'Nitrification Problem', cause: 'Ammonia not being converted to nitrate. See Ammonia Wizard.', actions: ['Run High Ammonia Wizard', 'Check SRT, DO, pH, temperature', 'Nitrifiers may be inhibited', 'Common in cold weather', 'Usually SRT or DO issue'], severity: 'high' },
      result_tn_both: { diagnosis: 'Complete Nitrogen Removal Failure', cause: 'Neither nitrification nor denitrification working properly.', actions: ['Address nitrification first', 'Run High Ammonia Wizard', 'Once ammonia controlled, address nitrate', 'May need process modifications', 'Consider BNR upgrade'], severity: 'critical' },
      result_tn_need_anoxic: { diagnosis: 'No Anoxic Zone', cause: 'Cannot denitrify without anoxic conditions.', actions: ['Create anoxic zone', 'Turn off aerators in first zone', 'Add IMLR from aerobic to anoxic', 'Need 2-4 hour HRT in anoxic', 'May need baffles or modifications'], severity: 'high' },
      result_tn_anoxic_do: { diagnosis: 'DO Too High in Anoxic Zone', cause: 'Oxygen in anoxic zone inhibits denitrification.', actions: ['Reduce IMLR rate', 'Check for mechanical aerators', 'Verify mixers not entraining air', 'Add baffle to prevent backmix', 'Target DO < 0.3 mg/L'], severity: 'high' },
      result_tn_imlr: { diagnosis: 'Check IMLR Rate', cause: 'Internal mixed liquor recycle may need adjustment.', actions: ['IMLR typically 200-400% of influent', 'Higher IMLR = more denitrification', 'But too high wastes energy', 'Balance with anoxic detention', 'Check recycle pumps'], severity: 'moderate' },
      result_tn_add_carbon: { diagnosis: 'Carbon Limited Denitrification', cause: 'Not enough BOD available for denitrification.', actions: ['Add supplemental carbon', 'Methanol, glycerol, or acetate', 'Dose based on NO3-N √ó 3-4', 'Consider primary effluent bypass', 'Fermenter for VFA production'], severity: 'high' },
      result_bnr_a2o: { diagnosis: 'A2O Process Optimization', cause: 'A2O may need tuning for both N and P removal.', actions: ['Optimize zone volumes', 'Check recycle rates (RAS and IMLR)', 'Verify anaerobic truly anaerobic', 'Balance SRT for both processes', 'May need supplemental chemical for P'], severity: 'moderate' },
      result_bnr_bardenpho: { diagnosis: 'Bardenpho Process Optimization', cause: '4 or 5 stage Bardenpho needs proper operation.', actions: ['Verify each zone conditions', 'Check recycles between zones', 'Second anoxic may need carbon', 'Final aerobic for N2 stripping', 'Complex process - review design'], severity: 'moderate' },
      result_bnr_sbr: { diagnosis: 'SBR BNR Optimization', cause: 'SBR cycle timing affects nutrient removal.', actions: ['Adjust anaerobic phase length', 'Verify anoxic phase conditions', 'Aerobic phase for nitrification', 'May need cycle modifications', 'Check decant settings'], severity: 'moderate' },
      result_bnr_needed: { diagnosis: 'BNR Process Needed', cause: 'Current process cannot achieve nutrient limits.', actions: ['Evaluate BNR options', 'A2O, Bardenpho, MLE common', 'Capital project required', 'Consider phased approach', 'Chemical may bridge gap'], severity: 'high' }
    }
  },
  blower: {
    title: '‚ö° Blower/Aeration Troubleshooting',
    color: '#0369a1',
    steps: {
      start: {
        question: 'What is the main symptom?',
        answers: [
          { text: 'Low airflow / can\'t meet DO', next: 'blower_low_air' },
          { text: 'High amp draw / overheating', next: 'blower_high_amps' },
          { text: 'Blower tripping / shutting down', next: 'blower_tripping' },
          { text: 'Unusual noise or vibration', next: 'blower_noise' },
          { text: 'Uneven air distribution in basin', next: 'blower_distribution' }
        ]
      },
      blower_low_air: {
        question: 'Is the blower running at full capacity?',
        answers: [
          { text: 'Yes - VFD at 100%', next: 'low_air_full_speed' },
          { text: 'No - VFD limited by something', next: 'low_air_limited' },
          { text: 'Not sure / no VFD', next: 'low_air_check' }
        ]
      },
      low_air_full_speed: {
        question: 'What is the discharge pressure?',
        answers: [
          { text: 'Pressure higher than normal', next: 'result_blower_high_pressure' },
          { text: 'Pressure normal or low', next: 'result_blower_capacity' }
        ]
      },
      low_air_limited: {
        question: 'What is limiting the VFD?',
        answers: [
          { text: 'High amp draw', next: 'blower_high_amps' },
          { text: 'High temperature', next: 'result_blower_cooling' },
          { text: 'Control system limiting', next: 'result_blower_controls' }
        ]
      },
      low_air_check: {
        question: 'Check the inlet filter - is it clean?',
        answers: [
          { text: 'Filter dirty/clogged', next: 'result_blower_filter' },
          { text: 'Filter clean', next: 'result_blower_mechanical' }
        ]
      },
      blower_high_amps: {
        question: 'When did high amps start?',
        answers: [
          { text: 'Gradually increased over time', next: 'result_blower_diffuser_fouling' },
          { text: 'Sudden increase', next: 'result_blower_mechanical' },
          { text: 'Always been high', next: 'result_blower_sizing' }
        ]
      },
      blower_tripping: {
        question: 'What trips the blower?',
        answers: [
          { text: 'High temperature', next: 'result_blower_cooling' },
          { text: 'High amps / overload', next: 'result_blower_overload' },
          { text: 'Surge condition', next: 'result_blower_surge' },
          { text: 'Unknown / check fault log', next: 'result_blower_check_faults' }
        ]
      },
      blower_noise: {
        question: 'What type of noise?',
        answers: [
          { text: 'Grinding or scraping', next: 'result_blower_bearing' },
          { text: 'Rattling or loose', next: 'result_blower_loose' },
          { text: 'Whistling or air leak', next: 'result_blower_leak' },
          { text: 'Surge/pulsing sound', next: 'result_blower_surge' }
        ]
      },
      blower_distribution: {
        question: 'Where is air distribution uneven?',
        answers: [
          { text: 'One zone consistently low', next: 'result_blower_zone_valve' },
          { text: 'Random areas low', next: 'result_blower_diffusers' },
          { text: 'Pattern changes over time', next: 'result_blower_fouling_pattern' }
        ]
      }
    },
    results: {
      result_blower_high_pressure: { diagnosis: 'High System Pressure', cause: 'Diffusers or piping restricting airflow, causing high pressure.', actions: ['Check for closed valves', 'Inspect diffusers for fouling', 'Calculate headloss through system', 'Consider diffuser cleaning/replacement', 'May need larger piping'], severity: 'high' },
      result_blower_capacity: { diagnosis: 'Insufficient Blower Capacity', cause: 'Blower cannot deliver required airflow at current conditions.', actions: ['Verify design vs. actual capacity', 'Check inlet air temperature', 'May need additional blower', 'Evaluate turbo vs. PD options', 'Consider load reduction'], severity: 'high' },
      result_blower_cooling: { diagnosis: 'Blower Overheating', cause: 'Inadequate cooling causing temperature trips.', actions: ['Check cooling fan operation', 'Clean cooling fins/radiator', 'Verify ambient temperature OK', 'Check for blocked vents', 'May need additional cooling'], severity: 'high' },
      result_blower_controls: { diagnosis: 'Control System Limiting Blower', cause: 'Controls preventing full blower operation.', actions: ['Check DO setpoint and control', 'Verify valve positions', 'Check for alarm conditions', 'Review control logic', 'May need tuning'], severity: 'moderate' },
      result_blower_filter: { diagnosis: 'Clogged Inlet Filter', cause: 'Dirty filter restricting inlet airflow.', actions: ['Replace or clean filter', 'Establish filter change schedule', 'Check differential pressure', 'Consider better filtration', 'Usually monthly changes'], severity: 'moderate' },
      result_blower_mechanical: { diagnosis: 'Mechanical Problem', cause: 'Internal blower issue affecting performance.', actions: ['Check bearings and oil', 'Listen for unusual sounds', 'Check shaft alignment', 'May need manufacturer service', 'Vibration analysis recommended'], severity: 'high' },
      result_blower_diffuser_fouling: { diagnosis: 'Diffuser Fouling', cause: 'Gradual diffuser fouling increasing back pressure.', actions: ['Measure pressure trend over time', 'Plan diffuser cleaning', 'Consider acid gas cleaning', 'Evaluate diffuser age', 'Budget for replacement if old'], severity: 'moderate' },
      result_blower_sizing: { diagnosis: 'Blower Undersized', cause: 'Blower was not properly sized for actual conditions.', actions: ['Compare nameplate to actual duty', 'May need larger motor', 'Consider adding blower', 'Evaluate process changes', 'Reduce loading if possible'], severity: 'high' },
      result_blower_overload: { diagnosis: 'Motor Overload', cause: 'Blower motor drawing excessive current.', actions: ['Check for mechanical binding', 'Verify voltage supply', 'Check for diffuser fouling', 'May need motor service', 'Consider power quality'], severity: 'high' },
      result_blower_surge: { diagnosis: 'Blower Surge Condition', cause: 'Turbo blower operating in surge zone.', actions: ['Open blowoff valve', 'Increase system demand', 'Check surge control system', 'May need to reduce speed', 'Turbo blowers have minimum flow'], severity: 'critical' },
      result_blower_check_faults: { diagnosis: 'Review Fault History', cause: 'Need to identify specific trip cause.', actions: ['Check blower fault log', 'Review SCADA alarms', 'Note time and conditions', 'Contact manufacturer if needed', 'Systematic troubleshooting'], severity: 'moderate' },
      result_blower_bearing: { diagnosis: 'Bearing Failure', cause: 'Bearings failing causing grinding noise.', actions: ['Stop blower if severe', 'Check oil level and condition', 'Plan bearing replacement', 'Catastrophic failure if ignored', 'May need rebuild'], severity: 'critical' },
      result_blower_loose: { diagnosis: 'Loose Components', cause: 'Loose bolts, guards, or fittings.', actions: ['Check all fasteners', 'Tighten loose components', 'Check coupling alignment', 'Verify guards secure', 'Usually easy fix'], severity: 'moderate' },
      result_blower_leak: { diagnosis: 'Air Leak', cause: 'Leak in piping or connections losing air.', actions: ['Listen for leaks', 'Check pipe joints', 'Inspect flexible connectors', 'Use soapy water to find leaks', 'Repair as found'], severity: 'moderate' },
      result_blower_zone_valve: { diagnosis: 'Zone Valve Problem', cause: 'One zone not receiving proper airflow.', actions: ['Check zone valve position', 'Verify valve actuator', 'Check for obstruction', 'May need valve service', 'Check controls to valve'], severity: 'moderate' },
      result_blower_diffusers: { diagnosis: 'Diffuser Problems', cause: 'Some diffusers clogged or damaged.', actions: ['Inspect basin visually', 'Look for uneven bubbling', 'May need to drain and inspect', 'Clean or replace diffusers', 'Check header piping'], severity: 'moderate' },
      result_blower_fouling_pattern: { diagnosis: 'Progressive Diffuser Fouling', cause: 'Diffusers fouling unevenly over time.', actions: ['Plan systematic inspection', 'Track air distribution changes', 'Schedule cleaning', 'Consider air bump cleaning', 'Evaluate diffuser type'], severity: 'moderate' }
    }
  },
  clarifier: {
    title: 'üîß Clarifier Mechanical Troubleshooting',
    color: '#475569',
    steps: {
      start: {
        question: 'What clarifier issue are you experiencing?',
        answers: [
          { text: 'High torque / overload alarm', next: 'clar_torque' },
          { text: 'Mechanism not rotating', next: 'clar_stopped' },
          { text: 'Scum/foam accumulation', next: 'clar_scum' },
          { text: 'Effluent weir problems', next: 'clar_weir' },
          { text: 'Sludge collection issues', next: 'clar_sludge' }
        ]
      },
      clar_torque: {
        question: 'Is the high torque constant or intermittent?',
        answers: [
          { text: 'Constant high torque', next: 'clar_torque_constant' },
          { text: 'Spikes/intermittent', next: 'clar_torque_spikes' }
        ]
      },
      clar_torque_constant: {
        question: 'What is the sludge blanket depth?',
        answers: [
          { text: 'Very deep (> 4 ft)', next: 'result_clar_deep_blanket' },
          { text: 'Normal (< 3 ft)', next: 'result_clar_mechanical_drag' }
        ]
      },
      clar_torque_spikes: {
        question: 'When do spikes occur?',
        answers: [
          { text: 'Random times', next: 'result_clar_debris' },
          { text: 'Same location each rotation', next: 'result_clar_obstruction' }
        ]
      },
      clar_stopped: {
        question: 'Is power getting to the drive?',
        answers: [
          { text: 'No power / electrical issue', next: 'result_clar_electrical' },
          { text: 'Power OK but not moving', next: 'clar_mechanical_stop' }
        ]
      },
      clar_mechanical_stop: {
        question: 'Is the drive motor running?',
        answers: [
          { text: 'Motor runs but mechanism doesn\'t move', next: 'result_clar_drive_failure' },
          { text: 'Motor won\'t start', next: 'result_clar_motor' }
        ]
      },
      clar_scum: {
        question: 'Is the scum removal system working?',
        answers: [
          { text: 'Scum skimmer not operating', next: 'result_clar_skimmer' },
          { text: 'Skimmer works but scum still accumulates', next: 'result_clar_scum_excessive' },
          { text: 'Scum box/trough full', next: 'result_clar_scum_box' }
        ]
      },
      clar_weir: {
        question: 'What is the weir problem?',
        answers: [
          { text: 'Uneven flow over weirs', next: 'result_clar_weir_level' },
          { text: 'Algae/debris on weirs', next: 'result_clar_weir_dirty' },
          { text: 'Weirs damaged', next: 'result_clar_weir_damage' }
        ]
      },
      clar_sludge: {
        question: 'What sludge collection problem?',
        answers: [
          { text: 'Sludge not reaching hopper', next: 'result_clar_scraper' },
          { text: 'Sludge buildup in corners', next: 'result_clar_corners' },
          { text: 'RAS pump suction issues', next: 'result_clar_ras_pump' }
        ]
      }
    },
    results: {
      result_clar_deep_blanket: { diagnosis: 'Deep Sludge Blanket', cause: 'Excessive sludge causing high drag on mechanism.', actions: ['Increase RAS pumping immediately', 'Increase WAS rate', 'Monitor blanket until < 3 ft', 'Check for pump issues', 'Process may be overloaded'], severity: 'high' },
      result_clar_mechanical_drag: { diagnosis: 'Mechanical Drag', cause: 'Friction in mechanism components.', actions: ['Check bearings and bushings', 'Inspect squeegees/scrapers', 'Lubricate as needed', 'Check for corrosion', 'May need rebuilding'], severity: 'moderate' },
      result_clar_debris: { diagnosis: 'Debris in Clarifier', cause: 'Rags or debris causing intermittent drag.', actions: ['Plan cleanout', 'Improve screening at headworks', 'Check for rag buildup on mechanism', 'May need diver inspection', 'Install rag catchers'], severity: 'moderate' },
      result_clar_obstruction: { diagnosis: 'Fixed Obstruction', cause: 'Something on floor at specific location.', actions: ['Drain and inspect', 'Remove obstruction', 'Check for damaged components', 'Debris or broken equipment', 'Document location'], severity: 'high' },
      result_clar_electrical: { diagnosis: 'Electrical Problem', cause: 'Power supply issue to clarifier drive.', actions: ['Check breaker/fuses', 'Verify power at drive', 'Check control circuit', 'Inspect wiring', 'May need electrician'], severity: 'moderate' },
      result_clar_drive_failure: { diagnosis: 'Drive Mechanism Failure', cause: 'Gearbox, shear pin, or drive failure.', actions: ['Check shear pins first', 'Inspect gearbox', 'Check drive coupling', 'Listen for grinding', 'May need major repair'], severity: 'critical' },
      result_clar_motor: { diagnosis: 'Motor Problem', cause: 'Drive motor issue.', actions: ['Check motor starter', 'Test motor windings', 'Check for overload trip', 'Verify motor connections', 'May need motor repair/replacement'], severity: 'high' },
      result_clar_skimmer: { diagnosis: 'Scum Skimmer Problem', cause: 'Skimmer mechanism not functioning.', actions: ['Check skimmer blade', 'Verify arm rotation', 'Check pivot and supports', 'Adjust beach slope', 'May need repair'], severity: 'moderate' },
      result_clar_scum_excessive: { diagnosis: 'Excessive Scum Production', cause: 'Process producing more scum than can be removed.', actions: ['Address foam-forming organisms', 'Reduce SRT if Nocardia', 'Increase removal frequency', 'Check FOG in influent', 'See Foam Wizard'], severity: 'moderate' },
      result_clar_scum_box: { diagnosis: 'Scum Removal System Backup', cause: 'Scum not being removed from box/trough.', actions: ['Check scum pump', 'Clear any blockages', 'Increase pump run time', 'Clean scum trough', 'Check discharge line'], severity: 'moderate' },
      result_clar_weir_level: { diagnosis: 'Weirs Out of Level', cause: 'Uneven weirs causing unequal flow distribution.', actions: ['Survey weir elevations', 'Adjust to within 1/8 inch', 'May need weir replacement', 'Check for settlement', 'Critical for performance'], severity: 'high' },
      result_clar_weir_dirty: { diagnosis: 'Dirty Weirs', cause: 'Algae and debris affecting weir performance.', actions: ['Clean weirs regularly', 'Brush or pressure wash', 'Weekly cleaning recommended', 'Consider weir covers', 'Install spray bars'], severity: 'low' },
      result_clar_weir_damage: { diagnosis: 'Damaged Weirs', cause: 'Weirs bent, broken, or deteriorated.', actions: ['Inspect all weirs', 'Replace damaged sections', 'Consider V-notch weirs', 'FRP or aluminum options', 'Plan for rehabilitation'], severity: 'moderate' },
      result_clar_scraper: { diagnosis: 'Scraper/Squeegee Problem', cause: 'Sludge not being conveyed to hopper.', actions: ['Inspect scraper blades', 'Check blade contact with floor', 'Replace worn squeegees', 'Verify proper blade angle', 'Check for damage'], severity: 'moderate' },
      result_clar_corners: { diagnosis: 'Corner Sludge Buildup', cause: 'Rectangular clarifier corners accumulating sludge.', actions: ['Install corner sweeps', 'Add corner fillets', 'Increase corner attention', 'Common in rectangular tanks', 'May need manual cleaning'], severity: 'moderate' },
      result_clar_ras_pump: { diagnosis: 'RAS Pump Suction Problem', cause: 'Pump not drawing sludge properly.', actions: ['Check for air in suction', 'Verify pump operation', 'Inspect suction piping', 'Check for sludge ratholing', 'Verify hopper design'], severity: 'high' }
    }
  },
  raswas: {
    title: 'üíß RAS/WAS Optimization',
    color: '#0891b2',
    steps: {
      start: {
        question: 'What RAS/WAS issue are you troubleshooting?',
        answers: [
          { text: 'High sludge blanket despite pumping', next: 'ras_blanket' },
          { text: 'RAS concentration too low/high', next: 'ras_concentration' },
          { text: 'Can\'t maintain target MLSS', next: 'ras_mlss' },
          { text: 'WAS rate calculation', next: 'ras_was_calc' },
          { text: 'RAS pump problems', next: 'ras_pump' }
        ]
      },
      ras_blanket: {
        question: 'What is the current RAS rate as % of influent flow?',
        answers: [
          { text: 'RAS < 25%', next: 'result_ras_increase' },
          { text: 'RAS 25-50%', next: 'ras_blanket_mid' },
          { text: 'RAS 50-100%', next: 'ras_blanket_high' },
          { text: 'RAS > 100%', next: 'result_ras_too_high' }
        ]
      },
      ras_blanket_mid: {
        question: 'Is the sludge settling normally (SVI < 150)?',
        answers: [
          { text: 'Yes - SVI is normal', next: 'result_ras_increase_more' },
          { text: 'No - poor settling (SVI > 150)', next: 'result_ras_bulking' }
        ]
      },
      ras_blanket_high: {
        question: 'Is the RAS pump able to deliver more?',
        answers: [
          { text: 'Yes - can increase pump speed', next: 'result_ras_pump_up' },
          { text: 'No - pump at max capacity', next: 'result_ras_pump_limit' }
        ]
      },
      ras_concentration: {
        question: 'What is the RAS concentration vs MLSS?',
        answers: [
          { text: 'RAS < MLSS (too dilute)', next: 'result_ras_dilute' },
          { text: 'RAS = 2-3√ó MLSS (normal)', next: 'result_ras_normal' },
          { text: 'RAS > 4√ó MLSS (very thick)', next: 'result_ras_thick' }
        ]
      },
      ras_mlss: {
        question: 'Is MLSS too high or too low?',
        answers: [
          { text: 'MLSS too high', next: 'result_was_increase' },
          { text: 'MLSS too low', next: 'result_was_decrease' },
          { text: 'MLSS fluctuating', next: 'result_was_consistency' }
        ]
      },
      ras_was_calc: {
        question: 'What are you trying to control?',
        answers: [
          { text: 'Target a specific SRT', next: 'result_was_srt' },
          { text: 'Target a specific MLSS', next: 'result_was_mlss_target' },
          { text: 'Maximize solids removal', next: 'result_was_maximize' }
        ]
      },
      ras_pump: {
        question: 'What pump problem?',
        answers: [
          { text: 'Pump won\'t prime / losing suction', next: 'result_ras_prime' },
          { text: 'Low flow despite running', next: 'result_ras_low_flow' },
          { text: 'Variable flow / surging', next: 'result_ras_surging' }
        ]
      }
    },
    results: {
      result_ras_increase: { diagnosis: 'RAS Rate Too Low', cause: 'RAS rate insufficient to return solids to aeration basin.', actions: ['Increase RAS to 50-75% of influent', 'Monitor blanket response', 'Typical RAS range 25-100%', 'Higher for poor settling sludge', 'Check pump capacity'], severity: 'moderate' },
      result_ras_increase_more: { diagnosis: 'Increase RAS Rate', cause: 'Good settling sludge but not returning fast enough.', actions: ['Increase RAS rate 10-20%', 'Can go higher with good SVI', 'Monitor clarifier performance', 'Target blanket < 2 ft', 'Adjust incrementally'], severity: 'moderate' },
      result_ras_bulking: { diagnosis: 'Filamentous Bulking Affecting RAS', cause: 'Poor settling causing blanket despite RAS pumping.', actions: ['Run Bulking Wizard', 'Address root cause of bulking', 'May need polymer addition', 'Can\'t pump way out of bulking', 'RAS will be dilute'], severity: 'high' },
      result_ras_too_high: { diagnosis: 'Excessive RAS Rate', cause: 'RAS > 100% wastes energy and disrupts settling.', actions: ['Reduce RAS rate', 'Very high RAS is counterproductive', 'Reduces clarifier detention', 'May actually hurt settling', 'Address root cause'], severity: 'moderate' },
      result_ras_pump_up: { diagnosis: 'Increase Pump Speed', cause: 'Pump has additional capacity available.', actions: ['Increase VFD speed or pump runtime', 'Monitor discharge pressure', 'Check motor amps', 'Gradual increases', 'Verify blanket responds'], severity: 'moderate' },
      result_ras_pump_limit: { diagnosis: 'RAS Pump Capacity Limit', cause: 'Pumps cannot deliver more flow.', actions: ['May need larger pumps', 'Bring additional pump online', 'Check for piping restrictions', 'Verify impeller condition', 'Consider parallel operation'], severity: 'high' },
      result_ras_dilute: { diagnosis: 'Dilute RAS', cause: 'Clarifier not thickening sludge adequately.', actions: ['Check for hydraulic short-circuiting', 'Verify blanket depth', 'May indicate clarifier problems', 'Check density current', 'Poor flocculation possible'], severity: 'moderate' },
      result_ras_normal: { diagnosis: 'Normal RAS Concentration', cause: 'RAS concentration is in expected range.', actions: ['No action needed', 'RAS 2-3√ó MLSS is typical', 'Monitor for changes', 'Document as baseline', 'Good clarifier performance'], severity: 'low' },
      result_ras_thick: { diagnosis: 'Very Thick RAS', cause: 'Sludge thickening excessively in clarifier.', actions: ['May indicate too low RAS rate', 'Or excellent settling', 'Check for denitrification', 'Could be pre-rising sludge', 'Monitor closely'], severity: 'moderate' },
      result_was_increase: { diagnosis: 'Increase WAS Rate', cause: 'MLSS higher than target, need to waste more.', actions: ['Calculate current SRT', 'Increase WAS 10-20%', 'Changes take 1-3 SRTs to stabilize', 'Monitor daily', 'Adjust incrementally'], severity: 'moderate' },
      result_was_decrease: { diagnosis: 'Decrease WAS Rate', cause: 'MLSS lower than target, wasting too much.', actions: ['Reduce WAS rate', 'Allow MLSS to build', 'May take several days', 'Check for other solids loss', 'TSS in effluent?'], severity: 'moderate' },
      result_was_consistency: { diagnosis: 'Inconsistent WAS Operation', cause: 'Variable wasting causing MLSS swings.', actions: ['Establish consistent WAS schedule', 'Daily wasting better than intermittent', 'Same time each day', 'Automatic pacing helpful', 'Record all wasting'], severity: 'moderate' },
      result_was_srt: { diagnosis: 'SRT-Based WAS Control', cause: 'Setting WAS to achieve target SRT.', actions: ['WAS (gpd) = Aer Vol √ó MLSS √ó 8.34 / (SRT √ó WAS TSS √ó 8.34)', 'Plus effluent solids loss', 'Typical SRT: 5-15 days', 'Adjust based on process needs', 'Monitor SRT weekly'], severity: 'low' },
      result_was_mlss_target: { diagnosis: 'MLSS-Based WAS Control', cause: 'Adjusting WAS to maintain MLSS.', actions: ['Increase WAS if MLSS rising', 'Decrease WAS if MLSS falling', 'Small adjustments daily', 'Seasonal adjustments needed', 'Document target and actual'], severity: 'low' },
      result_was_maximize: { diagnosis: 'Maximize Solids Wasting', cause: 'Need to remove solids as fast as possible.', actions: ['Waste thickest concentration', 'Waste from RAS line if possible', 'Continuous wasting most efficient', 'Monitor clarifier blanket', 'May need temporary increase'], severity: 'moderate' },
      result_ras_prime: { diagnosis: 'RAS Pump Losing Prime', cause: 'Air getting into pump suction.', actions: ['Check suction piping for leaks', 'Verify submergence in hopper', 'Check for vortexing', 'Inspect foot valve if present', 'May need to reprime'], severity: 'high' },
      result_ras_low_flow: { diagnosis: 'Low RAS Flow', cause: 'Pump running but not delivering expected flow.', actions: ['Check for plugged suction', 'Inspect impeller wear', 'Verify valve positions', 'Check for air binding', 'May need pump service'], severity: 'high' },
      result_ras_surging: { diagnosis: 'RAS Flow Surging', cause: 'Inconsistent flow indicating pump or system issue.', actions: ['Check for suction problems', 'Verify NPSH adequate', 'Look for air entrainment', 'Check VFD operation', 'May be sludge ratholing'], severity: 'moderate' }
    }
  }
};

var wizardState = { active: false, type: null, currentStep: 'start', path: [], answers: [] };
var wizardHistory = [];

function startWizard(type) {
  if (!wizardData[type]) { showToast('Wizard not found', 'error'); return; }
  var wizard = wizardData[type];
  wizardState = { active: true, type: type, currentStep: 'start', path: ['Start'], answers: [] };
  document.getElementById('wizardActiveArea').style.display = 'block';
  document.getElementById('wizardResults').style.display = 'none';
  document.getElementById('wizardTitle').innerHTML = wizard.title;
  document.getElementById('wizardTitle').style.background = 'linear-gradient(135deg,' + wizard.color + ',' + wizard.color + 'aa)';
  loadWizardStep('start');
  document.getElementById('wizardActiveArea').scrollIntoView({ behavior: 'smooth' });
}

function loadWizardStep(stepId) {
  var wizard = wizardData[wizardState.type];
  if (stepId.startsWith('result_')) { showWizardResult(stepId); return; }
  var step = wizard.steps[stepId];
  if (!step) { showToast('Step not found', 'error'); return; }
  wizardState.currentStep = stepId;
  var totalSteps = Object.keys(wizard.steps).length;
  var currentIndex = Object.keys(wizard.steps).indexOf(stepId) + 1;
  var percent = Math.round((currentIndex / totalSteps) * 100);
  document.getElementById('wizardProgress').textContent = 'Step ' + currentIndex + ' of ' + totalSteps;
  document.getElementById('wizardPercent').textContent = percent + '%';
  document.getElementById('wizardProgressBar').style.width = percent + '%';
  document.getElementById('wizardQuestionText').textContent = step.question;
  var answersHtml = '';
  step.answers.forEach(function(answer, index) {
    answersHtml += '<button onclick="selectWizardAnswer(' + index + ',\'' + answer.next + '\')" style="background:rgba(124,58,237,0.3);border:2px solid #7c3aed;color:white;padding:16px 20px;border-radius:12px;font-size:16px;text-align:left;cursor:pointer;transition:all 0.2s;width:100%" onmouseover="this.style.background=\'rgba(124,58,237,0.5)\'" onmouseout="this.style.background=\'rgba(124,58,237,0.3)\'">' + answer.text + '</button>';
  });
  document.getElementById('wizardAnswers').innerHTML = answersHtml;
  document.getElementById('wizardBreadcrumb').textContent = wizardState.path.join(' ‚Üí ');
  document.getElementById('wizardBackBtn').disabled = wizardState.path.length <= 1;
}

function selectWizardAnswer(index, next) {
  var wizard = wizardData[wizardState.type];
  var step = wizard.steps[wizardState.currentStep];
  var answer = step.answers[index];
  wizardState.answers.push({ question: step.question, answer: answer.text });
  var shortAnswer = answer.text.length > 25 ? answer.text.substring(0, 25) + '...' : answer.text;
  wizardState.path.push(shortAnswer);
  loadWizardStep(next);
}

function showWizardResult(resultId) {
  var wizard = wizardData[wizardState.type];
  var result = wizard.results[resultId];
  if (!result) { showToast('Result not found', 'error'); return; }
  document.getElementById('wizardActiveArea').style.display = 'none';
  document.getElementById('wizardResults').style.display = 'block';
  var severityColors = { low: '#10b981', moderate: '#f59e0b', high: '#ef4444', critical: '#dc2626' };
  var severityLabels = { low: 'üü¢ LOW', moderate: 'üü° MODERATE', high: 'üü† HIGH', critical: 'üî¥ CRITICAL' };
  var actionsHtml = result.actions.map(function(a) { return '<li style="margin-bottom:8px">' + a + '</li>'; }).join('');
  document.getElementById('wizardResultContent').innerHTML = 
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">' +
    '<h2 style="margin:0;font-size:18px">‚úÖ ' + result.diagnosis + '</h2>' +
    '<span style="background:' + severityColors[result.severity] + ';padding:8px 16px;border-radius:20px;font-weight:bold">' + severityLabels[result.severity] + '</span></div>' +
    '<div style="background:rgba(0,0,0,0.2);padding:20px;border-radius:12px;margin-bottom:20px">' +
    '<h4 style="margin:0 0 10px 0;opacity:0.9">üîç Root Cause:</h4>' +
    '<p style="margin:0;font-size:16px;line-height:1.6">' + result.cause + '</p></div>' +
    '<div style="background:rgba(0,0,0,0.2);padding:20px;border-radius:12px">' +
    '<h4 style="margin:0 0 10px 0;opacity:0.9">üõ†Ô∏è Recommended Actions:</h4>' +
    '<ol style="margin:0;padding-left:20px;font-size:15px;line-height:1.8">' + actionsHtml + '</ol></div>';
  var historyEntry = { date: new Date().toLocaleString(), wizard: wizard.title, diagnosis: result.diagnosis, severity: result.severity };
  wizardHistory.unshift(historyEntry);
  if (wizardHistory.length > 10) wizardHistory.pop();
  localStorage.setItem('wwtp_wizard_history', JSON.stringify(wizardHistory));
  updateWizardHistoryDisplay();
  document.getElementById('wizardResults').scrollIntoView({ behavior: 'smooth' });
}

function wizardBack() {
  if (wizardState.path.length <= 1) return;
  wizardState.path.pop();
  wizardState.answers.pop();
  var steps = Object.keys(wizardData[wizardState.type].steps);
  var prevStep = wizardState.path.length === 1 ? 'start' : steps[Math.max(0, wizardState.path.length - 1)];
  loadWizardStep(prevStep);
}

function wizardRestart() {
  startWizard(wizardState.type);
}

function exitWizard() {
  wizardState = { active: false, type: null, currentStep: 'start', path: [], answers: [] };
  document.getElementById('wizardActiveArea').style.display = 'none';
  document.getElementById('wizardResults').style.display = 'none';
  document.querySelector('#wizards .section').scrollIntoView({ behavior: 'smooth' });
}

function generateWizardReport() {
  var wizard = wizardData[wizardState.type];
  var resultId = Object.keys(wizard.results).find(function(key) {
    return wizard.results[key].diagnosis === document.querySelector('#wizardResultContent h2').textContent.replace('‚úÖ ', '');
  });
  var result = wizard.results[resultId];
  var report = 'WWTP TROUBLESHOOTING REPORT\n' + '='.repeat(50) + '\n\n';
  report += 'Date: ' + new Date().toLocaleString() + '\n';
  report += 'Wizard: ' + wizard.title + '\n\n';
  report += 'DIAGNOSIS: ' + result.diagnosis + '\n';
  report += 'Severity: ' + result.severity.toUpperCase() + '\n\n';
  report += 'ROOT CAUSE:\n' + result.cause + '\n\n';
  report += 'DIAGNOSTIC PATH:\n' + wizardState.path.join(' ‚Üí ') + '\n\n';
  report += 'RECOMMENDED ACTIONS:\n';
  result.actions.forEach(function(a, i) { report += (i + 1) + '. ' + a + '\n'; });
  report += '\n' + '='.repeat(50) + '\n';
  report += 'Generated by WWTP Command Center v9.9.16\n';
  var blob = new Blob([report], { type: 'text/plain' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'WWTP_Diagnosis_' + new Date().toISOString().slice(0, 10) + '.txt';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Report downloaded!', 'success');
}

function updateWizardHistoryDisplay() {
  var container = document.getElementById('wizardHistory');
  if (!wizardHistory || wizardHistory.length === 0) {
    container.innerHTML = '<p>No diagnoses completed yet. Run a wizard to see history here.</p>';
    return;
  }
  var html = '<div style="display:flex;flex-direction:column;gap:10px">';
  wizardHistory.forEach(function(entry) {
    var severityColors = { low: '#10b981', moderate: '#f59e0b', high: '#ef4444', critical: '#dc2626' };
    html += '<div style="background:var(--bg-section);padding:12px;border-radius:8px;border-left:4px solid ' + severityColors[entry.severity] + '">' +
      '<div style="font-weight:bold">' + entry.diagnosis + '</div>' +
      '<div style="font-size:12px;opacity:0.7;margin-top:4px">' + entry.date + '</div></div>';
  });
  html += '</div>';
  container.innerHTML = html;
}

// Load history on init
try { wizardHistory = JSON.parse(localStorage.getItem('wwtp_wizard_history')) || []; updateWizardHistoryDisplay(); } catch(e) { wizardHistory = []; }

// ========== END GUIDED WIZARDS SYSTEM ==========


// ========== PLANT PROFILES SYSTEM v9.6.0 ==========

var plantProfiles = [];

// Initialize profiles on load
function initPlantProfiles() {
  try {
    var saved = localStorage.getItem('wwtp_plant_profiles');
    if (saved) {
      plantProfiles = JSON.parse(saved);
    }
    updateProfileDropdown();
  } catch(e) {
    console.error('Error loading profiles:', e);
    plantProfiles = [];
  }
}

// Update dropdown with saved profiles
function updateProfileDropdown() {
  var select = document.getElementById('profileSelect');
  if (!select) return;
  
  select.innerHTML = '<option value="">-- Select a Plant Profile (' + plantProfiles.length + ' saved) --</option>';
  
  plantProfiles.forEach(function(profile, index) {
    var option = document.createElement('option');
    option.value = index;
    option.textContent = profile.name + (profile.client ? ' (' + profile.client + ')' : '');
    select.appendChild(option);
  });
}

// Save new profile from current values
function saveNewProfile() {
  var nameInput = document.getElementById('newProfileName');
  var name = nameInput ? nameInput.value.trim() : '';
  
  if (!name) {
    showToast('Please enter a profile name', 'error');
    return;
  }
  
  // Check for duplicate names
  var exists = plantProfiles.some(function(p) { return p.name.toLowerCase() === name.toLowerCase(); });
  if (exists) {
    if (!confirm('A profile named "' + name + '" already exists. Overwrite it?')) {
      return;
    }
    // Remove existing
    plantProfiles = plantProfiles.filter(function(p) { return p.name.toLowerCase() !== name.toLowerCase(); });
  }
  
  // Gather all values
  var profile = {
    name: name,
    created: new Date().toISOString(),
    updated: new Date().toISOString(),
    // Master settings
    flow: getInputValue('masterFlow'),
    aerationVolume: getInputValue('masterAerVol'),
    bod: getInputValue('masterBOD'),
    mlss: getInputValue('masterMLSS'),
    // Extended parameters
    plantName: getInputValue('profilePlantName'),
    client: getInputValue('profileClient'),
    permit: getInputValue('profilePermit'),
    designFlow: getInputValue('profileDesignFlow'),
    processType: getInputValue('profileProcessType'),
    clarifiers: getInputValue('profileClarifiers'),
    clarifierDia: getInputValue('profileClarifierDia'),
    swd: getInputValue('profileSWD'),
    targetSRT: getInputValue('profileTargetSRT'),
    notes: getInputValue('profileNotes')
  };
  
  plantProfiles.push(profile);
  savePlantProfiles();
  updateProfileDropdown();
  
  // Clear input
  if (nameInput) nameInput.value = '';
  
  showToast('‚úÖ Profile "' + name + '" saved!', 'success');
}

// Helper to get input value
function getInputValue(id) {
  var el = document.getElementById(id);
  if (!el) return '';
  return el.value;
}

// Helper to set input value
function setInputValue(id, value) {
  var el = document.getElementById(id);
  if (el && value !== undefined && value !== null && value !== '') {
    el.value = value;
  }
}

// Save profiles to localStorage
function savePlantProfiles() {
  try {
    localStorage.setItem('wwtp_plant_profiles', JSON.stringify(plantProfiles));
  } catch(e) {
    showToast('Error saving profiles: ' + e.message, 'error');
  }
}

// Preview selected profile
function previewProfile() {
  var select = document.getElementById('profileSelect');
  var previewDiv = document.getElementById('profilePreview');
  var contentDiv = document.getElementById('profilePreviewContent');
  
  if (!select || !previewDiv || !contentDiv) return;
  
  var index = select.value;
  if (index === '' || !plantProfiles[index]) {
    previewDiv.style.display = 'none';
    return;
  }
  
  var p = plantProfiles[index];
  var html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px">';
  html += '<div><strong>Flow:</strong> ' + (p.flow || '-') + ' MGD</div>';
  html += '<div><strong>Aeration Vol:</strong> ' + (p.aerationVolume || '-') + ' MG</div>';
  html += '<div><strong>BOD:</strong> ' + (p.bod || '-') + ' mg/L</div>';
  html += '<div><strong>MLSS:</strong> ' + (p.mlss || '-') + ' mg/L</div>';
  if (p.processType) html += '<div><strong>Process:</strong> ' + p.processType.toUpperCase() + '</div>';
  if (p.designFlow) html += '<div><strong>Design Flow:</strong> ' + p.designFlow + ' MGD</div>';
  if (p.client) html += '<div><strong>Client:</strong> ' + p.client + '</div>';
  if (p.permit) html += '<div><strong>Permit:</strong> ' + p.permit + '</div>';
  html += '</div>';
  if (p.notes) html += '<div style="margin-top:10px;font-style:italic;opacity:0.8">üìù ' + p.notes + '</div>';
  html += '<div style="margin-top:10px;font-size:12px;opacity:0.6">Last updated: ' + new Date(p.updated).toLocaleDateString() + '</div>';
  
  contentDiv.innerHTML = html;
  previewDiv.style.display = 'block';
}

// Load selected profile
function loadSelectedProfile() {
  var select = document.getElementById('profileSelect');
  if (!select) return;
  
  var index = select.value;
  if (index === '' || !plantProfiles[index]) {
    showToast('Please select a profile first', 'error');
    return;
  }
  
  var p = plantProfiles[index];
  
  // Load master settings in Profiles panel
  setInputValue('masterFlow', p.flow);
  setInputValue('masterAerVol', p.aerationVolume);
  setInputValue('masterBOD', p.bod);
  setInputValue('masterMLSS', p.mlss);
  
  // Also load to Daily Ops master settings
  setInputValue('masterFlowDaily', p.flow);
  setInputValue('masterAerVolDaily', p.aerationVolume);
  setInputValue('masterBODDaily', p.bod);
  setInputValue('masterMLSSDaily', p.mlss);
  
  // Update Dashboard KPIs directly
  var flow = parseFloat(p.flow) || 5.0;
  var aerVol = parseFloat(p.aerationVolume) || 1.0;
  var bod = parseFloat(p.bod) || 200;
  var mlss = parseFloat(p.mlss) || 3000;
  
  if (document.getElementById('kpi-flow')) document.getElementById('kpi-flow').textContent = flow.toFixed(2);
  if (document.getElementById('kpi-mlss')) document.getElementById('kpi-mlss').textContent = mlss;
  
  // Calculate and update F/M
  var mlvss = mlss * 0.8;
  var bodLoad = flow * bod * 8.34;
  var fm = bodLoad / (mlvss * aerVol * 8.34);
  if (document.getElementById('kpi-fm')) document.getElementById('kpi-fm').textContent = fm.toFixed(2);
  
  // Load extended parameters
  setInputValue('profilePlantName', p.plantName);
  setInputValue('profileClient', p.client);
  setInputValue('profilePermit', p.permit);
  setInputValue('profileDesignFlow', p.designFlow);
  setInputValue('profileProcessType', p.processType);
  setInputValue('profileClarifiers', p.clarifiers);
  setInputValue('profileClarifierDia', p.clarifierDia);
  setInputValue('profileSWD', p.swd);
  setInputValue('profileTargetSRT', p.targetSRT);
  setInputValue('profileNotes', p.notes);
  
  // Sync to all calculators
  if (typeof syncAllMasterSettings === 'function') {
    syncAllMasterSettings();
  }
  
  // Auto-calculate all
  if (typeof syncAndCalculateAll === 'function') {
    syncAndCalculateAll();
  } else if (typeof calculateAll === 'function') {
    calculateAll();
  }
  
  showToast('‚úÖ Loaded & Synced: ' + p.name, 'success');
}

// Delete selected profile
function deleteSelectedProfile() {
  var select = document.getElementById('profileSelect');
  if (!select) return;
  
  var index = parseInt(select.value);
  if (isNaN(index) || !plantProfiles[index]) {
    showToast('Please select a profile first', 'error');
    return;
  }
  
  var profileName = plantProfiles[index].name;
  
  // Create custom confirm modal for mobile
  var modal = document.createElement('div');
  modal.id = 'deleteConfirmModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:99999;padding:20px';
  modal.innerHTML = 
    '<div style="background:linear-gradient(135deg,#1e1b4b,#312e81);padding:30px;border-radius:16px;max-width:400px;width:100%;text-align:center;border:3px solid #ef4444">' +
    '<div style="font-size:50px;margin-bottom:15px">üóëÔ∏è</div>' +
    '<h3 style="color:white;margin:0 0 15px 0">Delete Profile?</h3>' +
    '<p style="color:#e2e8f0;margin:0 0 25px 0">Delete "<strong>' + profileName + '</strong>"?<br><br>This cannot be undone.</p>' +
    '<div style="display:flex;gap:15px;justify-content:center">' +
    '<button onclick="confirmDeleteProfile(' + index + ')" style="background:#ef4444;color:white;border:none;padding:14px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer">üóëÔ∏è Delete</button>' +
    '<button onclick="document.getElementById(\'deleteConfirmModal\').remove()" style="background:#6b7280;color:white;border:none;padding:14px 30px;border-radius:10px;font-size:16px;cursor:pointer">Cancel</button>' +
    '</div></div>';
  document.body.appendChild(modal);
}

function confirmDeleteProfile(index) {
  // Close modal
  var modal = document.getElementById('deleteConfirmModal');
  if (modal) modal.remove();
  
  // Delete profile
  var profileName = plantProfiles[index].name;
  plantProfiles.splice(index, 1);
  savePlantProfiles();
  updateProfileDropdown();
  
  // Hide preview
  var preview = document.getElementById('profilePreview');
  if (preview) preview.style.display = 'none';
  
  // Reset dropdown
  var select = document.getElementById('profileSelect');
  if (select) select.value = '';
  
  showToast('üóëÔ∏è Deleted: ' + profileName, 'success');
}

// Export all profiles as JSON
function exportProfiles() {
  if (plantProfiles.length === 0) {
    showToast('No profiles to export', 'error');
    return;
  }
  
  var data = {
    version: '9.2.8',
    exported: new Date().toISOString(),
    profiles: plantProfiles
  };
  
  var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'WWTP_Plant_Profiles_' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('üì§ Exported ' + plantProfiles.length + ' profiles', 'success');
}

// Trigger file import
function importProfiles() {
  document.getElementById('profileImportFile').click();
}

// Handle file import
function handleProfileImport(event) {
  var file = event.target.files[0];
  if (!file) return;
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      var imported = data.profiles || data;
      
      if (!Array.isArray(imported)) {
        throw new Error('Invalid profile format');
      }
      
      var count = 0;
      imported.forEach(function(profile) {
        if (profile.name) {
          // Check for duplicates
          var exists = plantProfiles.some(function(p) { return p.name === profile.name; });
          if (!exists) {
            plantProfiles.push(profile);
            count++;
          }
        }
      });
      
      savePlantProfiles();
      updateProfileDropdown();
      
      showToast('üì• Imported ' + count + ' new profiles', 'success');
    } catch(err) {
      showToast('Error importing: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);
  
  // Reset file input
  event.target.value = '';
}

// Show profile statistics
function showProfileCount() {
  var msg = 'üìä Plant Profiles Statistics\n\n';
  msg += 'Total Profiles: ' + plantProfiles.length + '\n\n';
  
  if (plantProfiles.length > 0) {
    msg += 'Profiles:\n';
    plantProfiles.forEach(function(p, i) {
      msg += (i + 1) + '. ' + p.name + (p.client ? ' (' + p.client + ')' : '') + '\n';
    });
  }
  
  alert(msg);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initPlantProfiles);
// Also try to init immediately in case DOM is already ready
if (document.readyState !== 'loading') {
  initPlantProfiles();
}

// ========== END PLANT PROFILES SYSTEM ==========


// ========== MASTER SETTINGS SYNC SYSTEM ==========

// Sync Master Settings from Process Control to ALL calculators
function syncMasterToAll() {
  // Get values from Process Control Master Settings (primary source)
  var flow = parseFloat(document.getElementById('masterFlowPC')?.value) || 3.5;
  var aerVol = parseFloat(document.getElementById('masterAerVolPC')?.value) || 1.0;
  var bod = parseFloat(document.getElementById('masterBODPC')?.value) || 200;
  var mlss = parseFloat(document.getElementById('masterMLSSPC')?.value) || 3000;
  var clarDia = parseFloat(document.getElementById('masterClarDia')?.value) || 80;
  var clarNum = parseFloat(document.getElementById('masterClarNum')?.value) || 2;
  var weirLen = parseFloat(document.getElementById('masterWeirLen')?.value) || 500;
  var wasFlow = parseFloat(document.getElementById('masterWAS')?.value) || 25000;
  
  // Sync to Profiles panel master settings
  if (document.getElementById('masterFlow')) document.getElementById('masterFlow').value = flow;
  if (document.getElementById('masterAerVol')) document.getElementById('masterAerVol').value = aerVol;
  if (document.getElementById('masterBOD')) document.getElementById('masterBOD').value = bod;
  if (document.getElementById('masterMLSS')) document.getElementById('masterMLSS').value = mlss;
  
  // Update Dashboard KPIs
  if (document.getElementById('kpi-flow')) document.getElementById('kpi-flow').textContent = flow.toFixed(2);
  if (document.getElementById('kpi-mlss')) document.getElementById('kpi-mlss').textContent = mlss;
  
  // Calculate and update F/M ratio
  var mlvss = mlss * 0.8;
  var bodLoad = flow * bod * 8.34;
  var fm = bodLoad / (mlvss * aerVol * 8.34);
  if (document.getElementById('kpi-fm')) document.getElementById('kpi-fm').textContent = fm.toFixed(2);
  
  // Sync to calculator inputs across panels
  var flowInputs = ['flow', 'inf_flow', 'flowRate', 'q_flow', 'daily_flow'];
  var bodInputs = ['bod', 'inf_bod', 'bodConc'];
  // NOTE: Reactor Master Settings (SBR, MBR, MBBR) are kept SEPARATE - not synced from main KPI
  var mlssInputs = [
    'mlss', 'mlss_conc', 'mlss_val',           // General
    'srt_mlss', 'svi_mlss', 'mcrt_mlss',       // Process calculators
    'was_mlss', 'ras_mlss', 'slr_mlss',        // Solids handling
    'clar_mlss', 'ras_ratio_mlss',             // Clarifier & RAS
    'ras_blanket_mlss', 'ras_mlss_current',    // RAS methods
    'was2_srt_mlss', 'was2_mcrt_mlss',         // Advanced WAS
    'was2_fm_mlss', 'was2_mlss_current',       // Advanced WAS
    'rpt_mlss'                                  // Reports
    // EXCLUDED: sbr_mlss, sbr_load_mlss, sbr_was_mlss, mbr_srt_mlss, ifas_mlss, rm_mbr_mlss
    // These are controlled by Reactor Master Settings separately
  ];
  var volInputs = ['aerVol', 'aer_volume', 'basin_vol', 'srt_vol', 'dt_volume'];
  
  flowInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = flow;
  });
  
  bodInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = bod;
  });
  
  mlssInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = mlss;
  });
  
  volInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = aerVol;
  });
  
  // ===== SYNC TO ENHANCED CALCULATORS =====
  
  // Detention Time
  if (document.getElementById('dt_volume')) document.getElementById('dt_volume').value = aerVol;
  if (document.getElementById('dt_flow')) document.getElementById('dt_flow').value = flow;
  
  // Surface Overflow Rate
  if (document.getElementById('sor_flow')) document.getElementById('sor_flow').value = flow;
  if (document.getElementById('sor_dia')) document.getElementById('sor_dia').value = clarDia;
  if (document.getElementById('sor_num')) document.getElementById('sor_num').value = clarNum;
  
  // Weir Loading
  if (document.getElementById('weir_flow')) document.getElementById('weir_flow').value = flow;
  if (document.getElementById('weir_length')) document.getElementById('weir_length').value = weirLen;
  
  // Oxygen Requirement - calculate BOD load
  var bodRemoved = Math.round(flow * bod * 8.34 * 0.95); // 95% removal
  var tknOxidized = Math.round(flow * 40 * 8.34 * 0.90); // Assume 40 mg/L TKN, 90% nitrification
  if (document.getElementById('o2_bod')) document.getElementById('o2_bod').value = bodRemoved;
  if (document.getElementById('o2_tkn')) document.getElementById('o2_tkn').value = tknOxidized;
  
  // Chemical Cost
  if (document.getElementById('chem_flow')) document.getElementById('chem_flow').value = flow;
  
  // SRT Calculator
  if (document.getElementById('srt_vol')) document.getElementById('srt_vol').value = aerVol;
  if (document.getElementById('srt_mlss')) document.getElementById('srt_mlss').value = mlss;
  if (document.getElementById('srt_was')) document.getElementById('srt_was').value = wasFlow;
  
  // Recalculate all enhanced calculators
  if (typeof calcDetentionTime === 'function') calcDetentionTime();
  if (typeof calcSOR === 'function') calcSOR();
  if (typeof calcWeirLoading === 'function') calcWeirLoading();
  if (typeof calcOxygenReq === 'function') calcOxygenReq();
  if (typeof calcChemCost === 'function') calcChemCost();
  if (typeof calcSRT === 'function') calcSRT();
  
  // Update F/M gauge
  if (typeof updateGauge === 'function') {
    updateGauge('fm', fm, 0, 1, 0.2, 0.5);
  }
  
  // Silently sync - no toast on boot
}

// Keep old function name for backwards compatibility
function syncAllMasterSettings() {
  syncMasterToAll();
}

// Sync from Profiles panel to Process Control and everywhere else
function syncFromProfiles() {
  var flow = parseFloat(document.getElementById('masterFlow')?.value) || 5.0;
  var aerVol = parseFloat(document.getElementById('masterAerVol')?.value) || 1.0;
  var bod = parseFloat(document.getElementById('masterBOD')?.value) || 200;
  var mlss = parseFloat(document.getElementById('masterMLSS')?.value) || 3000;
  
  // Sync to Process Control Master Settings
  if (document.getElementById('masterFlowPC')) document.getElementById('masterFlowPC').value = flow;
  if (document.getElementById('masterAerVolPC')) document.getElementById('masterAerVolPC').value = aerVol;
  if (document.getElementById('masterBODPC')) document.getElementById('masterBODPC').value = bod;
  if (document.getElementById('masterMLSSPC')) document.getElementById('masterMLSSPC').value = mlss;
  
  // Then sync everything else
  syncMasterToAll();
}

// Override original syncMasterSettings to also update KPIs
var originalSyncMasterSettings = typeof syncMasterSettings === 'function' ? syncMasterSettings : null;
function syncMasterSettings() {
  syncFromProfiles();
  if (originalSyncMasterSettings) {
    // Call original but it's already covered by syncFromProfiles
  }
  syncAllMasterSettings();
}

// ========== END MASTER SETTINGS SYNC SYSTEM ==========


// ========== ENHANCED CALCULATORS SYSTEM ==========

var calcUnits = 'us'; // 'us' or 'metric'
var calcHistory = [];
var formulasVisible = false;
var compareModeActive = false;

// Initialize calculators
function initEnhancedCalculators() {
  loadCalcHistory();
  calcDetentionTime();
  calcSOR();
  calcWeirLoading();
  calcOxygenReq();
  calcChemCost();
  calcSRT();
}

// Unit conversion toggle
function setUnits(unit) {
  calcUnits = unit;
  document.querySelectorAll('#unitToggle button').forEach(function(btn) {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Update labels based on unit selection
  if (unit === 'metric') {
    document.getElementById('dt_vol_unit').textContent = 'm¬≥';
    document.getElementById('dt_flow_unit').textContent = 'm¬≥/d';
    document.getElementById('dt_result_unit').textContent = 'hours';
  } else {
    document.getElementById('dt_vol_unit').textContent = 'MG';
    document.getElementById('dt_flow_unit').textContent = 'MGD';
    document.getElementById('dt_result_unit').textContent = 'hours';
  }
  
  // Recalculate all
  calcDetentionTime();
  calcSOR();
  calcWeirLoading();
  calcOxygenReq();
  calcChemCost();
  calcSRT();
  
  showToast('Units changed to ' + (unit === 'us' ? 'US' : 'Metric'), 'info');
}

// Toggle formula display
function toggleFormulaDisplay() {
  formulasVisible = !formulasVisible;
  var boxes = document.querySelectorAll('.formula-box');
  boxes.forEach(function(box) {
    box.classList.toggle('visible', formulasVisible);
  });
  showToast(formulasVisible ? 'Formulas shown' : 'Formulas hidden', 'info');
}

// Toggle compare mode
function toggleCompareMode() {
  compareModeActive = !compareModeActive;
  var panel = document.getElementById('compareModePanel');
  panel.style.display = compareModeActive ? 'block' : 'none';
  
  if (compareModeActive) {
    updateCompareMode();
  }
  showToast(compareModeActive ? 'Compare mode enabled' : 'Compare mode disabled', 'info');
}

function updateCompareMode() {
  var compareA = document.getElementById('compareA');
  var compareB = document.getElementById('compareB');
  
  compareA.innerHTML = '<p><strong>Detention Time:</strong> ' + document.getElementById('dt_result').textContent + ' hrs</p>' +
    '<p><strong>SOR:</strong> ' + document.getElementById('sor_result').textContent + ' GPD/ft¬≤</p>' +
    '<p><strong>SRT:</strong> ' + document.getElementById('srt_result').textContent + ' days</p>' +
    '<p><strong>O‚ÇÇ Required:</strong> ' + document.getElementById('o2_result').textContent + ' lb/d</p>';
  
  compareB.innerHTML = '<p style="color:#94a3b8">Modify input values above to see comparison</p>';
}

// Detention Time Calculator
function calcDetentionTime() {
  var vol = parseFloat(document.getElementById('dt_volume').value) || 0;
  var flow = parseFloat(document.getElementById('dt_flow').value) || 0;
  
  var dt = 0;
  if (flow > 0) {
    dt = (vol * 24) / flow; // hours for US units
  }
  
  document.getElementById('dt_result').textContent = dt.toFixed(2);
  document.getElementById('dt_formula').textContent = 'HRT = (Volume √ó 24) / Flow = (' + vol.toFixed(1) + ' MG √ó 24) / ' + flow.toFixed(1) + ' MGD = ' + dt.toFixed(2) + ' hrs';
  
  validateInput('dt_volume', vol, 0.1, 100);
  validateInput('dt_flow', flow, 0.1, 100);
}

// Surface Overflow Rate Calculator
function calcSOR_Clarifier() {
  var flow = parseFloat(document.getElementById('sor_flow').value) || 0;
  var dia = parseFloat(document.getElementById('sor_dia').value) || 0;
  var num = parseFloat(document.getElementById('sor_num').value) || 1;
  
  var area = Math.PI * Math.pow(dia/2, 2) * num; // total sq ft
  var sor = 0;
  if (area > 0) {
    sor = (flow * 1000000) / area;
  }
  
  var resultEl = document.getElementById('sor_result');
  var statusEl = document.getElementById('sor_status');
  
  resultEl.textContent = Math.round(sor).toLocaleString();
  
  if (sor < 300) {
    resultEl.style.color = '#f59e0b';
    statusEl.textContent = '‚ö† Low (may be oversized)';
    statusEl.style.color = '#f59e0b';
  } else if (sor <= 800) {
    resultEl.style.color = '#10b981';
    statusEl.textContent = '‚úì Good (300-800 typical)';
    statusEl.style.color = '#10b981';
  } else if (sor <= 1200) {
    resultEl.style.color = '#f59e0b';
    statusEl.textContent = '‚ö† High (may affect settling)';
    statusEl.style.color = '#f59e0b';
  } else {
    resultEl.style.color = '#ef4444';
    statusEl.textContent = '‚úó Too High (>1200)';
    statusEl.style.color = '#ef4444';
  }
  
  document.getElementById('sor_formula').textContent = 'SOR = Flow / Area = ' + (flow*1000000).toLocaleString() + ' GPD / ' + Math.round(area).toLocaleString() + ' sq ft = ' + Math.round(sor) + ' GPD/ft¬≤';
}

// Weir Loading Calculator
function calcWeirLoading() {
  var flow = parseFloat(document.getElementById('weir_flow').value) || 0;
  var length = parseFloat(document.getElementById('weir_length').value) || 0;
  
  var wlr = 0;
  if (length > 0) {
    wlr = (flow * 1000000) / length;
  }
  
  var resultEl = document.getElementById('weir_result');
  var statusEl = document.getElementById('weir_status');
  
  resultEl.textContent = Math.round(wlr).toLocaleString();
  
  if (wlr <= 10000) {
    resultEl.style.color = '#10b981';
    statusEl.textContent = '‚úì Good (<10,000 typical)';
    statusEl.style.color = '#10b981';
  } else if (wlr <= 15000) {
    resultEl.style.color = '#f59e0b';
    statusEl.textContent = '‚ö† Elevated (may cause currents)';
    statusEl.style.color = '#f59e0b';
  } else {
    resultEl.style.color = '#ef4444';
    statusEl.textContent = '‚úó Too High (>15,000)';
    statusEl.style.color = '#ef4444';
  }
  
  document.getElementById('weir_formula').textContent = 'WLR = Flow / Weir Length = ' + (flow*1000000).toLocaleString() + ' / ' + length + ' = ' + Math.round(wlr).toLocaleString() + ' GPD/ft';
}

// Oxygen Requirement Calculator
function calcOxygenReq() {
  var bod = parseFloat(document.getElementById('o2_bod').value) || 0;
  var tkn = parseFloat(document.getElementById('o2_tkn').value) || 0;
  
  // O2 = 1.5 √ó BOD removed + 4.6 √ó TKN oxidized (nitrification)
  var o2 = (1.5 * bod) + (4.6 * tkn);
  var o2hr = o2 / 24;
  
  document.getElementById('o2_result').textContent = Math.round(o2).toLocaleString();
  document.getElementById('o2_hourly').textContent = Math.round(o2hr) + ' lb/hr';
  document.getElementById('o2_formula').textContent = 'O‚ÇÇ = 1.5√óBOD + 4.6√óTKN = 1.5√ó' + bod + ' + 4.6√ó' + tkn + ' = ' + Math.round(o2).toLocaleString() + ' lb/d';
}

// Chemical Cost Calculator
function calcChemCost() {
  var flow = parseFloat(document.getElementById('chem_flow').value) || 0;
  var dose = parseFloat(document.getElementById('chem_dose').value) || 0;
  var cost = parseFloat(document.getElementById('chem_cost').value) || 0;
  
  var lbsPerDay = flow * dose * 8.34;
  var dailyCost = lbsPerDay * cost;
  var monthlyCost = dailyCost * 30;
  var yearlyCost = dailyCost * 365;
  
  document.getElementById('chem_daily').textContent = '$' + Math.round(dailyCost).toLocaleString();
  document.getElementById('chem_monthly').textContent = '$' + Math.round(monthlyCost).toLocaleString() + '/month ‚Ä¢ $' + Math.round(yearlyCost).toLocaleString() + '/year';
  document.getElementById('chem_formula').textContent = 'lbs/d = Flow √ó Dose √ó 8.34 = ' + flow + ' √ó ' + dose + ' √ó 8.34 = ' + Math.round(lbsPerDay).toLocaleString() + ' lb/d √ó $' + cost.toFixed(2) + ' = $' + Math.round(dailyCost) + '/d';
}

// SRT Calculator
function calcSRT() {
  var vol = parseFloat(document.getElementById('srt_vol').value) || 0;
  var mlss = parseFloat(document.getElementById('srt_mlss').value) || 0;
  var was = parseFloat(document.getElementById('srt_was').value) || 0;
  var wasTss = parseFloat(document.getElementById('srt_wastss').value) || 0;
  
  var mlssInv = vol * mlss * 8.34; // lbs in system
  var wasSolids = was * wasTss * 8.34 / 1000000; // lbs/day wasted
  
  var srt = 0;
  if (wasSolids > 0) {
    srt = mlssInv / (wasSolids * 1000000);
  }
  
  var resultEl = document.getElementById('srt_result');
  var statusEl = document.getElementById('srt_status');
  
  resultEl.textContent = srt.toFixed(1);
  
  if (srt < 3) {
    resultEl.style.color = '#ef4444';
    statusEl.textContent = '‚úó Too Low (washout risk)';
    statusEl.style.color = '#ef4444';
  } else if (srt < 5) {
    resultEl.style.color = '#f59e0b';
    statusEl.textContent = '‚ö† Low (limited nitrification)';
    statusEl.style.color = '#f59e0b';
  } else if (srt <= 15) {
    resultEl.style.color = '#10b981';
    statusEl.textContent = '‚úì Good for nitrification';
    statusEl.style.color = '#10b981';
  } else if (srt <= 25) {
    resultEl.style.color = '#f59e0b';
    statusEl.textContent = '‚ö† High (check for Nocardia)';
    statusEl.style.color = '#f59e0b';
  } else {
    resultEl.style.color = '#ef4444';
    statusEl.textContent = '‚úó Very High (foam risk)';
    statusEl.style.color = '#ef4444';
  }
  
  document.getElementById('srt_formula').textContent = 'SRT = (Vol √ó MLSS √ó 8.34) / (WAS √ó WAS_TSS √ó 8.34) = ' + srt.toFixed(1) + ' days';
  
  // Update gauge
  updateGauge('srt', srt, 0, 30, 5, 15);
}

// Update gauge visualization
function updateGauge(type, value, min, max, optMin, optMax) {
  var gaugeEl = document.getElementById(type + 'Gauge');
  var valueEl = document.getElementById(type + 'GaugeValue');
  var cardEl = document.getElementById(type + 'Card');
  var statusEl = document.getElementById(type + 'Status');
  
  if (!gaugeEl) return;
  
  var percent = Math.min(100, Math.max(0, ((value - min) / (max - min)) * 100));
  var offset = 173 - (173 * percent / 100);
  
  gaugeEl.style.strokeDashoffset = offset;
  valueEl.textContent = value.toFixed(1);
  
  // Color based on optimal range
  if (value >= optMin && value <= optMax) {
    gaugeEl.setAttribute('stroke', '#10b981');
    cardEl.className = 'calc-result-card optimal';
    statusEl.className = 'status-badge optimal';
    statusEl.textContent = '‚úì Optimal';
  } else if (value < optMin * 0.5 || value > optMax * 1.5) {
    gaugeEl.setAttribute('stroke', '#ef4444');
    cardEl.className = 'calc-result-card critical';
    statusEl.className = 'status-badge critical';
    statusEl.textContent = '‚úó Critical';
  } else {
    gaugeEl.setAttribute('stroke', '#f59e0b');
    cardEl.className = 'calc-result-card warning';
    statusEl.className = 'status-badge warning';
    statusEl.textContent = '‚ö† Warning';
  }
}

// Input validation with visual feedback
function validateInput(inputId, value, min, max) {
  var input = document.getElementById(inputId);
  if (!input) return;
  
  input.classList.remove('valid', 'invalid', 'warning-range');
  
  if (value < min || value > max) {
    input.classList.add('invalid');
  } else if (value < min * 1.2 || value > max * 0.8) {
    input.classList.add('warning-range');
  } else {
    input.classList.add('valid');
  }
}

// Save calculation results
function saveCalcResults() {
  var result = {
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString(),
    detentionTime: document.getElementById('dt_result').textContent,
    sor: document.getElementById('sor_result').textContent,
    weirLoading: document.getElementById('weir_result').textContent,
    oxygenReq: document.getElementById('o2_result').textContent,
    chemCost: document.getElementById('chem_daily').textContent,
    srt: document.getElementById('srt_result').textContent
  };
  
  calcHistory.unshift(result);
  if (calcHistory.length > 50) calcHistory.pop(); // Keep last 50
  
  localStorage.setItem('wwtp_calc_history', JSON.stringify(calcHistory));
  showToast('üíæ Results saved to history', 'success');
}

// Load calculation history
function loadCalcHistory() {
  try {
    var saved = localStorage.getItem('wwtp_calc_history');
    if (saved) {
      calcHistory = JSON.parse(saved);
    }
  } catch(e) {
    console.error('Error loading calc history:', e);
    calcHistory = [];
  }
}

// Show calculation history modal
function showCalcHistory() {
  var modal = document.getElementById('calcHistoryModal');
  var list = document.getElementById('calcHistoryList');
  
  if (calcHistory.length === 0) {
    list.innerHTML = '<p style="color:#94a3b8;text-align:center">No saved calculations yet.</p>';
  } else {
    var html = '';
    calcHistory.forEach(function(item, index) {
      html += '<div class="calc-history-item">';
      html += '<div>';
      html += '<div class="timestamp">' + item.date + ' ' + item.time + '</div>';
      html += '<div class="values">DT: ' + item.detentionTime + 'hr ‚Ä¢ SOR: ' + item.sor + ' ‚Ä¢ SRT: ' + item.srt + 'd</div>';
      html += '</div>';
      html += '<button onclick="loadHistoryItem(' + index + ')" style="background:#3b82f6;border:none;color:white;padding:6px 12px;border-radius:6px;cursor:pointer">Load</button>';
      html += '</div>';
    });
    list.innerHTML = html;
  }
  
  modal.style.display = 'block';
}

function closeCalcHistory() {
  document.getElementById('calcHistoryModal').style.display = 'none';
}

function clearCalcHistory() {
  if (confirm('Clear all calculation history?')) {
    calcHistory = [];
    localStorage.removeItem('wwtp_calc_history');
    showCalcHistory();
    showToast('History cleared', 'info');
  }
}

function loadHistoryItem(index) {
  // Could restore inputs from history item
  showToast('Historical values: DT=' + calcHistory[index].detentionTime + ', SRT=' + calcHistory[index].srt, 'info');
  closeCalcHistory();
}

// Export calculation results
function exportCalcResults() {
  var csv = 'Parameter,Value,Unit,Status\n';
  csv += 'Detention Time,' + document.getElementById('dt_result').textContent + ',hours,\n';
  csv += 'Surface Overflow Rate,' + document.getElementById('sor_result').textContent + ',GPD/ft¬≤,' + document.getElementById('sor_status').textContent + '\n';
  csv += 'Weir Loading,' + document.getElementById('weir_result').textContent + ',GPD/ft,' + document.getElementById('weir_status').textContent + '\n';
  csv += 'Oxygen Required,' + document.getElementById('o2_result').textContent + ',lb O2/day,\n';
  csv += 'Chemical Cost,' + document.getElementById('chem_daily').textContent + ',$/day,\n';
  csv += 'SRT,' + document.getElementById('srt_result').textContent + ',days,' + document.getElementById('srt_status').textContent + '\n';
  
  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_calculations_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('üì§ Results exported to CSV', 'success');
}

function exportCalcHistory() {
  if (calcHistory.length === 0) {
    showToast('No history to export', 'error');
    return;
  }
  
  var csv = 'Date,Time,Detention Time (hr),SOR (GPD/ft¬≤),Weir Loading (GPD/ft),O2 Required (lb/d),Chemical Cost ($/d),SRT (days)\n';
  calcHistory.forEach(function(item) {
    csv += item.date + ',' + item.time + ',' + item.detentionTime + ',' + item.sor + ',' + item.weirLoading + ',' + item.oxygenReq + ',' + item.chemCost + ',' + item.srt + '\n';
  });
  
  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_calc_history_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('üì§ History exported to CSV', 'success');
  closeCalcHistory();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initEnhancedCalculators);
if (document.readyState !== 'loading') {
  initEnhancedCalculators();
}

// ========== END ENHANCED CALCULATORS SYSTEM ==========


// ========== PDF REPORT GENERATOR SYSTEM ==========

var selectedReportType = null;

// Initialize report date to today
document.addEventListener('DOMContentLoaded', function() {
  var dateInput = document.getElementById('rpt_date');
  if (dateInput) {
    dateInput.value = new Date().toISOString().split('T')[0];
  }
  loadBrandingSettings();
});

// Select report type
function selectReportType(type) {
  selectedReportType = type;
  
  // Update card styles
  ['daily', 'process', 'visit', 'calc'].forEach(function(t) {
    var card = document.getElementById('rptCard_' + t);
    if (card) {
      card.style.borderColor = (t === type) ? '#fbbf24' : 'transparent';
      card.style.transform = (t === type) ? 'scale(1.02)' : 'scale(1)';
    }
  });
  
  // Show configuration section
  document.getElementById('reportConfigSection').style.display = 'block';
  
  // Update title
  var titles = {
    daily: 'üìÖ Daily Operations Report Configuration',
    process: '‚öôÔ∏è Process Summary Report Configuration',
    visit: 'üè≠ Client Visit Report Configuration',
    calc: 'üßÆ Calculation Report Configuration'
  };
  document.getElementById('reportConfigTitle').textContent = titles[type];
  
  // Show/hide specific fields
  document.getElementById('dailyFields').style.display = (type === 'daily') ? 'block' : 'none';
  document.getElementById('visitFields').style.display = (type === 'visit') ? 'block' : 'none';
  
  // Scroll to config
  document.getElementById('reportConfigSection').scrollIntoView({ behavior: 'smooth' });
  
  showToast('Selected: ' + titles[type].split(' Configuration')[0], 'info');
}

// Load from profile
function loadProfileToReport() {
  var profileSelect = document.getElementById('profileSelect');
  if (!profileSelect || !profileSelect.value) {
    showToast('No profile selected. Go to Profiles panel first.', 'error');
    return;
  }
  
  var profiles = JSON.parse(localStorage.getItem('wwtp_plant_profiles') || '[]');
  var profile = profiles[profileSelect.value];
  
  if (profile) {
    document.getElementById('rpt_plant').value = profile.plantName || profile.name || '';
    document.getElementById('rpt_client').value = profile.client || '';
    document.getElementById('rpt_permit').value = profile.permit || '';
    document.getElementById('rpt_designflow').value = profile.designFlow || '';
    document.getElementById('rpt_process').value = profile.processType || 'Conventional AS';
    
    // Also load values
    document.getElementById('rpt_flow').value = profile.flow || '3.5';
    document.getElementById('rpt_mlss').value = profile.mlss || '3000';
    
    showToast('‚úÖ Loaded from profile: ' + profile.name, 'success');
  }
}

// Load from Master Settings
function loadMasterToReport() {
  var flow = document.getElementById('masterFlowPC')?.value || '3.5';
  var bod = document.getElementById('masterBODPC')?.value || '200';
  var mlss = document.getElementById('masterMLSSPC')?.value || '3000';
  
  document.getElementById('rpt_flow').value = flow;
  document.getElementById('rpt_bod').value = bod;
  document.getElementById('rpt_mlss').value = mlss;
  
  showToast('‚úÖ Loaded from Master Settings', 'success');
}

// Save branding settings
function saveBrandingSettings() {
  var branding = {
    company: document.getElementById('rpt_company')?.value || '',
    consultant: document.getElementById('rpt_consultant')?.value || '',
    phone: document.getElementById('rpt_phone')?.value || '',
    email: document.getElementById('rpt_email')?.value || '',
    license: document.getElementById('rpt_license')?.value || ''
  };
  localStorage.setItem('wwtp_branding', JSON.stringify(branding));
  showToast('üíæ Branding saved!', 'success');
}

// Load branding settings
function loadBrandingSettings() {
  try {
    var branding = JSON.parse(localStorage.getItem('wwtp_branding') || '{}');
    if (branding.company) document.getElementById('rpt_company').value = branding.company;
    if (branding.consultant) document.getElementById('rpt_consultant').value = branding.consultant;
    if (branding.phone) document.getElementById('rpt_phone').value = branding.phone;
    if (branding.email) document.getElementById('rpt_email').value = branding.email;
    if (branding.license) document.getElementById('rpt_license').value = branding.license;
  } catch(e) {
    console.log('No saved branding');
  }
}

// Preview Report
function previewReport() {
  if (!selectedReportType) {
    showToast('Please select a report type first', 'error');
    return;
  }
  
  var html = generateReportHTML(selectedReportType);
  document.getElementById('reportPreviewContent').innerHTML = html;
  document.getElementById('reportPreviewArea').style.display = 'block';
  document.getElementById('reportPreviewArea').scrollIntoView({ behavior: 'smooth' });
}

function closeReportPreview() {
  document.getElementById('reportPreviewArea').style.display = 'none';
}

// Generate Report HTML
function generateReportHTML(type) {
  var company = document.getElementById('rpt_company')?.value || 'WWTP Consulting';
  var consultant = document.getElementById('rpt_consultant')?.value || '';
  var phone = document.getElementById('rpt_phone')?.value || '';
  var email = document.getElementById('rpt_email')?.value || '';
  var license = document.getElementById('rpt_license')?.value || '';
  
  var plant = document.getElementById('rpt_plant')?.value || 'Plant Name';
  var client = document.getElementById('rpt_client')?.value || '';
  var permit = document.getElementById('rpt_permit')?.value || '';
  var rptDate = document.getElementById('rpt_date')?.value || new Date().toISOString().split('T')[0];
  var processType = document.getElementById('rpt_process')?.value || '';
  var designFlow = document.getElementById('rpt_designflow')?.value || '';
  
  var notes = document.getElementById('rpt_notes')?.value || '';
  
  var html = '';
  
  // Header
  html += '<div style="border-bottom:3px solid #059669;padding-bottom:20px;margin-bottom:20px">';
  html += '<h1 style="margin:0;color:#059669;font-size:18px">' + company + '</h1>';
  if (consultant) html += '<p style="margin:5px 0;font-size:14px"><strong>Consultant:</strong> ' + consultant + '</p>';
  var contactLine = [];
  if (phone) contactLine.push(phone);
  if (email) contactLine.push(email);
  if (license) contactLine.push('License: ' + license);
  if (contactLine.length) html += '<p style="margin:5px 0;font-size:13px;color:#666">' + contactLine.join(' | ') + '</p>';
  html += '</div>';
  
  // Report Title
  var titles = {
    daily: 'üìÖ Daily Operations Report',
    process: '‚öôÔ∏è Process Summary Report',
    visit: 'üè≠ Client Visit Report',
    calc: 'üßÆ Calculation Report'
  };
  html += '<h2 style="text-align:center;color:#1e3a5f;margin-bottom:20px">' + titles[type] + '</h2>';
  
  // Plant Info Box
  html += '<div style="background:#f0f9ff;padding:15px;border-radius:8px;margin-bottom:20px">';
  html += '<table style="width:100%;border-collapse:collapse">';
  html += '<tr><td style="padding:5px"><strong>Plant:</strong> ' + plant + '</td>';
  html += '<td style="padding:5px"><strong>Date:</strong> ' + formatDate(rptDate) + '</td></tr>';
  if (client) html += '<tr><td style="padding:5px"><strong>Client:</strong> ' + client + '</td>';
  if (permit) html += '<td style="padding:5px"><strong>Permit #:</strong> ' + permit + '</td></tr>';
  if (processType || designFlow) {
    html += '<tr>';
    if (processType) html += '<td style="padding:5px"><strong>Process:</strong> ' + processType + '</td>';
    if (designFlow) html += '<td style="padding:5px"><strong>Design Flow:</strong> ' + designFlow + ' MGD</td>';
    html += '</tr>';
  }
  html += '</table></div>';
  
  // Type-specific content
  if (type === 'daily') {
    html += generateDailyContent();
  } else if (type === 'process') {
    html += generateProcessContent();
  } else if (type === 'visit') {
    html += generateVisitContent();
  } else if (type === 'calc') {
    html += generateCalcContent();
  }
  
  // Notes
  if (notes) {
    html += '<div style="margin-top:20px;padding:15px;background:#fef3c7;border-radius:8px">';
    html += '<h4 style="margin:0 0 10px 0;color:#92400e">üìù Notes</h4>';
    html += '<p style="margin:0;white-space:pre-wrap">' + notes + '</p>';
    html += '</div>';
  }
  
  // Footer
  html += '<div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb;text-align:center;color:#6b7280;font-size:12px">';
  html += '<p>Report generated by WWTP Command Center v9.9.16 on ' + new Date().toLocaleString() + '</p>';
  html += '<p>' + company + '</p>';
  html += '</div>';
  
  return html;
}

// Daily Operations Content
function generateDailyContent() {
  var flow = document.getElementById('rpt_flow')?.value || '-';
  var bod = document.getElementById('rpt_bod')?.value || '-';
  var tss = document.getElementById('rpt_tss')?.value || '-';
  var mlss = document.getElementById('rpt_mlss')?.value || '-';
  var doVal = document.getElementById('rpt_do')?.value || '-';
  var ph = document.getElementById('rpt_ph')?.value || '-';
  var effBod = document.getElementById('rpt_eff_bod')?.value || '-';
  var effTss = document.getElementById('rpt_eff_tss')?.value || '-';
  var effNh3 = document.getElementById('rpt_eff_nh3')?.value || '-';
  
  var html = '<h3 style="color:#059669;border-bottom:2px solid #059669;padding-bottom:5px">Influent Parameters</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#e0f2fe"><th style="padding:10px;text-align:left;border:1px solid #bae6fd">Parameter</th><th style="padding:10px;text-align:center;border:1px solid #bae6fd">Value</th><th style="padding:10px;text-align:center;border:1px solid #bae6fd">Unit</th><th style="padding:10px;text-align:center;border:1px solid #bae6fd">Status</th></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Flow Rate</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + flow + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">MGD</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">BOD</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + bod + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">TSS</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + tss + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '</table>';
  
  html += '<h3 style="color:#f97316;border-bottom:2px solid #f97316;padding-bottom:5px">Process Parameters</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#ffedd5"><th style="padding:10px;text-align:left;border:1px solid #fed7aa">Parameter</th><th style="padding:10px;text-align:center;border:1px solid #fed7aa">Value</th><th style="padding:10px;text-align:center;border:1px solid #fed7aa">Unit</th><th style="padding:10px;text-align:center;border:1px solid #fed7aa">Status</th></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">MLSS</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + mlss + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">DO</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + doVal + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">pH</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + ph + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">-</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '</table>';
  
  html += '<h3 style="color:#10b981;border-bottom:2px solid #10b981;padding-bottom:5px">Effluent Quality</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#d1fae5"><th style="padding:10px;text-align:left;border:1px solid #a7f3d0">Parameter</th><th style="padding:10px;text-align:center;border:1px solid #a7f3d0">Value</th><th style="padding:10px;text-align:center;border:1px solid #a7f3d0">Unit</th><th style="padding:10px;text-align:center;border:1px solid #a7f3d0">Status</th></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Effluent BOD</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + effBod + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;color:#10b981">‚úì Pass</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Effluent TSS</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + effTss + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;color:#10b981">‚úì Pass</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Effluent NH‚ÇÉ-N</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + effNh3 + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;color:#10b981">‚úì Pass</td></tr>';
  html += '</table>';
  
  return html;
}

// Process Summary Content
function generateProcessContent() {
  var dt = document.getElementById('dt_result')?.textContent || '-';
  var sor = document.getElementById('sor_result')?.textContent || '-';
  var weir = document.getElementById('weir_result')?.textContent || '-';
  var o2 = document.getElementById('o2_result')?.textContent || '-';
  var srt = document.getElementById('srt_result')?.textContent || '-';
  var chemCost = document.getElementById('chem_daily')?.textContent || '-';
  
  var html = '<h3 style="color:#6366f1;border-bottom:2px solid #6366f1;padding-bottom:5px">Process Calculations Summary</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#e0e7ff"><th style="padding:10px;text-align:left;border:1px solid #c7d2fe">Parameter</th><th style="padding:10px;text-align:center;border:1px solid #c7d2fe">Calculated Value</th><th style="padding:10px;text-align:center;border:1px solid #c7d2fe">Unit</th><th style="padding:10px;text-align:center;border:1px solid #c7d2fe">Target Range</th></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Detention Time</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + dt + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">hours</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">4-8 hrs</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Surface Overflow Rate</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + sor + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">GPD/ft¬≤</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">300-800</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Weir Loading</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + weir + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">GPD/ft</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">&lt;10,000</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Oxygen Required</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + o2 + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">lb/day</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">-</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">SRT (Sludge Age)</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + srt + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">days</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">5-15 days</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Chemical Cost</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + chemCost + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">per day</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">-</td></tr>';
  html += '</table>';
  
  return html;
}

// Client Visit Content
function generateVisitContent() {
  var purpose = document.getElementById('rpt_purpose')?.value || '';
  var time = document.getElementById('rpt_time')?.value || '';
  var findings = document.getElementById('rpt_findings')?.value || '';
  var recommendations = document.getElementById('rpt_recommendations')?.value || '';
  var actions = document.getElementById('rpt_actions')?.value || '';
  
  var html = '';
  
  html += '<div style="background:#f0f9ff;padding:15px;border-radius:8px;margin-bottom:15px">';
  html += '<p><strong>Visit Purpose:</strong> ' + purpose + '</p>';
  if (time) html += '<p><strong>Time On-Site:</strong> ' + time + '</p>';
  html += '</div>';
  
  if (findings) {
    html += '<h3 style="color:#dc2626;border-bottom:2px solid #dc2626;padding-bottom:5px">üîç Key Findings</h3>';
    html += '<div style="background:#fef2f2;padding:15px;border-radius:8px;margin-bottom:15px;white-space:pre-wrap">' + findings + '</div>';
  }
  
  if (recommendations) {
    html += '<h3 style="color:#059669;border-bottom:2px solid #059669;padding-bottom:5px">‚úÖ Recommendations</h3>';
    html += '<div style="background:#d1fae5;padding:15px;border-radius:8px;margin-bottom:15px;white-space:pre-wrap">' + recommendations + '</div>';
  }
  
  if (actions) {
    html += '<h3 style="color:#f97316;border-bottom:2px solid #f97316;padding-bottom:5px">üìã Action Items</h3>';
    html += '<div style="background:#ffedd5;padding:15px;border-radius:8px;margin-bottom:15px;white-space:pre-wrap">' + actions + '</div>';
  }
  
  return html;
}

// Calculation Report Content
function generateCalcContent() {
  var html = '<h3 style="color:#0ea5e9;border-bottom:2px solid #0ea5e9;padding-bottom:5px">üßÆ Complete Calculation Report</h3>';
  
  // Get all enhanced calculator values
  var calcs = [
    { name: 'Detention Time', value: document.getElementById('dt_result')?.textContent || '-', unit: 'hours', formula: 'HRT = (Volume √ó 24) / Flow' },
    { name: 'Surface Overflow Rate', value: document.getElementById('sor_result')?.textContent || '-', unit: 'GPD/ft¬≤', formula: 'SOR = Flow / Surface Area' },
    { name: 'Weir Loading', value: document.getElementById('weir_result')?.textContent || '-', unit: 'GPD/ft', formula: 'WLR = Flow / Weir Length' },
    { name: 'Oxygen Requirement', value: document.getElementById('o2_result')?.textContent || '-', unit: 'lb O‚ÇÇ/day', formula: 'O‚ÇÇ = 1.5√óBOD + 4.6√óTKN' },
    { name: 'Chemical Cost', value: document.getElementById('chem_daily')?.textContent || '-', unit: 'per day', formula: 'Cost = Flow √ó Dose √ó 8.34 √ó Unit Cost' },
    { name: 'SRT (Sludge Age)', value: document.getElementById('srt_result')?.textContent || '-', unit: 'days', formula: 'SRT = MLSS Inventory / WAS Solids' }
  ];
  
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#e0f2fe"><th style="padding:10px;text-align:left;border:1px solid #bae6fd">Calculation</th><th style="padding:10px;text-align:center;border:1px solid #bae6fd">Result</th><th style="padding:10px;text-align:center;border:1px solid #bae6fd">Unit</th><th style="padding:10px;text-align:left;border:1px solid #bae6fd">Formula</th></tr>';
  
  calcs.forEach(function(calc) {
    html += '<tr>';
    html += '<td style="padding:8px;border:1px solid #e5e7eb;font-weight:bold">' + calc.name + '</td>';
    html += '<td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-size:16px;font-weight:bold;color:#0ea5e9">' + calc.value + '</td>';
    html += '<td style="padding:8px;text-align:center;border:1px solid #e5e7eb">' + calc.unit + '</td>';
    html += '<td style="padding:8px;border:1px solid #e5e7eb;font-family:monospace;font-size:12px;color:#6b7280">' + calc.formula + '</td>';
    html += '</tr>';
  });
  
  html += '</table>';
  
  return html;
}

// Format date
function formatDate(dateStr) {
  if (!dateStr) return '-';
  var d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

// Generate PDF
function generatePDFReport() {
  if (!selectedReportType) {
    showToast('Please select a report type first', 'error');
    return;
  }
  
  var html = generateReportHTML(selectedReportType);
  
  var printWindow = window.open('', '_blank');
  printWindow.document.write('<!DOCTYPE html><html><head><title>WWTP Report</title>');
  printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto;color:#1e3a5f}table{width:100%}@media print{body{padding:20px}}</style>');
  printWindow.document.write('</head><body>');
  printWindow.document.write(html);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  
  setTimeout(function() {
    printWindow.print();
  }, 500);
  
  showToast('üìÑ Report generated - use Print > Save as PDF', 'success');
}

// Print report
function printReport() {
  if (!selectedReportType) {
    showToast('Please select a report type first', 'error');
    return;
  }
  generatePDFReport();
}

// Export all calculations to CSV
function exportAllCalculations() {
  var csv = 'Parameter,Value,Unit\n';
  csv += 'Flow Rate,' + (document.getElementById('masterFlowPC')?.value || '-') + ',MGD\n';
  csv += 'Aeration Volume,' + (document.getElementById('masterAerVolPC')?.value || '-') + ',MG\n';
  csv += 'BOD,' + (document.getElementById('masterBODPC')?.value || '-') + ',mg/L\n';
  csv += 'MLSS,' + (document.getElementById('masterMLSSPC')?.value || '-') + ',mg/L\n';
  csv += 'Detention Time,' + (document.getElementById('dt_result')?.textContent || '-') + ',hours\n';
  csv += 'Surface Overflow Rate,' + (document.getElementById('sor_result')?.textContent || '-') + ',GPD/ft¬≤\n';
  csv += 'Weir Loading,' + (document.getElementById('weir_result')?.textContent || '-') + ',GPD/ft\n';
  csv += 'Oxygen Required,' + (document.getElementById('o2_result')?.textContent || '-') + ',lb/day\n';
  csv += 'SRT,' + (document.getElementById('srt_result')?.textContent || '-') + ',days\n';
  
  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_calculations_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('üìä Calculations exported to CSV', 'success');
}

// Export daily log
function exportDailyLog() {
  var date = new Date().toISOString().split('T')[0];
  var csv = 'Date,Flow (MGD),BOD (mg/L),TSS (mg/L),MLSS (mg/L),DO (mg/L),pH,Eff BOD,Eff TSS,Eff NH3\n';
  csv += date + ',';
  csv += (document.getElementById('rpt_flow')?.value || '-') + ',';
  csv += (document.getElementById('rpt_bod')?.value || '-') + ',';
  csv += (document.getElementById('rpt_tss')?.value || '-') + ',';
  csv += (document.getElementById('rpt_mlss')?.value || '-') + ',';
  csv += (document.getElementById('rpt_do')?.value || '-') + ',';
  csv += (document.getElementById('rpt_ph')?.value || '-') + ',';
  csv += (document.getElementById('rpt_eff_bod')?.value || '-') + ',';
  csv += (document.getElementById('rpt_eff_tss')?.value || '-') + ',';
  csv += (document.getElementById('rpt_eff_nh3')?.value || '-') + '\n';
  
  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_daily_log_' + date + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('üìÖ Daily log exported', 'success');
}

// ========== END PDF REPORT GENERATOR SYSTEM ==========


// ========== ALARM/ALERT SYSTEM ==========

var alertSettings = {
  bod_max: 30,
  tss_max: 30,
  nh3_max: 5,
  mlss_min: 1500,
  mlss_max: 4500,
  do_min: 1.0,
  svi_max: 150,
  flow_max: 10,
  ph_min: 6.0,
  ph_max: 9.0
};

var alertHistory = [];

// Initialize alert system
function initAlertSystem() {
  loadAlertSettings();
  loadAlertHistory();
  checkAlerts();
}

// Toggle alert settings panel
function toggleAlertSettings() {
  var panel = document.getElementById('alertSettings');
  var history = document.getElementById('alertHistory');
  if (panel) {
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    if (history) history.style.display = 'none';
  }
}

// View alert history
function viewAlertHistory() {
  var panel = document.getElementById('alertHistory');
  var settings = document.getElementById('alertSettings');
  if (panel) {
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    if (settings) settings.style.display = 'none';
  }
  renderAlertHistory();
}

// Save alert settings
function saveAlertSettings() {
  alertSettings = {
    bod_max: parseFloat(document.getElementById('alert_bod_max')?.value) || 30,
    tss_max: parseFloat(document.getElementById('alert_tss_max')?.value) || 30,
    nh3_max: parseFloat(document.getElementById('alert_nh3_max')?.value) || 5,
    mlss_min: parseFloat(document.getElementById('alert_mlss_min')?.value) || 1500,
    mlss_max: parseFloat(document.getElementById('alert_mlss_max')?.value) || 4500,
    do_min: parseFloat(document.getElementById('alert_do_min')?.value) || 1.0,
    svi_max: parseFloat(document.getElementById('alert_svi_max')?.value) || 150,
    flow_max: parseFloat(document.getElementById('alert_flow_max')?.value) || 10,
    ph_min: parseFloat(document.getElementById('alert_ph_min')?.value) || 6.0,
    ph_max: parseFloat(document.getElementById('alert_ph_max')?.value) || 9.0
  };
  localStorage.setItem('wwtp_alert_settings', JSON.stringify(alertSettings));
  showToast('‚úÖ Alert settings saved', 'success');
  checkAlerts();
}

// Load alert settings
function loadAlertSettings() {
  try {
    var saved = JSON.parse(localStorage.getItem('wwtp_alert_settings'));
    if (saved) {
      alertSettings = saved;
      // Populate form
      if (document.getElementById('alert_bod_max')) document.getElementById('alert_bod_max').value = alertSettings.bod_max;
      if (document.getElementById('alert_tss_max')) document.getElementById('alert_tss_max').value = alertSettings.tss_max;
      if (document.getElementById('alert_nh3_max')) document.getElementById('alert_nh3_max').value = alertSettings.nh3_max;
      if (document.getElementById('alert_mlss_min')) document.getElementById('alert_mlss_min').value = alertSettings.mlss_min;
      if (document.getElementById('alert_mlss_max')) document.getElementById('alert_mlss_max').value = alertSettings.mlss_max;
      if (document.getElementById('alert_do_min')) document.getElementById('alert_do_min').value = alertSettings.do_min;
      if (document.getElementById('alert_svi_max')) document.getElementById('alert_svi_max').value = alertSettings.svi_max;
      if (document.getElementById('alert_flow_max')) document.getElementById('alert_flow_max').value = alertSettings.flow_max;
      if (document.getElementById('alert_ph_min')) document.getElementById('alert_ph_min').value = alertSettings.ph_min;
      if (document.getElementById('alert_ph_max')) document.getElementById('alert_ph_max').value = alertSettings.ph_max;
    }
  } catch(e) {
    console.log('No saved alert settings');
  }
}

// Load default alerts
function loadDefaultAlerts() {
  alertSettings = {
    bod_max: 30, tss_max: 30, nh3_max: 5,
    mlss_min: 1500, mlss_max: 4500, do_min: 1.0,
    svi_max: 150, flow_max: 10, ph_min: 6.0, ph_max: 9.0
  };
  saveAlertSettings();
  showToast('üîÑ Reset to default thresholds', 'info');
}

// Check all alerts
function checkAlerts() {
  var alerts = [];
  var activeAlertsDiv = document.getElementById('activeAlerts');
  var noAlertsMsg = document.getElementById('noAlertsMsg');
  
  // Get current values (from various sources)
  var currentBOD = parseFloat(document.getElementById('rpt_eff_bod')?.value) || parseFloat(document.getElementById('kpi-bod')?.textContent) || 0;
  var currentTSS = parseFloat(document.getElementById('rpt_eff_tss')?.value) || 0;
  var currentNH3 = parseFloat(document.getElementById('rpt_eff_nh3')?.value) || 0;
  var currentMLSS = parseFloat(document.getElementById('masterMLSSPC')?.value) || parseFloat(document.getElementById('kpi-mlss')?.textContent) || 3000;
  var currentDO = parseFloat(document.getElementById('rpt_do')?.value) || 2.0;
  var currentPH = parseFloat(document.getElementById('rpt_ph')?.value) || 7.2;
  var currentFlow = parseFloat(document.getElementById('masterFlowPC')?.value) || parseFloat(document.getElementById('kpi-flow')?.textContent) || 3.5;
  
  // Check each parameter
  if (currentBOD > alertSettings.bod_max) {
    alerts.push({ param: 'BOD', value: currentBOD, limit: alertSettings.bod_max, type: 'high' });
    updateIndicator('ind_bod', 'alert', currentBOD);
  } else {
    updateIndicator('ind_bod', 'ok');
  }
  
  if (currentTSS > alertSettings.tss_max) {
    alerts.push({ param: 'TSS', value: currentTSS, limit: alertSettings.tss_max, type: 'high' });
    updateIndicator('ind_tss', 'alert', currentTSS);
  } else {
    updateIndicator('ind_tss', 'ok');
  }
  
  if (currentNH3 > alertSettings.nh3_max) {
    alerts.push({ param: 'NH‚ÇÉ', value: currentNH3, limit: alertSettings.nh3_max, type: 'high' });
    updateIndicator('ind_nh3', 'alert', currentNH3);
  } else {
    updateIndicator('ind_nh3', 'ok');
  }
  
  if (currentDO < alertSettings.do_min) {
    alerts.push({ param: 'DO', value: currentDO, limit: alertSettings.do_min, type: 'low' });
    updateIndicator('ind_do', 'warning', currentDO);
  } else {
    updateIndicator('ind_do', 'ok');
  }
  
  if (currentMLSS < alertSettings.mlss_min || currentMLSS > alertSettings.mlss_max) {
    alerts.push({ param: 'MLSS', value: currentMLSS, limit: currentMLSS < alertSettings.mlss_min ? alertSettings.mlss_min : alertSettings.mlss_max, type: currentMLSS < alertSettings.mlss_min ? 'low' : 'high' });
    updateIndicator('ind_mlss', 'warning', currentMLSS);
  } else {
    updateIndicator('ind_mlss', 'ok');
  }
  
  if (currentPH < alertSettings.ph_min || currentPH > alertSettings.ph_max) {
    alerts.push({ param: 'pH', value: currentPH, limit: currentPH < alertSettings.ph_min ? alertSettings.ph_min : alertSettings.ph_max, type: currentPH < alertSettings.ph_min ? 'low' : 'high' });
    updateIndicator('ind_ph', 'warning', currentPH);
  } else {
    updateIndicator('ind_ph', 'ok');
  }
  
  // Display alerts
  if (activeAlertsDiv) {
    if (alerts.length === 0) {
      activeAlertsDiv.innerHTML = '<div class="note success"><strong>‚úì All Systems Normal</strong><br>No active alerts. All parameters within limits.</div>';
    } else {
      var html = '';
      alerts.forEach(function(alert) {
        var color = alert.type === 'high' ? '#ef4444' : '#fbbf24';
        html += '<div class="note" style="background:rgba(' + (alert.type === 'high' ? '239,68,68' : '251,191,36') + ',0.2);border-left-color:' + color + ';margin-bottom:10px">';
        html += '<strong style="color:' + color + '">‚ö†Ô∏è ' + alert.param + ' ' + alert.type.toUpperCase() + '</strong><br>';
        html += 'Current: <strong>' + alert.value + '</strong> | Limit: ' + alert.limit;
        html += '</div>';
        
        // Log to history
        logAlert(alert);
      });
      activeAlertsDiv.innerHTML = html;
    }
  }
  
  return alerts;
}

// Update indicator
function updateIndicator(id, status, value) {
  var el = document.getElementById(id);
  if (!el) return;
  
  var colors = {
    ok: { border: '#4ade80', text: '#4ade80', label: '‚úì OK' },
    warning: { border: '#fbbf24', text: '#fbbf24', label: '‚ö†Ô∏è' },
    alert: { border: '#ef4444', text: '#ef4444', label: '‚ö†Ô∏è' }
  };
  
  var c = colors[status] || colors.ok;
  el.style.borderLeftColor = c.border;
  var valueDiv = el.querySelector('div:last-child');
  if (valueDiv) {
    valueDiv.style.color = c.text;
    valueDiv.textContent = value !== undefined ? value : c.label;
  }
}

// Log alert to history
function logAlert(alert) {
  var entry = {
    timestamp: new Date().toISOString(),
    param: alert.param,
    value: alert.value,
    limit: alert.limit,
    type: alert.type
  };
  
  alertHistory.unshift(entry);
  if (alertHistory.length > 100) alertHistory.pop();
  
  localStorage.setItem('wwtp_alert_history', JSON.stringify(alertHistory));
}

// Load alert history
function loadAlertHistory() {
  try {
    var saved = JSON.parse(localStorage.getItem('wwtp_alert_history'));
    if (saved) alertHistory = saved;
  } catch(e) {
    alertHistory = [];
  }
}

// Render alert history
function renderAlertHistory() {
  var list = document.getElementById('alertHistoryList');
  if (!list) return;
  
  if (alertHistory.length === 0) {
    list.innerHTML = '<div style="padding:15px;text-align:center;opacity:0.7">No alerts recorded</div>';
    return;
  }
  
  var html = '';
  alertHistory.slice(0, 20).forEach(function(entry) {
    var color = entry.type === 'high' ? '#ef4444' : '#fbbf24';
    var date = new Date(entry.timestamp);
    var timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    
    html += '<div style="padding:10px;border-bottom:1px solid #374151;display:flex;justify-content:space-between">';
    html += '<span><span style="color:' + color + '">‚óè</span> ' + entry.param + ' ' + entry.type + ': ' + entry.value + ' (limit: ' + entry.limit + ')</span>';
    html += '<span style="opacity:0.7;font-size:12px">' + timeStr + '</span>';
    html += '</div>';
  });
  
  list.innerHTML = html;
}

// Clear alert history
function clearAlertHistory() {
  alertHistory = [];
  localStorage.removeItem('wwtp_alert_history');
  renderAlertHistory();
  showToast('üóëÔ∏è Alert history cleared', 'info');
}

// Export alert history
function exportAlertHistory() {
  if (alertHistory.length === 0) {
    showToast('No alerts to export', 'warning');
    return;
  }
  
  var csv = 'Timestamp,Parameter,Value,Limit,Type\n';
  alertHistory.forEach(function(entry) {
    csv += entry.timestamp + ',' + entry.param + ',' + entry.value + ',' + entry.limit + ',' + entry.type + '\n';
  });
  
  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_alert_history_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('üì§ Alert history exported', 'success');
}

// Test alert
function testAlert() {
  var testAlert = { param: 'TEST', value: 999, limit: 100, type: 'high' };
  logAlert(testAlert);
  
  // Visual feedback
  showToast('üîî Test alert triggered!', 'warning');
  
  // Play sound if available
  try {
    var audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleA8LQ4zS5bWNNgMJPX3M3LueLgADL2a00NqsOAABHU+Yx9y4TgAADzZ7q8fRogwAAAsgVJC70eMAAAAACBo9bKG+zgAAAAMAAAUVLFd9pcYA');
    audio.volume = 0.3;
    audio.play();
  } catch(e) {}
  
  renderAlertHistory();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initAlertSystem, 1000);
});

// ========== END ALARM/ALERT SYSTEM ==========


// ========== REACTOR MASTER SETTINGS ==========

var currentReactorTab = 'sbr';

// Show reactor master tab
function showReactorMasterTab(tab) {
  currentReactorTab = tab;
  
  // Hide all master sections
  ['sbr', 'mbr', 'mbbr'].forEach(function(t) {
    var el = document.getElementById('reactorMaster_' + t);
    var btn = document.getElementById('rmTab_' + t);
    if (el) el.style.display = 'none';
    if (btn) {
      btn.classList.remove('gradient');
      btn.classList.add('gray');
    }
  });
  
  // Show selected
  var selected = document.getElementById('reactorMaster_' + tab);
  var selectedBtn = document.getElementById('rmTab_' + tab);
  if (selected) selected.style.display = 'block';
  if (selectedBtn) {
    selectedBtn.classList.remove('gray');
    selectedBtn.classList.add('gradient');
  }
}

// Sync reactor master values to calculators
function syncReactorMaster() {
  // SBR Sync
  syncField('rm_sbr_flow', ['sbr_flow', 'sbr_aer_flow']);
  syncField('rm_sbr_basins', ['sbr_basins']);
  syncField('rm_sbr_vol', ['sbr_vol']);
  syncField('rm_sbr_fill', ['sbr_fill']);
  syncField('rm_sbr_react', ['sbr_react']);
  syncField('rm_sbr_settle', ['sbr_settle']);
  syncField('rm_sbr_decant', ['sbr_decant']);
  syncField('rm_sbr_idle', ['sbr_idle']);
  syncField('rm_sbr_bod', ['sbr_bod_in']);
  syncField('rm_sbr_tkn', ['sbr_tkn']);
  syncField('rm_sbr_eff_bod', ['sbr_bod_out']);
  syncField('rm_sbr_eff_nh3', ['sbr_nh3_out']);
  
  // MBR Sync
  syncField('rm_mbr_flow', ['mbr_flow', 'mbr_aer_flow']);
  syncField('rm_mbr_trains', ['mbr_trains']);
  syncField('rm_mbr_area', ['mbr_area']);
  syncField('rm_mbr_flux', ['mbr_flux']);
  syncField('rm_mbr_tmp', ['mbr_tmp_max']);
  syncField('rm_mbr_mlss', ['mbr_mlss']);
  syncField('rm_mbr_bw_freq', ['mbr_bw_freq']);
  syncField('rm_mbr_bw_dur', ['mbr_bw_dur']);
  syncField('rm_mbr_bod', ['mbr_bod_in']);
  syncField('rm_mbr_vol', ['mbr_vol']);
  syncField('rm_mbr_srt', ['mbr_srt']);
  
  // MBBR Sync
  syncField('rm_mbbr_flow', ['mbbr_flow', 'mbbr_aer_flow']);
  syncField('rm_mbbr_vol', ['mbbr_vol']);
  syncField('rm_mbbr_stages', ['mbbr_stages']);
  syncField('rm_mbbr_fill', ['mbbr_fill_pct']);
  syncField('rm_mbbr_ssa', ['mbbr_ssa']);
  syncField('rm_mbbr_protected', ['mbbr_protected']);
  syncField('rm_mbbr_bod', ['mbbr_bod_in']);
  syncField('rm_mbbr_bod_rate', ['mbbr_bod_rate']);
  syncField('rm_mbbr_nh3_rate', ['mbbr_nh3_rate']);
  syncField('rm_mbbr_do', ['mbbr_do']);
  syncField('rm_mbbr_temp', ['mbbr_temp']);
  syncField('rm_mbbr_eff_bod', ['mbbr_bod_out']);
  
  // Silently sync - no toast on boot
}

// Helper function to sync a master field to target fields
function syncField(sourceId, targetIds) {
  var source = document.getElementById(sourceId);
  if (!source) return;
  
  var value = source.value;
  targetIds.forEach(function(targetId) {
    var target = document.getElementById(targetId);
    if (target) target.value = value;
  });
}

// Save reactor settings to localStorage
function saveReactorSettings() {
  var settings = {
    sbr: {
      flow: document.getElementById('rm_sbr_flow')?.value || '2.0',
      basins: document.getElementById('rm_sbr_basins')?.value || '2',
      vol: document.getElementById('rm_sbr_vol')?.value || '0.5',
      fill: document.getElementById('rm_sbr_fill')?.value || '60',
      react: document.getElementById('rm_sbr_react')?.value || '120',
      settle: document.getElementById('rm_sbr_settle')?.value || '60',
      decant: document.getElementById('rm_sbr_decant')?.value || '30',
      idle: document.getElementById('rm_sbr_idle')?.value || '30',
      bod: document.getElementById('rm_sbr_bod')?.value || '200',
      tkn: document.getElementById('rm_sbr_tkn')?.value || '40',
      eff_bod: document.getElementById('rm_sbr_eff_bod')?.value || '10',
      eff_nh3: document.getElementById('rm_sbr_eff_nh3')?.value || '1'
    },
    mbr: {
      flow: document.getElementById('rm_mbr_flow')?.value || '1.5',
      trains: document.getElementById('rm_mbr_trains')?.value || '2',
      area: document.getElementById('rm_mbr_area')?.value || '50000',
      flux: document.getElementById('rm_mbr_flux')?.value || '12',
      tmp: document.getElementById('rm_mbr_tmp')?.value || '8',
      mlss: document.getElementById('rm_mbr_mlss')?.value || '10000',
      bw_freq: document.getElementById('rm_mbr_bw_freq')?.value || '10',
      bw_dur: document.getElementById('rm_mbr_bw_dur')?.value || '30',
      cip: document.getElementById('rm_mbr_cip')?.value || '30',
      bod: document.getElementById('rm_mbr_bod')?.value || '200',
      vol: document.getElementById('rm_mbr_vol')?.value || '0.8',
      srt: document.getElementById('rm_mbr_srt')?.value || '15'
    },
    mbbr: {
      flow: document.getElementById('rm_mbbr_flow')?.value || '2.0',
      vol: document.getElementById('rm_mbbr_vol')?.value || '0.6',
      stages: document.getElementById('rm_mbbr_stages')?.value || '2',
      fill: document.getElementById('rm_mbbr_fill')?.value || '50',
      ssa: document.getElementById('rm_mbbr_ssa')?.value || '500',
      protected: document.getElementById('rm_mbbr_protected')?.value || '67',
      bod: document.getElementById('rm_mbbr_bod')?.value || '200',
      bod_rate: document.getElementById('rm_mbbr_bod_rate')?.value || '10',
      nh3_rate: document.getElementById('rm_mbbr_nh3_rate')?.value || '1.5',
      do: document.getElementById('rm_mbbr_do')?.value || '4.0',
      temp: document.getElementById('rm_mbbr_temp')?.value || '20',
      eff_bod: document.getElementById('rm_mbbr_eff_bod')?.value || '10'
    }
  };
  
  localStorage.setItem('wwtp_reactor_master', JSON.stringify(settings));
  showToast('üíæ Reactor settings saved!', 'success');
}

// Load reactor settings from localStorage
function loadReactorSettings() {
  try {
    var saved = JSON.parse(localStorage.getItem('wwtp_reactor_master'));
    if (!saved) {
      // Silently return if no saved settings - don't show toast on boot
      return;
    }
    
    // Load SBR
    if (saved.sbr) {
      setIfExists('rm_sbr_flow', saved.sbr.flow);
      setIfExists('rm_sbr_basins', saved.sbr.basins);
      setIfExists('rm_sbr_vol', saved.sbr.vol);
      setIfExists('rm_sbr_fill', saved.sbr.fill);
      setIfExists('rm_sbr_react', saved.sbr.react);
      setIfExists('rm_sbr_settle', saved.sbr.settle);
      setIfExists('rm_sbr_decant', saved.sbr.decant);
      setIfExists('rm_sbr_idle', saved.sbr.idle);
      setIfExists('rm_sbr_bod', saved.sbr.bod);
      setIfExists('rm_sbr_tkn', saved.sbr.tkn);
      setIfExists('rm_sbr_eff_bod', saved.sbr.eff_bod);
      setIfExists('rm_sbr_eff_nh3', saved.sbr.eff_nh3);
    }
    
    // Load MBR
    if (saved.mbr) {
      setIfExists('rm_mbr_flow', saved.mbr.flow);
      setIfExists('rm_mbr_trains', saved.mbr.trains);
      setIfExists('rm_mbr_area', saved.mbr.area);
      setIfExists('rm_mbr_flux', saved.mbr.flux);
      setIfExists('rm_mbr_tmp', saved.mbr.tmp);
      setIfExists('rm_mbr_mlss', saved.mbr.mlss);
      setIfExists('rm_mbr_bw_freq', saved.mbr.bw_freq);
      setIfExists('rm_mbr_bw_dur', saved.mbr.bw_dur);
      setIfExists('rm_mbr_cip', saved.mbr.cip);
      setIfExists('rm_mbr_bod', saved.mbr.bod);
      setIfExists('rm_mbr_vol', saved.mbr.vol);
      setIfExists('rm_mbr_srt', saved.mbr.srt);
    }
    
    // Load MBBR
    if (saved.mbbr) {
      setIfExists('rm_mbbr_flow', saved.mbbr.flow);
      setIfExists('rm_mbbr_vol', saved.mbbr.vol);
      setIfExists('rm_mbbr_stages', saved.mbbr.stages);
      setIfExists('rm_mbbr_fill', saved.mbbr.fill);
      setIfExists('rm_mbbr_ssa', saved.mbbr.ssa);
      setIfExists('rm_mbbr_protected', saved.mbbr.protected);
      setIfExists('rm_mbbr_bod', saved.mbbr.bod);
      setIfExists('rm_mbbr_bod_rate', saved.mbbr.bod_rate);
      setIfExists('rm_mbbr_nh3_rate', saved.mbbr.nh3_rate);
      setIfExists('rm_mbbr_do', saved.mbbr.do);
      setIfExists('rm_mbbr_temp', saved.mbbr.temp);
      setIfExists('rm_mbbr_eff_bod', saved.mbbr.eff_bod);
    }
    
    showToast('üìÇ Reactor settings loaded!', 'success');
    syncReactorMaster();
    
  } catch(e) {
    showToast('Error loading reactor settings', 'error');
  }
}

// Helper to set value if element exists
function setIfExists(id, value) {
  var el = document.getElementById(id);
  if (el && value !== undefined) el.value = value;
}

// Initialize reactor settings on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    loadReactorSettings();
  }, 1500);
});

// ========== END REACTOR MASTER SETTINGS ==========


// ========== ADVANCED WAS CALCULATOR ==========

var currentWASMethod = 'srt';

// Show WAS calculation method
function showWASMethod(method) {
  currentWASMethod = method;
  
  // Hide all methods
  ['srt', 'mcrt', 'fm', 'mlss'].forEach(function(m) {
    var el = document.getElementById('wasMethod_' + m);
    var btn = document.getElementById('wasTab_' + m);
    if (el) el.style.display = 'none';
    if (btn) {
      btn.classList.remove('gradient');
      btn.classList.add('gray');
    }
  });
  
  // Show selected
  var selected = document.getElementById('wasMethod_' + method);
  var selectedBtn = document.getElementById('wasTab_' + method);
  if (selected) selected.style.display = 'block';
  if (selectedBtn) {
    selectedBtn.classList.remove('gray');
    selectedBtn.classList.add('gradient');
  }
  
  // Clear results
  document.getElementById('was2_results').innerHTML = '';
}

// Calculate Advanced WAS
function calcAdvancedWAS() {
  var results = {};
  
  switch(currentWASMethod) {
    case 'srt':
      results = calcWAS_SRT();
      break;
    case 'mcrt':
      results = calcWAS_MCRT();
      break;
    case 'fm':
      results = calcWAS_FM();
      break;
    case 'mlss':
      results = calcWAS_MLSS();
      break;
  }
  
  displayWASResults(results);
}

// Method 1: SRT Control
function calcWAS_SRT() {
  var vol = parseFloat(document.getElementById('was2_srt_vol').value) || 1.5;
  var mlss = parseFloat(document.getElementById('was2_srt_mlss').value) || 3000;
  var targetSRT = parseFloat(document.getElementById('was2_srt_target').value) || 10;
  var clarVol = parseFloat(document.getElementById('was2_srt_clarvol').value) || 0.3;
  var blanket = parseFloat(document.getElementById('was2_srt_blanket').value) || 2;
  var rasConc = parseFloat(document.getElementById('was2_srt_ras').value) || 8000;
  var effTSS = parseFloat(document.getElementById('was2_srt_efftss').value) || 10;
  var effQ = parseFloat(document.getElementById('was2_srt_effq').value) || 5.0;
  var wasConc = parseFloat(document.getElementById('was2_srt_wasconc').value) || 8000;
  
  // Calculate solids inventory
  var aerationInv = vol * mlss * 8.34; // lb in aeration basin
  var clarArea = clarVol * 1000000 / 7.48 / blanket; // approximate
  var clarInv = clarVol * 0.5 * rasConc * 8.34; // lb in clarifier (estimate)
  var totalInv = aerationInv + clarInv;
  
  // Effluent solids loss
  var effLoss = effQ * effTSS * 8.34; // lb/day
  
  // WAS needed
  var wasMass = (totalInv / targetSRT) - effLoss; // lb/day
  if (wasMass < 0) wasMass = 0;
  
  var wasGPD = (wasMass / wasConc / 8.34) * 1000000;
  var wasGPM = wasGPD / 1440;
  
  // Calculate actual SRT
  var actualSRT = totalInv / (wasMass + effLoss);
  
  return {
    method: 'SRT Control',
    aerationInv: aerationInv,
    clarInv: clarInv,
    totalInv: totalInv,
    effLoss: effLoss,
    wasMass: wasMass,
    wasGPD: wasGPD,
    wasGPM: wasGPM,
    targetSRT: targetSRT,
    actualSRT: actualSRT,
    wasConc: wasConc
  };
}

// Method 2: MCRT Control
function calcWAS_MCRT() {
  var vol = parseFloat(document.getElementById('was2_mcrt_vol').value) || 1.5;
  var mlss = parseFloat(document.getElementById('was2_mcrt_mlss').value) || 3000;
  var targetMCRT = parseFloat(document.getElementById('was2_mcrt_target').value) || 12;
  var effTSS = parseFloat(document.getElementById('was2_mcrt_efftss').value) || 10;
  var effQ = parseFloat(document.getElementById('was2_mcrt_effq').value) || 5.0;
  var wasConc = parseFloat(document.getElementById('was2_mcrt_wasconc').value) || 8000;
  
  // Solids inventory (aeration only for MCRT)
  var inventory = vol * mlss * 8.34;
  
  // Effluent loss
  var effLoss = effQ * effTSS * 8.34;
  
  // MCRT formula: MCRT = Inventory / (WAS + Effluent loss)
  // WAS = (Inventory / MCRT) - Effluent loss
  var wasMass = (inventory / targetMCRT) - effLoss;
  if (wasMass < 0) wasMass = 0;
  
  var wasGPD = (wasMass / wasConc / 8.34) * 1000000;
  var wasGPM = wasGPD / 1440;
  
  var actualMCRT = inventory / (wasMass + effLoss);
  
  return {
    method: 'MCRT Control',
    aerationInv: inventory,
    totalInv: inventory,
    effLoss: effLoss,
    wasMass: wasMass,
    wasGPD: wasGPD,
    wasGPM: wasGPM,
    targetMCRT: targetMCRT,
    actualMCRT: actualMCRT,
    wasConc: wasConc
  };
}

// Method 3: F/M Control
function calcWAS_FM() {
  var flow = parseFloat(document.getElementById('was2_fm_flow').value) || 5.0;
  var bod = parseFloat(document.getElementById('was2_fm_bod').value) || 200;
  var targetFM = parseFloat(document.getElementById('was2_fm_target').value) || 0.3;
  var mlss = parseFloat(document.getElementById('was2_fm_mlss').value) || 3000;
  var vssRatio = parseFloat(document.getElementById('was2_fm_vss').value) || 0.80;
  var vol = parseFloat(document.getElementById('was2_fm_vol').value) || 1.5;
  var yieldCoef = parseFloat(document.getElementById('was2_fm_yield').value) || 0.6;
  var wasConc = parseFloat(document.getElementById('was2_fm_wasconc').value) || 8000;
  var kd = parseFloat(document.getElementById('was2_fm_kd').value) || 0.06;
  
  // BOD load
  var bodLoad = flow * bod * 8.34; // lb BOD/day
  
  // Current biomass
  var mlvss = mlss * vssRatio;
  var biomass = vol * mlvss * 8.34; // lb MLVSS
  
  // Current F/M
  var currentFM = bodLoad / biomass;
  
  // Target biomass for desired F/M
  var targetBiomass = bodLoad / targetFM;
  var targetMLVSS = targetBiomass / (vol * 8.34);
  var targetMLSS = targetMLVSS / vssRatio;
  
  // Daily growth
  var growth = bodLoad * yieldCoef; // lb TSS/day
  var decay = biomass * kd; // lb/day
  var netGrowth = growth - decay;
  
  // WAS to maintain current MLSS
  var wasMass = netGrowth;
  
  // If MLSS too high, need extra wasting
  if (mlss > targetMLSS) {
    var excessSolids = (mlss - targetMLSS) * vol * 8.34 / 3; // remove over 3 days
    wasMass += excessSolids;
  }
  
  var wasGPD = (wasMass / wasConc / 8.34) * 1000000;
  var wasGPM = wasGPD / 1440;
  
  return {
    method: 'F/M Control',
    bodLoad: bodLoad,
    currentFM: currentFM,
    targetFM: targetFM,
    currentMLSS: mlss,
    targetMLSS: targetMLSS,
    growth: growth,
    decay: decay,
    netGrowth: netGrowth,
    wasMass: wasMass,
    wasGPD: wasGPD,
    wasGPM: wasGPM,
    wasConc: wasConc
  };
}

// Method 4: MLSS Control
function calcWAS_MLSS() {
  var flow = parseFloat(document.getElementById('was2_mlss_flow').value) || 5.0;
  var bod = parseFloat(document.getElementById('was2_mlss_bod').value) || 200;
  var yieldCoef = parseFloat(document.getElementById('was2_mlss_yield').value) || 0.6;
  var targetMLSS = parseFloat(document.getElementById('was2_mlss_target').value) || 3000;
  var currentMLSS = parseFloat(document.getElementById('was2_mlss_current').value) || 3200;
  var vol = parseFloat(document.getElementById('was2_mlss_vol').value) || 1.5;
  var daysToTarget = parseFloat(document.getElementById('was2_mlss_days').value) || 3;
  var wasConc = parseFloat(document.getElementById('was2_mlss_wasconc').value) || 8000;
  var kd = parseFloat(document.getElementById('was2_mlss_kd').value) || 0.06;
  
  // Daily growth
  var bodLoad = flow * bod * 8.34;
  var growth = bodLoad * yieldCoef;
  
  // Decay
  var inventory = vol * currentMLSS * 8.34;
  var decay = inventory * kd * 0.8; // Approximate VSS decay
  
  // Net growth
  var netGrowth = growth - decay;
  
  // Excess solids to remove
  var excessSolids = 0;
  if (currentMLSS > targetMLSS) {
    excessSolids = (currentMLSS - targetMLSS) * vol * 8.34 / daysToTarget;
  }
  
  // Total WAS
  var wasMass = netGrowth + excessSolids;
  if (wasMass < 0) wasMass = 0;
  
  var wasGPD = (wasMass / wasConc / 8.34) * 1000000;
  var wasGPM = wasGPD / 1440;
  
  // Projected MLSS
  var projectedMLSS = currentMLSS;
  if (wasMass > 0) {
    var netChange = (netGrowth - wasMass) / (vol * 8.34);
    projectedMLSS = currentMLSS + (netChange * daysToTarget);
  }
  
  return {
    method: 'MLSS Control',
    currentMLSS: currentMLSS,
    targetMLSS: targetMLSS,
    growth: growth,
    decay: decay,
    netGrowth: netGrowth,
    excessSolids: excessSolids,
    wasMass: wasMass,
    wasGPD: wasGPD,
    wasGPM: wasGPM,
    daysToTarget: daysToTarget,
    projectedMLSS: projectedMLSS,
    wasConc: wasConc
  };
}

// Display WAS Results
function displayWASResults(r) {
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #a855f7">';
  html += '<h4 style="margin:0 0 15px 0;color:#a855f7">üöø ' + r.method + ' Results</h4>';
  html += '<table class="table">';
  html += '<tbody>';
  
  if (r.aerationInv) html += '<tr><td>Aeration Basin Inventory</td><td><span class="result">' + r.aerationInv.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  if (r.clarInv) html += '<tr><td>Clarifier Inventory (est)</td><td><span class="result">' + r.clarInv.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  if (r.totalInv) html += '<tr><td>Total Solids Inventory</td><td><span class="result">' + r.totalInv.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  if (r.effLoss) html += '<tr><td>Effluent Solids Loss</td><td><span class="result">' + r.effLoss.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  if (r.bodLoad) html += '<tr><td>BOD Loading</td><td><span class="result">' + r.bodLoad.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  if (r.currentFM) html += '<tr><td>Current F/M</td><td><span class="result">' + r.currentFM.toFixed(3) + '</span></td><td>lb/lb/day</td></tr>';
  if (r.growth) html += '<tr><td>Daily Growth</td><td><span class="result">' + r.growth.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  if (r.decay) html += '<tr><td>Daily Decay</td><td><span class="result">' + r.decay.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  if (r.netGrowth) html += '<tr><td>Net Growth</td><td><span class="result">' + r.netGrowth.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a855f7">üíß WAS Rate</td></tr>';
  html += '<tr><td>WAS Mass Rate</td><td><span class="result" style="font-size:18px;color:#4ade80">' + r.wasMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>WAS Volume Rate</td><td><span class="result" style="font-size:18px;color:#4ade80">' + r.wasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>gpd</td></tr>';
  html += '<tr><td>WAS Flow Rate</td><td><span class="result" style="font-size:18px;color:#4ade80">' + r.wasGPM.toFixed(1) + '</span></td><td>gpm</td></tr>';
  
  if (r.actualSRT) html += '<tr><td>Calculated SRT</td><td><span class="result">' + r.actualSRT.toFixed(1) + '</span></td><td>days</td></tr>';
  if (r.actualMCRT) html += '<tr><td>Calculated MCRT</td><td><span class="result">' + r.actualMCRT.toFixed(1) + '</span></td><td>days</td></tr>';
  if (r.targetMLSS) html += '<tr><td>Target MLSS</td><td><span class="result">' + r.targetMLSS.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>mg/L</td></tr>';
  if (r.projectedMLSS) html += '<tr><td>Projected MLSS (in ' + r.daysToTarget + ' days)</td><td><span class="result">' + r.projectedMLSS.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>mg/L</td></tr>';
  
  html += '</tbody></table>';
  
  // Add recommendation
  html += '<div class="note success" style="margin-top:15px">';
  html += '<strong>üí° Recommendation:</strong> ';
  if (r.wasGPM < 5) {
    html += 'Low WAS rate. Consider wasting from RAS line for better control.';
  } else if (r.wasGPM > 50) {
    html += 'High WAS rate. Ensure adequate thickener/dewatering capacity.';
  } else {
    html += 'WAS rate is in normal range. Monitor SVI and settleability.';
  }
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('was2_results').innerHTML = html;
}

// Compare All WAS Methods
function compareWASMethods() {
  // Calculate all methods
  var srt = calcWAS_SRT();
  var mcrt = calcWAS_MCRT();
  var fm = calcWAS_FM();
  var mlss = calcWAS_MLSS();
  
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px">';
  html += '<h4 style="margin:0 0 15px 0;color:#a855f7">üìä WAS Method Comparison</h4>';
  html += '<table class="table">';
  html += '<thead><tr><th>Method</th><th>WAS (lb/day)</th><th>WAS (gpd)</th><th>WAS (gpm)</th></tr></thead>';
  html += '<tbody>';
  html += '<tr><td>üìÖ SRT Control</td><td>' + srt.wasMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + srt.wasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + srt.wasGPM.toFixed(1) + '</td></tr>';
  html += '<tr><td>‚è±Ô∏è MCRT Control</td><td>' + mcrt.wasMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + mcrt.wasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + mcrt.wasGPM.toFixed(1) + '</td></tr>';
  html += '<tr><td>‚öñÔ∏è F/M Control</td><td>' + fm.wasMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + fm.wasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + fm.wasGPM.toFixed(1) + '</td></tr>';
  html += '<tr><td>üìä MLSS Control</td><td>' + mlss.wasMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + mlss.wasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + mlss.wasGPM.toFixed(1) + '</td></tr>';
  html += '</tbody></table>';
  
  // Average recommendation
  var avgWAS = (srt.wasGPM + mcrt.wasGPM + fm.wasGPM + mlss.wasGPM) / 4;
  html += '<div class="note info" style="margin-top:15px">';
  html += '<strong>üìà Average WAS Rate:</strong> ' + avgWAS.toFixed(1) + ' gpm (' + (avgWAS * 1440).toLocaleString(undefined, {maximumFractionDigits:0}) + ' gpd)';
  html += '<br><small>Use multiple methods and trend results to determine optimal WAS strategy for your plant.</small>';
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('was2_results').innerHTML = html;
}

// Reset Advanced WAS
function resetAdvancedWAS() {
  document.getElementById('was2_results').innerHTML = '';
  showToast('üîÑ WAS Calculator reset', 'info');
}

// ========== END ADVANCED WAS CALCULATOR ==========


// ========== RAS (RETURN ACTIVATED SLUDGE) CALCULATOR ==========

var currentRASMethod = 'ratio';

// Show RAS calculation method
function showRASMethod(method) {
  currentRASMethod = method;
  
  // Hide all methods
  ['ratio', 'mlss', 'blanket'].forEach(function(m) {
    var el = document.getElementById('rasMethod_' + m);
    var btn = document.getElementById('rasTab_' + m);
    if (el) el.style.display = 'none';
    if (btn) {
      btn.classList.remove('green', 'gradient');
      btn.classList.add('gray');
    }
  });
  
  // Show selected
  var selected = document.getElementById('rasMethod_' + method);
  var selectedBtn = document.getElementById('rasTab_' + method);
  if (selected) selected.style.display = 'block';
  if (selectedBtn) {
    selectedBtn.classList.remove('gray');
    selectedBtn.classList.add('green');
  }
  
  // Clear results
  document.getElementById('ras_results').innerHTML = '';
}

// Calculate RAS
function calcRAS_Advanced() {
  var results = {};
  
  switch(currentRASMethod) {
    case 'ratio':
      results = calcRAS_Ratio();
      break;
    case 'mlss':
      results = calcRAS_MLSS();
      break;
    case 'blanket':
      results = calcRAS_Blanket();
      break;
  }
  
  displayRASResults(results);
}

// Method 1: RAS Ratio
function calcRAS_Ratio() {
  var flow = parseFloat(document.getElementById('ras_ratio_flow').value) || 5.0;
  var rasPct = parseFloat(document.getElementById('ras_ratio_pct').value) || 50;
  var mlss = parseFloat(document.getElementById('ras_ratio_mlss').value) || 3000;
  var rasConc = parseFloat(document.getElementById('ras_ratio_conc').value) || 8000;
  var numPumps = parseFloat(document.getElementById('ras_ratio_pumps').value) || 2;
  var pumpCap = parseFloat(document.getElementById('ras_ratio_pumpcap').value) || 1500;
  
  // Calculate RAS flow
  var rasFlow = flow * (rasPct / 100); // MGD
  var rasGPM = rasFlow * 1000000 / 1440;
  var rasGPD = rasFlow * 1000000;
  
  // Calculate mass loading
  var rasMassReturn = rasFlow * rasConc * 8.34; // lb/day returned
  var influentMass = flow * 200 * 8.34; // Assume 200 mg/L influent TSS
  
  // Check pump capacity
  var totalPumpCap = numPumps * pumpCap; // gpm
  var pumpUtilization = (rasGPM / totalPumpCap) * 100;
  
  // Calculate theoretical MLSS from mass balance
  // MLSS = (Q_inf * TSS_inf + Q_ras * RAS_conc) / (Q_inf + Q_ras) - simplified
  var theoreticalMLSS = (rasConc * rasPct/100) / (1 + rasPct/100);
  
  // RAS/MLSS ratio
  var rasMLSSRatio = rasConc / mlss;
  
  // Settling characteristics
  var settlingStatus = 'Good';
  var settlingColor = '#4ade80';
  if (rasMLSSRatio < 2.0) {
    settlingStatus = 'Poor - Check SVI';
    settlingColor = '#ef4444';
  } else if (rasMLSSRatio < 2.5) {
    settlingStatus = 'Fair';
    settlingColor = '#fbbf24';
  }
  
  return {
    method: 'RAS Ratio Method',
    rasFlow: rasFlow,
    rasGPM: rasGPM,
    rasGPD: rasGPD,
    rasPct: rasPct,
    rasConc: rasConc,
    mlss: mlss,
    rasMLSSRatio: rasMLSSRatio,
    rasMassReturn: rasMassReturn,
    pumpUtilization: pumpUtilization,
    totalPumpCap: totalPumpCap,
    settlingStatus: settlingStatus,
    settlingColor: settlingColor,
    theoreticalMLSS: theoreticalMLSS
  };
}

// Method 2: Target MLSS
function calcRAS_MLSS() {
  var flow = parseFloat(document.getElementById('ras_mlss_flow').value) || 5.0;
  var targetMLSS = parseFloat(document.getElementById('ras_mlss_target').value) || 3000;
  var currentMLSS = parseFloat(document.getElementById('ras_mlss_current').value) || 2800;
  var rasConc = parseFloat(document.getElementById('ras_mlss_conc').value) || 8000;
  var infTSS = parseFloat(document.getElementById('ras_mlss_inftss').value) || 200;
  var vol = parseFloat(document.getElementById('ras_mlss_vol').value) || 1.5;
  
  // Mass balance: Q*TSS_inf + Qras*RAS = (Q+Qras)*MLSS (simplified steady state)
  // Solving for Qras: Qras = Q * (MLSS - TSS_inf) / (RAS - MLSS)
  
  var rasFlow = flow * (targetMLSS - infTSS) / (rasConc - targetMLSS);
  if (rasFlow < 0) rasFlow = 0;
  if (rasConc <= targetMLSS) {
    rasFlow = flow; // RAS concentration too low
  }
  
  var rasGPM = rasFlow * 1000000 / 1440;
  var rasGPD = rasFlow * 1000000;
  var rasPct = (rasFlow / flow) * 100;
  
  // Check if achievable
  var achievable = rasConc > targetMLSS;
  
  // RAS/MLSS ratio
  var rasMLSSRatio = rasConc / targetMLSS;
  
  // Current inventory
  var currentInv = vol * currentMLSS * 8.34;
  var targetInv = vol * targetMLSS * 8.34;
  var invDiff = targetInv - currentInv;
  
  return {
    method: 'Target MLSS Method',
    rasFlow: rasFlow,
    rasGPM: rasGPM,
    rasGPD: rasGPD,
    rasPct: rasPct,
    rasConc: rasConc,
    targetMLSS: targetMLSS,
    currentMLSS: currentMLSS,
    rasMLSSRatio: rasMLSSRatio,
    currentInv: currentInv,
    targetInv: targetInv,
    invDiff: invDiff,
    achievable: achievable
  };
}

// Method 3: Blanket Control
function calcRAS_Blanket() {
  var flow = parseFloat(document.getElementById('ras_blanket_flow').value) || 5.0;
  var currentBlanket = parseFloat(document.getElementById('ras_blanket_current').value) || 3.0;
  var targetBlanket = parseFloat(document.getElementById('ras_blanket_target').value) || 2.0;
  var swd = parseFloat(document.getElementById('ras_blanket_swd').value) || 12;
  var currentRAS = parseFloat(document.getElementById('ras_blanket_currentras').value) || 2.5;
  var svi = parseFloat(document.getElementById('ras_blanket_svi').value) || 120;
  var mlss = parseFloat(document.getElementById('ras_blanket_mlss').value) || 3000;
  var area = parseFloat(document.getElementById('ras_blanket_area').value) || 7850;
  var adjFactor = parseFloat(document.getElementById('ras_blanket_adj').value) || 1.2;
  
  // Calculate blanket change needed
  var blanketChange = currentBlanket - targetBlanket; // positive = need to reduce
  
  // Estimate RAS adjustment (rule of thumb: 10% RAS change per 0.5 ft blanket)
  var rasAdjPct = (blanketChange / 0.5) * 10 * adjFactor;
  var newRAS = currentRAS * (1 + rasAdjPct/100);
  if (newRAS < 0) newRAS = 0.5; // Minimum
  
  var rasGPM = newRAS * 1000000 / 1440;
  var rasGPD = newRAS * 1000000;
  var rasPct = (newRAS / flow) * 100;
  
  // Calculate solids loading rate
  var slr = (flow + newRAS) * mlss * 8.34 / area;
  
  // Calculate settling rate from SVI
  var settlingVelocity = 1000 / svi; // Approximate ft/hr at MLSS concentration
  
  // Blanket status
  var blanketStatus = 'Normal';
  var blanketColor = '#4ade80';
  if (currentBlanket > swd * 0.5) {
    blanketStatus = 'HIGH - Risk of washout!';
    blanketColor = '#ef4444';
  } else if (currentBlanket > swd * 0.33) {
    blanketStatus = 'Elevated - Monitor closely';
    blanketColor = '#fbbf24';
  } else if (currentBlanket < 1) {
    blanketStatus = 'Low - May reduce RAS';
    blanketColor = '#60a5fa';
  }
  
  // Recommended action
  var action = '';
  if (blanketChange > 1) {
    action = 'Significantly increase RAS rate';
  } else if (blanketChange > 0.5) {
    action = 'Moderately increase RAS rate';
  } else if (blanketChange > 0) {
    action = 'Slightly increase RAS rate';
  } else if (blanketChange < -1) {
    action = 'Consider reducing RAS rate';
  } else {
    action = 'Maintain current RAS rate';
  }
  
  return {
    method: 'Blanket Control Method',
    currentRAS: currentRAS,
    newRAS: newRAS,
    rasGPM: rasGPM,
    rasGPD: rasGPD,
    rasPct: rasPct,
    currentBlanket: currentBlanket,
    targetBlanket: targetBlanket,
    blanketChange: blanketChange,
    rasAdjPct: rasAdjPct,
    slr: slr,
    svi: svi,
    settlingVelocity: settlingVelocity,
    blanketStatus: blanketStatus,
    blanketColor: blanketColor,
    action: action,
    swd: swd
  };
}

// Display RAS Results
function displayRASResults(r) {
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #10b981">';
  html += '<h4 style="margin:0 0 15px 0;color:#10b981">üîÑ ' + r.method + ' Results</h4>';
  html += '<table class="table">';
  html += '<tbody>';
  
  // RAS Flow Results
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#10b981">üíß RAS Flow Rate</td></tr>';
  html += '<tr><td>RAS Flow</td><td><span class="result" style="font-size:18px;color:#4ade80">' + (r.rasFlow || r.newRAS || 0).toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>RAS Flow</td><td><span class="result" style="font-size:18px;color:#4ade80">' + r.rasGPM.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>gpm</td></tr>';
  html += '<tr><td>RAS Flow</td><td><span class="result">' + r.rasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>gpd</td></tr>';
  html += '<tr><td>RAS Ratio (RAS/Q)</td><td><span class="result" style="color:#60a5fa">' + r.rasPct.toFixed(1) + '</span></td><td>%</td></tr>';
  
  // Method-specific results
  if (r.rasConc) {
    html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#10b981">üìä Solids Data</td></tr>';
    html += '<tr><td>RAS Concentration</td><td><span class="result">' + r.rasConc.toLocaleString() + '</span></td><td>mg/L</td></tr>';
  }
  if (r.rasMLSSRatio) {
    html += '<tr><td>RAS/MLSS Ratio</td><td><span class="result">' + r.rasMLSSRatio.toFixed(2) + '</span></td><td>-</td></tr>';
  }
  if (r.rasMassReturn) {
    html += '<tr><td>RAS Mass Return</td><td><span class="result">' + r.rasMassReturn.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  }
  if (r.pumpUtilization) {
    var pumpColor = r.pumpUtilization > 90 ? '#ef4444' : r.pumpUtilization > 75 ? '#fbbf24' : '#4ade80';
    html += '<tr><td>Pump Utilization</td><td><span class="result" style="color:' + pumpColor + '">' + r.pumpUtilization.toFixed(1) + '</span></td><td>%</td></tr>';
  }
  if (r.slr) {
    var slrColor = r.slr > 35 ? '#fbbf24' : '#4ade80';
    html += '<tr><td>Solids Loading Rate</td><td><span class="result" style="color:' + slrColor + '">' + r.slr.toFixed(1) + '</span></td><td>lb/sf/day</td></tr>';
  }
  
  // Blanket-specific
  if (r.currentBlanket !== undefined) {
    html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#f59e0b">üìè Blanket Status</td></tr>';
    html += '<tr><td>Current Blanket</td><td><span class="result">' + r.currentBlanket.toFixed(1) + '</span></td><td>ft</td></tr>';
    html += '<tr><td>Target Blanket</td><td><span class="result">' + r.targetBlanket.toFixed(1) + '</span></td><td>ft</td></tr>';
    html += '<tr><td>Blanket Status</td><td colspan="2"><span style="color:' + r.blanketColor + ';font-weight:bold">' + r.blanketStatus + '</span></td></tr>';
    html += '<tr><td>RAS Adjustment</td><td><span class="result">' + (r.rasAdjPct > 0 ? '+' : '') + r.rasAdjPct.toFixed(1) + '</span></td><td>%</td></tr>';
  }
  
  // MLSS target specific
  if (r.targetMLSS && r.currentMLSS) {
    html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#3b82f6">üéØ MLSS Balance</td></tr>';
    html += '<tr><td>Current MLSS</td><td><span class="result">' + r.currentMLSS.toLocaleString() + '</span></td><td>mg/L</td></tr>';
    html += '<tr><td>Target MLSS</td><td><span class="result">' + r.targetMLSS.toLocaleString() + '</span></td><td>mg/L</td></tr>';
    if (!r.achievable) {
      html += '<tr><td colspan="3" style="color:#ef4444">‚ö†Ô∏è RAS concentration too low to achieve target MLSS!</td></tr>';
    }
  }
  
  html += '</tbody></table>';
  
  // Settling status or recommendation
  if (r.settlingStatus) {
    html += '<div class="note" style="margin-top:15px;border-left-color:' + r.settlingColor + '">';
    html += '<strong>Settling Status:</strong> <span style="color:' + r.settlingColor + '">' + r.settlingStatus + '</span>';
    if (r.rasMLSSRatio < 2.5) {
      html += '<br><small>Consider checking SVI and microscopic exam for filaments.</small>';
    }
    html += '</div>';
  }
  
  if (r.action) {
    html += '<div class="note success" style="margin-top:15px">';
    html += '<strong>üí° Recommendation:</strong> ' + r.action;
    html += '</div>';
  }
  
  html += '</div>';
  
  document.getElementById('ras_results').innerHTML = html;
}

// Calculate RAS Settling Check
function calcRASSettling() {
  // Get values from whichever method is active
  var mlss, rasConc, svi, flow;
  
  if (currentRASMethod === 'ratio') {
    mlss = parseFloat(document.getElementById('ras_ratio_mlss').value) || 3000;
    rasConc = parseFloat(document.getElementById('ras_ratio_conc').value) || 8000;
    flow = parseFloat(document.getElementById('ras_ratio_flow').value) || 5.0;
    svi = 100; // Default
  } else if (currentRASMethod === 'blanket') {
    mlss = parseFloat(document.getElementById('ras_blanket_mlss').value) || 3000;
    svi = parseFloat(document.getElementById('ras_blanket_svi').value) || 120;
    flow = parseFloat(document.getElementById('ras_blanket_flow').value) || 5.0;
    rasConc = 1000000 / svi; // Theoretical max
  } else {
    mlss = parseFloat(document.getElementById('ras_mlss_current').value) || 3000;
    rasConc = parseFloat(document.getElementById('ras_mlss_conc').value) || 8000;
    flow = parseFloat(document.getElementById('ras_mlss_flow').value) || 5.0;
    svi = 100;
  }
  
  // Prompt for SVI if not in blanket method
  if (currentRASMethod !== 'blanket') {
    var inputSVI = prompt('Enter current SVI (mL/g):', '120');
    if (inputSVI) svi = parseFloat(inputSVI);
  }
  
  // Calculate settling parameters
  var ssvi = svi; // Stirred SVI approximately = SVI
  var theoreticalRASConc = 1000000 / svi; // mg/L
  var actualRatio = rasConc / mlss;
  var theoreticalRatio = theoreticalRASConc / mlss;
  
  // State point analysis (simplified)
  var settlingFlux = mlss * (1000 / svi) / 1000; // lb/sf/hr approximate
  
  // Determine status
  var status = '';
  var color = '#4ade80';
  var recommendations = [];
  
  if (svi > 200) {
    status = 'POOR SETTLING - Bulking sludge';
    color = '#ef4444';
    recommendations.push('Identify filament type via microscopy');
    recommendations.push('Check F/M ratio, DO, nutrients');
    recommendations.push('Consider chlorination or RAS chlorination');
  } else if (svi > 150) {
    status = 'FAIR SETTLING - Elevated SVI';
    color = '#fbbf24';
    recommendations.push('Monitor for increasing trend');
    recommendations.push('Review process conditions');
    recommendations.push('Increase WAS to reduce SRT');
  } else if (svi > 80) {
    status = 'GOOD SETTLING';
    color = '#4ade80';
    recommendations.push('Maintain current operations');
  } else {
    status = 'EXCELLENT SETTLING - Pin floc possible';
    color = '#60a5fa';
    recommendations.push('Monitor for pin floc in effluent');
    recommendations.push('May need to reduce WAS');
  }
  
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid ' + color + '">';
  html += '<h4 style="margin:0 0 15px 0;color:' + color + '">üìâ Settling Analysis</h4>';
  html += '<table class="table">';
  html += '<tbody>';
  html += '<tr><td>SVI</td><td><span class="result" style="color:' + color + '">' + svi + '</span></td><td>mL/g</td></tr>';
  html += '<tr><td>MLSS</td><td><span class="result">' + mlss.toLocaleString() + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Theoretical Max RAS Conc</td><td><span class="result">' + theoreticalRASConc.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Actual RAS Concentration</td><td><span class="result">' + rasConc.toLocaleString() + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>RAS/MLSS Ratio</td><td><span class="result">' + actualRatio.toFixed(2) + '</span></td><td>-</td></tr>';
  html += '<tr><td>Settling Status</td><td colspan="2"><strong style="color:' + color + '">' + status + '</strong></td></tr>';
  html += '</tbody></table>';
  
  html += '<div class="note info" style="margin-top:15px">';
  html += '<strong>üí° Recommendations:</strong><ul style="margin:10px 0 0 20px">';
  recommendations.forEach(function(rec) {
    html += '<li>' + rec + '</li>';
  });
  html += '</ul></div>';
  
  html += '</div>';
  
  document.getElementById('ras_results').innerHTML = html;
}

// Reset RAS Calculator
function resetRASCalc() {
  document.getElementById('ras_results').innerHTML = '';
  showToast('üîÑ RAS Calculator reset', 'info');
}

// ========== END RAS CALCULATOR ==========


// ========== CLARIFIER SLR CALCULATOR ==========

// Calculate Clarifier Loading Rates
function calcClarifier_Advanced() {
  // Get inputs
  var numClarifiers = parseFloat(document.getElementById('clar_num').value) || 2;
  var diameter = parseFloat(document.getElementById('clar_dia').value) || 80;
  var swd = parseFloat(document.getElementById('clar_swd').value) || 12;
  var cwDia = parseFloat(document.getElementById('clar_cw').value) || 15;
  var weirLength = parseFloat(document.getElementById('clar_weir').value) || 251;
  var online = parseFloat(document.getElementById('clar_online').value) || 2;
  
  var flow = parseFloat(document.getElementById('clar_flow').value) || 5.0;
  var rasFlow = parseFloat(document.getElementById('clar_ras').value) || 2.5;
  var mlss = parseFloat(document.getElementById('clar_mlss').value) || 3000;
  var svi = parseFloat(document.getElementById('clar_svi').value) || 120;
  var rasConc = parseFloat(document.getElementById('clar_rasconc').value) || 8000;
  
  // Calculate areas
  var grossArea = Math.PI * Math.pow(diameter/2, 2); // sf per clarifier
  var cwArea = Math.PI * Math.pow(cwDia/2, 2); // center well area
  var netArea = grossArea - cwArea; // net settling area per clarifier
  var totalNetArea = netArea * online; // total online area
  var totalGrossArea = grossArea * online;
  
  // Calculate volume
  var volumePerClarifier = grossArea * swd / 7.48 / 1000000; // MG
  var totalVolume = volumePerClarifier * online;
  
  // Calculate total weir length
  var totalWeirLength = weirLength * online;
  
  // Calculate loading rates
  var flowGPD = flow * 1000000;
  var totalFlow = flow + rasFlow; // MGD to clarifier
  var totalFlowGPD = totalFlow * 1000000;
  
  // Surface Overflow Rate (based on influent only)
  var sor = flowGPD / totalNetArea; // gpd/sf
  
  // Solids Loading Rate
  var solidsLoad = totalFlow * mlss * 8.34; // lb/day total solids to clarifier
  var slr = solidsLoad / totalNetArea; // lb/sf/day
  
  // Weir Loading Rate
  var wlr = flowGPD / totalWeirLength; // gpd/lf
  
  // Hydraulic Detention Time
  var hdt = (totalVolume / flow) * 24; // hours
  
  // RAS ratio
  var rasRatio = (rasFlow / flow) * 100;
  
  // Determine status colors
  var sorStatus = getSORStatus(sor);
  var slrStatus = getSLRStatus(slr, svi);
  var wlrStatus = getWLRStatus(wlr);
  
  // Display results
  displayClarifierResults({
    type: 'Average Conditions',
    flow: flow,
    rasFlow: rasFlow,
    totalFlow: totalFlow,
    rasRatio: rasRatio,
    mlss: mlss,
    svi: svi,
    numClarifiers: numClarifiers,
    online: online,
    diameter: diameter,
    grossArea: grossArea,
    netArea: netArea,
    totalNetArea: totalNetArea,
    totalVolume: totalVolume,
    totalWeirLength: totalWeirLength,
    sor: sor,
    sorStatus: sorStatus,
    slr: slr,
    slrStatus: slrStatus,
    wlr: wlr,
    wlrStatus: wlrStatus,
    hdt: hdt,
    solidsLoad: solidsLoad
  });
}

// Calculate Peak Conditions
function calcClarifierPeak() {
  // Get inputs
  var numClarifiers = parseFloat(document.getElementById('clar_num').value) || 2;
  var diameter = parseFloat(document.getElementById('clar_dia').value) || 80;
  var swd = parseFloat(document.getElementById('clar_swd').value) || 12;
  var cwDia = parseFloat(document.getElementById('clar_cw').value) || 15;
  var weirLength = parseFloat(document.getElementById('clar_weir').value) || 251;
  var online = parseFloat(document.getElementById('clar_online').value) || 2;
  
  var flow = parseFloat(document.getElementById('clar_flow').value) || 5.0;
  var rasFlow = parseFloat(document.getElementById('clar_ras').value) || 2.5;
  var mlss = parseFloat(document.getElementById('clar_mlss').value) || 3000;
  var peakFactor = parseFloat(document.getElementById('clar_pf').value) || 2.5;
  var svi = parseFloat(document.getElementById('clar_svi').value) || 120;
  
  // Peak flow
  var peakFlow = flow * peakFactor;
  var peakRAS = rasFlow * 1.5; // Typically increase RAS during peak
  var peakTotal = peakFlow + peakRAS;
  
  // Calculate areas
  var grossArea = Math.PI * Math.pow(diameter/2, 2);
  var cwArea = Math.PI * Math.pow(cwDia/2, 2);
  var netArea = grossArea - cwArea;
  var totalNetArea = netArea * online;
  var totalVolume = grossArea * swd / 7.48 / 1000000 * online;
  var totalWeirLength = weirLength * online;
  
  // Calculate peak loading rates
  var peakFlowGPD = peakFlow * 1000000;
  var peakTotalFlowGPD = peakTotal * 1000000;
  
  var peakSOR = peakFlowGPD / totalNetArea;
  var peakSolidsLoad = peakTotal * mlss * 8.34;
  var peakSLR = peakSolidsLoad / totalNetArea;
  var peakWLR = peakFlowGPD / totalWeirLength;
  var peakHDT = (totalVolume / peakFlow) * 24;
  
  // Determine status
  var sorStatus = getSORStatus(peakSOR, true);
  var slrStatus = getSLRStatus(peakSLR, svi, true);
  var wlrStatus = getWLRStatus(peakWLR, true);
  
  // Display results
  displayClarifierResults({
    type: 'Peak Conditions (PF=' + peakFactor + ')',
    flow: peakFlow,
    rasFlow: peakRAS,
    totalFlow: peakTotal,
    rasRatio: (peakRAS / peakFlow) * 100,
    mlss: mlss,
    svi: svi,
    numClarifiers: numClarifiers,
    online: online,
    diameter: diameter,
    grossArea: grossArea,
    netArea: netArea,
    totalNetArea: totalNetArea,
    totalVolume: totalVolume,
    totalWeirLength: totalWeirLength,
    sor: peakSOR,
    sorStatus: sorStatus,
    slr: peakSLR,
    slrStatus: slrStatus,
    wlr: peakWLR,
    wlrStatus: wlrStatus,
    hdt: peakHDT,
    solidsLoad: peakSolidsLoad,
    isPeak: true,
    peakFactor: peakFactor
  });
}

// State Point Analysis
function calcStatePoint() {
  var flow = parseFloat(document.getElementById('clar_flow').value) || 5.0;
  var rasFlow = parseFloat(document.getElementById('clar_ras').value) || 2.5;
  var mlss = parseFloat(document.getElementById('clar_mlss').value) || 3000;
  var svi = parseFloat(document.getElementById('clar_svi').value) || 120;
  var rasConc = parseFloat(document.getElementById('clar_rasconc').value) || 8000;
  var online = parseFloat(document.getElementById('clar_online').value) || 2;
  var diameter = parseFloat(document.getElementById('clar_dia').value) || 80;
  var cwDia = parseFloat(document.getElementById('clar_cw').value) || 15;
  
  var grossArea = Math.PI * Math.pow(diameter/2, 2);
  var cwArea = Math.PI * Math.pow(cwDia/2, 2);
  var netArea = grossArea - cwArea;
  var totalNetArea = netArea * online;
  
  // Vesilind settling parameters (empirical)
  var vo = 20; // ft/hr - initial settling velocity
  var k = 0.0004 * svi; // Settling constant based on SVI
  
  // Calculate underflow rate (RAS)
  var underflowRate = (rasFlow * 1000000) / (totalNetArea * 24); // ft/hr
  
  // Calculate overflow rate
  var overflowRate = (flow * 1000000) / (totalNetArea * 24); // ft/hr
  
  // State point concentration
  // Simplified: Operating line intersects settling flux curve
  var operatingConc = mlss; // mg/L
  var settlingVelocity = vo * Math.exp(-k * mlss/1000); // ft/hr at MLSS
  
  // Settling flux at MLSS
  var settlingFlux = (mlss/1000) * settlingVelocity * 62.4 / 24; // lb/sf/day
  
  // Limiting flux (simplified)
  var limitingConc = (1/k) * 1000 * Math.log(vo * k / underflowRate); // mg/L
  if (limitingConc < 0) limitingConc = mlss * 2;
  var limitingFlux = (limitingConc/1000) * vo * Math.exp(-k * limitingConc/1000) * 62.4 / 24;
  
  // Applied flux
  var appliedFlux = ((flow + rasFlow) * mlss * 8.34) / totalNetArea;
  
  // Safety factor
  var safetyFactor = settlingFlux / appliedFlux;
  
  // Determine status
  var status = '';
  var color = '#4ade80';
  var recommendations = [];
  
  if (safetyFactor < 1.0) {
    status = 'OVERLOADED - Failure likely';
    color = '#ef4444';
    recommendations.push('Reduce flow or increase RAS immediately');
    recommendations.push('Consider bringing additional clarifier online');
    recommendations.push('Increase WAS to reduce MLSS');
  } else if (safetyFactor < 1.25) {
    status = 'CRITICAL - Near capacity';
    color = '#f97316';
    recommendations.push('Monitor closely, prepare contingency');
    recommendations.push('Avoid additional loading');
    recommendations.push('Consider increasing RAS rate');
  } else if (safetyFactor < 1.5) {
    status = 'MARGINAL - Limited capacity';
    color = '#fbbf24';
    recommendations.push('Adequate for current conditions');
    recommendations.push('May struggle during peak flows');
    recommendations.push('Monitor settling characteristics');
  } else {
    status = 'ADEQUATE - Good capacity';
    color = '#4ade80';
    recommendations.push('Operating within safe limits');
    recommendations.push('Can handle moderate flow increases');
  }
  
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid ' + color + '">';
  html += '<h4 style="margin:0 0 15px 0;color:#3b82f6">üìà State Point Analysis</h4>';
  
  html += '<table class="table">';
  html += '<tbody>';
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">Settling Parameters</td></tr>';
  html += '<tr><td>Initial Settling Velocity (Vo)</td><td><span class="result">' + vo.toFixed(1) + '</span></td><td>ft/hr</td></tr>';
  html += '<tr><td>Settling Constant (k)</td><td><span class="result">' + k.toFixed(4) + '</span></td><td>L/mg</td></tr>';
  html += '<tr><td>Settling Velocity at MLSS</td><td><span class="result">' + settlingVelocity.toFixed(2) + '</span></td><td>ft/hr</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">Flux Analysis</td></tr>';
  html += '<tr><td>Settling Flux at MLSS</td><td><span class="result">' + settlingFlux.toFixed(1) + '</span></td><td>lb/sf/day</td></tr>';
  html += '<tr><td>Applied Solids Flux</td><td><span class="result">' + appliedFlux.toFixed(1) + '</span></td><td>lb/sf/day</td></tr>';
  html += '<tr><td>Limiting Concentration</td><td><span class="result">' + limitingConc.toFixed(0) + '</span></td><td>mg/L</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">Operating Rates</td></tr>';
  html += '<tr><td>Overflow Rate</td><td><span class="result">' + overflowRate.toFixed(2) + '</span></td><td>ft/hr</td></tr>';
  html += '<tr><td>Underflow Rate (RAS)</td><td><span class="result">' + underflowRate.toFixed(2) + '</span></td><td>ft/hr</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:' + color + '">Safety Factor</td></tr>';
  html += '<tr><td>Capacity Safety Factor</td><td><span class="result" style="font-size:20px;color:' + color + '">' + safetyFactor.toFixed(2) + '</span></td><td>-</td></tr>';
  html += '<tr><td>Status</td><td colspan="2"><strong style="color:' + color + '">' + status + '</strong></td></tr>';
  html += '</tbody></table>';
  
  html += '<div class="note" style="margin-top:15px;border-left-color:' + color + '">';
  html += '<strong>üí° Recommendations:</strong><ul style="margin:10px 0 0 20px">';
  recommendations.forEach(function(rec) {
    html += '<li>' + rec + '</li>';
  });
  html += '</ul></div>';
  
  html += '</div>';
  
  document.getElementById('clar_results').innerHTML = html;
}

// Get SOR Status
function getSORStatus(sor, isPeak) {
  var limit = isPeak ? 1200 : 800;
  var warn = isPeak ? 1000 : 600;
  
  if (sor > limit) return { color: '#ef4444', text: 'HIGH', icon: '‚ö†Ô∏è' };
  if (sor > warn) return { color: '#fbbf24', text: 'ELEVATED', icon: '‚ö°' };
  return { color: '#4ade80', text: 'OK', icon: '‚úì' };
}

// Get SLR Status
function getSLRStatus(slr, svi, isPeak) {
  var limit = isPeak ? 50 : 30;
  var warn = isPeak ? 35 : 25;
  
  // Adjust for poor settling
  if (svi > 150) {
    limit *= 0.7;
    warn *= 0.7;
  }
  
  if (slr > limit) return { color: '#ef4444', text: 'HIGH', icon: '‚ö†Ô∏è' };
  if (slr > warn) return { color: '#fbbf24', text: 'ELEVATED', icon: '‚ö°' };
  return { color: '#4ade80', text: 'OK', icon: '‚úì' };
}

// Get WLR Status
function getWLRStatus(wlr, isPeak) {
  var limit = isPeak ? 30000 : 20000;
  var warn = isPeak ? 25000 : 15000;
  
  if (wlr > limit) return { color: '#ef4444', text: 'HIGH', icon: '‚ö†Ô∏è' };
  if (wlr > warn) return { color: '#fbbf24', text: 'ELEVATED', icon: '‚ö°' };
  return { color: '#4ade80', text: 'OK', icon: '‚úì' };
}

// Display Clarifier Results
function displayClarifierResults(r) {
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #3b82f6">';
  html += '<h4 style="margin:0 0 15px 0;color:#3b82f6">üèä ' + r.type + '</h4>';
  
  html += '<table class="table">';
  html += '<tbody>';
  
  // Clarifier Info
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üèóÔ∏è Clarifier Configuration</td></tr>';
  html += '<tr><td>Clarifiers Online</td><td><span class="result">' + r.online + ' of ' + r.numClarifiers + '</span></td><td>-</td></tr>';
  html += '<tr><td>Diameter</td><td><span class="result">' + r.diameter + '</span></td><td>ft</td></tr>';
  html += '<tr><td>Net Area (per clarifier)</td><td><span class="result">' + r.netArea.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>sf</td></tr>';
  html += '<tr><td>Total Net Area</td><td><span class="result">' + r.totalNetArea.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>sf</td></tr>';
  html += '<tr><td>Total Volume</td><td><span class="result">' + r.totalVolume.toFixed(3) + '</span></td><td>MG</td></tr>';
  
  // Flow Info
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üíß Flow Data</td></tr>';
  html += '<tr><td>Influent Flow</td><td><span class="result">' + r.flow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>RAS Flow</td><td><span class="result">' + r.rasFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Total to Clarifier</td><td><span class="result">' + r.totalFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>RAS Ratio</td><td><span class="result">' + r.rasRatio.toFixed(0) + '</span></td><td>%</td></tr>';
  html += '<tr><td>MLSS</td><td><span class="result">' + r.mlss.toLocaleString() + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Solids Load</td><td><span class="result">' + r.solidsLoad.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  
  // Loading Rates
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">üìä Loading Rates</td></tr>';
  
  html += '<tr>';
  html += '<td>Surface Overflow Rate (SOR)</td>';
  html += '<td><span class="result" style="font-size:18px;color:' + r.sorStatus.color + '">' + r.sor.toFixed(0) + '</span></td>';
  html += '<td>gpd/sf <span style="color:' + r.sorStatus.color + '">' + r.sorStatus.icon + ' ' + r.sorStatus.text + '</span></td>';
  html += '</tr>';
  
  html += '<tr>';
  html += '<td>Solids Loading Rate (SLR)</td>';
  html += '<td><span class="result" style="font-size:18px;color:' + r.slrStatus.color + '">' + r.slr.toFixed(1) + '</span></td>';
  html += '<td>lb/sf/day <span style="color:' + r.slrStatus.color + '">' + r.slrStatus.icon + ' ' + r.slrStatus.text + '</span></td>';
  html += '</tr>';
  
  html += '<tr>';
  html += '<td>Weir Loading Rate (WLR)</td>';
  html += '<td><span class="result" style="font-size:18px;color:' + r.wlrStatus.color + '">' + r.wlr.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td>';
  html += '<td>gpd/lf <span style="color:' + r.wlrStatus.color + '">' + r.wlrStatus.icon + ' ' + r.wlrStatus.text + '</span></td>';
  html += '</tr>';
  
  html += '<tr><td>Hydraulic Detention Time</td><td><span class="result">' + r.hdt.toFixed(1) + '</span></td><td>hours</td></tr>';
  
  html += '</tbody></table>';
  
  // Summary recommendation
  var overallStatus = 'Good';
  var overallColor = '#4ade80';
  if (r.sorStatus.text === 'HIGH' || r.slrStatus.text === 'HIGH' || r.wlrStatus.text === 'HIGH') {
    overallStatus = 'Overloaded';
    overallColor = '#ef4444';
  } else if (r.sorStatus.text === 'ELEVATED' || r.slrStatus.text === 'ELEVATED' || r.wlrStatus.text === 'ELEVATED') {
    overallStatus = 'Near Capacity';
    overallColor = '#fbbf24';
  }
  
  html += '<div class="note" style="margin-top:15px;border-left-color:' + overallColor + '">';
  html += '<strong style="color:' + overallColor + '">Overall Status: ' + overallStatus + '</strong><br>';
  
  if (overallStatus === 'Overloaded') {
    html += 'Consider bringing additional clarifier online or reducing flow. ';
    html += 'Check for settling problems (SVI = ' + r.svi + ').';
  } else if (overallStatus === 'Near Capacity') {
    html += 'Operating near design limits. Monitor during peak flows. ';
    html += 'Ensure backup clarifier is available.';
  } else {
    html += 'Clarifier operating within acceptable limits.';
  }
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('clar_results').innerHTML = html;
}

// Reset Clarifier Calculator
function resetClarifier() {
  document.getElementById('clar_results').innerHTML = '';
  showToast('üîÑ Clarifier Calculator reset', 'info');
}

// ========== END CLARIFIER SLR CALCULATOR ==========


// ========== SLUDGE JUDGE / SETTLEOMETER CALCULATOR ==========

// Calculate Settling Test Results
function calcSettling() {
  var mlss = parseFloat(document.getElementById('sj_mlss').value) || 3000;
  var cylinder = parseFloat(document.getElementById('sj_cylinder').value) || 2000;
  var stirred = document.getElementById('sj_stirred').value === 'yes';
  var location = document.getElementById('sj_location').value;
  
  // Get readings
  var v0 = parseFloat(document.getElementById('sj_0').value) || cylinder;
  var v5 = parseFloat(document.getElementById('sj_5').value) || 0;
  var v10 = parseFloat(document.getElementById('sj_10').value) || 0;
  var v15 = parseFloat(document.getElementById('sj_15').value) || 0;
  var v20 = parseFloat(document.getElementById('sj_20').value) || 0;
  var v25 = parseFloat(document.getElementById('sj_25').value) || 0;
  var v30 = parseFloat(document.getElementById('sj_30').value) || 0;
  var v60 = parseFloat(document.getElementById('sj_60').value) || 0;
  
  if (v30 === 0) {
    document.getElementById('sj_results').innerHTML = '<div class="note warning">Enter 30-minute settled volume to calculate SVI</div>';
    return;
  }
  
  // Calculate SVI
  // SVI = (Settled Volume mL / Cylinder Volume mL) √ó (1000 / MLSS mg/L) √ó 1000
  // Simplified: SVI = (V30 √ó 1000) / (Cylinder √ó MLSS / 1000)
  var svi = (v30 * 1000) / (cylinder * mlss / 1000);
  
  // Calculate % settled at 30 min
  var pctSettled30 = ((v0 - v30) / v0) * 100;
  
  // Calculate settling rate (first 10 minutes - linear phase)
  var settlingRate = 0;
  if (v5 > 0 && v10 > 0) {
    settlingRate = (v5 - v10) / 5; // mL/min
  } else if (v10 > 0) {
    settlingRate = (v0 - v10) / 10;
  }
  
  // Settling velocity (ft/hr) - based on cylinder geometry
  var cylinderHeight = cylinder === 2000 ? 18 : 14; // inches approximate
  var settlingVelocity = 0;
  if (v10 > 0 && v0 > 0) {
    var heightDrop = ((v0 - v10) / v0) * cylinderHeight; // inches in 10 min
    settlingVelocity = (heightDrop / 12) * 6; // ft/hr
  }
  
  // Theoretical RAS concentration
  var theoreticalRAS = 1000000 / svi; // mg/L
  
  // SDI (Sludge Density Index) = 100 / SVI
  var sdi = 100 / svi;
  
  // Determine status
  var status = getSVIStatus(svi);
  
  // Build results HTML
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid ' + status.color + '">';
  html += '<h4 style="margin:0 0 15px 0;color:#f59e0b">üß™ Settling Test Results</h4>';
  
  // Main SVI display
  html += '<div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;flex-wrap:wrap">';
  html += '<div style="background:#1e3a5f;padding:20px;border-radius:12px;text-align:center;min-width:150px">';
  html += '<div style="font-size:14px;opacity:0.7">' + (stirred ? 'SSVI' : 'SVI') + '</div>';
  html += '<div style="font-size:42px;font-weight:bold;color:' + status.color + '">' + svi.toFixed(0) + '</div>';
  html += '<div style="font-size:14px">mL/g</div>';
  html += '</div>';
  html += '<div style="flex:1">';
  html += '<div style="font-size:18px;color:' + status.color + ';font-weight:bold">' + status.icon + ' ' + status.text + '</div>';
  html += '<div style="margin-top:5px;opacity:0.8">' + status.description + '</div>';
  html += '</div>';
  html += '</div>';
  
  // Results table
  html += '<table class="table">';
  html += '<tbody>';
  html += '<tr><td>Sample Location</td><td><span class="result">' + getLocationName(location) + '</span></td><td>-</td></tr>';
  html += '<tr><td>MLSS Concentration</td><td><span class="result">' + mlss.toLocaleString() + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>30-min Settled Volume</td><td><span class="result">' + v30 + '</span></td><td>mL</td></tr>';
  html += '<tr><td>% Volume Reduction</td><td><span class="result">' + pctSettled30.toFixed(1) + '</span></td><td>%</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">Calculated Parameters</td></tr>';
  html += '<tr><td>' + (stirred ? 'SSVI' : 'SVI') + '</td><td><span class="result" style="color:' + status.color + ';font-size:18px">' + svi.toFixed(1) + '</span></td><td>mL/g</td></tr>';
  html += '<tr><td>SDI (Sludge Density Index)</td><td><span class="result">' + sdi.toFixed(2) + '</span></td><td>g/100mL</td></tr>';
  html += '<tr><td>Theoretical Max RAS Conc</td><td><span class="result">' + theoreticalRAS.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>mg/L</td></tr>';
  
  if (settlingRate > 0) {
    html += '<tr><td>Initial Settling Rate</td><td><span class="result">' + settlingRate.toFixed(1) + '</span></td><td>mL/min</td></tr>';
  }
  if (settlingVelocity > 0) {
    html += '<tr><td>Settling Velocity</td><td><span class="result">' + settlingVelocity.toFixed(2) + '</span></td><td>ft/hr</td></tr>';
  }
  
  if (v60 > 0) {
    var svi60 = (v60 * 1000) / (cylinder * mlss / 1000);
    var compactionRatio = v30 / v60;
    html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">60-Minute Data</td></tr>';
    html += '<tr><td>60-min Settled Volume</td><td><span class="result">' + v60 + '</span></td><td>mL</td></tr>';
    html += '<tr><td>60-min SVI</td><td><span class="result">' + svi60.toFixed(1) + '</span></td><td>mL/g</td></tr>';
    html += '<tr><td>Compaction Ratio (30/60)</td><td><span class="result">' + compactionRatio.toFixed(2) + '</span></td><td>-</td></tr>';
  }
  
  html += '</tbody></table>';
  
  // Recommendations
  html += '<div class="note" style="margin-top:15px;border-left-color:' + status.color + '">';
  html += '<strong>üí° Recommendations:</strong><ul style="margin:10px 0 0 20px">';
  status.recommendations.forEach(function(rec) {
    html += '<li>' + rec + '</li>';
  });
  html += '</ul></div>';
  
  html += '</div>';
  
  document.getElementById('sj_results').innerHTML = html;
}

// Get SVI Status
function getSVIStatus(svi) {
  if (svi < 80) {
    return {
      color: '#4ade80',
      text: 'EXCELLENT',
      icon: '‚úì',
      description: 'Old/dense sludge - watch for pin floc',
      recommendations: [
        'Monitor effluent TSS for pin floc carryover',
        'May be able to reduce WAS slightly',
        'Check microscopy for floc structure'
      ]
    };
  } else if (svi < 120) {
    return {
      color: '#4ade80',
      text: 'GOOD',
      icon: '‚úì',
      description: 'Normal, healthy settling sludge',
      recommendations: [
        'Maintain current operations',
        'Continue routine monitoring',
        'Ideal settling characteristics'
      ]
    };
  } else if (svi < 150) {
    return {
      color: '#fbbf24',
      text: 'FAIR',
      icon: '‚ö†Ô∏è',
      description: 'Light bulking may be beginning',
      recommendations: [
        'Monitor trend over next few days',
        'Check DO levels (maintain > 2.0 mg/L)',
        'Verify nutrient availability (N, P)',
        'Review F/M ratio'
      ]
    };
  } else if (svi < 200) {
    return {
      color: '#f97316',
      text: 'POOR',
      icon: '‚ö†Ô∏è',
      description: 'Bulking sludge - action needed',
      recommendations: [
        'Perform microscopic exam to identify filaments',
        'Check for low DO, nutrient deficiency, or septic conditions',
        'Consider increasing WAS to reduce SRT',
        'Review selector or anoxic zone operation'
      ]
    };
  } else {
    return {
      color: '#ef4444',
      text: 'VERY POOR',
      icon: '‚ùå',
      description: 'Severe bulking - immediate action required',
      recommendations: [
        'Identify dominant filament type immediately',
        'Consider chlorination of RAS (2-10 lb Cl2/1000 lb MLSS)',
        'Add polymer to clarifier if needed',
        'Significantly increase WAS rate',
        'Check for industrial discharge or toxic shock'
      ]
    };
  }
}

// Get Location Name
function getLocationName(loc) {
  var names = {
    'mlss': 'MLSS (Aeration Basin)',
    'ras': 'Return Activated Sludge',
    'effluent': 'Secondary Effluent'
  };
  return names[loc] || loc;
}

// Show Settling Curve
function showSettlingCurve() {
  var container = document.getElementById('sj_chart_container');
  var cylinder = parseFloat(document.getElementById('sj_cylinder').value) || 2000;
  
  // Get readings
  var readings = [
    { time: 0, vol: parseFloat(document.getElementById('sj_0').value) || cylinder },
    { time: 5, vol: parseFloat(document.getElementById('sj_5').value) || null },
    { time: 10, vol: parseFloat(document.getElementById('sj_10').value) || null },
    { time: 15, vol: parseFloat(document.getElementById('sj_15').value) || null },
    { time: 20, vol: parseFloat(document.getElementById('sj_20').value) || null },
    { time: 25, vol: parseFloat(document.getElementById('sj_25').value) || null },
    { time: 30, vol: parseFloat(document.getElementById('sj_30').value) || null },
    { time: 60, vol: parseFloat(document.getElementById('sj_60').value) || null }
  ].filter(r => r.vol !== null && r.vol > 0);
  
  if (readings.length < 2) {
    showToast('Enter at least 2 readings to show curve', 'warning');
    return;
  }
  
  container.style.display = 'block';
  
  // Create chart
  var ctx = document.getElementById('settlingChart').getContext('2d');
  
  // Destroy existing chart if any
  if (window.settlingChartInstance) {
    window.settlingChartInstance.destroy();
  }
  
  window.settlingChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: readings.map(r => r.time + ' min'),
      datasets: [{
        label: 'Settled Volume (mL)',
        data: readings.map(r => r.vol),
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 6,
        pointBackgroundColor: '#f59e0b'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: false,
          title: { display: true, text: 'Settled Volume (mL)', color: '#94a3b8' },
          grid: { color: '#374151' },
          ticks: { color: '#94a3b8' }
        },
        x: {
          title: { display: true, text: 'Time', color: '#94a3b8' },
          grid: { color: '#374151' },
          ticks: { color: '#94a3b8' }
        }
      }
    }
  });
}

// Save Settling Test
function saveSettlingTest() {
  var test = {
    date: document.getElementById('sj_date').value || new Date().toISOString().split('T')[0],
    time: document.getElementById('sj_time').value || new Date().toTimeString().split(' ')[0].slice(0,5),
    location: document.getElementById('sj_location').value,
    mlss: document.getElementById('sj_mlss').value,
    cylinder: document.getElementById('sj_cylinder').value,
    stirred: document.getElementById('sj_stirred').value,
    readings: {
      v0: document.getElementById('sj_0').value,
      v5: document.getElementById('sj_5').value,
      v10: document.getElementById('sj_10').value,
      v15: document.getElementById('sj_15').value,
      v20: document.getElementById('sj_20').value,
      v25: document.getElementById('sj_25').value,
      v30: document.getElementById('sj_30').value,
      v60: document.getElementById('sj_60').value
    }
  };
  
  // Calculate SVI for storage
  var v30 = parseFloat(test.readings.v30) || 0;
  var mlss = parseFloat(test.mlss) || 3000;
  var cylinder = parseFloat(test.cylinder) || 2000;
  if (v30 > 0) {
    test.svi = (v30 * 1000) / (cylinder * mlss / 1000);
  }
  
  // Get existing tests
  var tests = JSON.parse(localStorage.getItem('wwtp_settling_tests') || '[]');
  tests.unshift(test);
  
  // Keep last 50 tests
  if (tests.length > 50) tests = tests.slice(0, 50);
  
  localStorage.setItem('wwtp_settling_tests', JSON.stringify(tests));
  showToast('üíæ Settling test saved!', 'success');
}

// Reset Settling Test
function resetSettling() {
  document.getElementById('sj_5').value = '';
  document.getElementById('sj_10').value = '';
  document.getElementById('sj_15').value = '';
  document.getElementById('sj_20').value = '';
  document.getElementById('sj_25').value = '';
  document.getElementById('sj_30').value = '';
  document.getElementById('sj_60').value = '';
  document.getElementById('sj_results').innerHTML = '';
  document.getElementById('sj_chart_container').style.display = 'none';
  showToast('üîÑ Settling test reset', 'info');
}

// ========== END SLUDGE JUDGE / SETTLEOMETER CALCULATOR ==========


// ========== JAR TEST OPTIMIZER ==========

// Update coagulant cost based on type
function updateCoagCost() {
  var type = document.getElementById('jt_coag_type').value;
  var costs = {
    'alum': 0.15,
    'ferric': 0.18,
    'ferrous': 0.10,
    'pac': 0.35,
    'sodium_aluminate': 0.45
  };
  document.getElementById('jt_coag_cost').value = costs[type] || 0.15;
}

// Analyze Jar Test Results
function analyzeJarTest() {
  var plantFlow = parseFloat(document.getElementById('jt_plant_flow').value) || 5.0;
  var coagCost = parseFloat(document.getElementById('jt_coag_cost').value) || 0.15;
  var polyCost = parseFloat(document.getElementById('jt_poly_cost').value) || 2.50;
  var initTurb = parseFloat(document.getElementById('jt_init_turb').value) || 25;
  var targetTurb = parseFloat(document.getElementById('jt_target_turb').value) || 5;
  var coagType = document.getElementById('jt_coag_type').value;
  
  // Collect jar data
  var jars = [];
  for (var i = 1; i <= 6; i++) {
    var coagDose = parseFloat(document.getElementById('jt_' + i + '_coag').value) || 0;
    var polyDose = parseFloat(document.getElementById('jt_' + i + '_poly').value) || 0;
    var turb = parseFloat(document.getElementById('jt_' + i + '_turb').value);
    var floc = document.getElementById('jt_' + i + '_floc').value;
    var fph = parseFloat(document.getElementById('jt_' + i + '_fph').value);
    
    if (coagDose > 0 && !isNaN(turb)) {
      jars.push({
        jar: i,
        coagDose: coagDose,
        polyDose: polyDose,
        turb: turb,
        floc: floc ? parseInt(floc) : 0,
        fph: fph,
        removal: ((initTurb - turb) / initTurb * 100)
      });
    }
  }
  
  if (jars.length < 2) {
    document.getElementById('jt_results').innerHTML = '<div class="note warning">Enter turbidity results for at least 2 jars to analyze.</div>';
    return;
  }
  
  // Find optimal jar (lowest turbidity that meets target with best floc)
  var validJars = jars.filter(j => j.turb <= targetTurb);
  var optimalJar = null;
  
  if (validJars.length > 0) {
    // Among jars meeting target, find lowest dose
    optimalJar = validJars.reduce((best, current) => {
      if (!best) return current;
      if (current.coagDose < best.coagDose) return current;
      if (current.coagDose === best.coagDose && current.floc > best.floc) return current;
      return best;
    }, null);
  } else {
    // No jar meets target - find best performer
    optimalJar = jars.reduce((best, current) => {
      if (!best) return current;
      if (current.turb < best.turb) return current;
      return best;
    }, null);
  }
  
  // Calculate costs for optimal dose
  var optCoagDose = optimalJar.coagDose;
  var optPolyDose = optimalJar.polyDose;
  
  // lb/day = MGD √ó dose(mg/L) √ó 8.34
  var coagLbDay = plantFlow * optCoagDose * 8.34;
  var polyLbDay = plantFlow * optPolyDose * 8.34;
  
  var dailyCoagCost = coagLbDay * coagCost;
  var dailyPolyCost = polyLbDay * polyCost;
  var totalDailyCost = dailyCoagCost + dailyPolyCost;
  
  // Cost per 1000 gallons
  var costPer1000 = totalDailyCost / (plantFlow * 1000);
  
  // Cost per MG
  var costPerMG = totalDailyCost / plantFlow;
  
  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #f59e0b">';
  html += '<h4 style="margin:0 0 15px 0;color:#f59e0b">üß´ Jar Test Analysis Results</h4>';
  
  // Optimal dose display
  var meetsTarget = optimalJar.turb <= targetTurb;
  html += '<div style="display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap">';
  html += '<div style="background:#1e3a5f;padding:20px;border-radius:12px;text-align:center;min-width:150px;border:2px solid ' + (meetsTarget ? '#4ade80' : '#fbbf24') + '">';
  html += '<div style="font-size:12px;opacity:0.7">OPTIMAL DOSE</div>';
  html += '<div style="font-size:36px;font-weight:bold;color:' + (meetsTarget ? '#4ade80' : '#fbbf24') + '">' + optCoagDose + '</div>';
  html += '<div style="font-size:14px">mg/L ' + getCoagName(coagType) + '</div>';
  html += '<div style="font-size:11px;margin-top:5px;opacity:0.7">Jar #' + optimalJar.jar + '</div>';
  html += '</div>';
  html += '<div style="flex:1;min-width:200px">';
  html += '<div style="font-size:20px;color:' + (meetsTarget ? '#4ade80' : '#fbbf24') + ';font-weight:bold">' + (meetsTarget ? '‚úì Meets Target' : '‚ö†Ô∏è Below Target') + '</div>';
  html += '<div style="margin-top:5px">Final Turbidity: <strong>' + optimalJar.turb + ' NTU</strong> (Target: ' + targetTurb + ')</div>';
  html += '<div>Removal: <strong>' + optimalJar.removal.toFixed(1) + '%</strong></div>';
  html += '<div>Floc Quality: <strong>' + getFlocDescription(optimalJar.floc) + '</strong></div>';
  html += '</div>';
  html += '</div>';
  
  // Results table
  html += '<table class="table" style="margin-bottom:15px">';
  html += '<tbody>';
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä All Jar Results</td></tr>';
  
  jars.forEach(function(j) {
    var isOptimal = j.jar === optimalJar.jar;
    var rowStyle = isOptimal ? 'background:rgba(74,222,128,0.15)' : '';
    html += '<tr style="' + rowStyle + '">';
    html += '<td>Jar ' + j.jar + (isOptimal ? ' ‚≠ê' : '') + '</td>';
    html += '<td>' + j.coagDose + ' mg/L ‚Üí <strong>' + j.turb + ' NTU</strong></td>';
    html += '<td>' + j.removal.toFixed(1) + '% removal</td>';
    html += '</tr>';
  });
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üí∞ Cost Analysis (at ' + plantFlow + ' MGD)</td></tr>';
  html += '<tr><td>Coagulant Feed Rate</td><td><span class="result">' + coagLbDay.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  if (optPolyDose > 0) {
    html += '<tr><td>Polymer Feed Rate</td><td><span class="result">' + polyLbDay.toFixed(1) + '</span></td><td>lb/day</td></tr>';
  }
  html += '<tr><td>Daily Coagulant Cost</td><td><span class="result">$' + dailyCoagCost.toFixed(2) + '</span></td><td>/day</td></tr>';
  if (dailyPolyCost > 0) {
    html += '<tr><td>Daily Polymer Cost</td><td><span class="result">$' + dailyPolyCost.toFixed(2) + '</span></td><td>/day</td></tr>';
  }
  html += '<tr><td><strong>Total Daily Cost</strong></td><td><span class="result" style="font-size:18px;color:#4ade80">$' + totalDailyCost.toFixed(2) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Cost per 1,000 gal</td><td><span class="result">$' + costPer1000.toFixed(4) + '</span></td><td>/1000 gal</td></tr>';
  html += '<tr><td>Cost per MG</td><td><span class="result">$' + costPerMG.toFixed(2) + '</span></td><td>/MG</td></tr>';
  html += '<tr><td>Monthly Cost (est)</td><td><span class="result">$' + (totalDailyCost * 30).toFixed(0) + '</span></td><td>/month</td></tr>';
  html += '</tbody></table>';
  
  // Recommendation
  html += '<div class="note success">';
  html += '<strong>üí° Recommendation:</strong> ';
  if (meetsTarget) {
    html += 'Use ' + optCoagDose + ' mg/L ' + getCoagName(coagType);
    if (optPolyDose > 0) html += ' with ' + optPolyDose + ' mg/L polymer';
    html += '. This achieves ' + optimalJar.removal.toFixed(0) + '% turbidity removal at $' + costPer1000.toFixed(4) + '/1000 gal.';
  } else {
    html += 'No tested dose achieved target turbidity of ' + targetTurb + ' NTU. Consider testing higher doses or adding polymer assistance.';
  }
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('jt_results').innerHTML = html;
}

// Get coagulant name
function getCoagName(type) {
  var names = {
    'alum': 'Alum',
    'ferric': 'Ferric Chloride',
    'ferrous': 'Ferrous Sulfate',
    'pac': 'PAC',
    'sodium_aluminate': 'Sodium Aluminate'
  };
  return names[type] || type;
}

// Get floc description
function getFlocDescription(size) {
  var desc = {
    0: 'Not rated',
    1: '1 - Pin floc (poor)',
    2: '2 - Small (fair)',
    3: '3 - Medium (good)',
    4: '4 - Large (very good)',
    5: '5 - Extra large (excellent)'
  };
  return desc[size] || 'Not rated';
}

// Show Jar Test Chart
function showJarTestChart() {
  var container = document.getElementById('jt_chart_container');
  
  // Collect data
  var labels = [];
  var turbData = [];
  var removalData = [];
  
  for (var i = 1; i <= 6; i++) {
    var coagDose = parseFloat(document.getElementById('jt_' + i + '_coag').value) || 0;
    var turb = parseFloat(document.getElementById('jt_' + i + '_turb').value);
    var initTurb = parseFloat(document.getElementById('jt_init_turb').value) || 25;
    
    if (coagDose > 0 && !isNaN(turb)) {
      labels.push(coagDose + ' mg/L');
      turbData.push(turb);
      removalData.push(((initTurb - turb) / initTurb * 100));
    }
  }
  
  if (labels.length < 2) {
    showToast('Enter results for at least 2 jars', 'warning');
    return;
  }
  
  container.style.display = 'block';
  
  var ctx = document.getElementById('jarTestChart').getContext('2d');
  
  if (window.jarTestChartInstance) {
    window.jarTestChartInstance.destroy();
  }
  
  window.jarTestChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Final Turbidity (NTU)',
        data: turbData,
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 6,
        pointBackgroundColor: '#f59e0b',
        yAxisID: 'y'
      }, {
        label: '% Removal',
        data: removalData,
        borderColor: '#4ade80',
        backgroundColor: 'rgba(74, 222, 128, 0.1)',
        fill: false,
        tension: 0.3,
        pointRadius: 6,
        pointBackgroundColor: '#4ade80',
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: { 
          display: true,
          labels: { color: '#94a3b8' }
        }
      },
      scales: {
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          title: { display: true, text: 'Turbidity (NTU)', color: '#f59e0b' },
          grid: { color: '#374151' },
          ticks: { color: '#f59e0b' }
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          title: { display: true, text: '% Removal', color: '#4ade80' },
          grid: { drawOnChartArea: false },
          ticks: { color: '#4ade80' },
          min: 0,
          max: 100
        },
        x: {
          title: { display: true, text: 'Coagulant Dose', color: '#94a3b8' },
          grid: { color: '#374151' },
          ticks: { color: '#94a3b8' }
        }
      }
    }
  });
}

// Save Jar Test
function saveJarTest() {
  var test = {
    date: new Date().toISOString(),
    source: document.getElementById('jt_source').value,
    coagType: document.getElementById('jt_coag_type').value,
    polyType: document.getElementById('jt_poly_type').value,
    initTurb: document.getElementById('jt_init_turb').value,
    initPH: document.getElementById('jt_init_ph').value,
    plantFlow: document.getElementById('jt_plant_flow').value,
    jars: []
  };
  
  for (var i = 1; i <= 6; i++) {
    var coagDose = parseFloat(document.getElementById('jt_' + i + '_coag').value) || 0;
    var turb = document.getElementById('jt_' + i + '_turb').value;
    if (coagDose > 0 && turb) {
      test.jars.push({
        jar: i,
        coagDose: coagDose,
        polyDose: document.getElementById('jt_' + i + '_poly').value,
        turb: turb,
        floc: document.getElementById('jt_' + i + '_floc').value,
        fph: document.getElementById('jt_' + i + '_fph').value
      });
    }
  }
  
  var tests = JSON.parse(localStorage.getItem('wwtp_jar_tests') || '[]');
  tests.unshift(test);
  if (tests.length > 50) tests = tests.slice(0, 50);
  localStorage.setItem('wwtp_jar_tests', JSON.stringify(tests));
  
  showToast('üíæ Jar test saved!', 'success');
}

// Reset Jar Test
function resetJarTest() {
  for (var i = 1; i <= 6; i++) {
    document.getElementById('jt_' + i + '_turb').value = '';
    document.getElementById('jt_' + i + '_ph').value = '';
    document.getElementById('jt_' + i + '_fph').value = '';
    document.getElementById('jt_' + i + '_floc').value = '';
  }
  document.getElementById('jt_results').innerHTML = '';
  document.getElementById('jt_chart_container').style.display = 'none';
  showToast('üîÑ Jar test reset', 'info');
}

// Calculate Syringe Doses for Jar Test
function calcSyringeDoses() {
  var jarVol = parseFloat(document.getElementById('jt_jar_vol').value) || 2000; // mL
  var stockPct = parseFloat(document.getElementById('jt_stock_pct').value) || 1.0; // %
  var syringeSize = parseFloat(document.getElementById('jt_syringe').value) || 10; // mL
  
  // Stock solution concentration: 1% = 10,000 mg/L
  var stockConc = stockPct * 10000; // mg/L
  
  // Get coagulant doses from jars
  var html = '<table style="width:100%;font-size:12px;border-collapse:collapse">';
  html += '<tr style="background:#1e3a5f"><th style="padding:5px;text-align:center">Jar</th><th style="padding:5px;text-align:center">Dose (mg/L)</th><th style="padding:5px;text-align:center;color:#4ade80">mL to Add</th><th style="padding:5px;text-align:center">Syringe Marks</th></tr>';
  
  for (var i = 1; i <= 6; i++) {
    var dose = parseFloat(document.getElementById('jt_' + i + '_coag').value) || 0;
    if (dose > 0) {
      // Formula: mL stock = (dose mg/L √ó jar volume mL) / stock conc mg/L
      var mlToAdd = (dose * jarVol) / stockConc;
      var syringeMarks = mlToAdd / syringeSize * 100; // as % of syringe
      
      var syringeText = '';
      if (mlToAdd <= syringeSize) {
        syringeText = mlToAdd.toFixed(2) + ' mL';
      } else {
        var fullSyringes = Math.floor(mlToAdd / syringeSize);
        var remainder = mlToAdd % syringeSize;
        syringeText = fullSyringes + '√ó full + ' + remainder.toFixed(2) + ' mL';
      }
      
      html += '<tr>';
      html += '<td style="padding:5px;text-align:center;font-weight:bold;color:#fbbf24">' + i + '</td>';
      html += '<td style="padding:5px;text-align:center">' + dose + '</td>';
      html += '<td style="padding:5px;text-align:center;color:#4ade80;font-weight:bold">' + mlToAdd.toFixed(2) + '</td>';
      html += '<td style="padding:5px;text-align:center;font-size:11px">' + syringeText + '</td>';
      html += '</tr>';
    }
  }
  html += '</table>';
  
  html += '<div style="margin-top:8px;padding:8px;background:#243b55;border-radius:6px;font-size:11px">';
  html += '<strong>Formula:</strong> mL = (Dose mg/L √ó ' + jarVol + ' mL) √∑ ' + stockConc.toLocaleString() + ' mg/L';
  html += '<br><strong>Stock:</strong> ' + stockPct + '% = ' + stockConc.toLocaleString() + ' mg/L';
  html += '</div>';
  
  document.getElementById('jt_syringe_results').innerHTML = html;
}

// Reset All Chemicals Calculators
function resetAllChemicals() {
  if (!confirm('Reset all Chemical Systems calculators to default values?')) return;
  
  // Chemical Feed Optimizer
  var chemFields = ['chem_flow', 'chem_p_in', 'chem_p_target', 'chem_strength', 'chem_cost'];
  var chemDefaults = [5.0, 6.0, 1.0, 48, 2.50];
  chemFields.forEach(function(id, i) {
    var el = document.getElementById(id);
    if (el) el.value = chemDefaults[i];
  });
  if (document.getElementById('chem_type')) document.getElementById('chem_type').value = 'alum';
  if (document.getElementById('chem_results')) document.getElementById('chem_results').innerHTML = '';
  
  // Jar Test
  resetJarTest();
  document.getElementById('jt_coag_type').value = 'alum';
  document.getElementById('jt_poly_type').value = 'none';
  document.getElementById('jt_coag_cost').value = '0.15';
  document.getElementById('jt_poly_cost').value = '2.50';
  document.getElementById('jt_plant_flow').value = '5.0';
  document.getElementById('jt_init_turb').value = '25';
  document.getElementById('jt_init_ph').value = '7.2';
  document.getElementById('jt_target_turb').value = '5';
  document.getElementById('jt_jar_vol').value = '2000';
  document.getElementById('jt_stock_pct').value = '1.0';
  document.getElementById('jt_syringe').value = '10';
  document.getElementById('jt_syringe_results').innerHTML = '';
  // Reset jar doses to defaults
  var defaultDoses = [10, 20, 30, 40, 50, 60];
  for (var i = 1; i <= 6; i++) {
    document.getElementById('jt_' + i + '_coag').value = defaultDoses[i-1];
    document.getElementById('jt_' + i + '_poly').value = '0';
    document.getElementById('jt_' + i + '_settle').value = '15';
  }
  
  // Chlorine Dosing
  var clFields = ['cl_flow', 'cl_dose', 'cl_strength'];
  var clDefaults = [5.0, 5.0, 12.5];
  clFields.forEach(function(id, i) {
    var el = document.getElementById(id);
    if (el) el.value = clDefaults[i];
  });
  if (document.getElementById('cl_results')) document.getElementById('cl_results').innerHTML = '';
  
  // Polymer Dosing
  var polyFields = ['poly_flow', 'poly_solids', 'poly_dose', 'poly_strength', 'poly_cost'];
  var polyDefaults = [50, 1.0, 8, 0.5, 2.50];
  polyFields.forEach(function(id, i) {
    var el = document.getElementById(id);
    if (el) el.value = polyDefaults[i];
  });
  if (document.getElementById('poly_results')) document.getElementById('poly_results').innerHTML = '';
  
  showToast('üîÑ All Chemical Systems calculators reset!', 'success');
}

// ========== END JAR TEST OPTIMIZER ==========


// ========== MULTI-METHOD SLUDGE AGE CALCULATOR ==========

// Show method panel
function showSAMethod(method) {
  // Hide all panels
  for (var i = 1; i <= 5; i++) {
    document.getElementById('sa_method_' + i).style.display = 'none';
    document.getElementById('sa_tab_' + i).className = 'btn gray';
    document.getElementById('sa_tab_' + i).style.background = '';
  }
  // Show selected
  document.getElementById('sa_method_' + method).style.display = 'block';
  document.getElementById('sa_tab_' + method).className = 'btn';
  document.getElementById('sa_tab_' + method).style.background = '#8b5cf6';
}

// Method 1: Standard SRT
function calcSA1() {
  var vol = parseFloat(document.getElementById('sa_vol').value) || 1.5;
  var mlss = parseFloat(document.getElementById('sa_mlss').value) || 3000;
  var wasFlow = parseFloat(document.getElementById('sa1_was_flow').value) || 25000;
  var wasTss = parseFloat(document.getElementById('sa1_was_tss').value) || 8000;
  
  // System solids (lb) = Vol (MG) √ó MLSS (mg/L) √ó 8.34
  var systemSolids = vol * mlss * 8.34;
  
  // WAS solids (lb/day) = WAS Flow (GPD) √ó WAS TSS (mg/L) √ó 8.34 / 1,000,000
  var wasSolids = (wasFlow * wasTss * 8.34) / 1000000;
  
  // SRT = System Solids / WAS Solids
  var srt = systemSolids / wasSolids;
  
  var status = getSRTStatus(srt);
  
  var html = '<div style="background:#1e3a5f;padding:15px;border-radius:10px">';
  html += '<table class="table"><tbody>';
  html += '<tr><td>System Solids Inventory</td><td><span class="result">' + systemSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  html += '<tr><td>WAS Solids Removed</td><td><span class="result">' + wasSolids.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td><strong>Standard SRT</strong></td><td><span class="result" style="font-size:20px;color:' + status.color + '">' + srt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Status</td><td colspan="2" style="color:' + status.color + '">' + status.icon + ' ' + status.text + '</td></tr>';
  html += '</tbody></table>';
  html += '<div style="margin-top:10px;font-size:12px;opacity:0.7">Formula: SRT = (Vol √ó MLSS √ó 8.34) √∑ (WAS Flow √ó WAS TSS √ó 8.34 √∑ 10‚Å∂)</div>';
  html += '</div>';
  
  document.getElementById('sa1_result').innerHTML = html;
  return { method: 'Standard SRT', value: srt, status: status };
}

// Method 2: MCRT (with effluent loss)
function calcSA2() {
  var vol = parseFloat(document.getElementById('sa_vol').value) || 1.5;
  var mlss = parseFloat(document.getElementById('sa_mlss').value) || 3000;
  var clarVol = parseFloat(document.getElementById('sa_clar_vol').value) || 0.3;
  var clarTss = parseFloat(document.getElementById('sa_clar_tss').value) || 5000;
  var wasFlow = parseFloat(document.getElementById('sa2_was_flow').value) || 25000;
  var wasTss = parseFloat(document.getElementById('sa2_was_tss').value) || 8000;
  var effFlow = parseFloat(document.getElementById('sa2_eff_flow').value) || 5.0;
  var effTss = parseFloat(document.getElementById('sa2_eff_tss').value) || 10;
  
  // Total system solids (aeration + clarifier)
  var aerSolids = vol * mlss * 8.34;
  var clarSolids = clarVol * clarTss * 8.34;
  var totalSolids = aerSolids + clarSolids;
  
  // Solids out
  var wasSolids = (wasFlow * wasTss * 8.34) / 1000000;
  var effSolids = effFlow * effTss * 8.34;
  var totalOut = wasSolids + effSolids;
  
  // MCRT
  var mcrt = totalSolids / totalOut;
  
  // Also calc SRT (WAS only) for comparison
  var srt = totalSolids / wasSolids;
  
  var status = getSRTStatus(mcrt);
  
  var html = '<div style="background:#1e3a5f;padding:15px;border-radius:10px">';
  html += '<table class="table"><tbody>';
  html += '<tr><td>Aeration Solids</td><td><span class="result">' + aerSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  html += '<tr><td>Clarifier Solids</td><td><span class="result">' + clarSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  html += '<tr><td><strong>Total System Solids</strong></td><td><span class="result">' + totalSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  html += '<tr style="background:#243b55"><td colspan="3"></td></tr>';
  html += '<tr><td>WAS Solids</td><td><span class="result">' + wasSolids.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Effluent Solids Loss</td><td><span class="result">' + effSolids.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Total Solids Out</td><td><span class="result">' + totalOut.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr style="background:#243b55"><td colspan="3"></td></tr>';
  html += '<tr><td><strong>MCRT</strong></td><td><span class="result" style="font-size:20px;color:' + status.color + '">' + mcrt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>SRT (WAS only)</td><td><span class="result">' + srt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Status</td><td colspan="2" style="color:' + status.color + '">' + status.icon + ' ' + status.text + '</td></tr>';
  html += '</tbody></table>';
  html += '</div>';
  
  document.getElementById('sa2_result').innerHTML = html;
  return { method: 'MCRT', value: mcrt, status: status };
}

// Method 3: Aerobic SRT (nitrification)
function calcSA3() {
  var temp = parseFloat(document.getElementById('sa3_temp').value) || 15;
  var sf = parseFloat(document.getElementById('sa3_sf').value) || 2.0;
  var umax20 = parseFloat(document.getElementById('sa3_umax').value) || 0.75;
  
  // Temperature correction (theta = 1.07 for nitrifiers)
  var umax = umax20 * Math.pow(1.07, temp - 20);
  
  // Minimum SRT = 1 / umax
  var minSRT = 1 / umax;
  
  // Design SRT with safety factor
  var designSRT = minSRT * sf;
  
  // Recommended SRT at this temperature
  var recSRT = getRecommendedSRT(temp);
  
  var html = '<div style="background:#1e3a5f;padding:15px;border-radius:10px">';
  html += '<table class="table"><tbody>';
  html += '<tr><td>Design Temperature</td><td><span class="result">' + temp + '</span></td><td>¬∞C</td></tr>';
  html += '<tr><td>Œºmax at 20¬∞C</td><td><span class="result">' + umax20.toFixed(2) + '</span></td><td>1/day</td></tr>';
  html += '<tr><td>Œºmax at ' + temp + '¬∞C</td><td><span class="result">' + umax.toFixed(3) + '</span></td><td>1/day</td></tr>';
  html += '<tr><td>Minimum SRT (no SF)</td><td><span class="result">' + minSRT.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Safety Factor</td><td><span class="result">' + sf + '</span></td><td>√ó</td></tr>';
  html += '<tr><td><strong>Design Aerobic SRT</strong></td><td><span class="result" style="font-size:20px;color:#fbbf24">' + designSRT.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Typical Recommendation</td><td><span class="result">' + recSRT + '</span></td><td>days</td></tr>';
  html += '</tbody></table>';
  html += '<div class="note warning" style="margin-top:10px">‚ö†Ô∏è Operating below minimum SRT will result in nitrifier washout!</div>';
  html += '</div>';
  
  document.getElementById('sa3_result').innerHTML = html;
  return { method: 'Aerobic SRT', value: designSRT, status: { color: '#fbbf24', text: 'Design Value' } };
}

// Method 4: F/M Based
function calcSA4() {
  var vol = parseFloat(document.getElementById('sa_vol').value) || 1.5;
  var mlvss = parseFloat(document.getElementById('sa_mlvss').value) || 2400;
  var bodLoad = parseFloat(document.getElementById('sa4_bod').value) || 4170;
  var y = parseFloat(document.getElementById('sa4_y').value) || 0.6;
  var kd = parseFloat(document.getElementById('sa4_kd').value) || 0.06;
  
  // MLVSS mass (lb)
  var mlvssMass = vol * mlvss * 8.34;
  
  // F/M ratio
  var fm = bodLoad / mlvssMass;
  
  // Observed yield
  var yObs = y / (1 + kd * (1 / (y * fm - kd)));
  
  // SRT estimate: SRT ‚âà 1 / (Y √ó F/M - kd)
  var denominator = y * fm - kd;
  var srt = denominator > 0 ? 1 / denominator : 999;
  
  var status = getSRTStatus(srt);
  
  var html = '<div style="background:#1e3a5f;padding:15px;border-radius:10px">';
  html += '<table class="table"><tbody>';
  html += '<tr><td>BOD Loading</td><td><span class="result">' + bodLoad.toLocaleString() + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>MLVSS Mass</td><td><span class="result">' + mlvssMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  html += '<tr><td>F/M Ratio</td><td><span class="result">' + fm.toFixed(3) + '</span></td><td>lb BOD/lb MLVSS/d</td></tr>';
  html += '<tr><td>Yield Coefficient (Y)</td><td><span class="result">' + y + '</span></td><td>lb VSS/lb BOD</td></tr>';
  html += '<tr><td>Decay Rate (kd)</td><td><span class="result">' + kd + '</span></td><td>1/day</td></tr>';
  html += '<tr><td><strong>Estimated SRT</strong></td><td><span class="result" style="font-size:20px;color:' + status.color + '">' + srt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Status</td><td colspan="2" style="color:' + status.color + '">' + status.icon + ' ' + status.text + '</td></tr>';
  html += '</tbody></table>';
  html += '<div style="margin-top:10px;font-size:12px;opacity:0.7">Formula: SRT ‚âà 1 √∑ (Y √ó F/M - kd)</div>';
  html += '</div>';
  
  document.getElementById('sa4_result').innerHTML = html;
  return { method: 'F/M Based', value: srt, status: status };
}

// Method 5: Kinetic (Monod)
function calcSA5() {
  var s = parseFloat(document.getElementById('sa5_s').value) || 10;
  var ks = parseFloat(document.getElementById('sa5_ks').value) || 60;
  var umax = parseFloat(document.getElementById('sa5_umax').value) || 3.0;
  var kd = parseFloat(document.getElementById('sa5_kd').value) || 0.06;
  
  // Specific growth rate at effluent substrate
  var u = (umax * s) / (ks + s);
  
  // Net growth rate
  var uNet = u - kd;
  
  // SRT = 1 / uNet (when uNet > 0)
  var srt = uNet > 0 ? 1 / uNet : 999;
  
  // Also calculate minimum SRT (when S ‚Üí 0)
  var minSRT = (ks + kd * ks / umax) / (umax - kd);
  
  var status = getSRTStatus(srt);
  
  var html = '<div style="background:#1e3a5f;padding:15px;border-radius:10px">';
  html += '<table class="table"><tbody>';
  html += '<tr><td>Effluent Substrate (S)</td><td><span class="result">' + s + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Half-saturation (Ks)</td><td><span class="result">' + ks + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Max Growth Rate (Œºmax)</td><td><span class="result">' + umax + '</span></td><td>1/day</td></tr>';
  html += '<tr><td>Specific Growth (Œº)</td><td><span class="result">' + u.toFixed(3) + '</span></td><td>1/day</td></tr>';
  html += '<tr><td>Net Growth (Œº - kd)</td><td><span class="result">' + uNet.toFixed(3) + '</span></td><td>1/day</td></tr>';
  html += '<tr><td><strong>Kinetic SRT</strong></td><td><span class="result" style="font-size:20px;color:' + status.color + '">' + srt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Minimum SRT</td><td><span class="result">' + minSRT.toFixed(2) + '</span></td><td>days</td></tr>';
  html += '</tbody></table>';
  html += '<div style="margin-top:10px;font-size:12px;opacity:0.7">Monod: Œº = Œºmax √ó S √∑ (Ks + S); SRT = 1 √∑ (Œº - kd)</div>';
  html += '</div>';
  
  document.getElementById('sa5_result').innerHTML = html;
  return { method: 'Kinetic', value: srt, status: status };
}

// Get SRT Status
function getSRTStatus(srt) {
  if (srt < 4) {
    return { color: '#ef4444', icon: '‚ùå', text: 'Too Low - No nitrification, unstable' };
  } else if (srt < 8) {
    return { color: '#fbbf24', icon: '‚ö†Ô∏è', text: 'Low - Marginal nitrification' };
  } else if (srt <= 15) {
    return { color: '#4ade80', icon: '‚úì', text: 'Good - Full nitrification' };
  } else if (srt <= 25) {
    return { color: '#60a5fa', icon: '‚úì', text: 'Extended Aeration range' };
  } else {
    return { color: '#a78bfa', icon: '‚ö†Ô∏è', text: 'Very High - Check for sludge issues' };
  }
}

// Get recommended SRT by temperature
function getRecommendedSRT(temp) {
  if (temp >= 20) return '8-12';
  if (temp >= 15) return '10-15';
  if (temp >= 10) return '15-20';
  if (temp >= 5) return '20-30';
  return '30+';
}

// Compare All Methods
function compareAllSA() {
  var results = [];
  results.push(calcSA1());
  results.push(calcSA2());
  results.push(calcSA3());
  results.push(calcSA4());
  results.push(calcSA5());
  
  // Calculate average (excluding outliers)
  var values = results.map(r => r.value).filter(v => v < 100);
  var avg = values.reduce((a, b) => a + b, 0) / values.length;
  var min = Math.min(...values);
  var max = Math.max(...values);
  
  var html = '<div style="background:linear-gradient(135deg,#1e3a5f,#2d4a6f);padding:20px;border-radius:12px;border:2px solid #8b5cf6">';
  html += '<h4 style="margin:0 0 15px 0;color:#8b5cf6">üìä Method Comparison</h4>';
  
  html += '<table class="table"><thead><tr><th>Method</th><th>SRT (days)</th><th>Status</th></tr></thead><tbody>';
  results.forEach(function(r) {
    html += '<tr>';
    html += '<td>' + r.method + '</td>';
    html += '<td><span class="result" style="color:' + r.status.color + '">' + (r.value < 100 ? r.value.toFixed(1) : 'N/A') + '</span></td>';
    html += '<td style="color:' + r.status.color + '">' + r.status.icon + ' ' + r.status.text + '</td>';
    html += '</tr>';
  });
  html += '</tbody></table>';
  
  // Summary
  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:12px;color:#94a3b8">Average</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">' + avg.toFixed(1) + '</div>';
  html += '<div style="font-size:12px;color:#94a3b8">days</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:12px;color:#94a3b8">Range</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#60a5fa">' + min.toFixed(1) + ' - ' + max.toFixed(1) + '</div>';
  html += '<div style="font-size:12px;color:#94a3b8">days</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:12px;color:#94a3b8">Variance</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + (max - min).toFixed(1) + '</div>';
  html += '<div style="font-size:12px;color:#94a3b8">days spread</div></div>';
  html += '</div>';
  
  // Recommendation
  var recommendation = '';
  if (max - min < 3) {
    recommendation = '‚úì Methods agree well. High confidence in SRT estimate.';
  } else if (max - min < 7) {
    recommendation = '‚ö†Ô∏è Some variance between methods. Verify input data.';
  } else {
    recommendation = '‚ùå Large variance. Check data accuracy and clarifier performance.';
  }
  html += '<div class="note info" style="margin-top:15px">' + recommendation + '</div>';
  
  html += '</div>';
  
  document.getElementById('sa_comparison').innerHTML = html;
  showToast('All methods calculated!', 'success');
}

// Reset All
function resetAllSA() {
  for (var i = 1; i <= 5; i++) {
    document.getElementById('sa' + i + '_result').innerHTML = '';
  }
  document.getElementById('sa_comparison').innerHTML = '';
  showToast('Sludge Age calculator reset', 'info');
}

// Calculate all on common input change
function calcAllSludgeAge() {
  // Recalculate active method
}

// ========== END MULTI-METHOD SLUDGE AGE CALCULATOR ==========


// ========== COMPREHENSIVE BIOGAS/DIGESTER CALCULATOR ==========

function calcBiogas() {
  // Digester configuration
  var numDig = parseFloat(document.getElementById('bg_num_dig').value) || 2;
  var dia = parseFloat(document.getElementById('bg_dia').value) || 60;
  var swd = parseFloat(document.getElementById('bg_swd').value) || 25;
  var digType = document.getElementById('bg_type').value;
  var temp = parseFloat(document.getElementById('bg_temp').value) || 95;
  var online = parseFloat(document.getElementById('bg_online').value) || 2;
  
  // Sludge feed
  var psFlow = parseFloat(document.getElementById('bg_ps_flow').value) || 30000;
  var psPct = parseFloat(document.getElementById('bg_ps_pct').value) || 5.0;
  var psVS = parseFloat(document.getElementById('bg_ps_vs').value) || 0.75;
  var wasFlow = parseFloat(document.getElementById('bg_was_flow').value) || 20000;
  var wasPct = parseFloat(document.getElementById('bg_was_pct').value) || 4.0;
  var wasVS = parseFloat(document.getElementById('bg_was_vs').value) || 0.70;
  
  // Performance
  var vsDest = parseFloat(document.getElementById('bg_vs_dest').value) / 100 || 0.55;
  var gasRate = parseFloat(document.getElementById('bg_gas_rate').value) || 15;
  var ch4Pct = parseFloat(document.getElementById('bg_ch4').value) / 100 || 0.65;
  
  // Economics
  var chpEff = parseFloat(document.getElementById('bg_chp_eff').value) / 100 || 0.30;
  var elecCost = parseFloat(document.getElementById('bg_elec_cost').value) || 0.10;
  var ngCost = parseFloat(document.getElementById('bg_ng_cost').value) || 1.00;
  
  // Calculate digester volume
  var areaEach = Math.PI * Math.pow(dia / 2, 2);
  var volEach = areaEach * swd; // cf
  var volTotal = volEach * numDig;
  var volOnline = volEach * online;
  var volGal = volOnline * 7.48;
  
  // Calculate sludge feed
  var totalFlow = psFlow + wasFlow;
  
  // Solids calculations
  // lb/day = gpd √ó %solids √ó 8.34
  var psSolids = psFlow * (psPct / 100) * 8.34;
  var psVolatile = psSolids * psVS;
  var wasSolids = wasFlow * (wasPct / 100) * 8.34;
  var wasVolatile = wasSolids * wasVS;
  
  var totalSolids = psSolids + wasSolids;
  var totalVS = psVolatile + wasVolatile;
  
  // Loading rates
  var vsLoading = totalVS / volOnline; // lb VS/cf/day
  var hrt = volGal / totalFlow; // days
  
  // VS destroyed and remaining
  var vsDestroyed = totalVS * vsDest;
  var vsRemaining = totalVS - vsDestroyed;
  var fixedSolids = totalSolids - totalVS;
  var digestedSolids = vsRemaining + fixedSolids;
  
  // Gas production
  var totalGas = vsDestroyed * gasRate; // cf/day
  var methaneVol = totalGas * ch4Pct;
  
  // Energy calculations
  var btuTotal = totalGas * 600; // BTU/day (biogas ~600 BTU/cf)
  var btumethane = methaneVol * 1000; // BTU/day (pure CH4 ~1000 BTU/cf)
  var therms = btumethane / 100000;
  
  // Electrical generation potential (CHP)
  var kwh = (btumethane * chpEff) / 3412; // kWh/day
  var kw = kwh / 24; // continuous kW
  
  // Economic value
  var elecValue = kwh * elecCost;
  var ngValue = therms * ngCost;
  var annualElec = elecValue * 365;
  var annualNG = ngValue * 365;
  
  // Status checks
  var vsLoadStatus = getVSLoadingStatus(vsLoading, digType);
  var hrtStatus = getHRTStatus(hrt, digType);
  
  // Build results HTML
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #f97316">';
  html += '<h4 style="margin:0 0 15px 0;color:#f97316">üî• Digester Analysis Results</h4>';
  
  // Key metrics display
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Total Volume</div>';
  html += '<div style="font-size:22px;font-weight:bold;color:#60a5fa">' + (volOnline / 1000).toFixed(0) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">cu ft</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">HRT</div>';
  html += '<div style="font-size:22px;font-weight:bold;color:' + hrtStatus.color + '">' + hrt.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">days</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">VS Loading</div>';
  html += '<div style="font-size:22px;font-weight:bold;color:' + vsLoadStatus.color + '">' + vsLoading.toFixed(3) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">lb/cf/d</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Total Gas</div>';
  html += '<div style="font-size:22px;font-weight:bold;color:#4ade80">' + (totalGas / 1000).toFixed(1) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">cf/day</div></div>';
  html += '</div>';
  
  // Detailed results table
  html += '<table class="table" style="font-size:13px">';
  html += '<tbody>';
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Solids Loading</td></tr>';
  html += '<tr><td>Total Solids Feed</td><td><span class="result">' + totalSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Volatile Solids Feed</td><td><span class="result">' + totalVS.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb VS/day</td></tr>';
  html += '<tr><td>VS Loading Rate</td><td><span class="result" style="color:' + vsLoadStatus.color + '">' + vsLoading.toFixed(3) + '</span></td><td>lb VS/cf/day</td></tr>';
  html += '<tr><td>Status</td><td colspan="2" style="color:' + vsLoadStatus.color + '">' + vsLoadStatus.icon + ' ' + vsLoadStatus.text + '</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">‚è±Ô∏è Hydraulics</td></tr>';
  html += '<tr><td>Total Sludge Flow</td><td><span class="result">' + totalFlow.toLocaleString() + '</span></td><td>gpd</td></tr>';
  html += '<tr><td>Hydraulic Retention Time</td><td><span class="result" style="color:' + hrtStatus.color + '">' + hrt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Status</td><td colspan="2" style="color:' + hrtStatus.color + '">' + hrtStatus.icon + ' ' + hrtStatus.text + '</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">üî• Gas Production</td></tr>';
  html += '<tr><td>VS Destroyed</td><td><span class="result">' + vsDestroyed.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb VS/day</td></tr>';
  html += '<tr><td>Total Biogas</td><td><span class="result">' + totalGas.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>cf/day</td></tr>';
  html += '<tr><td>Methane Volume (' + (ch4Pct * 100).toFixed(0) + '%)</td><td><span class="result">' + methaneVol.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>cf CH‚ÇÑ/day</td></tr>';
  html += '<tr><td>Energy Content</td><td><span class="result">' + (btumethane / 1000000).toFixed(2) + '</span></td><td>MMBTU/day</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">‚ö° Energy Recovery</td></tr>';
  html += '<tr><td>CHP Electrical Output</td><td><span class="result">' + kwh.toFixed(0) + '</span></td><td>kWh/day</td></tr>';
  html += '<tr><td>Continuous Power</td><td><span class="result">' + kw.toFixed(1) + '</span></td><td>kW</td></tr>';
  html += '<tr><td>Daily Electric Value</td><td><span class="result" style="color:#4ade80">$' + elecValue.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Equivalent NG Value</td><td><span class="result" style="color:#4ade80">$' + ngValue.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Annual Value (Electric)</td><td><span class="result" style="color:#4ade80;font-size:16px">$' + annualElec.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#ef4444">üóëÔ∏è Digested Sludge</td></tr>';
  html += '<tr><td>Digested Solids</td><td><span class="result">' + digestedSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Solids Reduction</td><td><span class="result">' + ((1 - digestedSolids / totalSolids) * 100).toFixed(1) + '</span></td><td>%</td></tr>';
  html += '</tbody></table>';
  
  html += '</div>';
  
  document.getElementById('bg_results').innerHTML = html;
  showToast('Biogas calculated!', 'success');
}

// Calculate Digester Heating Requirements
function calcDigesterHeating() {
  var numDig = parseFloat(document.getElementById('bg_num_dig').value) || 2;
  var dia = parseFloat(document.getElementById('bg_dia').value) || 60;
  var swd = parseFloat(document.getElementById('bg_swd').value) || 25;
  var targetTemp = parseFloat(document.getElementById('bg_temp').value) || 95;
  var online = parseFloat(document.getElementById('bg_online').value) || 2;
  
  var psFlow = parseFloat(document.getElementById('bg_ps_flow').value) || 30000;
  var wasFlow = parseFloat(document.getElementById('bg_was_flow').value) || 20000;
  var totalFlow = psFlow + wasFlow;
  
  // Assume feed sludge temp of 60¬∞F and ground temp of 55¬∞F
  var feedTemp = 60;
  var groundTemp = 55;
  var ambientTemp = 50;
  
  // Digester surface area (cylinder walls + top + bottom)
  var radius = dia / 2;
  var wallArea = Math.PI * dia * swd;
  var topArea = Math.PI * radius * radius;
  var totalArea = wallArea + topArea * 2; // walls + top + bottom
  
  // Heat loss coefficients (BTU/hr/sf/¬∞F)
  var uWall = 0.12; // insulated concrete
  var uTop = 0.10; // floating cover
  var uBottom = 0.08; // ground contact
  
  // Heat losses (BTU/hr)
  var heatLossWall = wallArea * uWall * (targetTemp - ambientTemp);
  var heatLossTop = topArea * uTop * (targetTemp - ambientTemp);
  var heatLossBottom = topArea * uBottom * (targetTemp - groundTemp);
  var totalHeatLoss = (heatLossWall + heatLossTop + heatLossBottom) * online;
  
  // Sludge heating requirement
  // BTU = flow (gpd) √ó 8.34 √ó (target - feed) √ó specific heat (1.0)
  var sludgeHeat = totalFlow * 8.34 * (targetTemp - feedTemp); // BTU/day
  var sludgeHeatHr = sludgeHeat / 24;
  
  // Total heat required
  var totalHeat = totalHeatLoss + sludgeHeatHr;
  var totalHeatDay = totalHeat * 24;
  
  // Boiler sizing (80% efficiency)
  var boilerInput = totalHeat / 0.80;
  var boilerHP = boilerInput / 33475; // 1 boiler HP = 33,475 BTU/hr
  
  // Natural gas usage
  var ngTherms = totalHeatDay / 80000; // 80% efficient boiler
  var ngCost = parseFloat(document.getElementById('bg_ng_cost').value) || 1.00;
  var dailyNGCost = ngTherms * ngCost;
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #fbbf24">';
  html += '<h4 style="margin:0 0 15px 0;color:#fbbf24">üå°Ô∏è Digester Heating Requirements</h4>';
  
  html += '<table class="table" style="font-size:13px">';
  html += '<tbody>';
  html += '<tr style="background:#243b55"><td colspan="3" style="font-weight:bold;color:#ef4444">üî• Heat Losses</td></tr>';
  html += '<tr><td>Wall Heat Loss</td><td><span class="result">' + (heatLossWall * online / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  html += '<tr><td>Top Heat Loss</td><td><span class="result">' + (heatLossTop * online / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  html += '<tr><td>Bottom Heat Loss</td><td><span class="result">' + (heatLossBottom * online / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  html += '<tr><td><strong>Total Heat Loss</strong></td><td><span class="result">' + (totalHeatLoss / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  
  html += '<tr style="background:#243b55"><td colspan="3" style="font-weight:bold;color:#60a5fa">üì• Sludge Heating</td></tr>';
  html += '<tr><td>Feed Temperature</td><td><span class="result">' + feedTemp + '</span></td><td>¬∞F</td></tr>';
  html += '<tr><td>Target Temperature</td><td><span class="result">' + targetTemp + '</span></td><td>¬∞F</td></tr>';
  html += '<tr><td>Temperature Rise</td><td><span class="result">' + (targetTemp - feedTemp) + '</span></td><td>¬∞F</td></tr>';
  html += '<tr><td>Sludge Heating</td><td><span class="result">' + (sludgeHeatHr / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  
  html += '<tr style="background:#243b55"><td colspan="3" style="font-weight:bold;color:#4ade80">‚öôÔ∏è Equipment Sizing</td></tr>';
  html += '<tr><td><strong>Total Heat Required</strong></td><td><span class="result" style="font-size:16px;color:#fbbf24">' + (totalHeat / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  html += '<tr><td>Boiler Input (80% eff)</td><td><span class="result">' + (boilerInput / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  html += '<tr><td>Boiler Size</td><td><span class="result">' + boilerHP.toFixed(0) + '</span></td><td>BHP</td></tr>';
  html += '<tr><td>Daily NG Usage</td><td><span class="result">' + ngTherms.toFixed(1) + '</span></td><td>therms/day</td></tr>';
  html += '<tr><td>Daily Heating Cost</td><td><span class="result" style="color:#ef4444">$' + dailyNGCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '</tbody></table>';
  
  // Net energy check
  var gasProduced = parseFloat(document.getElementById('bg_gas_rate').value) || 15;
  var vsDestPct = parseFloat(document.getElementById('bg_vs_dest').value) / 100 || 0.55;
  var ch4Pct = parseFloat(document.getElementById('bg_ch4').value) / 100 || 0.65;
  var psFlow = parseFloat(document.getElementById('bg_ps_flow').value) || 30000;
  var psPct = parseFloat(document.getElementById('bg_ps_pct').value) / 100 || 0.05;
  var psVS = parseFloat(document.getElementById('bg_ps_vs').value) || 0.75;
  var wasFlow = parseFloat(document.getElementById('bg_was_flow').value) || 20000;
  var wasPct = parseFloat(document.getElementById('bg_was_pct').value) / 100 || 0.04;
  var wasVS = parseFloat(document.getElementById('bg_was_vs').value) || 0.70;
  
  var totalVS = (psFlow * psPct * 8.34 * psVS) + (wasFlow * wasPct * 8.34 * wasVS);
  var gasEnergy = totalVS * vsDestPct * gasProduced * ch4Pct * 1000; // BTU/day
  var netEnergy = gasEnergy - totalHeatDay;
  
  if (netEnergy > 0) {
    html += '<div class="note success" style="margin-top:15px">‚úÖ <strong>Energy Positive!</strong> Biogas produces ' + ((gasEnergy - totalHeatDay) / 1000000).toFixed(2) + ' MMBTU/day more than heating requires.</div>';
  } else {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è <strong>Supplemental Heat Needed.</strong> Heating requires ' + (Math.abs(netEnergy) / 1000000).toFixed(2) + ' MMBTU/day more than biogas produces.</div>';
  }
  
  html += '</div>';
  
  document.getElementById('bg_heating_results').innerHTML = html;
}

// Get VS Loading status
function getVSLoadingStatus(vsLoad, digType) {
  var limits = {
    'standard': { low: 0.03, high: 0.10 },
    'high': { low: 0.15, high: 0.40 },
    'two_stage': { low: 0.25, high: 0.50 },
    'egg': { low: 0.20, high: 0.45 }
  };
  var lim = limits[digType] || limits.high;
  
  if (vsLoad < lim.low) {
    return { color: '#60a5fa', icon: '‚¨áÔ∏è', text: 'Underloaded - capacity available' };
  } else if (vsLoad <= lim.high) {
    return { color: '#4ade80', icon: '‚úì', text: 'Good - within design range' };
  } else {
    return { color: '#ef4444', icon: '‚ö†Ô∏è', text: 'Overloaded - risk of upset' };
  }
}

// Get HRT status
function getHRTStatus(hrt, digType) {
  var minHRT = {
    'standard': 30,
    'high': 15,
    'two_stage': 10,
    'egg': 15
  };
  var min = minHRT[digType] || 15;
  
  if (hrt < min * 0.8) {
    return { color: '#ef4444', icon: '‚ö†Ô∏è', text: 'Too short - incomplete digestion' };
  } else if (hrt < min) {
    return { color: '#fbbf24', icon: '‚ö†Ô∏è', text: 'Marginal - monitor closely' };
  } else {
    return { color: '#4ade80', icon: '‚úì', text: 'Adequate retention time' };
  }
}

// Reset biogas calculator
function resetBiogas() {
  document.getElementById('bg_results').innerHTML = '';
  document.getElementById('bg_heating_results').innerHTML = '';
  showToast('Biogas calculator reset', 'info');
}

// ========== END BIOGAS/DIGESTER CALCULATOR ==========


// ========== COMPREHENSIVE UV DISINFECTION CALCULATOR ==========

// Update defaults based on UV system type
function updateUVDefaults() {
  var type = document.getElementById('uv_type').value;
  var lampCost = document.getElementById('uv_lamp_cost');
  var lampLife = document.getElementById('uv_lamp_life');
  var elf = document.getElementById('uv_elf');
  
  switch(type) {
    case 'lp':
      lampCost.value = '100';
      lampLife.value = '12000';
      elf.value = '0.7';
      break;
    case 'lpho':
      lampCost.value = '150';
      lampLife.value = '12000';
      elf.value = '0.7';
      break;
    case 'mp':
      lampCost.value = '500';
      lampLife.value = '4000';
      elf.value = '0.6';
      break;
  }
  calcUVSystem();
}

// Update dose based on application and pathogen
function updateUVDose() {
  var app = document.getElementById('uv_app').value;
  var pathogen = document.getElementById('uv_pathogen').value;
  var dose = document.getElementById('uv_dose');
  var uvt = document.getElementById('uv_uvt');
  var logRed = document.getElementById('uv_log');
  
  // Set typical UVT by application
  switch(app) {
    case 'secondary': uvt.value = '60'; break;
    case 'tertiary': uvt.value = '70'; break;
    case 'reuse': uvt.value = '75'; break;
    case 'drinking': uvt.value = '95'; break;
  }
  
  // Set dose by pathogen
  var doseTable = {
    'ecoli': 25,
    'fecal': 40,
    'entero': 50,
    'crypto': 12,
    'giardia': 11,
    'virus': 186
  };
  
  dose.value = doseTable[pathogen] || 40;
  
  // Adjust for reuse
  if (app === 'reuse') {
    dose.value = Math.max(100, parseFloat(dose.value));
    logRed.value = '5';
  }
  
  calcUVSystem();
}

// Main UV system calculation
function calcUVSystem() {
  // Get inputs
  var flow = parseFloat(document.getElementById('uv_flow').value) || 5.0;
  var pf = parseFloat(document.getElementById('uv_pf').value) || 2.0;
  var channels = parseFloat(document.getElementById('uv_channels').value) || 2;
  var uvType = document.getElementById('uv_type').value;
  var redund = document.getElementById('uv_redund').value;
  
  var uvt = parseFloat(document.getElementById('uv_uvt').value) || 65;
  var tss = parseFloat(document.getElementById('uv_tss').value) || 10;
  
  var dose = parseFloat(document.getElementById('uv_dose').value) || 40;
  var logRed = parseFloat(document.getElementById('uv_log').value) || 4;
  var elf = parseFloat(document.getElementById('uv_elf').value) || 0.7;
  var ff = parseFloat(document.getElementById('uv_ff').value) || 0.8;
  var sf = parseFloat(document.getElementById('uv_sf').value) || 1.2;
  
  var elecCost = parseFloat(document.getElementById('uv_elec').value) || 0.10;
  var lampCost = parseFloat(document.getElementById('uv_lamp_cost').value) || 150;
  var lampLife = parseFloat(document.getElementById('uv_lamp_life').value) || 12000;
  
  // Calculate peak flow
  var peakFlow = flow * pf;
  var flowPerChannel = peakFlow / channels;
  var flowGPM = flowPerChannel * 694.4; // MGD to GPM
  
  // Adjusted dose (accounting for factors)
  var adjustedDose = dose * sf / (elf * ff);
  
  // UVT correction factor (lower UVT = more lamps needed)
  var uvtFactor = Math.pow(65 / uvt, 1.5);
  
  // Lamp characteristics by type
  var lampSpecs = {
    'lp': { power: 65, output: 25, name: 'Low Pressure' },      // 65W, 25 W/lamp effective
    'lpho': { power: 250, output: 80, name: 'LP High Output' }, // 250W, 80 W/lamp effective
    'mp': { power: 3000, output: 300, name: 'Medium Pressure' } // 3000W, 300 W/lamp effective
  };
  var lamp = lampSpecs[uvType];
  
  // Estimate lamps per channel based on flow and dose
  // Simplified: ~1 LPHO lamp per 100 GPM at 40 mJ/cm¬≤ with 65% UVT
  var baseLampsPerGPM = {
    'lp': 0.02,     // 50 GPM per lamp
    'lpho': 0.01,   // 100 GPM per lamp
    'mp': 0.002     // 500 GPM per lamp
  };
  
  var lampsPerChannel = Math.ceil(flowGPM * baseLampsPerGPM[uvType] * (adjustedDose / 40) * uvtFactor);
  lampsPerChannel = Math.max(lampsPerChannel, 4); // Minimum 4 lamps per bank
  
  // Apply redundancy
  var totalChannels = channels;
  if (redund === 'n1') totalChannels += 1;
  if (redund === 'n2') totalChannels += 2;
  
  var totalLamps = lampsPerChannel * totalChannels;
  var activeLamps = lampsPerChannel * channels;
  
  // Power consumption
  var powerPerChannel = lampsPerChannel * lamp.power / 1000; // kW
  var totalPower = powerPerChannel * channels; // Only active channels
  var peakPower = powerPerChannel * totalChannels; // All channels
  
  // Operating costs
  var hoursPerYear = 8760;
  var annualKWH = totalPower * hoursPerYear;
  var annualElecCost = annualKWH * elecCost;
  
  // Lamp replacement
  var replacementsPerYear = hoursPerYear / lampLife;
  var lampsPerYear = activeLamps * replacementsPerYear;
  var annualLampCost = lampsPerYear * lampCost;
  
  var totalAnnualCost = annualElecCost + annualLampCost;
  var costPerMG = totalAnnualCost / (flow * 365);
  
  // UV status check
  var uvtStatus = getUVTStatus(uvt);
  var tssStatus = tss <= 10 ? { color: '#4ade80', text: 'Good' } : (tss <= 20 ? { color: '#fbbf24', text: 'Marginal' } : { color: '#ef4444', text: 'High - pretreat' });
  
  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #06b6d4">';
  html += '<h4 style="margin:0 0 15px 0;color:#06b6d4">‚òÄÔ∏è UV System Design Results</h4>';
  
  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Total Lamps</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#06b6d4">' + totalLamps + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">' + lamp.name + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Channels</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">' + totalChannels + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">(' + channels + ' active)</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Power</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + totalPower.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">kW</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Annual Cost</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#a78bfa">$' + (totalAnnualCost / 1000).toFixed(1) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/year</div></div>';
  html += '</div>';
  
  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä System Sizing</td></tr>';
  html += '<tr><td>Peak Design Flow</td><td><span class="result">' + peakFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Flow per Channel</td><td><span class="result">' + flowGPM.toFixed(0) + '</span></td><td>GPM</td></tr>';
  html += '<tr><td>Lamps per Channel</td><td><span class="result">' + lampsPerChannel + '</span></td><td>lamps</td></tr>';
  html += '<tr><td>Total Lamps (with redund.)</td><td><span class="result">' + totalLamps + '</span></td><td>lamps</td></tr>';
  html += '<tr><td>Lamp Type</td><td colspan="2">' + lamp.name + ' (' + lamp.power + 'W)</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">‚ò¢Ô∏è Dose Calculations</td></tr>';
  html += '<tr><td>Target Dose</td><td><span class="result">' + dose + '</span></td><td>mJ/cm¬≤</td></tr>';
  html += '<tr><td>Adjusted Dose (with factors)</td><td><span class="result">' + adjustedDose.toFixed(1) + '</span></td><td>mJ/cm¬≤</td></tr>';
  html += '<tr><td>Target Log Reduction</td><td><span class="result">' + logRed + '</span></td><td>log</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">üíß Water Quality</td></tr>';
  html += '<tr><td>UVT</td><td><span class="result" style="color:' + uvtStatus.color + '">' + uvt + '%</span></td><td>' + uvtStatus.text + '</td></tr>';
  html += '<tr><td>TSS</td><td><span class="result" style="color:' + tssStatus.color + '">' + tss + ' mg/L</span></td><td>' + tssStatus.text + '</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">üí∞ Operating Costs</td></tr>';
  html += '<tr><td>Power Consumption</td><td><span class="result">' + totalPower.toFixed(1) + '</span></td><td>kW</td></tr>';
  html += '<tr><td>Annual Energy</td><td><span class="result">' + (annualKWH / 1000).toFixed(0) + '</span></td><td>MWh/yr</td></tr>';
  html += '<tr><td>Annual Electric Cost</td><td><span class="result">$' + annualElecCost.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Lamp Replacements</td><td><span class="result">' + lampsPerYear.toFixed(0) + '</span></td><td>lamps/yr</td></tr>';
  html += '<tr><td>Annual Lamp Cost</td><td><span class="result">$' + annualLampCost.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td><strong>Total Annual Cost</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + totalAnnualCost.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Cost per MG Treated</td><td><span class="result">$' + costPerMG.toFixed(2) + '</span></td><td>/MG</td></tr>';
  html += '</tbody></table>';
  
  html += '</div>';
  
  document.getElementById('uv_results').innerHTML = html;
  showToast('UV system calculated!', 'success');
}

// Compare LP vs MP systems
function compareUVSystems() {
  var flow = parseFloat(document.getElementById('uv_flow').value) || 5.0;
  var uvt = parseFloat(document.getElementById('uv_uvt').value) || 65;
  var dose = parseFloat(document.getElementById('uv_dose').value) || 40;
  var channels = parseFloat(document.getElementById('uv_channels').value) || 2;
  
  // Calculate for each type
  var systems = [
    { type: 'LP', power: 65, output: 25, cost: 100, life: 12000, lampsPerGPM: 0.02 },
    { type: 'LPHO', power: 250, output: 80, cost: 150, life: 12000, lampsPerGPM: 0.01 },
    { type: 'MP', power: 3000, output: 300, cost: 500, life: 4000, lampsPerGPM: 0.002 }
  ];
  
  var flowGPM = flow * 694.4 / channels;
  var uvtFactor = Math.pow(65 / uvt, 1.5);
  var elecCost = parseFloat(document.getElementById('uv_elec').value) || 0.10;
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #a78bfa">';
  html += '<h4 style="margin:0 0 15px 0;color:#a78bfa">üìä UV System Comparison</h4>';
  
  html += '<table class="table" style="font-size:13px">';
  html += '<thead><tr><th>Parameter</th><th>LP</th><th>LPHO</th><th>MP</th></tr></thead>';
  html += '<tbody>';
  
  var results = systems.map(function(s) {
    var lamps = Math.ceil(flowGPM * s.lampsPerGPM * (dose / 40) * uvtFactor) * channels;
    lamps = Math.max(lamps, 4 * channels);
    var power = lamps * s.power / 1000;
    var annualElec = power * 8760 * elecCost;
    var annualLamps = (lamps * 8760 / s.life) * s.cost;
    var annualTotal = annualElec + annualLamps;
    return { ...s, lamps, power, annualElec, annualLamps, annualTotal };
  });
  
  html += '<tr><td>Total Lamps</td>';
  results.forEach(r => html += '<td><span class="result">' + r.lamps + '</span></td>');
  html += '</tr>';
  
  html += '<tr><td>Power (kW)</td>';
  results.forEach(r => html += '<td><span class="result">' + r.power.toFixed(1) + '</span></td>');
  html += '</tr>';
  
  html += '<tr><td>Electric Cost ($/yr)</td>';
  results.forEach(r => html += '<td>$' + (r.annualElec / 1000).toFixed(1) + 'K</td>');
  html += '</tr>';
  
  html += '<tr><td>Lamp Cost ($/yr)</td>';
  results.forEach(r => html += '<td>$' + (r.annualLamps / 1000).toFixed(1) + 'K</td>');
  html += '</tr>';
  
  // Find lowest cost
  var minCost = Math.min(...results.map(r => r.annualTotal));
  html += '<tr style="background:#243b55"><td><strong>Total Annual</strong></td>';
  results.forEach(r => {
    var highlight = r.annualTotal === minCost ? 'color:#4ade80;font-weight:bold' : '';
    html += '<td style="' + highlight + '">$' + (r.annualTotal / 1000).toFixed(1) + 'K' + (r.annualTotal === minCost ? ' ‚úì' : '') + '</td>';
  });
  html += '</tr>';
  
  html += '</tbody></table>';
  
  // Recommendation
  var best = results.find(r => r.annualTotal === minCost);
  html += '<div class="note info" style="margin-top:15px">üí° <strong>Recommendation:</strong> ' + best.type + ' system has lowest annual operating cost for this application.</div>';
  
  html += '</div>';
  
  document.getElementById('uv_comparison').innerHTML = html;
}

// Get UVT status
function getUVTStatus(uvt) {
  if (uvt >= 75) return { color: '#4ade80', text: 'Excellent' };
  if (uvt >= 65) return { color: '#60a5fa', text: 'Good' };
  if (uvt >= 55) return { color: '#fbbf24', text: 'Fair - more lamps needed' };
  return { color: '#ef4444', text: 'Poor - pretreat recommended' };
}

// Reset UV calculator
function resetUVSystem() {
  document.getElementById('uv_results').innerHTML = '';
  document.getElementById('uv_comparison').innerHTML = '';
  showToast('UV calculator reset', 'info');
}

// Keep old calcUV for backwards compatibility
function calcUV() { calcUVSystem(); }
function resetUV() { resetUVSystem(); }

// ========== END UV DISINFECTION CALCULATOR ==========


// ========== COMPREHENSIVE NUTRIENT BALANCE CALCULATOR ==========

// Update defaults based on process type
function updateNBDefaults() {
  var process = document.getElementById('nb_process').value;
  var srt = document.getElementById('nb_srt');
  var anoxic = document.getElementById('nb_anoxic');
  var ir = document.getElementById('nb_ir');
  
  switch(process) {
    case 'conv':
      srt.value = '5'; anoxic.value = '0'; ir.value = '0';
      break;
    case 'nit':
      srt.value = '12'; anoxic.value = '0'; ir.value = '0';
      break;
    case 'ndn':
      srt.value = '15'; anoxic.value = '33'; ir.value = '3';
      break;
    case 'bnr':
      srt.value = '15'; anoxic.value = '40'; ir.value = '4';
      break;
    case 'ebpr':
      srt.value = '12'; anoxic.value = '50'; ir.value = '4';
      break;
  }
  calcNutrientBalance();
}

// Main nutrient balance calculation
function calcNutrientBalance() {
  // Get inputs
  var flow = parseFloat(document.getElementById('nb_flow').value) || 5.0;
  var bod = parseFloat(document.getElementById('nb_bod').value) || 200;
  var tss = parseFloat(document.getElementById('nb_tss').value) || 220;
  var tkn = parseFloat(document.getElementById('nb_tkn').value) || 40;
  var nh3 = parseFloat(document.getElementById('nb_nh3').value) || 28;
  var orgN = parseFloat(document.getElementById('nb_orgn').value) || 12;
  var tp = parseFloat(document.getElementById('nb_tp').value) || 7;
  var op = parseFloat(document.getElementById('nb_op').value) || 5;
  var temp = parseFloat(document.getElementById('nb_temp').value) || 20;
  
  var process = document.getElementById('nb_process').value;
  var srt = parseFloat(document.getElementById('nb_srt').value) || 12;
  var mlss = parseFloat(document.getElementById('nb_mlss').value) || 3000;
  var anoxicPct = parseFloat(document.getElementById('nb_anoxic').value) / 100 || 0.33;
  var ir = parseFloat(document.getElementById('nb_ir').value) || 3;
  var ras = parseFloat(document.getElementById('nb_ras').value) || 0.5;
  
  var nh3Lim = parseFloat(document.getElementById('nb_nh3_lim').value) || 2;
  var tnLim = parseFloat(document.getElementById('nb_tn_lim').value) || 10;
  var tpLim = parseFloat(document.getElementById('nb_tp_lim').value) || 1;
  
  var carbonSource = document.getElementById('nb_carbon').value;
  var pChem = document.getElementById('nb_pchem').value;
  var alkAvail = parseFloat(document.getElementById('nb_alk').value) || 200;
  
  // Loadings (lb/day)
  var bodLoad = flow * bod * 8.34;
  var tknLoad = flow * tkn * 8.34;
  var nh3Load = flow * nh3 * 8.34;
  var tpLoad = flow * tp * 8.34;
  
  // BOD:N:P Ratio check
  var bodnRatio = bod / tkn;
  var bodpRatio = bod / tp;
  var nRatioStatus = bodnRatio >= 20 ? { color: '#4ade80', text: 'Adequate carbon' } : { color: '#fbbf24', text: 'May need carbon supplement' };
  var pRatioStatus = bodpRatio >= 100 ? { color: '#4ade80', text: 'Adequate' } : { color: '#fbbf24', text: 'Check P removal' };
  
  // Nitrogen pathway calculations
  var nitrificationEff = 0;
  var denitrificationEff = 0;
  var effNH3 = nh3;
  var effNO3 = 0;
  var effTN = tkn;
  
  // Temperature correction for nitrification
  var minSRT = 1 / (0.75 * Math.pow(1.07, temp - 20));
  
  if (process !== 'conv' && srt > minSRT) {
    // Nitrification occurs
    nitrificationEff = Math.min(95, 85 + (srt - minSRT) * 2);
    var nh3Oxidized = nh3 * (nitrificationEff / 100);
    effNH3 = nh3 - nh3Oxidized;
    effNO3 = nh3Oxidized + orgN * 0.8; // Some org-N also nitrified
    
    // Denitrification (if anoxic zone present)
    if (anoxicPct > 0) {
      // Denitrification efficiency based on IR ratio and anoxic fraction
      var denitrificationPotential = (ir + ras) / (1 + ir + ras);
      denitrificationEff = Math.min(90, denitrificationPotential * 100 * anoxicPct * 3);
      var no3Removed = effNO3 * (denitrificationEff / 100);
      effNO3 = effNO3 - no3Removed;
    }
    
    effTN = effNH3 + effNO3 + (orgN * 0.1); // Residual org-N
  }
  
  // Phosphorus pathway
  var bioPRemoval = 0;
  var chemPRemoval = 0;
  var effTP = tp;
  
  // Bio-P removal estimate (in EBPR or BNR process)
  if (process === 'ebpr' || process === 'bnr') {
    bioPRemoval = Math.min(tp * 0.8, bod * 0.015); // ~1.5% of BOD as P uptake
    effTP = tp - bioPRemoval;
  }
  
  // Check if chemical P removal needed
  var chemPNeeded = effTP - tpLim;
  if (chemPNeeded > 0 && pChem !== 'none') {
    chemPRemoval = chemPNeeded;
    effTP = tpLim;
  }
  
  // Alkalinity balance
  var alkConsumed = nh3 * (nitrificationEff / 100) * 7.14; // 7.14 mg alk/mg N
  var alkRecovered = (effNO3 > 0 ? nh3 * (nitrificationEff / 100) * (denitrificationEff / 100) * 3.57 : 0);
  var alkNet = alkAvail - alkConsumed + alkRecovered;
  var alkStatus = alkNet > 50 ? { color: '#4ade80', text: 'Adequate' } : (alkNet > 0 ? { color: '#fbbf24', text: 'Marginal' } : { color: '#ef4444', text: 'Supplement needed' });
  
  // Oxygen demand
  var o2BOD = bodLoad * 1.5; // 1.5 lb O2/lb BOD
  var o2Nit = tknLoad * 4.6 * (nitrificationEff / 100); // 4.6 lb O2/lb N
  var o2Credit = tknLoad * (nitrificationEff / 100) * (denitrificationEff / 100) * 2.86; // Denit credit
  var totalO2 = o2BOD + o2Nit - o2Credit;
  
  // Carbon requirement for denitrification
  var carbonReq = 0;
  var carbonCost = 0;
  if (denitrificationEff > 0) {
    var no3ToRemove = flow * effNO3 * 8.34 * (denitrificationEff / (100 - denitrificationEff));
    carbonReq = no3ToRemove * 3.0; // ~3 lb methanol/lb NO3-N
    if (carbonSource === 'methanol') carbonCost = carbonReq * 0.50;
    else if (carbonSource === 'acetate') carbonCost = carbonReq * 0.80;
    else if (carbonSource === 'glycerol') carbonCost = carbonReq * 0.60;
  }
  
  // Chemical P cost
  var pChemCost = 0;
  var pChemDose = 0;
  if (chemPRemoval > 0 && pChem !== 'none') {
    pChemDose = flow * chemPRemoval * 8.34 * (pChem === 'alum' ? 10 : 5);
    pChemCost = pChemDose * (pChem === 'alum' ? 0.15 : 0.20);
  }
  
  // Compliance check
  var nh3Compliant = effNH3 <= nh3Lim;
  var tnCompliant = effTN <= tnLim;
  var tpCompliant = effTP <= tpLim;
  
  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #22c55e">';
  html += '<h4 style="margin:0 0 15px 0;color:#22c55e">üåø Nutrient Balance Results</h4>';
  
  // Compliance summary cards
  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:' + (nh3Compliant ? '#065f46' : '#7f1d1d') + ';padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;opacity:0.8">Effluent NH‚ÇÉ-N</div>';
  html += '<div style="font-size:18px;font-weight:bold">' + effNH3.toFixed(1) + '</div>';
  html += '<div style="font-size:11px">Limit: ' + nh3Lim + ' mg/L ' + (nh3Compliant ? '‚úì' : '‚úó') + '</div></div>';
  html += '<div style="background:' + (tnCompliant ? '#065f46' : '#7f1d1d') + ';padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;opacity:0.8">Effluent TN</div>';
  html += '<div style="font-size:18px;font-weight:bold">' + effTN.toFixed(1) + '</div>';
  html += '<div style="font-size:11px">Limit: ' + tnLim + ' mg/L ' + (tnCompliant ? '‚úì' : '‚úó') + '</div></div>';
  html += '<div style="background:' + (tpCompliant ? '#065f46' : '#7f1d1d') + ';padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;opacity:0.8">Effluent TP</div>';
  html += '<div style="font-size:18px;font-weight:bold">' + effTP.toFixed(1) + '</div>';
  html += '<div style="font-size:11px">Limit: ' + tpLim + ' mg/L ' + (tpCompliant ? '‚úì' : '‚úó') + '</div></div>';
  html += '</div>';
  
  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Influent Ratios</td></tr>';
  html += '<tr><td>BOD:N Ratio</td><td><span class="result">' + bodnRatio.toFixed(1) + ':1</span></td><td style="color:' + nRatioStatus.color + '">' + nRatioStatus.text + '</td></tr>';
  html += '<tr><td>BOD:P Ratio</td><td><span class="result">' + bodpRatio.toFixed(0) + ':1</span></td><td style="color:' + pRatioStatus.color + '">' + pRatioStatus.text + '</td></tr>';
  html += '<tr><td>BOD:N:P</td><td colspan="2"><span class="result">' + (bod/tp).toFixed(0) + ':' + (tkn/tp).toFixed(1) + ':1</span> (ideal ~100:5:1)</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üß™ Nitrogen Balance</td></tr>';
  html += '<tr><td>Nitrification Efficiency</td><td><span class="result">' + nitrificationEff.toFixed(0) + '%</span></td><td>' + (process === 'conv' ? 'Not designed' : (srt > minSRT ? 'SRT adequate' : 'Increase SRT')) + '</td></tr>';
  html += '<tr><td>Denitrification Efficiency</td><td><span class="result">' + denitrificationEff.toFixed(0) + '%</span></td><td>' + (anoxicPct > 0 ? 'IR=' + ir + ', Anoxic=' + (anoxicPct*100).toFixed(0) + '%' : 'No anoxic zone') + '</td></tr>';
  html += '<tr><td>Effluent NH‚ÇÉ-N</td><td><span class="result" style="color:' + (nh3Compliant ? '#4ade80' : '#ef4444') + '">' + effNH3.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Effluent NO‚ÇÉ-N</td><td><span class="result">' + effNO3.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Effluent TN</td><td><span class="result" style="color:' + (tnCompliant ? '#4ade80' : '#ef4444') + '">' + effTN.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">üî¨ Phosphorus Balance</td></tr>';
  html += '<tr><td>Bio-P Removal</td><td><span class="result">' + bioPRemoval.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Chemical P Removal</td><td><span class="result">' + chemPRemoval.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Effluent TP</td><td><span class="result" style="color:' + (tpCompliant ? '#4ade80' : '#ef4444') + '">' + effTP.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">‚öóÔ∏è Alkalinity Balance</td></tr>';
  html += '<tr><td>Alkalinity Consumed (Nit)</td><td><span class="result">' + alkConsumed.toFixed(0) + '</span></td><td>mg/L as CaCO‚ÇÉ</td></tr>';
  html += '<tr><td>Alkalinity Recovered (Denit)</td><td><span class="result">' + alkRecovered.toFixed(0) + '</span></td><td>mg/L as CaCO‚ÇÉ</td></tr>';
  html += '<tr><td>Net Alkalinity</td><td><span class="result" style="color:' + alkStatus.color + '">' + alkNet.toFixed(0) + '</span></td><td>' + alkStatus.text + '</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#ef4444">üí® Oxygen Demand</td></tr>';
  html += '<tr><td>BOD Oxidation</td><td><span class="result">' + o2BOD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb O‚ÇÇ/day</td></tr>';
  html += '<tr><td>Nitrification</td><td><span class="result">' + o2Nit.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb O‚ÇÇ/day</td></tr>';
  html += '<tr><td>Denitrification Credit</td><td><span class="result">-' + o2Credit.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb O‚ÇÇ/day</td></tr>';
  html += '<tr><td><strong>Total O‚ÇÇ Demand</strong></td><td><span class="result" style="font-size:16px;color:#60a5fa">' + totalO2.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb O‚ÇÇ/day</td></tr>';
  
  html += '</tbody></table>';
  
  // Recommendations
  var recs = [];
  if (!nh3Compliant) recs.push('Increase SRT or lower loading for better nitrification');
  if (!tnCompliant && anoxicPct < 0.4) recs.push('Increase anoxic fraction or internal recycle for TN');
  if (!tpCompliant && pChem === 'none') recs.push('Add chemical P removal to meet TP limit');
  if (alkNet < 50) recs.push('Monitor alkalinity - may need supplementation');
  if (recs.length > 0) {
    html += '<div class="note warning" style="margin-top:15px"><strong>‚ö†Ô∏è Recommendations:</strong><ul style="margin:5px 0 0 20px">';
    recs.forEach(r => html += '<li>' + r + '</li>');
    html += '</ul></div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ System meets all nutrient limits!</div>';
  }
  
  html += '</div>';
  
  document.getElementById('nb_results').innerHTML = html;
  showToast('Nutrient balance calculated!', 'success');
}

// Show nutrient flow diagram
function showNutrientDiagram() {
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px">';
  html += '<h4 style="margin:0 0 15px 0;color:#22c55e">üìä Nitrogen & Phosphorus Pathways</h4>';
  
  // Simple text diagram
  html += '<div style="font-family:monospace;font-size:12px;background:#0f172a;padding:15px;border-radius:8px;overflow-x:auto">';
  html += '<pre style="margin:0;color:#94a3b8">';
  html += '           INFLUENT                     EFFLUENT\n';
  html += '              ‚îÇ                            ‚îÇ\n';
  html += '     TKN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ [AEROBIC] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚ñ∫ NH‚ÇÉ-N (residual)\n';
  html += '     (NH‚ÇÉ+Org)‚îÇ         ‚îÇ                 ‚îÇ\n';
  html += '              ‚îÇ         ‚ñº                 ‚îÇ\n';
  html += '              ‚îÇ      NO‚ÇÉ-N ‚îÄ‚îÄ‚ñ∫ [ANOXIC]‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚ñ∫ NO‚ÇÉ-N (residual)\n';
  html += '              ‚îÇ                   ‚îÇ       ‚îÇ\n';
  html += '              ‚îÇ                   ‚ñº       ‚îÇ\n';
  html += '              ‚îÇ                  N‚ÇÇ ‚Üë     ‚îÇ\n';
  html += '              ‚îÇ                 (gas)     ‚îÇ\n';
  html += '              ‚îÇ                           ‚îÇ\n';
  html += '     TP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ [BIO-P] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚ñ∫ TP (effluent)\n';
  html += '              ‚îÇ         ‚îÇ                 ‚îÇ\n';
  html += '              ‚îÇ    [CHEM-P]‚îÄ‚îÄ‚îÄ‚ñ∫ Sludge    ‚îÇ\n';
  html += '              ‚îÇ                           ‚îÇ\n';
  html += '</pre>';
  html += '</div>';
  
  html += '<div style="margin-top:15px;display:grid;grid-template-columns:repeat(2,1fr);gap:15px">';
  html += '<div style="background:#243b55;padding:10px;border-radius:8px">';
  html += '<strong style="color:#4ade80">Nitrogen Pathway:</strong><br>';
  html += '<span style="font-size:12px">TKN ‚Üí NH‚ÇÉ ‚Üí NO‚ÇÉ ‚Üí N‚ÇÇ(g)</span>';
  html += '</div>';
  html += '<div style="background:#243b55;padding:10px;border-radius:8px">';
  html += '<strong style="color:#a78bfa">Phosphorus Pathway:</strong><br>';
  html += '<span style="font-size:12px">TP ‚Üí Bio-P uptake ‚Üí Sludge/Effluent</span>';
  html += '</div>';
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('nb_diagram').innerHTML = html;
}

// Reset nutrient balance calculator
function resetNutrientBalance() {
  document.getElementById('nb_results').innerHTML = '';
  document.getElementById('nb_diagram').innerHTML = '';
  showToast('Nutrient calculator reset', 'info');
}

// ========== END NUTRIENT BALANCE CALCULATOR ==========


// ========== WET WEATHER & I/I CALCULATOR ==========

function calcWetWeather() {
  // Get inputs
  var dwf = parseFloat(document.getElementById('ww_dwf').value) || 5.0;
  var minFlow = parseFloat(document.getElementById('ww_min').value) || 3.0;
  var maxDry = parseFloat(document.getElementById('ww_max_dry').value) || 7.0;
  var area = parseFloat(document.getElementById('ww_area').value) || 5000;
  var pop = parseFloat(document.getElementById('ww_pop').value) || 50000;
  var sewerMi = parseFloat(document.getElementById('ww_sewer_mi').value) || 100;
  
  var wwf = parseFloat(document.getElementById('ww_wwf').value) || 15.0;
  var duration = parseFloat(document.getElementById('ww_duration').value) || 6;
  var rain = parseFloat(document.getElementById('ww_rain').value) || 1.5;
  var recurrence = document.getElementById('ww_recurrence').value;
  var gw = document.getElementById('ww_gw').value;
  var season = document.getElementById('ww_season').value;
  
  var capacity = parseFloat(document.getElementById('ww_capacity').value) || 10.0;
  var peakCap = parseFloat(document.getElementById('ww_peak_cap').value) || 15.0;
  var bypassThresh = parseFloat(document.getElementById('ww_bypass').value) || 18.0;
  var storage = parseFloat(document.getElementById('ww_storage').value) || 2.0;
  var bodDry = parseFloat(document.getElementById('ww_bod_dry').value) || 200;
  var bodLim = parseFloat(document.getElementById('ww_bod_lim').value) || 30;
  
  // Calculate flow metrics
  var peakingFactor = wwf / dwf;
  var excessFlow = wwf - dwf;
  var iiFlow = wwf - maxDry; // I&I = wet weather - max dry weather
  var iiPercent = (iiFlow / wwf) * 100;
  
  // Per-unit I&I rates
  var iiPerMile = (iiFlow * 1000000) / sewerMi;
  var iiPerCapita = (iiFlow * 1000000) / pop;
  var rdii = (iiFlow * 1000000) / (rain * area); // RDII = gal/in/acre
  
  // Capacity analysis
  var capacityUsed = (wwf / peakCap) * 100;
  var headroom = peakCap - wwf;
  var bypassRisk = wwf >= bypassThresh;
  var storageHours = (storage * 1000000) / ((wwf - capacity) * 1000000 / 24);
  if (wwf <= capacity) storageHours = 999; // No storage needed
  
  // Volume calculations
  var totalWWVolume = wwf * (duration / 24); // MG during storm
  var excessVolume = (wwf - capacity) * (duration / 24);
  if (excessVolume < 0) excessVolume = 0;
  
  // Dilution impact
  var dilutionFactor = dwf / wwf;
  var bodWet = bodDry * dilutionFactor;
  var treatmentMargin = (bodLim / bodWet) * 100;
  
  // Status checks
  var peakingStatus = getPeakingStatus(peakingFactor);
  var iiMileStatus = getIIMileStatus(iiPerMile);
  var capacityStatus = getCapacityStatus(capacityUsed);
  
  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #0ea5e9">';
  html += '<h4 style="margin:0 0 15px 0;color:#0ea5e9">üåßÔ∏è Wet Weather Analysis Results</h4>';
  
  // Key metrics cards
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Peaking Factor</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + peakingStatus.color + '">' + peakingFactor.toFixed(1) + 'x</div>';
  html += '<div style="font-size:11px;color:' + peakingStatus.color + '">' + peakingStatus.text + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">I&I Flow</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#f97316">' + iiFlow.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">MGD</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Capacity Used</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + capacityStatus.color + '">' + capacityUsed.toFixed(0) + '%</div>';
  html += '<div style="font-size:11px;color:' + capacityStatus.color + '">' + capacityStatus.text + '</div></div>';
  html += '<div style="background:' + (bypassRisk ? '#7f1d1d' : '#065f46') + ';padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;opacity:0.8">SSO/Bypass Risk</div>';
  html += '<div style="font-size:18px;font-weight:bold">' + (bypassRisk ? '‚ö†Ô∏è HIGH' : '‚úì LOW') + '</div>';
  html += '<div style="font-size:11px;opacity:0.8">' + (bypassRisk ? 'Exceeds threshold' : 'Within capacity') + '</div></div>';
  html += '</div>';
  
  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Flow Analysis</td></tr>';
  html += '<tr><td>Dry Weather Flow</td><td><span class="result">' + dwf.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Peak Wet Weather Flow</td><td><span class="result">' + wwf.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Excess Flow (WWF - DWF)</td><td><span class="result">' + excessFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Peaking Factor</td><td><span class="result" style="color:' + peakingStatus.color + '">' + peakingFactor.toFixed(2) + '</span></td><td>√ó</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#f97316">üíß I&I Metrics</td></tr>';
  html += '<tr><td>I&I Flow (WWF - Max Dry)</td><td><span class="result">' + iiFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>I&I Percentage</td><td><span class="result">' + iiPercent.toFixed(1) + '</span></td><td>%</td></tr>';
  html += '<tr><td>I&I per Mile of Sewer</td><td><span class="result" style="color:' + iiMileStatus.color + '">' + iiPerMile.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>gpd/mi</td></tr>';
  html += '<tr><td>I&I per Capita</td><td><span class="result">' + iiPerCapita.toFixed(0) + '</span></td><td>gpd/cap</td></tr>';
  html += '<tr><td>RDII</td><td><span class="result">' + rdii.toFixed(0) + '</span></td><td>gal/in/acre</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üè≠ Capacity Analysis</td></tr>';
  html += '<tr><td>Design Capacity</td><td><span class="result">' + capacity.toFixed(1) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Peak Hydraulic Capacity</td><td><span class="result">' + peakCap.toFixed(1) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Capacity Used</td><td><span class="result" style="color:' + capacityStatus.color + '">' + capacityUsed.toFixed(0) + '%</span></td><td></td></tr>';
  html += '<tr><td>Headroom</td><td><span class="result">' + headroom.toFixed(1) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Storage Time @ Peak</td><td><span class="result">' + (storageHours < 100 ? storageHours.toFixed(1) : 'N/A') + '</span></td><td>hours</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">üß™ Treatment Impact</td></tr>';
  html += '<tr><td>Dilution Factor</td><td><span class="result">' + dilutionFactor.toFixed(2) + '</span></td><td></td></tr>';
  html += '<tr><td>Influent BOD (wet weather)</td><td><span class="result">' + bodWet.toFixed(0) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Effluent BOD Limit</td><td><span class="result">' + bodLim + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Treatment Margin</td><td><span class="result">' + treatmentMargin.toFixed(0) + '</span></td><td>%</td></tr>';
  
  html += '</tbody></table>';
  
  // Recommendations
  var recs = [];
  if (peakingFactor > 4) recs.push('High peaking factor suggests significant I&I - investigate sources');
  if (iiPerMile > 10000) recs.push('I&I rate exceeds 10,000 gpd/mi - consider rehabilitation program');
  if (capacityUsed > 100) recs.push('Peak flow exceeds hydraulic capacity - storage or capacity expansion needed');
  if (bypassRisk) recs.push('SSO/bypass risk - implement flow equalization or reduce I&I');
  if (storageHours < 2 && storageHours > 0) recs.push('Limited storage time - consider additional equalization');
  
  if (recs.length > 0) {
    html += '<div class="note warning" style="margin-top:15px"><strong>‚ö†Ô∏è Recommendations:</strong><ul style="margin:5px 0 0 20px">';
    recs.forEach(r => html += '<li>' + r + '</li>');
    html += '</ul></div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ System within capacity for this storm event.</div>';
  }
  
  html += '</div>';
  
  document.getElementById('ww_results').innerHTML = html;
  showToast('Wet weather analysis complete!', 'success');
}

// Calculate detailed I&I analysis
function calcIandI() {
  var dwf = parseFloat(document.getElementById('ww_dwf').value) || 5.0;
  var minFlow = parseFloat(document.getElementById('ww_min').value) || 3.0;
  var maxDry = parseFloat(document.getElementById('ww_max_dry').value) || 7.0;
  var wwf = parseFloat(document.getElementById('ww_wwf').value) || 15.0;
  var sewerMi = parseFloat(document.getElementById('ww_sewer_mi').value) || 100;
  var pop = parseFloat(document.getElementById('ww_pop').value) || 50000;
  var gw = document.getElementById('ww_gw').value;
  
  // Base wastewater flow (from min flow)
  var bwf = minFlow * 0.9; // ~90% of min is base
  
  // Groundwater infiltration (chronic)
  var gwiFactor = { low: 0.1, normal: 0.2, high: 0.35 }[gw] || 0.2;
  var gwi = (dwf - bwf) * gwiFactor;
  
  // Direct inflow (storm-related)
  var directInflow = wwf - maxDry;
  
  // RDII (Rainfall Derived I&I)
  var rdii = wwf - dwf - gwi;
  if (rdii < 0) rdii = 0;
  
  // Total I&I
  var totalII = gwi + directInflow;
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #f97316">';
  html += '<h4 style="margin:0 0 15px 0;color:#f97316">üíß I&I Breakdown Analysis</h4>';
  
  html += '<table class="table" style="font-size:13px"><tbody>';
  html += '<tr><td>Base Wastewater Flow</td><td><span class="result">' + bwf.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Groundwater Infiltration (GWI)</td><td><span class="result">' + gwi.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Direct Inflow (storm)</td><td><span class="result">' + directInflow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>RDII (Rainfall Derived)</td><td><span class="result">' + rdii.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr style="background:#243b55"><td><strong>Total I&I</strong></td><td><span class="result" style="font-size:16px;color:#f97316">' + totalII.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '</tbody></table>';
  
  // I&I Component chart (text-based)
  html += '<div style="margin-top:15px;background:#0f172a;padding:15px;border-radius:8px">';
  html += '<div style="font-size:12px;color:#94a3b8;margin-bottom:10px">I&I Component Distribution:</div>';
  var gwiPct = (gwi / totalII) * 100 || 0;
  var inflowPct = (directInflow / totalII) * 100 || 0;
  html += '<div style="display:flex;height:24px;border-radius:4px;overflow:hidden">';
  html += '<div style="width:' + gwiPct + '%;background:#3b82f6" title="GWI ' + gwiPct.toFixed(0) + '%"></div>';
  html += '<div style="width:' + inflowPct + '%;background:#f97316" title="Inflow ' + inflowPct.toFixed(0) + '%"></div>';
  html += '</div>';
  html += '<div style="display:flex;justify-content:space-between;font-size:11px;margin-top:5px">';
  html += '<span style="color:#3b82f6">‚ñ† GWI: ' + gwiPct.toFixed(0) + '%</span>';
  html += '<span style="color:#f97316">‚ñ† Direct Inflow: ' + inflowPct.toFixed(0) + '%</span>';
  html += '</div>';
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('ww_ii_results').innerHTML = html;
}

// Calculate storage requirements
function calcStorageNeeded() {
  var wwf = parseFloat(document.getElementById('ww_wwf').value) || 15.0;
  var capacity = parseFloat(document.getElementById('ww_capacity').value) || 10.0;
  var duration = parseFloat(document.getElementById('ww_duration').value) || 6;
  var storage = parseFloat(document.getElementById('ww_storage').value) || 2.0;
  
  var excessFlow = wwf - capacity;
  if (excessFlow < 0) excessFlow = 0;
  
  var storageNeeded = excessFlow * (duration / 24); // MG
  var additionalNeeded = storageNeeded - storage;
  if (additionalNeeded < 0) additionalNeeded = 0;
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #a78bfa">';
  html += '<h4 style="margin:0 0 15px 0;color:#a78bfa">üèóÔ∏è Storage Requirements</h4>';
  
  html += '<table class="table" style="font-size:13px"><tbody>';
  html += '<tr><td>Excess Flow Rate</td><td><span class="result">' + excessFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Storm Duration</td><td><span class="result">' + duration + '</span></td><td>hours</td></tr>';
  html += '<tr><td>Storage Volume Needed</td><td><span class="result">' + storageNeeded.toFixed(2) + '</span></td><td>MG</td></tr>';
  html += '<tr><td>Existing Storage</td><td><span class="result">' + storage.toFixed(2) + '</span></td><td>MG</td></tr>';
  html += '<tr style="background:#243b55"><td><strong>Additional Storage Needed</strong></td><td><span class="result" style="font-size:16px;color:' + (additionalNeeded > 0 ? '#ef4444' : '#4ade80') + '">' + additionalNeeded.toFixed(2) + '</span></td><td>MG</td></tr>';
  html += '</tbody></table>';
  
  if (additionalNeeded > 0) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Need ' + additionalNeeded.toFixed(2) + ' MG additional storage (' + (additionalNeeded * 1000000).toLocaleString() + ' gallons) to handle this storm event without bypass.</div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ Existing storage sufficient for this storm event.</div>';
  }
  
  html += '</div>';
  
  document.getElementById('ww_ii_results').innerHTML = html;
}

// Status helpers
function getPeakingStatus(pf) {
  if (pf <= 2.5) return { color: '#4ade80', text: 'Normal' };
  if (pf <= 3.5) return { color: '#fbbf24', text: 'Elevated' };
  if (pf <= 5) return { color: '#f97316', text: 'High I&I likely' };
  return { color: '#ef4444', text: 'Severe I&I' };
}

function getIIMileStatus(ii) {
  if (ii <= 3000) return { color: '#4ade80', text: 'Low' };
  if (ii <= 6000) return { color: '#fbbf24', text: 'Moderate' };
  if (ii <= 10000) return { color: '#f97316', text: 'High' };
  return { color: '#ef4444', text: 'Excessive' };
}

function getCapacityStatus(pct) {
  if (pct <= 75) return { color: '#4ade80', text: 'Good' };
  if (pct <= 90) return { color: '#fbbf24', text: 'Elevated' };
  if (pct <= 100) return { color: '#f97316', text: 'At capacity' };
  return { color: '#ef4444', text: 'Over capacity' };
}

function resetWetWeather() {
  document.getElementById('ww_results').innerHTML = '';
  document.getElementById('ww_ii_results').innerHTML = '';
  showToast('Wet weather calculator reset', 'info');
}

// ========== END WET WEATHER CALCULATOR ==========


// ========== SEPTAGE RECEIVING CALCULATOR ==========

// Update defaults based on septage type
function updateSeptageDefaults() {
  var type = document.getElementById('sep_type').value;
  var bod = document.getElementById('sep_bod');
  var tss = document.getElementById('sep_tss');
  var tkn = document.getElementById('sep_tkn');
  var nh3 = document.getElementById('sep_nh3');
  var fog = document.getElementById('sep_fog');
  
  var defaults = {
    'residential': { bod: 6000, tss: 15000, tkn: 700, nh3: 400, fog: 8000 },
    'commercial': { bod: 3000, tss: 8000, tkn: 300, nh3: 150, fog: 5000 },
    'grease': { bod: 50000, tss: 25000, tkn: 100, nh3: 50, fog: 100000 },
    'portable': { bod: 10000, tss: 25000, tkn: 1000, nh3: 600, fog: 4000 },
    'mixed': { bod: 8000, tss: 18000, tkn: 500, nh3: 300, fog: 15000 }
  };
  
  var d = defaults[type] || defaults.residential;
  bod.value = d.bod;
  tss.value = d.tss;
  tkn.value = d.tkn;
  nh3.value = d.nh3;
  fog.value = d.fog;
  
  calcSeptage();
}

// Main septage calculation
function calcSeptage() {
  // Plant baseline
  var designFlow = parseFloat(document.getElementById('sep_design').value) || 5.0;
  var currentFlow = parseFloat(document.getElementById('sep_flow').value) || 4.0;
  var availPct = parseFloat(document.getElementById('sep_avail').value) || 20;
  var bodLoad = parseFloat(document.getElementById('sep_bod_load').value) || 6000;
  var bodCap = parseFloat(document.getElementById('sep_bod_cap').value) || 8000;
  var tssLoad = parseFloat(document.getElementById('sep_tss_load').value) || 5500;
  
  // Septage characteristics
  var sepBod = parseFloat(document.getElementById('sep_bod').value) || 6000;
  var sepTss = parseFloat(document.getElementById('sep_tss').value) || 15000;
  var sepTkn = parseFloat(document.getElementById('sep_tkn').value) || 700;
  var sepNh3 = parseFloat(document.getElementById('sep_nh3').value) || 400;
  var sepFog = parseFloat(document.getElementById('sep_fog').value) || 8000;
  
  // Receiving operations
  var truckSize = parseFloat(document.getElementById('sep_truck').value) || 3000;
  var trucksPerDay = parseFloat(document.getElementById('sep_trucks').value) || 10;
  var opHours = parseFloat(document.getElementById('sep_hours').value) || 8;
  var recRate = parseFloat(document.getElementById('sep_rate').value) || 200;
  var maxVol = parseFloat(document.getElementById('sep_max_vol').value) || 50000;
  
  // Economics
  var tipFee = parseFloat(document.getElementById('sep_fee').value) || 0.08;
  var treatCost = parseFloat(document.getElementById('sep_cost').value) || 0.02;
  
  // Calculate daily septage volume
  var dailyVol = Math.min(truckSize * trucksPerDay, maxVol);
  var dailyVolMG = dailyVol / 1000000;
  
  // Calculate loadings from septage
  var sepBodLoad = dailyVol * sepBod * 8.34 / 1000000; // lb/day
  var sepTssLoad = dailyVol * sepTss * 8.34 / 1000000;
  var sepTknLoad = dailyVol * sepTkn * 8.34 / 1000000;
  var sepFogLoad = dailyVol * sepFog * 8.34 / 1000000;
  
  // Plant loading after septage
  var totalBodLoad = bodLoad + sepBodLoad;
  var bodCapUsed = (totalBodLoad / bodCap) * 100;
  
  // Flow impact
  var totalFlow = currentFlow + dailyVolMG;
  var flowCapUsed = (totalFlow / designFlow) * 100;
  
  // Slug loading check (if all discharged in one hour)
  var slugBod = (truckSize * sepBod * 8.34) / 1000000; // lb per truck
  var avgHourlyBod = bodLoad / 24;
  var slugFactor = slugBod / avgHourlyBod;
  
  // Economics
  var dailyRevenue = dailyVol * tipFee;
  var dailyCost = dailyVol * treatCost;
  var dailyProfit = dailyRevenue - dailyCost;
  var annualRevenue = dailyRevenue * 365;
  var annualProfit = dailyProfit * 365;
  
  // Time to discharge
  var dischargeTime = dailyVol / recRate; // minutes total
  var trucksPerHour = 60 / (truckSize / recRate);
  
  // Status checks
  var bodStatus = getBodLoadStatus(bodCapUsed);
  var flowStatus = getFlowLoadStatus(flowCapUsed);
  var slugStatus = getSlugStatus(slugFactor);
  
  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #84cc16">';
  html += '<h4 style="margin:0 0 15px 0;color:#84cc16">üöõ Septage Receiving Analysis</h4>';
  
  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Daily Volume</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#84cc16">' + (dailyVol/1000).toFixed(0) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">gallons</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">BOD Added</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + sepBodLoad.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">lb/day</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">BOD Capacity</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + bodStatus.color + '">' + bodCapUsed.toFixed(0) + '%</div>';
  html += '<div style="font-size:11px;color:' + bodStatus.color + '">' + bodStatus.text + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Daily Profit</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">$' + dailyProfit.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/day</div></div>';
  html += '</div>';
  
  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Volume & Operations</td></tr>';
  html += '<tr><td>Daily Septage Volume</td><td><span class="result">' + dailyVol.toLocaleString() + '</span></td><td>gal/day</td></tr>';
  html += '<tr><td>Trucks per Day</td><td><span class="result">' + trucksPerDay + '</span></td><td>trucks</td></tr>';
  html += '<tr><td>Trucks per Hour (at ' + recRate + ' GPM)</td><td><span class="result">' + trucksPerHour.toFixed(1) + '</span></td><td>trucks/hr</td></tr>';
  html += '<tr><td>Total Discharge Time</td><td><span class="result">' + (dischargeTime/60).toFixed(1) + '</span></td><td>hours</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">‚öñÔ∏è Loading Impacts</td></tr>';
  html += '<tr><td>BOD Load Added</td><td><span class="result">' + sepBodLoad.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>TSS Load Added</td><td><span class="result">' + sepTssLoad.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>TKN Load Added</td><td><span class="result">' + sepTknLoad.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>FOG Load Added</td><td><span class="result">' + sepFogLoad.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Total Plant BOD</td><td><span class="result">' + totalBodLoad.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>BOD Capacity Used</td><td><span class="result" style="color:' + bodStatus.color + '">' + bodCapUsed.toFixed(0) + '%</span></td><td>' + bodStatus.text + '</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#ef4444">‚ö° Slug Loading</td></tr>';
  html += '<tr><td>BOD per Truck</td><td><span class="result">' + slugBod.toFixed(0) + '</span></td><td>lb</td></tr>';
  html += '<tr><td>Avg Hourly BOD (plant)</td><td><span class="result">' + avgHourlyBod.toFixed(0) + '</span></td><td>lb/hr</td></tr>';
  html += '<tr><td>Slug Factor</td><td><span class="result" style="color:' + slugStatus.color + '">' + slugFactor.toFixed(1) + 'x</span></td><td>' + slugStatus.text + '</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üí∞ Economics</td></tr>';
  html += '<tr><td>Daily Revenue</td><td><span class="result">$' + dailyRevenue.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Daily Treatment Cost</td><td><span class="result">$' + dailyCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Daily Net Profit</td><td><span class="result" style="color:#4ade80">$' + dailyProfit.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Annual Revenue</td><td><span class="result">$' + annualRevenue.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td><strong>Annual Profit</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + annualProfit.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  
  html += '</tbody></table>';
  
  // Recommendations
  var recs = [];
  if (bodCapUsed > 90) recs.push('BOD loading near capacity - consider reducing septage volume');
  if (slugFactor > 3) recs.push('High slug loading potential - spread deliveries throughout day');
  if (sepFogLoad > 500) recs.push('Significant FOG load - ensure adequate grease removal');
  if (dailyProfit < 0) recs.push('Operating at a loss - increase tipping fee or reduce costs');
  
  if (recs.length > 0) {
    html += '<div class="note warning" style="margin-top:15px"><strong>‚ö†Ô∏è Recommendations:</strong><ul style="margin:5px 0 0 20px">';
    recs.forEach(r => html += '<li>' + r + '</li>');
    html += '</ul></div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ Septage receiving within plant capacity and profitable.</div>';
  }
  
  html += '</div>';
  
  document.getElementById('sep_results').innerHTML = html;
  showToast('Septage analysis complete!', 'success');
}

// Calculate maximum septage capacity
function calcSeptageCapacity() {
  var bodLoad = parseFloat(document.getElementById('sep_bod_load').value) || 6000;
  var bodCap = parseFloat(document.getElementById('sep_bod_cap').value) || 8000;
  var sepBod = parseFloat(document.getElementById('sep_bod').value) || 6000;
  
  var availBod = bodCap - bodLoad;
  var maxSeptageVol = (availBod * 1000000) / (sepBod * 8.34);
  var maxTrucks = maxSeptageVol / (parseFloat(document.getElementById('sep_truck').value) || 3000);
  
  var tipFee = parseFloat(document.getElementById('sep_fee').value) || 0.08;
  var maxRevenue = maxSeptageVol * tipFee;
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #a78bfa">';
  html += '<h4 style="margin:0 0 15px 0;color:#a78bfa">üìä Maximum Septage Capacity</h4>';
  
  html += '<table class="table" style="font-size:13px"><tbody>';
  html += '<tr><td>Available BOD Capacity</td><td><span class="result">' + availBod.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Max Septage Volume</td><td><span class="result" style="font-size:16px;color:#84cc16">' + maxSeptageVol.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>gal/day</td></tr>';
  html += '<tr><td>Max Trucks per Day</td><td><span class="result">' + maxTrucks.toFixed(0) + '</span></td><td>trucks</td></tr>';
  html += '<tr><td>Max Daily Revenue</td><td><span class="result" style="color:#4ade80">$' + maxRevenue.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '</tbody></table>';
  
  html += '<div class="note info" style="margin-top:15px">üí° Based on BOD loading capacity. Also consider TSS, TKN, and operational constraints.</div>';
  
  html += '</div>';
  
  document.getElementById('sep_results').innerHTML += html;
}

// Status helpers
function getBodLoadStatus(pct) {
  if (pct <= 70) return { color: '#4ade80', text: 'Good capacity' };
  if (pct <= 85) return { color: '#fbbf24', text: 'Moderate' };
  if (pct <= 100) return { color: '#f97316', text: 'Near capacity' };
  return { color: '#ef4444', text: 'Over capacity' };
}

function getFlowLoadStatus(pct) {
  if (pct <= 80) return { color: '#4ade80', text: 'Good' };
  if (pct <= 95) return { color: '#fbbf24', text: 'Elevated' };
  return { color: '#ef4444', text: 'At/over capacity' };
}

function getSlugStatus(factor) {
  if (factor <= 1.5) return { color: '#4ade80', text: 'Minimal impact' };
  if (factor <= 3) return { color: '#fbbf24', text: 'Moderate slug' };
  return { color: '#ef4444', text: 'High slug risk' };
}

function resetSeptage() {
  document.getElementById('sep_results').innerHTML = '';
  showToast('Septage calculator reset', 'info');
}

// ========== END SEPTAGE RECEIVING CALCULATOR ==========


// ========== BELT PRESS / CENTRIFUGE CALCULATOR ==========

// Update defaults based on equipment type
function updateDewateringDefaults() {
  var type = document.getElementById('dw_type').value;
  var cakePct = document.getElementById('dw_cake_pct');
  var capture = document.getElementById('dw_capture');
  var polyDose = document.getElementById('dw_poly_dose');
  var hydLoad = document.getElementById('dw_hyd_load');
  var solLoad = document.getElementById('dw_sol_load');
  
  var defaults = {
    'bfp': { cake: 22, capture: 95, poly: 12, hydLoad: 75, solLoad: 1000 },
    'centrifuge': { cake: 25, capture: 95, poly: 20, hydLoad: 100, solLoad: 1500 },
    'screw': { cake: 20, capture: 92, poly: 8, hydLoad: 50, solLoad: 600 },
    'plate': { cake: 35, capture: 98, poly: 8, hydLoad: 30, solLoad: 400 }
  };
  
  var d = defaults[type] || defaults.bfp;
  cakePct.value = d.cake;
  capture.value = d.capture;
  polyDose.value = d.poly;
  hydLoad.value = d.hydLoad;
  solLoad.value = d.solLoad;
  
  calcDewatering2();
}

// Update defaults based on sludge type
function updateSludgeDefaults() {
  var sludge = document.getElementById('dw_sludge').value;
  var feedPct = document.getElementById('dw_feed_pct');
  var vsRatio = document.getElementById('dw_vs_ratio');
  var polyDose = document.getElementById('dw_poly_dose');
  var cakePct = document.getElementById('dw_cake_pct');
  
  var defaults = {
    'primary': { feed: 4.5, vs: 0.75, poly: 6, cake: 30 },
    'was': { feed: 4.0, vs: 0.80, poly: 20, cake: 18 },
    'mixed': { feed: 3.5, vs: 0.70, poly: 12, cake: 22 },
    'digested': { feed: 3.0, vs: 0.55, poly: 15, cake: 25 },
    'aerobic': { feed: 2.5, vs: 0.65, poly: 18, cake: 20 }
  };
  
  var d = defaults[sludge] || defaults.mixed;
  feedPct.value = d.feed;
  vsRatio.value = d.vs;
  polyDose.value = d.poly;
  cakePct.value = d.cake;
  
  calcDewatering2();
}

// Main dewatering calculation
function calcDewatering2() {
  // Equipment config
  var equipType = document.getElementById('dw_type').value;
  var units = parseFloat(document.getElementById('dw_units').value) || 2;
  var inService = parseFloat(document.getElementById('dw_service').value) || 1;
  var size = parseFloat(document.getElementById('dw_size').value) || 2.0;
  var opHours = parseFloat(document.getElementById('dw_hours').value) || 8;
  var opDays = parseFloat(document.getElementById('dw_days').value) || 5;
  
  // Feed characteristics
  var feedGPM = parseFloat(document.getElementById('dw_feed_gpm').value) || 150;
  var feedPct = parseFloat(document.getElementById('dw_feed_pct').value) / 100 || 0.035;
  var dailyVol = parseFloat(document.getElementById('dw_daily_vol').value) || 72000;
  var vsRatio = parseFloat(document.getElementById('dw_vs_ratio').value) || 0.70;
  var sg = parseFloat(document.getElementById('dw_sg').value) || 1.02;
  
  // Performance
  var cakePct = parseFloat(document.getElementById('dw_cake_pct').value) / 100 || 0.22;
  var capture = parseFloat(document.getElementById('dw_capture').value) / 100 || 0.95;
  var hydLoad = parseFloat(document.getElementById('dw_hyd_load').value) || 75;
  var solLoad = parseFloat(document.getElementById('dw_sol_load').value) || 1000;
  
  // Polymer
  var polyDose = parseFloat(document.getElementById('dw_poly_dose').value) || 12;
  var polySoln = parseFloat(document.getElementById('dw_poly_soln').value) / 100 || 0.0025;
  var polyCost = parseFloat(document.getElementById('dw_poly_cost').value) || 2.50;
  var washGPM = parseFloat(document.getElementById('dw_wash').value) || 80;
  var elecCost = parseFloat(document.getElementById('dw_elec_cost').value) || 0.10;
  
  // Disposal
  var dispCost = parseFloat(document.getElementById('dw_disp_cost').value) || 50;
  var truckCY = parseFloat(document.getElementById('dw_truck_cy').value) || 20;
  
  // Calculate feed solids
  var feedLbHr = feedGPM * 60 * 8.34 * sg * feedPct; // lb dry solids/hr
  var feedDryTonHr = feedLbHr / 2000;
  
  // Daily processing (based on daily volume)
  var dailySolidsLb = dailyVol * 8.34 * sg * feedPct;
  var dailyDryTon = dailySolidsLb / 2000;
  
  // Required run time
  var reqRunTime = dailySolidsLb / feedLbHr;
  
  // Cake production
  var capturedSolids = feedLbHr * capture;
  var cakeLbHr = capturedSolids / cakePct; // wet cake
  var cakeTonHr = cakeLbHr / 2000;
  
  // Daily cake
  var dailyCakeLb = dailySolidsLb * capture / cakePct;
  var dailyCakeTon = dailyCakeLb / 2000;
  var dailyCakeCY = dailyCakeTon / 0.6; // ~0.6 tons/CY for cake
  
  // Centrate/filtrate
  var centrateSolids = feedLbHr * (1 - capture);
  var centrateTSS = (centrateSolids / (feedGPM * 60 * 8.34)) * 1000000; // mg/L
  
  // Polymer usage
  var polyLbHr = feedDryTonHr * polyDose;
  var polyGPH = polyLbHr / (polySoln * 8.34);
  var dailyPolyLb = dailyDryTon * polyDose;
  var dailyPolyCost = dailyPolyLb * polyCost;
  
  // Loading rates
  var actualHydLoad = feedGPM / (size * inService);
  var actualSolLoad = feedLbHr / (size * inService);
  
  // Energy (equipment-specific)
  var kWhPerDT = { 'bfp': 15, 'centrifuge': 45, 'screw': 10, 'plate': 8 }[equipType] || 15;
  var dailyKWh = dailyDryTon * kWhPerDT;
  var dailyElecCost = dailyKWh * elecCost;
  
  // Wash water
  var dailyWashGal = washGPM * 60 * opHours;
  
  // Disposal
  var dailyDispCost = dailyCakeTon * dispCost;
  var trucksPerDay = dailyCakeCY / truckCY;
  
  // Total daily cost
  var totalDailyCost = dailyPolyCost + dailyElecCost + dailyDispCost;
  var costPerDryTon = totalDailyCost / dailyDryTon;
  var annualCost = totalDailyCost * opDays * 52;
  
  // Status checks
  var hydLoadStatus = getHydLoadStatus(actualHydLoad, hydLoad);
  var solLoadStatus = getSolLoadStatus(actualSolLoad, solLoad);
  var captureStatus = capture >= 0.95 ? { color: '#4ade80', text: 'Excellent' } : (capture >= 0.90 ? { color: '#fbbf24', text: 'Good' } : { color: '#ef4444', text: 'Low' });
  
  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #ec4899">';
  html += '<h4 style="margin:0 0 15px 0;color:#ec4899">üóúÔ∏è Dewatering Analysis Results</h4>';
  
  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Feed Rate</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#ec4899">' + feedLbHr.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">lb DS/hr</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Cake Produced</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">' + dailyCakeTon.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">wet tons/day</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Capture</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + captureStatus.color + '">' + (capture * 100).toFixed(0) + '%</div>';
  html += '<div style="font-size:11px;color:' + captureStatus.color + '">' + captureStatus.text + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Cost</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">$' + costPerDryTon.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/dry ton</div></div>';
  html += '</div>';
  
  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Feed & Production</td></tr>';
  html += '<tr><td>Feed Solids Rate</td><td><span class="result">' + feedLbHr.toFixed(0) + '</span></td><td>lb DS/hr</td></tr>';
  html += '<tr><td>Daily Dry Solids</td><td><span class="result">' + dailyDryTon.toFixed(2) + '</span></td><td>dry tons/day</td></tr>';
  html += '<tr><td>Required Run Time</td><td><span class="result">' + reqRunTime.toFixed(1) + '</span></td><td>hours</td></tr>';
  html += '<tr><td>Cake Production</td><td><span class="result">' + cakeLbHr.toFixed(0) + '</span></td><td>lb wet/hr</td></tr>';
  html += '<tr><td>Daily Cake Volume</td><td><span class="result">' + dailyCakeCY.toFixed(1) + '</span></td><td>cubic yards</td></tr>';
  html += '<tr><td>Trucks per Day</td><td><span class="result">' + trucksPerDay.toFixed(1) + '</span></td><td>trucks</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üìà Loading Rates</td></tr>';
  html += '<tr><td>Hydraulic Loading</td><td><span class="result" style="color:' + hydLoadStatus.color + '">' + actualHydLoad.toFixed(0) + '</span></td><td>GPM/m (' + hydLoadStatus.text + ')</td></tr>';
  html += '<tr><td>Solids Loading</td><td><span class="result" style="color:' + solLoadStatus.color + '">' + actualSolLoad.toFixed(0) + '</span></td><td>lb/hr/m (' + solLoadStatus.text + ')</td></tr>';
  html += '<tr><td>Capture Efficiency</td><td><span class="result" style="color:' + captureStatus.color + '">' + (capture * 100).toFixed(1) + '%</span></td><td>' + captureStatus.text + '</td></tr>';
  html += '<tr><td>Centrate TSS</td><td><span class="result">' + centrateTSS.toFixed(0) + '</span></td><td>mg/L</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">‚öóÔ∏è Polymer Usage</td></tr>';
  html += '<tr><td>Polymer Rate</td><td><span class="result">' + polyLbHr.toFixed(1) + '</span></td><td>lb/hr</td></tr>';
  html += '<tr><td>Polymer Solution</td><td><span class="result">' + polyGPH.toFixed(1) + '</span></td><td>GPH</td></tr>';
  html += '<tr><td>Daily Polymer</td><td><span class="result">' + dailyPolyLb.toFixed(1) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Daily Polymer Cost</td><td><span class="result">$' + dailyPolyCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">üí∞ Operating Costs</td></tr>';
  html += '<tr><td>Polymer Cost</td><td><span class="result">$' + dailyPolyCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Energy Cost</td><td><span class="result">$' + dailyElecCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Disposal Cost</td><td><span class="result">$' + dailyDispCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td><strong>Total Daily Cost</strong></td><td><span class="result" style="font-size:16px;color:#fbbf24">$' + totalDailyCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Cost per Dry Ton</td><td><span class="result">$' + costPerDryTon.toFixed(0) + '</span></td><td>/DT</td></tr>';
  html += '<tr><td>Annual Cost</td><td><span class="result">$' + annualCost.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  
  html += '</tbody></table>';
  
  // Check capacity
  if (reqRunTime > opHours) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Required run time (' + reqRunTime.toFixed(1) + ' hr) exceeds operating hours (' + opHours + ' hr). Consider increasing units in service or extending hours.</div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ Capacity adequate. ' + ((opHours - reqRunTime) / opHours * 100).toFixed(0) + '% reserve capacity available.</div>';
  }
  
  html += '</div>';
  
  document.getElementById('dw2_results').innerHTML = html;
  showToast('Dewatering analysis complete!', 'success');
}

// Compare dewatering equipment
function compareDewateringEquip() {
  var dailyDryTon = parseFloat(document.getElementById('dw_daily_vol').value) * 8.34 * 
    parseFloat(document.getElementById('dw_feed_pct').value) / 100 / 2000 || 3;
  var polyCost = parseFloat(document.getElementById('dw_poly_cost').value) || 2.50;
  var elecCost = parseFloat(document.getElementById('dw_elec_cost').value) || 0.10;
  var dispCost = parseFloat(document.getElementById('dw_disp_cost').value) || 50;
  
  var equipment = [
    { name: 'Belt Filter Press', cake: 22, poly: 12, energy: 15, capture: 95, capital: 'Medium' },
    { name: 'Centrifuge', cake: 25, poly: 20, energy: 45, capture: 95, capital: 'High' },
    { name: 'Screw Press', cake: 20, poly: 8, energy: 10, capture: 92, capital: 'Low' },
    { name: 'Plate & Frame', cake: 35, poly: 8, energy: 8, capture: 98, capital: 'Medium' }
  ];
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #a78bfa">';
  html += '<h4 style="margin:0 0 15px 0;color:#a78bfa">üìä Equipment Comparison</h4>';
  
  html += '<table class="table" style="font-size:12px">';
  html += '<thead><tr><th>Parameter</th>';
  equipment.forEach(e => html += '<th>' + e.name.split(' ')[0] + '</th>');
  html += '</tr></thead><tbody>';
  
  html += '<tr><td>Cake Solids (%)</td>';
  equipment.forEach(e => html += '<td>' + e.cake + '%</td>');
  html += '</tr>';
  
  html += '<tr><td>Capture (%)</td>';
  equipment.forEach(e => html += '<td>' + e.capture + '%</td>');
  html += '</tr>';
  
  html += '<tr><td>Polymer (lb/DT)</td>';
  equipment.forEach(e => html += '<td>' + e.poly + '</td>');
  html += '</tr>';
  
  html += '<tr><td>Energy (kWh/DT)</td>';
  equipment.forEach(e => html += '<td>' + e.energy + '</td>');
  html += '</tr>';
  
  // Calculate costs
  var costs = equipment.map(e => {
    var wetCake = dailyDryTon * (e.capture/100) / (e.cake/100);
    var polyCostDay = dailyDryTon * e.poly * polyCost;
    var energyCostDay = dailyDryTon * e.energy * elecCost;
    var dispCostDay = wetCake * dispCost;
    return polyCostDay + energyCostDay + dispCostDay;
  });
  
  var minCost = Math.min(...costs);
  html += '<tr style="background:#243b55"><td><strong>Daily Cost</strong></td>';
  costs.forEach((c, i) => {
    var highlight = c === minCost ? 'color:#4ade80;font-weight:bold' : '';
    html += '<td style="' + highlight + '">$' + c.toFixed(0) + (c === minCost ? ' ‚úì' : '') + '</td>';
  });
  html += '</tr>';
  
  html += '<tr><td>Capital Cost</td>';
  equipment.forEach(e => html += '<td>' + e.capital + '</td>');
  html += '</tr>';
  
  html += '</tbody></table>';
  
  html += '</div>';
  
  document.getElementById('dw2_results').innerHTML += html;
}

// Optimize polymer dose
function optimizePolymer() {
  var currentDose = parseFloat(document.getElementById('dw_poly_dose').value) || 12;
  var sludgeType = document.getElementById('dw_sludge').value;
  
  var optimalRange = {
    'primary': { min: 3, max: 8, optimal: 5 },
    'was': { min: 15, max: 25, optimal: 18 },
    'mixed': { min: 8, max: 15, optimal: 12 },
    'digested': { min: 10, max: 18, optimal: 14 },
    'aerobic': { min: 12, max: 22, optimal: 16 }
  }[sludgeType] || { min: 8, max: 15, optimal: 12 };
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #4ade80">';
  html += '<h4 style="margin:0 0 15px 0;color:#4ade80">‚öóÔ∏è Polymer Optimization</h4>';
  
  html += '<table class="table" style="font-size:13px"><tbody>';
  html += '<tr><td>Current Dose</td><td><span class="result">' + currentDose + '</span></td><td>lb/DT</td></tr>';
  html += '<tr><td>Optimal Range</td><td><span class="result">' + optimalRange.min + ' - ' + optimalRange.max + '</span></td><td>lb/DT</td></tr>';
  html += '<tr><td>Recommended</td><td><span class="result" style="color:#4ade80">' + optimalRange.optimal + '</span></td><td>lb/DT</td></tr>';
  html += '</tbody></table>';
  
  if (currentDose < optimalRange.min) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Dose below optimal range - may have poor capture and high centrate TSS.</div>';
  } else if (currentDose > optimalRange.max) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Dose above optimal range - may be overdosing. Consider jar testing.</div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ Dose within optimal range for ' + sludgeType.replace('_', ' ') + ' sludge.</div>';
  }
  
  html += '</div>';
  
  document.getElementById('dw2_results').innerHTML += html;
}

// Status helpers
function getHydLoadStatus(actual, target) {
  var ratio = actual / target;
  if (ratio <= 0.8) return { color: '#4ade80', text: 'Good' };
  if (ratio <= 1.0) return { color: '#fbbf24', text: 'At limit' };
  return { color: '#ef4444', text: 'Over limit' };
}

function getSolLoadStatus(actual, target) {
  var ratio = actual / target;
  if (ratio <= 0.8) return { color: '#4ade80', text: 'Good' };
  if (ratio <= 1.0) return { color: '#fbbf24', text: 'At limit' };
  return { color: '#ef4444', text: 'Over limit' };
}

function resetDewatering2() {
  document.getElementById('dw2_results').innerHTML = '';
  showToast('Dewatering calculator reset', 'info');
}

// ========== END BELT PRESS / CENTRIFUGE CALCULATOR ==========


// ========== SLUDGE BOX (DRY) HAUL CALCULATOR ==========

// Update box defaults based on type
function updateBoxDefaults() {
  var type = document.getElementById('sb_box_type').value;
  var boxCY = document.getElementById('sb_box_cy');
  var weightLimit = document.getElementById('sb_weight_limit');
  
  var defaults = {
    '20cy': { cy: 20, weight: 18 },
    '30cy': { cy: 30, weight: 20 },
    '40cy': { cy: 40, weight: 22 },
    'lugger': { cy: 12, weight: 10 },
    'custom': { cy: 30, weight: 20 }
  };
  
  var d = defaults[type] || defaults['30cy'];
  boxCY.value = d.cy;
  weightLimit.value = d.weight;
  
  calcSludgeBox();
}

// Main sludge box calculation
function calcSludgeBox() {
  // Cake production
  var cakePerDay = parseFloat(document.getElementById('sb_cake_day').value) || 5;
  var cakeUnit = document.getElementById('sb_cake_unit').value;
  var cakePct = parseFloat(document.getElementById('sb_cake_pct').value) / 100 || 0.22;
  var density = parseFloat(document.getElementById('sb_density').value) || 1200;
  var opDays = parseFloat(document.getElementById('sb_op_days').value) || 5;
  var storageDays = parseFloat(document.getElementById('sb_storage_days').value) || 3;
  
  // Box configuration
  var boxCY = parseFloat(document.getElementById('sb_box_cy').value) || 30;
  var fillPct = parseFloat(document.getElementById('sb_fill_pct').value) / 100 || 0.85;
  var numBoxes = parseFloat(document.getElementById('sb_num_boxes').value) || 2;
  var weightLimit = parseFloat(document.getElementById('sb_weight_limit').value) || 20;
  
  // Costs
  var haulCost = parseFloat(document.getElementById('sb_haul_cost').value) || 350;
  var dispTon = parseFloat(document.getElementById('sb_disp_ton').value) || 45;
  var rental = parseFloat(document.getElementById('sb_rental').value) || 150;
  var fuelPct = parseFloat(document.getElementById('sb_fuel').value) / 100 || 0.10;
  var envFee = parseFloat(document.getElementById('sb_env_fee').value) || 15;
  
  // Convert cake production to standard units (wet tons/day and cy/day)
  var wetTonsDay, cyDay, dryTonsDay;
  
  switch(cakeUnit) {
    case 'wetton':
      wetTonsDay = cakePerDay;
      cyDay = (cakePerDay * 2000) / density;
      dryTonsDay = cakePerDay * cakePct;
      break;
    case 'dryton':
      dryTonsDay = cakePerDay;
      wetTonsDay = cakePerDay / cakePct;
      cyDay = (wetTonsDay * 2000) / density;
      break;
    case 'cy':
      cyDay = cakePerDay;
      wetTonsDay = (cakePerDay * density) / 2000;
      dryTonsDay = wetTonsDay * cakePct;
      break;
    case 'lb':
      wetTonsDay = cakePerDay / 2000;
      cyDay = cakePerDay / density;
      dryTonsDay = wetTonsDay * cakePct;
      break;
  }
  
  // Weekly production
  var wetTonsWeek = wetTonsDay * opDays;
  var cyWeek = cyDay * opDays;
  
  // Usable box capacity
  var usableCY = boxCY * fillPct;
  var usableWeight = weightLimit; // tons
  
  // Determine limiting factor
  var weightPerCY = density / 2000; // tons per cy
  var cyAtWeightLimit = usableWeight / weightPerCY;
  
  var limitingFactor, effectiveCY;
  if (usableCY <= cyAtWeightLimit) {
    limitingFactor = 'Volume';
    effectiveCY = usableCY;
  } else {
    limitingFactor = 'Weight';
    effectiveCY = cyAtWeightLimit;
  }
  
  var effectiveTons = effectiveCY * weightPerCY;
  
  // Days to fill one box
  var daysToFill = effectiveCY / cyDay;
  
  // Hauls per week
  var haulsPerWeek = opDays / daysToFill;
  var haulsPerMonth = haulsPerWeek * 4.33;
  var haulsPerYear = haulsPerWeek * 52;
  
  // Storage capacity
  var totalStorageCY = usableCY * numBoxes;
  var storageCapDays = totalStorageCY / cyDay;
  var storageOK = storageCapDays >= storageDays;
  
  // Cost calculations
  var costPerHaul = haulCost * (1 + fuelPct) + envFee;
  var dispCostPerHaul = effectiveTons * dispTon;
  var totalPerHaul = costPerHaul + dispCostPerHaul;
  
  var weeklyHaulCost = haulsPerWeek * totalPerHaul;
  var monthlyHaulCost = haulsPerMonth * totalPerHaul;
  var monthlyRental = rental * numBoxes;
  var monthlyTotal = monthlyHaulCost + monthlyRental;
  var annualTotal = monthlyTotal * 12;
  
  // Cost per ton metrics
  var costPerWetTon = monthlyTotal / (wetTonsWeek * 4.33);
  var costPerDryTon = monthlyTotal / (dryTonsDay * opDays * 4.33);
  var costPerCY = monthlyTotal / (cyWeek * 4.33);
  
  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #78716c">';
  html += '<h4 style="margin:0 0 15px 0;color:#a8a29e">üì¶ Sludge Box Hauling Analysis</h4>';
  
  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Hauls/Week</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#78716c">' + haulsPerWeek.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">pulls</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Days to Fill</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + daysToFill.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">days/box</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Monthly Cost</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">$' + (monthlyTotal/1000).toFixed(1) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/month</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Cost/Wet Ton</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#a78bfa">$' + costPerWetTon.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/wet ton</div></div>';
  html += '</div>';
  
  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Production Summary</td></tr>';
  html += '<tr><td>Daily Cake (wet)</td><td><span class="result">' + wetTonsDay.toFixed(2) + '</span></td><td>wet tons/day</td></tr>';
  html += '<tr><td>Daily Cake (dry)</td><td><span class="result">' + dryTonsDay.toFixed(2) + '</span></td><td>dry tons/day</td></tr>';
  html += '<tr><td>Daily Volume</td><td><span class="result">' + cyDay.toFixed(1) + '</span></td><td>cy/day</td></tr>';
  html += '<tr><td>Weekly Volume</td><td><span class="result">' + cyWeek.toFixed(1) + '</span></td><td>cy/week</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">üì¶ Box Capacity</td></tr>';
  html += '<tr><td>Box Size</td><td><span class="result">' + boxCY + '</span></td><td>cy</td></tr>';
  html += '<tr><td>Usable Volume (' + (fillPct*100) + '%)</td><td><span class="result">' + usableCY.toFixed(1) + '</span></td><td>cy</td></tr>';
  html += '<tr><td>Weight Limit</td><td><span class="result">' + weightLimit + '</span></td><td>tons</td></tr>';
  html += '<tr><td>Limiting Factor</td><td colspan="2"><span class="result" style="color:#fbbf24">' + limitingFactor + '</span> (effective: ' + effectiveCY.toFixed(1) + ' cy / ' + effectiveTons.toFixed(1) + ' tons)</td></tr>';
  html += '<tr><td>Days to Fill Box</td><td><span class="result">' + daysToFill.toFixed(2) + '</span></td><td>days</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üöõ Hauling Frequency</td></tr>';
  html += '<tr><td>Hauls per Week</td><td><span class="result">' + haulsPerWeek.toFixed(2) + '</span></td><td>pulls/week</td></tr>';
  html += '<tr><td>Hauls per Month</td><td><span class="result">' + haulsPerMonth.toFixed(1) + '</span></td><td>pulls/month</td></tr>';
  html += '<tr><td>Hauls per Year</td><td><span class="result">' + haulsPerYear.toFixed(0) + '</span></td><td>pulls/year</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">üè™ Storage Capacity</td></tr>';
  html += '<tr><td>On-Site Boxes</td><td><span class="result">' + numBoxes + '</span></td><td>boxes</td></tr>';
  html += '<tr><td>Total Storage</td><td><span class="result">' + totalStorageCY.toFixed(1) + '</span></td><td>cy</td></tr>';
  html += '<tr><td>Storage Capacity</td><td><span class="result" style="color:' + (storageOK ? '#4ade80' : '#ef4444') + '">' + storageCapDays.toFixed(1) + '</span></td><td>days</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#ef4444">üí∞ Cost Breakdown</td></tr>';
  html += '<tr><td>Haul + Fuel + Env Fee</td><td><span class="result">$' + costPerHaul.toFixed(0) + '</span></td><td>/haul</td></tr>';
  html += '<tr><td>Disposal Fee</td><td><span class="result">$' + dispCostPerHaul.toFixed(0) + '</span></td><td>/haul</td></tr>';
  html += '<tr><td>Total per Haul</td><td><span class="result">$' + totalPerHaul.toFixed(0) + '</span></td><td>/haul</td></tr>';
  html += '<tr><td>Monthly Hauling</td><td><span class="result">$' + monthlyHaulCost.toFixed(0) + '</span></td><td>/month</td></tr>';
  html += '<tr><td>Monthly Rental</td><td><span class="result">$' + monthlyRental.toFixed(0) + '</span></td><td>/month</td></tr>';
  html += '<tr><td><strong>Monthly Total</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + monthlyTotal.toFixed(0) + '</span></td><td>/month</td></tr>';
  html += '<tr><td>Annual Total</td><td><span class="result">$' + annualTotal.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Cost per Wet Ton</td><td><span class="result">$' + costPerWetTon.toFixed(2) + '</span></td><td>/wet ton</td></tr>';
  html += '<tr><td>Cost per Dry Ton</td><td><span class="result">$' + costPerDryTon.toFixed(2) + '</span></td><td>/dry ton</td></tr>';
  
  html += '</tbody></table>';
  
  // Storage warning
  if (!storageOK) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Storage capacity (' + storageCapDays.toFixed(1) + ' days) is less than required (' + storageDays + ' days). Consider adding boxes or increasing haul frequency.</div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ Storage capacity adequate for ' + storageCapDays.toFixed(1) + ' days of production.</div>';
  }
  
  html += '</div>';
  
  document.getElementById('sb_results').innerHTML = html;
  showToast('Sludge box calculation complete!', 'success');
}

// Calculate weekly schedule
function calcBoxSchedule() {
  var cakePerDay = parseFloat(document.getElementById('sb_cake_day').value) || 5;
  var cakeUnit = document.getElementById('sb_cake_unit').value;
  var density = parseFloat(document.getElementById('sb_density').value) || 1200;
  var opDays = parseFloat(document.getElementById('sb_op_days').value) || 5;
  var boxCY = parseFloat(document.getElementById('sb_box_cy').value) || 30;
  var fillPct = parseFloat(document.getElementById('sb_fill_pct').value) / 100 || 0.85;
  var numBoxes = parseFloat(document.getElementById('sb_num_boxes').value) || 2;
  
  // Convert to cy/day
  var cyDay;
  if (cakeUnit === 'wetton') cyDay = (cakePerDay * 2000) / density;
  else if (cakeUnit === 'cy') cyDay = cakePerDay;
  else cyDay = (cakePerDay * 2000) / density;
  
  var usableCY = boxCY * fillPct;
  
  // Simulate a week
  var days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  var boxLevels = new Array(numBoxes).fill(0);
  var schedule = [];
  var activeBox = 0;
  
  for (var d = 0; d < 7; d++) {
    var dayName = days[d];
    var producing = d < opDays;
    var hauls = [];
    
    if (producing) {
      boxLevels[activeBox] += cyDay;
      
      // Check if box needs hauling
      if (boxLevels[activeBox] >= usableCY) {
        hauls.push('Box ' + (activeBox + 1));
        boxLevels[activeBox] = 0;
        activeBox = (activeBox + 1) % numBoxes;
      }
    }
    
    schedule.push({
      day: dayName,
      producing: producing,
      levels: boxLevels.slice(),
      hauls: hauls
    });
  }
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #60a5fa">';
  html += '<h4 style="margin:0 0 15px 0;color:#60a5fa">üìÖ Weekly Hauling Schedule</h4>';
  
  html += '<table class="table" style="font-size:12px">';
  html += '<thead><tr><th>Day</th><th>Production</th>';
  for (var b = 0; b < numBoxes; b++) {
    html += '<th>Box ' + (b + 1) + '</th>';
  }
  html += '<th>Haul</th></tr></thead><tbody>';
  
  schedule.forEach(function(s) {
    html += '<tr>';
    html += '<td><strong>' + s.day + '</strong></td>';
    html += '<td>' + (s.producing ? '‚úì ' + cyDay.toFixed(1) + ' cy' : '-') + '</td>';
    s.levels.forEach(function(level, i) {
      var pct = (level / usableCY) * 100;
      var color = pct > 80 ? '#ef4444' : (pct > 50 ? '#fbbf24' : '#4ade80');
      html += '<td><span style="color:' + color + '">' + pct.toFixed(0) + '%</span></td>';
    });
    html += '<td>' + (s.hauls.length > 0 ? 'üöõ ' + s.hauls.join(', ') : '-') + '</td>';
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  html += '<div style="margin-top:10px;font-size:12px;color:#94a3b8">Note: This is a simplified simulation. Actual schedule may vary based on hauler availability.</div>';
  html += '</div>';
  
  document.getElementById('sb_schedule').innerHTML = html;
}

// Optimize box size
function optimizeBoxSize() {
  var cakePerDay = parseFloat(document.getElementById('sb_cake_day').value) || 5;
  var density = parseFloat(document.getElementById('sb_density').value) || 1200;
  var opDays = parseFloat(document.getElementById('sb_op_days').value) || 5;
  var haulCost = parseFloat(document.getElementById('sb_haul_cost').value) || 350;
  var dispTon = parseFloat(document.getElementById('sb_disp_ton').value) || 45;
  
  // Convert to cy/day (assume wet tons)
  var cyDay = (cakePerDay * 2000) / density;
  var cyWeek = cyDay * opDays;
  
  var boxSizes = [
    { name: 'Lugger (12 CY)', cy: 12, rental: 100 },
    { name: '20 CY Roll-off', cy: 20, rental: 125 },
    { name: '30 CY Roll-off', cy: 30, rental: 150 },
    { name: '40 CY Roll-off', cy: 40, rental: 175 }
  ];
  
  var results = boxSizes.map(function(box) {
    var usable = box.cy * 0.85;
    var haulsWeek = cyWeek / usable;
    var weightPerHaul = (usable * density) / 2000;
    var costPerHaul = haulCost * 1.1 + 15 + (weightPerHaul * dispTon);
    var weeklyTotal = (haulsWeek * costPerHaul) + (box.rental / 4.33);
    return { ...box, haulsWeek, costPerHaul, weeklyTotal };
  });
  
  var minCost = Math.min(...results.map(r => r.weeklyTotal));
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #4ade80">';
  html += '<h4 style="margin:0 0 15px 0;color:#4ade80">üìä Box Size Optimization</h4>';
  
  html += '<table class="table" style="font-size:12px">';
  html += '<thead><tr><th>Box Size</th><th>Hauls/Week</th><th>Cost/Haul</th><th>Weekly Cost</th></tr></thead>';
  html += '<tbody>';
  
  results.forEach(function(r) {
    var best = r.weeklyTotal === minCost;
    html += '<tr' + (best ? ' style="background:rgba(74,222,128,0.2)"' : '') + '>';
    html += '<td>' + r.name + (best ? ' ‚úì' : '') + '</td>';
    html += '<td>' + r.haulsWeek.toFixed(2) + '</td>';
    html += '<td>$' + r.costPerHaul.toFixed(0) + '</td>';
    html += '<td style="' + (best ? 'color:#4ade80;font-weight:bold' : '') + '">$' + r.weeklyTotal.toFixed(0) + '</td>';
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  
  var bestOption = results.find(r => r.weeklyTotal === minCost);
  html += '<div class="note info" style="margin-top:15px">üí° <strong>Recommendation:</strong> ' + bestOption.name + ' offers the lowest weekly cost at $' + bestOption.weeklyTotal.toFixed(0) + '/week.</div>';
  
  html += '</div>';
  
  document.getElementById('sb_schedule').innerHTML = html;
}

function resetSludgeBox() {
  document.getElementById('sb_results').innerHTML = '';
  document.getElementById('sb_schedule').innerHTML = '';
  showToast('Sludge box calculator reset', 'info');
}

// ========== END SLUDGE BOX CALCULATOR ==========


// ========== PUMP STATION CALCULATOR ==========

function calcPumpStation() {
  // Design flows
  var avgFlow = parseFloat(document.getElementById('ps_avg_flow').value) || 1.0;
  var peakFlow = parseFloat(document.getElementById('ps_peak_flow').value) || 2.5;
  var minFlow = parseFloat(document.getElementById('ps_min_flow').value) || 0.3;
  var designLife = parseFloat(document.getElementById('ps_life').value) || 20;
  var growth = parseFloat(document.getElementById('ps_growth').value) / 100 || 0.02;
  
  // Wet well
  var shape = document.getElementById('ps_shape').value;
  var dim1 = parseFloat(document.getElementById('ps_dim1').value) || 10;
  var dim2 = parseFloat(document.getElementById('ps_dim2').value) || 8;
  var leadOn = parseFloat(document.getElementById('ps_lead_on').value) || 6;
  var leadOff = parseFloat(document.getElementById('ps_lead_off').value) || 3;
  var lagOn = parseFloat(document.getElementById('ps_lag_on').value) || 8;
  var hla = parseFloat(document.getElementById('ps_hla').value) || 10;
  
  // Pumps
  var numPumps = parseInt(document.getElementById('ps_num_pumps').value) || 2;
  var pumpGPM = parseFloat(document.getElementById('ps_pump_gpm').value) || 700;
  var tdh = parseFloat(document.getElementById('ps_tdh').value) || 45;
  var pumpEff = parseFloat(document.getElementById('ps_eff').value) / 100 || 0.70;
  var motorEff = parseFloat(document.getElementById('ps_motor_eff').value) / 100 || 0.92;
  
  // Energy
  var elecCost = parseFloat(document.getElementById('ps_elec').value) || 0.10;
  var demandCharge = parseFloat(document.getElementById('ps_demand').value) || 12;
  var hasVFD = document.getElementById('ps_vfd').value === 'yes';
  
  // Calculate wet well volume
  var wwArea, wwVolPerFt;
  if (shape === 'circular') {
    wwArea = Math.PI * Math.pow(dim1/2, 2);
  } else {
    wwArea = dim1 * dim2;
  }
  wwVolPerFt = wwArea * 7.48; // gal/ft
  
  // Active storage volume (between lead on and lead off)
  var activeDepth = leadOn - leadOff;
  var activeVolume = activeDepth * wwVolPerFt;
  
  // Future design flow
  var futureAvg = avgFlow * Math.pow(1 + growth, designLife);
  var futurePeak = peakFlow * Math.pow(1 + growth, designLife);
  
  // Convert flows to GPM
  var avgGPM = avgFlow * 1000000 / 1440;
  var peakGPM = peakFlow * 1000000 / 1440;
  var minGPM = minFlow * 1000000 / 1440;
  
  // Firm capacity (N-1 pumps)
  var firmCapacity = pumpGPM * (numPumps - 1);
  var firmCapacityMGD = firmCapacity * 1440 / 1000000;
  var capacityOK = firmCapacity >= peakGPM;
  
  // Cycle time calculation (at average flow)
  var fillTime = activeVolume / avgGPM; // min to fill
  var pumpDownTime = activeVolume / (pumpGPM - avgGPM); // min to pump down
  var cycleTime = fillTime + pumpDownTime;
  var startsPerHour = 60 / cycleTime;
  
  // Detention time at min flow
  var totalWWVol = hla * wwVolPerFt;
  var detentionTime = totalWWVol / minGPM;
  
  // Horsepower calculation
  var whp = (pumpGPM * tdh) / 3960; // Water HP
  var bhp = whp / pumpEff; // Brake HP
  var motorHP = Math.ceil(bhp / 0.9 / 5) * 5; // Next standard size, 90% service factor
  var kW = (bhp * 0.746) / motorEff;
  
  // Energy costs
  var runHoursDay = (avgFlow * 1000000) / (pumpGPM * 60);
  var dailyKWh = kW * runHoursDay;
  var monthlyKWh = dailyKWh * 30;
  var monthlyEnergy = monthlyKWh * elecCost;
  var monthlyDemand = kW * demandCharge;
  var monthlyTotal = monthlyEnergy + monthlyDemand;
  var annualCost = monthlyTotal * 12;
  
  // Status checks
  var cycleStatus = getCycleStatus(cycleTime);
  var startsStatus = getStartsStatus(startsPerHour);
  var detentionStatus = getDetentionStatus(detentionTime);
  
  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #14b8a6">';
  html += '<h4 style="margin:0 0 15px 0;color:#14b8a6">üîÑ Pump Station Analysis</h4>';
  
  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Cycle Time</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + cycleStatus.color + '">' + cycleTime.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:' + cycleStatus.color + '">min (' + cycleStatus.text + ')</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Starts/Hour</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + startsStatus.color + '">' + startsPerHour.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:' + startsStatus.color + '">' + startsStatus.text + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Motor Size</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + motorHP + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">HP each</div></div>';
  html += '<div style="background:' + (capacityOK ? '#065f46' : '#7f1d1d') + ';padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;opacity:0.8">Firm Capacity</div>';
  html += '<div style="font-size:18px;font-weight:bold">' + (capacityOK ? '‚úì OK' : '‚ö†Ô∏è LOW') + '</div>';
  html += '<div style="font-size:11px;opacity:0.8">' + firmCapacityMGD.toFixed(2) + ' MGD</div></div>';
  html += '</div>';
  
  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Design Flows</td></tr>';
  html += '<tr><td>Average Flow</td><td><span class="result">' + avgFlow.toFixed(2) + '</span></td><td>MGD (' + avgGPM.toFixed(0) + ' GPM)</td></tr>';
  html += '<tr><td>Peak Flow</td><td><span class="result">' + peakFlow.toFixed(2) + '</span></td><td>MGD (' + peakGPM.toFixed(0) + ' GPM)</td></tr>';
  html += '<tr><td>Future Peak (' + designLife + ' yr)</td><td><span class="result">' + futurePeak.toFixed(2) + '</span></td><td>MGD</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">ü™£ Wet Well</td></tr>';
  html += '<tr><td>Surface Area</td><td><span class="result">' + wwArea.toFixed(1) + '</span></td><td>sq ft</td></tr>';
  html += '<tr><td>Volume per Foot</td><td><span class="result">' + wwVolPerFt.toFixed(0) + '</span></td><td>gal/ft</td></tr>';
  html += '<tr><td>Active Storage</td><td><span class="result">' + activeVolume.toFixed(0) + '</span></td><td>gallons</td></tr>';
  html += '<tr><td>Total Volume</td><td><span class="result">' + totalWWVol.toFixed(0) + '</span></td><td>gallons</td></tr>';
  html += '<tr><td>Detention Time (min flow)</td><td><span class="result" style="color:' + detentionStatus.color + '">' + detentionTime.toFixed(1) + '</span></td><td>min (' + detentionStatus.text + ')</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#14b8a6">‚öôÔ∏è Pump Performance</td></tr>';
  html += '<tr><td>Each Pump Capacity</td><td><span class="result">' + pumpGPM + '</span></td><td>GPM</td></tr>';
  html += '<tr><td>Firm Capacity (N-1)</td><td><span class="result">' + firmCapacity + '</span></td><td>GPM (' + firmCapacityMGD.toFixed(2) + ' MGD)</td></tr>';
  html += '<tr><td>Water Horsepower</td><td><span class="result">' + whp.toFixed(1) + '</span></td><td>WHP</td></tr>';
  html += '<tr><td>Brake Horsepower</td><td><span class="result">' + bhp.toFixed(1) + '</span></td><td>BHP</td></tr>';
  html += '<tr><td>Motor Size (each)</td><td><span class="result">' + motorHP + '</span></td><td>HP</td></tr>';
  html += '<tr><td>Power Draw</td><td><span class="result">' + kW.toFixed(1) + '</span></td><td>kW</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üí∞ Energy Costs</td></tr>';
  html += '<tr><td>Daily Run Time</td><td><span class="result">' + runHoursDay.toFixed(1) + '</span></td><td>hours</td></tr>';
  html += '<tr><td>Monthly Energy</td><td><span class="result">' + monthlyKWh.toFixed(0) + '</span></td><td>kWh</td></tr>';
  html += '<tr><td>Monthly Energy Cost</td><td><span class="result">$' + monthlyEnergy.toFixed(0) + '</span></td><td></td></tr>';
  html += '<tr><td>Monthly Demand Cost</td><td><span class="result">$' + monthlyDemand.toFixed(0) + '</span></td><td></td></tr>';
  html += '<tr><td><strong>Annual Cost</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + annualCost.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  
  html += '</tbody></table>';
  html += '</div>';
  
  document.getElementById('ps_results').innerHTML = html;
  showToast('Pump station analysis complete!', 'success');
}

function calcCycleTime() {
  var avgFlow = parseFloat(document.getElementById('ps_avg_flow').value) || 1.0;
  var pumpGPM = parseFloat(document.getElementById('ps_pump_gpm').value) || 700;
  var shape = document.getElementById('ps_shape').value;
  var dim1 = parseFloat(document.getElementById('ps_dim1').value) || 10;
  var dim2 = parseFloat(document.getElementById('ps_dim2').value) || 8;
  var leadOn = parseFloat(document.getElementById('ps_lead_on').value) || 6;
  var leadOff = parseFloat(document.getElementById('ps_lead_off').value) || 3;
  
  var wwArea = shape === 'circular' ? Math.PI * Math.pow(dim1/2, 2) : dim1 * dim2;
  var wwVolPerFt = wwArea * 7.48;
  var activeDepth = leadOn - leadOff;
  var activeVolume = activeDepth * wwVolPerFt;
  
  // Cycle times at different flow rates
  var flows = [0.25, 0.5, 0.75, 1.0, 1.25, 1.5].map(f => f * avgFlow);
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #60a5fa;margin-top:15px">';
  html += '<h4 style="margin:0 0 15px 0;color:#60a5fa">‚è±Ô∏è Cycle Time Analysis</h4>';
  
  html += '<table class="table" style="font-size:12px">';
  html += '<thead><tr><th>Flow (MGD)</th><th>Flow (GPM)</th><th>Fill Time</th><th>Pump Time</th><th>Cycle</th><th>Starts/hr</th></tr></thead>';
  html += '<tbody>';
  
  flows.forEach(function(f) {
    var gpm = f * 1000000 / 1440;
    if (gpm >= pumpGPM) return; // Skip if flow exceeds pump capacity
    var fillTime = activeVolume / gpm;
    var pumpTime = activeVolume / (pumpGPM - gpm);
    var cycle = fillTime + pumpTime;
    var starts = 60 / cycle;
    var color = cycle < 5 ? '#ef4444' : (cycle < 10 ? '#fbbf24' : '#4ade80');
    html += '<tr>';
    html += '<td>' + f.toFixed(2) + '</td>';
    html += '<td>' + gpm.toFixed(0) + '</td>';
    html += '<td>' + fillTime.toFixed(1) + ' min</td>';
    html += '<td>' + pumpTime.toFixed(1) + ' min</td>';
    html += '<td style="color:' + color + '">' + cycle.toFixed(1) + ' min</td>';
    html += '<td>' + starts.toFixed(1) + '</td>';
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  html += '<div class="note info" style="margin-top:10px">üí° Minimum recommended cycle time: 5-10 minutes. Max 6-12 starts/hour.</div>';
  html += '</div>';
  
  document.getElementById('ps_results').innerHTML += html;
}

function calcVFDSavings() {
  var avgFlow = parseFloat(document.getElementById('ps_avg_flow').value) || 1.0;
  var pumpGPM = parseFloat(document.getElementById('ps_pump_gpm').value) || 700;
  var tdh = parseFloat(document.getElementById('ps_tdh').value) || 45;
  var pumpEff = parseFloat(document.getElementById('ps_eff').value) / 100 || 0.70;
  var motorEff = parseFloat(document.getElementById('ps_motor_eff').value) / 100 || 0.92;
  var elecCost = parseFloat(document.getElementById('ps_elec').value) || 0.10;
  
  var avgGPM = avgFlow * 1000000 / 1440;
  var runHoursDay = (avgFlow * 1000000) / (pumpGPM * 60);
  
  // Constant speed (full power when running)
  var bhpFull = (pumpGPM * tdh) / (3960 * pumpEff);
  var kWFull = (bhpFull * 0.746) / motorEff;
  var annualKWhCS = kWFull * runHoursDay * 365;
  var annualCostCS = annualKWhCS * elecCost;
  
  // VFD (affinity laws - power varies with cube of speed)
  var speedRatio = avgGPM / pumpGPM;
  var powerRatio = Math.pow(speedRatio, 3);
  var kWVFD = kWFull * powerRatio;
  var runHoursVFD = 24; // Runs continuously at reduced speed
  var annualKWhVFD = kWVFD * runHoursVFD * 365;
  var annualCostVFD = annualKWhVFD * elecCost;
  
  var savings = annualCostCS - annualCostVFD;
  var savingsPct = (savings / annualCostCS) * 100;
  
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #4ade80;margin-top:15px">';
  html += '<h4 style="margin:0 0 15px 0;color:#4ade80">üí° VFD Energy Savings Analysis</h4>';
  
  html += '<table class="table" style="font-size:13px">';
  html += '<thead><tr><th>Parameter</th><th>Constant Speed</th><th>VFD</th></tr></thead>';
  html += '<tbody>';
  html += '<tr><td>Operating Speed</td><td>100%</td><td>' + (speedRatio * 100).toFixed(0) + '%</td></tr>';
  html += '<tr><td>Power Draw (kW)</td><td>' + kWFull.toFixed(1) + '</td><td>' + kWVFD.toFixed(1) + '</td></tr>';
  html += '<tr><td>Run Hours/Day</td><td>' + runHoursDay.toFixed(1) + '</td><td>24 (continuous)</td></tr>';
  html += '<tr><td>Annual kWh</td><td>' + annualKWhCS.toLocaleString(undefined,{maximumFractionDigits:0}) + '</td><td>' + annualKWhVFD.toLocaleString(undefined,{maximumFractionDigits:0}) + '</td></tr>';
  html += '<tr><td>Annual Cost</td><td>$' + annualCostCS.toLocaleString(undefined,{maximumFractionDigits:0}) + '</td><td>$' + annualCostVFD.toLocaleString(undefined,{maximumFractionDigits:0}) + '</td></tr>';
  html += '<tr style="background:#065f46"><td><strong>Annual Savings</strong></td><td colspan="2" style="text-align:center;font-size:18px;color:#4ade80"><strong>$' + savings.toLocaleString(undefined,{maximumFractionDigits:0}) + ' (' + savingsPct.toFixed(0) + '%)</strong></td></tr>';
  html += '</tbody></table>';
  
  html += '<div class="note info" style="margin-top:10px">üí° Affinity Laws: Power ‚àù Speed¬≥. Reducing speed by 50% reduces power by 87.5%!</div>';
  html += '</div>';
  
  document.getElementById('ps_results').innerHTML += html;
}

function getCycleStatus(ct) {
  if (ct >= 10) return { color: '#4ade80', text: 'Good' };
  if (ct >= 5) return { color: '#fbbf24', text: 'Acceptable' };
  return { color: '#ef4444', text: 'Too short' };
}

function getStartsStatus(sph) {
  if (sph <= 6) return { color: '#4ade80', text: 'Good' };
  if (sph <= 12) return { color: '#fbbf24', text: 'Acceptable' };
  return { color: '#ef4444', text: 'Too many' };
}

function getDetentionStatus(dt) {
  if (dt <= 20) return { color: '#4ade80', text: 'Good' };
  if (dt <= 30) return { color: '#fbbf24', text: 'OK' };
  return { color: '#ef4444', text: 'Septicity risk' };
}

function resetPumpStation() {
  document.getElementById('ps_results').innerHTML = '';
  showToast('Pump station calculator reset', 'info');
}

// ========== END PUMP STATION CALCULATOR ==========


// ========== MEMBRANE CALCULATOR (MBR/RO/UF) ==========

function updateMembraneDefaults() {
  var memType = document.getElementById('mem_type').value;
  var flux = document.getElementById('mem_flux');
  var tmp = document.getElementById('mem_tmp');
  var perm = document.getElementById('mem_perm');
  
  var defaults = {
    'mbr': { flux: 15, tmp: 3, perm: 150, area: 400 },
    'uf': { flux: 40, tmp: 15, perm: 80, area: 500 },
    'mf': { flux: 50, tmp: 10, perm: 100, area: 500 },
    'ro': { flux: 18, tmp: 150, perm: 4, area: 400 },
    'nf': { flux: 25, tmp: 100, perm: 8, area: 400 }
  };
  
  var d = defaults[memType] || defaults.mbr;
  flux.value = d.flux;
  tmp.value = d.tmp;
  perm.value = d.perm;
  document.getElementById('mem_mod_area').value = d.area;
  
  calcMembrane();
}

function calcMembrane() {
  // System config
  var memType = document.getElementById('mem_type').value;
  var designFlow = parseFloat(document.getElementById('mem_design_flow').value) || 1.0;
  var peakFactor = parseFloat(document.getElementById('mem_peak').value) || 1.5;
  var recovery = parseFloat(document.getElementById('mem_recovery').value) / 100 || 0.85;
  var numTrains = parseInt(document.getElementById('mem_trains').value) || 2;
  
  // Operating parameters
  var flux = parseFloat(document.getElementById('mem_flux').value) || 15;
  var tmp = parseFloat(document.getElementById('mem_tmp').value) || 3;
  var perm = parseFloat(document.getElementById('mem_perm').value) || 150;
  var temp = parseFloat(document.getElementById('mem_temp').value) || 20;
  
  // Module specs
  var modArea = parseFloat(document.getElementById('mem_mod_area').value) || 400;
  var modsPerCass = parseInt(document.getElementById('mem_mods_cass').value) || 8;
  
  // Cleaning
  var cipInterval = parseFloat(document.getElementById('mem_cip_interval').value) || 90;
  var cipDuration = parseFloat(document.getElementById('mem_cip_duration').value) || 4;
  var cipChemCost = parseFloat(document.getElementById('mem_cip_cost').value) || 500;
  
  // Costs
  var elecCost = parseFloat(document.getElementById('mem_elec').value) || 0.10;
  var modCost = parseFloat(document.getElementById('mem_mod_cost').value) || 3000;
  var modLife = parseFloat(document.getElementById('mem_mod_life').value) || 7;
  
  // Calculate feed flow
  var feedFlow = designFlow / recovery;
  var peakFeed = feedFlow * peakFactor;
  
  // Temperature correction (viscosity)
  var tempFactor = Math.exp(0.0239 * (20 - temp));
  var correctedFlux = flux / tempFactor;
  
  // Required membrane area
  var peakFlowGFD = peakFeed * 1000000 / 1440; // GPM to GFD basis
  var reqArea = (peakFeed * 1000000) / (correctedFlux * 1440 / 1000); // sq ft
  
  // Modules and cassettes
  var modsRequired = Math.ceil(reqArea / modArea);
  var cassRequired = Math.ceil(modsRequired / modsPerCass);
  var modsPerTrain = Math.ceil(modsRequired / numTrains);
  var cassPerTrain = Math.ceil(cassRequired / numTrains);
  var actualArea = modsRequired * modArea;
  
  // Actual operating flux
  var actualFlux = (designFlow * 1000000) / (actualArea * 1440 / 1000);
  
  // Permeability check
  var calcPerm = correctedFlux / tmp;
  var permStatus = calcPerm >= perm * 0.7 ? { color: '#4ade80', text: 'Good' } : 
                   calcPerm >= perm * 0.5 ? { color: '#fbbf24', text: 'Moderate fouling' } : 
                   { color: '#ef4444', text: 'Severe fouling' };
  
  // Energy (pressure-based)
  var pumpPressure = tmp * 2.31 + 10; // TMP + piping losses, ft
  var pumpHP = (peakFeed * 694 * pumpPressure) / (3960 * 0.7); // GPM basis
  var pumpKW = pumpHP * 0.746;
  var dailyKWh = pumpKW * 24 * (designFlow / peakFeed); // Avg operation
  var annualKWh = dailyKWh * 365;
  var annualElec = annualKWh * elecCost;
  
  // Membrane replacement
  var annualModReplacement = (modsRequired * modCost) / modLife;
  
  // CIP costs
  var cipsPerYear = 365 / cipInterval;
  var annualCIPCost = cipsPerYear * cipChemCost * numTrains;
  
  // Total annual cost
  var totalAnnual = annualElec + annualModReplacement + annualCIPCost;
  var costPerMG = totalAnnual / (designFlow * 365);
  
  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #8b5cf6">';
  html += '<h4 style="margin:0 0 15px 0;color:#8b5cf6">üî¨ Membrane System Analysis</h4>';
  
  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Total Modules</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#8b5cf6">' + modsRequired + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">modules</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Membrane Area</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + (actualArea/1000).toFixed(0) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">sq ft</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Operating Flux</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">' + actualFlux.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">GFD</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Annual Cost</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">$' + (totalAnnual/1000).toFixed(0) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/year</div></div>';
  html += '</div>';
  
  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä System Configuration</td></tr>';
  html += '<tr><td>Membrane Type</td><td><span class="result">' + memType.toUpperCase() + '</span></td><td></td></tr>';
  html += '<tr><td>Design Flow</td><td><span class="result">' + designFlow.toFixed(2) + '</span></td><td>MGD permeate</td></tr>';
  html += '<tr><td>Feed Flow (at ' + (recovery*100).toFixed(0) + '% recovery)</td><td><span class="result">' + feedFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Number of Trains</td><td><span class="result">' + numTrains + '</span></td><td></td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#8b5cf6">üî¨ Membrane Sizing</td></tr>';
  html += '<tr><td>Design Flux (20¬∞C)</td><td><span class="result">' + flux + '</span></td><td>GFD</td></tr>';
  html += '<tr><td>Temp Corrected Flux (' + temp + '¬∞C)</td><td><span class="result">' + correctedFlux.toFixed(1) + '</span></td><td>GFD</td></tr>';
  html += '<tr><td>Required Area</td><td><span class="result">' + reqArea.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>sq ft</td></tr>';
  html += '<tr><td>Modules Required</td><td><span class="result">' + modsRequired + '</span></td><td>modules</td></tr>';
  html += '<tr><td>Cassettes Required</td><td><span class="result">' + cassRequired + '</span></td><td>cassettes</td></tr>';
  html += '<tr><td>Per Train</td><td><span class="result">' + modsPerTrain + ' modules / ' + cassPerTrain + ' cassettes</span></td><td></td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">üìà Performance</td></tr>';
  html += '<tr><td>TMP</td><td><span class="result">' + tmp + '</span></td><td>psi</td></tr>';
  html += '<tr><td>Permeability</td><td><span class="result" style="color:' + permStatus.color + '">' + calcPerm.toFixed(1) + '</span></td><td>GFD/psi (' + permStatus.text + ')</td></tr>';
  html += '<tr><td>CIP Interval</td><td><span class="result">' + cipInterval + '</span></td><td>days</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üí∞ Annual Costs</td></tr>';
  html += '<tr><td>Energy Cost</td><td><span class="result">$' + annualElec.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Membrane Replacement</td><td><span class="result">$' + annualModReplacement.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>CIP Chemicals</td><td><span class="result">$' + annualCIPCost.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td><strong>Total Annual</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + totalAnnual.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Cost per MG</td><td><span class="result">$' + costPerMG.toFixed(2) + '</span></td><td>/MG</td></tr>';
  
  html += '</tbody></table>';
  html += '</div>';
  
  document.getElementById('mem_results').innerHTML = html;
  showToast('Membrane analysis complete!', 'success');
}

function resetMembrane() {
  document.getElementById('mem_results').innerHTML = '';
  showToast('Membrane calculator reset', 'info');
}

// ========== END MEMBRANE CALCULATOR ==========


// ========== DAF (DISSOLVED AIR FLOTATION) CALCULATOR ==========

function calcDAF() {
  // Design flows
  var designFlow = parseFloat(document.getElementById('daf_flow').value) || 1.0;
  var peakFactor = parseFloat(document.getElementById('daf_peak').value) || 1.5;
  var numUnits = parseInt(document.getElementById('daf_units').value) || 2;
  
  // Influent characteristics
  var infTSS = parseFloat(document.getElementById('daf_inf_tss').value) || 200;
  var infFOG = parseFloat(document.getElementById('daf_inf_fog').value) || 100;
  var infBOD = parseFloat(document.getElementById('daf_inf_bod').value) || 300;
  var temp = parseFloat(document.getElementById('daf_temp').value) || 20;
  
  // Design parameters
  var slr = parseFloat(document.getElementById('daf_slr').value) || 2.0;
  var hlr = parseFloat(document.getElementById('daf_hlr').value) || 4.0;
  var asRatio = parseFloat(document.getElementById('daf_as').value) || 0.02;
  var recyclePct = parseFloat(document.getElementById('daf_recycle').value) || 30;
  var satPressure = parseFloat(document.getElementById('daf_pressure').value) || 60;
  
  // Performance targets
  var tssRemoval = parseFloat(document.getElementById('daf_tss_rem').value) || 90;
  var fogRemoval = parseFloat(document.getElementById('daf_fog_rem').value) || 95;
  
  // Costs
  var elecCost = parseFloat(document.getElementById('daf_elec').value) || 0.10;
  var polyDose = parseFloat(document.getElementById('daf_poly').value) || 5;
  var polyCost = parseFloat(document.getElementById('daf_poly_cost').value) || 2.50;
  
  // Calculate flows
  var peakFlow = designFlow * peakFactor;
  var flowPerUnit = designFlow / numUnits;
  var peakPerUnit = peakFlow / numUnits;
  var recycleFlow = designFlow * (recyclePct / 100);
  var totalFlow = designFlow + recycleFlow;
  
  // Tank sizing
  var reqAreaSLR = (infTSS * designFlow * 8.34) / (slr * 24); // sq ft based on SLR
  var reqAreaHLR = (designFlow * 1000000) / (hlr * 1440); // sq ft based on HLR
  var reqArea = Math.max(reqAreaSLR, reqAreaHLR);
  var areaPerUnit = reqArea / numUnits;
  
  // Typical dimensions (L:W = 4:1)
  var width = Math.sqrt(areaPerUnit / 4);
  var length = width * 4;
  var depth = 8; // typical
  
  // Air requirements
  var airSolubility = 18.7 * (satPressure / 14.7) * (293 / (273 + temp)); // mg/L at pressure
  var airReleased = airSolubility * 0.9; // 90% release efficiency
  var recycleGPM = recycleFlow * 1000000 / 1440;
  var airRequired = (airReleased * recycleGPM * 8.34) / 1000000; // lb/min
  var scfmAir = airRequired * 13.1; // SCFM
  
  // Check A/S ratio
  var solidsMass = infTSS * designFlow * 8.34; // lb/day
  var airMass = airReleased * recycleGPM * 60 * 24 * 8.34 / 1000000; // lb/day
  var actualAS = airMass / solidsMass;
  var asStatus = actualAS >= asRatio * 0.8 ? { color: '#4ade80', text: 'Adequate' } : { color: '#ef4444', text: 'Low - increase recycle' };
  
  // Effluent quality
  var effTSS = infTSS * (1 - tssRemoval / 100);
  var effFOG = infFOG * (1 - fogRemoval / 100);
  var effBOD = infBOD * (1 - tssRemoval / 100 * 0.5); // Assume 50% BOD tied to TSS
  
  // Float production
  var tssRemoved = infTSS - effTSS;
  var fogRemoved = infFOG - effFOG;
  var floatSolids = (tssRemoved + fogRemoved) * designFlow * 8.34; // lb/day
  var floatPct = 4; // typical 4% solids
  var floatVolume = floatSolids / (floatPct / 100 * 8.34) / 1000; // thousand gal/day
  
  // Energy
  var satPumpHP = (recycleGPM * satPressure * 2.31) / (3960 * 0.7);
  var airCompHP = scfmAir * 0.15; // Approx HP per SCFM at 60 psi
  var totalHP = satPumpHP + airCompHP;
  var totalKW = totalHP * 0.746;
  var dailyKWh = totalKW * 24;
  var annualElec = dailyKWh * 365 * elecCost;
  
  // Polymer
  var dailyPoly = polyDose * solidsMass / 2000; // lb/day
  var annualPolyCost = dailyPoly * polyCost * 365;
  
  // Total annual cost
  var totalAnnual = annualElec + annualPolyCost;
  
  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #f59e0b">';
  html += '<h4 style="margin:0 0 15px 0;color:#f59e0b">ü´ß DAF System Analysis</h4>';
  
  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Tank Area</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#f59e0b">' + reqArea.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">sq ft total</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">A/S Ratio</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + asStatus.color + '">' + (actualAS * 100).toFixed(2) + '</div>';
  html += '<div style="font-size:11px;color:' + asStatus.color + '">' + asStatus.text + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Effluent TSS</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">' + effTSS.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">mg/L</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Float Produced</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + (floatSolids/1000).toFixed(1) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">lb/day</div></div>';
  html += '</div>';
  
  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Design Parameters</td></tr>';
  html += '<tr><td>Design Flow</td><td><span class="result">' + designFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Recycle Flow (' + recyclePct + '%)</td><td><span class="result">' + recycleFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Total Flow</td><td><span class="result">' + totalFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#f59e0b">ü´ß Tank Sizing</td></tr>';
  html += '<tr><td>Total Tank Area</td><td><span class="result">' + reqArea.toFixed(0) + '</span></td><td>sq ft</td></tr>';
  html += '<tr><td>Per Unit (' + numUnits + ' units)</td><td><span class="result">' + areaPerUnit.toFixed(0) + '</span></td><td>sq ft</td></tr>';
  html += '<tr><td>Suggested Dimensions</td><td><span class="result">' + length.toFixed(0) + ' √ó ' + width.toFixed(0) + ' √ó ' + depth + '</span></td><td>ft (L√óW√óD)</td></tr>';
  html += '<tr><td>Surface Loading (SLR)</td><td><span class="result">' + slr.toFixed(1) + '</span></td><td>lb TSS/sf/day</td></tr>';
  html += '<tr><td>Hydraulic Loading (HLR)</td><td><span class="result">' + hlr.toFixed(1) + '</span></td><td>GPM/sf</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#06b6d4">üí® Air System</td></tr>';
  html += '<tr><td>Saturator Pressure</td><td><span class="result">' + satPressure + '</span></td><td>psi</td></tr>';
  html += '<tr><td>Air Solubility</td><td><span class="result">' + airSolubility.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>A/S Ratio</td><td><span class="result" style="color:' + asStatus.color + '">' + (actualAS * 100).toFixed(3) + '</span></td><td>lb air/lb solids</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üìà Performance</td></tr>';
  html += '<tr><td>Influent TSS ‚Üí Effluent</td><td><span class="result">' + infTSS + ' ‚Üí ' + effTSS.toFixed(0) + '</span></td><td>mg/L (' + tssRemoval + '% removal)</td></tr>';
  html += '<tr><td>Influent FOG ‚Üí Effluent</td><td><span class="result">' + infFOG + ' ‚Üí ' + effFOG.toFixed(0) + '</span></td><td>mg/L (' + fogRemoval + '% removal)</td></tr>';
  html += '<tr><td>Float Production</td><td><span class="result">' + floatSolids.toFixed(0) + '</span></td><td>lb/day @ ' + floatPct + '% solids</td></tr>';
  html += '<tr><td>Float Volume</td><td><span class="result">' + (floatVolume * 1000).toFixed(0) + '</span></td><td>gal/day</td></tr>';
  
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#ef4444">üí∞ Operating Costs</td></tr>';
  html += '<tr><td>Power Requirement</td><td><span class="result">' + totalKW.toFixed(1) + '</span></td><td>kW</td></tr>';
  html += '<tr><td>Annual Energy</td><td><span class="result">$' + annualElec.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Polymer Usage</td><td><span class="result">' + dailyPoly.toFixed(1) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Annual Polymer</td><td><span class="result">$' + annualPolyCost.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td><strong>Total Annual</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + totalAnnual.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  
  html += '</tbody></table>';
  html += '</div>';
  
  document.getElementById('daf_results').innerHTML = html;
  showToast('DAF analysis complete!', 'success');
}

function resetDAF() {
  document.getElementById('daf_results').innerHTML = '';
  showToast('DAF calculator reset', 'info');
}

// ========== END DAF CALCULATOR ==========


// ========== GOOGLE SHEETS SYNC ==========

function connectGoogleSheet() {
  var url = document.getElementById('sheets_url').value;
  if (!url || !url.includes('docs.google.com/spreadsheets')) {
    showToast('Please enter a valid Google Sheets URL', 'error');
    return;
  }
  
  // Simulate connection (in real implementation, would use Google Sheets API)
  document.getElementById('sheets_status_dot').style.background = '#fbbf24';
  document.getElementById('sheets_status_text').textContent = 'Connecting...';
  
  setTimeout(function() {
    document.getElementById('sheets_status_dot').style.background = '#4ade80';
    document.getElementById('sheets_status_text').textContent = 'Connected';
    document.getElementById('last_sync').value = new Date().toLocaleString();
    showToast('Connected to Google Sheet!', 'success');
  }, 1500);
}

function testSheetConnection() {
  var url = document.getElementById('sheets_url').value;
  if (!url) {
    showToast('Please enter a Sheet URL first', 'error');
    return;
  }
  showToast('Testing connection...', 'info');
  setTimeout(function() {
    showToast('Connection test successful!', 'success');
  }, 1000);
}

function exportToSheets() {
  var selections = [];
  if (document.getElementById('exp_flow').checked) selections.push('Flow Data');
  if (document.getElementById('exp_do').checked) selections.push('DO Readings');
  if (document.getElementById('exp_mlss').checked) selections.push('MLSS/SVI');
  if (document.getElementById('exp_sludge').checked) selections.push('Sludge Data');
  if (document.getElementById('exp_bod').checked) selections.push('BOD/COD');
  if (document.getElementById('exp_tss').checked) selections.push('TSS');
  if (document.getElementById('exp_nutrients').checked) selections.push('Nutrients');
  
  if (selections.length === 0) {
    showToast('Please select data to export', 'error');
    return;
  }
  
  var html = '<div style="background:#065f46;padding:20px;border-radius:12px;border-left:4px solid #4ade80">';
  html += '<h4 style="margin:0 0 15px 0;color:#4ade80">‚úÖ Export Successful</h4>';
  html += '<p>Exported ' + selections.length + ' data categories to Google Sheets:</p>';
  html += '<ul style="margin:10px 0 0 20px">';
  selections.forEach(function(s) { html += '<li>' + s + '</li>'; });
  html += '</ul>';
  html += '<p style="margin-top:15px;font-size:12px;opacity:0.8">Last sync: ' + new Date().toLocaleString() + '</p>';
  html += '</div>';
  
  document.getElementById('sheets_results').innerHTML = html;
  document.getElementById('last_sync').value = new Date().toLocaleString();
  showToast('Data exported to Google Sheets!', 'success');
}

function scheduleAutoSync() {
  var freq = document.getElementById('sync_freq').value;
  var time = document.getElementById('sync_time').value;
  
  if (freq === 'manual') {
    showToast('Auto-sync disabled', 'info');
    return;
  }
  
  showToast('Auto-sync scheduled: ' + freq + ' at ' + time, 'success');
}

function downloadCSV() {
  // Generate sample CSV data
  var csvContent = 'Date,Flow (MGD),DO (mg/L),MLSS (mg/L),SVI,pH,Temp (F)\n';
  var today = new Date();
  for (var i = 6; i >= 0; i--) {
    var d = new Date(today);
    d.setDate(d.getDate() - i);
    csvContent += d.toLocaleDateString() + ',' + (3 + Math.random()).toFixed(2) + ',' + 
                  (1.5 + Math.random()).toFixed(1) + ',' + (2800 + Math.random()*400).toFixed(0) + ',' +
                  (120 + Math.random()*40).toFixed(0) + ',' + (6.8 + Math.random()*0.4).toFixed(1) + ',' +
                  (68 + Math.random()*8).toFixed(0) + '\n';
  }
  
  var blob = new Blob([csvContent], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_data_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV downloaded!', 'success');
}

// ========== END GOOGLE SHEETS SYNC ==========


// ========== SERVICE PROPOSAL GENERATOR ==========

function generateServiceProposal() {
  var client = document.getElementById('prop_client').value || 'Client Name';
  var contact = document.getElementById('prop_contact').value || 'Contact Person';
  var facility = document.getElementById('prop_facility').value || 'WWTP';
  var capacity = document.getElementById('prop_capacity').value || '5.0';
  var hourly = parseFloat(document.getElementById('prop_hourly').value) || 150;
  var retainer = parseFloat(document.getElementById('prop_retainer').value) || 2500;
  var visit = parseFloat(document.getElementById('prop_visit').value) || 500;
  var term = document.getElementById('prop_term').value;
  
  // Calculate annual value
  var visitsPerMonth = document.getElementById('svc_monthly').checked ? 1 : 0;
  var annualVisits = visitsPerMonth * 12;
  var annualRetainer = retainer * 12;
  var annualVisitCost = annualVisits * visit;
  var annualTotal = annualRetainer + annualVisitCost;
  
  // Get selected services
  var services = [];
  if (document.getElementById('svc_monthly').checked) services.push('Monthly Site Visits');
  if (document.getElementById('svc_process').checked) services.push('Process Optimization');
  if (document.getElementById('svc_troubleshoot').checked) services.push('24/7 Troubleshooting Support');
  if (document.getElementById('svc_training').checked) services.push('Operator Training');
  if (document.getElementById('svc_dmr').checked) services.push('DMR Review & Assistance');
  if (document.getElementById('svc_reports').checked) services.push('Monthly Status Reports');
  if (document.getElementById('svc_permit').checked) services.push('Permit Compliance Support');
  if (document.getElementById('svc_audit').checked) services.push('Annual Compliance Audit');
  
  var html = '<div style="background:white;color:#1a1a2e;padding:30px;border-radius:12px;font-family:Georgia,serif">';
  html += '<div style="text-align:center;border-bottom:3px solid #0077b6;padding-bottom:20px;margin-bottom:20px">';
  html += '<h1 style="margin:0;color:#0077b6;font-size:20px">WASTEWATER CONSULTING SERVICES</h1>';
  html += '<h2 style="margin:10px 0 0 0;color:#333;font-size:18px;font-weight:normal">Service Proposal</h2>';
  html += '</div>';
  
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px">';
  html += '<div><strong>Prepared For:</strong><br>' + client + '<br>Attn: ' + contact + '</div>';
  html += '<div style="text-align:right"><strong>Date:</strong> ' + new Date().toLocaleDateString() + '<br><strong>Valid For:</strong> 30 Days</div>';
  html += '</div>';
  
  html += '<div style="background:#f0f9ff;padding:20px;border-radius:8px;margin-bottom:20px">';
  html += '<h3 style="margin:0 0 10px 0;color:#0077b6">Facility: ' + facility + '</h3>';
  html += '<p style="margin:0">Design Capacity: ' + capacity + ' MGD | Treatment: ' + document.getElementById('prop_treatment').value.replace('_', ' ').toUpperCase() + '</p>';
  html += '</div>';
  
  html += '<h3 style="color:#0077b6;border-bottom:1px solid #ccc;padding-bottom:10px">Scope of Services</h3>';
  html += '<ul style="line-height:1.8">';
  services.forEach(function(s) { html += '<li>' + s + '</li>'; });
  html += '</ul>';
  
  html += '<h3 style="color:#0077b6;border-bottom:1px solid #ccc;padding-bottom:10px;margin-top:30px">Investment Summary</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#0077b6;color:white"><th style="padding:12px;text-align:left">Item</th><th style="padding:12px;text-align:right">Amount</th></tr>';
  html += '<tr style="border-bottom:1px solid #ddd"><td style="padding:12px">Monthly Retainer</td><td style="padding:12px;text-align:right">$' + retainer.toLocaleString() + '/month</td></tr>';
  if (visitsPerMonth > 0) {
    html += '<tr style="border-bottom:1px solid #ddd"><td style="padding:12px">Site Visits (' + visitsPerMonth + '/month)</td><td style="padding:12px;text-align:right">$' + visit.toLocaleString() + '/visit</td></tr>';
  }
  html += '<tr style="border-bottom:1px solid #ddd"><td style="padding:12px">Additional Hours (as needed)</td><td style="padding:12px;text-align:right">$' + hourly.toLocaleString() + '/hour</td></tr>';
  html += '<tr style="background:#f0f9ff;font-weight:bold"><td style="padding:12px">Estimated Annual Investment</td><td style="padding:12px;text-align:right;color:#0077b6;font-size:18px">$' + annualTotal.toLocaleString() + '</td></tr>';
  html += '</table>';
  
  html += '<div style="background:#065f46;color:white;padding:15px;border-radius:8px;margin-top:20px">';
  html += '<strong>Contract Term:</strong> ' + term.replace('_', ' ').replace('month', ' Month').replace('annual', 'Annual').replace('year', ' Year') + ' | ';
  html += '<strong>Payment:</strong> Net 30 Days';
  html += '</div>';
  
  html += '</div>';
  
  document.getElementById('proposal_preview').innerHTML = html;
  showToast('Proposal generated!', 'success');
}

function previewProposal() {
  generateServiceProposal();
}

function saveProposalTemplate() {
  showToast('Template saved for future use!', 'success');
}

function clearProposalForm() {
  document.getElementById('prop_client').value = '';
  document.getElementById('prop_contact').value = '';
  document.getElementById('prop_facility').value = '';
  document.getElementById('prop_email').value = '';
  document.getElementById('prop_phone').value = '';
  document.getElementById('prop_address').value = '';
  document.getElementById('proposal_preview').innerHTML = '';
  showToast('Form cleared', 'info');
}

// ========== END SERVICE PROPOSAL GENERATOR ==========




// ========== ENHANCED FEATURES v5.1.0 ==========

// Quick Calculate All - runs all calculators at once
function calculateAll() {
  const calcs = ['calcOLR', 'calcFM', 'calcSVI', 'calcHRT', 'calcBODeff', 'calcRAS', 'calcChlorine', 'calcPolymer'];
  let count = 0;
  calcs.forEach(fn => {
    try {
      if (typeof window[fn] === 'function') {
        window[fn]();
        count++;
      }
    } catch(e) {}
  });
  showToast('Calculated ' + count + ' parameters', 'success');
}

// Export all results to text
function exportResults() {
  let results = '=== WWTP COMMAND CENTER RESULTS ===\n';
  results += 'Generated: ' + new Date().toLocaleString() + '\n\n';
  
  const resultSpans = document.querySelectorAll('.result');
  resultSpans.forEach(span => {
    if (span.textContent && span.textContent !== '-') {
      const row = span.closest('tr');
      if (row) {
        const label = row.querySelector('.rowh');
        if (label) {
          results += label.textContent + ': ' + span.textContent + '\n';
        }
      }
    }
  });
  
  const blob = new Blob([results], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_results_' + new Date().toISOString().split('T')[0] + '.txt';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Results exported!', 'success');
}

// Print current panel
function printPanel() {
  const activePanel = document.querySelector('.panel.active');
  if (activePanel) {
    const printContent = activePanel.innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<html><head><title>WWTP Command Center v9.9.16</title>');
    printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px}table{width:100%;border-collapse:collapse;margin:10px 0}td,th{border:1px solid #ddd;padding:8px;text-align:left}.section{margin:20px 0;padding:15px;border:1px solid #ccc;border-radius:8px}.section-h{font-weight:bold;font-size:18px;margin-bottom:10px}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write('<h1>WWTP Command Center Report</h1>');
    printWindow.document.write('<p>Generated: ' + new Date().toLocaleString() + '</p>');
    printWindow.document.write(printContent);
    printWindow.document.write('');
    printWindow.document.close();
    printWindow.print();
  }
}

// Reset all calculators
function resetAll() {
  if (confirm('Reset all calculator values to defaults?')) {
    const resets = ['resetOLR', 'resetFM', 'resetSVI', 'resetHRT', 'resetBODeff', 'resetRAS', 'resetChlorine', 'resetPolymer', 'resetPump', 'resetWAS', 'resetSRTmain', 'resetSOR', 'resetWOR', 'resetSLR', 'resetMCRT', 'resetOUR', 'resetNH3', 'resetPhos', 'resetTSS', 'resetGrit', 'resetDigester'];
    resets.forEach(fn => {
      try {
        if (typeof window[fn] === 'function') window[fn]();
      } catch(e) {}
    });
    showToast('All calculators reset', 'info');
  }
}

// Quick status check
function quickStatus() {
  const fm = document.getElementById('r_fm');
  const svi = document.getElementById('r_svi');
  const bod = document.getElementById('r_bod_eff');
  
  let status = 'üìä Quick Status:\n';
  status += '‚Ä¢ F/M Ratio: ' + (fm ? fm.textContent : 'N/A') + '\n';
  status += '‚Ä¢ SVI: ' + (svi ? svi.textContent : 'N/A') + '\n';
  status += '‚Ä¢ BOD Removal: ' + (bod ? bod.textContent : 'N/A') + '%\n';
  
  alert(status);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 's':
        e.preventDefault();
        if (typeof saveData === 'function') saveData();
        break;
      case 'p':
        e.preventDefault();
        printPanel();
        break;
      case 'e':
        e.preventDefault();
        exportResults();
        break;
    }
  }
});

</script>

<!-- Floating Action Button -->
<div id="fab-menu" style="position:fixed;bottom:20px;right:20px;z-index:1000">
<button onclick="document.getElementById('fab-options').style.display=document.getElementById('fab-options').style.display==='none'?'flex':'none'" style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;font-size:18px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.3)">‚öôÔ∏è</button>
<div id="fab-options" style="display:none;flex-direction:column;gap:8px;position:absolute;bottom:65px;right:0">
<button onclick="calculateAll();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#06d6a0;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">‚ö° Calculate All</button>
<button onclick="exportResults();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#0077b6;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üì§ Export Results</button>
<button onclick="quickStatus();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#ffd166;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üìä Quick Status</button>
<button onclick="printPanel();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#00b4d8;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üñ®Ô∏è Print Panel</button>
</div>
</div>


<script>
// ========== VOICE CONTROL SYSTEM v5.1.0 ==========

var voiceRecognition = null;
var isListening = false;

// Initialize Voice Control
function initVoice() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    voiceRecognition = new SpeechRecognition();
    voiceRecognition.continuous = false;
    voiceRecognition.interimResults = false;
    voiceRecognition.lang = 'en-US';
    
    voiceRecognition.onresult = function(event) {
      var transcript = event.results[0][0].transcript.toLowerCase();
      showVoiceFeedback('üéØ Heard: "' + transcript + '"');
      processVoiceCommand(transcript);
    };
    
    voiceRecognition.onerror = function(event) {
      showVoiceFeedback('‚ùå Error: ' + event.error);
      stopListening();
    };
    
    voiceRecognition.onend = function() {
      stopListening();
    };
    
    console.log('Voice control initialized');
  } else {
    console.log('Speech recognition not supported');
    var btn = document.getElementById('voiceBtn');
    if (btn) btn.style.display = 'none';
  }
}

// Toggle voice listening
function toggleVoice() {
  if (isListening) {
    stopListening();
  } else {
    startListening();
  }
}

// Start listening
function startListening() {
  if (!voiceRecognition) {
    showVoiceFeedback('‚ùå Voice not supported in this browser');
    return;
  }
  try {
    voiceRecognition.start();
    isListening = true;
    document.getElementById('voiceBtn').classList.add('listening');
    showVoiceFeedback('üé§ Listening... Say a command');
  } catch(e) {
    showVoiceFeedback('‚ùå Could not start voice recognition');
  }
}

// Stop listening
function stopListening() {
  isListening = false;
  document.getElementById('voiceBtn').classList.remove('listening');
  if (voiceRecognition) {
    try { voiceRecognition.stop(); } catch(e) {}
  }
  setTimeout(function() {
    document.getElementById('voiceFeedback').classList.remove('active');
  }, 3000);
}

// Show voice feedback
function showVoiceFeedback(text) {
  var feedback = document.getElementById('voiceFeedback');
  feedback.textContent = text;
  feedback.classList.add('active');
}

// Process voice commands
function processVoiceCommand(cmd) {
  var executed = false;
  
  // Navigation commands
  if (cmd.includes('dashboard') || cmd.includes('home')) {
    switchPanel('dashboard');
    showVoiceFeedback('‚úì Switched to Dashboard');
    executed = true;
  } else if (cmd.includes('calculator') || cmd.includes('calculation') || cmd.includes('process')) {
    switchPanel('hydraulics');
    showVoiceFeedback('‚úì Switched to Process Calculations');
    executed = true;
  } else if (cmd.includes('operator') || cmd.includes('tools') || cmd.includes('training')) {
    switchPanel('daily-ops');
    showVoiceFeedback('‚úì Switched to Operator Tools');
    executed = true;
  } else if (cmd.includes('report')) {
    switchPanel('reports');
    showVoiceFeedback('‚úì Switched to Reports');
    executed = true;
  } else if (cmd.includes('maintenance')) {
    switchPanel('maintenance');
    showVoiceFeedback('‚úì Switched to Maintenance');
    executed = true;
  } else if (cmd.includes('energy')) {
    switchPanel('aeration');
    showVoiceFeedback('‚úì Switched to Energy');
    executed = true;
  } else if (cmd.includes('cost')) {
    switchPanel('chemicals');
    showVoiceFeedback('‚úì Switched to Cost Analysis');
    executed = true;
  } else if (cmd.includes('diagnostic')) {
    switchPanel('wizards');
    showVoiceFeedback('‚úì Switched to Diagnostics');
    executed = true;
  }
  
  // Action commands
  else if (cmd.includes('calculate all') || cmd.includes('run all')) {
    calculateAll();
    showVoiceFeedback('‚úì Running all calculations...');
    executed = true;
  } else if (cmd.includes('save')) {
    saveAllData();
    showVoiceFeedback('‚úì Data saved!');
    executed = true;
  } else if (cmd.includes('export')) {
    exportResults();
    showVoiceFeedback('‚úì Exporting results...');
    executed = true;
  } else if (cmd.includes('print')) {
    printPanel();
    showVoiceFeedback('‚úì Printing...');
    executed = true;
  } else if (cmd.includes('reset')) {
    resetAll();
    showVoiceFeedback('‚úì Reset complete');
    executed = true;
  } else if (cmd.includes('status') || cmd.includes('quick status')) {
    quickStatus();
    showVoiceFeedback('‚úì Showing status...');
    executed = true;
  }
  
  // Wizard commands
  else if (cmd.includes('f/m') || cmd.includes('f m') || cmd.includes('food to microorganism')) {
    startWizard('fm');
    showVoiceFeedback('‚úì Starting F/M Wizard');
    executed = true;
  } else if (cmd.includes('srt') || cmd.includes('solids retention')) {
    startWizard('srt');
    showVoiceFeedback('‚úì Starting SRT Wizard');
    executed = true;
  } else if (cmd.includes('svi') || cmd.includes('sludge volume')) {
    startWizard('svi');
    showVoiceFeedback('‚úì Starting SVI Wizard');
    executed = true;
  } else if (cmd.includes('chlorine')) {
    startWizard('chlorine');
    showVoiceFeedback('‚úì Starting Chlorine Wizard');
    executed = true;
  }
  
  // Help command
  else if (cmd.includes('help') || cmd.includes('commands')) {
    showVoiceHelp();
    showVoiceFeedback('‚úì Showing voice commands');
    executed = true;
  }
  
  // Dark mode
  else if (cmd.includes('dark mode') || cmd.includes('night mode')) {
    toggleDarkMode();
    showVoiceFeedback('‚úì Toggled dark mode');
    executed = true;
  }
  
  if (!executed) {
    showVoiceFeedback('‚ùì Command not recognized. Say "help" for commands.');
    speakText('Command not recognized. Say help for available commands.');
  } else {
    speakText('Done');
  }
}

// Text to speech
function speakText(text) {
  if ('speechSynthesis' in window) {
    var utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    speechSynthesis.speak(utterance);
  }
}

// Show voice help modal
function showVoiceHelp() {
  var html = '<div style="max-width:500px">';
  html += '<h3 style="color:#4ade80;margin:0 0 15px 0">üé§ Voice Commands</h3>';
  html += '<p style="color:#94a3b8;margin-bottom:15px">Click the mic button and say any of these commands:</p>';
  
  html += '<div class="voice-commands-list">';
  html += '<div><strong style="color:#60a5fa">Navigation:</strong></div>';
  html += '<div><code>"Dashboard"</code> - Go to dashboard</div>';
  html += '<div><code>"Calculators"</code> - Go to process calculations</div>';
  html += '<div><code>"Operator tools"</code> - Go to operator tools</div>';
  html += '<div><code>"Reports"</code> - Go to reports</div>';
  html += '<div><code>"Maintenance"</code> - Go to maintenance</div>';
  html += '</div>';
  
  html += '<div class="voice-commands-list" style="margin-top:10px">';
  html += '<div><strong style="color:#60a5fa">Actions:</strong></div>';
  html += '<div><code>"Calculate all"</code> - Run all calculations</div>';
  html += '<div><code>"Save"</code> - Save all data</div>';
  html += '<div><code>"Export"</code> - Export results</div>';
  html += '<div><code>"Print"</code> - Print current panel</div>';
  html += '<div><code>"Quick status"</code> - Show plant status</div>';
  html += '</div>';
  
  html += '<div class="voice-commands-list" style="margin-top:10px">';
  html += '<div><strong style="color:#60a5fa">Wizards:</strong></div>';
  html += '<div><code>"F/M wizard"</code> - Start F/M calculation</div>';
  html += '<div><code>"SRT wizard"</code> - Start SRT calculation</div>';
  html += '<div><code>"SVI wizard"</code> - Start SVI calculation</div>';
  html += '<div><code>"Chlorine wizard"</code> - Start chlorine dosing</div>';
  html += '</div>';
  
  html += '<div class="voice-commands-list" style="margin-top:10px">';
  html += '<div><strong style="color:#60a5fa">Other:</strong></div>';
  html += '<div><code>"Help"</code> - Show this help</div>';
  html += '<div><code>"Dark mode"</code> - Toggle dark mode</div>';
  html += '</div>';
  
  html += '</div>';
  
  showModal('Voice Commands', html);
}

// Duplicate switchPanel removed - using main function

// Initialize voice on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initVoice, 1000);
});

// ========== END VOICE CONTROL SYSTEM ==========


// Belt Press Calculator
function calcBeltPress() {
  const feedSolids = parseFloat(document.getElementById('bp_feed').value) || 3;
  const cakeSolids = parseFloat(document.getElementById('bp_cake').value) || 22;
  const feedFlow = parseFloat(document.getElementById('bp_rate').value) || 150;
  const polyDose = parseFloat(document.getElementById('bp_poly').value) || 8;
  
  // Dry solids in (lb/hr)
  const drySolidsIn = feedFlow * 60 * 8.34 * (feedSolids / 100);
  
  // Cake production (wet lb/hr)
  const cakeProduction = drySolidsIn / (cakeSolids / 100);
  
  // Polymer usage (lb/hr) = (Dry Tons/hr) √ó (lb polymer/dry ton)
  const dryTonsHr = drySolidsIn / 2000;
  const polymerUsage = dryTonsHr * polyDose;
  
  // Capture rate (assumed 95% typical)
  const captureRate = 95;
  
  document.getElementById('r_bp_dry').textContent = drySolidsIn.toFixed(0);
  document.getElementById('r_bp_cake').textContent = cakeProduction.toFixed(0);
  document.getElementById('r_bp_capture').textContent = captureRate.toFixed(0);
  document.getElementById('r_bp_polymer').textContent = polymerUsage.toFixed(1);
  
  if (typeof showToast === 'function') showToast('Belt Press calculated', 'success');
}

function resetBeltPress() {
  document.getElementById('bp_feed').value = '3';
  document.getElementById('bp_cake').value = '22';
  document.getElementById('bp_rate').value = '150';
  document.getElementById('bp_poly').value = '8';
  ['r_bp_dry', 'r_bp_cake', 'r_bp_capture', 'r_bp_polymer'].forEach(id => {
    if(document.getElementById(id)) document.getElementById(id).textContent = '-';
  });
}



// ==================== SBR FUNCTIONS ====================

function calcSBRCycle() {
  const flow = parseFloat(document.getElementById('sbr_flow').value) || 2;
  const basins = parseInt(document.getElementById('sbr_basins').value) || 2;
  const vol = parseFloat(document.getElementById('sbr_vol').value) || 0.5;
  const fill = parseFloat(document.getElementById('sbr_fill').value) || 60;
  const react = parseFloat(document.getElementById('sbr_react').value) || 120;
  const settle = parseFloat(document.getElementById('sbr_settle').value) || 60;
  const decant = parseFloat(document.getElementById('sbr_decant').value) || 45;
  const idle = parseFloat(document.getElementById('sbr_idle').value) || 15;
  
  const totalCycle = fill + react + settle + decant + idle;
  const cyclesPerDay = 1440 / totalCycle;
  const decantVol = (flow / basins) / cyclesPerDay; // MG per decant
  const treatmentCap = decantVol * cyclesPerDay * basins;
  const hrt = (vol * 1000000) / ((flow / basins / cyclesPerDay) * 1000000) * (totalCycle / 60);
  const fillFrac = (decantVol / vol) * 100;
  
  document.getElementById('r_sbr_cycle').textContent = totalCycle.toFixed(0);
  document.getElementById('r_sbr_cpd').textContent = cyclesPerDay.toFixed(1);
  document.getElementById('r_sbr_cap').textContent = treatmentCap.toFixed(2);
  document.getElementById('r_sbr_hrt').textContent = hrt.toFixed(1);
  document.getElementById('r_sbr_decvol').textContent = decantVol.toFixed(3);
  document.getElementById('r_sbr_fillfrac').textContent = fillFrac.toFixed(1);
  
  // Status indicators
  document.getElementById('s_sbr_cycle').textContent = totalCycle <= 360 ? '‚úì Good' : totalCycle <= 480 ? '‚ö† Long' : '‚úó Too Long';
  document.getElementById('s_sbr_cycle').className = 'status ' + (totalCycle <= 360 ? 'ok' : totalCycle <= 480 ? 'warn' : 'bad');
  document.getElementById('s_sbr_cpd').textContent = cyclesPerDay >= 3 ? '‚úì Good' : '‚ö† Low';
  document.getElementById('s_sbr_cpd').className = 'status ' + (cyclesPerDay >= 3 ? 'ok' : 'warn');
  document.getElementById('s_sbr_cap').textContent = treatmentCap >= flow ? '‚úì Adequate' : '‚úó Under Capacity';
  document.getElementById('s_sbr_cap').className = 'status ' + (treatmentCap >= flow ? 'ok' : 'bad');
  document.getElementById('s_sbr_hrt').textContent = hrt >= 4 ? '‚úì Good' : '‚ö† Short';
  document.getElementById('s_sbr_hrt').className = 'status ' + (hrt >= 4 ? 'ok' : 'warn');
}

function resetSBRCycle() {
  ['sbr_flow','sbr_basins','sbr_vol','sbr_fill','sbr_react','sbr_settle','sbr_decant','sbr_idle'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','2','0.5','60','120','60','45','15'][i];
  });
  ['r_sbr_cycle','r_sbr_cpd','r_sbr_cap','r_sbr_hrt','r_sbr_decvol','r_sbr_fillfrac','s_sbr_cycle','s_sbr_cpd','s_sbr_cap','s_sbr_hrt'].forEach(id => {
    if(document.getElementById(id)) document.getElementById(id).textContent = '-';
  });
}

function calcSBRAeration() {
  const flow = parseFloat(document.getElementById('sbr_flow').value) || 2;
  const bodIn = parseFloat(document.getElementById('sbr_bod').value) || 200;
  const bodOut = parseFloat(document.getElementById('sbr_bod_eff').value) || 10;
  const nh3 = parseFloat(document.getElementById('sbr_nh3').value) || 30;
  const mlss = parseFloat(document.getElementById('sbr_mlss').value) || 3500;
  const srt = parseFloat(document.getElementById('sbr_srt').value) || 15;
  const alpha = parseFloat(document.getElementById('sbr_alpha').value) || 0.5;
  const beta = parseFloat(document.getElementById('sbr_beta').value) || 0.95;
  const temp = parseFloat(document.getElementById('sbr_temp').value) || 20;
  const basins = parseInt(document.getElementById('sbr_basins').value) || 2;
  
  // Carbonaceous O2 demand: 1.1-1.5 lb O2/lb BOD removed
  const bodRemoved = (bodIn - bodOut) * flow * 8.34;
  const cod = bodRemoved * 1.2;
  
  // Nitrogenous O2 demand: 4.6 lb O2/lb NH3-N oxidized
  const nod = nh3 * flow * 8.34 * 4.6;
  
  const aor = cod + nod;
  
  // Convert AOR to SOTR using alpha, beta, temp correction
  const theta = Math.pow(1.024, temp - 20);
  const cSat = 9.09; // mg/L at 20C
  const cOp = 2.0; // operating DO
  const sotr = aor / (alpha * theta * beta * ((cSat - cOp) / cSat));
  
  // Air required at 25% OTE
  const airReq = (sotr / 24) / (0.075 * 0.232 * 0.25) / 60;
  const airPerBasin = airReq / basins;
  
  document.getElementById('r_sbr_cod').textContent = cod.toFixed(0);
  document.getElementById('r_sbr_nod').textContent = nod.toFixed(0);
  document.getElementById('r_sbr_aor').textContent = aor.toFixed(0);
  document.getElementById('r_sbr_sotr').textContent = (sotr/24).toFixed(1);
  document.getElementById('r_sbr_air').textContent = airReq.toFixed(0);
  document.getElementById('r_sbr_airbasin').textContent = airPerBasin.toFixed(0);
}

function resetSBRAeration() {
  ['sbr_bod','sbr_bod_eff','sbr_nh3','sbr_mlss','sbr_srt','sbr_alpha','sbr_beta','sbr_temp'].forEach((id,i) => {
    document.getElementById(id).value = ['200','10','30','3500','15','0.5','0.95','20'][i];
  });
  ['r_sbr_cod','r_sbr_nod','r_sbr_aor','r_sbr_sotr','r_sbr_air','r_sbr_airbasin'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcSBRSettle() {
  const mlss = parseFloat(document.getElementById('sbr_set_mlss').value) || 3500;
  const svi = parseFloat(document.getElementById('sbr_svi').value) || 120;
  const settleTime = parseFloat(document.getElementById('sbr_set_time').value) || 60;
  const depth = parseFloat(document.getElementById('sbr_depth').value) || 18;
  const decDepth = parseFloat(document.getElementById('sbr_decdepth').value) || 4;
  
  // Sludge volume after settling
  const sludgeVolPct = (mlss * svi) / 10000;
  const blanketHeight = depth * (sludgeVolPct / 100);
  const clearWater = depth - blanketHeight;
  const settleVel = (depth - blanketHeight) / (settleTime / 60);
  const margin = clearWater - decDepth;
  
  document.getElementById('r_sbr_blanket').textContent = blanketHeight.toFixed(1);
  document.getElementById('r_sbr_clear').textContent = clearWater.toFixed(1);
  document.getElementById('r_sbr_sv').textContent = settleVel.toFixed(1);
  document.getElementById('r_sbr_margin').textContent = margin.toFixed(1);
  document.getElementById('r_sbr_sludgevol').textContent = sludgeVolPct.toFixed(1);
  
  document.getElementById('s_sbr_blanket').textContent = blanketHeight < depth * 0.5 ? '‚úì Good' : '‚ö† High';
  document.getElementById('s_sbr_blanket').className = 'status ' + (blanketHeight < depth * 0.5 ? 'ok' : 'warn');
  document.getElementById('s_sbr_clear').textContent = clearWater > 6 ? '‚úì Good' : '‚ö† Low';
  document.getElementById('s_sbr_clear').className = 'status ' + (clearWater > 6 ? 'ok' : 'warn');
  document.getElementById('s_sbr_margin').textContent = margin > 2 ? '‚úì Safe' : margin > 0 ? '‚ö† Tight' : '‚úó Risk';
  document.getElementById('s_sbr_margin').className = 'status ' + (margin > 2 ? 'ok' : margin > 0 ? 'warn' : 'bad');
}

function resetSBRSettle() {
  ['sbr_set_mlss','sbr_svi','sbr_set_time','sbr_depth','sbr_decdepth'].forEach((id,i) => {
    document.getElementById(id).value = ['3500','120','60','18','4'][i];
  });
  ['r_sbr_blanket','r_sbr_clear','r_sbr_sv','r_sbr_margin','r_sbr_sludgevol','s_sbr_blanket','s_sbr_clear','s_sbr_margin'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcSBRLoading() {
  const flow = parseFloat(document.getElementById('sbr_ld_flow').value) || 2;
  const bod = parseFloat(document.getElementById('sbr_ld_bod').value) || 200;
  const vol = parseFloat(document.getElementById('sbr_ld_vol').value) || 0.5;
  const basins = parseInt(document.getElementById('sbr_ld_basins').value) || 2;
  const mlss = parseFloat(document.getElementById('sbr_ld_mlss').value) || 3500;
  const vssRatio = parseFloat(document.getElementById('sbr_ld_vss').value) || 0.8;
  
  const totalVol = vol * basins;
  const bodLoad = flow * bod * 8.34;
  const mlvss = mlss * vssRatio;
  const inventory = totalVol * mlss * 8.34;
  const mlvssInv = totalVol * mlvss * 8.34;
  const fm = bodLoad / mlvssInv;
  const vlr = bodLoad / (totalVol * 1000000 / 7.48 / 1000);
  const hrt = (totalVol / flow) * 24;
  
  document.getElementById('r_sbr_fm').textContent = fm.toFixed(3);
  document.getElementById('r_sbr_vlr').textContent = vlr.toFixed(1);
  document.getElementById('r_sbr_inv').textContent = inventory.toFixed(0);
  document.getElementById('r_sbr_bodload').textContent = bodLoad.toFixed(0);
  document.getElementById('r_sbr_syshrt').textContent = hrt.toFixed(1);
  
  document.getElementById('s_sbr_fm').textContent = fm >= 0.05 && fm <= 0.15 ? '‚úì Extended Air' : fm > 0.15 && fm <= 0.4 ? '‚úì Conv.' : '‚ö† Check';
  document.getElementById('s_sbr_fm').className = 'status ' + (fm >= 0.05 && fm <= 0.4 ? 'ok' : 'warn');
  document.getElementById('s_sbr_vlr').textContent = vlr < 40 ? '‚úì Normal' : '‚ö† High';
  document.getElementById('s_sbr_vlr').className = 'status ' + (vlr < 40 ? 'ok' : 'warn');
}

function resetSBRLoading() {
  ['sbr_ld_flow','sbr_ld_bod','sbr_ld_vol','sbr_ld_basins','sbr_ld_mlss','sbr_ld_vss'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','200','0.5','2','3500','0.8'][i];
  });
  ['r_sbr_fm','r_sbr_vlr','r_sbr_inv','r_sbr_bodload','r_sbr_syshrt','s_sbr_fm','s_sbr_vlr'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcSBRWAS() {
  const vol = parseFloat(document.getElementById('sbr_was_vol').value) || 1;
  const mlss = parseFloat(document.getElementById('sbr_was_mlss').value) || 3500;
  const srt = parseFloat(document.getElementById('sbr_was_srt').value) || 15;
  const effTss = parseFloat(document.getElementById('sbr_was_tss').value) || 10;
  const effFlow = parseFloat(document.getElementById('sbr_was_flow').value) || 2;
  
  const inventory = vol * mlss * 8.34;
  const effLoss = effFlow * effTss * 8.34;
  const wasReq = (inventory / srt) - effLoss;
  const wasGpd = (wasReq / (mlss * 8.34)) * 1000000;
  
  // Assume 4 cycles per day
  const cyclesPerDay = 4;
  const wasPerCycle = wasGpd / cyclesPerDay;
  
  document.getElementById('r_sbr_was_inv').textContent = inventory.toFixed(0);
  document.getElementById('r_sbr_was_eff').textContent = effLoss.toFixed(0);
  document.getElementById('r_sbr_was_req').textContent = wasReq.toFixed(0);
  document.getElementById('r_sbr_was_gpd').textContent = wasGpd.toFixed(0);
  document.getElementById('r_sbr_was_cycle').textContent = wasPerCycle.toFixed(0);
}

function resetSBRWAS() {
  ['sbr_was_vol','sbr_was_mlss','sbr_was_srt','sbr_was_tss','sbr_was_flow'].forEach((id,i) => {
    document.getElementById(id).value = ['1.0','3500','15','10','2.0'][i];
  });
  ['r_sbr_was_inv','r_sbr_was_eff','r_sbr_was_req','r_sbr_was_gpd','r_sbr_was_cycle'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcSBRNutrients() {
  const tkn = parseFloat(document.getElementById('sbr_tkn').value) || 40;
  const nh3Eff = parseFloat(document.getElementById('sbr_nh3_eff').value) || 1;
  const no3 = parseFloat(document.getElementById('sbr_no3').value) || 8;
  const tpIn = parseFloat(document.getElementById('sbr_tp_in').value) || 6;
  const tpEff = parseFloat(document.getElementById('sbr_tp_eff').value) || 1;
  const anoxic = parseFloat(document.getElementById('sbr_anoxic').value) || 45;
  const anaerobic = parseFloat(document.getElementById('sbr_anaerobic').value) || 30;
  
  const effTN = nh3Eff + no3;
  const tnRemoval = ((tkn - effTN) / tkn) * 100;
  const nitrification = ((tkn - nh3Eff) / tkn) * 100;
  const denitrification = anoxic > 30 ? ((tkn - nh3Eff - no3) / (tkn - nh3Eff)) * 100 : 0;
  const tpRemoval = ((tpIn - tpEff) / tpIn) * 100;
  const pRelease = anaerobic > 20 ? tpIn * 3 : 0; // P release in anaerobic zone
  const bioP = tpIn - tpEff;
  
  document.getElementById('r_sbr_tn_rem').textContent = tnRemoval.toFixed(1);
  document.getElementById('r_sbr_nitr').textContent = nitrification.toFixed(1);
  document.getElementById('r_sbr_denitr').textContent = denitrification.toFixed(1);
  document.getElementById('r_sbr_tp_rem').textContent = tpRemoval.toFixed(1);
  document.getElementById('r_sbr_prel').textContent = pRelease.toFixed(1);
  document.getElementById('r_sbr_biop').textContent = bioP.toFixed(1);
  
  document.getElementById('s_sbr_tn').textContent = tnRemoval > 70 ? '‚úì Good' : tnRemoval > 50 ? '‚ö† Moderate' : '‚úó Low';
  document.getElementById('s_sbr_tn').className = 'status ' + (tnRemoval > 70 ? 'ok' : tnRemoval > 50 ? 'warn' : 'bad');
  document.getElementById('s_sbr_tp').textContent = tpRemoval > 80 ? '‚úì Good' : tpRemoval > 60 ? '‚ö† Moderate' : '‚úó Low';
  document.getElementById('s_sbr_tp').className = 'status ' + (tpRemoval > 80 ? 'ok' : tpRemoval > 60 ? 'warn' : 'bad');
}

function resetSBRNutrients() {
  ['sbr_tkn','sbr_nh3_eff','sbr_no3','sbr_tp_in','sbr_tp_eff','sbr_anoxic','sbr_anaerobic'].forEach((id,i) => {
    document.getElementById(id).value = ['40','1','8','6','1','45','30'][i];
  });
  ['r_sbr_tn_rem','r_sbr_nitr','r_sbr_denitr','r_sbr_tp_rem','r_sbr_prel','r_sbr_biop','s_sbr_tn','s_sbr_tp'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}



// ==================== MBR FUNCTIONS (continued) ====================

function calcMBRCleaning() {
  const permInit = parseFloat(document.getElementById('mbr_perm_init').value) || 8;
  const permCurr = parseFloat(document.getElementById('mbr_perm_curr').value) || 5;
  const permClean = parseFloat(document.getElementById('mbr_perm_clean').value) || 7;
  const daysCIP = parseFloat(document.getElementById('mbr_days_cip').value) || 30;
  const age = parseFloat(document.getElementById('mbr_age').value) || 36;
  
  const foulRate = (permInit - permCurr) / daysCIP;
  const revFoul = ((permClean - permCurr) / (permInit - permCurr)) * 100;
  const irrFoul = ((permInit - permClean) / permInit) * 100;
  const cipEff = ((permClean - permCurr) / (permInit - permCurr)) * 100;
  
  // Days until permeability drops to 2 GFD/psi (trigger point)
  const targetPerm = 2.5;
  const daysToClean = foulRate > 0 ? (permCurr - targetPerm) / foulRate : 999;
  
  // Health score
  const health = permCurr > 4 ? 'Good' : permCurr > 2.5 ? 'Fair' : 'Poor';
  
  document.getElementById('r_mbr_foul_rate').textContent = foulRate.toFixed(3);
  document.getElementById('r_mbr_rev_foul').textContent = revFoul.toFixed(1);
  document.getElementById('r_mbr_irr_foul').textContent = irrFoul.toFixed(1);
  document.getElementById('r_mbr_cip_eff').textContent = cipEff.toFixed(1);
  document.getElementById('r_mbr_days_cip').textContent = daysToClean > 0 ? daysToClean.toFixed(0) : 'N/A';
  document.getElementById('r_mbr_health').textContent = health;
  
  document.getElementById('s_mbr_foul').textContent = foulRate < 0.05 ? '‚úì Normal' : foulRate < 0.1 ? '‚ö† Elevated' : '‚úó High';
  document.getElementById('s_mbr_foul').className = 'status ' + (foulRate < 0.05 ? 'ok' : foulRate < 0.1 ? 'warn' : 'bad');
  document.getElementById('s_mbr_irr').textContent = irrFoul < 15 ? '‚úì Normal' : irrFoul < 30 ? '‚ö† Aging' : '‚úó Replace Soon';
  document.getElementById('s_mbr_irr').className = 'status ' + (irrFoul < 15 ? 'ok' : irrFoul < 30 ? 'warn' : 'bad');
  document.getElementById('s_mbr_health').textContent = health === 'Good' ? '‚úì' : health === 'Fair' ? '‚ö†' : '‚úó';
  document.getElementById('s_mbr_health').className = 'status ' + (health === 'Good' ? 'ok' : health === 'Fair' ? 'warn' : 'bad');
}

function resetMBRCleaning() {
  ['mbr_perm_init','mbr_perm_curr','mbr_perm_clean','mbr_days_cip','mbr_age'].forEach((id,i) => {
    document.getElementById(id).value = ['8','5','7','30','36'][i];
  });
  ['r_mbr_foul_rate','r_mbr_rev_foul','r_mbr_irr_foul','r_mbr_cip_eff','r_mbr_days_cip','r_mbr_health'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBRLoading() {
  const flow = parseFloat(document.getElementById('mbr_ld_flow').value) || 2;
  const bod = parseFloat(document.getElementById('mbr_ld_bod').value) || 200;
  const vol = parseFloat(document.getElementById('mbr_ld_vol').value) || 0.8;
  const mlss = parseFloat(document.getElementById('mbr_ld_mlss').value) || 10000;
  const vssRatio = parseFloat(document.getElementById('mbr_ld_vss').value) || 0.8;
  const wasFlow = parseFloat(document.getElementById('mbr_ld_was').value) || 10000;
  const wasTss = parseFloat(document.getElementById('mbr_ld_wastss').value) || 10000;
  
  const mlvss = mlss * vssRatio;
  const bodLoad = flow * bod * 8.34;
  const inventory = vol * mlss * 8.34;
  const mlvssInv = vol * mlvss * 8.34;
  const fm = bodLoad / mlvssInv;
  const vlr = bodLoad / (vol * 1000000 / 7.48 / 1000);
  const hrt = (vol / flow) * 24;
  
  // SRT = Inventory / WAS rate
  const wasLb = wasFlow * wasTss * 8.34 / 1000000;
  const srt = inventory / wasLb;
  
  // Sludge production
  const sludgeProd = wasLb;
  
  document.getElementById('r_mbr_fm').textContent = fm.toFixed(3);
  document.getElementById('r_mbr_vlr').textContent = vlr.toFixed(1);
  document.getElementById('r_mbr_hrt').textContent = hrt.toFixed(1);
  document.getElementById('r_mbr_srt').textContent = srt.toFixed(1);
  document.getElementById('r_mbr_inv').textContent = inventory.toFixed(0);
  document.getElementById('r_mbr_sludge').textContent = sludgeProd.toFixed(0);
  
  document.getElementById('s_mbr_fm').textContent = fm >= 0.05 && fm <= 0.15 ? '‚úì Typical MBR' : fm < 0.05 ? '‚ö† Low' : '‚úó High';
  document.getElementById('s_mbr_fm').className = 'status ' + (fm >= 0.05 && fm <= 0.15 ? 'ok' : 'warn');
  document.getElementById('s_mbr_hrt').textContent = hrt >= 4 && hrt <= 12 ? '‚úì Normal' : '‚ö† Check';
  document.getElementById('s_mbr_hrt').className = 'status ' + (hrt >= 4 && hrt <= 12 ? 'ok' : 'warn');
  document.getElementById('s_mbr_srt').textContent = srt >= 10 && srt <= 30 ? '‚úì Normal' : srt > 30 ? '‚ö† Long' : '‚ö† Short';
  document.getElementById('s_mbr_srt').className = 'status ' + (srt >= 10 && srt <= 30 ? 'ok' : 'warn');
}

function resetMBRLoading() {
  ['mbr_ld_flow','mbr_ld_bod','mbr_ld_vol','mbr_ld_mlss','mbr_ld_vss','mbr_ld_was','mbr_ld_wastss'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','200','0.8','10000','0.8','10000','10000'][i];
  });
  ['r_mbr_fm','r_mbr_vlr','r_mbr_hrt','r_mbr_srt','r_mbr_inv','r_mbr_sludge'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBREnergy() {
  const flow = parseFloat(document.getElementById('mbr_en_flow').value) || 2;
  const blowHP = parseFloat(document.getElementById('mbr_blow_hp').value) || 100;
  const scourHP = parseFloat(document.getElementById('mbr_scour_hp').value) || 75;
  const permHP = parseFloat(document.getElementById('mbr_perm_hp').value) || 25;
  const recircHP = parseFloat(document.getElementById('mbr_recirc_hp').value) || 15;
  const hrs = parseFloat(document.getElementById('mbr_hrs').value) || 24;
  const rate = parseFloat(document.getElementById('mbr_rate').value) || 0.10;
  
  const blowKWH = (blowHP + scourHP) * 0.746 * hrs;
  const pumpKWH = (permHP + recircHP) * 0.746 * hrs;
  const totalKWH = blowKWH + pumpKWH;
  const specEnergy = totalKWH / (flow * 1000); // kWh/kgal
  const dailyCost = totalKWH * rate;
  const monthlyCost = dailyCost * 30;
  
  document.getElementById('r_mbr_blow_kwh').textContent = blowKWH.toFixed(0);
  document.getElementById('r_mbr_pump_kwh').textContent = pumpKWH.toFixed(0);
  document.getElementById('r_mbr_tot_kwh').textContent = totalKWH.toFixed(0);
  document.getElementById('r_mbr_spec_en').textContent = specEnergy.toFixed(2);
  document.getElementById('r_mbr_cost_day').textContent = dailyCost.toFixed(2);
  document.getElementById('r_mbr_cost_mo').textContent = monthlyCost.toFixed(0);
  
  document.getElementById('s_mbr_spec').textContent = specEnergy < 1.5 ? '‚úì Efficient' : specEnergy < 2.5 ? '‚ö† Typical' : '‚úó High';
  document.getElementById('s_mbr_spec').className = 'status ' + (specEnergy < 1.5 ? 'ok' : specEnergy < 2.5 ? 'warn' : 'bad');
}

function resetMBREnergy() {
  ['mbr_en_flow','mbr_blow_hp','mbr_scour_hp','mbr_perm_hp','mbr_recirc_hp','mbr_hrs','mbr_rate'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','100','75','25','15','24','0.10'][i];
  });
  ['r_mbr_blow_kwh','r_mbr_pump_kwh','r_mbr_tot_kwh','r_mbr_spec_en','r_mbr_cost_day','r_mbr_cost_mo'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function diagnoseMBR() {
  const tmpTrend = document.getElementById('mbr_tmp_trend').value;
  const permTrend = document.getElementById('mbr_perm_trend').value;
  const foam = document.getElementById('mbr_foam').value;
  const color = document.getElementById('mbr_color').value;
  
  let diagnosis = [];
  let actions = [];
  
  // TMP analysis
  if (tmpTrend === 'rapid' || tmpTrend === 'sudden') {
    diagnosis.push('‚ö†Ô∏è <b>High TMP increase detected</b> - indicates fouling');
    if (tmpTrend === 'sudden') {
      actions.push('Check for membrane damage or clogged aerators');
      actions.push('Perform emergency maintenance clean');
    } else {
      actions.push('Schedule CIP within 1-2 days');
      actions.push('Increase scour air temporarily');
    }
  }
  
  // Permeability analysis
  if (permTrend === 'low') {
    diagnosis.push('‚ö†Ô∏è <b>Low permeability</b> - significant fouling present');
    actions.push('Perform recovery clean (NaOCl + citric acid)');
    actions.push('Consider membrane replacement if >5 years old');
  } else if (permTrend === 'declining') {
    diagnosis.push('üìâ <b>Declining permeability</b> - monitor closely');
    actions.push('Increase maintenance clean frequency');
  }
  
  // Foam analysis
  if (foam === 'heavy') {
    diagnosis.push('ü´ß <b>Heavy brown foam</b> - Nocardia/filamentous growth');
    actions.push('Reduce SRT to 12-15 days');
    actions.push('Add chlorine to RAS (2-5 mg/L)');
    actions.push('Increase WAS rate');
  } else if (foam === 'white') {
    diagnosis.push('ü´ß <b>White foam</b> - surfactant/detergent in influent');
    actions.push('Check for industrial discharge');
    actions.push('May need additional pretreatment');
  }
  
  // Color analysis
  if (color === 'dark') {
    diagnosis.push('üîò <b>Dark/black mixed liquor</b> - septic conditions');
    actions.push('Increase aeration immediately');
    actions.push('Check blowers and diffusers');
  } else if (color === 'gray') {
    diagnosis.push('‚ö™ <b>Gray mixed liquor</b> - low DO or toxic shock');
    actions.push('Check DO levels (maintain >2 mg/L)');
    actions.push('Review influent for toxic discharge');
  } else if (color === 'light') {
    diagnosis.push('üíß <b>Light/thin mixed liquor</b> - washout or low MLSS');
    actions.push('Reduce WAS rate');
    actions.push('Check for high flows or poor settling');
  }
  
  if (diagnosis.length === 0) {
    diagnosis.push('‚úÖ <b>System appears normal</b>');
    actions.push('Continue routine monitoring');
  }
  
  const diagDiv = document.getElementById('mbr_diagnosis');
  const contentDiv = document.getElementById('mbr_diag_content');
  contentDiv.innerHTML = '<p><b>Issues Detected:</b></p><ul>' + 
    diagnosis.map(d => '<li>' + d + '</li>').join('') + '</ul>' +
    '<p style="margin-top:10px"><b>Recommended Actions:</b></p><ul>' +
    actions.map(a => '<li>' + a + '</li>').join('') + '</ul>';
  diagDiv.style.display = 'block';
}



// ==================== MBBR FUNCTIONS ====================

function calcMBBRMedia() {
  const vol = parseFloat(document.getElementById('mbbr_vol').value) || 0.5;
  const fillPct = parseFloat(document.getElementById('mbbr_fill').value) || 50;
  const ssa = parseFloat(document.getElementById('mbbr_ssa').value) || 500;
  const activeFrac = parseFloat(document.getElementById('mbbr_active').value) || 0.67;
  
  // Media type presets
  const mediaType = document.getElementById('mbbr_media_type').value;
  let actualSSA = ssa;
  if (mediaType === 'k1' || mediaType === 'k3') actualSSA = 500;
  else if (mediaType === 'k5') actualSSA = 800;
  else if (mediaType === 'biofilm_chip') actualSSA = 3000;
  else if (mediaType === 'anoxk') actualSSA = 650;
  
  const volCF = vol * 1000000 / 7.48;
  const mediaVol = volCF * (fillPct / 100);
  const mediaVolM3 = mediaVol * 0.0283;
  
  // Total surface area
  const totalSA = mediaVolM3 * actualSSA; // m¬≤
  const totalSAsf = totalSA * 10.764; // sq ft
  const activeSA = totalSA * activeFrac;
  const activeSAsf = activeSA * 10.764;
  
  const mediaQty = mediaVol / 27; // cu yd
  
  document.getElementById('r_mbbr_vol_cf').textContent = volCF.toFixed(0);
  document.getElementById('r_mbbr_media_vol').textContent = mediaVol.toFixed(0);
  document.getElementById('r_mbbr_tsa').textContent = totalSAsf.toFixed(0);
  document.getElementById('r_mbbr_asa').textContent = activeSAsf.toFixed(0);
  document.getElementById('r_mbbr_asa_m2').textContent = activeSA.toFixed(0);
  document.getElementById('r_mbbr_media_qty').textContent = mediaQty.toFixed(0);
}

function resetMBBRMedia() {
  ['mbbr_vol','mbbr_fill','mbbr_ssa','mbbr_active'].forEach((id,i) => {
    document.getElementById(id).value = ['0.5','50','500','0.67'][i];
  });
  document.getElementById('mbbr_media_type').value = 'k1';
  ['r_mbbr_vol_cf','r_mbbr_media_vol','r_mbbr_tsa','r_mbbr_asa','r_mbbr_asa_m2','r_mbbr_media_qty'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBBRBOD() {
  const flow = parseFloat(document.getElementById('mbbr_bod_flow').value) || 2;
  const bodIn = parseFloat(document.getElementById('mbbr_bod_in').value) || 200;
  const bodOut = parseFloat(document.getElementById('mbbr_bod_out').value) || 20;
  const temp = parseFloat(document.getElementById('mbbr_bod_temp').value) || 15;
  const targetDO = parseFloat(document.getElementById('mbbr_do').value) || 3;
  const sarRate = parseFloat(document.getElementById('mbbr_sar').value) || 15;
  
  const bodLoad = flow * bodIn * 8.34;
  const bodRemoval = flow * (bodIn - bodOut) * 8.34;
  const bodRemovalKg = bodRemoval / 2.205;
  
  // Temperature correction (theta = 1.06 for BOD)
  const tempCF = Math.pow(1.06, temp - 15);
  const correctedRate = sarRate * tempCF;
  
  // Surface area required
  const saRequired = (bodRemovalKg * 1000) / correctedRate; // m¬≤
  
  // Assume we have area from media calc or use default
  const assumedSA = 5000; // m¬≤ default
  const appliedSALR = (bodRemovalKg * 1000) / assumedSA;
  
  const bodEff = ((bodIn - bodOut) / bodIn) * 100;
  
  document.getElementById('r_mbbr_bod_load').textContent = bodLoad.toFixed(0);
  document.getElementById('r_mbbr_bod_rem').textContent = bodRemoval.toFixed(0);
  document.getElementById('r_mbbr_sa_req').textContent = saRequired.toFixed(0);
  document.getElementById('r_mbbr_salr').textContent = appliedSALR.toFixed(1);
  document.getElementById('r_mbbr_temp_cf').textContent = tempCF.toFixed(2);
  document.getElementById('r_mbbr_bod_eff').textContent = bodEff.toFixed(1);
  
  document.getElementById('s_mbbr_salr').textContent = appliedSALR <= 20 ? '‚úì Normal' : appliedSALR <= 30 ? '‚ö† High' : '‚úó Overloaded';
  document.getElementById('s_mbbr_salr').className = 'status ' + (appliedSALR <= 20 ? 'ok' : appliedSALR <= 30 ? 'warn' : 'bad');
}

function resetMBBRBOD() {
  ['mbbr_bod_flow','mbbr_bod_in','mbbr_bod_out','mbbr_bod_temp','mbbr_do','mbbr_sar'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','200','20','15','3','15'][i];
  });
  ['r_mbbr_bod_load','r_mbbr_bod_rem','r_mbbr_sa_req','r_mbbr_salr','r_mbbr_temp_cf','r_mbbr_bod_eff'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBBRNitrif() {
  const flow = parseFloat(document.getElementById('mbbr_nit_flow').value) || 2;
  const nh3In = parseFloat(document.getElementById('mbbr_nh3_in').value) || 30;
  const nh3Out = parseFloat(document.getElementById('mbbr_nh3_out').value) || 2;
  const temp = parseFloat(document.getElementById('mbbr_nit_temp').value) || 15;
  const targetDO = parseFloat(document.getElementById('mbbr_nit_do').value) || 4;
  const nitRate = parseFloat(document.getElementById('mbbr_nit_rate').value) || 1.2;
  const availSA = parseFloat(document.getElementById('mbbr_nit_sa').value) || 5000;
  
  const nh3Load = flow * nh3In * 8.34;
  const nh3Removal = flow * (nh3In - nh3Out) * 8.34;
  const nh3RemovalKg = nh3Removal / 2.205;
  
  // Temperature correction (theta = 1.098 for nitrification)
  const tempCF = Math.pow(1.098, temp - 15);
  const correctedRate = nitRate * tempCF;
  
  // DO limitation
  const doFactor = targetDO / (targetDO + 1.0);
  const effectiveRate = correctedRate * doFactor;
  
  const saRequired = (nh3RemovalKg * 1000) / effectiveRate;
  const appliedSANR = (nh3RemovalKg * 1000) / availSA;
  const utilization = (saRequired / availSA) * 100;
  
  // Alkalinity consumed: 7.14 lb CaCO3 / lb NH3-N
  const alkConsumed = nh3Removal * 7.14;
  
  document.getElementById('r_mbbr_nh3_load').textContent = nh3Load.toFixed(0);
  document.getElementById('r_mbbr_nh3_rem').textContent = nh3Removal.toFixed(0);
  document.getElementById('r_mbbr_nit_sa_req').textContent = saRequired.toFixed(0);
  document.getElementById('r_mbbr_sanr').textContent = appliedSANR.toFixed(2);
  document.getElementById('r_mbbr_nit_util').textContent = utilization.toFixed(1);
  document.getElementById('r_mbbr_alk').textContent = alkConsumed.toFixed(0);
  
  document.getElementById('s_mbbr_sanr').textContent = appliedSANR <= 1.5 ? '‚úì Normal' : appliedSANR <= 2.5 ? '‚ö† High' : '‚úó Overloaded';
  document.getElementById('s_mbbr_sanr').className = 'status ' + (appliedSANR <= 1.5 ? 'ok' : appliedSANR <= 2.5 ? 'warn' : 'bad');
  document.getElementById('s_mbbr_nit_util').textContent = utilization <= 80 ? '‚úì Capacity' : utilization <= 100 ? '‚ö† Near Limit' : '‚úó Over';
  document.getElementById('s_mbbr_nit_util').className = 'status ' + (utilization <= 80 ? 'ok' : utilization <= 100 ? 'warn' : 'bad');
}

function resetMBBRNitrif() {
  ['mbbr_nit_flow','mbbr_nh3_in','mbbr_nh3_out','mbbr_nit_temp','mbbr_nit_do','mbbr_nit_rate','mbbr_nit_sa'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','30','2','15','4','1.2','5000'][i];
  });
  ['r_mbbr_nh3_load','r_mbbr_nh3_rem','r_mbbr_nit_sa_req','r_mbbr_sanr','r_mbbr_nit_util','r_mbbr_alk'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBBRAeration() {
  const flow = parseFloat(document.getElementById('mbbr_air_flow').value) || 2;
  const bodRem = parseFloat(document.getElementById('mbbr_air_bod').value) || 180;
  const nh3Rem = parseFloat(document.getElementById('mbbr_air_nh3').value) || 28;
  const vol = parseFloat(document.getElementById('mbbr_air_vol').value) || 0.5;
  const targetDO = parseFloat(document.getElementById('mbbr_air_do').value) || 4;
  const alpha = parseFloat(document.getElementById('mbbr_air_alpha').value) || 0.55;
  const ote = parseFloat(document.getElementById('mbbr_air_ote').value) || 25;
  
  // O2 demands
  const cod2 = flow * bodRem * 8.34 * 1.2; // 1.2 lb O2/lb BOD
  const nod2 = flow * nh3Rem * 8.34 * 4.6; // 4.6 lb O2/lb N
  const aor = cod2 + nod2;
  
  // SOTR (alpha correction)
  const sotr = aor / alpha;
  const sotrHr = sotr / 24;
  
  // Air required
  const airReq = sotrHr / (0.075 * 0.232 * (ote/100)) / 60;
  
  // Mixing air (rule of thumb: 1 SCFM per cu ft of media at 50% fill)
  const mediaVol = vol * 1000000 / 7.48 * 0.5; // cu ft
  const mixAir = mediaVol * 0.5; // Reduced factor for MBBR
  
  const totalAir = Math.max(airReq, mixAir);
  
  document.getElementById('r_mbbr_cod2').textContent = cod2.toFixed(0);
  document.getElementById('r_mbbr_nod2').textContent = nod2.toFixed(0);
  document.getElementById('r_mbbr_aor').textContent = aor.toFixed(0);
  document.getElementById('r_mbbr_sotr').textContent = sotrHr.toFixed(1);
  document.getElementById('r_mbbr_air').textContent = airReq.toFixed(0);
  document.getElementById('r_mbbr_mix_air').textContent = mixAir.toFixed(0);
  document.getElementById('r_mbbr_tot_air').textContent = totalAir.toFixed(0);
}

function resetMBBRAeration() {
  ['mbbr_air_flow','mbbr_air_bod','mbbr_air_nh3','mbbr_air_vol','mbbr_air_do','mbbr_air_alpha','mbbr_air_ote'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','180','28','0.5','4','0.55','25'][i];
  });
  ['r_mbbr_cod2','r_mbbr_nod2','r_mbbr_aor','r_mbbr_sotr','r_mbbr_air','r_mbbr_mix_air','r_mbbr_tot_air'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBBRHydraulics() {
  const flow = parseFloat(document.getElementById('mbbr_hyd_flow').value) || 2;
  const vol = parseFloat(document.getElementById('mbbr_hyd_vol').value) || 0.5;
  const num = parseInt(document.getElementById('mbbr_hyd_num').value) || 2;
  const length = parseFloat(document.getElementById('mbbr_hyd_l').value) || 60;
  const width = parseFloat(document.getElementById('mbbr_hyd_w').value) || 30;
  const swd = parseFloat(document.getElementById('mbbr_hyd_d').value) || 18;
  const screen = parseFloat(document.getElementById('mbbr_screen').value) || 8;
  
  const totalVol = vol * num;
  const hrt = (totalVol / flow) * 24;
  const hrtEach = hrt / num;
  
  // Velocity at screen (assume full width screen)
  const flowCFS = flow * 1000000 / 7.48 / 86400;
  const screenArea = width * swd * 0.5; // 50% open area typical
  const velocity = flowCFS / screenArea;
  
  const lwRatio = length / width;
  const dwRatio = swd / width;
  
  document.getElementById('r_mbbr_tot_vol').textContent = totalVol.toFixed(2);
  document.getElementById('r_mbbr_hrt').textContent = hrt.toFixed(1);
  document.getElementById('r_mbbr_hrt_each').textContent = hrtEach.toFixed(1);
  document.getElementById('r_mbbr_vel').textContent = velocity.toFixed(2);
  document.getElementById('r_mbbr_lw').textContent = lwRatio.toFixed(1);
  document.getElementById('r_mbbr_dw').textContent = dwRatio.toFixed(2);
  
  document.getElementById('s_mbbr_hrt').textContent = hrt >= 1 && hrt <= 6 ? '‚úì Normal' : '‚ö† Check';
  document.getElementById('s_mbbr_hrt').className = 'status ' + (hrt >= 1 && hrt <= 6 ? 'ok' : 'warn');
  document.getElementById('s_mbbr_vel').textContent = velocity < 1.0 ? '‚úì OK' : velocity < 2.0 ? '‚ö† High' : '‚úó Too High';
  document.getElementById('s_mbbr_vel').className = 'status ' + (velocity < 1.0 ? 'ok' : velocity < 2.0 ? 'warn' : 'bad');
  document.getElementById('s_mbbr_lw').textContent = lwRatio >= 1.5 && lwRatio <= 3 ? '‚úì Good' : '‚ö† Check';
  document.getElementById('s_mbbr_lw').className = 'status ' + (lwRatio >= 1.5 && lwRatio <= 3 ? 'ok' : 'warn');
}

function resetMBBRHydraulics() {
  ['mbbr_hyd_flow','mbbr_hyd_vol','mbbr_hyd_num','mbbr_hyd_l','mbbr_hyd_w','mbbr_hyd_d','mbbr_screen'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','0.5','2','60','30','18','8'][i];
  });
  ['r_mbbr_tot_vol','r_mbbr_hrt','r_mbbr_hrt_each','r_mbbr_vel','r_mbbr_lw','r_mbbr_dw'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBBRPerf() {
  const bodIn = parseFloat(document.getElementById('mbbr_perf_bod_in').value) || 200;
  const bodOut = parseFloat(document.getElementById('mbbr_perf_bod_out').value) || 15;
  const nh3In = parseFloat(document.getElementById('mbbr_perf_nh3_in').value) || 30;
  const nh3Out = parseFloat(document.getElementById('mbbr_perf_nh3_out').value) || 1;
  const flow = parseFloat(document.getElementById('mbbr_perf_flow').value) || 2;
  const sa = parseFloat(document.getElementById('mbbr_perf_sa').value) || 5000;
  const temp = parseFloat(document.getElementById('mbbr_perf_temp').value) || 18;
  
  const bodRem = ((bodIn - bodOut) / bodIn) * 100;
  const nh3Rem = ((nh3In - nh3Out) / nh3In) * 100;
  
  // Actual rates (g/m¬≤/d)
  const bodLoadKg = flow * bodIn * 8.34 / 2.205;
  const nh3LoadKg = flow * nh3In * 8.34 / 2.205;
  const salr = (bodLoadKg * 1000) / sa;
  const sanr = (nh3LoadKg * 1000) / sa;
  
  // Removal rates
  const bodRemKg = flow * (bodIn - bodOut) * 8.34 / 2.205;
  const nh3RemKg = flow * (nh3In - nh3Out) * 8.34 / 2.205;
  const rr = (bodRemKg * 1000) / sa;
  const nr = (nh3RemKg * 1000) / sa;
  
  document.getElementById('r_mbbr_perf_bod').textContent = bodRem.toFixed(1);
  document.getElementById('r_mbbr_perf_nh3').textContent = nh3Rem.toFixed(1);
  document.getElementById('r_mbbr_perf_salr').textContent = salr.toFixed(1);
  document.getElementById('r_mbbr_perf_sanr').textContent = sanr.toFixed(2);
  document.getElementById('r_mbbr_perf_rr').textContent = rr.toFixed(1);
  document.getElementById('r_mbbr_perf_nr').textContent = nr.toFixed(2);
  
  document.getElementById('s_mbbr_perf_bod').textContent = bodRem > 85 ? '‚úì Excellent' : bodRem > 70 ? '‚úì Good' : '‚ö† Low';
  document.getElementById('s_mbbr_perf_bod').className = 'status ' + (bodRem > 70 ? 'ok' : 'warn');
  document.getElementById('s_mbbr_perf_nh3').textContent = nh3Rem > 90 ? '‚úì Excellent' : nh3Rem > 75 ? '‚úì Good' : '‚ö† Low';
  document.getElementById('s_mbbr_perf_nh3').className = 'status ' + (nh3Rem > 75 ? 'ok' : 'warn');
  document.getElementById('s_mbbr_perf_rr').textContent = rr >= 5 && rr <= 20 ? '‚úì Normal' : '‚ö† Check';
  document.getElementById('s_mbbr_perf_rr').className = 'status ' + (rr >= 5 && rr <= 20 ? 'ok' : 'warn');
  document.getElementById('s_mbbr_perf_nr').textContent = nr >= 0.5 && nr <= 2 ? '‚úì Normal' : '‚ö† Check';
  document.getElementById('s_mbbr_perf_nr').className = 'status ' + (nr >= 0.5 && nr <= 2 ? 'ok' : 'warn');
}

function resetMBBRPerf() {
  ['mbbr_perf_bod_in','mbbr_perf_bod_out','mbbr_perf_nh3_in','mbbr_perf_nh3_out','mbbr_perf_flow','mbbr_perf_sa','mbbr_perf_temp'].forEach((id,i) => {
    document.getElementById(id).value = ['200','15','30','1','2.0','5000','18'][i];
  });
  ['r_mbbr_perf_bod','r_mbbr_perf_nh3','r_mbbr_perf_salr','r_mbbr_perf_sanr','r_mbbr_perf_rr','r_mbbr_perf_nr'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcIFAS() {
  const flow = parseFloat(document.getElementById('ifas_flow').value) || 3;
  const vol = parseFloat(document.getElementById('ifas_vol').value) || 1;
  const mlss = parseFloat(document.getElementById('ifas_mlss').value) || 3000;
  const fillPct = parseFloat(document.getElementById('ifas_fill').value) || 40;
  const ssa = parseFloat(document.getElementById('ifas_ssa').value) || 500;
  const bodLoad = parseFloat(document.getElementById('ifas_bod').value) || 5000;
  
  // Suspended biomass
  const suspBio = vol * mlss * 8.34;
  
  // Media surface area
  const volCF = vol * 1000000 / 7.48;
  const mediaVol = volCF * (fillPct / 100) * 0.0283; // m¬≥
  const surfaceArea = mediaVol * ssa * 0.67; // active m¬≤
  
  // Attached biomass estimate (10 g/m¬≤ typical biofilm density)
  const attBio = surfaceArea * 10 / 453.6; // lbs
  
  const totalBio = suspBio + attBio;
  
  // Effective MLSS
  const effMLSS = (totalBio / (vol * 8.34));
  
  // Combined F/M
  const fm = bodLoad / (totalBio * 0.8); // VSS ratio
  
  document.getElementById('r_ifas_susp').textContent = suspBio.toFixed(0);
  document.getElementById('r_ifas_att').textContent = attBio.toFixed(0);
  document.getElementById('r_ifas_tot').textContent = totalBio.toFixed(0);
  document.getElementById('r_ifas_eff_mlss').textContent = effMLSS.toFixed(0);
  document.getElementById('r_ifas_fm').textContent = fm.toFixed(3);
  document.getElementById('r_ifas_sa').textContent = surfaceArea.toFixed(0);
  
  document.getElementById('s_ifas_fm').textContent = fm >= 0.1 && fm <= 0.3 ? '‚úì Normal' : fm < 0.1 ? '‚ö† Low' : '‚ö† High';
  document.getElementById('s_ifas_fm').className = 'status ' + (fm >= 0.1 && fm <= 0.3 ? 'ok' : 'warn');
}

function resetIFAS() {
  ['ifas_flow','ifas_vol','ifas_mlss','ifas_fill','ifas_ssa','ifas_bod'].forEach((id,i) => {
    document.getElementById(id).value = ['3.0','1.0','3000','40','500','5000'][i];
  });
  ['r_ifas_susp','r_ifas_att','r_ifas_tot','r_ifas_eff_mlss','r_ifas_fm','r_ifas_sa'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}




// SBR Cycle Time Calculator
function calcSBRCycle() {
  var flow = parseFloat(document.getElementById('sbr_flow').value) || 0;
  var basins = parseInt(document.getElementById('sbr_basins').value) || 1;
  var vol = parseFloat(document.getElementById('sbr_vol').value) || 0;
  var fill = parseFloat(document.getElementById('sbr_fill').value) || 0;
  var react = parseFloat(document.getElementById('sbr_react').value) || 0;
  var settle = parseFloat(document.getElementById('sbr_settle').value) || 0;
  var decant = parseFloat(document.getElementById('sbr_decant').value) || 0;
  var idle = parseFloat(document.getElementById('sbr_idle').value) || 0;
  
  var totalCycle = fill + react + settle + decant + idle;
  var cyclesPerDay = 1440 / totalCycle;
  var flowPerBasin = flow / basins;
  var hrt = (vol * basins * 24) / flow;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>Total Cycle Time</td><td><strong>' + totalCycle.toFixed(0) + '</strong></td><td>minutes</td></tr>';
  html += '<tr><td>Cycles per Day</td><td><strong>' + cyclesPerDay.toFixed(1) + '</strong></td><td>cycles</td></tr>';
  html += '<tr><td>Flow per Basin</td><td><strong>' + flowPerBasin.toFixed(2) + '</strong></td><td>MGD</td></tr>';
  html += '<tr><td>Hydraulic Retention Time</td><td><strong>' + hrt.toFixed(1) + '</strong></td><td>hours</td></tr>';
  html += '</tbody></table>';
  
  document.getElementById('sbr_cycle_results').innerHTML = html;
}

function resetSBRCycle() {
  document.getElementById('sbr_flow').value = '2.0';
  document.getElementById('sbr_basins').value = '2';
  document.getElementById('sbr_vol').value = '0.5';
  document.getElementById('sbr_fill').value = '60';
  document.getElementById('sbr_react').value = '120';
  document.getElementById('sbr_settle').value = '60';
  document.getElementById('sbr_decant').value = '30';
  document.getElementById('sbr_idle').value = '30';
  document.getElementById('sbr_cycle_results').innerHTML = '';
}


// Debug: check panel structure on load
document.addEventListener('DOMContentLoaded', function() {
  var sbrPanel = document.getElementById('sbr');
  if (sbrPanel) {
    console.log('SBR panel exists');
    console.log('SBR parent ID: ' + (sbrPanel.parentElement ? sbrPanel.parentElement.id : 'no id'));
    console.log('SBR parent class: ' + (sbrPanel.parentElement ? sbrPanel.parentElement.className : 'none'));
    console.log('SBR innerHTML preview: ' + sbrPanel.innerHTML.substring(0, 150));
  } else {
    console.log('SBR panel NOT FOUND');
  }
});



// SBR Aeration Calculator
function calcSBRAeration() {
  var bodIn = parseFloat(document.getElementById('sbr_bod_in').value) || 0;
  var bodOut = parseFloat(document.getElementById('sbr_bod_out').value) || 0;
  var flow = parseFloat(document.getElementById('sbr_aer_flow').value) || 0;
  var tkn = parseFloat(document.getElementById('sbr_tkn').value) || 0;
  var nh3Out = parseFloat(document.getElementById('sbr_nh3_out').value) || 0;
  var reactHr = parseFloat(document.getElementById('sbr_react_hr').value) || 1;
  
  var bodRemoved = (bodIn - bodOut) * flow * 8.34;
  var carbonO2 = bodRemoved * 1.2;
  var nOxidized = (tkn - nh3Out) * flow * 8.34;
  var nitrogenO2 = nOxidized * 4.6;
  var totalO2 = carbonO2 + nitrogenO2;
  var o2Rate = totalO2 / reactHr;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>BOD Removed</td><td><strong>' + bodRemoved.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>Carbonaceous O2 Demand</td><td><strong>' + carbonO2.toFixed(0) + '</strong></td><td>lb O2/day</td></tr>';
  html += '<tr><td>Nitrogenous O2 Demand</td><td><strong>' + nitrogenO2.toFixed(0) + '</strong></td><td>lb O2/day</td></tr>';
  html += '<tr><td>Total O2 Required</td><td><strong>' + totalO2.toFixed(0) + '</strong></td><td>lb O2/day</td></tr>';
  html += '<tr><td>O2 Transfer Rate</td><td><strong>' + o2Rate.toFixed(0) + '</strong></td><td>lb O2/hr</td></tr>';
  html += '</tbody></table>';
  document.getElementById('sbr_aeration_results').innerHTML = html;
}
function resetSBRAeration() {
  ['sbr_bod_in','sbr_bod_out','sbr_aer_flow','sbr_tkn','sbr_nh3_out','sbr_react_hr'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.value = el.defaultValue;
  });
  document.getElementById('sbr_aeration_results').innerHTML = '';
}

// SBR Settling Calculator
function calcSBRSettling() {
  var mlss = parseFloat(document.getElementById('sbr_mlss').value) || 0;
  var svi = parseFloat(document.getElementById('sbr_svi').value) || 0;
  var depth = parseFloat(document.getElementById('sbr_depth').value) || 0;
  var settleTime = parseFloat(document.getElementById('sbr_settle_t').value) || 0;
  var decantPct = parseFloat(document.getElementById('sbr_decant_pct').value) || 0;
  
  var blanketVol = (mlss * svi) / 1000000;
  var blanketHeight = depth * blanketVol;
  var clearWater = depth - blanketHeight;
  var settleVel = (depth - blanketHeight) / (settleTime / 60);
  var decantDepth = depth * (decantPct / 100);
  var margin = clearWater - decantDepth;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>Sludge Blanket Height</td><td><strong>' + blanketHeight.toFixed(1) + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Clear Water Zone</td><td><strong>' + clearWater.toFixed(1) + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Settling Velocity</td><td><strong>' + settleVel.toFixed(2) + '</strong></td><td>ft/hr</td></tr>';
  html += '<tr><td>Decant Depth</td><td><strong>' + decantDepth.toFixed(1) + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Safety Margin</td><td><strong>' + margin.toFixed(1) + '</strong></td><td>ft</td></tr>';
  html += '</tbody></table>';
  document.getElementById('sbr_settling_results').innerHTML = html;
}
function resetSBRSettling() {
  ['sbr_mlss','sbr_svi','sbr_depth','sbr_settle_t','sbr_decant_pct'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.value = el.defaultValue;
  });
  document.getElementById('sbr_settling_results').innerHTML = '';
}

// SBR Loading Calculator
function calcSBRLoading() {
  var flow = parseFloat(document.getElementById('sbr_load_flow').value) || 0;
  var bod = parseFloat(document.getElementById('sbr_load_bod').value) || 0;
  var vol = parseFloat(document.getElementById('sbr_load_vol').value) || 0;
  var mlss = parseFloat(document.getElementById('sbr_load_mlss').value) || 0;
  var vssRatio = parseFloat(document.getElementById('sbr_vss_ratio').value) || 0.8;
  var basins = parseInt(document.getElementById('sbr_load_basins').value) || 1;
  
  var bodLoad = flow * bod * 8.34;
  var mlvss = mlss * vssRatio;
  var totalVol = vol * basins;
  var biomass = mlvss * totalVol * 8.34;
  var fm = bodLoad / biomass;
  var volLoad = bodLoad / (totalVol * 1000000) * 1000;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>BOD Loading</td><td><strong>' + bodLoad.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>MLVSS</td><td><strong>' + mlvss.toFixed(0) + '</strong></td><td>mg/L</td></tr>';
  html += '<tr><td>Biomass Inventory</td><td><strong>' + biomass.toFixed(0) + '</strong></td><td>lb</td></tr>';
  html += '<tr><td>F/M Ratio</td><td><strong>' + fm.toFixed(3) + '</strong></td><td>lb BOD/lb MLVSS/d</td></tr>';
  html += '<tr><td>Volumetric Loading</td><td><strong>' + volLoad.toFixed(1) + '</strong></td><td>lb BOD/1000 cf/d</td></tr>';
  html += '</tbody></table>';
  document.getElementById('sbr_loading_results').innerHTML = html;
}
function resetSBRLoading() {
  ['sbr_load_flow','sbr_load_bod','sbr_load_vol','sbr_load_mlss','sbr_vss_ratio','sbr_load_basins'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.value = el.defaultValue;
  });
  document.getElementById('sbr_loading_results').innerHTML = '';
}

// SBR WAS Calculator
function calcSBRWAS() {
  var srt = parseFloat(document.getElementById('sbr_srt').value) || 1;
  var mlss = parseFloat(document.getElementById('sbr_was_mlss').value) || 0;
  var vol = parseFloat(document.getElementById('sbr_was_vol').value) || 0;
  var effTss = parseFloat(document.getElementById('sbr_eff_tss').value) || 0;
  var effFlow = parseFloat(document.getElementById('sbr_eff_flow').value) || 0;
  
  var inventory = mlss * vol * 8.34;
  var effLoss = effTss * effFlow * 8.34;
  var wasRequired = (inventory / srt) - effLoss;
  var wasGPD = wasRequired / (mlss * 8.34 / 1000);
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>MLSS Inventory</td><td><strong>' + inventory.toFixed(0) + '</strong></td><td>lb</td></tr>';
  html += '<tr><td>Effluent Solids Loss</td><td><strong>' + effLoss.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>WAS Required</td><td><strong>' + wasRequired.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>WAS Flow</td><td><strong>' + wasGPD.toFixed(0) + '</strong></td><td>GPD</td></tr>';
  html += '</tbody></table>';
  document.getElementById('sbr_was_results').innerHTML = html;
}
function resetSBRWAS() {
  ['sbr_srt','sbr_was_mlss','sbr_was_vol','sbr_eff_tss','sbr_eff_flow'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.value = el.defaultValue;
  });
  document.getElementById('sbr_was_results').innerHTML = '';
}

// SBR Nutrient Removal Calculator
function calcSBRNutrient() {
  var tnIn = parseFloat(document.getElementById('sbr_tn_in').value) || 0;
  var tnOut = parseFloat(document.getElementById('sbr_tn_out').value) || 0;
  var tpIn = parseFloat(document.getElementById('sbr_tp_in').value) || 0;
  var tpOut = parseFloat(document.getElementById('sbr_tp_out').value) || 0;
  var anoxic = parseFloat(document.getElementById('sbr_anoxic').value) || 0;
  var anaerobic = parseFloat(document.getElementById('sbr_anaerobic').value) || 0;
  
  var tnRemoval = ((tnIn - tnOut) / tnIn) * 100;
  var tpRemoval = ((tpIn - tpOut) / tpIn) * 100;
  var denitrRate = (tnIn - tnOut) / (anoxic / 60);
  var pRelease = tpIn * 0.5;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>TN Removal</td><td><strong>' + tnRemoval.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>TP Removal</td><td><strong>' + tpRemoval.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>Denitrification Rate</td><td><strong>' + denitrRate.toFixed(2) + '</strong></td><td>mg/L/hr</td></tr>';
  html += '<tr><td>Est. P Release</td><td><strong>' + pRelease.toFixed(1) + '</strong></td><td>mg/L</td></tr>';
  html += '</tbody></table>';
  document.getElementById('sbr_nutrient_results').innerHTML = html;
}
function resetSBRNutrient() {
  ['sbr_tn_in','sbr_tn_out','sbr_tp_in','sbr_tp_out','sbr_anoxic','sbr_anaerobic'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.value = el.defaultValue;
  });
  document.getElementById('sbr_nutrient_results').innerHTML = '';
}



// MBR Flux Calculator
function calcMBRFlux() {
  var flow = parseFloat(document.getElementById('mbr_perm_flow').value) || 0;
  var area = parseFloat(document.getElementById('mbr_mem_area').value) || 1;
  var tmp = parseFloat(document.getElementById('mbr_tmp').value) || 1;
  var temp = parseFloat(document.getElementById('mbr_temp').value) || 20;
  
  var flux_gfd = (flow * 1440) / area;
  var flux_lmh = flux_gfd * 1.7;
  var perm = flux_lmh / (tmp * 0.0689);
  var tempCorr = 1.0 + 0.02 * (temp - 20);
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>Net Flux</td><td><strong>' + flux_gfd.toFixed(1) + '</strong></td><td>GFD</td></tr>';
  html += '<tr><td>Net Flux</td><td><strong>' + flux_lmh.toFixed(1) + '</strong></td><td>LMH</td></tr>';
  html += '<tr><td>Permeability</td><td><strong>' + perm.toFixed(1) + '</strong></td><td>LMH/bar</td></tr>';
  html += '<tr><td>Temp Correction Factor</td><td><strong>' + tempCorr.toFixed(2) + '</strong></td><td></td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbr_flux_results').innerHTML = html;
}
function resetMBRFlux() {
  document.getElementById('mbr_flux_results').innerHTML = '';
}

// MBR Aeration Calculator
function calcMBRAeration() {
  var bodLoad = parseFloat(document.getElementById('mbr_bod_load').value) || 0;
  var tknLoad = parseFloat(document.getElementById('mbr_tkn_load').value) || 0;
  var area = parseFloat(document.getElementById('mbr_scour_area').value) || 1;
  var scourRate = parseFloat(document.getElementById('mbr_scour_rate').value) || 0;
  
  var processO2 = bodLoad * 1.2 + tknLoad * 4.6;
  var scourAir = area * scourRate;
  var totalAir = (processO2 / 0.02) + scourAir;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>Process O2 Demand</td><td><strong>' + processO2.toFixed(0) + '</strong></td><td>lb O2/day</td></tr>';
  html += '<tr><td>Membrane Scour Air</td><td><strong>' + scourAir.toFixed(0) + '</strong></td><td>SCFM</td></tr>';
  html += '<tr><td>Est. Total Air</td><td><strong>' + totalAir.toFixed(0) + '</strong></td><td>SCFM</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbr_aeration_results').innerHTML = html;
}
function resetMBRAeration() {
  document.getElementById('mbr_aeration_results').innerHTML = '';
}

// MBR Energy Calculator
function calcMBREnergy() {
  var permHP = parseFloat(document.getElementById('mbr_perm_hp').value) || 0;
  var blowerHP = parseFloat(document.getElementById('mbr_blower_hp').value) || 0;
  var runHrs = parseFloat(document.getElementById('mbr_run_hrs').value) || 24;
  var flow = parseFloat(document.getElementById('mbr_energy_flow').value) || 1;
  var rate = parseFloat(document.getElementById('mbr_elec_rate').value) || 0.10;
  
  var totalHP = permHP + blowerHP;
  var kWh = totalHP * 0.746 * runHrs;
  var specific = kWh / (flow * 1000);
  var dailyCost = kWh * rate;
  var monthlyCost = dailyCost * 30;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>Total Connected HP</td><td><strong>' + totalHP.toFixed(0) + '</strong></td><td>HP</td></tr>';
  html += '<tr><td>Daily Energy</td><td><strong>' + kWh.toFixed(0) + '</strong></td><td>kWh/day</td></tr>';
  html += '<tr><td>Specific Energy</td><td><strong>' + specific.toFixed(2) + '</strong></td><td>kWh/kgal</td></tr>';
  html += '<tr><td>Daily Cost</td><td><strong>$' + dailyCost.toFixed(2) + '</strong></td><td></td></tr>';
  html += '<tr><td>Monthly Cost</td><td><strong>$' + monthlyCost.toFixed(0) + '</strong></td><td></td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbr_energy_results').innerHTML = html;
}
function resetMBREnergy() {
  document.getElementById('mbr_energy_results').innerHTML = '';
}

// MBBR Media Calculator
function calcMBBRMedia() {
  var vol = parseFloat(document.getElementById('mbbr_vol').value) || 0;
  var fill = parseFloat(document.getElementById('mbbr_fill').value) || 0;
  var ssa = parseFloat(document.getElementById('mbbr_ssa').value) || 0;
  
  var volCF = vol * 1000000 / 7.48;
  var mediaVol = volCF * (fill / 100);
  var mediaVolM3 = mediaVol * 0.0283;
  var totalSA = mediaVolM3 * ssa;
  var activeSA = totalSA * 0.67;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>Reactor Volume</td><td><strong>' + volCF.toFixed(0) + '</strong></td><td>cf</td></tr>';
  html += '<tr><td>Media Volume</td><td><strong>' + mediaVol.toFixed(0) + '</strong></td><td>cf</td></tr>';
  html += '<tr><td>Total Surface Area</td><td><strong>' + totalSA.toFixed(0) + '</strong></td><td>m¬≤</td></tr>';
  html += '<tr><td>Active Surface Area</td><td><strong>' + activeSA.toFixed(0) + '</strong></td><td>m¬≤</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_media_results').innerHTML = html;
}
function resetMBBRMedia() {
  document.getElementById('mbbr_media_results').innerHTML = '';
}

// MBBR BOD Calculator
function calcMBBRBOD() {
  var flow = parseFloat(document.getElementById('mbbr_bod_flow').value) || 0;
  var bodIn = parseFloat(document.getElementById('mbbr_bod_in').value) || 0;
  var bodOut = parseFloat(document.getElementById('mbbr_bod_out').value) || 0;
  var temp = parseFloat(document.getElementById('mbbr_bod_temp').value) || 20;
  var salr = parseFloat(document.getElementById('mbbr_salr').value) || 10;
  
  var bodLoad = flow * (bodIn - bodOut) * 3.785 * 1000;
  var saRequired = bodLoad / salr;
  var tempFactor = Math.pow(1.06, temp - 20);
  var correctedSALR = salr * tempFactor;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>BOD Load to Remove</td><td><strong>' + (bodLoad/1000).toFixed(1) + '</strong></td><td>kg/day</td></tr>';
  html += '<tr><td>Surface Area Required</td><td><strong>' + saRequired.toFixed(0) + '</strong></td><td>m¬≤</td></tr>';
  html += '<tr><td>Temp Correction Factor</td><td><strong>' + tempFactor.toFixed(2) + '</strong></td><td></td></tr>';
  html += '<tr><td>Corrected SALR</td><td><strong>' + correctedSALR.toFixed(1) + '</strong></td><td>g/m¬≤/d</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_bod_results').innerHTML = html;
}
function resetMBBRBOD() {
  document.getElementById('mbbr_bod_results').innerHTML = '';
}

// MBBR Aeration Calculator
function calcMBBRAeration() {
  var bodLoad = parseFloat(document.getElementById('mbbr_aer_bod').value) || 0;
  var nh3Load = parseFloat(document.getElementById('mbbr_aer_nh3').value) || 0;
  var mediaVol = parseFloat(document.getElementById('mbbr_media_vol').value) || 0;
  var mixRate = parseFloat(document.getElementById('mbbr_mix_rate').value) || 1;
  
  var carbonO2 = bodLoad * 1.2;
  var nitrogenO2 = nh3Load * 4.6;
  var totalO2 = carbonO2 + nitrogenO2;
  var processAir = totalO2 / 0.02;
  var mixingAir = mediaVol * mixRate;
  var totalAir = Math.max(processAir, mixingAir);
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>Carbonaceous O2</td><td><strong>' + carbonO2.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>Nitrogenous O2</td><td><strong>' + nitrogenO2.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>Process Air Required</td><td><strong>' + processAir.toFixed(0) + '</strong></td><td>SCFM</td></tr>';
  html += '<tr><td>Mixing Air Required</td><td><strong>' + mixingAir.toFixed(0) + '</strong></td><td>SCFM</td></tr>';
  html += '<tr><td>Design Air (greater of)</td><td><strong>' + totalAir.toFixed(0) + '</strong></td><td>SCFM</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_aeration_results').innerHTML = html;
}
function resetMBBRAeration() {
  document.getElementById('mbbr_aeration_results').innerHTML = '';
}



// MBR Cleaning Calculator
function calcMBRCleaning() {
  var permInit = parseFloat(document.getElementById('mbr_perm_init').value) || 1;
  var permCurr = parseFloat(document.getElementById('mbr_perm_curr').value) || 0;
  var daysCIP = parseFloat(document.getElementById('mbr_days_cip').value) || 1;
  var permPost = parseFloat(document.getElementById('mbr_perm_post').value) || 0;
  
  var foulingRate = (permInit - permCurr) / daysCIP;
  var totalFouling = ((permInit - permCurr) / permInit) * 100;
  var reversible = ((permPost - permCurr) / (permInit - permCurr)) * 100;
  var irreversible = 100 - reversible;
  var cipEfficiency = (permPost / permInit) * 100;
  var membraneHealth = permCurr > permInit * 0.5 ? 'Good' : permCurr > permInit * 0.3 ? 'Fair' : 'Poor';
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>Fouling Rate</td><td><strong>' + foulingRate.toFixed(2) + '</strong></td><td>LMH/bar/day</td></tr>';
  html += '<tr><td>Total Fouling</td><td><strong>' + totalFouling.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>Reversible Fouling</td><td><strong>' + reversible.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>Irreversible Fouling</td><td><strong>' + irreversible.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>CIP Efficiency</td><td><strong>' + cipEfficiency.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>Membrane Health</td><td><strong>' + membraneHealth + '</strong></td><td></td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbr_cleaning_results').innerHTML = html;
}
function resetMBRCleaning() {
  document.getElementById('mbr_cleaning_results').innerHTML = '';
}

// MBR Loading Calculator
function calcMBRLoading() {
  var flow = parseFloat(document.getElementById('mbr_srt_flow').value) || 0;
  var bod = parseFloat(document.getElementById('mbr_srt_bod').value) || 0;
  var mlss = parseFloat(document.getElementById('mbr_srt_mlss').value) || 0;
  var vol = parseFloat(document.getElementById('mbr_srt_vol').value) || 0;
  var wasFlow = parseFloat(document.getElementById('mbr_was_flow').value) || 0;
  var wasConc = parseFloat(document.getElementById('mbr_was_conc').value) || 0;
  
  var bodLoad = flow * bod * 8.34;
  var biomass = mlss * vol * 8.34;
  var fm = bodLoad / (biomass * 0.8);
  var hrt = (vol / flow) * 24;
  var wasLb = wasFlow * wasConc * 8.34 / 1000000;
  var srt = biomass / wasLb;
  var volLoad = bodLoad / (vol * 1000000) * 1000;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>BOD Loading</td><td><strong>' + bodLoad.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>F/M Ratio</td><td><strong>' + fm.toFixed(3) + '</strong></td><td>lb BOD/lb MLVSS/d</td></tr>';
  html += '<tr><td>HRT</td><td><strong>' + hrt.toFixed(1) + '</strong></td><td>hours</td></tr>';
  html += '<tr><td>SRT</td><td><strong>' + srt.toFixed(0) + '</strong></td><td>days</td></tr>';
  html += '<tr><td>Volumetric Loading</td><td><strong>' + volLoad.toFixed(1) + '</strong></td><td>lb BOD/1000 cf/d</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbr_loading_results').innerHTML = html;
}
function resetMBRLoading() {
  document.getElementById('mbr_loading_results').innerHTML = '';
}

// MBR Troubleshooting
function calcMBRTroubleshoot() {
  var tmpTrend = document.getElementById('mbr_tmp_trend').value;
  var permTrend = document.getElementById('mbr_perm_trend').value;
  var foam = document.getElementById('mbr_foam').value;
  var permQuality = document.getElementById('mbr_perm_quality').value;
  
  var issues = [];
  var recommendations = [];
  
  if (tmpTrend === 'rapid' || tmpTrend === 'jump') {
    issues.push('Rapid TMP increase indicates acute fouling');
    recommendations.push('Perform maintenance clean (MC) immediately');
    recommendations.push('Check for membrane damage or air scour issues');
  } else if (tmpTrend === 'gradual') {
    issues.push('Gradual TMP increase is normal but monitor closely');
    recommendations.push('Schedule CIP within 1-2 weeks');
  }
  
  if (permTrend === 'rapid_decline') {
    issues.push('Rapid permeability decline - possible membrane damage');
    recommendations.push('Inspect membranes for fiber breakage');
    recommendations.push('Check pretreatment for debris');
  }
  
  if (foam === 'heavy') {
    issues.push('Heavy foam indicates possible Nocardia/filament issue');
    recommendations.push('Reduce SRT or add selector zone');
    recommendations.push('Consider antifoam addition');
  }
  
  if (permQuality === 'turbid') {
    issues.push('Turbid permeate indicates membrane integrity issue');
    recommendations.push('Perform integrity test immediately');
    recommendations.push('Isolate and repair damaged modules');
  }
  
  if (issues.length === 0) {
    issues.push('No significant issues detected');
    recommendations.push('Continue normal operation');
  }
  
  var html = '<div class="note warning"><strong>Issues Identified:</strong><ul>';
  issues.forEach(function(i) { html += '<li>' + i + '</li>'; });
  html += '</ul></div>';
  html += '<div class="note success"><strong>Recommendations:</strong><ul>';
  recommendations.forEach(function(r) { html += '<li>' + r + '</li>'; });
  html += '</ul></div>';
  
  document.getElementById('mbr_troubleshoot_results').innerHTML = html;
}

// MBBR Nitrification Calculator
function calcMBBRNitrification() {
  var flow = parseFloat(document.getElementById('mbbr_nit_flow').value) || 0;
  var nh3In = parseFloat(document.getElementById('mbbr_nh3_in').value) || 0;
  var nh3Out = parseFloat(document.getElementById('mbbr_nh3_out').value) || 0;
  var temp = parseFloat(document.getElementById('mbbr_nit_temp').value) || 15;
  var doConc = parseFloat(document.getElementById('mbbr_do').value) || 0;
  var sanr = parseFloat(document.getElementById('mbbr_sanr').value) || 1;
  
  var nh3Load = flow * (nh3In - nh3Out) * 3.785 * 1000;
  var tempFactor = Math.pow(1.098, temp - 20);
  var doFactor = doConc / (doConc + 1.3);
  var correctedSANR = sanr * tempFactor * doFactor;
  var saRequired = (nh3Load / 1000) / correctedSANR;
  var alkConsumed = (nh3In - nh3Out) * 7.14 * flow * 8.34;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>NH3-N Load to Remove</td><td><strong>' + (nh3Load/1000).toFixed(1) + '</strong></td><td>kg/day</td></tr>';
  html += '<tr><td>Temp Correction Factor</td><td><strong>' + tempFactor.toFixed(2) + '</strong></td><td></td></tr>';
  html += '<tr><td>DO Correction Factor</td><td><strong>' + doFactor.toFixed(2) + '</strong></td><td></td></tr>';
  html += '<tr><td>Corrected SANR</td><td><strong>' + correctedSANR.toFixed(2) + '</strong></td><td>g N/m¬≤/d</td></tr>';
  html += '<tr><td>Surface Area Required</td><td><strong>' + saRequired.toFixed(0) + '</strong></td><td>m¬≤</td></tr>';
  html += '<tr><td>Alkalinity Consumed</td><td><strong>' + alkConsumed.toFixed(0) + '</strong></td><td>lb/day as CaCO3</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_nit_results').innerHTML = html;
}
function resetMBBRNitrification() {
  document.getElementById('mbbr_nit_results').innerHTML = '';
}

// MBBR Hydraulic Calculator
function calcMBBRHydraulic() {
  var flow = parseFloat(document.getElementById('mbbr_hyd_flow').value) || 0;
  var vol = parseFloat(document.getElementById('mbbr_hyd_vol').value) || 0;
  var length = parseFloat(document.getElementById('mbbr_length').value) || 0;
  var width = parseFloat(document.getElementById('mbbr_width').value) || 0;
  var depth = parseFloat(document.getElementById('mbbr_wat_depth').value) || 0;
  var screenArea = parseFloat(document.getElementById('mbbr_screen').value) || 1;
  
  var hrt = (vol / flow) * 24 * 60;
  var calcVol = length * width * depth / 7.48 / 1000000;
  var lw = length / width;
  var dw = depth / width;
  var flowGPM = flow * 1000000 / 1440;
  var screenVel = flowGPM / screenArea / 7.48;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>HRT</td><td><strong>' + hrt.toFixed(0) + '</strong></td><td>minutes</td></tr>';
  html += '<tr><td>Calculated Volume</td><td><strong>' + calcVol.toFixed(3) + '</strong></td><td>MG</td></tr>';
  html += '<tr><td>L:W Ratio</td><td><strong>' + lw.toFixed(1) + '</strong></td><td>(target 2:1)</td></tr>';
  html += '<tr><td>D:W Ratio</td><td><strong>' + dw.toFixed(2) + '</strong></td><td>(target 0.5-1.0)</td></tr>';
  html += '<tr><td>Screen Velocity</td><td><strong>' + screenVel.toFixed(2) + '</strong></td><td>ft/s (max 1.0)</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_hydraulic_results').innerHTML = html;
}
function resetMBBRHydraulic() {
  document.getElementById('mbbr_hydraulic_results').innerHTML = '';
}

// MBBR Performance Calculator
function calcMBBRPerformance() {
  var bodIn = parseFloat(document.getElementById('mbbr_perf_bod_in').value) || 0;
  var bodOut = parseFloat(document.getElementById('mbbr_perf_bod_out').value) || 0;
  var nh3In = parseFloat(document.getElementById('mbbr_perf_nh3_in').value) || 0;
  var nh3Out = parseFloat(document.getElementById('mbbr_perf_nh3_out').value) || 0;
  var sa = parseFloat(document.getElementById('mbbr_perf_sa').value) || 1;
  var flow = parseFloat(document.getElementById('mbbr_perf_flow').value) || 0;
  
  var bodRemoval = ((bodIn - bodOut) / bodIn) * 100;
  var nh3Removal = ((nh3In - nh3Out) / nh3In) * 100;
  var bodLoad = flow * bodIn * 3.785;
  var nh3Load = flow * nh3In * 3.785;
  var actualSALR = bodLoad / sa;
  var actualSANR = nh3Load / sa;
  var bodRate = (bodIn - bodOut) * flow * 3.785 * 1000 / sa;
  var nh3Rate = (nh3In - nh3Out) * flow * 3.785 * 1000 / sa;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>BOD Removal</td><td><strong>' + bodRemoval.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>NH3 Removal</td><td><strong>' + nh3Removal.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>Actual SALR (BOD)</td><td><strong>' + actualSALR.toFixed(1) + '</strong></td><td>g/m¬≤/d</td></tr>';
  html += '<tr><td>Actual SANR (NH3)</td><td><strong>' + actualSANR.toFixed(2) + '</strong></td><td>g N/m¬≤/d</td></tr>';
  html += '<tr><td>BOD Removal Rate</td><td><strong>' + bodRate.toFixed(1) + '</strong></td><td>g/m¬≤/d</td></tr>';
  html += '<tr><td>NH3 Removal Rate</td><td><strong>' + nh3Rate.toFixed(2) + '</strong></td><td>g N/m¬≤/d</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_perf_results').innerHTML = html;
}
function resetMBBRPerformance() {
  document.getElementById('mbbr_perf_results').innerHTML = '';
}

// IFAS Calculator
function calcIFAS() {
  var mlss = parseFloat(document.getElementById('ifas_mlss').value) || 0;
  var vol = parseFloat(document.getElementById('ifas_vol').value) || 0;
  var fill = parseFloat(document.getElementById('ifas_fill').value) || 0;
  var biofilm = parseFloat(document.getElementById('ifas_biofilm').value) || 0;
  var ssa = parseFloat(document.getElementById('ifas_ssa').value) || 0;
  var flow = parseFloat(document.getElementById('ifas_flow').value) || 0;
  
  var suspBiomass = mlss * vol * 8.34;
  var volCF = vol * 1000000 / 7.48;
  var mediaVol = volCF * fill / 100;
  var mediaVolM3 = mediaVol * 0.0283;
  var surfaceArea = mediaVolM3 * ssa;
  var attachedBiomass = surfaceArea * biofilm / 1000 * 2.205;
  var totalBiomass = suspBiomass + attachedBiomass;
  var effectiveMLSS = totalBiomass / (vol * 8.34);
  var attachedPct = (attachedBiomass / totalBiomass) * 100;
  
  var html = '<table class="table"><tbody>';
  html += '<tr><td>Suspended Biomass</td><td><strong>' + suspBiomass.toFixed(0) + '</strong></td><td>lb</td></tr>';
  html += '<tr><td>Media Surface Area</td><td><strong>' + surfaceArea.toFixed(0) + '</strong></td><td>m¬≤</td></tr>';
  html += '<tr><td>Attached Biomass</td><td><strong>' + attachedBiomass.toFixed(0) + '</strong></td><td>lb</td></tr>';
  html += '<tr><td>Total Biomass</td><td><strong>' + totalBiomass.toFixed(0) + '</strong></td><td>lb</td></tr>';
  html += '<tr><td>Effective MLSS</td><td><strong>' + effectiveMLSS.toFixed(0) + '</strong></td><td>mg/L equiv</td></tr>';
  html += '<tr><td>Attached Fraction</td><td><strong>' + attachedPct.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '</tbody></table>';
  document.getElementById('ifas_results').innerHTML = html;
}
function resetIFAS() {
  document.getElementById('ifas_results').innerHTML = '';
}

// ==================== SBR TROUBLESHOOTING ====================
function calcSBRTroubleshoot() {
  var effIssue = document.getElementById('sbr_eff_issue').value;
  var settleIssue = document.getElementById('sbr_settle_issue').value;
  var opIssue = document.getElementById('sbr_op_issue').value;
  var svi = parseFloat(document.getElementById('sbr_diag_svi').value) || 150;
  
  var html = '<div style="margin-top:15px">';
  var issueCount = 0;
  var recommendations = [];
  
  // Analyze SVI
  var sviStatus = 'good';
  var sviColor = '#06d6a0';
  if (svi > 200) { sviStatus = 'poor'; sviColor = '#ef4444'; }
  else if (svi > 150) { sviStatus = 'fair'; sviColor = '#ffd166'; }
  
  html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px">';
  html += '<h4 style="color:#60a5fa;margin:0 0 10px 0">üìä SVI Analysis: ' + svi + ' mL/g</h4>';
  html += '<div style="display:flex;align-items:center;gap:10px">';
  html += '<div style="width:100px;height:20px;background:#243b55;border-radius:10px;overflow:hidden">';
  html += '<div style="width:' + Math.min(svi/4, 100) + '%;height:100%;background:' + sviColor + '"></div></div>';
  html += '<span style="color:' + sviColor + ';font-weight:bold">' + sviStatus.toUpperCase() + '</span></div>';
  if (svi < 80) html += '<p style="color:#94a3b8;margin:10px 0 0 0">‚ö†Ô∏è Very low SVI may indicate old sludge or pin floc</p>';
  else if (svi > 200) html += '<p style="color:#94a3b8;margin:10px 0 0 0">‚ö†Ô∏è High SVI indicates settling problems - check for filaments</p>';
  html += '</div>';
  
  // Effluent Quality Issues
  if (effIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ef4444">';
    html += '<h4 style="color:#f87171;margin:0 0 10px 0">üö® Effluent Quality: ' + effIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';
    
    if (effIssue === 'high_tss') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient settle time</li><li>Decanter withdrawal too fast</li><li>Sludge blanket too high</li><li>Poor floc formation</li></ul>';
      recommendations.push('Extend settle phase by 10-15 minutes');
      recommendations.push('Reduce decant withdrawal rate');
      recommendations.push('Increase WAS to lower blanket level');
      recommendations.push('Check polymer addition if used');
    } else if (effIssue === 'high_bod') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient react time</li><li>Low MLSS concentration</li><li>Inadequate aeration</li><li>Shock load</li></ul>';
      recommendations.push('Extend aeration/react phase');
      recommendations.push('Reduce WAS to increase MLSS');
      recommendations.push('Verify DO > 2.0 mg/L during react');
      recommendations.push('Check influent loading for shock loads');
    } else if (effIssue === 'high_nh3') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient SRT for nitrifiers</li><li>Low DO during aeration</li><li>pH too low (&lt;6.8)</li><li>Temperature too cold</li></ul>';
      recommendations.push('Increase SRT to >10 days for nitrification');
      recommendations.push('Maintain DO > 2.5 mg/L during react');
      recommendations.push('Add alkalinity if pH < 7.0');
      recommendations.push('Extend aeration time in cold weather');
    } else if (effIssue === 'high_no3') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient anoxic time</li><li>Anoxic phase DO too high</li><li>Lack of carbon source</li></ul>';
      recommendations.push('Extend anoxic fill phase');
      recommendations.push('Ensure DO < 0.5 mg/L during anoxic');
      recommendations.push('Consider carbon supplementation');
    } else if (effIssue === 'high_phos') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient anaerobic time</li><li>Nitrate in anaerobic zone</li><li>Secondary P release</li></ul>';
      recommendations.push('Add/extend anaerobic phase (30-60 min)');
      recommendations.push('Ensure no nitrate entering anaerobic');
      recommendations.push('Consider chemical P removal backup');
    }
    html += '</div>';
  }
  
  // Settling Issues
  if (settleIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ffd166">';
    html += '<h4 style="color:#fbbf24;margin:0 0 10px 0">‚ö†Ô∏è Settling Problem: ' + settleIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';
    
    if (settleIssue === 'poor' || settleIssue === 'bulking') {
      html += '<p style="color:#e0f2fe"><strong>Filamentous Bulking Indicators:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Check microscopy for filament ID</li><li>Common: Nocardia, M. parvicella, Type 021N</li></ul>';
      recommendations.push('Identify filament type via microscopy');
      recommendations.push('Increase DO if Type 1701/S. natans');
      recommendations.push('Reduce F/M if Nocardia/Microthrix');
      recommendations.push('Consider selector or chlorination');
    } else if (settleIssue === 'rising') {
      html += '<p style="color:#e0f2fe"><strong>Rising Sludge Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Denitrification in settle phase</li><li>N2 gas bubbles lifting sludge</li></ul>';
      recommendations.push('Shorten settle time');
      recommendations.push('Add short mix at end of react to strip N2');
      recommendations.push('Increase WAS to reduce SRT');
    } else if (settleIssue === 'pin_floc') {
      html += '<p style="color:#e0f2fe"><strong>Pin Floc Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Over-aeration breaking floc</li><li>Very old sludge</li><li>Nutrient deficiency</li></ul>';
      recommendations.push('Reduce aeration intensity');
      recommendations.push('Increase WAS to reduce SRT');
      recommendations.push('Check N:P ratio (100:5:1 BOD:N:P)');
    } else if (settleIssue === 'foam') {
      html += '<p style="color:#e0f2fe"><strong>Foam Types:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Brown/tan: Nocardia or Microthrix</li><li>White: Detergents or young sludge</li><li>Dark: Old sludge</li></ul>';
      recommendations.push('ID foam type and organism');
      recommendations.push('Spray water or defoamer');
      recommendations.push('Adjust SRT (reduce for Nocardia)');
    }
    html += '</div>';
  }
  
  // Operational Issues
  if (opIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #0077b6">';
    html += '<h4 style="color:#60a5fa;margin:0 0 10px 0">üîß Operational Issue: ' + opIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';
    
    if (opIssue === 'short_cycle') {
      recommendations.push('Review cycle timing - typical: Fill 2hr, React 3-4hr, Settle 1hr, Decant 0.5hr');
      recommendations.push('Consider adding basins or reducing flow');
    } else if (opIssue === 'carryover') {
      recommendations.push('Lower decanter start level');
      recommendations.push('Slow decant rate');
      recommendations.push('Increase settle time');
      recommendations.push('Lower sludge blanket with more WAS');
    } else if (opIssue === 'low_do') {
      recommendations.push('Increase blower output');
      recommendations.push('Check diffuser fouling');
      recommendations.push('Verify adequate react time');
    } else if (opIssue === 'high_do') {
      recommendations.push('Implement DO control strategy');
      recommendations.push('Reduce aeration during low load periods');
      recommendations.push('Consider VFD on blowers');
    } else if (opIssue === 'odor') {
      recommendations.push('Check for septicity in fill phase');
      recommendations.push('Ensure adequate aeration');
      recommendations.push('Review sludge handling');
    }
    html += '</div>';
  }
  
  // Recommendations Summary
  if (recommendations.length > 0) {
    html += '<div style="background:linear-gradient(135deg,#065f46,#047857);padding:15px;border-radius:8px">';
    html += '<h4 style="color:#a7f3d0;margin:0 0 10px 0">‚úÖ Recommended Actions (' + recommendations.length + ')</h4>';
    html += '<ol style="color:#d1fae5;margin:0;padding-left:20px">';
    recommendations.forEach(function(rec) {
      html += '<li style="margin-bottom:8px">' + rec + '</li>';
    });
    html += '</ol></div>';
  } else if (issueCount === 0) {
    html += '<div style="background:#065f46;padding:20px;border-radius:8px;text-align:center">';
    html += '<span style="font-size:48px">‚úÖ</span>';
    html += '<h4 style="color:#a7f3d0;margin:10px 0 0 0">SBR Operating Normally</h4>';
    html += '<p style="color:#d1fae5;margin:5px 0 0 0">No issues detected. Continue monitoring.</p>';
    html += '</div>';
  }
  
  html += '</div>';
  document.getElementById('sbr_troubleshoot_results').innerHTML = html;
  showToast('SBR Diagnosis Complete', 'success');
}

function resetSBRTroubleshoot() {
  document.getElementById('sbr_eff_issue').value = 'none';
  document.getElementById('sbr_settle_issue').value = 'none';
  document.getElementById('sbr_op_issue').value = 'none';
  document.getElementById('sbr_diag_svi').value = '150';
  document.getElementById('sbr_troubleshoot_results').innerHTML = '';
}

// ==================== MBBR TROUBLESHOOTING ====================
function calcMBBRTroubleshoot() {
  var mediaIssue = document.getElementById('mbbr_media_issue').value;
  var perfIssue = document.getElementById('mbbr_perf_issue').value;
  var biofilmIssue = document.getElementById('mbbr_biofilm_issue').value;
  var airIssue = document.getElementById('mbbr_air_issue').value;
  
  var html = '<div style="margin-top:15px">';
  var issueCount = 0;
  var recommendations = [];
  
  // Media Issues
  if (mediaIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ef4444">';
    html += '<h4 style="color:#f87171;margin:0 0 10px 0">üî¥ Media Issue: ' + mediaIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';
    
    if (mediaIssue === 'clogging') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Excessive biofilm growth</li><li>Inadequate scouring aeration</li><li>High TSS loading</li><li>Grease/oil accumulation</li></ul>';
      recommendations.push('Increase aeration intensity temporarily');
      recommendations.push('Check and clean screens');
      recommendations.push('Review pretreatment effectiveness');
      recommendations.push('Consider media cleaning cycle');
    } else if (mediaIssue === 'loss') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Screen openings too large</li><li>Screen damage or gaps</li><li>Media degradation</li></ul>';
      recommendations.push('Inspect screens for damage or gaps');
      recommendations.push('Verify screen opening size vs media');
      recommendations.push('Check media condition - replace if degraded');
    } else if (mediaIssue === 'poor_mixing') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient aeration</li><li>Uneven diffuser layout</li><li>Fill % too high</li></ul>';
      recommendations.push('Increase airflow rate');
      recommendations.push('Check diffuser distribution');
      recommendations.push('Reduce media fill to <67%');
    } else if (mediaIssue === 'accumulation') {
      recommendations.push('Add baffles or modify tank geometry');
      recommendations.push('Increase mixing energy');
      recommendations.push('Consider mechanical mixing');
    } else if (mediaIssue === 'breakage') {
      recommendations.push('Evaluate media quality and age');
      recommendations.push('Check for excessive mechanical stress');
      recommendations.push('Plan media replacement');
    }
    html += '</div>';
  }
  
  // Performance Issues
  if (perfIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ffd166">';
    html += '<h4 style="color:#fbbf24;margin:0 0 10px 0">‚ö†Ô∏è Performance Issue: ' + perfIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';
    
    if (perfIssue === 'low_bod') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient surface area</li><li>Low temperature</li><li>Inadequate HRT</li><li>Nutrient deficiency</li></ul>';
      recommendations.push('Verify SALR < 20 g BOD/m¬≤/d');
      recommendations.push('Check temperature - apply correction factors');
      recommendations.push('Ensure HRT > 1 hour');
      recommendations.push('Verify N:P ratio adequate');
    } else if (perfIssue === 'low_nh3') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Nitrifiers outcompeted by heterotrophs</li><li>Low DO</li><li>Cold temperature</li><li>Alkalinity limited</li></ul>';
      recommendations.push('Ensure BOD:TKN ratio allows nitrifier growth');
      recommendations.push('Maintain DO > 3 mg/L');
      recommendations.push('Target SANR < 1.5 g N/m¬≤/d at 20¬∞C');
      recommendations.push('Check alkalinity > 50 mg/L as CaCO3');
    } else if (perfIssue === 'variable') {
      recommendations.push('Check for hydraulic short-circuiting');
      recommendations.push('Review loading patterns for shock loads');
      recommendations.push('Verify consistent aeration');
    } else if (perfIssue === 'declining') {
      recommendations.push('Check media for fouling or clogging');
      recommendations.push('Evaluate biofilm health');
      recommendations.push('Review maintenance frequency');
    }
    html += '</div>';
  }
  
  // Biofilm Issues
  if (biofilmIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #00b4d8">';
    html += '<h4 style="color:#a78bfa;margin:0 0 10px 0">üß´ Biofilm Issue: ' + biofilmIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';
    
    if (biofilmIssue === 'thin') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Excessive scour/shear</li><li>Low organic loading</li><li>Toxic compounds</li><li>Insufficient startup time</li></ul>';
      recommendations.push('Reduce aeration intensity');
      recommendations.push('Verify adequate BOD loading');
      recommendations.push('Check for toxic industrial discharge');
      recommendations.push('Allow 4-8 weeks for biofilm development');
    } else if (biofilmIssue === 'thick') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient shear/scour</li><li>High organic loading</li><li>Diffusion limitations</li></ul>';
      recommendations.push('Increase aeration for more scour');
      recommendations.push('Consider periodic high-intensity mixing');
      recommendations.push('Evaluate loading rate reduction');
    } else if (biofilmIssue === 'sloughing') {
      recommendations.push('Investigate toxic events');
      recommendations.push('Check for pH or temperature swings');
      recommendations.push('Review aeration consistency');
    } else if (biofilmIssue === 'dark') {
      recommendations.push('Increase DO - biofilm may be anaerobic');
      recommendations.push('Check for sulfide generation');
      recommendations.push('Review organic loading');
    }
    html += '</div>';
  }
  
  // Aeration Issues
  if (airIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #0077b6">';
    html += '<h4 style="color:#60a5fa;margin:0 0 10px 0">üí® Aeration Issue: ' + airIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';
    
    if (airIssue === 'uneven') {
      recommendations.push('Inspect diffuser grid for damage');
      recommendations.push('Check for clogged diffusers');
      recommendations.push('Verify header pipe sizing');
      recommendations.push('Consider diffuser cleaning/replacement');
    } else if (airIssue === 'low_do') {
      recommendations.push('Increase blower output');
      recommendations.push('Check for diffuser fouling');
      recommendations.push('Verify alpha factor for actual OTE');
      recommendations.push('Evaluate organic loading');
    } else if (airIssue === 'fouled_diff') {
      recommendations.push('Schedule diffuser cleaning');
      recommendations.push('Consider acid cleaning protocol');
      recommendations.push('Evaluate diffuser replacement cycle');
    } else if (airIssue === 'channeling') {
      recommendations.push('Review diffuser layout');
      recommendations.push('Add baffles to improve distribution');
      recommendations.push('Consider different diffuser type');
    }
    html += '</div>';
  }
  
  // Recommendations Summary
  if (recommendations.length > 0) {
    html += '<div style="background:linear-gradient(135deg,#065f46,#047857);padding:15px;border-radius:8px">';
    html += '<h4 style="color:#a7f3d0;margin:0 0 10px 0">‚úÖ Recommended Actions (' + recommendations.length + ')</h4>';
    html += '<ol style="color:#d1fae5;margin:0;padding-left:20px">';
    recommendations.forEach(function(rec) {
      html += '<li style="margin-bottom:8px">' + rec + '</li>';
    });
    html += '</ol></div>';
  } else if (issueCount === 0) {
    html += '<div style="background:#065f46;padding:20px;border-radius:8px;text-align:center">';
    html += '<span style="font-size:48px">‚úÖ</span>';
    html += '<h4 style="color:#a7f3d0;margin:10px 0 0 0">MBBR Operating Normally</h4>';
    html += '<p style="color:#d1fae5;margin:5px 0 0 0">No issues detected. Continue monitoring.</p>';
    html += '</div>';
  }
  
  // Quick Reference
  html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-top:15px">';
  html += '<h4 style="color:#60a5fa;margin:0 0 10px 0">üìö MBBR Quick Reference</h4>';
  html += '<table style="width:100%;color:#e0f2fe;font-size:14px">';
  html += '<tr><td>Typical SALR (BOD)</td><td><strong>5-20 g/m¬≤/d</strong></td></tr>';
  html += '<tr><td>Typical SANR (NH3)</td><td><strong>0.5-1.5 g N/m¬≤/d</strong></td></tr>';
  html += '<tr><td>Media Fill</td><td><strong>50-67%</strong></td></tr>';
  html += '<tr><td>Min HRT</td><td><strong>1-2 hours</strong></td></tr>';
  html += '<tr><td>DO Target</td><td><strong>3-5 mg/L</strong></td></tr>';
  html += '</table></div>';
  
  html += '</div>';
  document.getElementById('mbbr_troubleshoot_results').innerHTML = html;
  showToast('MBBR Diagnosis Complete', 'success');
}

function resetMBBRTroubleshoot() {
  document.getElementById('mbbr_media_issue').value = 'none';
  document.getElementById('mbbr_perf_issue').value = 'none';
  document.getElementById('mbbr_biofilm_issue').value = 'none';
  document.getElementById('mbbr_air_issue').value = 'none';
  document.getElementById('mbbr_troubleshoot_results').innerHTML = '';
}

// ==================== HYDRAULIC PROFILE CALCULATOR ====================
function calcHydraulicProfile() {
  var flow = parseFloat(document.getElementById('hydr_flow').value) || 5;
  var peakFactor = parseFloat(document.getElementById('hydr_peak').value) || 2.5;
  var outfallWSE = parseFloat(document.getElementById('hydr_outfall').value) || 100;
  var peakFlow = flow * peakFactor;
  
  // Get all head losses
  var losses = {
    'Outfall': 0,
    'Effluent Piping': parseFloat(document.getElementById('hl_eff_pipe').value) || 0,
    'Cascade Aerator': parseFloat(document.getElementById('hl_cascade').value) || 0,
    'UV/Disinfection': parseFloat(document.getElementById('hl_disinfect').value) || 0,
    'Filters': parseFloat(document.getElementById('hl_filters').value) || 0,
    'Secondary Eff Weir': parseFloat(document.getElementById('hl_sec_weir').value) || 0,
    'Secondary Clarifier': parseFloat(document.getElementById('hl_secondary').value) || 0,
    'Secondary Inlet': parseFloat(document.getElementById('hl_sec_in').value) || 0,
    'Aeration Basin': parseFloat(document.getElementById('hl_aeration').value) || 0,
    'Aeration Inlet': parseFloat(document.getElementById('hl_aer_in').value) || 0,
    'Primary Eff Weir': parseFloat(document.getElementById('hl_prim_weir').value) || 0,
    'Primary Clarifier': parseFloat(document.getElementById('hl_prim').value) || 0,
    'Primary Inlet': parseFloat(document.getElementById('hl_prim_in').value) || 0,
    'Flow Measurement': parseFloat(document.getElementById('hl_parshall').value) || 0,
    'Grit Chamber': parseFloat(document.getElementById('hl_grit').value) || 0,
    'Bar Screen': parseFloat(document.getElementById('hl_barscreen').value) || 0
  };
  
  // Calculate cumulative WSE from outfall upstream
  var profile = [];
  var currentWSE = outfallWSE;
  var totalLoss = 0;
  
  for (var unit in losses) {
    profile.push({
      unit: unit,
      headloss: losses[unit],
      wse: currentWSE,
      cumulative: totalLoss
    });
    currentWSE += losses[unit];
    totalLoss += losses[unit];
  }
  
  // Reverse to show from headworks to outfall
  profile.reverse();
  
  // Build results table
  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 15px 0">üìê Hydraulic Profile Results</h4>';
  html += '<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Design Flow</div>';
  html += '<div style="color:#4ade80;font-size:18px;font-weight:bold">' + flow.toFixed(1) + ' MGD</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Peak Flow</div>';
  html += '<div style="color:#ffd166;font-size:18px;font-weight:bold">' + peakFlow.toFixed(1) + ' MGD</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Total Head Loss</div>';
  html += '<div style="color:#60a5fa;font-size:18px;font-weight:bold">' + totalLoss.toFixed(2) + ' ft</div></div>';
  html += '</div>';
  
  html += '<table class="table"><thead><tr style="background:#374151">';
  html += '<th>Unit Process</th><th>Head Loss (ft)</th><th>WSE (ft)</th><th>Cumulative Loss (ft)</th>';
  html += '</tr></thead><tbody>';
  
  var cumLoss = 0;
  profile.forEach(function(p) {
    var rowColor = p.headloss > 0.4 ? '#fef3c7' : '';
    html += '<tr style="background:' + rowColor + '">';
    html += '<td><strong>' + p.unit + '</strong></td>';
    html += '<td>' + p.headloss.toFixed(2) + '</td>';
    html += '<td style="color:#4ade80;font-weight:bold">' + (outfallWSE + totalLoss - cumLoss).toFixed(2) + '</td>';
    html += '<td>' + cumLoss.toFixed(2) + '</td>';
    html += '</tr>';
    cumLoss += p.headloss;
  });
  
  html += '</tbody></table>';
  
  // Add headworks elevation
  var headworksWSE = outfallWSE + totalLoss;
  html += '<div style="margin-top:15px;padding:15px;background:linear-gradient(135deg,#059669,#06d6a0);border-radius:8px;text-align:center">';
  html += '<div style="font-size:14px;opacity:0.9">Required Headworks Water Surface Elevation</div>';
  html += '<div style="font-size:32px;font-weight:bold">' + headworksWSE.toFixed(2) + ' ft</div>';
  html += '</div></div>';
  
  document.getElementById('hydraulic_results').innerHTML = html;
  
  // Show and update chart
  document.getElementById('hydraulic_chart_container').style.display = 'block';
  updateHydraulicChart(profile, outfallWSE, totalLoss);
  
  showToast('Hydraulic Profile Calculated', 'success');
}

function updateHydraulicChart(profile, outfallWSE, totalLoss) {
  var ctx = document.getElementById('hydraulicChart');
  if (!ctx) return;
  
  if (window.hydraulicChartInstance) {
    window.hydraulicChartInstance.destroy();
  }
  
  var labels = profile.map(function(p) { return p.unit; });
  var cumLoss = 0;
  var wseData = profile.map(function(p) {
    var wse = outfallWSE + totalLoss - cumLoss;
    cumLoss += p.headloss;
    return wse;
  });
  
  window.hydraulicChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Water Surface Elevation (ft)',
        data: wseData,
        borderColor: '#4ade80',
        backgroundColor: 'rgba(74, 222, 128, 0.1)',
        fill: true,
        tension: 0.1,
        pointRadius: 6,
        pointBackgroundColor: '#4ade80'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          ticks: { 
            maxRotation: 45,
            minRotation: 45,
            font: { size: 10 }
          }
        },
        y: {
          title: { display: true, text: 'WSE (ft)' },
          beginAtZero: false
        }
      }
    }
  });
}

function exportHydraulicProfile() {
  var flow = document.getElementById('hydr_flow').value;
  var outfall = document.getElementById('hydr_outfall').value;
  
  var csv = 'WWTP Hydraulic Profile\nDesign Flow (MGD),' + flow + '\nOutfall WSE (ft),' + outfall + '\n\n';
  csv += 'Unit Process,Head Loss (ft)\n';
  
  var inputs = ['hl_barscreen','hl_grit','hl_parshall','hl_prim_in','hl_prim','hl_prim_weir','hl_aer_in','hl_aeration','hl_sec_in','hl_secondary','hl_sec_weir','hl_filters','hl_disinfect','hl_eff_pipe','hl_cascade'];
  var names = ['Bar Screen','Grit Chamber','Flow Measurement','Primary Inlet','Primary Clarifier','Primary Weir','Aeration Inlet','Aeration Basin','Secondary Inlet','Secondary Clarifier','Secondary Weir','Filters','UV/Disinfection','Effluent Piping','Cascade Aerator'];
  
  for (var i = 0; i < inputs.length; i++) {
    var val = document.getElementById(inputs[i]).value;
    csv += names[i] + ',' + val + '\n';
  }
  
  var blob = new Blob([csv], {type: 'text/csv'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'hydraulic_profile.csv';
  a.click();
  showToast('Hydraulic Profile exported to CSV', 'success');
}

function resetHydraulicProfile() {
  var defaults = {
    'hydr_flow': '5.0', 'hydr_peak': '2.5', 'hydr_outfall': '100.00',
    'hl_barscreen': '0.50', 'hl_grit': '0.25', 'hl_parshall': '0.30',
    'hl_prim_in': '0.20', 'hl_prim': '0.50', 'hl_prim_weir': '0.15',
    'hl_aer_in': '0.25', 'hl_aeration': '0.50', 'hl_sec_in': '0.30',
    'hl_secondary': '0.50', 'hl_sec_weir': '0.20', 'hl_filters': '0.00',
    'hl_disinfect': '0.25', 'hl_eff_pipe': '0.50', 'hl_cascade': '0.00'
  };
  for (var id in defaults) {
    document.getElementById(id).value = defaults[id];
  }
  document.getElementById('hydraulic_results').innerHTML = '';
  document.getElementById('hydraulic_chart_container').style.display = 'none';
}

// Pipe Headloss (Hazen-Williams)
function calcPipeHeadloss() {
  var Q = parseFloat(document.getElementById('pipe_flow').value) || 0; // GPM
  var D = parseFloat(document.getElementById('pipe_dia').value) || 8; // inches
  var L = parseFloat(document.getElementById('pipe_length').value) || 100; // ft
  var C = parseFloat(document.getElementById('pipe_c').value) || 130;
  var K = parseFloat(document.getElementById('pipe_k').value) || 0;
  
  // Convert to CFS
  var Qcfs = Q / 448.831;
  var Dft = D / 12;
  var A = Math.PI * Math.pow(Dft, 2) / 4;
  var V = Qcfs / A;
  
  // Hazen-Williams: hf = 10.67 * L * Q^1.852 / (C^1.852 * D^4.87)
  // Q in CFS, D in ft, L in ft
  var hf = 10.67 * L * Math.pow(Qcfs, 1.852) / (Math.pow(C, 1.852) * Math.pow(Dft, 4.87));
  
  // Minor losses: hm = K * V^2 / (2g)
  var hm = K * Math.pow(V, 2) / (2 * 32.2);
  var hTotal = hf + hm;
  var hPer100 = (hf / L) * 100;
  
  document.getElementById('r_pipe_vel').textContent = V.toFixed(2);
  document.getElementById('r_pipe_friction').textContent = hf.toFixed(3);
  document.getElementById('r_pipe_fittings').textContent = hm.toFixed(3);
  document.getElementById('r_pipe_total').textContent = hTotal.toFixed(3);
  document.getElementById('r_pipe_per100').textContent = hPer100.toFixed(3);
  
  // Velocity check
  var velStatus = V < 2 ? '‚ö†Ô∏è Low velocity' : V > 10 ? '‚ö†Ô∏è High velocity' : '‚úì OK';
  showToast('Pipe headloss calculated. Velocity: ' + velStatus, V >= 2 && V <= 10 ? 'success' : 'warning');
}

function resetPipeHeadloss() {
  document.getElementById('pipe_flow').value = '1000';
  document.getElementById('pipe_dia').value = '8';
  document.getElementById('pipe_length').value = '500';
  document.getElementById('pipe_c').value = '130';
  document.getElementById('pipe_k').value = '2.5';
  ['r_pipe_vel','r_pipe_friction','r_pipe_fittings','r_pipe_total','r_pipe_per100'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Weir Head Calculation
function calcWeir() {
  var Q = parseFloat(document.getElementById('weir_flow').value) || 0; // MGD
  var L = parseFloat(document.getElementById('weir_length').value) || 1; // ft
  var C = parseFloat(document.getElementById('weir_coef').value) || 3.33;
  
  // Convert MGD to CFS
  var Qcfs = Q * 1.547;
  
  // Q = C * L * H^1.5 => H = (Q / (C * L))^(2/3)
  var H = Math.pow(Qcfs / (C * L), 2/3);
  
  document.getElementById('r_weir_head').textContent = H.toFixed(3);
}

// Orifice Head Calculation
function calcOrifice() {
  var Q = parseFloat(document.getElementById('orif_flow').value) || 0; // GPM
  var D = parseFloat(document.getElementById('orif_dia').value) || 6; // inches
  var Cd = parseFloat(document.getElementById('orif_cd').value) || 0.62;
  
  // Convert to CFS
  var Qcfs = Q / 448.831;
  var A = Math.PI * Math.pow(D/12, 2) / 4; // sq ft
  
  // Q = Cd * A * sqrt(2 * g * H) => H = (Q / (Cd * A))^2 / (2 * g)
  var H = Math.pow(Qcfs / (Cd * A), 2) / (2 * 32.2);
  
  document.getElementById('r_orif_head').textContent = H.toFixed(3);
}

// Open Channel Flow (Manning's)
function calcChannelFlow() {
  var Q = parseFloat(document.getElementById('chan_flow').value) || 0; // MGD
  var b = parseFloat(document.getElementById('chan_width').value) || 4; // ft
  var S = parseFloat(document.getElementById('chan_slope').value) || 0.001;
  var n = parseFloat(document.getElementById('chan_n').value) || 0.015;
  var z = parseFloat(document.getElementById('chan_ss').value) || 0; // side slope
  
  // Convert MGD to CFS
  var Qcfs = Q * 1.547;
  
  // Iteratively solve for normal depth using Manning's equation
  // Q = (1.49/n) * A * R^(2/3) * S^(1/2)
  // For trapezoidal: A = (b + z*y) * y, P = b + 2*y*sqrt(1+z^2), R = A/P
  
  var y = 1.0; // initial guess
  for (var i = 0; i < 50; i++) {
    var A = (b + z * y) * y;
    var P = b + 2 * y * Math.sqrt(1 + z * z);
    var R = A / P;
    var Qcalc = (1.49 / n) * A * Math.pow(R, 2/3) * Math.sqrt(S);
    
    var error = Qcfs - Qcalc;
    if (Math.abs(error) < 0.001) break;
    
    // Newton-Raphson adjustment
    var dA_dy = b + 2 * z * y;
    var dP_dy = 2 * Math.sqrt(1 + z * z);
    var dR_dy = (dA_dy * P - A * dP_dy) / (P * P);
    var dQ_dy = (1.49 / n) * Math.sqrt(S) * (dA_dy * Math.pow(R, 2/3) + A * (2/3) * Math.pow(R, -1/3) * dR_dy);
    
    y = y + error / dQ_dy;
    if (y < 0.01) y = 0.01;
  }
  
  var A = (b + z * y) * y;
  var P = b + 2 * y * Math.sqrt(1 + z * z);
  var R = A / P;
  var V = Qcfs / A;
  var Fr = V / Math.sqrt(32.2 * (A / (b + 2 * z * y))); // Froude number
  
  document.getElementById('r_chan_depth').textContent = y.toFixed(3);
  document.getElementById('r_chan_area').textContent = A.toFixed(2);
  document.getElementById('r_chan_wp').textContent = P.toFixed(2);
  document.getElementById('r_chan_rh').textContent = R.toFixed(3);
  document.getElementById('r_chan_vel').textContent = V.toFixed(2);
  document.getElementById('r_chan_froude').textContent = Fr.toFixed(3) + (Fr < 1 ? ' (Subcritical)' : ' (Supercritical)');
  
  showToast('Channel flow calculated', 'success');
}

function resetChannelFlow() {
  document.getElementById('chan_flow').value = '5.0';
  document.getElementById('chan_width').value = '4';
  document.getElementById('chan_slope').value = '0.001';
  document.getElementById('chan_n').value = '0.015';
  document.getElementById('chan_ss').value = '0';
  ['r_chan_depth','r_chan_area','r_chan_wp','r_chan_rh','r_chan_vel','r_chan_froude'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}


// Business section switcher
function showBusinessSection(section) {
  document.getElementById('biz-clients').style.display = section === 'clients' ? 'block' : 'none';
  document.getElementById('biz-proposals').style.display = section === 'proposals' ? 'block' : 'none';
  document.getElementById('biz-roi').style.display = section === 'roi' ? 'block' : 'none';
  document.getElementById('biz-timetracking').style.display = section === 'timetracking' ? 'block' : 'none';
  document.getElementById('biz-ai-enhance').style.display = section === 'ai-enhance' ? 'block' : 'none';
  var costCalc = document.getElementById('biz-costcalc');
  if (costCalc) costCalc.style.display = section === 'costcalc' ? 'block' : 'none';
  var sheetsSync = document.getElementById('biz-sheets');
  if (sheetsSync) sheetsSync.style.display = section === 'sheets' ? 'block' : 'none';
  var serviceProp = document.getElementById('biz-serviceprop');
  if (serviceProp) serviceProp.style.display = section === 'serviceprop' ? 'block' : 'none';
  var scenariosSection = document.getElementById('biz-scenarios');
  if (scenariosSection) scenariosSection.style.display = section === 'scenarios' ? 'block' : 'none';
  
  // Initialize cost calculator when opened
  if (section === 'costcalc') {
    calculateAllCosts();
  }
}

// ==================== COST CALCULATOR FUNCTIONS v9.6.0 ====================

function calculateAllCosts() {
  var flowMGD = parseFloat(document.getElementById('cost_flow_mgd').value) || 0;
  var opDays = parseFloat(document.getElementById('cost_op_days').value) || 365;
  var kwhRate = parseFloat(document.getElementById('cost_kwh_rate').value) || 0;
  
  // Calculate chemical costs
  var chemDailyTotal = 0;
  var chemRows = document.querySelectorAll('#chemCostTable tbody tr');
  chemRows.forEach(function(row) {
    var dose = parseFloat(row.querySelector('.chem-dose').value) || 0;
    var price = parseFloat(row.querySelector('.chem-price').value) || 0;
    
    // lb/day = mg/L * MGD * 8.34
    var dailyUse = dose * flowMGD * 8.34;
    var dailyCost = dailyUse * price;
    var monthlyCost = dailyCost * 30;
    
    row.querySelector('.chem-daily-use').textContent = dailyUse.toFixed(1);
    row.querySelector('.chem-daily-cost').textContent = '$' + dailyCost.toFixed(2);
    row.querySelector('.chem-monthly-cost').textContent = '$' + monthlyCost.toFixed(2);
    
    chemDailyTotal += dailyCost;
  });
  
  document.getElementById('chem_daily_total').textContent = '$' + chemDailyTotal.toFixed(2);
  document.getElementById('chem_monthly_total').textContent = '$' + (chemDailyTotal * 30).toFixed(2);
  
  // Calculate energy costs
  var energyDailyKwh = 0;
  var energyDailyCost = 0;
  var equipRows = document.querySelectorAll('#energyCostTable tbody tr');
  equipRows.forEach(function(row) {
    var hp = parseFloat(row.querySelector('.equip-hp').value) || 0;
    var qty = parseFloat(row.querySelector('.equip-qty').value) || 0;
    var hrs = parseFloat(row.querySelector('.equip-hrs').value) || 0;
    
    // kW = HP * 0.746, daily kWh = kW * hours * qty
    var kw = hp * 0.746;
    var dailyKwh = kw * hrs * qty;
    var dailyCost = dailyKwh * kwhRate;
    var monthlyCost = dailyCost * 30;
    
    row.querySelector('.equip-daily-kwh').textContent = dailyKwh.toFixed(0);
    row.querySelector('.equip-daily-cost').textContent = '$' + dailyCost.toFixed(2);
    row.querySelector('.equip-monthly-cost').textContent = '$' + monthlyCost.toFixed(2);
    
    energyDailyKwh += dailyKwh;
    energyDailyCost += dailyCost;
  });
  
  document.getElementById('energy_daily_kwh').textContent = energyDailyKwh.toFixed(0);
  document.getElementById('energy_daily_total').textContent = '$' + energyDailyCost.toFixed(2);
  document.getElementById('energy_monthly_total').textContent = '$' + (energyDailyCost * 30).toFixed(2);
  
  // Calculate solids disposal costs
  var dryTons = parseFloat(document.getElementById('cost_sludge_tons').value) || 0;
  var disposalRate = parseFloat(document.getElementById('cost_disposal_rate').value) || 0;
  var cakeSolids = parseFloat(document.getElementById('cost_cake_solids').value) || 0;
  var haulingCost = parseFloat(document.getElementById('cost_hauling').value) || 0;
  var tonsPerLoad = parseFloat(document.getElementById('cost_tons_per_load').value) || 1;
  
  var wetTons = (cakeSolids > 0) ? (dryTons / (cakeSolids / 100)) : 0;
  var loadsPerMonth = (tonsPerLoad > 0) ? (wetTons * 30 / tonsPerLoad) : 0;
  var disposalCostMonth = wetTons * 30 * disposalRate;
  var haulingCostMonth = loadsPerMonth * haulingCost;
  var solidsTotalMonth = disposalCostMonth + haulingCostMonth;
  
  document.getElementById('solids_wet_tons').textContent = wetTons.toFixed(1);
  document.getElementById('solids_loads_month').textContent = loadsPerMonth.toFixed(1);
  document.getElementById('solids_disposal_cost').textContent = '$' + disposalCostMonth.toFixed(2);
  document.getElementById('solids_hauling_cost').textContent = '$' + haulingCostMonth.toFixed(2);
  document.getElementById('solids_monthly_total').textContent = '$' + solidsTotalMonth.toFixed(2);
  
  // Calculate totals
  var chemMonthly = chemDailyTotal * 30;
  var energyMonthly = energyDailyCost * 30;
  var solidsMonthly = solidsTotalMonth;
  
  var totalDaily = chemDailyTotal + energyDailyCost + (solidsTotalMonth / 30);
  var totalMonthly = chemMonthly + energyMonthly + solidsMonthly;
  var totalAnnual = totalMonthly * 12;
  
  var mgPerYear = flowMGD * opDays;
  var costPerMG = (mgPerYear > 0) ? (totalAnnual / mgPerYear) : 0;
  
  // Update KPI cards
  document.getElementById('cost_daily').textContent = '$' + totalDaily.toFixed(2);
  document.getElementById('cost_monthly').textContent = '$' + totalMonthly.toFixed(2);
  document.getElementById('cost_annual').textContent = '$' + totalAnnual.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('cost_per_mg').textContent = '$' + costPerMG.toFixed(2);
  
  // Update summary table
  document.getElementById('sum_chem_monthly').textContent = '$' + chemMonthly.toFixed(2);
  document.getElementById('sum_chem_annual').textContent = '$' + (chemMonthly * 12).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sum_energy_monthly').textContent = '$' + energyMonthly.toFixed(2);
  document.getElementById('sum_energy_annual').textContent = '$' + (energyMonthly * 12).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sum_solids_monthly').textContent = '$' + solidsMonthly.toFixed(2);
  document.getElementById('sum_solids_annual').textContent = '$' + (solidsMonthly * 12).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sum_total_monthly').innerHTML = '<strong>$' + totalMonthly.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</strong>';
  document.getElementById('sum_total_annual').innerHTML = '<strong>$' + totalAnnual.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</strong>';
  document.getElementById('sum_cost_per_mg').innerHTML = '<strong>$' + costPerMG.toFixed(2) + '/MG</strong>';
  
  console.log('[v9.6.0] Cost calculation complete. Total: $' + totalMonthly.toFixed(2) + '/month');
}

function addChemicalRow() {
  var tbody = document.querySelector('#chemCostTable tbody');
  var newRow = document.createElement('tr');
  newRow.innerHTML = '<td><input type="text" value="New Chemical" style="width:100px" class="chem-name"></td>' +
    '<td><input type="number" value="0" step="0.1" class="chem-dose" onchange="calculateAllCosts()"></td>' +
    '<td><input type="number" value="0.00" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>' +
    '<td class="chem-daily-use">-</td>' +
    '<td class="chem-daily-cost">-</td>' +
    '<td class="chem-monthly-cost">-</td>';
  tbody.appendChild(newRow);
}

function addEquipmentRow() {
  var tbody = document.querySelector('#energyCostTable tbody');
  var newRow = document.createElement('tr');
  newRow.innerHTML = '<td><input type="text" value="New Equipment" style="width:100px" class="equip-name"></td>' +
    '<td><input type="number" value="0" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>' +
    '<td><input type="number" value="1" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>' +
    '<td><input type="number" value="24" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>' +
    '<td class="equip-daily-kwh">-</td>' +
    '<td class="equip-daily-cost">-</td>' +
    '<td class="equip-monthly-cost">-</td>';
  tbody.appendChild(newRow);
}

function saveCostData() {
  var data = {
    flow: document.getElementById('cost_flow_mgd').value,
    opDays: document.getElementById('cost_op_days').value,
    kwhRate: document.getElementById('cost_kwh_rate').value,
    demandRate: document.getElementById('cost_demand_rate').value,
    sludgeTons: document.getElementById('cost_sludge_tons').value,
    disposalRate: document.getElementById('cost_disposal_rate').value,
    cakeSolids: document.getElementById('cost_cake_solids').value,
    hauling: document.getElementById('cost_hauling').value,
    tonsPerLoad: document.getElementById('cost_tons_per_load').value,
    chemicals: [],
    equipment: []
  };
  
  document.querySelectorAll('#chemCostTable tbody tr').forEach(function(row) {
    data.chemicals.push({
      name: row.querySelector('.chem-name').value,
      dose: row.querySelector('.chem-dose').value,
      price: row.querySelector('.chem-price').value
    });
  });
  
  document.querySelectorAll('#energyCostTable tbody tr').forEach(function(row) {
    data.equipment.push({
      name: row.querySelector('.equip-name').value,
      hp: row.querySelector('.equip-hp').value,
      qty: row.querySelector('.equip-qty').value,
      hrs: row.querySelector('.equip-hrs').value
    });
  });
  
  localStorage.setItem('wwtp_cost_data', JSON.stringify(data));
  showToast('üíæ Cost data saved!', 'success');
}

function loadCostData() {
  var saved = localStorage.getItem('wwtp_cost_data');
  if (!saved) return;
  
  try {
    var data = JSON.parse(saved);
    document.getElementById('cost_flow_mgd').value = data.flow || 5;
    document.getElementById('cost_op_days').value = data.opDays || 365;
    document.getElementById('cost_kwh_rate').value = data.kwhRate || 0.08;
    document.getElementById('cost_demand_rate').value = data.demandRate || 10;
    document.getElementById('cost_sludge_tons').value = data.sludgeTons || 2.5;
    document.getElementById('cost_disposal_rate').value = data.disposalRate || 45;
    document.getElementById('cost_cake_solids').value = data.cakeSolids || 22;
    document.getElementById('cost_hauling').value = data.hauling || 350;
    document.getElementById('cost_tons_per_load').value = data.tonsPerLoad || 20;
    
    console.log('[v9.6.0] Cost data loaded from localStorage');
  } catch(e) {
    console.error('Error loading cost data:', e);
  }
}

function exportCostReport() {
  var flow = document.getElementById('cost_flow_mgd').value;
  var daily = document.getElementById('cost_daily').textContent;
  var monthly = document.getElementById('cost_monthly').textContent;
  var annual = document.getElementById('cost_annual').textContent;
  var perMG = document.getElementById('cost_per_mg').textContent;
  
  var report = 'WWTP OPERATIONS COST REPORT\\n';
  report += '============================\\n\\n';
  report += 'Plant Flow: ' + flow + ' MGD\\n\\n';
  report += 'COST SUMMARY\\n';
  report += '------------\\n';
  report += 'Daily Cost: ' + daily + '\\n';
  report += 'Monthly Cost: ' + monthly + '\\n';
  report += 'Annual Cost: ' + annual + '\\n';
  report += 'Cost per MG: ' + perMG + '\\n\\n';
  report += 'Generated: ' + new Date().toLocaleString() + '\\n';
  report += 'WWTP Command Center v9.9.16';
  
  alert(report);
  showToast('üìÑ Report generated!', 'success');
}

// Load saved cost data on page load
document.addEventListener('DOMContentLoaded', function() {
  loadCostData();
});

// ==================== END COST CALCULATOR FUNCTIONS ====================

// Reactor section switcher
function showReactorSection(section) {
  console.log('showReactorSection called with:', section);
  
  // Get all reactor content divs
  var sbrDiv = document.getElementById('reactor-sbr');
  var mbrDiv = document.getElementById('reactor-mbr');
  var mbbrDiv = document.getElementById('reactor-mbbr');
  
  console.log('Found divs:', sbrDiv ? 'sbr-OK' : 'sbr-MISSING', mbrDiv ? 'mbr-OK' : 'mbr-MISSING', mbbrDiv ? 'mbbr-OK' : 'mbbr-MISSING');
  
  // Hide all sections
  if (sbrDiv) sbrDiv.style.display = 'none';
  if (mbrDiv) mbrDiv.style.display = 'none';
  if (mbbrDiv) mbbrDiv.style.display = 'none';
  
  // Show selected section
  if (section === 'sbr' && sbrDiv) sbrDiv.style.display = 'block';
  if (section === 'mbr' && mbrDiv) mbrDiv.style.display = 'block';
  if (section === 'mbbr' && mbbrDiv) mbbrDiv.style.display = 'block';
  
  // Update button active states
  var btnSbr = document.getElementById('btn-sbr');
  var btnMbr = document.getElementById('btn-mbr');
  var btnMbbr = document.getElementById('btn-mbbr');
  
  if (btnSbr) {
    btnSbr.className = section === 'sbr' ? 'btn gradient active' : 'btn gray';
  }
  if (btnMbr) {
    btnMbr.className = section === 'mbr' ? 'btn blue active' : 'btn gray';
  }
  if (btnMbbr) {
    btnMbbr.className = section === 'mbbr' ? 'btn purple active' : 'btn gray';
  }
  
  console.log('showReactorSection complete - showing:', section);
}

// ==================== AERATION & ENERGY CALCULATORS ====================
function calcAOTR() {
  var sotr = parseFloat(document.getElementById('aer_sotr').value) || 150;
  var temp = parseFloat(document.getElementById('aer_temp').value) || 20;
  var opDO = parseFloat(document.getElementById('aer_do').value) || 2.0;
  var satDO = parseFloat(document.getElementById('aer_do_sat').value) || 9.1;
  var alpha = parseFloat(document.getElementById('aer_alpha').value) || 0.85;
  var beta = parseFloat(document.getElementById('aer_beta').value) || 0.95;
  
  // Theta correction for temperature
  var theta = Math.pow(1.024, temp - 20);
  
  // DO saturation at field conditions
  var csField = beta * satDO;
  
  // AOTR calculation
  var aotr = sotr * alpha * theta * ((csField - opDO) / 9.17);
  
  // Transfer efficiency
  var eff = (aotr / sotr) * 100;
  
  document.getElementById('r_aer_theta').textContent = theta.toFixed(3);
  document.getElementById('r_aer_aotr').textContent = aotr.toFixed(1);
  document.getElementById('r_aer_eff').textContent = eff.toFixed(1);
}

function calcBlowerPower() {
  var scfm = parseFloat(document.getElementById('aer_scfm').value) || 5000;
  var psi = parseFloat(document.getElementById('aer_psi').value) || 8;
  var inletTemp = parseFloat(document.getElementById('aer_inlet_temp').value) || 70;
  var eff = parseFloat(document.getElementById('aer_blower_eff').value) / 100 || 0.70;
  
  // Convert to absolute values
  var p1 = 14.7; // atmospheric psia
  var p2 = p1 + psi;
  var t1 = inletTemp + 460; // Rankine
  
  // Adiabatic head (simplified)
  var k = 1.4; // specific heat ratio for air
  var head = (k / (k - 1)) * (t1 / 1) * (Math.pow(p2 / p1, (k - 1) / k) - 1);
  
  // Brake horsepower
  var bhp = (scfm * head) / (33000 * eff);
  var motorHP = bhp * 1.15; // 15% service factor
  var kw = motorHP * 0.746;
  
  document.getElementById('r_blower_bhp').textContent = bhp.toFixed(1);
  document.getElementById('r_blower_motor').textContent = Math.ceil(motorHP / 5) * 5; // Round to nearest 5 HP
  document.getElementById('r_blower_kw').textContent = kw.toFixed(1);
}

function calcEnergyUse() {
  var blowerHP = parseFloat(document.getElementById('eng_blower_hp').value) || 200;
  var pumpHP = parseFloat(document.getElementById('eng_pump_hp').value) || 100;
  var otherHP = parseFloat(document.getElementById('eng_other_hp').value) || 50;
  var hours = parseFloat(document.getElementById('eng_hours').value) || 24;
  var rate = parseFloat(document.getElementById('eng_rate').value) || 0.12;
  
  var totalHP = blowerHP + pumpHP + otherHP;
  var totalKW = totalHP * 0.746;
  var dailyKWH = totalKW * hours;
  var monthlyCost = dailyKWH * 30 * rate;
  var annualCost = dailyKWH * 365 * rate;
  
  // Intensity assuming 5 MGD
  var intensity = dailyKWH / 5;
  
  document.getElementById('r_eng_daily').textContent = dailyKWH.toFixed(0);
  document.getElementById('r_eng_monthly').textContent = '$' + monthlyCost.toFixed(0);
  document.getElementById('r_eng_annual').textContent = '$' + annualCost.toFixed(0);
  document.getElementById('r_eng_intensity').textContent = intensity.toFixed(0);
}

// ==================== CHEMICAL SYSTEMS CALCULATORS ====================
function calcChemFeed() {
  var flow = parseFloat(document.getElementById('chem_flow').value) || 5;
  var pIn = parseFloat(document.getElementById('chem_p_in').value) || 6;
  var pTarget = parseFloat(document.getElementById('chem_p_target').value) || 1;
  var chemType = document.getElementById('chem_type').value;
  var strength = parseFloat(document.getElementById('chem_strength').value) / 100 || 0.48;
  var cost = parseFloat(document.getElementById('chem_cost').value) || 2.50;
  
  var pRemoval = pIn - pTarget;
  
  // Me:P ratios vary by chemical
  var meP, meWeight;
  switch(chemType) {
    case 'alum': meP = 2.5; meWeight = 27; break; // Al
    case 'ferric': meP = 2.0; meWeight = 56; break; // Fe
    case 'pac': meP = 1.5; meWeight = 27; break; // Al in PAC
    default: meP = 2.0; meWeight = 56;
  }
  
  // Calculate dose
  var meDose = pRemoval * meP * (meWeight / 31); // mg/L as metal
  var chemDose = meDose / strength; // Adjust for solution strength
  
  // Feed rate
  var gpd = (flow * chemDose * 8.34) / (8.34 * strength);
  var dailyCost = (gpd / 1000) * cost * 1000; // Simplified
  
  document.getElementById('r_chem_ratio').textContent = meP.toFixed(1) + ':1';
  document.getElementById('r_chem_dose').textContent = chemDose.toFixed(1);
  document.getElementById('r_chem_gpd').textContent = gpd.toFixed(0);
  document.getElementById('r_chem_daily_cost').textContent = '$' + dailyCost.toFixed(0);
}

function calcChlorine() {
  var flow = parseFloat(document.getElementById('cl_flow').value) || 5;
  var dose = parseFloat(document.getElementById('cl_dose').value) || 5;
  var strengthEl = document.getElementById('cl_strength');
  var strength = strengthEl ? parseFloat(strengthEl.value) / 100 : 0.125;
  if (!strength) strength = 0.125; // default 12.5%
  var contactEl = document.getElementById('cl_contact');
  var contact = contactEl ? parseFloat(contactEl.value) : 30;
  
  var lbDay = flow * dose * 8.34;
  var gpd = lbDay / (8.34 * strength);
  var ct = dose * contact;
  
  // Update results - handle both full and simplified panels
  document.getElementById('r_cl_lb').textContent = lbDay.toFixed(1);
  var gpdEl = document.getElementById('r_cl_gpd');
  if (gpdEl) gpdEl.textContent = gpd.toFixed(0);
  var galEl = document.getElementById('r_cl_gal');
  if (galEl) galEl.textContent = gpd.toFixed(0);
  var ctEl = document.getElementById('r_cl_ct');
  if (ctEl) ctEl.textContent = ct.toFixed(0);
}

function calcPolymer() {
  var flow = parseFloat(document.getElementById('poly_flow').value) || 50;
  var solids = parseFloat(document.getElementById('poly_solids').value) / 100 || 0.01;
  var dose = parseFloat(document.getElementById('poly_dose').value) || 12;
  var concEl = document.getElementById('poly_conc');
  var conc = concEl ? parseFloat(concEl.value) / 100 : 0.005;
  if (!conc) conc = 0.005; // default 0.5%
  
  var gpd = flow * 60 * 24;
  var lbSolids = gpd * 8.34 * solids;
  var lbSolidsHr = (flow * 60) * 8.34 * solids; // lb/hr for simplified
  var dryTons = lbSolids / 2000;
  var polyLb = dryTons * dose;
  var polyLbHr = (lbSolidsHr / 2000) * dose; // lb/hr for simplified
  var solnGPM = (polyLb / 24 / 60) / (8.34 * conc);
  
  // Update results - handle both full and simplified panels
  var dtEl = document.getElementById('r_poly_dt');
  if (dtEl) dtEl.textContent = dryTons.toFixed(2);
  var dryEl = document.getElementById('r_poly_dry');
  if (dryEl) dryEl.textContent = lbSolidsHr.toFixed(1);
  document.getElementById('r_poly_lb').textContent = polyLbHr.toFixed(1);
  var gpmEl = document.getElementById('r_poly_gpm');
  if (gpmEl) gpmEl.textContent = solnGPM.toFixed(2);
}

function resetChlorine() {
  document.getElementById('cl_flow').value = '5.0';
  document.getElementById('cl_dose').value = '5.0';
  var strengthEl = document.getElementById('cl_strength');
  if (strengthEl) strengthEl.value = '12.5';
  var contactEl = document.getElementById('cl_contact');
  if (contactEl) contactEl.value = '30';
  document.getElementById('r_cl_lb').textContent = '-';
  var gpdEl = document.getElementById('r_cl_gpd');
  if (gpdEl) gpdEl.textContent = '-';
  var galEl = document.getElementById('r_cl_gal');
  if (galEl) galEl.textContent = '-';
  var ctEl = document.getElementById('r_cl_ct');
  if (ctEl) ctEl.textContent = '-';
}

function resetPolymer() {
  document.getElementById('poly_flow').value = '50';
  document.getElementById('poly_solids').value = '3.0';
  document.getElementById('poly_dose').value = '12';
  var concEl = document.getElementById('poly_conc');
  if (concEl) concEl.value = '0.5';
  var dtEl = document.getElementById('r_poly_dt');
  if (dtEl) dtEl.textContent = '-';
  document.getElementById('r_poly_lb').textContent = '-';
  var gpmEl = document.getElementById('r_poly_gpm');
  if (gpmEl) gpmEl.textContent = '-';
  var dryEl = document.getElementById('r_poly_dry');
  if (dryEl) dryEl.textContent = '-';
}

function calcGas() {
  var vs = parseFloat(document.getElementById('gas_vs').value) || 5000;
  var rate = parseFloat(document.getElementById('gas_rate').value) || 15;
  var ch4Pct = parseFloat(document.getElementById('gas_ch4').value) || 65;
  
  var totalGas = vs * rate;
  var methaneVol = totalGas * (ch4Pct / 100);
  var btu = methaneVol * 1000; // ~1000 BTU per cf methane
  var kw = btu / 3412 / 24; // Convert BTU/day to kW
  
  document.getElementById('r_gas_total').textContent = totalGas.toLocaleString();
  document.getElementById('r_gas_ch4').textContent = methaneVol.toLocaleString();
  document.getElementById('r_gas_btu').textContent = btu.toLocaleString();
  document.getElementById('r_gas_kw').textContent = kw.toFixed(1);
}

function resetGas() {
  document.getElementById('gas_vs').value = '5000';
  document.getElementById('gas_rate').value = '15';
  document.getElementById('gas_ch4').value = '65';
  document.getElementById('r_gas_total').textContent = '-';
  document.getElementById('r_gas_ch4').textContent = '-';
  document.getElementById('r_gas_btu').textContent = '-';
  document.getElementById('r_gas_kw').textContent = '-';
}

function calcMLSS() {
  var mlss = parseFloat(document.getElementById('mlss_val').value) || 3000;
  var vssRatio = parseFloat(document.getElementById('mlss_vss').value) || 75;
  var vol = parseFloat(document.getElementById('mlss_vol').value) || 1.5;
  
  var mlvss = mlss * (vssRatio / 100);
  var totalLb = mlss * vol * 8.34;
  var volatileLb = mlvss * vol * 8.34;
  
  document.getElementById('r_mlvss').textContent = mlvss.toFixed(0);
  document.getElementById('r_mlss_lb').textContent = totalLb.toLocaleString();
  document.getElementById('r_mlvss_lb').textContent = volatileLb.toLocaleString();
}

function resetMLSS() {
  document.getElementById('mlss_val').value = '3000';
  document.getElementById('mlss_vss').value = '75';
  document.getElementById('mlss_vol').value = '1.5';
  document.getElementById('r_mlvss').textContent = '-';
  document.getElementById('r_mlss_lb').textContent = '-';
  document.getElementById('r_mlvss_lb').textContent = '-';
}

function calcAlkalinity_Chem() {
  var flow = parseFloat(document.getElementById('alk_flow').value) || 5;
  var current = parseFloat(document.getElementById('alk_current').value) || 120;
  var target = parseFloat(document.getElementById('alk_target').value) || 200;
  var chem = document.getElementById('alk_chem').value;
  
  var increase = target - current;
  
  // Equivalent weights
  var factor, density;
  switch(chem) {
    case 'naoh': factor = 0.8; density = 12.5; break; // 50% NaOH
    case 'lime': factor = 0.74; density = 6; break; // Ca(OH)2
    case 'soda': factor = 1.06; density = 8; break; // Na2CO3
    default: factor = 0.8; density = 12.5;
  }
  
  var lbDay = flow * increase * 8.34 * factor;
  var gpd = lbDay / density;
  
  document.getElementById('r_alk_increase').textContent = increase.toFixed(0);
  document.getElementById('r_alk_lb').textContent = lbDay.toFixed(0);
  document.getElementById('r_alk_gpd').textContent = gpd.toFixed(0);
}

// ==================== EXPANDED CHEMICAL CALCULATORS ====================

// Default values for chemical types (from typical SDS)
const chemicalDefaults = {
  // Coagulants
  ferric: { strength: 40, sg: 1.42 },
  alum: { strength: 48.5, sg: 1.33 },
  pac: { strength: 10, sg: 1.19 },
  // pH chemicals
  caustic25: { strength: 25, sg: 1.27 },
  caustic50: { strength: 50, sg: 1.53 },
  lime: { strength: 100, sg: 1.0 },
  acid93: { strength: 93, sg: 1.83 },
  acid50: { strength: 50, sg: 1.40 },
  co2: { strength: 100, sg: 1.0 },
  // Carbon sources
  methanol: { ratio: 3.0, sg: 0.79 },
  glycerin: { ratio: 5.0, sg: 1.26 },
  microc: { ratio: 4.0, sg: 1.12 },
  acetic: { ratio: 4.5, sg: 1.05 },
  // Odor control
  ferrous: { strength: 30, sg: 1.35 },
  ferric_odor: { strength: 40, sg: 1.42 },
  nitrate: { strength: 45, sg: 1.50 },
  peroxide: { strength: 50, sg: 1.20 }
};

// Update coagulant defaults from dropdown
function updateCoagDefaults() {
  const type = document.getElementById('coag_type').value;
  if (type !== 'custom' && chemicalDefaults[type]) {
    document.getElementById('coag_strength').value = chemicalDefaults[type].strength;
    document.getElementById('coag_sg').value = chemicalDefaults[type].sg;
  }
}

// Update pH defaults from dropdown
function updatePHDefaults() {
  const type = document.getElementById('ph_type').value;
  if (type !== 'custom' && chemicalDefaults[type]) {
    document.getElementById('ph_strength').value = chemicalDefaults[type].strength;
    document.getElementById('ph_sg').value = chemicalDefaults[type].sg;
  }
}

// Update carbon source defaults from dropdown
function updateCarbonDefaults() {
  const type = document.getElementById('carbon_type').value;
  if (type !== 'custom' && chemicalDefaults[type]) {
    document.getElementById('carbon_ratio').value = chemicalDefaults[type].ratio;
    document.getElementById('carbon_sg').value = chemicalDefaults[type].sg;
  }
}

// Update odor control defaults from dropdown
function updateOdorDefaults() {
  const type = document.getElementById('odor_type').value;
  const key = type === 'ferric' ? 'ferric_odor' : type;
  if (type !== 'custom' && chemicalDefaults[key]) {
    document.getElementById('odor_strength').value = chemicalDefaults[key].strength;
    document.getElementById('odor_sg').value = chemicalDefaults[key].sg;
  }
}

// Dechlorination Calculator
function calcDechlorination() {
  var flow = parseFloat(document.getElementById('dechlor_flow').value) || 5;
  var clRes = parseFloat(document.getElementById('dechlor_cl_res').value) || 0.5;
  var ratio = parseFloat(document.getElementById('dechlor_ratio').value) || 1.2;
  var strength = parseFloat(document.getElementById('dechlor_strength').value) / 100 || 0.38;
  var sg = parseFloat(document.getElementById('dechlor_sg').value) || 1.35;
  var cost = parseFloat(document.getElementById('dechlor_cost').value) || 3.50;
  
  // SBS lb/day = Flow (MGD) √ó Cl residual (mg/L) √ó 8.34 √ó ratio
  var sbsLb = flow * clRes * 8.34 * ratio;
  // Solution gallons = lb / (8.34 √ó strength √ó SG)
  var galDay = sbsLb / (8.34 * strength * sg);
  var dailyCost = galDay * cost;
  
  document.getElementById('r_dechlor_lb').textContent = sbsLb.toFixed(2);
  document.getElementById('r_dechlor_gal').textContent = galDay.toFixed(2);
  document.getElementById('r_dechlor_cost').textContent = '$' + dailyCost.toFixed(2);
}

// Coagulant (Ferric/Alum) Calculator
function calcCoagulant() {
  var flow = parseFloat(document.getElementById('coag_flow').value) || 5;
  var dose = parseFloat(document.getElementById('coag_dose').value) || 30;
  var strength = parseFloat(document.getElementById('coag_strength').value) / 100 || 0.40;
  var sg = parseFloat(document.getElementById('coag_sg').value) || 1.42;
  var cost = parseFloat(document.getElementById('coag_cost').value) || 1.80;
  
  // Chemical lb/day = Flow (MGD) √ó dose (mg/L) √ó 8.34
  var lbDay = flow * dose * 8.34;
  
  // Solution gallons = lb / (8.34 √ó SG √ó strength)
  var galDay = lbDay / (8.34 * sg * strength);
  var gph = galDay / 24;
  var dailyCost = galDay * cost;
  
  document.getElementById('r_coag_lb').textContent = lbDay.toFixed(1);
  document.getElementById('r_coag_gal').textContent = galDay.toFixed(1);
  document.getElementById('r_coag_gph').textContent = gph.toFixed(2);
  document.getElementById('r_coag_cost').textContent = '$' + dailyCost.toFixed(2);
}

// pH Adjustment Calculator
function calcPHAdjust() {
  var flow = parseFloat(document.getElementById('ph_flow').value) || 5;
  var current = parseFloat(document.getElementById('ph_current').value) || 6.5;
  var target = parseFloat(document.getElementById('ph_target').value) || 7.2;
  var alk = parseFloat(document.getElementById('ph_alk').value) || 150;
  var strength = parseFloat(document.getElementById('ph_strength').value) / 100 || 0.25;
  var sg = parseFloat(document.getElementById('ph_sg').value) || 1.27;
  var cost = parseFloat(document.getElementById('ph_cost').value) || 2.50;
  var type = document.getElementById('ph_type').value;
  
  var delta = target - current;
  var lbDay = 0;
  var galDay = 0;
  var notes = '';
  var dailyCost = 0;
  
  if (Math.abs(delta) < 0.05) {
    notes = 'pH already at target.';
  } else if (delta > 0) {
    // Raising pH - estimate based on alkalinity
    var alkFactor = Math.max(0.5, alk / 100);
    var chemDose = Math.abs(delta) * 10 * alkFactor;
    lbDay = flow * chemDose * 8.34;
    
    if (type === 'lime') {
      galDay = lbDay; // Lime is dry, report as lb
      dailyCost = lbDay * cost;
      notes = 'Hydrated lime (dry). Watch for scaling.';
    } else {
      galDay = lbDay / (8.34 * sg * strength);
      dailyCost = galDay * cost;
      notes = type.includes('caustic') ? 'Caustic - CAUTION: Corrosive!' : '';
    }
  } else {
    // Lowering pH
    var chemDose = Math.abs(delta) * 15;
    lbDay = flow * chemDose * 8.34;
    
    if (type === 'co2') {
      galDay = lbDay;
      dailyCost = lbDay * cost;
      notes = 'CO‚ÇÇ injection. Safest pH reduction method.';
    } else {
      galDay = lbDay / (8.34 * sg * strength);
      dailyCost = galDay * cost;
      notes = type.includes('acid') ? 'H‚ÇÇSO‚ÇÑ - DANGER! Add acid to water.' : '';
    }
  }
  
  document.getElementById('r_ph_lb').textContent = lbDay.toFixed(1);
  document.getElementById('r_ph_gal').textContent = (type === 'lime' || type === 'co2') ? lbDay.toFixed(1) + ' lb' : galDay.toFixed(2);
  document.getElementById('r_ph_cost').textContent = '$' + dailyCost.toFixed(2);
  document.getElementById('r_ph_notes').textContent = notes;
}

// Carbon Source Calculator (Denitrification)
function calcCarbonSource() {
  var flow = parseFloat(document.getElementById('carbon_flow').value) || 5;
  var no3 = parseFloat(document.getElementById('carbon_no3').value) || 15;
  var ratio = parseFloat(document.getElementById('carbon_ratio').value) || 3.0;
  var sg = parseFloat(document.getElementById('carbon_sg').value) || 0.79;
  var cost = parseFloat(document.getElementById('carbon_cost').value) || 2.00;
  
  var nLoad = flow * no3 * 8.34; // lb N/day
  var carbonLb = nLoad * ratio; // lb carbon/day
  var galDay = carbonLb / (8.34 * sg);
  var dailyCost = galDay * cost;
  
  document.getElementById('r_carbon_nload').textContent = nLoad.toFixed(1);
  document.getElementById('r_carbon_lb').textContent = carbonLb.toFixed(1);
  document.getElementById('r_carbon_gal').textContent = galDay.toFixed(1);
  document.getElementById('r_carbon_cost').textContent = '$' + dailyCost.toFixed(2);
}

// Odor Control Calculator
function calcOdorControl() {
  var flow = parseFloat(document.getElementById('odor_flow').value) || 5;
  var h2s = parseFloat(document.getElementById('odor_h2s').value) || 5;
  var strength = parseFloat(document.getElementById('odor_strength').value) / 100 || 0.30;
  var sg = parseFloat(document.getElementById('odor_sg').value) || 1.35;
  var ratio = parseFloat(document.getElementById('odor_ratio').value) || 3.0;
  var cost = parseFloat(document.getElementById('odor_cost').value) || 1.50;
  
  var chemLb = flow * h2s * 8.34 * ratio;
  var galDay = chemLb / (8.34 * sg * strength);
  var dailyCost = galDay * cost;
  
  document.getElementById('r_odor_lb').textContent = chemLb.toFixed(1);
  document.getElementById('r_odor_gal').textContent = galDay.toFixed(1);
  document.getElementById('r_odor_cost').textContent = '$' + dailyCost.toFixed(2);
}

// Chemical Dilution Calculator
function calcDilution() {
  var c1 = parseFloat(document.getElementById('dil_c1').value) || 12.5;
  var c2 = parseFloat(document.getElementById('dil_c2').value) || 1.0;
  var v2 = parseFloat(document.getElementById('dil_v2').value) || 100;
  
  // C1 √ó V1 = C2 √ó V2
  var v1 = (c2 * v2) / c1;
  var water = v2 - v1;
  var dilRatio = c1 / c2;
  
  document.getElementById('r_dil_v1').textContent = v1.toFixed(2);
  document.getElementById('r_dil_water').textContent = water.toFixed(2);
  document.getElementById('r_dil_ratio').textContent = dilRatio.toFixed(1);
}

// Reset functions for chemical calculators
function resetDechlorination() {
  document.getElementById('dechlor_flow').value = '5.0';
  document.getElementById('dechlor_cl_res').value = '0.5';
  document.getElementById('dechlor_ratio').value = '1.2';
  document.getElementById('dechlor_strength').value = '38';
  document.getElementById('dechlor_sg').value = '1.35';
  document.getElementById('dechlor_cost').value = '3.50';
  document.getElementById('r_dechlor_lb').textContent = '-';
  document.getElementById('r_dechlor_gal').textContent = '-';
  document.getElementById('r_dechlor_cost').textContent = '-';
}

function resetCoagulant() {
  document.getElementById('coag_flow').value = '5.0';
  document.getElementById('coag_dose').value = '30';
  document.getElementById('coag_type').value = 'ferric';
  document.getElementById('coag_strength').value = '40';
  document.getElementById('coag_sg').value = '1.42';
  document.getElementById('coag_cost').value = '1.80';
  document.getElementById('r_coag_lb').textContent = '-';
  document.getElementById('r_coag_gal').textContent = '-';
  document.getElementById('r_coag_gph').textContent = '-';
  document.getElementById('r_coag_cost').textContent = '-';
}

function resetPHAdjust() {
  document.getElementById('ph_flow').value = '5.0';
  document.getElementById('ph_type').value = 'caustic25';
  document.getElementById('ph_current').value = '6.5';
  document.getElementById('ph_target').value = '7.2';
  document.getElementById('ph_alk').value = '150';
  document.getElementById('ph_strength').value = '25';
  document.getElementById('ph_sg').value = '1.27';
  document.getElementById('ph_cost').value = '2.50';
  document.getElementById('r_ph_lb').textContent = '-';
  document.getElementById('r_ph_gal').textContent = '-';
  document.getElementById('r_ph_cost').textContent = '-';
  document.getElementById('r_ph_notes').textContent = '-';
}

function resetCarbonSource() {
  document.getElementById('carbon_flow').value = '5.0';
  document.getElementById('carbon_no3').value = '15';
  document.getElementById('carbon_type').value = 'methanol';
  document.getElementById('carbon_ratio').value = '3.0';
  document.getElementById('carbon_sg').value = '0.79';
  document.getElementById('carbon_cost').value = '2.00';
  var nloadEl = document.getElementById('r_carbon_nload');
  if (nloadEl) nloadEl.textContent = '-';
  document.getElementById('r_carbon_lb').textContent = '-';
  document.getElementById('r_carbon_gal').textContent = '-';
  document.getElementById('r_carbon_cost').textContent = '-';
}

function resetOdorControl() {
  document.getElementById('odor_flow').value = '5.0';
  document.getElementById('odor_h2s').value = '5';
  document.getElementById('odor_type').value = 'ferrous';
  document.getElementById('odor_strength').value = '30';
  document.getElementById('odor_sg').value = '1.35';
  document.getElementById('odor_ratio').value = '3.0';
  document.getElementById('odor_cost').value = '1.50';
  document.getElementById('r_odor_lb').textContent = '-';
  document.getElementById('r_odor_gal').textContent = '-';
  document.getElementById('r_odor_cost').textContent = '-';
}

// ==================== CHEMICAL INVENTORY TRACKER ====================
var chemicalInventory = [];
var editingChemIndex = -1;

function initChemicalInventory() {
  var saved = localStorage.getItem('wwtp_chemical_inventory');
  if (saved) {
    chemicalInventory = JSON.parse(saved);
  } else {
    // Default starter chemicals
    chemicalInventory = [
      { name: 'Sodium Hypochlorite (12.5%)', current: 800, daily: 35, reorder: 300, cost: 1.25, supplier: '', lastDelivery: '', notes: '' },
      { name: 'Sodium Bisulfite (38%)', current: 400, daily: 15, reorder: 150, cost: 2.80, supplier: '', lastDelivery: '', notes: '' },
      { name: 'Ferric Chloride (40%)', current: 1200, daily: 50, reorder: 500, cost: 1.60, supplier: '', lastDelivery: '', notes: '' },
      { name: 'Polymer (Emulsion)', current: 55, daily: 2, reorder: 30, cost: 8.50, supplier: '', lastDelivery: '', notes: '' }
    ];
  }
  renderInventoryTable();
}

function saveInventoryToStorage() {
  localStorage.setItem('wwtp_chemical_inventory', JSON.stringify(chemicalInventory));
}

function renderInventoryTable() {
  var tbody = document.getElementById('inventoryBody');
  if (!tbody) return;
  
  tbody.innerHTML = '';
  var lowCount = 0;
  var totalValue = 0;
  var totalDays = 0;
  var alerts = [];
  
  chemicalInventory.forEach(function(chem, index) {
    var daysLeft = chem.daily > 0 ? Math.floor(chem.current / chem.daily) : 999;
    var isLow = chem.current <= chem.reorder;
    var isCritical = daysLeft <= 3;
    
    if (isLow) lowCount++;
    totalValue += chem.current * chem.cost;
    totalDays += daysLeft;
    
    var statusClass = isCritical ? 'background:#ef4444' : isLow ? 'background:#f59e0b' : 'background:#22c55e';
    var statusText = isCritical ? 'üö® Critical' : isLow ? '‚ö†Ô∏è Low' : '‚úÖ OK';
    
    if (isCritical) {
      alerts.push('<li style="color:#dc2626"><strong>' + chem.name + '</strong> - Only ' + daysLeft + ' days supply remaining!</li>');
    } else if (isLow) {
      alerts.push('<li style="color:#d97706"><strong>' + chem.name + '</strong> - Below reorder point (' + chem.current + '/' + chem.reorder + ' gal)</li>');
    }
    
    var row = '<tr style="border-bottom:1px solid #334155">' +
      '<td style="padding:10px">' + chem.name + '</td>' +
      '<td style="padding:10px;text-align:center">' + chem.current.toLocaleString() + '</td>' +
      '<td style="padding:10px;text-align:center">' + chem.daily + ' gal/day</td>' +
      '<td style="padding:10px;text-align:center;font-weight:bold;' + (isCritical ? 'color:#ef4444' : isLow ? 'color:#f59e0b' : '') + '">' + daysLeft + '</td>' +
      '<td style="padding:10px;text-align:center">' + chem.reorder.toLocaleString() + '</td>' +
      '<td style="padding:10px;text-align:center"><span style="' + statusClass + ';color:white;padding:4px 8px;border-radius:12px;font-size:11px">' + statusText + '</span></td>' +
      '<td style="padding:10px;text-align:center">' +
        '<button onclick="editChemical(' + index + ')" style="background:#3b82f6;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;margin-right:4px">‚úèÔ∏è</button>' +
        '<button onclick="deleteChemical(' + index + ')" style="background:#ef4444;color:white;border:none;padding:4px 8px;border-radius:4px;cursor:pointer">üóëÔ∏è</button>' +
      '</td>' +
    '</tr>';
    tbody.innerHTML += row;
  });
  
  // Update summary cards
  document.getElementById('inv_lowcount').textContent = lowCount;
  document.getElementById('inv_totalitems').textContent = chemicalInventory.length;
  document.getElementById('inv_totalvalue').textContent = '$' + totalValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
  document.getElementById('inv_avgdays').textContent = chemicalInventory.length > 0 ? Math.round(totalDays / chemicalInventory.length) : 0;
  
  // Update alerts
  var alertsPanel = document.getElementById('inventoryAlerts');
  var alertsList = document.getElementById('alertsList');
  if (alerts.length > 0) {
    alertsList.innerHTML = alerts.join('');
    alertsPanel.style.display = 'block';
  } else {
    alertsPanel.style.display = 'none';
  }
}

function showAddChemForm() {
  editingChemIndex = -1;
  document.getElementById('chemFormTitle').textContent = '‚ûï Add Chemical';
  document.getElementById('inv_name').value = '';
  document.getElementById('inv_current').value = '500';
  document.getElementById('inv_daily').value = '25';
  document.getElementById('inv_reorder').value = '200';
  document.getElementById('inv_cost').value = '1.50';
  document.getElementById('inv_supplier').value = '';
  document.getElementById('inv_lastdelivery').value = '';
  document.getElementById('inv_notes').value = '';
  document.getElementById('chemFormContainer').style.display = 'block';
}

function hideChemForm() {
  document.getElementById('chemFormContainer').style.display = 'none';
  editingChemIndex = -1;
}

function editChemical(index) {
  editingChemIndex = index;
  var chem = chemicalInventory[index];
  document.getElementById('chemFormTitle').textContent = '‚úèÔ∏è Edit Chemical';
  document.getElementById('inv_name').value = chem.name;
  document.getElementById('inv_current').value = chem.current;
  document.getElementById('inv_daily').value = chem.daily;
  document.getElementById('inv_reorder').value = chem.reorder;
  document.getElementById('inv_cost').value = chem.cost;
  document.getElementById('inv_supplier').value = chem.supplier || '';
  document.getElementById('inv_lastdelivery').value = chem.lastDelivery || '';
  document.getElementById('inv_notes').value = chem.notes || '';
  document.getElementById('chemFormContainer').style.display = 'block';
}

function saveChemicalInventory() {
  var name = document.getElementById('inv_name').value.trim();
  if (!name) {
    alert('Please enter a chemical name');
    return;
  }
  
  var chem = {
    name: name,
    current: parseFloat(document.getElementById('inv_current').value) || 0,
    daily: parseFloat(document.getElementById('inv_daily').value) || 0,
    reorder: parseFloat(document.getElementById('inv_reorder').value) || 0,
    cost: parseFloat(document.getElementById('inv_cost').value) || 0,
    supplier: document.getElementById('inv_supplier').value,
    lastDelivery: document.getElementById('inv_lastdelivery').value,
    notes: document.getElementById('inv_notes').value
  };
  
  if (editingChemIndex >= 0) {
    chemicalInventory[editingChemIndex] = chem;
    showToast('Chemical updated!', 'success');
  } else {
    chemicalInventory.push(chem);
    showToast('Chemical added!', 'success');
  }
  
  saveInventoryToStorage();
  renderInventoryTable();
  hideChemForm();
}

function deleteChemical(index) {
  if (confirm('Delete ' + chemicalInventory[index].name + ' from inventory?')) {
    chemicalInventory.splice(index, 1);
    saveInventoryToStorage();
    renderInventoryTable();
    showToast('Chemical removed', 'info');
  }
}

function recordDelivery() {
  if (chemicalInventory.length === 0) {
    alert('No chemicals in inventory. Add chemicals first.');
    return;
  }
  
  var options = chemicalInventory.map(function(c, i) { return (i + 1) + '. ' + c.name; }).join('\\n');
  var choice = prompt('Select chemical (enter number):\\n' + options);
  if (!choice) return;
  
  var index = parseInt(choice) - 1;
  if (index < 0 || index >= chemicalInventory.length) {
    alert('Invalid selection');
    return;
  }
  
  var quantity = prompt('Enter delivery quantity (gallons):');
  if (!quantity) return;
  
  var qty = parseFloat(quantity);
  if (isNaN(qty) || qty <= 0) {
    alert('Invalid quantity');
    return;
  }
  
  chemicalInventory[index].current += qty;
  chemicalInventory[index].lastDelivery = new Date().toISOString().split('T')[0];
  
  saveInventoryToStorage();
  renderInventoryTable();
  showToast(qty + ' gallons of ' + chemicalInventory[index].name + ' added!', 'success');
}

function exportInventoryReport() {
  var report = '=== CHEMICAL INVENTORY REPORT ===\\n';
  report += 'Generated: ' + new Date().toLocaleString() + '\\n\\n';
  
  var totalValue = 0;
  chemicalInventory.forEach(function(chem) {
    var daysLeft = chem.daily > 0 ? Math.floor(chem.current / chem.daily) : 999;
    var value = chem.current * chem.cost;
    totalValue += value;
    var status = chem.current <= chem.reorder ? (daysLeft <= 3 ? 'CRITICAL' : 'LOW') : 'OK';
    
    report += chem.name + '\\n';
    report += '  Current: ' + chem.current.toLocaleString() + ' gal\\n';
    report += '  Daily Use: ' + chem.daily + ' gal/day\\n';
    report += '  Days Supply: ' + daysLeft + '\\n';
    report += '  Reorder Point: ' + chem.reorder.toLocaleString() + ' gal\\n';
    report += '  Value: $' + value.toFixed(2) + '\\n';
    report += '  Status: ' + status + '\\n';
    if (chem.supplier) report += '  Supplier: ' + chem.supplier + '\\n';
    if (chem.lastDelivery) report += '  Last Delivery: ' + chem.lastDelivery + '\\n';
    report += '\\n';
  });
  
  report += '=== SUMMARY ===\\n';
  report += 'Total Items: ' + chemicalInventory.length + '\\n';
  report += 'Total Inventory Value: $' + totalValue.toFixed(2) + '\\n';
  
  // Create download
  var blob = new Blob([report.replace(/\\n/g, '\\n')], {type: 'text/plain'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'Chemical_Inventory_' + new Date().toISOString().split('T')[0] + '.txt';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Report exported!', 'success');
}

// Initialize inventory on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initChemicalInventory, 500);
});

// ==================== SOLIDS HANDLING CALCULATORS ====================
function calcSludgeProduction() {
  var flow = parseFloat(document.getElementById('sp_flow').value) || 5;
  var tssIn = parseFloat(document.getElementById('sp_tss_in').value) || 220;
  var primRem = parseFloat(document.getElementById('sp_prim_rem').value) / 100 || 0.6;
  var bodIn = parseFloat(document.getElementById('sp_bod_in').value) || 200;
  var yieldCoef = parseFloat(document.getElementById('sp_yield').value) || 0.6;
  var vssTss = parseFloat(document.getElementById('sp_vss_tss').value) || 0.75;
  
  var conv = flow * 8.34;
  
  // Primary sludge
  var primTSS = tssIn * primRem * conv;
  var primVol4pct = primTSS / (8.34 * 0.04);
  
  // Secondary (biological) sludge
  var secBOD = bodIn * (1 - primRem * 0.3) * 0.90; // BOD removed in secondary
  var bioVSS = secBOD * conv * yieldCoef;
  var bioTSS = bioVSS / vssTss;
  var wasVol1pct = bioTSS / (8.34 * 0.01);
  
  var totalSludge = primTSS + bioTSS;
  
  var html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">';
  html += '<div style="background:#1a2744;padding:15px;border-radius:8px">';
  html += '<h4 style="color:#ffd166;margin:0 0 15px 0">üî∂ Primary Sludge</h4>';
  html += '<div>TSS Captured: <strong>' + primTSS.toFixed(0) + '</strong> lb/day</div>';
  html += '<div>Volume @ 4%: <strong>' + primVol4pct.toFixed(0) + '</strong> gpd</div>';
  html += '</div>';
  html += '<div style="background:#1a2744;padding:15px;border-radius:8px">';
  html += '<h4 style="color:#a78bfa;margin:0 0 15px 0">üî∑ WAS (Secondary)</h4>';
  html += '<div>VSS Produced: <strong>' + bioVSS.toFixed(0) + '</strong> lb/day</div>';
  html += '<div>TSS Produced: <strong>' + bioTSS.toFixed(0) + '</strong> lb/day</div>';
  html += '<div>Volume @ 1%: <strong>' + wasVol1pct.toFixed(0) + '</strong> gpd</div>';
  html += '</div></div>';
  html += '<div style="background:#059669;padding:15px;border-radius:8px;margin-top:15px;color:white;text-align:center">';
  html += '<div style="font-size:12px">Total Daily Sludge Production</div>';
  html += '<div style="font-size:20px;font-weight:bold">' + totalSludge.toFixed(0) + ' lb/day</div>';
  html += '</div>';
  
  document.getElementById('sp_results').innerHTML = html;
}

function resetSludgeProduction() {
  document.getElementById('sp_flow').value = '5.0';
  document.getElementById('sp_tss_in').value = '220';
  document.getElementById('sp_results').innerHTML = '';
}

function calcWASRate() {
  var vol = parseFloat(document.getElementById('was_vol').value) || 1.5;
  var mlss = parseFloat(document.getElementById('was_mlss').value) || 3000;
  var srt = parseFloat(document.getElementById('was_srt').value) || 10;
  var conc = parseFloat(document.getElementById('was_conc').value) || 8000;
  
  var inventory = vol * mlss * 8.34;
  var wasMass = inventory / srt;
  var wasGPD = wasMass / (conc * 8.34 / 1000000);
  var wasGPM = wasGPD / 1440;
  
  document.getElementById('r_was_inv').textContent = inventory.toFixed(0);
  document.getElementById('r_was_mass').textContent = wasMass.toFixed(0);
  document.getElementById('r_was_gpd').textContent = wasGPD.toFixed(0);
  document.getElementById('r_was_gpm').textContent = wasGPM.toFixed(1);
}

function calcThickenerLoading() {
  var flow = parseFloat(document.getElementById('gt_flow').value) || 50000;
  var feedTSS = parseFloat(document.getElementById('gt_feed_tss').value) / 100 || 0.01;
  var dia = parseFloat(document.getElementById('gt_dia').value) || 30;
  
  var area = Math.PI * Math.pow(dia/2, 2);
  var hydLoad = flow / area;
  var solLoad = (flow * 8.34 * feedTSS) / area;
  
  var status = solLoad <= 10 ? 'Excellent' : solLoad <= 20 ? 'Good' : solLoad <= 30 ? 'Acceptable' : 'Overloaded';
  var statusClass = solLoad <= 10 ? 'good' : solLoad <= 20 ? 'good' : solLoad <= 30 ? 'warn' : 'bad';
  
  document.getElementById('r_gt_area').textContent = area.toFixed(0);
  document.getElementById('r_gt_hyd').textContent = hydLoad.toFixed(0);
  document.getElementById('r_gt_sol').textContent = solLoad.toFixed(1);
  document.getElementById('r_gt_status').textContent = status;
  document.getElementById('r_gt_status').className = 'status ' + statusClass;
}

function calcDewatering() {
  var feed = parseFloat(document.getElementById('dw_feed').value) || 50;
  var feedPct = parseFloat(document.getElementById('dw_feed_pct').value) / 100 || 0.03;
  var cakePct = parseFloat(document.getElementById('dw_cake_pct').value) / 100 || 0.20;
  var polyDose = parseFloat(document.getElementById('dw_poly').value) || 12;
  var polyCost = parseFloat(document.getElementById('dw_poly_cost').value) || 2.50;
  
  var feedGPD = feed * 60 * 24;
  var feedLb = feedGPD * 8.34 * feedPct;
  var dryTons = feedLb / 2000;
  var cakeLb = feedLb; // solids in = solids out (conservation)
  var cakeWet = cakeLb / cakePct;
  var cakeTons = cakeWet / 2000;
  var polyLb = dryTons * polyDose;
  var polyCostDay = polyLb * polyCost;
  var captureEff = 95; // typical
  
  var html = '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Feed Solids</div>';
  html += '<div style="color:#4ade80;font-size:20px;font-weight:bold">' + feedLb.toFixed(0) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">lb/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Dry Tons/Day</div>';
  html += '<div style="color:#60a5fa;font-size:20px;font-weight:bold">' + dryTons.toFixed(1) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">DT/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Wet Cake</div>';
  html += '<div style="color:#ffd166;font-size:20px;font-weight:bold">' + cakeTons.toFixed(1) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">wet tons/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Polymer Cost</div>';
  html += '<div style="color:#a78bfa;font-size:20px;font-weight:bold">$' + polyCostDay.toFixed(0) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">per day</div></div>';
  html += '</div>';
  
  document.getElementById('dw_results').innerHTML = html;
}

// ==================== TCEQ COMPLIANCE MODULE ====================

// ==================== CHEMICAL FEED OPTIMIZER ====================
function optimizeChemFeed() {
  var flow = parseFloat(document.getElementById('cfo_flow').value) || 5;
  var pIn = parseFloat(document.getElementById('cfo_p_in').value) || 6;
  var pTarget = parseFloat(document.getElementById('cfo_p_target').value) || 1;
  var ph = parseFloat(document.getElementById('cfo_ph').value) || 7;
  var alk = parseFloat(document.getElementById('cfo_alk').value) || 200;
  var chem = document.getElementById('cfo_chem1').value;
  var strength = parseFloat(document.getElementById('cfo_strength').value) || 48;
  var sg = parseFloat(document.getElementById('cfo_sg').value) || 1.33;
  var cost = parseFloat(document.getElementById('cfo_cost').value) || 0.15;
  var targetRatio = parseFloat(document.getElementById('cfo_ratio').value) || 2;
  
  var pRemoval = pIn - pTarget;
  var pLoad = pRemoval * flow * 8.34; // lb P/day
  
  // Chemical properties
  var chemProps = {
    alum: { mw: 594, me_mw: 27, me_per_mol: 2, name: 'Alum', optimal_ph: [6.0, 7.0] },
    ferric: { mw: 162.2, me_mw: 55.85, me_per_mol: 1, name: 'Ferric Chloride', optimal_ph: [4.5, 5.5] },
    ferrous: { mw: 278, me_mw: 55.85, me_per_mol: 1, name: 'Ferrous Sulfate', optimal_ph: [7.0, 8.0] },
    pac: { mw: 174, me_mw: 27, me_per_mol: 1.5, name: 'PAC', optimal_ph: [6.5, 7.5] }
  };
  
  var props = chemProps[chem];
  var meRequired = pLoad * targetRatio / 31; // moles of metal
  var chemRequired = meRequired * props.mw / props.me_per_mol; // lb chemical/day
  
  var solutionLbGal = sg * 8.34 * (strength / 100);
  var solutionGPD = chemRequired / solutionLbGal;
  var solutionGPH = solutionGPD / 24;
  var mlMin = solutionGPH * 3785.41 / 60;
  
  // Alkalinity consumption (approx 0.5 mg/L alk per mg/L alum)
  var alkConsumed = (chemRequired / (flow * 8.34)) * 0.5;
  var alkRemaining = alk - alkConsumed;
  
  // pH impact assessment
  var phOptimal = ph >= props.optimal_ph[0] && ph <= props.optimal_ph[1];
  
  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 20px 0">üéØ Optimized Chemical Feed - ' + props.name + '</h4>';
  
  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">P to Remove</div>';
  html += '<div style="color:#4ade80;font-size:20px;font-weight:bold">' + pRemoval.toFixed(1) + ' mg/L</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">P Load</div>';
  html += '<div style="color:#60a5fa;font-size:20px;font-weight:bold">' + pLoad.toFixed(1) + ' lb/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Me:P Ratio</div>';
  html += '<div style="color:#ffd166;font-size:20px;font-weight:bold">' + targetRatio.toFixed(1) + ':1</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Chemical Dose</div>';
  html += '<div style="color:#a78bfa;font-size:20px;font-weight:bold">' + (chemRequired / (flow * 8.34)).toFixed(0) + ' mg/L</div></div>';
  html += '</div>';
  
  html += '<table class="table"><tbody>';
  html += '<tr><td>Chemical Feed Rate</td><td><strong>' + chemRequired.toFixed(1) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>Solution Feed Rate</td><td><strong>' + solutionGPD.toFixed(1) + '</strong></td><td>gpd</td></tr>';
  html += '<tr><td>Hourly Feed Rate</td><td><strong>' + solutionGPH.toFixed(2) + '</strong></td><td>gph</td></tr>';
  html += '<tr><td>Feed Rate</td><td><strong>' + mlMin.toFixed(1) + '</strong></td><td>mL/min</td></tr>';
  html += '<tr><td>Alk Remaining</td><td><strong>' + alkRemaining.toFixed(0) + '</strong></td><td>mg/L as CaCO3</td></tr>';
  html += '</tbody></table>';
  
  // pH optimization note
  if (!phOptimal) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Current pH (' + ph + ') is outside optimal range (' + props.optimal_ph[0] + '-' + props.optimal_ph[1] + ') for ' + props.name + '. Consider pH adjustment for better performance.</div>';
  }
  
  if (alkRemaining < 50) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Low residual alkalinity may cause pH depression. Consider supplemental alkalinity (lime/soda ash).</div>';
  }
  
  html += '</div>';
  document.getElementById('cfo_results').innerHTML = html;
  showToast('Chemical feed optimized', 'success');
}

function calcChemCost() {
  var flow = parseFloat(document.getElementById('cfo_flow').value) || 5;
  var pIn = parseFloat(document.getElementById('cfo_p_in').value) || 6;
  var pTarget = parseFloat(document.getElementById('cfo_p_target').value) || 1;
  var cost = parseFloat(document.getElementById('cfo_cost').value) || 0.15;
  var strength = parseFloat(document.getElementById('cfo_strength').value) || 48;
  var sg = parseFloat(document.getElementById('cfo_sg').value) || 1.33;
  var targetRatio = parseFloat(document.getElementById('cfo_ratio').value) || 2;
  
  var pRemoval = pIn - pTarget;
  var pLoad = pRemoval * flow * 8.34;
  var chemRequired = pLoad * targetRatio * 5.4; // Approx for alum
  
  var dailyCost = chemRequired * cost;
  var monthlyCost = dailyCost * 30;
  var annualCost = dailyCost * 365;
  var costPerMG = dailyCost / flow;
  
  var html = '<div style="background:linear-gradient(135deg,#059669,#06d6a0);padding:20px;border-radius:12px;margin-top:15px">';
  html += '<h4 style="margin:0 0 15px 0">üí∞ Cost Analysis</h4>';
  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px">';
  html += '<div><div style="opacity:0.9;font-size:12px">Daily</div><div style="font-size:18px;font-weight:bold">$' + dailyCost.toFixed(0) + '</div></div>';
  html += '<div><div style="opacity:0.9;font-size:12px">Monthly</div><div style="font-size:18px;font-weight:bold">$' + monthlyCost.toFixed(0) + '</div></div>';
  html += '<div><div style="opacity:0.9;font-size:12px">Annual</div><div style="font-size:18px;font-weight:bold">$' + annualCost.toLocaleString() + '</div></div>';
  html += '<div><div style="opacity:0.9;font-size:12px">Per MG</div><div style="font-size:18px;font-weight:bold">$' + costPerMG.toFixed(2) + '</div></div>';
  html += '</div></div>';
  
  document.getElementById('cfo_results').innerHTML += html;
}

function resetChemOptimizer() {
  document.getElementById('cfo_flow').value = '5.0';
  document.getElementById('cfo_p_in').value = '6.0';
  document.getElementById('cfo_p_target').value = '1.0';
  document.getElementById('cfo_results').innerHTML = '';
}

// ==================== EQUALIZATION BASIN SIZING ====================
function calcEQBasin() {
  var avgFlow = parseFloat(document.getElementById('eq_avg_flow').value) || 5;
  var peakFlow = parseFloat(document.getElementById('eq_peak_flow').value) || 8;
  var minFlow = parseFloat(document.getElementById('eq_min_flow').value) || 2.5;
  var targetFlow = parseFloat(document.getElementById('eq_target').value) || 5.5;
  var depth = parseFloat(document.getElementById('eq_depth').value) || 12;
  var freeboard = parseFloat(document.getElementById('eq_freeboard').value) || 2;
  var sf = parseFloat(document.getElementById('eq_sf').value) || 1.25;
  
  // Get hourly pattern
  var pattern = [];
  for (var h = 0; h < 24; h += 2) {
    var pct = parseFloat(document.getElementById('eq_h' + h).value) || 100;
    pattern.push(pct / 100);
    pattern.push(pct / 100); // Duplicate for odd hours
  }
  
  // Calculate cumulative volume difference
  var hourlyAvg = avgFlow / 24;
  var hourlyTarget = targetFlow / 24;
  var cumulative = 0;
  var maxStorage = 0;
  var minStorage = 0;
  
  for (var i = 0; i < 24; i++) {
    var hourlyIn = hourlyAvg * pattern[i];
    var diff = hourlyIn - hourlyTarget;
    cumulative += diff;
    maxStorage = Math.max(maxStorage, cumulative);
    minStorage = Math.min(minStorage, cumulative);
  }
  
  var requiredVolMG = (maxStorage - minStorage) * sf;
  var requiredVolGal = requiredVolMG * 1000000;
  var requiredVolCF = requiredVolGal / 7.48;
  var surfaceArea = requiredVolCF / depth;
  var sideDim = Math.sqrt(surfaceArea);
  
  var totalDepth = depth + freeboard;
  var detentionTime = (requiredVolMG / avgFlow) * 24 * 60; // minutes
  
  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 20px 0">üåä Equalization Basin Design</h4>';
  
  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Peak Factor</div>';
  html += '<div style="color:#ffd166;font-size:18px;font-weight:bold">' + (peakFlow/avgFlow).toFixed(2) + '</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Required Volume</div>';
  html += '<div style="color:#4ade80;font-size:18px;font-weight:bold">' + requiredVolMG.toFixed(2) + ' MG</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Detention Time</div>';
  html += '<div style="color:#60a5fa;font-size:18px;font-weight:bold">' + detentionTime.toFixed(0) + ' min</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Surface Area</div>';
  html += '<div style="color:#a78bfa;font-size:18px;font-weight:bold">' + surfaceArea.toFixed(0) + ' sf</div></div>';
  html += '</div>';
  
  html += '<table class="table"><tbody>';
  html += '<tr><td>Required Volume</td><td><strong>' + requiredVolGal.toLocaleString() + '</strong></td><td>gallons</td></tr>';
  html += '<tr><td>Operating Depth</td><td><strong>' + depth + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Total Depth (w/ freeboard)</td><td><strong>' + totalDepth + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Basin Dimensions (square)</td><td><strong>' + sideDim.toFixed(0) + ' √ó ' + sideDim.toFixed(0) + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Safety Factor Applied</td><td><strong>' + sf + '</strong></td><td></td></tr>';
  html += '</tbody></table>';
  
  html += '<div class="note info" style="margin-top:15px">üí° <strong>Design Notes:</strong> Provide mixing (10-20 HP/MG), odor control for >4 hr detention, and consider aeration if detention >30 minutes.</div>';
  html += '</div>';
  
  document.getElementById('eq_results').innerHTML = html;
  showToast('EQ basin sized', 'success');
}

function loadTypicalPattern() {
  var typical = {50:0, 40:2, 45:4, 80:6, 130:8, 120:10, 115:12, 110:14, 105:16, 125:18, 110:20, 70:22};
  for (var h in typical) {
    document.getElementById('eq_h' + typical[h]).value = h;
  }
  // Fix the mapping
  document.getElementById('eq_h0').value = '50';
  document.getElementById('eq_h2').value = '40';
  document.getElementById('eq_h4').value = '45';
  document.getElementById('eq_h6').value = '80';
  document.getElementById('eq_h8').value = '130';
  document.getElementById('eq_h10').value = '120';
  document.getElementById('eq_h12').value = '115';
  document.getElementById('eq_h14').value = '110';
  document.getElementById('eq_h16').value = '105';
  document.getElementById('eq_h18').value = '125';
  document.getElementById('eq_h20').value = '110';
  document.getElementById('eq_h22').value = '70';
  showToast('Typical diurnal pattern loaded', 'success');
}

function resetEQBasin() {
  document.getElementById('eq_avg_flow').value = '5.0';
  document.getElementById('eq_peak_flow').value = '8.0';
  document.getElementById('eq_results').innerHTML = '';
  loadTypicalPattern();
}

// ==================== VIOLATION RISK PREDICTOR ====================
function predictViolationRisk() {
  var bodLimit = parseFloat(document.getElementById('vr_bod_limit').value) || 45;
  var bodMonthly = parseFloat(document.getElementById('vr_bod_monthly').value) || 30;
  var tssLimit = parseFloat(document.getElementById('vr_tss_limit').value) || 45;
  var tssMonthly = parseFloat(document.getElementById('vr_tss_monthly').value) || 30;
  var nh3Limit = parseFloat(document.getElementById('vr_nh3_limit').value) || 4;
  
  var bodAvg = parseFloat(document.getElementById('vr_bod_avg').value) || 18;
  var bodStd = parseFloat(document.getElementById('vr_bod_std').value) || 5;
  var tssAvg = parseFloat(document.getElementById('vr_tss_avg').value) || 15;
  var tssStd = parseFloat(document.getElementById('vr_tss_std').value) || 4;
  var nh3Avg = parseFloat(document.getElementById('vr_nh3_avg').value) || 1.5;
  var nh3Std = parseFloat(document.getElementById('vr_nh3_std').value) || 0.8;
  
  // Calculate Z-scores and probabilities using normal distribution
  function calcRisk(avg, std, limit) {
    var z = (limit - avg) / std;
    // Approximate normal CDF
    var risk = 1 - normalCDF(z);
    return Math.max(0, Math.min(100, risk * 100));
  }
  
  function normalCDF(z) {
    var a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
    var a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    var sign = z < 0 ? -1 : 1;
    z = Math.abs(z) / Math.sqrt(2);
    var t = 1.0 / (1.0 + p * z);
    var y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-z * z);
    return 0.5 * (1.0 + sign * y);
  }
  
  var bodDailyRisk = calcRisk(bodAvg, bodStd, bodLimit);
  var bodMonthlyRisk = calcRisk(bodAvg, bodStd / Math.sqrt(30), bodMonthly);
  var tssDailyRisk = calcRisk(tssAvg, tssStd, tssLimit);
  var tssMonthlyRisk = calcRisk(tssAvg, tssStd / Math.sqrt(30), tssMonthly);
  var nh3Risk = calcRisk(nh3Avg, nh3Std, nh3Limit);
  
  var overallRisk = Math.max(bodDailyRisk, bodMonthlyRisk, tssDailyRisk, tssMonthlyRisk, nh3Risk);
  
  function riskColor(risk) {
    if (risk < 5) return '#06d6a0';
    if (risk < 15) return '#ffd166';
    return '#ef4444';
  }
  
  function riskLevel(risk) {
    if (risk < 5) return 'LOW';
    if (risk < 15) return 'MODERATE';
    return 'HIGH';
  }
  
  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 20px 0">‚ö†Ô∏è Violation Risk Assessment</h4>';
  
  // Overall risk gauge
  html += '<div style="text-align:center;margin-bottom:25px">';
  html += '<div style="font-size:14px;color:#94a3b8;margin-bottom:10px">Overall Violation Risk</div>';
  html += '<div style="font-size:48px;font-weight:bold;color:' + riskColor(overallRisk) + '">' + overallRisk.toFixed(1) + '%</div>';
  html += '<div style="font-size:18px;color:' + riskColor(overallRisk) + '">' + riskLevel(overallRisk) + ' RISK</div>';
  html += '</div>';
  
  html += '<table class="table"><thead><tr><th>Parameter</th><th>Limit</th><th>Avg ¬± œÉ</th><th>Risk %</th><th>Status</th></tr></thead><tbody>';
  
  html += '<tr><td>BOD (Daily Max)</td><td>' + bodLimit + ' mg/L</td><td>' + bodAvg + ' ¬± ' + bodStd + '</td>';
  html += '<td style="color:' + riskColor(bodDailyRisk) + ';font-weight:bold">' + bodDailyRisk.toFixed(1) + '%</td>';
  html += '<td><span style="color:' + riskColor(bodDailyRisk) + '">' + riskLevel(bodDailyRisk) + '</span></td></tr>';
  
  html += '<tr><td>BOD (Monthly Avg)</td><td>' + bodMonthly + ' mg/L</td><td>' + bodAvg + ' ¬± ' + (bodStd/Math.sqrt(30)).toFixed(1) + '</td>';
  html += '<td style="color:' + riskColor(bodMonthlyRisk) + ';font-weight:bold">' + bodMonthlyRisk.toFixed(1) + '%</td>';
  html += '<td><span style="color:' + riskColor(bodMonthlyRisk) + '">' + riskLevel(bodMonthlyRisk) + '</span></td></tr>';
  
  html += '<tr><td>TSS (Daily Max)</td><td>' + tssLimit + ' mg/L</td><td>' + tssAvg + ' ¬± ' + tssStd + '</td>';
  html += '<td style="color:' + riskColor(tssDailyRisk) + ';font-weight:bold">' + tssDailyRisk.toFixed(1) + '%</td>';
  html += '<td><span style="color:' + riskColor(tssDailyRisk) + '">' + riskLevel(tssDailyRisk) + '</span></td></tr>';
  
  html += '<tr><td>TSS (Monthly Avg)</td><td>' + tssMonthly + ' mg/L</td><td>' + tssAvg + ' ¬± ' + (tssStd/Math.sqrt(30)).toFixed(1) + '</td>';
  html += '<td style="color:' + riskColor(tssMonthlyRisk) + ';font-weight:bold">' + tssMonthlyRisk.toFixed(1) + '%</td>';
  html += '<td><span style="color:' + riskColor(tssMonthlyRisk) + '">' + riskLevel(tssMonthlyRisk) + '</span></td></tr>';
  
  html += '<tr><td>NH3-N (Daily Max)</td><td>' + nh3Limit + ' mg/L</td><td>' + nh3Avg + ' ¬± ' + nh3Std + '</td>';
  html += '<td style="color:' + riskColor(nh3Risk) + ';font-weight:bold">' + nh3Risk.toFixed(1) + '%</td>';
  html += '<td><span style="color:' + riskColor(nh3Risk) + '">' + riskLevel(nh3Risk) + '</span></td></tr>';
  
  html += '</tbody></table>';
  
  // Recommendations
  if (overallRisk > 15) {
    html += '<div class="note warning" style="margin-top:15px"><strong>‚ö†Ô∏è High Risk Recommendations:</strong><ul style="margin:10px 0 0 20px">';
    if (bodDailyRisk > 15 || bodMonthlyRisk > 15) html += '<li>Increase MLSS or SRT to improve BOD removal</li>';
    if (tssDailyRisk > 15 || tssMonthlyRisk > 15) html += '<li>Check clarifier performance and RAS rates</li>';
    if (nh3Risk > 15) html += '<li>Increase SRT for nitrification, verify DO > 2.0 mg/L</li>';
    html += '</ul></div>';
  } else if (overallRisk > 5) {
    html += '<div class="note info" style="margin-top:15px"><strong>üí° Moderate Risk:</strong> Continue monitoring. Consider operational adjustments to increase safety margin.</div>';
  } else {
    html += '<div class="note success" style="margin-top:15px"><strong>‚úÖ Low Risk:</strong> Current operations provide adequate safety margin against violations.</div>';
  }
  
  html += '</div>';
  document.getElementById('vr_results').innerHTML = html;
  showToast('Risk assessment complete', 'success');
}

function showRiskTrend() {
  showToast('Risk trending feature - coming soon!', 'info');
}

function resetViolationRisk() {
  document.getElementById('vr_bod_avg').value = '18';
  document.getElementById('vr_bod_std').value = '5';
  document.getElementById('vr_tss_avg').value = '15';
  document.getElementById('vr_tss_std').value = '4';
  document.getElementById('vr_nh3_avg').value = '1.5';
  document.getElementById('vr_nh3_std').value = '0.8';
  document.getElementById('vr_results').innerHTML = '';
}

// ==================== SOP LIBRARY ====================
var sopLibrary = {
  startup: {
    title: 'Plant Startup Procedure',
    category: 'Operations',
    steps: [
      'Verify all electrical systems are operational',
      'Check chemical tank levels and calibrate pumps',
      'Inspect all mechanical equipment (blowers, pumps, drives)',
      'Open inlet gates/valves slowly to allow gradual flow increase',
      'Start RAS pumps at minimum speed',
      'Start blowers and verify diffuser operation',
      'Monitor DO levels - target 2.0-4.0 mg/L',
      'Start WAS pumps based on MLSS targets',
      'Enable chemical feed systems (disinfection, nutrients)',
      'Begin sampling program within 24 hours',
      'Document all startup parameters in logbook'
    ],
    warnings: ['Never start blowers without open discharge', 'Verify clarifier mechanisms before flow introduction'],
    references: 'WEF MOP 11, Chapter 15'
  },
  shutdown: {
    title: 'Emergency Shutdown Procedure',
    category: 'Emergency',
    steps: [
      'NOTIFY: Alert supervisor and on-call personnel immediately',
      'ISOLATE: Close influent gates/valves if safe to do so',
      'STOP: Shut down non-essential equipment in reverse startup order',
      'SECURE: De-energize electrical panels if flooding risk',
      'PROTECT: Ensure chemical systems are safely isolated',
      'DOCUMENT: Record time, reason, and actions taken',
      'COMMUNICATE: Notify regulatory agency if required (>24hr bypass)',
      'ASSESS: Evaluate damage and develop restart plan',
      'RESTART: Follow startup procedure when safe'
    ],
    warnings: ['Personnel safety is priority #1', 'Follow LOTO procedures for all equipment', 'Do not enter confined spaces without proper procedures'],
    references: 'Plant Emergency Response Plan, OSHA 29 CFR 1910.147'
  },
  wasting: {
    title: 'Sludge Wasting (WAS) Procedure',
    category: 'Process Control',
    steps: [
      'Review current MLSS, SVI, and target SRT',
      'Calculate WAS volume: WAS (gal) = (Aeration Vol √ó MLSS) / (SRT √ó WAS Conc √ó 8.34)',
      'Or use mass-based: WAS (lb/day) = Aeration Inventory / Target SRT',
      'Verify WAS pump calibration',
      'Record initial totalizer reading',
      'Start WAS pump at calculated rate',
      'Waste during peak biological activity (typically 8AM-4PM)',
      'Monitor settleometer and adjust if SVI changes',
      'Record final totalizer and actual volume wasted',
      'Update process control spreadsheet'
    ],
    warnings: ['Do not waste during storm events', 'Verify thickener/digester capacity before wasting'],
    references: 'WEF MOP 11, Chapter 11; Plant Process Control Plan'
  },
  clarifier: {
    title: 'Clarifier Operations',
    category: 'Operations',
    steps: [
      'Daily: Check effluent clarity and weir condition',
      'Daily: Record sludge blanket depth (target 1-3 ft)',
      'Daily: Observe scum trough and remove accumulated material',
      'Weekly: Check mechanism torque and alarm setpoints',
      'Weekly: Inspect weirs for algae growth, clean as needed',
      'Monthly: Verify drive unit oil level',
      'Quarterly: Inspect underwater components during dewatering',
      'Calculate SOR = Flow (gpd) / Surface Area (sf) - target <800 gpd/sf',
      'Calculate WOR = Flow (gpd) / Weir Length (ft) - target <20,000 gpd/ft',
      'Adjust RAS rate to maintain target blanket depth'
    ],
    warnings: ['Never walk on clarifier without safety harness', 'High torque alarm indicates possible debris or mechanical failure'],
    references: 'WEF MOP 11, Chapter 8'
  },
  disinfection: {
    title: 'Disinfection Operations',
    category: 'Operations',
    steps: [
      'CHLORINATION:',
      '- Verify chlorine residual target (typically 0.5-2.0 mg/L)',
      '- Calculate dose: lb/day = Flow (MGD) √ó Dose (mg/L) √ó 8.34',
      '- Check chlorinator/feed pump operation',
      '- Monitor contact time (CT) requirements',
      '- Sample for residual at end of contact chamber',
      'UV DISINFECTION:',
      '- Record UV intensity and transmittance daily',
      '- Clean quartz sleeves weekly or per manufacturer',
      '- Replace lamps at end of rated life or when intensity drops',
      '- Verify UVT > 55% for adequate disinfection',
      '- Calculate delivered dose based on flow and intensity'
    ],
    warnings: ['Chlorine gas is extremely hazardous - follow safety protocols', 'UV exposure can cause eye/skin damage - never look at operating lamps'],
    references: 'WEF MOP 11, Chapter 12; EPA Disinfection Guidance Manual'
  },
  sampling: {
    title: 'Sampling & Testing Procedures',
    category: 'Laboratory',
    steps: [
      'Review permit requirements for sampling locations/frequency',
      'Prepare clean sample containers (appropriate for parameter)',
      'Composite samples: Program autosampler for 24-hr composite',
      'Grab samples: Collect at same time daily, document time',
      'Fill containers completely for BOD/DO (no headspace)',
      'Preserve samples per method requirements (acid, cooling)',
      'Label all samples: Location, Date, Time, Preservative, Analyst',
      'Maintain chain of custody for compliance samples',
      'Transport to lab within holding time requirements',
      'Document field measurements (pH, temp, DO) immediately',
      'Enter results in LIMS within 24 hours'
    ],
    warnings: ['Never exceed holding times', 'Use appropriate PPE when sampling'],
    references: '40 CFR 136; Standard Methods for Water and Wastewater'
  },
  chemical: {
    title: 'Chemical Handling Safety',
    category: 'Safety',
    steps: [
      'Review SDS before handling any chemical',
      'Wear appropriate PPE: gloves, goggles, apron minimum',
      'Verify ventilation in chemical storage areas',
      'Never mix incompatible chemicals (acids/bases, oxidizers/reducers)',
      'Use dedicated equipment for each chemical',
      'Secondary containment required for all bulk storage',
      'Inspect tanks and piping for leaks daily',
      'Calibrate chemical feed pumps weekly',
      'Document all chemical deliveries and usage',
      'Maintain spill response equipment nearby',
      'Train all personnel on emergency response procedures'
    ],
    warnings: ['NEVER add water to acid - always add acid to water', 'Chlorine gas requires SCBA and specific response procedures'],
    references: 'OSHA 29 CFR 1910.1200; Plant Chemical Hygiene Plan'
  },
  blower: {
    title: 'Blower Operations',
    category: 'Mechanical',
    steps: [
      'Pre-start checks: Oil level, filter condition, coupling alignment',
      'Verify discharge valve is OPEN before starting',
      'Start blower per manufacturer sequence',
      'Monitor discharge pressure and temperature',
      'Check for unusual noise or vibration',
      'Record amp draw and compare to baseline',
      'Adjust VFD speed to meet DO setpoint',
      'Rotate lead/lag blowers weekly',
      'Daily: Check oil level, inlet filter ŒîP, bearing temps',
      'Weekly: Inspect belt tension (if applicable)',
      'Monthly: Check/change oil per manufacturer schedule',
      'Annually: Professional vibration analysis'
    ],
    warnings: ['Never start with closed discharge - causes surge', 'Hot surfaces - allow cooldown before maintenance'],
    references: 'Manufacturer O&M Manual; WEF MOP 11, Chapter 5'
  },
  dewatering: {
    title: 'Dewatering Operations',
    category: 'Solids Handling',
    steps: [
      'BELT FILTER PRESS:',
      '- Pre-condition sludge with polymer (typical 8-15 lb/DT)',
      '- Adjust belt speed based on solids loading',
      '- Monitor cake dryness - target 18-22% solids',
      '- Wash belts continuously, deep clean at shutdown',
      '- Track polymer usage and cake solids daily',
      'CENTRIFUGE:',
      '- Start per manufacturer sequence',
      '- Adjust scroll speed differential for cake dryness',
      '- Monitor torque and vibration',
      '- Typical cake: 20-28% solids',
      '- Flush before and after each run',
      'Both: Jar test weekly to optimize polymer dose'
    ],
    warnings: ['Rotating equipment hazards - follow LOTO', 'Polymer is slippery - clean spills immediately'],
    references: 'WEF MOP 11, Chapter 16; Equipment O&M Manuals'
  }
};

function showSOP(sopKey) {
  var sop = sopLibrary[sopKey];
  if (!sop) return;
  
  var html = '<div style="background:var(--bg-section);padding:25px;border-radius:12px">';
  html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:20px">';
  html += '<div><h3 style="color:#4ade80;margin:0">' + sop.title + '</h3>';
  html += '<span style="background:var(--bg-tabs);padding:4px 12px;border-radius:15px;font-size:12px;margin-top:8px;display:inline-block">' + sop.category + '</span></div>';
  html += '<button onclick="printSOP(\'' + sopKey + '\')" class="btn small blue">üñ®Ô∏è Print</button>';
  html += '</div>';
  
  html += '<div style="background:var(--bg-tabs);padding:20px;border-radius:8px;margin-bottom:20px">';
  html += '<h4 style="color:#60a5fa;margin:0 0 15px 0">üìã Procedure Steps</h4>';
  html += '<ol style="margin:0;padding-left:25px;line-height:2">';
  sop.steps.forEach(function(step) {
    if (step.includes(':') && !step.includes('mg/L') && !step.includes('gpd')) {
      html += '<li style="font-weight:bold;color:#fbbf24;margin-top:10px">' + step + '</li>';
    } else if (step.startsWith('-')) {
      html += '<li style="list-style:none;margin-left:20px;color:var(--text-secondary)">' + step + '</li>';
    } else {
      html += '<li>' + step + '</li>';
    }
  });
  html += '</ol></div>';
  
  if (sop.warnings && sop.warnings.length > 0) {
    html += '<div style="background:#7f1d1d;padding:15px;border-radius:8px;margin-bottom:20px">';
    html += '<h4 style="color:#fca5a5;margin:0 0 10px 0">‚ö†Ô∏è Warnings</h4>';
    html += '<ul style="margin:0;padding-left:20px;color:#fecaca">';
    sop.warnings.forEach(function(w) { html += '<li>' + w + '</li>'; });
    html += '</ul></div>';
  }
  
  html += '<div style="color:var(--text-secondary);font-size:13px"><strong>References:</strong> ' + sop.references + '</div>';
  html += '</div>';
  
  // Display in Quick Reference modal if open, otherwise fallback
  var qrefDisplay = document.getElementById('qref_sop_display');
  var sopDisplay = document.getElementById('sop_display');
  
  if (qrefDisplay) {
    qrefDisplay.innerHTML = html;
  }
  if (sopDisplay) {
    sopDisplay.innerHTML = html;
  }
}

function searchSOPs() {
  var query = document.getElementById('sop_search').value.toLowerCase();
  var cards = document.querySelectorAll('.sop-card');
  cards.forEach(function(card) {
    var text = card.textContent.toLowerCase();
    card.style.display = text.includes(query) ? 'block' : 'none';
  });
}

function showAllSOPs() {
  document.getElementById('sop_search').value = '';
  var cards = document.querySelectorAll('.sop-card');
  cards.forEach(function(card) { card.style.display = 'block'; });
}

function printSOP(sopKey) {
  var sop = sopLibrary[sopKey];
  var printWindow = window.open('', '_blank');
  printWindow.document.write('<html><head><title>WWTP Command Center v9.9.16</title>');
  printWindow.document.write('<style>body{font-family:Arial;padding:20px}h1{color:#023e8a}ol{line-height:2}li{margin:5px 0}.warning{background:#fef3c7;padding:10px;border-radius:5px;margin:15px 0}</style>');
  printWindow.document.write('</head><body>');
  printWindow.document.write('<h1>' + sop.title + '</h1>');
  printWindow.document.write('<p><strong>Category:</strong> ' + sop.category + '</p>');
  printWindow.document.write('<h2>Procedure</h2><ol>');
  sop.steps.forEach(function(s) { printWindow.document.write('<li>' + s + '</li>'); });
  printWindow.document.write('</ol>');
  if (sop.warnings) {
    printWindow.document.write('<div class="warning"><h3>‚ö†Ô∏è Warnings</h3><ul>');
    sop.warnings.forEach(function(w) { printWindow.document.write('<li>' + w + '</li>'); });
    printWindow.document.write('</ul></div>');
  }
  printWindow.document.write('<p><strong>References:</strong> ' + sop.references + '</p>');
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
}

// ==================== MASS BALANCE CALCULATOR ====================
function calcMassBalance() {
  var flow = parseFloat(document.getElementById('mb_flow').value) || 5;
  var bodIn = parseFloat(document.getElementById('mb_bod_in').value) || 200;
  var tssIn = parseFloat(document.getElementById('mb_tss_in').value) || 220;
  var tknIn = parseFloat(document.getElementById('mb_tkn_in').value) || 40;
  var tpIn = parseFloat(document.getElementById('mb_tp_in').value) || 7;
  
  var primBOD = parseFloat(document.getElementById('mb_prim_bod').value) / 100 || 0.30;
  var primTSS = parseFloat(document.getElementById('mb_prim_tss').value) / 100 || 0.60;
  var secBOD = parseFloat(document.getElementById('mb_sec_bod').value) / 100 || 0.90;
  var secTSS = parseFloat(document.getElementById('mb_sec_tss').value) / 100 || 0.85;
  var secTKN = parseFloat(document.getElementById('mb_sec_tkn').value) / 100 || 0.80;
  var tertTP = parseFloat(document.getElementById('mb_tert_tp').value) / 100 || 0.85;
  var tertTSS = parseFloat(document.getElementById('mb_tert_tss').value) / 100 || 0.50;
  
  var yield_coef = parseFloat(document.getElementById('mb_yield').value) || 0.6;
  var vssTss = parseFloat(document.getElementById('mb_vss_tss').value) || 0.75;
  var primPct = parseFloat(document.getElementById('mb_prim_pct').value) || 4;
  var wasPct = parseFloat(document.getElementById('mb_was_pct').value) || 0.8;
  
  // Calculate loads (lb/day)
  var conv = flow * 8.34;
  
  var infBOD = bodIn * conv;
  var infTSS = tssIn * conv;
  var infTKN = tknIn * conv;
  var infTP = tpIn * conv;
  
  // After primary
  var primEffBOD = bodIn * (1 - primBOD);
  var primEffTSS = tssIn * (1 - primTSS);
  var primSludgeTSS = tssIn * primTSS * conv;
  
  // After secondary
  var secEffBOD = primEffBOD * (1 - secBOD);
  var secEffTSS = primEffTSS * (1 - secTSS);
  var secEffTKN = tknIn * (1 - secTKN);
  
  // Biological sludge production
  var bodRemoved = (bodIn - secEffBOD) * conv;
  var bioSludgeVSS = bodRemoved * yield_coef;
  var bioSludgeTSS = bioSludgeVSS / vssTss;
  
  // After tertiary
  var finalTSS = secEffTSS * (1 - tertTSS);
  var finalTP = tpIn * (1 - tertTP);
  
  // Sludge volumes
  var primSludgeGPD = primSludgeTSS / (8.34 * (primPct / 100));
  var wasGPD = bioSludgeTSS / (8.34 * (wasPct / 100));
  
  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 20px 0">‚öñÔ∏è Mass Balance Results</h4>';
  
  // Summary boxes
  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Influent BOD Load</div>';
  html += '<div style="color:#4ade80;font-size:20px;font-weight:bold">' + infBOD.toFixed(0) + ' lb/d</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Effluent BOD</div>';
  html += '<div style="color:#60a5fa;font-size:20px;font-weight:bold">' + secEffBOD.toFixed(1) + ' mg/L</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Primary Sludge</div>';
  html += '<div style="color:#ffd166;font-size:20px;font-weight:bold">' + primSludgeGPD.toFixed(0) + ' gpd</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">WAS Production</div>';
  html += '<div style="color:#a78bfa;font-size:20px;font-weight:bold">' + wasGPD.toFixed(0) + ' gpd</div></div>';
  html += '</div>';
  
  html += '<table class="table"><thead><tr><th>Location</th><th>BOD</th><th>TSS</th><th>TKN</th><th>TP</th></tr></thead><tbody>';
  html += '<tr style="background:#374151"><td><strong>Influent</strong></td>';
  html += '<td>' + bodIn + ' mg/L<br><small>' + infBOD.toFixed(0) + ' lb/d</small></td>';
  html += '<td>' + tssIn + ' mg/L<br><small>' + infTSS.toFixed(0) + ' lb/d</small></td>';
  html += '<td>' + tknIn + ' mg/L<br><small>' + infTKN.toFixed(0) + ' lb/d</small></td>';
  html += '<td>' + tpIn + ' mg/L<br><small>' + infTP.toFixed(0) + ' lb/d</small></td></tr>';
  
  html += '<tr><td>Primary Effluent</td>';
  html += '<td>' + primEffBOD.toFixed(0) + ' mg/L</td>';
  html += '<td>' + primEffTSS.toFixed(0) + ' mg/L</td>';
  html += '<td>' + tknIn + ' mg/L</td>';
  html += '<td>' + tpIn + ' mg/L</td></tr>';
  
  html += '<tr><td>Secondary Effluent</td>';
  html += '<td>' + secEffBOD.toFixed(1) + ' mg/L</td>';
  html += '<td>' + secEffTSS.toFixed(1) + ' mg/L</td>';
  html += '<td>' + secEffTKN.toFixed(1) + ' mg/L</td>';
  html += '<td>' + tpIn + ' mg/L</td></tr>';
  
  html += '<tr style="background:#374151"><td><strong>Final Effluent</strong></td>';
  html += '<td><strong>' + secEffBOD.toFixed(1) + '</strong> mg/L</td>';
  html += '<td><strong>' + finalTSS.toFixed(1) + '</strong> mg/L</td>';
  html += '<td><strong>' + secEffTKN.toFixed(1) + '</strong> mg/L</td>';
  html += '<td><strong>' + finalTP.toFixed(1) + '</strong> mg/L</td></tr>';
  
  html += '</tbody></table>';
  
  html += '<div style="margin-top:20px;display:grid;grid-template-columns:1fr 1fr;gap:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px">';
  html += '<h5 style="color:#fbbf24;margin:0 0 10px 0">üî∂ Primary Sludge</h5>';
  html += '<div>TSS Removed: ' + primSludgeTSS.toFixed(0) + ' lb/day</div>';
  html += '<div>Volume @ ' + primPct + '% solids: ' + primSludgeGPD.toFixed(0) + ' gpd</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px">';
  html += '<h5 style="color:#a78bfa;margin:0 0 10px 0">üî∑ Waste Activated Sludge</h5>';
  html += '<div>VSS Produced: ' + bioSludgeVSS.toFixed(0) + ' lb/day</div>';
  html += '<div>TSS Produced: ' + bioSludgeTSS.toFixed(0) + ' lb/day</div>';
  html += '<div>Volume @ ' + wasPct + '% solids: ' + wasGPD.toFixed(0) + ' gpd</div></div>';
  html += '</div></div>';
  
  document.getElementById('mb_results').innerHTML = html;
  showToast('Mass balance calculated', 'success');
}

function showMassBalanceDiagram() {
  showToast('Process flow diagram - coming soon!', 'info');
}

function resetMassBalance() {
  document.getElementById('mb_flow').value = '5.0';
  document.getElementById('mb_bod_in').value = '200';
  document.getElementById('mb_tss_in').value = '220';
  document.getElementById('mb_results').innerHTML = '';
}

// ==================== OXYGEN TRANSFER EFFICIENCY ====================
function calcOTE() {
  var diffuser = document.getElementById('ote_diffuser').value;
  var sote = parseFloat(document.getElementById('ote_sote').value) || 28;
  var depth = parseFloat(document.getElementById('ote_depth').value) || 15;
  var airflow = parseFloat(document.getElementById('ote_airflow').value) || 3000;
  var numDiff = parseFloat(document.getElementById('ote_num_diff').value) || 500;
  
  var temp = parseFloat(document.getElementById('ote_temp').value) || 20;
  var doOp = parseFloat(document.getElementById('ote_do').value) || 2;
  var altitude = parseFloat(document.getElementById('ote_altitude').value) || 500;
  var alpha = parseFloat(document.getElementById('ote_alpha').value) || 0.5;
  var beta = parseFloat(document.getElementById('ote_beta').value) || 0.95;
  var fouling = parseFloat(document.getElementById('ote_fouling').value) || 0.9;
  
  var o2Req = parseFloat(document.getElementById('ote_o2_req').value) || 5000;
  var blowerEff = parseFloat(document.getElementById('ote_blower_eff').value) / 100 || 0.70;
  var motorEff = parseFloat(document.getElementById('ote_motor_eff').value) / 100 || 0.95;
  var elecCost = parseFloat(document.getElementById('ote_elec_cost').value) || 0.10;
  
  // Saturation DO at temp and altitude
  var csStd = 9.09; // mg/L at 20¬∞C, sea level
  var cs = csStd * Math.exp(-0.0001 * altitude) * (1 - 0.02 * (temp - 20));
  var csMid = cs * (1 + depth / 42); // Mid-depth pressure correction
  
  // Temperature correction factor
  var theta = Math.pow(1.024, temp - 20);
  
  // Calculate AOTR from SOTR
  // SOTR = Airflow (SCFM) √ó 0.0173 √ó SOTE √ó depth/15
  var sotr = airflow * 0.0173 * (sote / 100) * (depth / 15); // lb O2/hr
  var sotrDaily = sotr * 24; // lb O2/day
  
  // AOTR = SOTR √ó alpha √ó F √ó ((beta √ó csMid - doOp) / csStd) √ó theta
  var aotr = sotr * alpha * fouling * ((beta * csMid - doOp) / csStd) * theta;
  var aotrDaily = aotr * 24;
  
  // Aeration Efficiency (SAE and AE)
  // Power calculation
  var pressurePsi = depth * 0.433 + 1; // gauge + losses
  var bhp = (airflow * pressurePsi) / (17.1 * blowerEff);
  var kw = bhp * 0.746 / motorEff;
  
  var sae = sotrDaily / (kw * 24); // lb O2/kWh (standard)
  var ae = aotrDaily / (kw * 24); // lb O2/kWh (actual)
  
  // Air per diffuser
  var airPerDiff = airflow / numDiff;
  
  // Cost analysis
  var kwhDay = kw * 24;
  var costDay = kwhDay * elecCost;
  var costMonth = costDay * 30;
  var costYear = costDay * 365;
  var costPerLbO2 = costDay / aotrDaily;
  
  // Check if AOTR meets requirement
  var surplus = aotrDaily - o2Req;
  var meetReq = surplus >= 0;
  
  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 20px 0">üí® Oxygen Transfer Analysis</h4>';
  
  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">SOTR</div>';
  html += '<div style="color:#60a5fa;font-size:20px;font-weight:bold">' + sotrDaily.toFixed(0) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">lb O‚ÇÇ/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">AOTR</div>';
  html += '<div style="color:#4ade80;font-size:20px;font-weight:bold">' + aotrDaily.toFixed(0) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">lb O‚ÇÇ/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">SAE</div>';
  html += '<div style="color:#ffd166;font-size:20px;font-weight:bold">' + sae.toFixed(2) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">lb O‚ÇÇ/kWh</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">AE (Actual)</div>';
  html += '<div style="color:#a78bfa;font-size:20px;font-weight:bold">' + ae.toFixed(2) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">lb O‚ÇÇ/kWh</div></div>';
  html += '</div>';
  
  html += '<table class="table"><tbody>';
  html += '<tr><td>Saturated DO (Cs at ' + temp + '¬∞C)</td><td><strong>' + cs.toFixed(2) + '</strong></td><td>mg/L</td></tr>';
  html += '<tr><td>Mid-depth Cs (pressure corrected)</td><td><strong>' + csMid.toFixed(2) + '</strong></td><td>mg/L</td></tr>';
  html += '<tr><td>Temperature Factor (Œ∏)</td><td><strong>' + theta.toFixed(3) + '</strong></td><td></td></tr>';
  html += '<tr><td>Air per Diffuser</td><td><strong>' + airPerDiff.toFixed(1) + '</strong></td><td>SCFM/diff</td></tr>';
  html += '<tr><td>Blower Power Required</td><td><strong>' + kw.toFixed(1) + '</strong></td><td>kW</td></tr>';
  html += '<tr><td>Daily Energy Use</td><td><strong>' + kwhDay.toFixed(0) + '</strong></td><td>kWh/day</td></tr>';
  html += '</tbody></table>';
  
  // Oxygen requirement check
  if (meetReq) {
    html += '<div class="note success" style="margin-top:15px">‚úÖ <strong>Oxygen Supply Adequate</strong> - AOTR (' + aotrDaily.toFixed(0) + ' lb/d) exceeds requirement (' + o2Req + ' lb/d) by ' + surplus.toFixed(0) + ' lb/d (' + ((surplus/o2Req)*100).toFixed(0) + '% margin)</div>';
  } else {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è <strong>Oxygen Supply Deficit</strong> - AOTR (' + aotrDaily.toFixed(0) + ' lb/d) is ' + Math.abs(surplus).toFixed(0) + ' lb/d SHORT of requirement (' + o2Req + ' lb/d). Increase airflow or add diffusers.</div>';
  }
  
  // Cost summary
  html += '<div style="background:linear-gradient(135deg,#059669,#06d6a0);padding:15px;border-radius:8px;margin-top:15px;color:white">';
  html += '<h5 style="margin:0 0 10px 0">üí∞ Operating Cost</h5>';
  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;text-align:center">';
  html += '<div><div style="opacity:0.9;font-size:11px">Daily</div><strong>$' + costDay.toFixed(0) + '</strong></div>';
  html += '<div><div style="opacity:0.9;font-size:11px">Monthly</div><strong>$' + costMonth.toFixed(0) + '</strong></div>';
  html += '<div><div style="opacity:0.9;font-size:11px">Annual</div><strong>$' + costYear.toLocaleString() + '</strong></div>';
  html += '<div><div style="opacity:0.9;font-size:11px">Per lb O‚ÇÇ</div><strong>$' + costPerLbO2.toFixed(3) + '</strong></div>';
  html += '</div></div>';
  
  html += '</div>';
  document.getElementById('ote_results').innerHTML = html;
  showToast('OTE calculated', 'success');
}

function compareAerators() {
  showToast('Aerator comparison tool - coming soon!', 'info');
}

function resetOTE() {
  document.getElementById('ote_sote').value = '28';
  document.getElementById('ote_airflow').value = '3000';
  document.getElementById('ote_temp').value = '20';
  document.getElementById('ote_do').value = '2.0';
  document.getElementById('ote_results').innerHTML = '';
}

// Simple OTE Calculator (for quick reference panel)
function calcOTESimple() {
  var airflow = parseFloat(document.getElementById('ote_air').value) || 2000;
  var depth = parseFloat(document.getElementById('ote_depth').value) || 15;
  var oteSTP = parseFloat(document.getElementById('ote_stp').value) || 25;
  var temp = parseFloat(document.getElementById('ote_temp').value) || 20;
  
  // Temperature correction factor (theta = 1.024)
  var theta = Math.pow(1.024, temp - 20);
  
  // Depth correction (approx 2% per foot of submergence)
  var depthFactor = 1 + (depth * 0.02);
  
  // Field OTE
  var fieldOTE = oteSTP * theta * depthFactor;
  
  // O2 delivered (lb/hr) = Airflow (scfm) √ó 60 √ó 0.075 √ó 0.232 √ó OTE
  var o2Delivered = airflow * 60 * 0.075 * 0.232 * (fieldOTE / 100);
  
  // Standard Oxygen Transfer Rate (SOTR)
  var sotr = airflow * 60 * 0.075 * 0.232 * (oteSTP / 100);
  
  document.getElementById('r_ote_field').textContent = fieldOTE.toFixed(1);
  document.getElementById('r_ote_o2').textContent = o2Delivered.toFixed(1);
  document.getElementById('r_ote_sotr').textContent = sotr.toFixed(1);
  
  showToast('OTE calculated', 'success');
}

function resetOTESimple() {
  document.getElementById('ote_air').value = '2000';
  document.getElementById('ote_depth').value = '15';
  document.getElementById('ote_stp').value = '25';
  document.getElementById('r_ote_field').textContent = '-';
  document.getElementById('r_ote_o2').textContent = '-';
  document.getElementById('r_ote_sotr').textContent = '-';
}

function checkCompliance() {
  var params = ['bod', 'tss', 'nh3', 'ecoli', 'tp'];
  var violations = 0;
  var warnings = 0;
  
  params.forEach(function(p) {
    var cur = parseFloat(document.getElementById('cur_' + p).value) || 0;
    var daily = parseFloat(document.getElementById('lim_' + p + '_daily').value) || 999;
    var monthly = parseFloat(document.getElementById('lim_' + p + '_monthly').value) || 999;
    var statEl = document.getElementById('stat_' + p);
    
    if (cur > daily) {
      statEl.innerHTML = '‚ùå VIOLATION';
      statEl.className = 'status bad';
      violations++;
    } else if (cur > monthly * 0.9) {
      statEl.innerHTML = '‚ö†Ô∏è Warning';
      statEl.className = 'status warn';
      warnings++;
    } else {
      statEl.innerHTML = '‚úì OK';
      statEl.className = 'status ok';
    }
  });
  
  // Check DO (minimum)
  var curDO = parseFloat(document.getElementById('cur_do').value) || 0;
  var minDO = parseFloat(document.getElementById('lim_do_min').value) || 4;
  var statDO = document.getElementById('stat_do');
  if (curDO < minDO) {
    statDO.innerHTML = '‚ùå VIOLATION';
    statDO.className = 'status bad';
    violations++;
  } else if (curDO < minDO * 1.1) {
    statDO.innerHTML = '‚ö†Ô∏è Warning';
    statDO.className = 'status warn';
    warnings++;
  } else {
    statDO.innerHTML = '‚úì OK';
    statDO.className = 'status ok';
  }
  
  // Check pH (range)
  var curPH = parseFloat(document.getElementById('cur_ph').value) || 7;
  var minPH = parseFloat(document.getElementById('lim_ph_min').value) || 6;
  var maxPH = parseFloat(document.getElementById('lim_ph_max').value) || 9;
  var statPH = document.getElementById('stat_ph');
  if (curPH < minPH || curPH > maxPH) {
    statPH.innerHTML = '‚ùå VIOLATION';
    statPH.className = 'status bad';
    violations++;
  } else {
    statPH.innerHTML = '‚úì OK';
    statPH.className = 'status ok';
  }
  
  if (violations > 0) {
    showToast('‚ö†Ô∏è ' + violations + ' Permit Violation(s) Detected!', 'error');
  } else if (warnings > 0) {
    showToast('‚ö†Ô∏è ' + warnings + ' Parameter(s) Approaching Limits', 'warning');
  } else {
    showToast('‚úÖ All Parameters In Compliance', 'success');
  }
}

function savePermitInfo() {
  var permitData = {
    permit_num: document.getElementById('tceq_permit_num').value,
    facility: document.getElementById('tceq_facility').value,
    permitted_flow: document.getElementById('tceq_permitted_flow').value,
    eff_date: document.getElementById('tceq_eff_date').value,
    exp_date: document.getElementById('tceq_exp_date').value,
    outfall: document.getElementById('tceq_outfall').value
  };
  localStorage.setItem('tceq_permit_info', JSON.stringify(permitData));
  showToast('Permit info saved!', 'success');
}

function loadPermitInfo() {
  var saved = localStorage.getItem('tceq_permit_info');
  if (saved) {
    var data = JSON.parse(saved);
    document.getElementById('tceq_permit_num').value = data.permit_num || '';
    document.getElementById('tceq_facility').value = data.facility || '';
    document.getElementById('tceq_permitted_flow').value = data.permitted_flow || '';
    document.getElementById('tceq_eff_date').value = data.eff_date || '';
    document.getElementById('tceq_exp_date').value = data.exp_date || '';
    document.getElementById('tceq_outfall').value = data.outfall || '';
    showToast('Permit info loaded!', 'success');
  } else {
    // Silently skip - no toast on boot
  }
}

function saveLimits() {
  var limits = {};
  var inputs = document.querySelectorAll('#tceq_limits_table input');
  inputs.forEach(function(inp) {
    limits[inp.id] = inp.value;
  });
  localStorage.setItem('tceq_limits', JSON.stringify(limits));
  showToast('Permit limits saved!', 'success');
}

function generateDMRTable() {
  var month = parseInt(document.getElementById('dmr_month').value);
  var year = parseInt(document.getElementById('dmr_year').value);
  var daysInMonth = new Date(year, month, 0).getDate();
  
  var html = '';
  for (var d = 1; d <= daysInMonth; d++) {
    html += '<tr>';
    html += '<td>' + month + '/' + d + '/' + year + '</td>';
    html += '<td><input type="number" class="dmr-input" step="0.01" style="width:60px"></td>';
    html += '<td><input type="number" class="dmr-input" style="width:60px"></td>';
    html += '<td><input type="number" class="dmr-input" style="width:60px"></td>';
    html += '<td><input type="number" class="dmr-input" step="0.1" style="width:60px"></td>';
    html += '<td><input type="number" class="dmr-input" step="0.1" style="width:60px"></td>';
    html += '<td><input type="number" class="dmr-input" step="0.1" style="width:60px"></td>';
    html += '</tr>';
  }
  document.getElementById('dmr_daily_body').innerHTML = html;
  showToast('DMR table generated for ' + daysInMonth + ' days', 'success');
}

function calculateDMRStats() {
  var rows = document.querySelectorAll('#dmr_daily_body tr');
  var stats = {flow: [], bod: [], tss: [], nh3: [], ph: [], do_val: []};
  
  rows.forEach(function(row) {
    var inputs = row.querySelectorAll('input');
    if (inputs[0].value) stats.flow.push(parseFloat(inputs[0].value));
    if (inputs[1].value) stats.bod.push(parseFloat(inputs[1].value));
    if (inputs[2].value) stats.tss.push(parseFloat(inputs[2].value));
    if (inputs[3].value) stats.nh3.push(parseFloat(inputs[3].value));
    if (inputs[4].value) stats.ph.push(parseFloat(inputs[4].value));
    if (inputs[5].value) stats.do_val.push(parseFloat(inputs[5].value));
  });
  
  function calcStats(arr) {
    if (arr.length === 0) return {avg: '-', max: '-', min: '-'};
    var sum = arr.reduce(function(a,b) { return a + b; }, 0);
    return {
      avg: (sum / arr.length).toFixed(2),
      max: Math.max.apply(null, arr).toFixed(2),
      min: Math.min.apply(null, arr).toFixed(2)
    };
  }
  
  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 15px 0">üìä DMR Statistics Summary</h4>';
  html += '<table class="table"><thead><tr><th>Parameter</th><th>Average</th><th>Maximum</th><th>Minimum</th><th>Sample Count</th></tr></thead><tbody>';
  
  var flowStats = calcStats(stats.flow);
  html += '<tr><td>Flow (MGD)</td><td>' + flowStats.avg + '</td><td>' + flowStats.max + '</td><td>' + flowStats.min + '</td><td>' + stats.flow.length + '</td></tr>';
  
  var bodStats = calcStats(stats.bod);
  html += '<tr><td>BOD (mg/L)</td><td>' + bodStats.avg + '</td><td>' + bodStats.max + '</td><td>' + bodStats.min + '</td><td>' + stats.bod.length + '</td></tr>';
  
  var tssStats = calcStats(stats.tss);
  html += '<tr><td>TSS (mg/L)</td><td>' + tssStats.avg + '</td><td>' + tssStats.max + '</td><td>' + tssStats.min + '</td><td>' + stats.tss.length + '</td></tr>';
  
  var nh3Stats = calcStats(stats.nh3);
  html += '<tr><td>NH3-N (mg/L)</td><td>' + nh3Stats.avg + '</td><td>' + nh3Stats.max + '</td><td>' + nh3Stats.min + '</td><td>' + stats.nh3.length + '</td></tr>';
  
  html += '</tbody></table></div>';
  document.getElementById('dmr_results').innerHTML = html;
  showToast('DMR statistics calculated', 'success');
}

function exportDMR() {
  var rows = document.querySelectorAll('#dmr_daily_body tr');
  var csv = 'Date,Flow (MGD),BOD (mg/L),TSS (mg/L),NH3 (mg/L),pH,DO (mg/L)\n';
  
  rows.forEach(function(row) {
    var date = row.cells[0].textContent;
    var inputs = row.querySelectorAll('input');
    csv += date + ',' + inputs[0].value + ',' + inputs[1].value + ',' + inputs[2].value + ',' + inputs[3].value + ',' + inputs[4].value + ',' + inputs[5].value + '\n';
  });
  
  var blob = new Blob([csv], {type: 'text/csv'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'DMR_Data_' + document.getElementById('dmr_month').value + '_' + document.getElementById('dmr_year').value + '.csv';
  a.click();
  showToast('DMR data exported to CSV', 'success');
}

// ==================== CLIENT MANAGEMENT ====================
var clients = JSON.parse(localStorage.getItem('wwtp_clients') || '[]');
var projects = JSON.parse(localStorage.getItem('wwtp_projects') || '[]');

function addClient() {
  var name = document.getElementById('client_name').value;
  if (!name) {
    showToast('Please enter client name', 'error');
    return;
  }
  
  var client = {
    id: Date.now(),
    name: name,
    contact: document.getElementById('client_contact').value,
    email: document.getElementById('client_email').value,
    phone: document.getElementById('client_phone').value,
    city: document.getElementById('client_city').value,
    type: document.getElementById('client_type').value,
    notes: document.getElementById('client_notes').value,
    created: new Date().toISOString(),
    plants: []
  };
  
  clients.push(client);
  localStorage.setItem('wwtp_clients', JSON.stringify(clients));
  renderClients();
  clearClientForm();
  updateClientStats();
  showToast('Client added successfully!', 'success');
}

function clearClientForm() {
  document.getElementById('client_name').value = '';
  document.getElementById('client_contact').value = '';
  document.getElementById('client_email').value = '';
  document.getElementById('client_phone').value = '';
  document.getElementById('client_city').value = '';
  document.getElementById('client_type').value = 'municipal';
  document.getElementById('client_notes').value = '';
}

function renderClients() {
  var container = document.getElementById('client_list');
  if (clients.length === 0) {
    container.innerHTML = '<div class="note">No clients added yet. Add your first client above!</div>';
    return;
  }
  
  var html = '';
  clients.forEach(function(c) {
    html += '<div class="client-card" style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #00b4d8">';
    html += '<div style="display:flex;justify-content:space-between;align-items:start">';
    html += '<div>';
    html += '<strong style="font-size:16px">' + c.name + '</strong>';
    html += '<span style="background:#374151;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:10px">' + c.type.toUpperCase() + '</span>';
    html += '<div style="color:#94a3b8;font-size:14px;margin-top:5px">';
    if (c.contact) html += 'üë§ ' + c.contact + ' &nbsp;';
    if (c.city) html += 'üìç ' + c.city;
    html += '</div>';
    if (c.email) html += '<div style="color:#60a5fa;font-size:13px">‚úâÔ∏è ' + c.email + '</div>';
    if (c.phone) html += '<div style="color:#94a3b8;font-size:13px">üìû ' + c.phone + '</div>';
    html += '</div>';
    html += '<div style="display:flex;gap:5px">';
    html += '<button class="btn small blue" onclick="editClient(' + c.id + ')">Edit</button>';
    html += '<button class="btn small red" onclick="deleteClient(' + c.id + ')">Delete</button>';
    html += '</div></div></div>';
  });
  container.innerHTML = html;
}

function deleteClient(id) {
  if (confirm('Delete this client?')) {
    clients = clients.filter(function(c) { return c.id !== id; });
    localStorage.setItem('wwtp_clients', JSON.stringify(clients));
    renderClients();
    updateClientStats();
    showToast('Client deleted', 'success');
  }
}

function editClient(id) {
  var client = clients.find(function(c) { return c.id === id; });
  if (client) {
    document.getElementById('client_name').value = client.name;
    document.getElementById('client_contact').value = client.contact;
    document.getElementById('client_email').value = client.email;
    document.getElementById('client_phone').value = client.phone;
    document.getElementById('client_city').value = client.city;
    document.getElementById('client_type').value = client.type;
    document.getElementById('client_notes').value = client.notes;
    deleteClient(id);
  }
}

function filterClients() {
  var search = document.getElementById('client_search').value.toLowerCase();
  var filtered = clients.filter(function(c) {
    return c.name.toLowerCase().includes(search) || 
           (c.city && c.city.toLowerCase().includes(search)) ||
           (c.contact && c.contact.toLowerCase().includes(search));
  });
  
  var container = document.getElementById('client_list');
  if (filtered.length === 0) {
    container.innerHTML = '<div class="note">No clients match your search.</div>';
    return;
  }
  
  var temp = clients;
  clients = filtered;
  renderClients();
  clients = temp;
}

function exportClients() {
  var csv = 'Name,Contact,Email,Phone,City,Type,Notes,Created\n';
  clients.forEach(function(c) {
    csv += '"' + c.name + '","' + c.contact + '","' + c.email + '","' + c.phone + '","' + c.city + '","' + c.type + '","' + c.notes + '","' + c.created + '"\n';
  });
  
  var blob = new Blob([csv], {type: 'text/csv'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'clients_export.csv';
  a.click();
  showToast('Clients exported to CSV', 'success');
}

function updateClientStats() {
  document.getElementById('stat_total_clients').textContent = clients.length;
  document.getElementById('stat_active_projects').textContent = projects.filter(function(p) { return p.status === 'active'; }).length;
  document.getElementById('stat_plants_managed').textContent = clients.reduce(function(sum, c) { return sum + (c.plants ? c.plants.length : 0); }, 0);
}

function showAddProjectModal() {
  showToast('Project management coming soon!', 'info');
}

function filterProjects(filter) {
  showToast('Projects filtered: ' + filter, 'info');
}

// ==================== PROPOSAL GENERATOR ====================
function updateProposalTotal() {
  var subtotal = 0;
  
  var services = ['assessment', 'compliance', 'training', 'energy', 'capacity', 'troubleshoot', 'monthly'];
  services.forEach(function(svc) {
    var checked = document.getElementById('svc_' + svc).checked;
    var price = parseFloat(document.getElementById('price_' + svc).value) || 0;
    if (checked) subtotal += price;
  });
  
  var discount = parseFloat(document.getElementById('prop_discount').value) || 0;
  var expenses = parseFloat(document.getElementById('prop_expenses').value) || 0;
  
  var discountAmount = subtotal * (discount / 100);
  var total = subtotal - discountAmount + expenses;
  
  document.getElementById('prop_subtotal').textContent = '$' + subtotal.toLocaleString('en-US', {minimumFractionDigits: 2});
  document.getElementById('prop_total').textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2});
}

function generateProposal() {
  var client = document.getElementById('prop_client').value;
  var project = document.getElementById('prop_project').value;
  
  if (!client || !project) {
    showToast('Please enter client and project name', 'error');
    return;
  }
  
  var services = [];
  var serviceList = ['assessment', 'compliance', 'training', 'energy', 'capacity', 'troubleshoot', 'monthly'];
  serviceList.forEach(function(svc) {
    if (document.getElementById('svc_' + svc).checked) {
      services.push({
        name: document.querySelector('label[for="svc_' + svc + '"] strong, label:has(#svc_' + svc + ') strong').textContent,
        price: parseFloat(document.getElementById('price_' + svc).value)
      });
    }
  });
  
  var proposal = {
    id: Date.now(),
    number: document.getElementById('prop_number').value,
    date: document.getElementById('prop_date').value,
    valid_until: document.getElementById('prop_valid').value,
    client: client,
    project: project,
    facility: document.getElementById('prop_facility').value,
    capacity: document.getElementById('prop_capacity').value,
    services: services,
    discount: parseFloat(document.getElementById('prop_discount').value) || 0,
    expenses: parseFloat(document.getElementById('prop_expenses').value) || 0,
    total: document.getElementById('prop_total').textContent,
    created: new Date().toISOString()
  };
  
  // Generate HTML preview
  var html = '<div style="background:white;color:#1a2744;padding:30px;border-radius:12px;max-height:600px;overflow-y:auto">';
  html += '<div style="text-align:center;margin-bottom:30px">';
  html += '<h1 style="color:#023e8a;margin:0">CONSULTING PROPOSAL</h1>';
  html += '<p style="color:#64748b">Proposal #' + proposal.number + '</p>';
  html += '</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px">';
  html += '<div><strong>Prepared For:</strong><br>' + proposal.client + '<br>' + proposal.facility + '</div>';
  html += '<div style="text-align:right"><strong>Date:</strong> ' + proposal.date + '<br><strong>Valid Until:</strong> ' + proposal.valid_until + '</div>';
  html += '</div>';
  html += '<h3 style="border-bottom:2px solid #023e8a;padding-bottom:10px">Scope of Services</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  services.forEach(function(s) {
    html += '<tr style="border-bottom:1px solid #e0f2fe"><td style="padding:10px">' + s.name + '</td><td style="text-align:right;padding:10px">$' + s.price.toLocaleString() + '</td></tr>';
  });
  html += '</table>';
  html += '<div style="text-align:right;font-size:18px;color:#059669"><strong>Total: ' + proposal.total + '</strong></div>';
  html += '</div>';
  
  showModal('Generated Proposal', html);
  saveProposalToStorage(proposal);
  showToast('Proposal generated!', 'success');
}

function saveProposalToStorage(proposal) {
  var saved = JSON.parse(localStorage.getItem('wwtp_proposals') || '[]');
  saved.push(proposal);
  localStorage.setItem('wwtp_proposals', JSON.stringify(saved));
  renderSavedProposals();
}

function renderSavedProposals() {
  var saved = JSON.parse(localStorage.getItem('wwtp_proposals') || '[]');
  var container = document.getElementById('saved_proposals');
  
  if (saved.length === 0) {
    container.innerHTML = '<div class="note">No saved proposals yet.</div>';
    return;
  }
  
  var html = '';
  saved.slice().reverse().forEach(function(p) {
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">';
    html += '<div>';
    html += '<strong>' + p.number + '</strong> - ' + p.client;
    html += '<div style="color:#94a3b8;font-size:13px">' + p.project + ' | ' + p.total + '</div>';
    html += '</div>';
    html += '<button class="btn small red" onclick="deleteProposal(' + p.id + ')">Delete</button>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function deleteProposal(id) {
  var saved = JSON.parse(localStorage.getItem('wwtp_proposals') || '[]');
  saved = saved.filter(function(p) { return p.id !== id; });
  localStorage.setItem('wwtp_proposals', JSON.stringify(saved));
  renderSavedProposals();
  showToast('Proposal deleted', 'success');
}

function saveProposal() {
  generateProposal();
}

function emailProposal() {
  showToast('Email functionality - integrate with your email service', 'info');
}

function clearProposal() {
  document.getElementById('prop_client').value = '';
  document.getElementById('prop_project').value = '';
  document.getElementById('prop_facility').value = '';
  var services = ['assessment', 'compliance', 'training', 'energy', 'capacity', 'troubleshoot', 'monthly'];
  services.forEach(function(svc) {
    document.getElementById('svc_' + svc).checked = false;
  });
  updateProposalTotal();
}

// ==================== ROI CALCULATOR ====================
function calculateROI() {
  // Current costs (annual)
  var energyCurrent = parseFloat(document.getElementById('roi_energy_current').value) * 12;
  var chemCurrent = parseFloat(document.getElementById('roi_chem_current').value) * 12;
  var sludgeCurrent = parseFloat(document.getElementById('roi_sludge_current').value) * 12;
  var maintCurrent = parseFloat(document.getElementById('roi_maint_current').value) * 12;
  var laborHrsCurrent = parseFloat(document.getElementById('roi_labor_current').value) * 52;
  var finesCurrent = parseFloat(document.getElementById('roi_fines_current').value);
  var laborRate = parseFloat(document.getElementById('roi_labor_rate').value);
  var laborCostCurrent = laborHrsCurrent * laborRate;
  var totalCurrent = energyCurrent + chemCurrent + sludgeCurrent + maintCurrent + laborCostCurrent + finesCurrent;
  
  // Proposed costs (annual)
  var energyProposed = parseFloat(document.getElementById('roi_energy_proposed').value) * 12;
  var chemProposed = parseFloat(document.getElementById('roi_chem_proposed').value) * 12;
  var sludgeProposed = parseFloat(document.getElementById('roi_sludge_proposed').value) * 12;
  var maintProposed = parseFloat(document.getElementById('roi_maint_proposed').value) * 12;
  var laborHrsProposed = parseFloat(document.getElementById('roi_labor_proposed').value) * 52;
  var finesProposed = parseFloat(document.getElementById('roi_fines_proposed').value);
  var laborCostProposed = laborHrsProposed * laborRate;
  var totalProposed = energyProposed + chemProposed + sludgeProposed + maintProposed + laborCostProposed + finesProposed;
  
  // Investment
  var consulting = parseFloat(document.getElementById('roi_consulting').value);
  var capital = parseFloat(document.getElementById('roi_capital').value);
  var implementation = parseFloat(document.getElementById('roi_implementation').value);
  var totalInvestment = consulting + capital + implementation;
  
  // Savings & ROI
  var annualSavings = totalCurrent - totalProposed;
  var paybackMonths = (annualSavings > 0) ? (totalInvestment / annualSavings) * 12 : 0;
  var roiPercent = (annualSavings > 0) ? ((annualSavings / totalInvestment) * 100) : 0;
  var fiveYearSavings = (annualSavings * 5) - totalInvestment;
  
  // Update displays
  document.getElementById('roi_current_total').textContent = '$' + totalCurrent.toLocaleString();
  document.getElementById('roi_proposed_total').textContent = '$' + totalProposed.toLocaleString();
  
  // Results HTML
  var html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px">';
  
  html += '<div style="background:linear-gradient(135deg,#059669,#06d6a0);padding:20px;border-radius:12px;text-align:center">';
  html += '<div style="font-size:32px;font-weight:bold">$' + annualSavings.toLocaleString() + '</div>';
  html += '<div style="opacity:0.9">Annual Savings</div></div>';
  
  html += '<div style="background:linear-gradient(135deg,#0077b6,#0077b6);padding:20px;border-radius:12px;text-align:center">';
  html += '<div style="font-size:32px;font-weight:bold">' + paybackMonths.toFixed(1) + '</div>';
  html += '<div style="opacity:0.9">Months to Payback</div></div>';
  
  html += '<div style="background:linear-gradient(135deg,#0096c7,#48cae4);padding:20px;border-radius:12px;text-align:center">';
  html += '<div style="font-size:32px;font-weight:bold">' + roiPercent.toFixed(0) + '%</div>';
  html += '<div style="opacity:0.9">Annual ROI</div></div>';
  
  html += '<div style="background:linear-gradient(135deg,#dc2626,#ffd166);padding:20px;border-radius:12px;text-align:center">';
  html += '<div style="font-size:32px;font-weight:bold">$' + fiveYearSavings.toLocaleString() + '</div>';
  html += '<div style="opacity:0.9">5-Year Net Benefit</div></div>';
  
  html += '</div>';
  
  // Savings breakdown
  html += '<div style="background:#1a2744;padding:20px;border-radius:12px;margin-top:20px">';
  html += '<h4 style="color:#4ade80;margin:0 0 15px 0">üí∞ Savings Breakdown (Annual)</h4>';
  html += '<table class="table"><tbody>';
  html += '<tr><td>Energy Savings</td><td style="color:#4ade80"><strong>$' + (energyCurrent - energyProposed).toLocaleString() + '</strong></td></tr>';
  html += '<tr><td>Chemical Savings</td><td style="color:#4ade80"><strong>$' + (chemCurrent - chemProposed).toLocaleString() + '</strong></td></tr>';
  html += '<tr><td>Sludge Disposal Savings</td><td style="color:#4ade80"><strong>$' + (sludgeCurrent - sludgeProposed).toLocaleString() + '</strong></td></tr>';
  html += '<tr><td>Maintenance Savings</td><td style="color:#4ade80"><strong>$' + (maintCurrent - maintProposed).toLocaleString() + '</strong></td></tr>';
  html += '<tr><td>Labor Overtime Savings</td><td style="color:#4ade80"><strong>$' + (laborCostCurrent - laborCostProposed).toLocaleString() + '</strong></td></tr>';
  html += '<tr><td>Compliance Fine Avoidance</td><td style="color:#4ade80"><strong>$' + (finesCurrent - finesProposed).toLocaleString() + '</strong></td></tr>';
  html += '</tbody></table></div>';
  
  document.getElementById('roi_results').innerHTML = html;
  
  // Update chart
  updateROIChart(energyCurrent - energyProposed, chemCurrent - chemProposed, sludgeCurrent - sludgeProposed, maintCurrent - maintProposed, laborCostCurrent - laborCostProposed, finesCurrent - finesProposed);
  
  showToast('ROI calculated!', 'success');
}

function updateROIChart(energy, chem, sludge, maint, labor, fines) {
  var ctx = document.getElementById('roiChart');
  if (!ctx) return;
  
  if (window.roiChartInstance) {
    window.roiChartInstance.destroy();
  }
  
  window.roiChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Energy', 'Chemical', 'Sludge', 'Maintenance', 'Labor', 'Fines'],
      datasets: [{
        label: 'Annual Savings ($)',
        data: [energy, chem, sludge, maint, labor, fines],
        backgroundColor: ['#0077b6', '#06d6a0', '#ffd166', '#00b4d8', '#ec4899', '#ef4444']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) { return '$' + value.toLocaleString(); }
          }
        }
      }
    }
  });
}

function resetROI() {
  document.getElementById('roi_energy_current').value = '25000';
  document.getElementById('roi_chem_current').value = '8000';
  document.getElementById('roi_sludge_current').value = '12000';
  document.getElementById('roi_maint_current').value = '5000';
  document.getElementById('roi_labor_current').value = '20';
  document.getElementById('roi_fines_current').value = '5000';
  document.getElementById('roi_energy_proposed').value = '18000';
  document.getElementById('roi_chem_proposed').value = '6500';
  document.getElementById('roi_sludge_proposed').value = '10000';
  document.getElementById('roi_maint_proposed').value = '4000';
  document.getElementById('roi_labor_proposed').value = '8';
  document.getElementById('roi_fines_proposed').value = '0';
  document.getElementById('roi_results').innerHTML = '<div class="note">Enter current and proposed values, then click "Calculate ROI" to see results.</div>';
}

function generateROIReport() {
  showToast('ROI Report generation - coming soon!', 'info');
}

function exportROIData() {
  var data = {
    current: {
      energy: document.getElementById('roi_energy_current').value,
      chemical: document.getElementById('roi_chem_current').value,
      sludge: document.getElementById('roi_sludge_current').value,
      maintenance: document.getElementById('roi_maint_current').value,
      labor_hours: document.getElementById('roi_labor_current').value,
      fines: document.getElementById('roi_fines_current').value
    },
    proposed: {
      energy: document.getElementById('roi_energy_proposed').value,
      chemical: document.getElementById('roi_chem_proposed').value,
      sludge: document.getElementById('roi_sludge_proposed').value,
      maintenance: document.getElementById('roi_maint_proposed').value,
      labor_hours: document.getElementById('roi_labor_proposed').value,
      fines: document.getElementById('roi_fines_proposed').value
    }
  };
  
  var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'roi_analysis.json';
  a.click();
  showToast('ROI data exported', 'success');
}

function addToProposal() {
  switchPanel('proposals');
  showToast('Navigate to Proposals tab to include ROI analysis', 'info');
}

function showModal(title, content, options) {
  // Close any existing modals first
  var existingModals = document.querySelectorAll('.wwtp-modal-overlay');
  existingModals.forEach(function(m) { m.remove(); });
  
  var opts = options || {};
  var width = opts.width || '800px';
  
  var modal = document.createElement('div');
  modal.className = 'wwtp-modal-overlay';
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:10000;display:flex;justify-content:center;align-items:center;padding:20px;box-sizing:border-box';
  
  // Close on backdrop click
  modal.onclick = function(e) {
    if (e.target === modal) {
      modal.remove();
    }
  };
  
  modal.innerHTML = '<div class="wwtp-modal-content" style="background:#1a2744;padding:0;border-radius:16px;max-width:' + width + ';width:100%;max-height:90vh;overflow:hidden;box-shadow:0 25px 60px rgba(0,0,0,0.5);animation:modalFadeIn 0.2s ease" onclick="event.stopPropagation()">' +
    '<div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:linear-gradient(135deg,#1e3a5f,#2d4a6f);border-bottom:1px solid #374151">' +
    '<h3 style="margin:0;color:white;font-size:17px">' + title + '</h3>' +
    '<button onclick="this.closest(\'.wwtp-modal-overlay\').remove()" style="background:rgba(239,68,68,0.2);color:#f87171;border:1px solid #ef4444;padding:6px 14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s" onmouseover="this.style.background=\'#ef4444\';this.style.color=\'white\'" onmouseout="this.style.background=\'rgba(239,68,68,0.2)\';this.style.color=\'#f87171\'">‚úï Close</button>' +
    '</div>' +
    '<div style="padding:20px;overflow-y:auto;max-height:calc(90vh - 70px)">' + content + '</div>' +
    '</div>';
  
  document.body.appendChild(modal);
  
  // Add escape key listener
  var escHandler = function(e) {
    if (e.key === 'Escape') {
      modal.remove();
      document.removeEventListener('keydown', escHandler);
    }
  };
  document.addEventListener('keydown', escHandler);
}

// Add modal animation style if not exists
if (!document.getElementById('modalAnimStyle')) {
  var style = document.createElement('style');
  style.id = 'modalAnimStyle';
  style.textContent = '@keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95) translateY(-10px); } to { opacity: 1; transform: scale(1) translateY(0); } }';
  document.head.appendChild(style);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  renderClients();
  updateClientStats();
  renderSavedProposals();
  updateProposalTotal();
  
  // Set default dates
  var today = new Date().toISOString().split('T')[0];
  if (document.getElementById('prop_date')) document.getElementById('prop_date').value = today;
  var validDate = new Date();
  validDate.setDate(validDate.getDate() + 30);
  if (document.getElementById('prop_valid')) document.getElementById('prop_valid').value = validDate.toISOString().split('T')[0];
});

</script>

<!-- Floating Action Button -->
<div id="fab-menu" style="position:fixed;bottom:20px;right:20px;z-index:1000">
<button onclick="document.getElementById('fab-options').style.display=document.getElementById('fab-options').style.display==='none'?'flex':'none'" style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;font-size:18px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.3)">‚öôÔ∏è</button>
<div id="fab-options" style="display:none;flex-direction:column;gap:8px;position:absolute;bottom:65px;right:0">
<button onclick="calculateAll();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#06d6a0;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">‚ö° Calculate All</button>
<button onclick="exportResults();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#0077b6;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üì§ Export Results</button>
<button onclick="quickStatus();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#ffd166;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üìä Quick Status</button>
<button onclick="printPanel();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#00b4d8;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üñ®Ô∏è Print Panel</button>
</div>
</div>


<!-- Voice Control Button -->
<button id="voiceBtn" class="voice-btn" onclick="toggleVoice()" title="Voice Commands">üé§</button>
<div id="voiceFeedback" class="voice-feedback"></div>

<!-- Mobile Bottom Navigation -->
<nav id="mobileNav" class="mobile-bottom-nav" role="navigation" aria-label="Main navigation">
  <button id="quickNav1" onclick="quickNavClick(0)" class="mobile-nav-btn active" type="button" aria-label="Dashboard">
    <span class="mobile-nav-icon" aria-hidden="true">üìä</span>
    <span class="mobile-nav-label">Dashboard</span>
  </button>
  <button id="quickNav2" onclick="quickNavClick(1)" class="mobile-nav-btn" type="button" aria-label="Process Control">
    <span class="mobile-nav-icon" aria-hidden="true">‚öôÔ∏è</span>
    <span class="mobile-nav-label">Process</span>
  </button>
  <button id="quickNav3" onclick="quickNavClick(2)" class="mobile-nav-btn" type="button" aria-label="Troubleshoot">
    <span class="mobile-nav-icon" aria-hidden="true">üîç</span>
    <span class="mobile-nav-label">Trouble</span>
  </button>
  <button id="quickNav4" onclick="quickNavClick(3)" class="mobile-nav-btn" type="button" aria-label="Simulate">
    <span class="mobile-nav-icon" aria-hidden="true">üîÆ</span>
    <span class="mobile-nav-label">Simulate</span>
  </button>
  <button onclick="toggleMobileMenu()" class="mobile-nav-btn mobile-menu-trigger" type="button" aria-label="More options" aria-expanded="false">
    <span class="mobile-nav-icon" aria-hidden="true">‚ò∞</span>
    <span class="mobile-nav-label">More</span>
  </button>
</nav>

<!-- Quick Nav Customization Modal -->
<div id="quickNavModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:100000;padding:20px;overflow-y:auto">
<div style="max-width:450px;margin:20px auto;background:linear-gradient(135deg,#1e3a5f,#2d4a6f);border-radius:16px;padding:20px;border:2px solid #f59e0b">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h3 style="margin:0;color:#f59e0b">‚ö° Customize Quick Nav</h3>
<button onclick="closeQuickNavModal()" style="background:#ef4444;border:none;color:white;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:18px">‚úï</button>
</div>
<p style="color:#94a3b8;font-size:14px;margin-bottom:20px">Choose panels for your 4 quick access buttons. Tap a slot to select it, then tap a panel to assign.</p>

<div id="quickNavSlots" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px">
<div class="quick-nav-slot" data-slot="0" onclick="selectQuickNavSlot(0)" style="background:#374151;padding:12px 8px;border-radius:10px;text-align:center;border:2px solid #4ade80;cursor:pointer">
<div style="font-size:18px" id="slot0Icon">üìä</div>
<div style="font-size:10px;margin-top:5px;color:#f0f9ff" id="slot0Label">Dashboard</div>
</div>
<div class="quick-nav-slot" data-slot="1" onclick="selectQuickNavSlot(1)" style="background:#374151;padding:12px 8px;border-radius:10px;text-align:center;border:2px solid #60a5fa;cursor:pointer">
<div style="font-size:18px" id="slot1Icon">‚öôÔ∏è</div>
<div style="font-size:10px;margin-top:5px;color:#f0f9ff" id="slot1Label">Process</div>
</div>
<div class="quick-nav-slot" data-slot="2" onclick="selectQuickNavSlot(2)" style="background:#374151;padding:12px 8px;border-radius:10px;text-align:center;border:2px solid #f87171;cursor:pointer">
<div style="font-size:18px" id="slot2Icon">üîç</div>
<div style="font-size:10px;margin-top:5px;color:#f0f9ff" id="slot2Label">Trouble</div>
</div>
<div class="quick-nav-slot" data-slot="3" onclick="selectQuickNavSlot(3)" style="background:#374151;padding:12px 8px;border-radius:10px;text-align:center;border:2px solid #a78bfa;cursor:pointer">
<div style="font-size:18px" id="slot3Icon">üîÆ</div>
<div style="font-size:10px;margin-top:5px;color:#f0f9ff" id="slot3Label">Simulate</div>
</div>
</div>

<div style="color:#94a3b8;font-size:13px;margin-bottom:10px">Tap a panel to assign it to the selected slot:</div>
<div id="quickNavPanelGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-height:300px;overflow-y:auto">
</div>

<div style="margin-top:20px;display:flex;gap:10px">
<button onclick="saveQuickNav()" class="btn gradient" style="flex:1">üíæ Save</button>
<button onclick="resetQuickNav()" class="btn gray" style="flex:1">üîÑ Reset Default</button>
</div>
</div>
</div>

<!-- Mobile Full Menu Overlay -->
<div id="mobileMenuOverlay" class="mobile-menu-overlay">
  <div class="mobile-menu-header">
    <h3>üè≠ WWTP Command Center</h3>
    <button onclick="toggleMobileMenu()" class="mobile-menu-close">‚úï</button>
  </div>
  
  <!-- EXECUTIVE Section -->
  <div style="padding:8px 15px 4px 15px">
    <div style="font-size:11px;font-weight:700;color:#3b82f6;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;align-items:center;gap:6px">
      <span>üìä</span> Executive
    </div>
  </div>
  <div class="mobile-menu-grid" style="padding:0 15px 8px 15px">
    <button onclick="switchPanel('dashboard');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(59,130,246,0.3)">
      <span>üìä</span><span>Dashboard</span>
    </button>
    <button onclick="switchPanel('reports');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(59,130,246,0.3)">
      <span>üìë</span><span>Reports</span>
    </button>
    <button onclick="switchPanel('multiplant');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(59,130,246,0.3)">
      <span>üåê</span><span>Multi-Plant</span>
    </button>
  </div>
  
  <!-- OPERATIONS Section -->
  <div style="padding:8px 15px 4px 15px;border-top:1px solid #374151">
    <div style="font-size:11px;font-weight:700;color:#10b981;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;align-items:center;gap:6px">
      <span>‚öôÔ∏è</span> Operations <span style="font-size:9px;color:#6b7280;font-weight:400">(Hydraulic Flow Order)</span>
    </div>
  </div>
  <div class="mobile-menu-grid" style="padding:0 15px 8px 15px">
    <button onclick="switchPanel('daily-ops');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(16,185,129,0.3)">
      <span>üë∑</span><span>Daily Ops</span>
    </button>
    <button onclick="switchPanel('hydraulics');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(16,185,129,0.3)">
      <span>üíß</span><span>Hydraulics</span>
    </button>
    <button onclick="switchPanel('process-control');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(16,185,129,0.3)">
      <span>‚öôÔ∏è</span><span>Process</span>
    </button>
    <button onclick="switchPanel('aeration');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(16,185,129,0.3)">
      <span>üí®</span><span>Aeration</span>
    </button>
    <button onclick="switchPanel('reactors');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(16,185,129,0.3)">
      <span>üîÑ</span><span>Reactors</span>
    </button>
    <button onclick="switchPanel('chemicals');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(16,185,129,0.3)">
      <span>‚öóÔ∏è</span><span>Chemicals</span>
    </button>
    <button onclick="switchPanel('solids');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(16,185,129,0.3)">
      <span>üóëÔ∏è</span><span>Solids</span>
    </button>
    <button onclick="switchPanel('compliance');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(16,185,129,0.3)">
      <span>üìã</span><span>Compliance</span>
    </button>
    <button onclick="switchPanel('maintenance');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(16,185,129,0.3)">
      <span>üîß</span><span>Maintenance</span>
    </button>
    <button onclick="switchPanel('troubleshoot');toggleMobileMenu()" class="mobile-menu-item" style="background:linear-gradient(135deg,#dc2626,#f97316);border:1px solid rgba(239,68,68,0.5)">
      <span>üîç</span><span>Troubleshoot</span>
    </button>
    <button onclick="switchPanel('simulations');toggleMobileMenu()" class="mobile-menu-item" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);border:1px solid rgba(99,102,241,0.5)">
      <span>üîÆ</span><span>Simulate</span>
    </button>
    <button onclick="switchPanel('panel-training');toggleMobileMenu()" class="mobile-menu-item" style="background:linear-gradient(135deg,#dc2626,#7c3aed);border:1px solid rgba(124,58,237,0.5)">
      <span>üéì</span><span>Training</span>
    </button>
    <button onclick="switchPanel('certification');toggleMobileMenu()" class="mobile-menu-item" style="background:linear-gradient(135deg,#059669,#10b981);border:1px solid rgba(16,185,129,0.5)">
      <span>üìú</span><span>Cert Prep</span>
    </button>
  </div>
  
  <!-- BUSINESS Section -->
  <div style="padding:8px 15px 4px 15px;border-top:1px solid #374151">
    <div style="font-size:11px;font-weight:700;color:#f59e0b;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;align-items:center;gap:6px">
      <span>üíº</span> Business
    </div>
  </div>
  <div class="mobile-menu-grid" style="padding:0 15px 8px 15px">
    <button onclick="switchPanel('business');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(245,158,11,0.3)">
      <span>üí∞</span><span>Costs</span>
    </button>
    <button onclick="switchPanel('profiles');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(245,158,11,0.3)">
      <span>üè≠</span><span>Profiles</span>
    </button>
    <button onclick="switchPanel('wizards');toggleMobileMenu()" class="mobile-menu-item" style="border:1px solid rgba(245,158,11,0.3)">
      <span>üßô</span><span>Wizards</span>
    </button>
  </div>
  
  <div style="padding:15px;border-top:1px solid #374151;margin-top:10px">
    <button onclick="toggleMobileMenu();openQuickNavModal()" style="width:100%;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;padding:15px;border-radius:10px;color:white;font-weight:bold;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px">
      <span>‚ö°</span> Customize Quick Nav Buttons
    </button>
  </div>
</div>

<style>
/* Mobile Bottom Navigation Bar */
.mobile-bottom-nav{
  display:none;
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:linear-gradient(to top,#0c1929,#1a2744);
  border-top:1px solid #023e8a;
  padding:8px 0 calc(8px + env(safe-area-inset-bottom));
  z-index:1000;
  justify-content:space-around;
  align-items:center;
  box-shadow:0 -4px 20px rgba(30,58,138,0.4)
}

.mobile-nav-btn{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  background:none;
  border:none;
  color:#94a3b8;
  padding:8px 16px;
  cursor:pointer;
  transition:all 0.2s;
  border-radius:12px
}

.mobile-nav-btn.active,.mobile-nav-btn:active{
  color:#90e0ef;
  background:rgba(99,102,241,0.2)
}

.mobile-nav-icon{font-size:22px}
.mobile-nav-label{font-size:10px;font-weight:600}

/* Mobile Menu Overlay */
.mobile-menu-overlay{
  display:none;
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(15,23,42,0.98);
  z-index:2000;
  flex-direction:column;
  animation:fadeIn 0.2s
}

.mobile-menu-overlay.active{display:flex}

.mobile-menu-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px;
  border-bottom:1px solid #023e8a
}

.mobile-menu-header h3{
  color:#90e0ef;
  font-size:18px;
  margin:0
}

.mobile-menu-close{
  background:none;
  border:none;
  color:#94a3b8;
  font-size:18px;
  cursor:pointer;
  padding:8px;
  border-radius:8px
}

.mobile-menu-close:hover{background:#243b55}

.mobile-menu-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  padding:20px;
  overflow-y:auto;
  flex:1
}

.mobile-menu-item{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  padding:20px 12px;
  background:#1a2744;
  border:1px solid #475569;
  border-radius:12px;
  color:#e0f2fe;
  cursor:pointer;
  transition:all 0.2s
}

.mobile-menu-item:active{
  background:#023e8a;
  transform:scale(0.95)
}

.mobile-menu-item span:first-child{font-size:20px}
.mobile-menu-item span:last-child{font-size:11px;font-weight:600;text-align:center}

/* Show mobile nav on small screens */
@media(max-width:767px){
  .mobile-bottom-nav{display:flex}
  .tabs{display:none !important}
  .voice-btn{bottom:90px}
  .panel{padding-bottom:100px}
  
  /* Ensure sticky header works properly on mobile */
  .sticky-header{
    position:sticky !important;
    top:0 !important;
    z-index:1000 !important;
    background:linear-gradient(135deg,#0a1628 0%,#1e3a5f 50%,#0d2137 100%) !important;
  }
  
  /* Compact mobile header */
  .sticky-header .header{
    padding:10px 12px !important;
  }
  
  /* Hide elements we don't need on mobile */
  .sticky-header nav.tabs{display:none !important}
  
  /* Content should start immediately after header */
  .content{
    padding:10px !important;
    padding-top:10px !important;
  }
  
  /* Fix any overflow issues */
  .wrap{
    overflow-x:hidden;
  }
}

/* Tablet: show tabs, hide mobile nav */
@media(min-width:768px){
  .mobile-bottom-nav{display:none !important}
  .mobile-menu-overlay{display:none !important}
}
</style>

<script>
// Mobile menu toggle
function toggleMobileMenu() {
  var overlay = document.getElementById('mobileMenuOverlay');
  overlay.classList.toggle('active');
  document.body.style.overflow = overlay.classList.contains('active') ? 'hidden' : '';
}


// ========== SECTION-BASED NAVIGATION v9.9.27 ==========

// Section definitions with panel mappings
var sectionConfig = {
  executive: {
    name: 'Executive',
    icon: 'üìä',
    color: '#3b82f6',
    panels: ['dashboard', 'reports', 'multiplant']
  },
  operations: {
    name: 'Operations',
    icon: '‚öôÔ∏è',
    color: '#10b981',
    panels: ['daily-ops', 'hydraulics', 'process-control', 'aeration', 'reactors', 'chemicals', 'solids', 'compliance', 'maintenance', 'troubleshoot', 'simulations', 'panel-training', 'certification']
  },
  business: {
    name: 'Business',
    icon: 'üíº',
    color: '#f59e0b',
    panels: ['business', 'profiles', 'wizards']
  }
};

// Panel display names for breadcrumb
var panelNames = {
  'dashboard': 'Dashboard',
  'daily-ops': 'Daily Operations',
  'process-control': 'Process Control',
  'reactors': 'Reactor Systems',
  'hydraulics': 'Flow & Hydraulics',
  'aeration': 'Aeration & DO',
  'chemicals': 'Chemical Systems',
  'solids': 'Solids Management',
  'compliance': 'Compliance & Lab',
  'wizards': 'Analysis Wizards',
  'maintenance': 'Maintenance',
  'reports': 'Reports & Trends',
  'profiles': 'Plant Profiles',
  'business': 'Cost Management',
  'multiplant': 'Multi-Plant',
  'troubleshoot': 'Troubleshooting',
  'simulations': 'Process Simulations',
  'certification': 'Certification Prep',
  'panel-training': 'Training & Safety'
};

var currentSection = 'operations';

// Section button styling configs
var sectionStyles = {
  executive: {
    activeIcon: 'background:linear-gradient(135deg,#3b82f6,#1d4ed8)',
    activeBody: 'background:linear-gradient(135deg,#3b82f6,#2563eb)',
    activeTitle: 'color:white',
    activeSub: 'color:#bfdbfe',
    activeBorder: 'border-color:#60a5fa',
    activeShadow: 'box-shadow:0 4px 25px rgba(59,130,246,0.5)',
    inactiveIcon: 'background:linear-gradient(135deg,#3b82f6,#1d4ed8)',
    inactiveBody: 'background:linear-gradient(145deg,#1e3a5f,#172554)',
    inactiveTitle: 'color:#93c5fd',
    inactiveSub: 'color:#64748b',
    inactiveBorder: 'border-color:#3b82f6',
    inactiveShadow: 'box-shadow:0 4px 20px rgba(59,130,246,0.2)'
  },
  operations: {
    activeIcon: 'background:linear-gradient(135deg,#059669,#047857)',
    activeBody: 'background:linear-gradient(135deg,#10b981,#059669)',
    activeTitle: 'color:white',
    activeSub: 'color:#d1fae5',
    activeBorder: 'border-color:#34d399',
    activeShadow: 'box-shadow:0 4px 25px rgba(16,185,129,0.5)',
    inactiveIcon: 'background:linear-gradient(135deg,#059669,#047857)',
    inactiveBody: 'background:linear-gradient(145deg,#134e4a,#0f3d3a)',
    inactiveTitle: 'color:#6ee7b7',
    inactiveSub: 'color:#64748b',
    inactiveBorder: 'border-color:#10b981',
    inactiveShadow: 'box-shadow:0 4px 20px rgba(16,185,129,0.2)'
  },
  business: {
    activeIcon: 'background:linear-gradient(135deg,#f59e0b,#d97706)',
    activeBody: 'background:linear-gradient(135deg,#f59e0b,#d97706)',
    activeTitle: 'color:white',
    activeSub: 'color:#fef3c7',
    activeBorder: 'border-color:#fbbf24',
    activeShadow: 'box-shadow:0 4px 25px rgba(245,158,11,0.5)',
    inactiveIcon: 'background:linear-gradient(135deg,#f59e0b,#d97706)',
    inactiveBody: 'background:linear-gradient(145deg,#78350f,#451a03)',
    inactiveTitle: 'color:#fcd34d',
    inactiveSub: 'color:#a16207',
    inactiveBorder: 'border-color:#f59e0b',
    inactiveShadow: 'box-shadow:0 4px 20px rgba(245,158,11,0.2)'
  }
};

// Switch between main sections (Executive, Operations, Business)
function switchSection(sectionId) {
  console.log('[v9.9.27] switchSection:', sectionId);
  currentSection = sectionId;
  
  // Update section buttons with premium styling
  document.querySelectorAll('.section-btn').forEach(function(btn) {
    var btnSection = btn.id.replace('section-btn-', '');
    var styles = sectionStyles[btnSection];
    var isActive = (btnSection === sectionId);
    
    var iconDiv = btn.children[0];
    var bodyDiv = btn.children[1];
    var titleSpan = bodyDiv ? bodyDiv.children[0] : null;
    var subSpan = bodyDiv ? bodyDiv.children[1] : null;
    
    if (isActive) {
      btn.style.cssText = btn.style.cssText.replace(/border-color:[^;]+/, styles.activeBorder).replace(/box-shadow:[^;]+/, styles.activeShadow);
      btn.style.borderColor = styles.activeBorder.split(':')[1];
      btn.style.boxShadow = styles.activeShadow.split('box-shadow:')[1];
      if (iconDiv) iconDiv.style.background = styles.activeIcon.split(':')[1];
      if (bodyDiv) bodyDiv.style.background = styles.activeBody.split(':')[1];
      if (titleSpan) titleSpan.style.color = 'white';
      if (subSpan) subSpan.style.color = styles.activeSub.split(':')[1];
    } else {
      btn.style.borderColor = styles.inactiveBorder.split(':')[1];
      btn.style.boxShadow = styles.inactiveShadow.split('box-shadow:')[1];
      if (iconDiv) iconDiv.style.background = styles.inactiveIcon.split(':')[1];
      if (bodyDiv) bodyDiv.style.background = styles.inactiveBody.split(':')[1];
      if (titleSpan) titleSpan.style.color = styles.inactiveTitle.split(':')[1];
      if (subSpan) subSpan.style.color = styles.inactiveSub.split(':')[1];
    }
  });
  
  // Show/hide section tabs
  document.querySelectorAll('.section-tabs').forEach(function(tabs) {
    tabs.style.display = 'none';
  });
  var activeTabs = document.getElementById('tabs-' + sectionId);
  if (activeTabs) {
    activeTabs.style.display = 'flex';
  }
  
  // Switch to first panel in section if current panel not in this section
  var config = sectionConfig[sectionId];
  var currentPanel = document.querySelector('.panel.active');
  var currentPanelId = currentPanel ? currentPanel.id : null;
  
  if (!config.panels.includes(currentPanelId)) {
    switchPanel(config.panels[0]);
  } else {
    updateBreadcrumb(currentPanelId);
  }
}

// Helper function to adjust color brightness
function adjustColor(hex, percent) {
  var num = parseInt(hex.replace('#', ''), 16);
  var r = Math.min(255, Math.max(0, (num >> 16) + percent));
  var g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + percent));
  var b = Math.min(255, Math.max(0, (num & 0x0000FF) + percent));
  return '#' + (0x1000000 + r * 0x10000 + g * 0x100 + b).toString(16).slice(1);
}

// Update breadcrumb display
function updateBreadcrumb(panelId) {
  var breadcrumb = document.getElementById('nav-breadcrumb');
  var panelSpan = document.getElementById('breadcrumb-panel');
  
  if (!breadcrumb || !panelSpan) return;
  
  // Find which section this panel belongs to
  var section = null;
  for (var key in sectionConfig) {
    if (sectionConfig[key].panels.includes(panelId)) {
      section = sectionConfig[key];
      currentSection = key;
      break;
    }
  }
  
  if (section) {
    breadcrumb.innerHTML = '<span style="color:' + section.color + '">' + section.icon + ' ' + section.name + '</span> <span style="margin:0 6px;color:#475569">‚Ä∫</span> <span id="breadcrumb-panel" style="color:#e2e8f0;font-weight:600">' + (panelNames[panelId] || panelId) + '</span>';
  }
}

// Find section for a panel
function getSectionForPanel(panelId) {
  for (var key in sectionConfig) {
    if (sectionConfig[key].panels.includes(panelId)) {
      return key;
    }
  }
  return 'operations'; // default
}

// Enhanced switchPanel to update section tabs and breadcrumb
var originalSwitchPanel = typeof switchPanel === 'function' ? switchPanel : null;

function switchPanelEnhanced(panelId) {
  console.log('[v9.9.27] switchPanelEnhanced:', panelId);
  
  // Find which section this panel belongs to
  var targetSection = getSectionForPanel(panelId);
  
  // If switching to a panel in a different section, switch sections first
  if (targetSection !== currentSection) {
    // Update section buttons without switching panel
    currentSection = targetSection;
    document.querySelectorAll('.section-btn').forEach(function(btn) {
      var btnSection = btn.id.replace('section-btn-', '');
      var styles = sectionStyles[btnSection];
      var isActive = (btnSection === targetSection);
      
      var iconDiv = btn.children[0];
      var bodyDiv = btn.children[1];
      var titleSpan = bodyDiv ? bodyDiv.children[0] : null;
      var subSpan = bodyDiv ? bodyDiv.children[1] : null;
      
      if (isActive) {
        btn.style.borderColor = styles.activeBorder.split(':')[1];
        btn.style.boxShadow = styles.activeShadow.split('box-shadow:')[1];
        if (iconDiv) iconDiv.style.background = styles.activeIcon.split(':')[1];
        if (bodyDiv) bodyDiv.style.background = styles.activeBody.split(':')[1];
        if (titleSpan) titleSpan.style.color = 'white';
        if (subSpan) subSpan.style.color = styles.activeSub.split(':')[1];
      } else {
        btn.style.borderColor = styles.inactiveBorder.split(':')[1];
        btn.style.boxShadow = styles.inactiveShadow.split('box-shadow:')[1];
        if (iconDiv) iconDiv.style.background = styles.inactiveIcon.split(':')[1];
        if (bodyDiv) bodyDiv.style.background = styles.inactiveBody.split(':')[1];
        if (titleSpan) titleSpan.style.color = styles.inactiveTitle.split(':')[1];
        if (subSpan) subSpan.style.color = styles.inactiveSub.split(':')[1];
      }
    });
    
    // Show correct section tabs
    document.querySelectorAll('.section-tabs').forEach(function(tabs) {
      tabs.style.display = 'none';
    });
    var activeTabs = document.getElementById('tabs-' + targetSection);
    if (activeTabs) {
      activeTabs.style.display = 'flex';
    }
  }
  
  // Remove active from all panels
  document.querySelectorAll('.panel').forEach(function(p) {
    p.classList.remove('active');
  });
  
  // Add active to target
  var target = document.getElementById(panelId);
  if (target) {
    target.classList.add('active');
  }
  
  // Update tabs in current section
  document.querySelectorAll('.section-tabs .tab').forEach(function(t) {
    var isTarget = t.getAttribute('data-panel') === panelId;
    t.classList.toggle('active', isTarget);
    t.setAttribute('aria-selected', isTarget ? 'true' : 'false');
  });
  
  // Update breadcrumb
  updateBreadcrumb(panelId);
  
  window.scrollTo(0, 0);
}

// Replace the original switchPanel
switchPanel = switchPanelEnhanced;

// ========== CUSTOMIZABLE QUICK NAV ==========
var quickNavPanels = [
  { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
  { id: 'daily-ops', icon: 'üë∑', label: 'Daily Ops' },
  { id: 'process-control', icon: '‚öôÔ∏è', label: 'Process' },
  { id: 'reactors', icon: 'üîÑ', label: 'Reactors' },
  { id: 'hydraulics', icon: 'üìê', label: 'Hydraulics' },
  { id: 'aeration', icon: 'üí®', label: 'Aeration' },
  { id: 'chemicals', icon: '‚öóÔ∏è', label: 'Chemicals' },
  { id: 'solids', icon: 'üóëÔ∏è', label: 'Solids' },
  { id: 'compliance', icon: 'üìã', label: 'Compliance' },
  { id: 'wizards', icon: 'ü©∫', label: 'Diagnose' },
  { id: 'troubleshoot', icon: 'üîç', label: 'Troubleshoot' },
  { id: 'simulations', icon: 'üîÆ', label: 'Simulate' },
  { id: 'certification', icon: 'üìú', label: 'Cert Prep' },
  { id: 'panel-training', icon: 'üéì', label: 'Training' },
  { id: 'maintenance', icon: 'üîß', label: 'Maintenance' },
  { id: 'reports', icon: 'üìë', label: 'Reports' },
  { id: 'profiles', icon: 'üè≠', label: 'Profiles' },
  { id: 'business', icon: 'üíº', label: 'Business' },
  { id: 'multiplant', icon: 'üåê', label: 'Multi-Plant' }
];

var quickNavConfig = [
  { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
  { id: 'process-control', icon: '‚öôÔ∏è', label: 'Process' },
  { id: 'troubleshoot', icon: 'üîç', label: 'Trouble' },
  { id: 'simulations', icon: 'üîÆ', label: 'Simulate' }
];

var selectedQuickNavSlot = 0;

function initQuickNav() {
  // Load saved config
  var saved = localStorage.getItem('wwtp_quick_nav_v2');
  if (saved) {
    try {
      var parsed = JSON.parse(saved);
      if (parsed.length === 4) {
        quickNavConfig = parsed;
      }
    } catch(e) {}
  }
  updateQuickNavButtons();
}

function updateQuickNavButtons() {
  for (var i = 0; i < 4; i++) {
    var btn = document.getElementById('quickNav' + (i + 1));
    if (btn && quickNavConfig[i]) {
      btn.querySelector('.mobile-nav-icon').textContent = quickNavConfig[i].icon;
      btn.querySelector('.mobile-nav-label').textContent = quickNavConfig[i].label;
      btn.setAttribute('data-panel', quickNavConfig[i].id);
    }
  }
}

function quickNavClick(index) {
  if (quickNavConfig[index]) {
    switchPanel(quickNavConfig[index].id);
    // Update active state
    var btns = document.querySelectorAll('.mobile-nav-btn');
    btns.forEach(function(b, i) {
      b.classList.toggle('active', i === index);
    });
  }
}

function openQuickNavModal() {
  selectedQuickNavSlot = 0;
  updateQuickNavModalSlots();
  buildQuickNavPanelGrid();
  document.getElementById('quickNavModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeQuickNavModal() {
  document.getElementById('quickNavModal').style.display = 'none';
  document.body.style.overflow = '';
}

function selectQuickNavSlot(index) {
  selectedQuickNavSlot = index;
  updateQuickNavModalSlots();
}

function updateQuickNavModalSlots() {
  var slotColors = ['#4ade80', '#60a5fa', '#f87171', '#a78bfa'];
  for (var i = 0; i < 4; i++) {
    var iconEl = document.getElementById('slot' + i + 'Icon');
    var labelEl = document.getElementById('slot' + i + 'Label');
    if (iconEl && quickNavConfig[i]) iconEl.textContent = quickNavConfig[i].icon;
    if (labelEl && quickNavConfig[i]) labelEl.textContent = quickNavConfig[i].label;
    
    // Highlight selected slot
    var slots = document.querySelectorAll('.quick-nav-slot');
    if (slots[i]) {
      slots[i].style.borderColor = (i === selectedQuickNavSlot) ? '#f59e0b' : slotColors[i];
      slots[i].style.transform = (i === selectedQuickNavSlot) ? 'scale(1.05)' : 'scale(1)';
      slots[i].style.boxShadow = (i === selectedQuickNavSlot) ? '0 0 15px rgba(245,158,11,0.5)' : 'none';
    }
  }
}

function buildQuickNavPanelGrid() {
  var html = '';
  quickNavPanels.forEach(function(panel) {
    var isSelected = quickNavConfig.some(function(c) { return c.id === panel.id; });
    html += '<button onclick="selectQuickNavPanel(\'' + panel.id + '\')" style="background:' + (isSelected ? '#059669' : '#374151') + ';border:none;padding:12px 8px;border-radius:8px;cursor:pointer;text-align:center">';
    html += '<div style="font-size:20px">' + panel.icon + '</div>';
    html += '<div style="font-size:10px;color:white;margin-top:4px">' + panel.label + '</div>';
    html += '</button>';
  });
  document.getElementById('quickNavPanelGrid').innerHTML = html;
}

function selectQuickNavPanel(panelId) {
  var panel = quickNavPanels.find(function(p) { return p.id === panelId; });
  if (panel) {
    quickNavConfig[selectedQuickNavSlot] = { id: panel.id, icon: panel.icon, label: panel.label };
    updateQuickNavModalSlots();
    buildQuickNavPanelGrid();
    
    // Auto-advance to next slot
    if (selectedQuickNavSlot < 3) {
      selectedQuickNavSlot++;
      updateQuickNavModalSlots();
    }
  }
}

function saveQuickNav() {
  localStorage.setItem('wwtp_quick_nav_v2', JSON.stringify(quickNavConfig));
  updateQuickNavButtons();
  closeQuickNavModal();
  showToast('‚ö° Quick Nav saved!', 'success');
}

function resetQuickNav() {
  quickNavConfig = [
    { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
    { id: 'process-control', icon: '‚öôÔ∏è', label: 'Process' },
    { id: 'troubleshoot', icon: 'üîç', label: 'Trouble' },
    { id: 'simulations', icon: 'üîÆ', label: 'Simulate' }
  ];
  updateQuickNavModalSlots();
  buildQuickNavPanelGrid();
}

// Initialize quick nav on load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initQuickNav, 500);
});
// ========== END CUSTOMIZABLE QUICK NAV ==========

// Update mobile nav active state - DISABLED FOR DEBUGGING
// // DISABLED: var originalSwitchPanel = window.switchPanel;
// window.switchPanel = function(panelId) {
//   originalSwitchPanel(panelId);
//   
//   // Update mobile bottom nav
//   var mobileNavBtns = document.querySelectorAll('.mobile-nav-btn[data-panel]');
//   mobileNavBtns.forEach(function(btn) {
//     btn.classList.toggle('active', btn.dataset.panel === panelId);
//   });
// };

// Swipe gesture support for tabs - DISABLED v9.9.16 (causing panel issues on tablet)
// (function() {
//   DISABLED - was switching panels on scroll
// })();

// Viewport height fix for mobile browsers
function setVH() {
  var vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', vh + 'px');
}
setVH();
window.addEventListener('resize', setVH);
</script>

<!-- ==================== ENHANCEMENT FEATURES v8.0.0 ==================== -->

<!-- Unit Converter Floating Widget -->
<div id="unitConverterWidget" style="display:none;position:fixed;bottom:100px;right:20px;width:320px;background:linear-gradient(135deg,#1a2744,#0c1929);border:2px solid #023e8a;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.5);z-index:1500;overflow:hidden">
  <div style="background:linear-gradient(135deg,#0077b6,#00b4d8);padding:12px 16px;display:flex;justify-content:space-between;align-items:center">
    <span style="color:white;font-weight:bold;font-size:14px">üîÑ Unit Converter</span>
    <button onclick="toggleUnitConverter()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer">√ó</button>
  </div>
  <div style="padding:16px">
    <select id="ucType" onchange="updateUnitConverter()" style="width:100%;padding:10px;border-radius:8px;border:1px solid #475569;background:#1a2744;color:#e0f2fe;margin-bottom:12px;font-size:14px">
      <option value="flow">Flow: MGD ‚Üî GPM ‚Üî m¬≥/day</option>
      <option value="mass">Mass Load: mg/L ‚Üî lb/day</option>
      <option value="temp">Temperature: ¬∞C ‚Üî ¬∞F</option>
      <option value="pressure">Pressure: PSI ‚Üî ft H‚ÇÇO ‚Üî kPa</option>
      <option value="length">Length: ft ‚Üî m ‚Üî in</option>
      <option value="volume">Volume: gal ‚Üî L ‚Üî ft¬≥</option>
      <option value="conc">Concentration: mg/L ‚Üî % ‚Üî lb/MG</option>
    </select>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <input type="number" id="ucInput" value="1" step="any" oninput="convertUnits()" style="flex:1;padding:10px;border-radius:8px;border:1px solid #475569;background:#0c1929;color:#4ade80;font-size:16px;font-weight:bold">
      <select id="ucFrom" onchange="convertUnits()" style="flex:1;padding:10px;border-radius:8px;border:1px solid #475569;background:#1a2744;color:#e0f2fe;font-size:12px"></select>
    </div>
    <div style="text-align:center;color:#64748b;margin:8px 0">‚¨áÔ∏è</div>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="text" id="ucOutput" readonly style="flex:1;padding:10px;border-radius:8px;border:1px solid #023e8a;background:#023e8a;color:#90e0ef;font-size:16px;font-weight:bold;text-align:center">
      <select id="ucTo" onchange="convertUnits()" style="flex:1;padding:10px;border-radius:8px;border:1px solid #475569;background:#1a2744;color:#e0f2fe;font-size:12px"></select>
    </div>
    <div id="ucFormula" style="margin-top:12px;padding:10px;background:#0c1929;border-radius:8px;color:#94a3b8;font-size:11px;text-align:center"></div>
  </div>
</div>

<!-- Floating Action Buttons -->
<div id="fabMenu" style="position:fixed;bottom:20px;right:20px;z-index:1400;display:flex;flex-direction:column;align-items:flex-end;gap:10px">
  <button id="fabUnitConv" onclick="toggleUnitConverter()" title="Unit Converter" style="display:none;width:50px;height:50px;border-radius:50%;border:none;background:linear-gradient(135deg,#0077b6,#00b4d8);color:white;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(59,130,246,0.4);transition:transform 0.2s">üîÑ</button>
  <button id="fabPDF" onclick="exportToPDF()" title="Export to PDF" style="display:none;width:50px;height:50px;border-radius:50%;border:none;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(239,68,68,0.4);transition:transform 0.2s">üìÑ</button>
  <button id="fabTheme" onclick="toggleThemeWithMemory()" title="Toggle Dark/Light" style="display:none;width:50px;height:50px;border-radius:50%;border:none;background:linear-gradient(135deg,#ffd166,#d97706);color:white;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(245,158,11,0.4);transition:transform 0.2s">üåì</button>
  <button id="fabMain" onclick="toggleFabMenu()" style="width:60px;height:60px;border-radius:50%;border:none;background:linear-gradient(135deg,#00b4d8,#0096c7);color:white;font-size:18px;cursor:pointer;box-shadow:0 6px 20px rgba(139,92,246,0.5);transition:transform 0.3s">‚ö°</button>
</div>

<!-- Offline Indicator -->
<div id="offlineIndicator" style="display:none;position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#ffd166,#d97706);color:white;text-align:center;padding:8px;font-size:13px;font-weight:600;z-index:2000">
  üì¥ Offline Mode - Data saved locally
</div>

<!-- PDF Export Modal -->
<div id="pdfModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:2000;justify-content:center;align-items:center">
  <div style="background:#1a2744;border-radius:16px;padding:24px;max-width:400px;width:90%;border:2px solid #023e8a">
    <h3 style="color:#90e0ef;margin:0 0 16px 0;font-size:18px">üìÑ Export to PDF</h3>
    <div style="margin-bottom:16px">
      <label style="color:#94a3b8;font-size:13px;display:block;margin-bottom:6px">Report Title</label>
      <input type="text" id="pdfTitle" value="WWTP Analysis Report" style="width:100%;padding:10px;border-radius:8px;border:1px solid #475569;background:#0c1929;color:#e0f2fe;box-sizing:border-box">
    </div>
    <div style="margin-bottom:16px">
      <label style="color:#94a3b8;font-size:13px;display:block;margin-bottom:6px">Include Sections</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label style="color:#e0f2fe;font-size:12px;display:flex;align-items:center;gap:6px"><input type="checkbox" id="pdfCalcs" checked> Calculations</label>
        <label style="color:#e0f2fe;font-size:12px;display:flex;align-items:center;gap:6px"><input type="checkbox" id="pdfKPIs" checked> KPI Summary</label>
        <label style="color:#e0f2fe;font-size:12px;display:flex;align-items:center;gap:6px"><input type="checkbox" id="pdfTimestamp" checked> Timestamp</label>
        <label style="color:#e0f2fe;font-size:12px;display:flex;align-items:center;gap:6px"><input type="checkbox" id="pdfNotes"> Notes</label>
      </div>
    </div>
    <div style="margin-bottom:16px" id="pdfNotesSection">
      <label style="color:#94a3b8;font-size:13px;display:block;margin-bottom:6px">Notes</label>
      <textarea id="pdfNotesText" rows="3" style="width:100%;padding:10px;border-radius:8px;border:1px solid #475569;background:#0c1929;color:#e0f2fe;resize:none;box-sizing:border-box" placeholder="Add notes to include in report..."></textarea>
    </div>
    <div style="display:flex;gap:10px">
      <button onclick="generatePDF()" style="flex:1;padding:12px;border-radius:8px;border:none;background:linear-gradient(135deg,#0077b6,#00b4d8);color:white;font-weight:600;cursor:pointer">üìÑ Generate PDF</button>
      <button onclick="closePDFModal()" style="padding:12px 20px;border-radius:8px;border:1px solid #475569;background:transparent;color:#94a3b8;cursor:pointer">Cancel</button>
    </div>
  </div>
</div>

<!-- Data Persistence & Features Script -->
<script>
// ==================== 1. DATA PERSISTENCE ====================
const STORAGE_KEY = 'wwtp_v7_data';
const PREFS_KEY = 'wwtp_v7_prefs';

// Save all input values
function saveAllData() {
  const data = {};
  document.querySelectorAll('input[id], select[id]').forEach(el => {
    if (el.type === 'checkbox') {
      data[el.id] = el.checked;
    } else if (el.type !== 'button' && el.type !== 'submit') {
      data[el.id] = el.value;
    }
  });
  data._timestamp = new Date().toISOString();
  data._version = 'v8.0.0';
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  console.log('üíæ Data saved:', Object.keys(data).length, 'fields');
}

// Load all saved data
function loadAllData() {
  try {
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (!data) return;
    let count = 0;
    Object.keys(data).forEach(id => {
      if (id.startsWith('_')) return;
      const el = document.getElementById(id);
      if (el) {
        if (el.type === 'checkbox') {
          el.checked = data[id];
        } else {
          el.value = data[id];
        }
        count++;
      }
    });
    console.log('üìÇ Data loaded:', count, 'fields from', data._timestamp);
    showToast('üìÇ Previous data restored', 'info');
  } catch (e) {
    console.log('No saved data found');
  }
}

// Auto-save on input change
function initAutoSave() {
  document.addEventListener('change', (e) => {
    if (e.target.matches('input, select')) {
      saveAllData();
    }
  });
  document.addEventListener('input', debounce((e) => {
    if (e.target.matches('input[type="number"], input[type="text"], textarea')) {
      saveAllData();
    }
  }, 1000));
}

function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

// ==================== 2. DARK/LIGHT TOGGLE WITH MEMORY ====================
function toggleThemeWithMemory() {
  const html = document.documentElement;
  const isCurrentlyDark = html.classList.contains('dark');
  
  // Add transition class for smooth animation
  document.body.style.transition = 'background 0.5s ease';
  
  if (isCurrentlyDark) {
    html.classList.remove('dark');
    localStorage.setItem('theme', 'light');
    showToast('‚òÄÔ∏è Light mode activated', 'info');
  } else {
    html.classList.add('dark');
    localStorage.setItem('theme', 'dark');
    showToast('üåô Dark mode activated', 'info');
  }
  
  updateThemeIcon();
  updateThemeButtonStyle();
}

function loadThemePreference() {
  const saved = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  
  if (saved === 'light') {
    document.documentElement.classList.remove('dark');
  } else if (saved === 'dark' || prefersDark) {
    document.documentElement.classList.add('dark');
  }
  
  updateThemeIcon();
  updateThemeButtonStyle();
}

function updateThemeIcon() {
  const isDark = document.documentElement.classList.contains('dark');
  
  // Update FAB button
  const fabBtn = document.getElementById('fabTheme');
  if (fabBtn) {
    fabBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    fabBtn.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
  }
  
  // Update header button
  const headerBtn = document.getElementById('themeBtn');
  if (headerBtn) {
    headerBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    headerBtn.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
  }
}

function updateThemeButtonStyle() {
  const isDark = document.documentElement.classList.contains('dark');
  const headerBtn = document.getElementById('themeBtn');
  
  if (headerBtn) {
    if (isDark) {
      headerBtn.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
    } else {
      headerBtn.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
    }
  }
}

// Listen for system theme changes
if (window.matchMedia) {
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      if (e.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      updateThemeIcon();
      updateThemeButtonStyle();
    }
  });
}

// ==================== 3. UNIT CONVERTER ====================
const unitConfigs = {
  flow: {
    units: ['MGD', 'GPM', 'GPD', 'm¬≥/day', 'L/s'],
    conversions: {
      'MGD': 1,
      'GPM': 694.44,
      'GPD': 1000000,
      'm¬≥/day': 3785.41,
      'L/s': 43.8126
    }
  },
  mass: {
    units: ['lb/day', 'kg/day', 'mg/L√óMGD'],
    conversions: {
      'lb/day': 1,
      'kg/day': 0.453592,
      'mg/L√óMGD': 0.1198 // approximate, needs flow
    },
    note: 'lb/day = mg/L √ó MGD √ó 8.34'
  },
  temp: {
    units: ['¬∞C', '¬∞F', 'K'],
    special: true
  },
  pressure: {
    units: ['PSI', 'ft H‚ÇÇO', 'kPa', 'bar', 'atm'],
    conversions: {
      'PSI': 1,
      'ft H‚ÇÇO': 2.31,
      'kPa': 6.89476,
      'bar': 0.0689476,
      'atm': 0.068046
    }
  },
  length: {
    units: ['ft', 'm', 'in', 'cm'],
    conversions: {
      'ft': 1,
      'm': 0.3048,
      'in': 12,
      'cm': 30.48
    }
  },
  volume: {
    units: ['gal', 'L', 'ft¬≥', 'm¬≥', 'MG'],
    conversions: {
      'gal': 1,
      'L': 3.78541,
      'ft¬≥': 0.133681,
      'm¬≥': 0.00378541,
      'MG': 0.000001
    }
  },
  conc: {
    units: ['mg/L', 'ppm', '%', 'lb/MG', 'g/L'],
    conversions: {
      'mg/L': 1,
      'ppm': 1,
      '%': 0.0001,
      'lb/MG': 8.34,
      'g/L': 0.001
    }
  }
};

function toggleUnitConverter() {
  const widget = document.getElementById('unitConverterWidget');
  widget.style.display = widget.style.display === 'none' ? 'block' : 'none';
  if (widget.style.display === 'block') updateUnitConverter();
}

function updateUnitConverter() {
  const type = document.getElementById('ucType').value;
  const config = unitConfigs[type];
  const fromSelect = document.getElementById('ucFrom');
  const toSelect = document.getElementById('ucTo');
  
  fromSelect.innerHTML = config.units.map((u, i) => `<option value="${u}" ${i===0?'selected':''}>${u}</option>`).join('');
  toSelect.innerHTML = config.units.map((u, i) => `<option value="${u}" ${i===1?'selected':''}>${u}</option>`).join('');
  
  convertUnits();
}

function convertUnits() {
  const type = document.getElementById('ucType').value;
  const config = unitConfigs[type];
  const input = parseFloat(document.getElementById('ucInput').value) || 0;
  const from = document.getElementById('ucFrom').value;
  const to = document.getElementById('ucTo').value;
  let result;
  let formula = '';

  if (type === 'temp') {
    // Temperature special handling
    if (from === '¬∞C' && to === '¬∞F') {
      result = (input * 9/5) + 32;
      formula = '¬∞F = (¬∞C √ó 9/5) + 32';
    } else if (from === '¬∞F' && to === '¬∞C') {
      result = (input - 32) * 5/9;
      formula = '¬∞C = (¬∞F - 32) √ó 5/9';
    } else if (from === '¬∞C' && to === 'K') {
      result = input + 273.15;
      formula = 'K = ¬∞C + 273.15';
    } else if (from === 'K' && to === '¬∞C') {
      result = input - 273.15;
      formula = '¬∞C = K - 273.15';
    } else if (from === '¬∞F' && to === 'K') {
      result = (input - 32) * 5/9 + 273.15;
      formula = 'K = (¬∞F - 32) √ó 5/9 + 273.15';
    } else if (from === 'K' && to === '¬∞F') {
      result = (input - 273.15) * 9/5 + 32;
      formula = '¬∞F = (K - 273.15) √ó 9/5 + 32';
    } else {
      result = input;
      formula = 'Same unit';
    }
  } else {
    // Standard conversion
    const baseValue = input / config.conversions[from];
    result = baseValue * config.conversions[to];
    formula = `${from} ‚Üí base ‚Üí ${to}`;
  }

  document.getElementById('ucOutput').value = result.toPrecision(6);
  document.getElementById('ucFormula').textContent = formula + (config.note ? ' | ' + config.note : '');
}

// ==================== 4. PDF EXPORT ====================
function exportToPDF() {
  document.getElementById('pdfModal').style.display = 'flex';
}

function closePDFModal() {
  document.getElementById('pdfModal').style.display = 'none';
}

function generatePDF() {
  const title = document.getElementById('pdfTitle').value || 'WWTP Report';
  const includeCalcs = document.getElementById('pdfCalcs').checked;
  const includeKPIs = document.getElementById('pdfKPIs').checked;
  const includeTimestamp = document.getElementById('pdfTimestamp').checked;
  const includeNotes = document.getElementById('pdfNotes').checked;
  const notes = document.getElementById('pdfNotesText').value;

  // Collect current panel data
  const activePanel = document.querySelector('.panel.active') || document.querySelector('.panel');
  const panelName = activePanel ? activePanel.id : 'Dashboard';

  // Collect all results from active panel
  const results = [];
  if (activePanel && includeCalcs) {
    activePanel.querySelectorAll('.result, [id^="r_"]').forEach(el => {
      const value = el.textContent.trim();
      if (value && value !== '-') {
        const row = el.closest('tr');
        const label = row ? row.querySelector('.rowh, td:first-child')?.textContent : el.id;
        const unit = row ? row.querySelector('td:last-child')?.textContent : '';
        results.push({ label: label || el.id, value, unit: unit || '' });
      }
    });
  }

  // Collect KPIs
  const kpis = [];
  if (includeKPIs) {
    document.querySelectorAll('.kpi-card').forEach(card => {
      const label = card.querySelector('h4')?.textContent || '';
      const value = card.querySelector('p')?.textContent || '';
      if (value && value !== '-') {
        kpis.push({ label, value });
      }
    });
  }

  // Generate HTML for print
  const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>WWTP Command Center v9.9.16</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 40px; color: #1a2744; }
        h1 { color: #023e8a; border-bottom: 3px solid #0077b6; padding-bottom: 10px; }
        h2 { color: #0077b6; margin-top: 30px; }
        .meta { color: #64748b; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #e0f2fe; padding: 10px; text-align: left; }
        th { background: #f0f9ff; color: #475569; }
        .value { font-weight: bold; color: #023e8a; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .kpi { background: #f8fafc; border: 1px solid #e0f2fe; border-radius: 8px; padding: 15px; text-align: center; }
        .kpi-label { font-size: 12px; color: #64748b; }
        .kpi-value { font-size: 24px; font-weight: bold; color: #023e8a; }
        .notes { background: #fefce8; border-left: 4px solid #ffd166; padding: 15px; margin: 20px 0; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e0f2fe; color: #94a3b8; font-size: 12px; }
        @media print { body { padding: 20px; } }
      </style>
    </head>
    <body>
      <h1>üìä ${title}</h1>
      <div class="meta">
        <strong>Panel:</strong> ${panelName.charAt(0).toUpperCase() + panelName.slice(1).replace(/-/g, ' ')}<br>
        ${includeTimestamp ? `<strong>Generated:</strong> ${new Date().toLocaleString()}<br>` : ''}
        <strong>App Version:</strong> v9.6.0
      </div>

      ${kpis.length > 0 ? `
        <h2>üìà Key Performance Indicators</h2>
        <div class="kpi-grid">
          ${kpis.slice(0, 8).map(k => `
            <div class="kpi">
              <div class="kpi-label">${k.label}</div>
              <div class="kpi-value">${k.value}</div>
            </div>
          `).join('')}
        </div>
      ` : ''}

      ${results.length > 0 ? `
        <h2>üî¨ Calculation Results</h2>
        <table>
          <thead>
            <tr><th>Parameter</th><th>Value</th><th>Unit</th></tr>
          </thead>
          <tbody>
            ${results.map(r => `
              <tr>
                <td>${r.label}</td>
                <td class="value">${r.value}</td>
                <td>${r.unit}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : '<p>No calculation results to display. Run calculations first.</p>'}

      ${includeNotes && notes ? `
        <h2>üìù Notes</h2>
        <div class="notes">${notes.replace(/\n/g, '<br>')}</div>
      ` : ''}

      <div class="footer">
        Generated by WWTP Command Center v8.0.0 | ${new Date().toLocaleDateString()}
      </div>
    </body>
    </html>
  `;

  // Open print window
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.onload = function() {
    printWindow.print();
  };

  closePDFModal();
  showToast('üìÑ PDF generated - use Print dialog to save', 'success');
}

// ==================== 5. OFFLINE MODE (SERVICE WORKER) ====================
const SW_CODE = `
const CACHE_NAME = 'wwtp-v9.9.16';
const ASSETS = ['/'];

self.addEventListener('install', e => {
  e.waitUntil(
    caches.open(CACHE_NAME).then(cache => {
      return cache.addAll(ASSETS);
    })
  );
  self.skipWaiting();
});

self.addEventListener('activate', e => {
  e.waitUntil(
    caches.keys().then(keys => {
      return Promise.all(
        keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))
      );
    })
  );
  self.clients.claim();
});

self.addEventListener('fetch', e => {
  e.respondWith(
    caches.match(e.request).then(cached => {
      return cached || fetch(e.request).then(response => {
        return caches.open(CACHE_NAME).then(cache => {
          cache.put(e.request, response.clone());
          return response;
        });
      });
    }).catch(() => {
      return new Response('<h1>Offline</h1><p>Please reconnect to the internet.</p>', {
        headers: { 'Content-Type': 'text/html' }
      });
    })
  );
});
`;

function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    const blob = new Blob([SW_CODE], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(blob);
    
    navigator.serviceWorker.register(swUrl, { scope: '/' })
      .then(reg => {
        console.log('‚úÖ Service Worker registered for offline mode');
      })
      .catch(err => {
        console.log('‚ö†Ô∏è Service Worker registration failed:', err.message);
        // Fallback: just use localStorage for offline data
      });
  }
}

// Online/Offline detection
function initOfflineDetection() {
  const indicator = document.getElementById('offlineIndicator');
  
  function updateOnlineStatus() {
    if (!navigator.onLine) {
      indicator.style.display = 'block';
      document.body.style.paddingTop = '40px';
    } else {
      indicator.style.display = 'none';
      document.body.style.paddingTop = '0';
    }
  }
  
  window.addEventListener('online', () => {
    updateOnlineStatus();
    showToast('üì∂ Back online!', 'success');
  });
  
  window.addEventListener('offline', () => {
    updateOnlineStatus();
    showToast('üì¥ Offline - data saved locally', 'warning');
  });
  
  updateOnlineStatus();
}

// ==================== FAB MENU ====================
let fabOpen = false;
function toggleFabMenu() {
  fabOpen = !fabOpen;
  const main = document.getElementById('fabMain');
  const buttons = ['fabUnitConv', 'fabPDF', 'fabTheme'];
  
  main.style.transform = fabOpen ? 'rotate(45deg)' : 'rotate(0deg)';
  
  buttons.forEach((id, i) => {
    const btn = document.getElementById(id);
    if (fabOpen) {
      setTimeout(() => {
        btn.style.display = 'flex';
        btn.style.opacity = '1';
        btn.style.transform = 'scale(1)';
      }, i * 50);
    } else {
      btn.style.opacity = '0';
      btn.style.transform = 'scale(0.5)';
      setTimeout(() => btn.style.display = 'none', 150);
    }
  });
}

// ==================== TOAST NOTIFICATION ====================
function showToast(message, type = 'info') {
  const colors = {
    info: '#0077b6',
    success: '#06d6a0',
    warning: '#ffd166',
    error: '#ef4444'
  };
  
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${colors[type]};
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    z-index: 3000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    animation: slideDown 0.3s ease;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideUp 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

// Add toast animations and mobile FAB positioning
const toastStyles = document.createElement('style');
toastStyles.textContent = `
  @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
  @keyframes slideUp { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(-20px); } }
  #fabUnitConv, #fabPDF, #fabTheme { opacity: 0; transform: scale(0.5); transition: all 0.15s ease; display: flex; align-items: center; justify-content: center; }
  #fabMain:hover, #fabUnitConv:hover, #fabPDF:hover, #fabTheme:hover { transform: scale(1.1); }
  @media(max-width:767px) {
    #fabMenu { bottom: 90px !important; right: 15px !important; }
    #unitConverterWidget { bottom: 160px !important; right: 15px !important; width: 290px !important; }
    #pdfModal > div { width: 95% !important; max-height: 90vh; overflow-y: auto; }
  }
`;
document.head.appendChild(toastStyles);

// ========== KEYBOARD SHORTCUTS ==========

var keyboardShortcutsEnabled = true;

document.addEventListener('keydown', function(e) {
  if (!keyboardShortcutsEnabled) return;
  
  // Don't trigger when typing in inputs
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
  
  // Ctrl/Cmd + key combinations
  if (e.ctrlKey || e.metaKey) {
    switch(e.key.toLowerCase()) {
      case 's':
        e.preventDefault();
        if (typeof saveAllData === 'function') saveAllData();
        showToast('üíæ Data saved', 'success');
        break;
      case 'p':
        e.preventDefault();
        switchPanel('profiles');
        break;
      case 'r':
        e.preventDefault();
        switchPanel('reports');
        break;
      case 'd':
        e.preventDefault();
        switchPanel('dashboard');
        break;
      case '/':
        e.preventDefault();
        showKeyboardHelp();
        break;
    }
    return;
  }
  
  // Single key shortcuts (when not in input)
  switch(e.key) {
    case '1':
      switchPanel('dashboard');
      break;
    case '2':
      switchPanel('daily-ops');
      break;
    case '3':
      switchPanel('process-control');
      break;
    case '4':
      switchPanel('wizards');
      break;
    case '5':
      switchPanel('reports');
      break;
    case '6':
      switchPanel('profiles');
      break;
    case '?':
      showKeyboardHelp();
      break;
    case 'Escape':
      closeAllModals();
      break;
  }
});

function showKeyboardHelp() {
  var helpHtml = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center" onclick="this.remove()">
      <div style="background:#1e3a5f;padding:30px;border-radius:16px;max-width:500px;color:white" onclick="event.stopPropagation()">
        <h3 style="margin:0 0 20px 0;color:#4ade80">‚å®Ô∏è Keyboard Shortcuts</h3>
        <div style="display:grid;grid-template-columns:auto 1fr;gap:10px 20px;font-size:14px">
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">1</kbd><span>Dashboard</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">2</kbd><span>Daily Operations</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">3</kbd><span>Process Control</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">4</kbd><span>Wizards</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">5</kbd><span>Reports</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">6</kbd><span>Profiles</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">Ctrl+S</kbd><span>Save All Data</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">Ctrl+D</kbd><span>Go to Dashboard</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">Ctrl+P</kbd><span>Go to Profiles</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">Ctrl+R</kbd><span>Go to Reports</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">?</kbd><span>Show this help</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">Esc</kbd><span>Close modals</span>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" style="margin-top:20px;background:#4ade80;color:#1e3a5f;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:bold">Got it!</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', helpHtml);
}

function closeAllModals() {
  // Close any open modals
  document.querySelectorAll('[style*="position:fixed"]').forEach(function(el) {
    if (el.style.zIndex > 9000) el.remove();
  });
  // Close alert panels
  var alertSettings = document.getElementById('alertSettings');
  var alertHistory = document.getElementById('alertHistory');
  if (alertSettings) alertSettings.style.display = 'none';
  if (alertHistory) alertHistory.style.display = 'none';
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  // Load saved theme
  loadThemePreference();
  
  // Load saved data
  setTimeout(loadAllData, 500);
  
  // Initialize auto-save
  initAutoSave();
  
  // Initialize unit converter
  updateUnitConverter();
  
  // Initialize offline detection
  initOfflineDetection();
  
  // Register service worker
  registerServiceWorker();
  
  // Sync Master Settings to all calculators
  setTimeout(function() {
    if (typeof syncMasterToAll === 'function') syncMasterToAll();
  }, 1000);
  
  // Show notes field toggle
  document.getElementById('pdfNotes')?.addEventListener('change', function() {
    document.getElementById('pdfNotesSection').style.display = this.checked ? 'block' : 'none';
  });
  
  // Check for first visit or version update
  checkFirstVisit();
  
  console.log('üöÄ WWTP Command Center v9.9.16 initialized with enhancements');
});

// First visit / tutorial
function checkFirstVisit() {
  var lastVersion = localStorage.getItem('wwtp_version');
  var currentVersion = '9.9.4';
  
  if (!lastVersion) {
    // First time user - show welcome
    setTimeout(showWelcomeTutorial, 1500);
  } else if (lastVersion !== currentVersion) {
    // Version update - show what's new
    setTimeout(showWhatsNew, 1500);
  }
  
  localStorage.setItem('wwtp_version', currentVersion);
}

function showWelcomeTutorial() {
  var html = `
    <div id="welcomeModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px">
      <div style="background:linear-gradient(135deg,#1e3a5f,#243b55);padding:30px;border-radius:20px;max-width:600px;color:white;text-align:center;animation:fadeIn 0.5s">
        <div style="font-size:60px;margin-bottom:15px">üè≠</div>
        <h2 style="margin:0 0 10px 0;color:#4ade80">Welcome to WWTP Command Center!</h2>
        <p style="opacity:0.9;margin-bottom:20px">Your comprehensive wastewater treatment analysis platform</p>
        
        <div style="text-align:left;background:rgba(0,0,0,0.3);padding:20px;border-radius:12px;margin-bottom:20px">
          <h4 style="color:#60a5fa;margin:0 0 15px 0">üöÄ Quick Start Guide:</h4>
          <div style="margin-bottom:12px"><span style="color:#4ade80">1.</span> Go to <strong>‚öôÔ∏è Process Control</strong> ‚Üí Set Master Settings</div>
          <div style="margin-bottom:12px"><span style="color:#4ade80">2.</span> Save your plant as a <strong>üè≠ Profile</strong></div>
          <div style="margin-bottom:12px"><span style="color:#4ade80">3.</span> Use <strong>üß≠ Wizards</strong> for troubleshooting</div>
          <div style="margin-bottom:12px"><span style="color:#4ade80">4.</span> Generate <strong>üìë Reports</strong> for clients</div>
          <div><span style="color:#4ade80">5.</span> Press <kbd style="background:#374151;padding:2px 6px;border-radius:4px">?</kbd> anytime for keyboard shortcuts</div>
        </div>
        
        <div style="display:flex;gap:10px;justify-content:center">
          <button onclick="document.getElementById('welcomeModal').remove();switchPanel('process-control')" style="background:#4ade80;color:#1e3a5f;border:none;padding:12px 24px;border-radius:10px;cursor:pointer;font-weight:bold;font-size:16px">üöÄ Get Started</button>
          <button onclick="document.getElementById('welcomeModal').remove()" style="background:#64748b;color:white;border:none;padding:12px 24px;border-radius:10px;cursor:pointer;font-weight:bold">Skip</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
}

function showWhatsNew() {
  var html = `
    <div id="whatsNewModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px">
      <div style="background:linear-gradient(135deg,#0f172a,#1e293b);padding:28px;border-radius:24px;max-width:720px;width:95%;color:white;animation:fadeIn 0.5s;max-height:92vh;overflow:hidden;display:flex;flex-direction:column;border:1px solid rgba(16,185,129,0.3);box-shadow:0 25px 80px rgba(16,185,129,0.25)">
        
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
          <div style="width:60px;height:60px;background:linear-gradient(135deg,#10b981,#3b82f6);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 8px 20px rgba(16,185,129,0.4)">üß≠</div>
          <div>
            <h2 style="margin:0;background:linear-gradient(135deg,#f8fafc,#cbd5e1);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:26px;font-weight:800">v9.9.27 NAVIGATION OVERHAUL</h2>
            <p style="opacity:0.7;margin:4px 0 0 0;font-size:13px">Section-Based Layout ‚Ä¢ Hydraulic Flow Order ‚Ä¢ Genius-Level Organization</p>
          </div>
        </div>
        
        <div style="text-align:left;overflow-y:auto;flex:1;padding-right:8px">
          
          <!-- NEW NAVIGATION -->
          <div style="background:linear-gradient(135deg,rgba(16,185,129,0.15),rgba(59,130,246,0.1));padding:16px;border-radius:12px;margin-bottom:16px;border:1px solid rgba(16,185,129,0.3)">
            <div style="font-weight:700;color:#4ade80;margin-bottom:12px;font-size:15px">üß≠ NEW: 3-Section Navigation</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div onclick="document.getElementById('whatsNewModal').remove();switchSection('executive')" style="flex:1;min-width:100px;background:linear-gradient(145deg,#1e3a5f,#172554);padding:14px;border-radius:10px;text-align:center;cursor:pointer;border:2px solid #3b82f6;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size:24px;margin-bottom:4px">üìä</div>
                <div style="font-size:12px;font-weight:700;color:#93c5fd">EXECUTIVE</div>
                <div style="font-size:9px;color:#64748b;margin-top:2px">Dashboard ‚Ä¢ Reports ‚Ä¢ Multi-Plant</div>
              </div>
              <div onclick="document.getElementById('whatsNewModal').remove();switchSection('operations')" style="flex:1;min-width:100px;background:linear-gradient(135deg,#10b981,#059669);padding:14px;border-radius:10px;text-align:center;cursor:pointer;border:2px solid #10b981;transition:all 0.2s;box-shadow:0 4px 12px rgba(16,185,129,0.3)" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size:24px;margin-bottom:4px">‚öôÔ∏è</div>
                <div style="font-size:12px;font-weight:700;color:white">OPERATIONS</div>
                <div style="font-size:9px;color:#d1fae5;margin-top:2px">12 Panels ‚Ä¢ Hydraulic Order</div>
              </div>
              <div onclick="document.getElementById('whatsNewModal').remove();switchSection('business')" style="flex:1;min-width:100px;background:linear-gradient(145deg,#78350f,#451a03);padding:14px;border-radius:10px;text-align:center;cursor:pointer;border:2px solid #f59e0b;transition:all 0.2s" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size:24px;margin-bottom:4px">üíº</div>
                <div style="font-size:12px;font-weight:700;color:#fcd34d">BUSINESS</div>
                <div style="font-size:9px;color:#a16207;margin-top:2px">Costs ‚Ä¢ Profiles ‚Ä¢ Wizards</div>
              </div>
            </div>
          </div>
          
          <!-- HYDRAULIC FLOW -->
          <div style="font-size:12px;font-weight:600;color:#94a3b8;margin:12px 0 10px 0;padding-bottom:6px;border-bottom:1px solid #334155">‚öôÔ∏è OPERATIONS - HYDRAULIC FLOW ORDER</div>
          
          <div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:12px;padding:14px;margin-bottom:16px;border:1px solid #374151">
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;font-size:11px">
              <span style="background:#10b981;color:white;padding:4px 8px;border-radius:6px;font-weight:600">Daily Ops</span>
              <span style="color:#475569">‚Üí</span>
              <span style="background:#0891b2;color:white;padding:4px 8px;border-radius:6px;font-weight:600">Hydraulics</span>
              <span style="color:#475569">‚Üí</span>
              <span style="background:#6366f1;color:white;padding:4px 8px;border-radius:6px;font-weight:600">Process</span>
              <span style="color:#475569">‚Üí</span>
              <span style="background:#8b5cf6;color:white;padding:4px 8px;border-radius:6px;font-weight:600">Aeration</span>
              <span style="color:#475569">‚Üí</span>
              <span style="background:#a855f7;color:white;padding:4px 8px;border-radius:6px;font-weight:600">Reactors</span>
              <span style="color:#475569">‚Üí</span>
              <span style="background:#ec4899;color:white;padding:4px 8px;border-radius:6px;font-weight:600">Chemicals</span>
              <span style="color:#475569">‚Üí</span>
              <span style="background:#f97316;color:white;padding:4px 8px;border-radius:6px;font-weight:600">Solids</span>
              <span style="color:#475569">‚Üí</span>
              <span style="background:#ef4444;color:white;padding:4px 8px;border-radius:6px;font-weight:600">Compliance</span>
            </div>
            <div style="margin-top:10px;font-size:11px;color:#64748b;text-align:center">
              <em>Follows treatment train: Influent ‚Üí Primary ‚Üí Secondary ‚Üí Chemical ‚Üí Effluent</em>
            </div>
          </div>
          
          <!-- KEY FEATURES -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">
            <div style="background:rgba(16,185,129,0.1);padding:12px;border-radius:10px;border-left:3px solid #10b981">
              <div style="font-size:12px;font-weight:600;color:#4ade80">üß≠ Smart Breadcrumb</div>
              <div style="font-size:10px;color:#94a3b8;margin-top:4px">Always know where you are: Section ‚Ä∫ Panel</div>
            </div>
            <div style="background:rgba(59,130,246,0.1);padding:12px;border-radius:10px;border-left:3px solid #3b82f6">
              <div style="font-size:12px;font-weight:600;color:#60a5fa">üì± Mobile Sections</div>
              <div style="font-size:10px;color:#94a3b8;margin-top:4px">Menu grouped by Executive / Operations / Business</div>
            </div>
            <div style="background:rgba(245,158,11,0.1);padding:12px;border-radius:10px;border-left:3px solid #f59e0b">
              <div style="font-size:12px;font-weight:600;color:#fbbf24">‚ö° Quick Nav Preserved</div>
              <div style="font-size:10px;color:#94a3b8;margin-top:4px">Your 4-button shortcuts still work</div>
            </div>
            <div style="background:rgba(139,92,246,0.1);padding:12px;border-radius:10px;border-left:3px solid #8b5cf6">
              <div style="font-size:12px;font-weight:600;color:#a78bfa">üéØ Logical Grouping</div>
              <div style="font-size:10px;color:#94a3b8;margin-top:4px">Find what you need faster</div>
            </div>
          </div>
          
          <!-- INCLUDED FROM PREVIOUS -->
          <div style="font-size:12px;font-weight:600;color:#94a3b8;margin:12px 0 10px 0;padding-bottom:6px;border-bottom:1px solid #334155">ALSO INCLUDED: TRAINING & SAFETY (v9.9.25-26)</div>
          
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div onclick="document.getElementById('whatsNewModal').remove();switchPanel('panel-training');showTrainingSection('safety')" style="background:rgba(220,38,38,0.1);padding:10px;border-radius:8px;border-left:3px solid #dc2626;cursor:pointer" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
              <div style="font-size:12px;font-weight:600;color:#fca5a5">‚ö†Ô∏è Safety Center</div>
              <div style="font-size:10px;color:#94a3b8">8 OSHA-compliant topics</div>
            </div>
            <div onclick="document.getElementById('whatsNewModal').remove();switchPanel('panel-training');showTrainingSection('videos')" style="background:rgba(124,58,237,0.1);padding:10px;border-radius:8px;border-left:3px solid #7c3aed;cursor:pointer" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
              <div style="font-size:12px;font-weight:600;color:#c4b5fd">üé¨ Video Library</div>
              <div style="font-size:10px;color:#94a3b8">70+ curated videos</div>
            </div>
          </div>
          
        </div>
        
        <div style="margin-top:14px;padding:12px;background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(59,130,246,0.15));border-radius:10px;font-size:12px;border:1px solid rgba(16,185,129,0.3)">
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:18px">üìç</span>
            <strong>New: Section selector at top ‚Ä¢ Breadcrumb navigation ‚Ä¢ Hydraulic flow tabs</strong>
          </div>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:14px">
          <button onclick="document.getElementById('whatsNewModal').remove()" style="flex:1;background:linear-gradient(135deg,#10b981,#059669);color:white;border:none;padding:14px 20px;border-radius:12px;cursor:pointer;font-weight:bold;font-size:14px;box-shadow:0 4px 15px rgba(16,185,129,0.3)">‚ú® Got It!</button>
          <button onclick="document.getElementById('whatsNewModal').remove();switchSection('operations')" style="flex:1;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;border:none;padding:14px 20px;border-radius:12px;cursor:pointer;font-weight:bold;font-size:14px;box-shadow:0 4px 15px rgba(59,130,246,0.3)">‚öôÔ∏è Explore Operations</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
}


// PDF Generator Functions
function saveBrandingSettings(){
  localStorage.setItem('wwtp_branding',JSON.stringify({
    company:document.getElementById('pdf_company')?.value||'',
    consultant:document.getElementById('pdf_consultant')?.value||'',
    phone:document.getElementById('pdf_phone')?.value||'',
    email:document.getElementById('pdf_email')?.value||''
  }));
  alert('Branding saved!');
}
function loadBrandingSettings(){
  var s=localStorage.getItem('wwtp_branding');
  if(s){var b=JSON.parse(s);
    document.getElementById('pdf_company').value=b.company||'';
    document.getElementById('pdf_consultant').value=b.consultant||'';
    document.getElementById('pdf_phone').value=b.phone||'';
    document.getElementById('pdf_email').value=b.email||'';
    alert('Branding loaded!');
  }
}
function generateProfessionalPDF(preview){
  var c=document.getElementById('pdf_company')?.value||'WWTP Consulting';
  var p=document.getElementById('pdf_plant')?.value||'Treatment Plant';
  var d=document.getElementById('pdf_date')?.value||new Date().toLocaleDateString();
  var h='<!DOCTYPE html><html><head><style>body{font-family:Arial;margin:40px}'+
    '.header{background:linear-gradient(135deg,#0077b6,#023e8a);color:white;padding:30px;border-radius:8px}'+
    'table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #ddd;padding:12px}'+
    'th{background:#0077b6;color:white}.good{color:#059669}</style></head><body>'+
    '<div class="header"><h1>'+c+'</h1><h2>Operations Report</h2></div>'+
    '<p><strong>Facility:</strong> '+p+'<br><strong>Date:</strong> '+d+'</p>'+
    '<h3>Process Parameters</h3><table><tr><th>Parameter</th><th>Value</th><th>Status</th></tr>'+
    '<tr><td>Flow Rate</td><td>3.5 MGD</td><td class="good">Normal</td></tr>'+
    '<tr><td>DO Level</td><td>2.1 mg/L</td><td class="good">Normal</td></tr>'+
    '<tr><td>MLSS</td><td>3,200 mg/L</td><td class="good">Normal</td></tr></table>'+
    '<h3>Compliance Status</h3><table><tr><th>Parameter</th><th>Result</th><th>Limit</th><th>Status</th></tr>'+
    '<tr><td>BOD</td><td>12 mg/L</td><td>30 mg/L</td><td class="good">Compliant</td></tr>'+
    '<tr><td>TSS</td><td>15 mg/L</td><td>30 mg/L</td><td class="good">Compliant</td></tr></table>'+
    '<p style="margin-top:40px;font-size:12px;color:#666">Generated by WWTP Command Center v9.9.16</p></body></html>';
  var w=window.open('','_blank');w.document.write(h);w.document.close();
  if(!preview)setTimeout(function(){w.print();},500);
}

// ==================== v9.6.0 ENHANCEMENT FUNCTIONS ====================

// ==================== TIME TRACKING ====================
let timerInterval = null;
let timerSeconds = 0;
let timerRunning = false;
let timeEntries = JSON.parse(localStorage.getItem('wwtp_time_entries') || '[]');

function startTimer() {
  if (timerRunning) return;
  
  const client = document.getElementById('timer_client')?.value;
  const task = document.getElementById('timer_task')?.value;
  
  if (!task) {
    showToast('Please enter a task description', 'warning');
    return;
  }
  
  timerRunning = true;
  document.getElementById('timer_start').style.display = 'none';
  document.getElementById('timer_pause').style.display = 'inline-block';
  document.getElementById('timer_stop').style.display = 'inline-block';
  
  timerInterval = setInterval(() => {
    timerSeconds++;
    updateTimerDisplay();
  }, 1000);
  
  showToast('‚è±Ô∏è Timer started', 'success');
}

function pauseTimer() {
  if (!timerRunning) return;
  
  timerRunning = false;
  clearInterval(timerInterval);
  
  document.getElementById('timer_pause').textContent = '‚ñ∂ Resume';
  document.getElementById('timer_pause').onclick = resumeTimer;
  
  showToast('‚è∏Ô∏è Timer paused', 'info');
}

function resumeTimer() {
  timerRunning = true;
  timerInterval = setInterval(() => {
    timerSeconds++;
    updateTimerDisplay();
  }, 1000);
  
  document.getElementById('timer_pause').textContent = '‚è∏ Pause';
  document.getElementById('timer_pause').onclick = pauseTimer;
  
  showToast('‚ñ∂ Timer resumed', 'info');
}

function stopTimer() {
  clearInterval(timerInterval);
  timerRunning = false;
  
  const hours = (timerSeconds / 3600).toFixed(2);
  const client = document.getElementById('timer_client')?.value || 'Unassigned';
  const project = document.getElementById('timer_project')?.value || '';
  const task = document.getElementById('timer_task')?.value || 'General';
  const type = document.getElementById('timer_type')?.value || 'consulting';
  
  const entry = {
    id: Date.now(),
    date: new Date().toISOString(),
    client: client,
    project: project,
    task: task,
    type: type,
    hours: parseFloat(hours),
    seconds: timerSeconds,
    rate: 150,
    billed: false
  };
  
  timeEntries.unshift(entry);
  saveTimeEntries();
  updateTimeStats();
  renderTimeEntries();
  
  // Reset timer
  timerSeconds = 0;
  updateTimerDisplay();
  document.getElementById('timer_start').style.display = 'inline-block';
  document.getElementById('timer_pause').style.display = 'none';
  document.getElementById('timer_stop').style.display = 'none';
  document.getElementById('timer_task').value = '';
  
  showToast(`‚è±Ô∏è ${hours} hours logged`, 'success');
}

function updateTimerDisplay() {
  const hours = Math.floor(timerSeconds / 3600);
  const minutes = Math.floor((timerSeconds % 3600) / 60);
  const seconds = timerSeconds % 60;
  
  const display = [
    hours.toString().padStart(2, '0'),
    minutes.toString().padStart(2, '0'),
    seconds.toString().padStart(2, '0')
  ].join(':');
  
  document.getElementById('timer_display').textContent = display;
}

function addManualTime() {
  const date = document.getElementById('manual_date')?.value || new Date().toISOString().split('T')[0];
  const hours = parseFloat(document.getElementById('manual_hours')?.value || 1);
  const rate = parseFloat(document.getElementById('manual_rate')?.value || 150);
  const desc = document.getElementById('manual_desc')?.value || '';
  const client = document.getElementById('timer_client')?.value || 'Unassigned';
  
  if (!desc) {
    showToast('Please enter a description', 'warning');
    return;
  }
  
  const entry = {
    id: Date.now(),
    date: new Date(date).toISOString(),
    client: client,
    project: '',
    task: desc,
    type: 'manual',
    hours: hours,
    seconds: hours * 3600,
    rate: rate,
    billed: false
  };
  
  timeEntries.unshift(entry);
  saveTimeEntries();
  updateTimeStats();
  renderTimeEntries();
  clearTimeForm();
  
  showToast(`‚ûï ${hours} hours added`, 'success');
}

function clearTimeForm() {
  document.getElementById('manual_desc').value = '';
  document.getElementById('manual_hours').value = '1.0';
}

function saveTimeEntries() {
  localStorage.setItem('wwtp_time_entries', JSON.stringify(timeEntries));
}

function updateTimeStats() {
  const now = new Date();
  const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
  weekStart.setHours(0, 0, 0, 0);
  
  const weekEntries = timeEntries.filter(e => new Date(e.date) >= weekStart);
  
  const totalHours = timeEntries.reduce((sum, e) => sum + e.hours, 0);
  const billableHours = timeEntries.filter(e => !e.billed).reduce((sum, e) => sum + e.hours, 0);
  const unbilled = timeEntries.filter(e => !e.billed).reduce((sum, e) => sum + (e.hours * e.rate), 0);
  
  document.getElementById('time_total_hours').textContent = totalHours.toFixed(1);
  document.getElementById('time_billable_hours').textContent = billableHours.toFixed(1);
  document.getElementById('time_unbilled').textContent = '$' + unbilled.toLocaleString();
  document.getElementById('time_avg_daily').textContent = (totalHours / 7).toFixed(1);
  
  // Update weekly display
  const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
  days.forEach(day => {
    document.getElementById('week_' + day).textContent = '0';
  });
  
  weekEntries.forEach(entry => {
    const dayIndex = new Date(entry.date).getDay();
    const dayId = 'week_' + days[dayIndex];
    const el = document.getElementById(dayId);
    if (el) {
      el.textContent = (parseFloat(el.textContent) + entry.hours).toFixed(1);
    }
  });
}

function renderTimeEntries() {
  const container = document.getElementById('time_entries_list');
  if (!container) return;
  
  if (timeEntries.length === 0) {
    container.innerHTML = '<div class="note">No time entries yet. Start the timer or add manual entries above.</div>';
    return;
  }
  
  const html = timeEntries.slice(0, 20).map(entry => `
    <div class="time-entry">
      <div class="time-entry-hours">${entry.hours.toFixed(2)}h</div>
      <div style="flex:1">
        <div style="font-weight:600;color:var(--text-accent)">${entry.task}</div>
        <div style="font-size:12px;color:var(--text-unit)">${entry.client} ‚Ä¢ ${new Date(entry.date).toLocaleDateString()}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:600;color:${entry.billed ? 'var(--ok)' : 'var(--warn)'}">$${(entry.hours * entry.rate).toFixed(0)}</div>
        <div style="font-size:11px;color:var(--text-unit)">${entry.billed ? '‚úì Billed' : 'Unbilled'}</div>
      </div>
      <button onclick="deleteTimeEntry(${entry.id})" style="background:none;border:none;color:var(--bad);cursor:pointer;font-size:18px">√ó</button>
    </div>
  `).join('');
  
  container.innerHTML = html;
}

function deleteTimeEntry(id) {
  if (confirm('Delete this time entry?')) {
    timeEntries = timeEntries.filter(e => e.id !== id);
    saveTimeEntries();
    updateTimeStats();
    renderTimeEntries();
    showToast('Entry deleted', 'info');
  }
}

function filterTimeLog() {
  // Implement time log filtering
  showToast('Filtering time log...', 'info');
  renderTimeEntries();
}

function exportTimeLog() {
  const csv = ['Date,Client,Project,Task,Hours,Rate,Amount,Status'];
  timeEntries.forEach(e => {
    csv.push(`${new Date(e.date).toLocaleDateString()},${e.client},${e.project},${e.task},${e.hours},${e.rate},${e.hours * e.rate},${e.billed ? 'Billed' : 'Unbilled'}`);
  });
  
  const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'time_log_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  
  showToast('üì§ Time log exported', 'success');
}

function generateTimesheet() {
  showToast('üìÑ Generating timesheet...', 'info');
  // Would generate a professional timesheet PDF
  setTimeout(() => showToast('Timesheet generated!', 'success'), 1000);
}

function generateInvoice() {
  const unbilledEntries = timeEntries.filter(e => !e.billed);
  if (unbilledEntries.length === 0) {
    showToast('No unbilled entries', 'warning');
    return;
  }
  
  showToast('üí∞ Generating invoice...', 'info');
  setTimeout(() => showToast('Invoice generated!', 'success'), 1000);
}

// ==================== ENHANCED HEADER FUNCTIONS v9.9.16 ====================
function toggleSettingsMenu() {
  var menu = document.getElementById('settingsMenu');
  if (menu) {
    menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  }
}

// Close settings menu when clicking outside
document.addEventListener('click', function(e) {
  var dropdown = document.getElementById('settingsDropdown');
  var menu = document.getElementById('settingsMenu');
  if (dropdown && menu && !dropdown.contains(e.target)) {
    menu.style.display = 'none';
  }
});

function showNotifications() {
  var notifications = [
    { type: 'warning', title: 'PM Due Soon', msg: 'Blower #1 maintenance due in 5 days', time: '2 hours ago' },
    { type: 'info', title: 'Data Synced', msg: 'All plant data synchronized successfully', time: '4 hours ago' },
    { type: 'success', title: 'Report Generated', msg: 'Monthly compliance report ready', time: '1 day ago' }
  ];
  
  var html = '<div style="max-height:400px;overflow-y:auto">';
  
  if (notifications.length === 0) {
    html += '<div style="text-align:center;padding:30px;color:#64748b">No notifications</div>';
  } else {
    notifications.forEach(function(n) {
      var color = n.type === 'warning' ? '#f59e0b' : (n.type === 'success' ? '#22c55e' : '#3b82f6');
      var icon = n.type === 'warning' ? '‚ö†Ô∏è' : (n.type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è');
      html += '<div style="padding:15px;background:#1e293b;border-radius:8px;margin-bottom:10px;border-left:4px solid ' + color + '">' +
        '<div style="display:flex;justify-content:space-between;align-items:center">' +
        '<strong style="color:#e2e8f0">' + icon + ' ' + n.title + '</strong>' +
        '<span style="font-size:11px;color:#64748b">' + n.time + '</span>' +
        '</div>' +
        '<div style="font-size:13px;color:#94a3b8;margin-top:6px">' + n.msg + '</div>' +
        '</div>';
    });
  }
  
  html += '</div>';
  html += '<div style="margin-top:15px;text-align:center">' +
    '<button onclick="this.closest(\'.modal-overlay\').remove()" class="btn" style="background:#374151;color:#e2e8f0">Close</button>' +
    '</div>';
  
  showModal('üîî Notifications', html);
}

function updateHeaderOnlineStatus(online) {
  var statusEl = document.getElementById('headerOnlineStatus');
  if (statusEl) {
    if (online) {
      statusEl.innerHTML = '<span style="width:8px;height:8px;background:#10b981;border-radius:50%;animation:statusPulse 2s infinite;box-shadow:0 0 8px #10b981"></span><span>Online</span>';
      statusEl.style.background = 'rgba(16,185,129,0.15)';
      statusEl.style.borderColor = 'rgba(16,185,129,0.3)';
      statusEl.style.color = '#34d399';
    } else {
      statusEl.innerHTML = '<span style="width:8px;height:8px;background:#ef4444;border-radius:50%"></span><span>Offline</span>';
      statusEl.style.background = 'rgba(239,68,68,0.15)';
      statusEl.style.borderColor = 'rgba(239,68,68,0.3)';
      statusEl.style.color = '#f87171';
    }
  }
}

// Listen for online/offline events for header
window.addEventListener('online', function() { updateHeaderOnlineStatus(true); });
window.addEventListener('offline', function() { updateHeaderOnlineStatus(false); });

function toggleTimeTracker() {
  switchPanel('business');
  setTimeout(() => showBusinessSection('timetracking'), 100);
  showToast('‚è±Ô∏è Time Tracker opened', 'info');
}

// ==================== CLIENT PORTAL MODE ====================
let portalActive = false;

function toggleClientPortal() {
  portalActive = !portalActive;
  
  if (portalActive) {
    showClientPortal();
  } else {
    closeClientPortal();
  }
}

function showClientPortal() {
  const portalHTML = `
    <div class="portal-mode" id="clientPortal">
      <div class="portal-header">
        <div class="portal-logo">üè≠</div>
        <h1 style="margin:0;font-size:20px">Client Portal</h1>
        <p style="opacity:0.9;margin:10px 0 0 0">Wastewater Treatment Performance Dashboard</p>
        <button onclick="closeClientPortal()" style="position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.2);border:none;color:white;padding:10px 20px;border-radius:8px;cursor:pointer">‚Üê Exit Portal</button>
      </div>
      
      <div style="max-width:1200px;margin:0 auto;padding:20px">
        <!-- Status Overview -->
        <div class="portal-card">
          <h3 style="margin:0 0 20px 0;color:var(--text-accent)">üìä Plant Status Overview</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
            <div class="portal-stat">
              <div class="portal-stat-value">‚úì</div>
              <div class="portal-stat-label">Compliance Status</div>
            </div>
            <div class="portal-stat">
              <div class="portal-stat-value">3.5</div>
              <div class="portal-stat-label">Flow (MGD)</div>
            </div>
            <div class="portal-stat">
              <div class="portal-stat-value">97%</div>
              <div class="portal-stat-label">Efficiency</div>
            </div>
            <div class="portal-stat">
              <div class="portal-stat-value">0</div>
              <div class="portal-stat-label">Active Alerts</div>
            </div>
          </div>
        </div>
        
        <!-- Compliance Summary -->
        <div class="portal-card">
          <h3 style="margin:0 0 20px 0;color:var(--text-accent)">üìã Compliance Summary</h3>
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="background:var(--bg-section)">
                <th style="padding:12px;text-align:left">Parameter</th>
                <th style="padding:12px;text-align:center">Result</th>
                <th style="padding:12px;text-align:center">Limit</th>
                <th style="padding:12px;text-align:center">Status</th>
              </tr>
            </thead>
            <tbody>
              <tr><td style="padding:12px">BOD</td><td style="text-align:center">12 mg/L</td><td style="text-align:center">30 mg/L</td><td style="text-align:center;color:#06d6a0">‚úì Pass</td></tr>
              <tr><td style="padding:12px">TSS</td><td style="text-align:center">15 mg/L</td><td style="text-align:center">30 mg/L</td><td style="text-align:center;color:#06d6a0">‚úì Pass</td></tr>
              <tr><td style="padding:12px">NH3-N</td><td style="text-align:center">1.2 mg/L</td><td style="text-align:center">3.0 mg/L</td><td style="text-align:center;color:#06d6a0">‚úì Pass</td></tr>
              <tr><td style="padding:12px">E. coli</td><td style="text-align:center">45 CFU</td><td style="text-align:center">126 CFU</td><td style="text-align:center;color:#06d6a0">‚úì Pass</td></tr>
            </tbody>
          </table>
        </div>
        
        <!-- Recent Activity -->
        <div class="portal-card">
          <h3 style="margin:0 0 20px 0;color:var(--text-accent)">üìÖ Recent Activity</h3>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="padding:15px;background:var(--bg-section);border-radius:8px;border-left:4px solid var(--ok)">
              <strong>Site Visit Completed</strong>
              <p style="margin:5px 0 0 0;color:var(--text-unit);font-size:14px">Process evaluation and operator training - Dec 10, 2024</p>
            </div>
            <div style="padding:15px;background:var(--bg-section);border-radius:8px;border-left:4px solid var(--info)">
              <strong>Monthly Report Submitted</strong>
              <p style="margin:5px 0 0 0;color:var(--text-unit);font-size:14px">November 2024 DMR submitted to TCEQ - Dec 5, 2024</p>
            </div>
            <div style="padding:15px;background:var(--bg-section);border-radius:8px;border-left:4px solid var(--ok)">
              <strong>Energy Audit Completed</strong>
              <p style="margin:5px 0 0 0;color:var(--text-unit);font-size:14px">Identified $3,200/month potential savings - Nov 28, 2024</p>
            </div>
          </div>
        </div>
        
        <!-- Contact -->
        <div class="portal-card" style="text-align:center">
          <h3 style="margin:0 0 15px 0;color:var(--text-accent)">üìû Contact Your Consultant</h3>
          <p style="color:var(--text-unit)">For questions or support, reach out anytime</p>
          <div style="display:flex;gap:15px;justify-content:center;margin-top:15px">
            <button class="btn gradient" onclick="showToast('Opening email...', 'info')">üìß Email</button>
            <button class="btn blue" onclick="showToast('Scheduling call...', 'info')">üìÖ Schedule Call</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', portalHTML);
  document.getElementById('portalBtn').classList.add('active');
  showToast('üëÅÔ∏è Client Portal Mode activated', 'success');
}

function closeClientPortal() {
  const portal = document.getElementById('clientPortal');
  if (portal) {
    portal.remove();
  }
  portalActive = false;
  document.getElementById('portalBtn').classList.remove('active');
  showToast('Client Portal closed', 'info');
}

// ==================== AI ENHANCEMENT ====================
function runAIAnalysis(type) {
  showToast('ü§ñ Running AI analysis...', 'info');
  
  // Show loading state
  const results = document.getElementById('ai_results');
  results.innerHTML = '<div class="ai-suggestion"><div class="ai-suggestion-title">üîÑ Analyzing...</div><p style="color:white;opacity:0.9">Processing plant data and generating insights...</p></div>';
  
  setTimeout(() => {
    let suggestions = [];
    
    if (type === 'process') {
      suggestions = [
        { title: 'üí° F/M Ratio Optimization', confidence: 92, text: 'Current F/M of 0.35 is within optimal range. Consider slight increase to 0.38 for improved settling.' },
        { title: 'üîÑ SRT Adjustment', confidence: 87, text: 'SRT of 12 days is adequate. During winter, extend to 15 days to maintain nitrification.' },
        { title: 'üìä MLSS Management', confidence: 94, text: 'MLSS at 3,200 mg/L is optimal. Maintain WAS rate to keep within 2,800-3,500 mg/L range.' }
      ];
    } else if (type === 'energy') {
      suggestions = [
        { title: '‚ö° Blower Optimization', confidence: 89, text: 'DO levels averaging 2.8 mg/L - reduce to 2.0 mg/L setpoint. Potential savings: $2,100/month.' },
        { title: 'üåô Off-Peak Operation', confidence: 85, text: 'Shift non-critical loads to off-peak hours (10PM-6AM). Estimated savings: $850/month.' },
        { title: 'üîß VFD Installation', confidence: 91, text: 'Installing VFDs on RAS pumps could reduce energy by 25%. ROI: 18 months.' }
      ];
    } else if (type === 'compliance') {
      suggestions = [
        { title: '‚úÖ Permit Status', confidence: 98, text: 'All parameters within permit limits. Current compliance rate: 100%.' },
        { title: 'üìã DMR Reminder', confidence: 100, text: 'December DMR due by January 28th. All data collection on track.' },
        { title: '‚ö†Ô∏è Upcoming Permit Renewal', confidence: 95, text: 'TPDES permit expires March 2025. Begin renewal process by January 2025.' }
      ];
    } else if (type === 'troubleshoot') {
      suggestions = [
        { title: 'üîç Potential Issue Detected', confidence: 78, text: 'SVI trending upward (from 120 to 145). Monitor for filamentous bulking.' },
        { title: 'üí° Recommended Action', confidence: 85, text: 'Increase RAS chlorination to 2-3 mg/L or adjust nutrient ratios (BOD:N:P).' },
        { title: 'üìà Trend Analysis', confidence: 82, text: 'Effluent TSS showing slight upward trend. Check secondary clarifier performance.' }
      ];
    }
    
    const html = suggestions.map((s, i) => `
      <div class="ai-suggestion" id="ai_suggestion_${i}" style="display:block">
        <div class="ai-suggestion-title">
          ${s.title}
          <span class="ai-confidence">${s.confidence}% Confidence</span>
        </div>
        <p style="color:white;opacity:0.9">${s.text}</p>
      </div>
    `).join('');
    
    results.innerHTML = html;
    showToast('‚úÖ AI analysis complete', 'success');
  }, 1500);
}

function showAITool(tool) {
  let title = '';
  let content = '';
  
  if (tool === 'report-writer') {
    title = 'üìù AI Report Writer';
    content = `
      <div class="input-group"><label>Report Type</label>
        <select id="ai_report_type">
          <option value="daily">Daily Operations Summary</option>
          <option value="monthly">Monthly Performance Report</option>
          <option value="compliance">Compliance Assessment</option>
          <option value="troubleshoot">Troubleshooting Report</option>
        </select>
      </div>
      <div class="input-group"><label>Additional Notes</label>
        <textarea id="ai_report_notes" rows="3" placeholder="Any specific items to include..."></textarea>
      </div>
      <div class="btns">
        <button class="btn gradient" onclick="generateAIReport()">ü§ñ Generate Report</button>
      </div>
    `;
  } else if (tool === 'troubleshoot') {
    title = 'üîç Smart Troubleshooter';
    content = `
      <div class="input-group"><label>What issue are you experiencing?</label>
        <select id="ai_issue_type">
          <option value="">Select issue type...</option>
          <option value="settling">Poor settling / High SVI</option>
          <option value="foam">Excessive foaming</option>
          <option value="odor">Odor issues</option>
          <option value="effluent">High effluent BOD/TSS</option>
          <option value="nitrification">Nitrification problems</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="input-group"><label>Describe the symptoms</label>
        <textarea id="ai_symptoms" rows="3" placeholder="Describe what you're observing..."></textarea>
      </div>
      <div class="btns">
        <button class="btn gradient" onclick="diagnoseIssue()">üîç Diagnose</button>
      </div>
    `;
  } else if (tool === 'optimizer') {
    title = 'üìà Process Optimizer';
    content = `
      <p style="color:var(--text-unit);margin-bottom:15px">The optimizer will analyze current conditions and suggest optimal setpoints.</p>
      <div class="kpi-grid" style="margin-bottom:15px">
        <div class="kpi-card"><h4>Current F/M</h4><p>0.35</p></div>
        <div class="kpi-card"><h4>Optimal F/M</h4><p>0.32-0.38</p></div>
        <div class="kpi-card"><h4>Current DO</h4><p>2.1</p></div>
        <div class="kpi-card"><h4>Optimal DO</h4><p>1.5-2.0</p></div>
      </div>
      <div class="btns">
        <button class="btn gradient" onclick="runFullOptimization()">‚ö° Run Full Optimization</button>
      </div>
    `;
  } else if (tool === 'compliance') {
    title = '‚úÖ Compliance Advisor';
    content = `
      <div class="note success" style="margin-bottom:15px">All parameters currently within permit limits</div>
      <div class="input-group"><label>What do you need help with?</label>
        <select id="ai_compliance_topic">
          <option value="dmr">DMR Preparation</option>
          <option value="permit">Permit Interpretation</option>
          <option value="exceedance">Handling Exceedances</option>
          <option value="reporting">Reporting Requirements</option>
        </select>
      </div>
      <div class="btns">
        <button class="btn gradient" onclick="getComplianceAdvice()">üìã Get Guidance</button>
      </div>
    `;
  }
  
  showModal(title, content);
}

function sendAIMessage() {
  const input = document.getElementById('ai_chat_input');
  const message = input.value.trim();
  
  if (!message) return;
  
  const messagesContainer = document.getElementById('ai_chat_messages');
  
  // Add user message
  messagesContainer.innerHTML += `<div class="ai-message user">${message}</div>`;
  input.value = '';
  
  // Show thinking indicator
  document.getElementById('ai_thinking').classList.add('active');
  
  // Scroll to bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  // Simulate AI response
  setTimeout(() => {
    document.getElementById('ai_thinking').classList.remove('active');
    
    let response = generateAIResponse(message);
    messagesContainer.innerHTML += `<div class="ai-message assistant">${response}</div>`;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }, 1500);
}

// generateAIResponse moved to main AI section (line ~13933)

function generateAIReport() {
  showToast('üìù Generating AI report...', 'info');
  setTimeout(() => {
    closeModal();
    showToast('‚úÖ Report generated!', 'success');
  }, 2000);
}

function diagnoseIssue() {
  showToast('üîç Analyzing issue...', 'info');
  setTimeout(() => {
    closeModal();
    runAIAnalysis('troubleshoot');
  }, 1500);
}

function runFullOptimization() {
  showToast('‚ö° Running optimization...', 'info');
  setTimeout(() => {
    closeModal();
    runAIAnalysis('process');
  }, 1500);
}

function getComplianceAdvice() {
  showToast('üìã Generating guidance...', 'info');
  setTimeout(() => {
    closeModal();
    runAIAnalysis('compliance');
  }, 1500);
}

// ==================== ENHANCED OFFLINE MODE ====================
let isOffline = false;
let pendingSync = [];

function enhancedOfflineInit() {
  // Create offline indicator
  if (!document.getElementById('offlineIndicator')) {
    const indicator = document.createElement('div');
    indicator.id = 'offlineIndicator';
    indicator.className = 'offline-indicator';
    indicator.innerHTML = 'üì¥ You are offline - Changes will sync when connection is restored';
    document.body.prepend(indicator);
  }
  
  // Enhanced online/offline handlers
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  
  // Check initial status
  if (!navigator.onLine) {
    handleOffline();
  }
}

function handleOnline() {
  isOffline = false;
  document.getElementById('offlineIndicator').classList.remove('visible');
  showToast('üì∂ Back online!', 'success');
  
  // Sync pending data
  if (pendingSync.length > 0) {
    syncPendingData();
  }
}

function handleOffline() {
  isOffline = true;
  document.getElementById('offlineIndicator').classList.add('visible');
  showToast('üì¥ Working offline - Data saved locally', 'warning');
}

function syncPendingData() {
  showToast('üîÑ Syncing pending data...', 'info');
  // Implement actual sync logic here
  setTimeout(() => {
    pendingSync = [];
    showToast('‚úÖ All data synced', 'success');
  }, 2000);
}

function queueForSync(data) {
  pendingSync.push({
    timestamp: new Date().toISOString(),
    data: data
  });
  localStorage.setItem('wwtp_pending_sync', JSON.stringify(pendingSync));
}

// ==================== ENHANCED PROPOSAL GENERATOR ====================
function generateProposalPreview() {
  const client = document.getElementById('prop_client')?.value || 'Client Name';
  const project = document.getElementById('prop_project')?.value || 'Project Name';
  const facility = document.getElementById('prop_facility')?.value || 'Facility';
  const date = document.getElementById('prop_date')?.value || new Date().toLocaleDateString();
  const propNum = document.getElementById('prop_number')?.value || 'PROP-2025-001';
  
  // Calculate totals from selected services
  let services = [];
  let total = 0;
  
  const serviceMap = {
    'svc_assessment': { name: 'Process Assessment & Evaluation', id: 'price_assessment' },
    'svc_compliance': { name: 'Compliance Review & Support', id: 'price_compliance' },
    'svc_training': { name: 'Operator Training (On-site)', id: 'price_training' },
    'svc_energy': { name: 'Energy Optimization Study', id: 'price_energy' },
    'svc_capacity': { name: 'Capacity Analysis & Planning', id: 'price_capacity' }
  };
  
  Object.keys(serviceMap).forEach(key => {
    const checkbox = document.getElementById(key);
    if (checkbox && checkbox.checked) {
      const price = parseFloat(document.getElementById(serviceMap[key].id)?.value || 0);
      services.push({ name: serviceMap[key].name, price: price });
      total += price;
    }
  });
  
  const html = `
    <div class="proposal-preview">
      <div class="proposal-header-logo">
        <h1 style="margin:0;color:#0077b6">Frazier Environmental Consulting</h1>
        <p style="margin:5px 0;color:#64748b">Professional Wastewater Treatment Services</p>
      </div>
      
      <h2 style="color:#023e8a">Service Proposal</h2>
      <p><strong>Proposal #:</strong> ${propNum}<br>
      <strong>Date:</strong> ${date}<br>
      <strong>Client:</strong> ${client}<br>
      <strong>Project:</strong> ${project}<br>
      <strong>Facility:</strong> ${facility}</p>
      
      <div class="proposal-section-title">Scope of Services</div>
      <table class="proposal-table">
        <thead>
          <tr><th>Service</th><th style="text-align:right">Fee</th></tr>
        </thead>
        <tbody>
          ${services.map(s => `<tr><td>${s.name}</td><td style="text-align:right">$${s.price.toLocaleString()}</td></tr>`).join('')}
          <tr class="proposal-total-row">
            <td><strong>Total Investment</strong></td>
            <td style="text-align:right"><strong>$${total.toLocaleString()}</strong></td>
          </tr>
        </tbody>
      </table>
      
      <div class="proposal-section-title">Terms & Conditions</div>
      <ul style="color:#475569">
        <li>50% due upon acceptance, 50% upon completion</li>
        <li>This proposal is valid for 30 days</li>
        <li>Travel expenses billed separately if applicable</li>
      </ul>
      
      <div style="margin-top:40px;border-top:2px solid #e2e8f0;padding-top:20px">
        <p><strong>Accepted By:</strong> _______________________</p>
        <p><strong>Date:</strong> _______________________</p>
      </div>
    </div>
  `;
  
  showModal('üìÑ Proposal Preview', html);
}

// Initialize new features on load
document.addEventListener('DOMContentLoaded', function() {
  // FORCE ALL SECTIONS OPEN
  document.querySelectorAll('.section-content').forEach(function(content) {
    content.style.display = 'block';
    content.style.maxHeight = 'none';
    content.style.overflow = 'visible';
    content.style.visibility = 'visible';
    content.style.height = 'auto';
  });
  
  // Initialize time entries display
  setTimeout(() => {
    updateTimeStats();
    renderTimeEntries();
    enhancedOfflineInit();
    
    // Set default date for time entry
    const dateInput = document.getElementById('manual_date');
    if (dateInput) {
      dateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Initialize mobile/tablet optimizations
    initMobileOptimizations();
  }, 1000);
});

// ==================== MOBILE & TABLET OPTIMIZATION v9.6.0 ====================

function initMobileOptimizations() {
  // Detect device type
  const isMobile = window.innerWidth <= 767;
  const isTablet = window.innerWidth >= 768 && window.innerWidth <= 1024;
  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  
  // Add device class to body
  document.body.classList.remove('is-mobile', 'is-tablet', 'is-desktop', 'is-touch');
  if (isMobile) document.body.classList.add('is-mobile');
  else if (isTablet) document.body.classList.add('is-tablet');
  else document.body.classList.add('is-desktop');
  if (isTouch) document.body.classList.add('is-touch');
  
  // Initialize touch gestures for panels
  if (isTouch) {
    initSwipeNavigation();
    initPullToRefresh();
  }
  
  // Prevent zoom on double-tap for iOS
  preventDoubleTapZoom();
  
  // Handle orientation changes
  handleOrientationChange();
  
  // Optimize scroll performance
  optimizeScrollPerformance();
  
  // Log device info
  console.log('Device:', isMobile ? 'Mobile' : isTablet ? 'Tablet' : 'Desktop', isTouch ? '(Touch)' : '(Mouse)');
}

// Swipe Navigation Between Panels
function initSwipeNavigation() {
  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;
  const minSwipeDistance = 80;
  const maxVerticalDistance = 100;
  
  const content = document.querySelector('.content');
  if (!content) return;
  
  content.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  }, { passive: true });
  
  content.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    handleSwipe();
  }, { passive: true });
  
  function handleSwipe() {
    const deltaX = touchEndX - touchStartX;
    const deltaY = Math.abs(touchEndY - touchStartY);
    
    // Only trigger if horizontal swipe and not too much vertical movement
    if (Math.abs(deltaX) > minSwipeDistance && deltaY < maxVerticalDistance) {
      const panels = ['dashboard', 'daily-ops', 'process-control', 'reactors', 'hydraulics', 
                      'aeration', 'chemicals', 'solids',  'scenarios', 
                      'reports', 'tools', 'settings', 'help'];
      
      // Find current panel
      const activePanel = document.querySelector('.panel.active');
      if (!activePanel) return;
      
      const currentId = activePanel.id;
      const currentIndex = panels.indexOf(currentId);
      
      if (currentIndex === -1) return;
      
      let newIndex;
      if (deltaX > 0) {
        // Swipe right - go to previous panel
        newIndex = currentIndex > 0 ? currentIndex - 1 : panels.length - 1;
      } else {
        // Swipe left - go to next panel
        newIndex = currentIndex < panels.length - 1 ? currentIndex + 1 : 0;
      }
      
      // Navigate to new panel
      if (typeof switchPanel === 'function') {
        switchPanel(panels[newIndex]);
        showToast('üì± ' + panels[newIndex].replace('-', ' ').toUpperCase(), 'info');
      }
    }
  }
}

// Pull to Refresh - DISABLED v9.9.16 (was causing panel issues)
function initPullToRefresh() {
  // Disabled - do nothing
  console.log('[v9.9.16] Pull-to-refresh disabled');
}

// Prevent double-tap zoom on iOS
function preventDoubleTapZoom() {
  let lastTouchEnd = 0;
  
  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
}

// Handle orientation changes
function handleOrientationChange() {
  window.addEventListener('orientationchange', () => {
    // Small delay to let the browser settle
    setTimeout(() => {
      // Reinitialize any size-dependent features
      const charts = document.querySelectorAll('canvas');
      charts.forEach(canvas => {
        if (canvas.chart) {
          canvas.chart.resize();
        }
      });
      
      // Update device class
      const isLandscape = window.innerWidth > window.innerHeight;
      document.body.classList.toggle('landscape', isLandscape);
      document.body.classList.toggle('portrait', !isLandscape);
      
      showToast(isLandscape ? 'üì± Landscape mode' : 'üì± Portrait mode', 'info');
    }, 100);
  });
  
  // Also listen for resize events
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      initMobileOptimizations();
    }, 250);
  });
}

// Optimize scroll performance
function optimizeScrollPerformance() {
  // Add passive listeners for scroll
  const scrollElements = document.querySelectorAll('.tabs, .table, .modal-body, .qref-body');
  scrollElements.forEach(el => {
    el.style.webkitOverflowScrolling = 'touch';
  });
  
  // Debounced scroll handler
  let scrollTimeout;
  window.addEventListener('scroll', () => {
    if (!document.body.classList.contains('is-scrolling')) {
      document.body.classList.add('is-scrolling');
    }
    
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      document.body.classList.remove('is-scrolling');
    }, 150);
  }, { passive: true });
}

// Touch-friendly input helpers
function enhanceInputsForTouch() {
  const inputs = document.querySelectorAll('input[type="number"], input[type="text"]');
  
  inputs.forEach(input => {
    // Add clear button functionality
    input.addEventListener('focus', function() {
      this.select(); // Select all text on focus for easy editing
    });
    
    // Prevent scroll when input is focused (iOS fix)
    input.addEventListener('touchmove', (e) => {
      if (document.activeElement === input) {
        e.stopPropagation();
      }
    }, { passive: true });
  });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', enhanceInputsForTouch);

// Haptic feedback helper (if supported)
function hapticFeedback(type = 'light') {
  if ('vibrate' in navigator) {
    switch(type) {
      case 'light':
        navigator.vibrate(10);
        break;
      case 'medium':
        navigator.vibrate(25);
        break;
      case 'heavy':
        navigator.vibrate(50);
        break;
      case 'success':
        navigator.vibrate([10, 50, 10]);
        break;
      case 'error':
        navigator.vibrate([50, 30, 50, 30, 50]);
        break;
    }
  }
}

// Add haptic feedback to buttons
document.querySelectorAll('.btn, .tab, .mobile-nav-btn').forEach(btn => {
  btn.addEventListener('touchstart', () => hapticFeedback('light'), { passive: true });
});

</script>

<!-- ==================== QUICK REFERENCE LIBRARY MODAL ==================== -->
<div id="quickRefModal" class="qref-modal" onclick="if(event.target===this)closeQuickRef()">
<div class="qref-content">
<div class="qref-header">
<h2>üìö Quick Reference Library</h2>
<button class="qref-close" onclick="closeQuickRef()">&times;</button>
</div>
<div class="qref-search">
<input type="text" id="qrefSearch" placeholder="üîç Search parameters, issues, limits..." oninput="filterQuickRef(this.value)">
</div>
<div class="qref-tabs">
<button class="qref-tab active" onclick="showQrefTab('parameters')">üìä Parameters</button>
<button class="qref-tab" onclick="showQrefTab('troubleshoot')">üîß Troubleshooting</button>
<button class="qref-tab" onclick="showQrefTab('regulatory')">üìã TCEQ Limits</button>
<button class="qref-tab" onclick="showQrefTab('formulas')">üßÆ Formulas</button>
<button class="qref-tab" onclick="showQrefTab('sops')">üìö SOPs</button>
</div>
<div class="qref-body">

<!-- PARAMETERS TAB -->
<div id="qref-parameters" class="qref-tab-content">
<div class="qref-section" data-search="mlss mixed liquor suspended solids biomass">
<h3>üß´ MLSS (Mixed Liquor Suspended Solids)</h3>
<table class="qref-table">
<tr><th>Process Type</th><th>Typical Range</th><th>Optimal</th></tr>
<tr><td>Conventional Activated Sludge</td><td>1,500 - 3,500 mg/L</td><td><span class="qref-range optimal">2,000 - 3,000 mg/L</span></td></tr>
<tr><td>Extended Aeration</td><td>3,000 - 6,000 mg/L</td><td><span class="qref-range optimal">4,000 - 5,000 mg/L</span></td></tr>
<tr><td>MBR Systems</td><td>8,000 - 15,000 mg/L</td><td><span class="qref-range optimal">10,000 - 12,000 mg/L</span></td></tr>
<tr><td>SBR Systems</td><td>2,000 - 5,000 mg/L</td><td><span class="qref-range optimal">3,000 - 4,000 mg/L</span></td></tr>
<tr><td>MBBR Systems</td><td>2,000 - 4,000 mg/L</td><td><span class="qref-range optimal">2,500 - 3,500 mg/L</span></td></tr>
</table>
</div>

<div class="qref-section" data-search="srt sludge retention time mcrt mean cell">
<h3>‚è±Ô∏è SRT (Sludge Retention Time)</h3>
<table class="qref-table">
<tr><th>Treatment Goal</th><th>Typical SRT</th><th>Notes</th></tr>
<tr><td>BOD Removal Only</td><td>3 - 5 days</td><td>Minimum for stable operation</td></tr>
<tr><td>Nitrification</td><td>8 - 15 days</td><td>Temperature dependent</td></tr>
<tr><td>Extended Aeration</td><td>20 - 30 days</td><td>Low sludge production</td></tr>
<tr><td>Cold Weather (&lt;15¬∞C)</td><td>15 - 25 days</td><td>Slower nitrifier growth</td></tr>
<tr><td>Warm Weather (&gt;20¬∞C)</td><td>8 - 12 days</td><td>Faster kinetics</td></tr>
</table>
</div>

<div class="qref-section" data-search="fm f/m food microorganism ratio loading">
<h3>‚öñÔ∏è F/M Ratio (Food to Microorganism)</h3>
<table class="qref-table">
<tr><th>Process Type</th><th>F/M Range</th><th>Optimal</th></tr>
<tr><td>Conventional</td><td>0.2 - 0.5</td><td><span class="qref-range optimal">0.3 - 0.4</span></td></tr>
<tr><td>Extended Aeration</td><td>0.05 - 0.15</td><td><span class="qref-range optimal">0.08 - 0.12</span></td></tr>
<tr><td>High Rate</td><td>0.5 - 1.0</td><td><span class="qref-range optimal">0.6 - 0.8</span></td></tr>
<tr><td>Contact Stabilization</td><td>0.2 - 0.6</td><td><span class="qref-range optimal">0.3 - 0.5</span></td></tr>
</table>
</div>

<div class="qref-section" data-search="svi sludge volume index settling">
<h3>üìâ SVI (Sludge Volume Index)</h3>
<table class="qref-table">
<tr><th>SVI Range</th><th>Condition</th><th>Action</th></tr>
<tr><td><span class="qref-range optimal">&lt; 100 mL/g</span></td><td>Excellent settling</td><td>Optimal operation</td></tr>
<tr><td><span class="qref-range warning">100 - 150 mL/g</span></td><td>Good settling</td><td>Monitor closely</td></tr>
<tr><td><span class="qref-range warning">150 - 200 mL/g</span></td><td>Fair settling</td><td>Investigate causes</td></tr>
<tr><td><span class="qref-range critical">&gt; 200 mL/g</span></td><td>Bulking sludge</td><td>Immediate action needed</td></tr>
</table>
</div>

<div class="qref-section" data-search="do dissolved oxygen aeration">
<h3>üí® Dissolved Oxygen (DO)</h3>
<table class="qref-table">
<tr><th>Location/Process</th><th>Target DO</th><th>Notes</th></tr>
<tr><td>Aeration Basin</td><td>1.5 - 2.5 mg/L</td><td>Minimum 1.0 for nitrification</td></tr>
<tr><td>Anoxic Zone</td><td>&lt; 0.5 mg/L</td><td>Required for denitrification</td></tr>
<tr><td>Anaerobic Zone</td><td>&lt; 0.2 mg/L</td><td>Bio-P removal</td></tr>
<tr><td>Final Effluent</td><td>&gt; 4.0 mg/L</td><td>Permit requirement typical</td></tr>
</table>
</div>

<div class="qref-section" data-search="ph alkalinity acid base">
<h3>üß™ pH & Alkalinity</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>Optimal Range</th><th>Critical Limits</th></tr>
<tr><td>Aeration Basin pH</td><td>6.8 - 7.5</td><td>&lt; 6.5 or &gt; 8.5 inhibits nitrification</td></tr>
<tr><td>Alkalinity (as CaCO‚ÇÉ)</td><td>100 - 200 mg/L</td><td>&lt; 50 mg/L causes pH crash</td></tr>
<tr><td>Alkalinity for Nitrification</td><td>7.1 mg/L per mg NH‚ÇÉ-N</td><td>Consumed during nitrification</td></tr>
</table>
</div>
</div>

<!-- TROUBLESHOOTING TAB -->
<div id="qref-troubleshoot" class="qref-tab-content qref-hidden">
<div class="qref-trouble" data-search="bulking filamentous settling svi high">
<h4>üö® Bulking Sludge (High SVI)</h4>
<p><strong>Symptoms:</strong> SVI &gt; 150, poor settling, rising sludge blanket</p>
<ul>
<li><strong>Low DO:</strong> Increase aeration, check diffusers</li>
<li><strong>Low F/M:</strong> Reduce MLSS, increase wasting</li>
<li><strong>Nutrient deficiency:</strong> Check N:P ratio (100:5:1 BOD:N:P)</li>
<li><strong>Septicity:</strong> Check collection system, reduce detention time</li>
<li><strong>Low pH:</strong> Add alkalinity (lime, soda ash)</li>
</ul>
</div>

<div class="qref-trouble" data-search="foaming nocardia microthrix brown white">
<h4>ü´ß Foaming Problems</h4>
<p><strong>Brown/Tan Foam (Nocardia):</strong></p>
<ul>
<li>Reduce SRT to 8-10 days</li>
<li>Increase wasting rate</li>
<li>Add chlorine to RAS (2-5 mg/L)</li>
<li>Spray water to break foam</li>
</ul>
<p><strong>White Foam:</strong></p>
<ul>
<li>Young sludge - reduce wasting</li>
<li>Low MLSS - reduce wasting, increase SRT</li>
<li>Surfactants - check industrial inputs</li>
</ul>
</div>

<div class="qref-trouble" data-search="nitrification ammonia high effluent">
<h4>‚ö†Ô∏è Poor Nitrification</h4>
<p><strong>Symptoms:</strong> High effluent ammonia, low nitrate</p>
<ul>
<li><strong>Low DO:</strong> Maintain &gt; 2.0 mg/L in aeration</li>
<li><strong>Low SRT:</strong> Increase to 12-15 days minimum</li>
<li><strong>Low pH:</strong> Maintain pH &gt; 6.8, add alkalinity</li>
<li><strong>Cold temperature:</strong> Increase SRT in winter</li>
<li><strong>Toxicity:</strong> Check for industrial discharge</li>
<li><strong>Insufficient alkalinity:</strong> Need 7.1 mg/L alk per mg/L NH‚ÇÉ-N</li>
</ul>
</div>

<div class="qref-trouble" data-search="rising sludge denitrification clarifier floating">
<h4>üîÑ Rising Sludge in Clarifier</h4>
<p><strong>Symptoms:</strong> Clumps of sludge floating, gas bubbles</p>
<ul>
<li><strong>Denitrification:</strong> Reduce sludge blanket depth</li>
<li>Increase RAS rate</li>
<li>Reduce SRT if over-nitrifying</li>
<li>Add anoxic zone before clarifier</li>
<li>Check for septic conditions</li>
</ul>
</div>

<div class="qref-trouble" data-search="pin floc dispersed turbid effluent cloudy">
<h4>üî¨ Pin Floc / Dispersed Growth</h4>
<p><strong>Symptoms:</strong> Turbid effluent, small floc particles</p>
<ul>
<li><strong>Over-aeration:</strong> Reduce DO to 2.0 mg/L</li>
<li><strong>Toxicity:</strong> Check industrial inputs</li>
<li><strong>Low SRT:</strong> Increase SRT, reduce wasting</li>
<li><strong>Hydraulic washout:</strong> Check for I&I during storms</li>
<li>Add polymer to clarifier</li>
</ul>
</div>

<div class="qref-trouble" data-search="phosphorus high effluent bio-p">
<h4>üß´ High Effluent Phosphorus</h4>
<p><strong>Symptoms:</strong> Effluent TP &gt; permit limit</p>
<ul>
<li><strong>Chemical addition:</strong> Alum, ferric, or ferrous</li>
<li>Dose ratio: 1.5-2.5 mol Fe/mol P or 1.5-2.0 mol Al/mol P</li>
<li><strong>Bio-P issues:</strong> Check anaerobic zone DO (&lt; 0.2 mg/L)</li>
<li>Ensure VFAs available in anaerobic zone</li>
<li>Check for nitrate recycle to anaerobic zone</li>
</ul>
</div>
</div>

<!-- REGULATORY TAB -->
<div id="qref-regulatory" class="qref-tab-content qref-hidden">
<div class="qref-section" data-search="tceq texas effluent limits permit">
<h3>üìã TCEQ Typical Effluent Limits</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>Daily Avg</th><th>Daily Max</th><th>Units</th></tr>
<tr><td>BOD‚ÇÖ</td><td>10 - 20</td><td>25 - 40</td><td>mg/L</td></tr>
<tr><td>TSS</td><td>15 - 20</td><td>30 - 45</td><td>mg/L</td></tr>
<tr><td>Ammonia-N (Summer)</td><td>2 - 5</td><td>4 - 10</td><td>mg/L</td></tr>
<tr><td>Ammonia-N (Winter)</td><td>3 - 10</td><td>6 - 20</td><td>mg/L</td></tr>
<tr><td>Total Phosphorus</td><td>0.5 - 1.0</td><td>1.0 - 2.0</td><td>mg/L</td></tr>
<tr><td>E. coli</td><td>126</td><td>399</td><td>CFU/100mL</td></tr>
<tr><td>DO (Minimum)</td><td>4.0 - 6.0</td><td>-</td><td>mg/L</td></tr>
<tr><td>pH</td><td colspan="2">6.0 - 9.0</td><td>S.U.</td></tr>
</table>
</div>

<div class="qref-section" data-search="cbod carbonaceous bod limits">
<h3>üìä CBOD‚ÇÖ vs BOD‚ÇÖ</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>When Required</th><th>Typical Limit</th></tr>
<tr><td>BOD‚ÇÖ (Total)</td><td>Standard permits</td><td>20 mg/L avg, 40 mg/L max</td></tr>
<tr><td>CBOD‚ÇÖ</td><td>Nitrifying plants</td><td>10 mg/L avg, 25 mg/L max</td></tr>
<tr><td>Note:</td><td colspan="2">CBOD ‚âà 0.8-0.9 √ó BOD for nitrifying plants</td></tr>
</table>
</div>

<div class="qref-section" data-search="monitoring frequency sampling">
<h3>üìÖ Typical Monitoring Frequency</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>Small (&lt;1 MGD)</th><th>Medium (1-5 MGD)</th><th>Large (&gt;5 MGD)</th></tr>
<tr><td>Flow</td><td>Daily</td><td>Continuous</td><td>Continuous</td></tr>
<tr><td>pH, DO, Temp</td><td>Daily</td><td>Daily</td><td>Continuous</td></tr>
<tr><td>BOD, TSS</td><td>Weekly</td><td>2x/week</td><td>Daily</td></tr>
<tr><td>Ammonia</td><td>Weekly</td><td>2x/week</td><td>Daily</td></tr>
<tr><td>E. coli</td><td>Weekly</td><td>2x/week</td><td>Daily</td></tr>
<tr><td>Phosphorus</td><td>Monthly</td><td>Weekly</td><td>2x/week</td></tr>
</table>
</div>
</div>

<!-- FORMULAS TAB -->
<div id="qref-formulas" class="qref-tab-content qref-hidden">
<div class="qref-section" data-search="formula calculation equation">
<h3>üßÆ Common Formulas</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>Formula</th></tr>
<tr><td><strong>F/M Ratio</strong></td><td>F/M = (Q √ó BOD √ó 8.34) / (V √ó MLSS √ó 8.34) = Q √ó BOD / (V √ó MLSS)</td></tr>
<tr><td><strong>SRT (days)</strong></td><td>SRT = (V √ó MLSS) / [(Qw √ó MLSS_ras) + (Qe √ó TSS_eff)]</td></tr>
<tr><td><strong>MLSS (mg/L)</strong></td><td>MLSS = (SRT √ó Q √ó BOD √ó Y) / [V √ó (1 + kd √ó SRT)]</td></tr>
<tr><td><strong>OLR</strong></td><td>OLR = (Q √ó BOD √ó 8.34) / (V √ó 1000) lb BOD/1000 cf/day</td></tr>
<tr><td><strong>SVI (mL/g)</strong></td><td>SVI = (Settled Volume mL/L √ó 1000) / MLSS mg/L</td></tr>
<tr><td><strong>WAS Flow</strong></td><td>Qw = V / SRT - Qe √ó (TSS_eff / MLSS_ras)</td></tr>
<tr><td><strong>RAS Rate</strong></td><td>RAS% = MLSS / (MLSS_ras - MLSS) √ó 100</td></tr>
<tr><td><strong>Detention Time</strong></td><td>DT (hr) = V (gal) √ó 24 / Q (GPD)</td></tr>
<tr><td><strong>Surface Loading</strong></td><td>SLR = Q (GPD) / Area (sf)</td></tr>
<tr><td><strong>Weir Loading</strong></td><td>WLR = Q (GPD) / Weir Length (ft)</td></tr>
</table>
</div>

<div class="qref-section" data-search="conversion factors units">
<h3>üìê Conversion Factors</h3>
<table class="qref-table">
<tr><th>Convert From</th><th>To</th><th>Multiply By</th></tr>
<tr><td>MGD</td><td>GPM</td><td>694.4</td></tr>
<tr><td>MGD</td><td>m¬≥/day</td><td>3,785</td></tr>
<tr><td>lb/day</td><td>kg/day</td><td>0.4536</td></tr>
<tr><td>mg/L √ó MGD √ó 8.34</td><td>lb/day</td><td>-</td></tr>
<tr><td>ft</td><td>m</td><td>0.3048</td></tr>
<tr><td>sf</td><td>m¬≤</td><td>0.0929</td></tr>
<tr><td>cf</td><td>gal</td><td>7.48</td></tr>
<tr><td>psi</td><td>ft head</td><td>2.31</td></tr>
<tr><td>HP</td><td>kW</td><td>0.746</td></tr>
</table>
</div>

<div class="qref-section" data-search="constants coefficients kinetic">
<h3>üìä Typical Design Constants</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>Symbol</th><th>Typical Value</th></tr>
<tr><td>Yield Coefficient</td><td>Y</td><td>0.4 - 0.6 lb VSS/lb BOD</td></tr>
<tr><td>Decay Coefficient</td><td>kd</td><td>0.05 - 0.1 day‚Åª¬π</td></tr>
<tr><td>MLVSS/MLSS Ratio</td><td>-</td><td>0.70 - 0.85</td></tr>
<tr><td>BOD:N:P Ratio</td><td>-</td><td>100:5:1</td></tr>
<tr><td>O‚ÇÇ for Carbonaceous</td><td>-</td><td>1.1 - 1.5 lb O‚ÇÇ/lb BOD</td></tr>
<tr><td>O‚ÇÇ for Nitrification</td><td>-</td><td>4.6 lb O‚ÇÇ/lb NH‚ÇÉ-N</td></tr>
<tr><td>Alkalinity for Nitrif.</td><td>-</td><td>7.1 mg/L alk per mg/L NH‚ÇÉ-N</td></tr>
</table>
</div>
</div>

<!-- SOP TAB -->
<div id="qref-sops" class="qref-tab-content qref-hidden">
<div class="note info" style="margin-bottom:20px">Quick reference SOPs for common wastewater operations. Click any card to view the full procedure.</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:15px" id="qref_sop_grid">

<div class="sop-card" onclick="showSOP('startup')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #06d6a0;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#4ade80;margin:0 0 8px 0">üöÄ Plant Startup</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Procedures for starting treatment processes after shutdown</p>
</div>

<div class="sop-card" onclick="showSOP('shutdown')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #ffd166;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#fbbf24;margin:0 0 8px 0">üõë Emergency Shutdown</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Emergency procedures for plant shutdown</p>
</div>

<div class="sop-card" onclick="showSOP('wasting')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #0077b6;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#60a5fa;margin:0 0 8px 0">üîÑ Sludge Wasting</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">WAS calculation and wasting procedures</p>
</div>

<div class="sop-card" onclick="showSOP('clarifier')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #a78bfa;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#a78bfa;margin:0 0 8px 0">‚öôÔ∏è Clarifier Operations</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Primary and secondary clarifier operation</p>
</div>

<div class="sop-card" onclick="showSOP('disinfection')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #ec4899;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#f472b6;margin:0 0 8px 0">‚ò¢Ô∏è Disinfection</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Chlorination and UV disinfection procedures</p>
</div>

<div class="sop-card" onclick="showSOP('sampling')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #00b4d8;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#48cae4;margin:0 0 8px 0">üß™ Sampling & Testing</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Sample collection and lab testing procedures</p>
</div>

<div class="sop-card" onclick="showSOP('chemical')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #84cc16;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#a3e635;margin:0 0 8px 0">‚öóÔ∏è Chemical Handling</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Safe chemical storage and handling</p>
</div>

<div class="sop-card" onclick="showSOP('blower')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #f97316;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#fb923c;margin:0 0 8px 0">üí® Blower Operations</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Aeration blower startup and maintenance</p>
</div>

<div class="sop-card" onclick="showSOP('dewatering')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #14b8a6;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#2dd4bf;margin:0 0 8px 0">üóúÔ∏è Dewatering</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Belt press and centrifuge operation</p>
</div>

</div>

<div id="qref_sop_display" style="margin-top:20px"></div>
</div>

</div>
</div>
</div>

<!-- PWA Install Button - REMOVED v9.6.0 (not functional on mobile) -->

<!-- PWA Install Instructions Modal -->
<div id="installModal" class="install-modal" onclick="if(event.target===this)closeInstallModal()">
<div class="install-modal-content">
<h3>üì≤ Install WWTP Command Center</h3>
<p style="color:var(--text-secondary);margin-bottom:16px">Add this app to your home screen for quick access and offline use.</p>

<div id="installAndroid" class="install-steps">
<strong>üì± Android (Chrome/Samsung):</strong>
<ol>
<li>Tap the <strong>‚ãÆ menu</strong> (3 dots) in browser</li>
<li>Select <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong></li>
<li>Tap <strong>Add/Install</strong> to confirm</li>
</ol>
</div>

<div id="installIOS" class="install-steps">
<strong>üçé iPhone/iPad (Safari):</strong>
<ol>
<li>Tap the <strong>Share button</strong> (‚ñ°‚Üë)</li>
<li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
<li>Tap <strong>Add</strong> to confirm</li>
</ol>
</div>

<div id="installDesktop" class="install-steps">
<strong>üíª Desktop (Chrome/Edge):</strong>
<ol>
<li>Click the <strong>install icon</strong> (‚äï) in the address bar</li>
<li>Or click <strong>‚ãÆ menu ‚Üí Install WWTP...</strong></li>
<li>Click <strong>Install</strong> to confirm</li>
</ol>
</div>

<button id="autoInstallBtn" class="btn gradient" style="margin-top:16px;display:none" onclick="installPWA()">
‚ö° Quick Install
</button>

<button class="close-btn" onclick="closeInstallModal()">Got it!</button>
</div>
</div>

<!-- PWA Update Banner -->
<div id="pwaUpdateBanner" class="pwa-update-banner">
<span>üîÑ New version available!</span>
<button onclick="updatePWA()">Update Now</button>
<button onclick="dismissUpdate()" style="background:transparent;color:white;text-decoration:underline">Later</button>
</div>

<script>
// ==================== PWA ENHANCEMENT v9.6.0 ====================

// PWA Install Prompt
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', function(e) {
  e.preventDefault();
  deferredPrompt = e;
  // Show quick install button in modal
  var autoBtn = document.getElementById('autoInstallBtn');
  if (autoBtn) autoBtn.style.display = 'block';
  console.log('[PWA] Install prompt captured - quick install available');
});

function showInstallModal() {
  var modal = document.getElementById('installModal');
  modal.classList.add('show');
  
  // Detect device and show relevant instructions
  var ua = navigator.userAgent.toLowerCase();
  var isIOS = /iphone|ipad|ipod/.test(ua);
  var isAndroid = /android/.test(ua);
  var isSamsung = /samsung/.test(ua);
  
  document.getElementById('installAndroid').style.display = (isAndroid || isSamsung) ? 'block' : 'none';
  document.getElementById('installIOS').style.display = isIOS ? 'block' : 'none';
  document.getElementById('installDesktop').style.display = (!isIOS && !isAndroid) ? 'block' : 'none';
  
  // Show all on desktop for reference
  if (!isIOS && !isAndroid && !isSamsung) {
    document.getElementById('installAndroid').style.display = 'block';
    document.getElementById('installIOS').style.display = 'block';
  }
  
  console.log('[PWA] Install modal opened. Device:', isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop');
}

function closeInstallModal() {
  document.getElementById('installModal').classList.remove('show');
}

function installPWA() {
  if (!deferredPrompt) {
    showToast('üì≤ Use manual install instructions above', 'info');
    return;
  }
  
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(function(result) {
    if (result.outcome === 'accepted') {
      showToast('‚úÖ App installed successfully!', 'success');
      closeInstallModal();
      // Install button removed
    }
    deferredPrompt = null;
    document.getElementById('autoInstallBtn').style.display = 'none';
  });
}

window.addEventListener('appinstalled', function() {
  // Install button removed
  closeInstallModal();
  showToast('‚úÖ WWTP Command Center installed!', 'success');
  console.log('[PWA] App installed');
});

// Log standalone status but don't auto-hide button (user may want to see instructions)
if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
  console.log('[PWA] Running in standalone mode');
}

// Online/Offline Detection
function updateOnlineStatus() {
  var statusEl = document.getElementById('pwaStatus');
  var textEl = document.getElementById('pwaStatusText');
  var headerStatus = document.getElementById('headerOnlineStatus');
  
  if (navigator.onLine) {
    statusEl.classList.remove('offline');
    statusEl.classList.add('online');
    textEl.textContent = 'Online';
    if (headerStatus) {
      headerStatus.style.background = '#10b981';
      headerStatus.textContent = 'üü¢ Online';
    }
    syncPendingData();
  } else {
    statusEl.classList.remove('online');
    statusEl.classList.add('offline');
    textEl.textContent = 'Offline Mode';
    if (headerStatus) {
      headerStatus.style.background = '#ef4444';
      headerStatus.textContent = 'üî¥ Offline';
    }
    showToast('üì¥ Working offline - data saved locally', 'warning');
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Initialize status on load
document.addEventListener('DOMContentLoaded', function() {
  updateOnlineStatus();
  
  // Hide status after 5 seconds if online
  setTimeout(function() {
    if (navigator.onLine) {
      var statusEl = document.getElementById('pwaStatus');
      statusEl.style.opacity = '0.3';
      statusEl.addEventListener('mouseenter', function() { this.style.opacity = '1'; });
      statusEl.addEventListener('mouseleave', function() { if(navigator.onLine) this.style.opacity = '0.3'; });
    }
  }, 5000);
});

// Offline Data Storage
var OFFLINE_STORAGE_KEY = 'wwtp_offline_data';

function saveOfflineData(key, data) {
  try {
    var stored = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '{}');
    stored[key] = {
      data: data,
      timestamp: Date.now(),
      synced: navigator.onLine
    };
    localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(stored));
    
    if (!navigator.onLine) {
      console.log('[PWA] Data saved offline:', key);
    }
    return true;
  } catch(e) {
    console.error('[PWA] Offline save error:', e);
    return false;
  }
}

function getOfflineData(key) {
  try {
    var stored = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '{}');
    return stored[key] ? stored[key].data : null;
  } catch(e) {
    return null;
  }
}

function syncPendingData() {
  try {
    var stored = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '{}');
    var pendingCount = 0;
    
    for (var key in stored) {
      if (!stored[key].synced) {
        stored[key].synced = true;
        pendingCount++;
      }
    }
    
    if (pendingCount > 0) {
      localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(stored));
      showToast('‚òÅÔ∏è ' + pendingCount + ' item(s) synced', 'success');
      console.log('[PWA] Synced', pendingCount, 'pending items');
    }
  } catch(e) {
    console.error('[PWA] Sync error:', e);
  }
}

// Cache Management
function getCacheSize() {
  var total = 0;
  for (var key in localStorage) {
    if (localStorage.hasOwnProperty(key)) {
      total += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
    }
  }
  return (total / 1024).toFixed(2) + ' KB';
}

function clearOfflineCache() {
  if (confirm('Clear all offline data? This cannot be undone.')) {
    localStorage.removeItem(OFFLINE_STORAGE_KEY);
    showToast('üóëÔ∏è Offline cache cleared', 'success');
  }
}

// PWA Update Handling
var newWorkerWaiting = null;

function updatePWA() {
  if (newWorkerWaiting) {
    newWorkerWaiting.postMessage({ type: 'SKIP_WAITING' });
  }
  window.location.reload();
}

function dismissUpdate() {
  document.getElementById('pwaUpdateBanner').classList.remove('show');
}

// Service Worker Registration (inline for single-file PWA)
if ('serviceWorker' in navigator) {
  // Create a minimal service worker blob for offline caching
  var swCode = `
    const CACHE_NAME = 'wwtp-v9.6.0';
    const OFFLINE_URL = '/';
    
    self.addEventListener('install', (e) => {
      self.skipWaiting();
    });
    
    self.addEventListener('activate', (e) => {
      e.waitUntil(clients.claim());
    });
    
    self.addEventListener('fetch', (e) => {
      if (e.request.mode === 'navigate') {
        e.respondWith(
          fetch(e.request).catch(() => caches.match(OFFLINE_URL))
        );
      }
    });
  `;
  
  // Note: Inline service workers have limitations
  // For full offline support, deploy sw.js separately
  console.log('[PWA] Service worker support detected');
  console.log('[PWA] For full offline support, deploy with separate sw.js file');
}

// Auto-save form data for offline resilience
function enableOfflineFormSave() {
  document.querySelectorAll('input, select, textarea').forEach(function(el) {
    if (el.id) {
      // Load saved value
      var saved = getOfflineData('form_' + el.id);
      if (saved !== null && !el.value) {
        el.value = saved;
      }
      
      // Save on change
      el.addEventListener('change', function() {
        saveOfflineData('form_' + this.id, this.value);
      });
    }
  });
}

// Initialize offline form saving after DOM ready
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(enableOfflineFormSave, 1000);
});

// PWA Diagnostic Info
function getPWAInfo() {
  return {
    online: navigator.onLine,
    standalone: window.matchMedia('(display-mode: standalone)').matches,
    cacheSize: getCacheSize(),
    serviceWorker: 'serviceWorker' in navigator,
    installable: deferredPrompt !== null
  };
}

console.log('[PWA v9.6.0] Enhanced PWA initialized');
console.log('[PWA] Status:', getPWAInfo());

// ==================== END PWA ENHANCEMENT ====================
</script>

<!-- FAVORITES FLOATING BUTTON -->
<div id="favoritesFloatingBtn" onclick="toggleFavoritesPanel()" style="position:fixed;bottom:90px;left:20px;width:56px;height:56px;background:linear-gradient(135deg,#f59e0b,#fbbf24);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:9998;box-shadow:0 4px 15px rgba(245,158,11,0.4);transition:all 0.3s;border:3px solid #fcd34d">
  <span style="font-size:20px">‚≠ê</span>
</div>

<!-- FAVORITES PANEL -->
<div id="favoritesPanel" style="display:none;position:fixed;bottom:160px;left:20px;width:320px;max-height:60vh;background:linear-gradient(135deg,#1e1b4b,#312e81);border-radius:16px;z-index:9999;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:3px solid #f59e0b;overflow:hidden">
  <div style="background:linear-gradient(135deg,#f59e0b,#fbbf24);padding:15px;display:flex;justify-content:space-between;align-items:center">
    <span style="font-weight:bold;font-size:18px;color:#1e1b4b">‚≠ê Favorites</span>
    <button onclick="toggleFavoritesPanel()" style="background:rgba(0,0,0,0.2);border:none;color:#1e1b4b;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:18px">‚úï</button>
  </div>
  <div id="favoritesList" style="padding:15px;max-height:calc(60vh - 60px);overflow-y:auto">
    <p style="color:#a5b4fc;text-align:center;margin:20px 0">No favorites yet.<br><br>Tap the ‚≠ê icon on any section to add it here.</p>
  </div>
</div>

<script>
// ========== FAVORITES SYSTEM ==========

var userFavorites = [];

// Favorite items available to star
var favoriteItems = [
  { id: 'fav_dashboard', name: 'üìä Dashboard', panel: 'dashboard', section: null },
  { id: 'fav_dailyops', name: 'üë∑ Daily Operations', panel: 'daily-ops', section: null },
  { id: 'fav_master', name: 'üéõÔ∏è Master Settings', panel: 'process-control', section: 'masterSettingsSection' },
  { id: 'fav_checklist', name: 'üìã Daily Checklist', panel: 'daily-ops', section: 'dailyChecklist' },
  { id: 'fav_process', name: '‚öôÔ∏è Process Control', panel: 'process-control', section: null },
  { id: 'fav_reactors', name: 'üîÑ Reactors', panel: 'reactors', section: null },
  { id: 'fav_hydraulics', name: 'üìê Hydraulics', panel: 'hydraulics', section: null },
  { id: 'fav_aeration', name: 'üí® Aeration', panel: 'aeration', section: null },
  { id: 'fav_chemicals', name: '‚öóÔ∏è Chemicals', panel: 'chemicals', section: null },
  { id: 'fav_solids', name: 'üóëÔ∏è Solids', panel: 'solids', section: null },
  { id: 'fav_compliance', name: 'üìã Compliance & Lab', panel: 'compliance', section: null },
  { id: 'fav_diagnostics', name: 'ü©∫ Diagnostics', panel: 'wizards', section: null },
  { id: 'fav_wizards', name: 'üß≠ Wizards', panel: 'wizards', section: null },
  { id: 'fav_maintenance', name: 'üîß Maintenance', panel: 'maintenance', section: null },
  { id: 'fav_reports', name: 'üìë Reports', panel: 'reports', section: null },
  { id: 'fav_profiles', name: 'üè≠ Profiles', panel: 'profiles', section: null },
  { id: 'fav_business', name: 'üíº Business', panel: 'business', section: null },
  { id: 'fav_multiplant', name: 'üè≠ Multi-Plant', panel: 'multiplant', section: null },
  // Calculators - Process Control
  { id: 'fav_svi', name: 'üß™ SVI Calculator', panel: 'process-control', section: 'sviCalcSection' },
  { id: 'fav_fm', name: 'üìä F/M Calculator', panel: 'process-control', section: 'fmCalcSection' },
  { id: 'fav_olr', name: 'üß´ OLR Calculator', panel: 'process-control', section: 'olrCalcSection' },
  { id: 'fav_mlss', name: 'üî¨ MLSS/MLVSS Calculator', panel: 'process-control', section: 'mlssCalcSection' },
  { id: 'fav_sludge_age', name: 'üìÖ Sludge Age (5 Methods)', panel: 'process-control', section: 'sludgeAgeCalculator' },
  // Calculators - Chemicals
  { id: 'fav_chlorine', name: 'üß¥ Chlorine Dosing', panel: 'chemicals', section: 'chlorineCalcSection' },
  { id: 'fav_polymer', name: 'üß™ Polymer Dosing', panel: 'chemicals', section: 'polymerCalcSection' },
  { id: 'fav_jar_test', name: 'üß´ Jar Test Optimizer', panel: 'chemicals', section: 'jarTestSection' },
  // Calculators - Hydraulics
  { id: 'fav_mass_balance', name: '‚öñÔ∏è Mass Balance', panel: 'hydraulics', section: 'massBalanceSection' },
  { id: 'fav_ote', name: 'üí® Oxygen Transfer (OTE)', panel: 'hydraulics', section: 'oteCalcSection' },
  // NEW - Solids Handling Calculators
  { id: 'fav_was_calc', name: 'üöø WAS Calculator', panel: 'solids', section: 'advancedWasCalculator' },
  { id: 'fav_ras_calc', name: 'üîÑ RAS Calculator', panel: 'solids', section: 'rasCalculatorSection' },
  { id: 'fav_clarifier_slr', name: 'üèä Clarifier SLR', panel: 'solids', section: 'clarifierSlrCalculator' },
  { id: 'fav_sludge_judge', name: 'üß™ Sludge Judge/Settleometer', panel: 'solids', section: 'sludgeJudgeCalculator' },
  { id: 'fav_thickener', name: 'üîÑ Thickener Loading', panel: 'solids', section: 'thickenerCalcSection' },
  { id: 'fav_biogas', name: 'üî• Biogas/Digester', panel: 'solids', section: 'biogasCalculator' },
  { id: 'fav_uv', name: '‚òÄÔ∏è UV Disinfection', panel: 'hydraulics', section: 'uvDisinfectionCalculator' },
  { id: 'fav_nutrient', name: 'üåø Nutrient Balance', panel: 'process-control', section: 'nutrientBalanceCalculator' },
  { id: 'fav_wetweather', name: 'üåßÔ∏è Wet Weather/I&I', panel: 'hydraulics', section: 'wetWeatherCalculator' },
  { id: 'fav_septage', name: 'üöõ Septage Receiving', panel: 'solids', section: 'septageCalculator' },
  { id: 'fav_dewatering', name: 'üóúÔ∏è Belt Press/Centrifuge', panel: 'hydraulics', section: 'dewateringCalculator' },
  { id: 'fav_sludgebox', name: 'üì¶ Sludge Box Hauling', panel: 'solids', section: 'sludgeBoxCalculator' },
  { id: 'fav_pumpstation', name: 'üîÑ Pump Station', panel: 'hydraulics', section: 'pumpStationCalculator' },
  { id: 'fav_membrane', name: 'üî¨ Membrane MBR/RO', panel: 'hydraulics', section: 'membraneCalculator' },
  { id: 'fav_daf', name: 'ü´ß DAF Flotation', panel: 'hydraulics', section: 'dafCalculator' },
  // Wizards
  { id: 'fav_tss_wizard', name: 'üî¥ TSS Wizard', panel: 'wizards', section: null, action: "startWizard('tss')" },
  { id: 'fav_bulking_wizard', name: 'üü† Bulking Wizard', panel: 'wizards', section: null, action: "startWizard('bulking')" },
  { id: 'fav_ammonia_wizard', name: 'üîµ Ammonia Wizard', panel: 'wizards', section: null, action: "startWizard('ammonia')" },
  { id: 'fav_do_wizard', name: 'üü¢ Low DO Wizard', panel: 'wizards', section: null, action: "startWizard('lowdo')" },
  { id: 'fav_foam_wizard', name: 'üü§ Foam/Scum Wizard', panel: 'wizards', section: null, action: "startWizard('foam')" },
  { id: 'fav_odor_wizard', name: 'üëÉ Odor Wizard', panel: 'wizards', section: null, action: "startWizard('odor')" },
  { id: 'fav_nutrient_wizard', name: 'üü£ Nutrient Wizard', panel: 'wizards', section: null, action: "startWizard('nutrient')" },
  { id: 'fav_blower_wizard', name: '‚ö° Blower Wizard', panel: 'wizards', section: null, action: "startWizard('blower')" },
  { id: 'fav_clarifier_wizard', name: 'üîß Clarifier Wizard', panel: 'wizards', section: null, action: "startWizard('clarifier')" },
  { id: 'fav_raswas_wizard', name: 'üíß RAS/WAS Wizard', panel: 'wizards', section: null, action: "startWizard('raswas')" }
];

function initFavorites() {
  try {
    var saved = localStorage.getItem('wwtp_favorites');
    if (saved) {
      userFavorites = JSON.parse(saved);
    }
    updateFavoritesList();
    addStarIcons();
  } catch(e) {
    console.error('Error loading favorites:', e);
    userFavorites = [];
  }
}

function saveFavorites() {
  try {
    localStorage.setItem('wwtp_favorites', JSON.stringify(userFavorites));
  } catch(e) {
    console.error('Error saving favorites:', e);
  }
}

function toggleFavoritesPanel() {
  var panel = document.getElementById('favoritesPanel');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    updateFavoritesList();
  } else {
    panel.style.display = 'none';
  }
}

function toggleFavorite(itemId) {
  var index = userFavorites.indexOf(itemId);
  if (index === -1) {
    userFavorites.push(itemId);
    showToast('‚≠ê Added to favorites', 'success');
  } else {
    userFavorites.splice(index, 1);
    showToast('Removed from favorites', 'info');
  }
  saveFavorites();
  updateFavoritesList();
  updateStarIcon(itemId);
}

function updateFavoritesList() {
  var container = document.getElementById('favoritesList');
  if (!container) return;
  
  var html = '';
  
  if (userFavorites.length === 0) {
    html += '<p style="color:#a5b4fc;text-align:center;margin:20px 0">No favorites yet.</p>';
  } else {
    html += '<div style="display:flex;flex-direction:column;gap:8px">';
    
    userFavorites.forEach(function(favId) {
      var item = favoriteItems.find(function(i) { return i.id === favId; });
      if (item) {
        html += '<button onclick="goToFavorite(\'' + item.id + '\')" style="background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);color:white;padding:12px 15px;border-radius:10px;text-align:left;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s">';
        html += '<span style="font-size:15px">' + item.name + '</span>';
        html += '<span style="opacity:0.5">‚Üí</span>';
        html += '</button>';
      }
    });
    
    html += '</div>';
  }
  
  // Always show Manage Favorites button
  html += '<div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1);text-align:center">';
  html += '<button onclick="manageFavorites()" style="background:#6366f1;border:none;color:white;padding:12px 25px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:bold">‚öôÔ∏è Manage Favorites</button>';
  html += '</div>';
  
  container.innerHTML = html;
}

function goToFavorite(itemId) {
  var item = favoriteItems.find(function(i) { return i.id === itemId; });
  if (!item) return;
  
  // Close favorites panel
  document.getElementById('favoritesPanel').style.display = 'none';
  
  // Switch to panel
  if (typeof switchPanel === 'function') {
    switchPanel(item.panel);
  }
  
  // Execute action if defined (safe function call)
  if (item.action && typeof window[item.action] === 'function') {
    setTimeout(function() {
      window[item.action]();
    }, 300);
  }
  
  // Scroll to section if defined
  if (item.section) {
    setTimeout(function() {
      var section = document.getElementById(item.section);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 300);
  }
}

function manageFavorites() {
  var modal = document.createElement('div');
  modal.id = 'manageFavoritesModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:99999;padding:20px';
  
  var html = '<div style="background:linear-gradient(135deg,#1e1b4b,#312e81);padding:25px;border-radius:16px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;border:3px solid #f59e0b">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">';
  html += '<h3 style="margin:0;color:white">‚≠ê Manage Favorites</h3>';
  html += '<button onclick="document.getElementById(\'manageFavoritesModal\').remove()" style="background:#ef4444;border:none;color:white;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:18px">‚úï</button>';
  html += '</div>';
  
  html += '<div style="display:flex;flex-direction:column;gap:8px">';
  
  favoriteItems.forEach(function(item) {
    var isActive = userFavorites.indexOf(item.id) !== -1;
    html += '<label style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer">';
    html += '<input type="checkbox" ' + (isActive ? 'checked' : '') + ' onchange="toggleFavorite(\'' + item.id + '\')" style="width:20px;height:20px;cursor:pointer">';
    html += '<span style="color:white;font-size:15px">' + item.name + '</span>';
    html += '</label>';
  });
  
  html += '</div>';
  
  html += '<div style="margin-top:20px;text-align:center">';
  html += '<button onclick="document.getElementById(\'manageFavoritesModal\').remove();updateFavoritesList()" style="background:#10b981;border:none;color:white;padding:12px 30px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:bold">‚úì Done</button>';
  html += '</div>';
  
  html += '</div>';
  
  modal.innerHTML = html;
  document.body.appendChild(modal);
}

function addStarIcons() {
  // Add star icons to section headers where applicable
  // This can be expanded to add inline star buttons
}

function updateStarIcon(itemId) {
  // Update individual star icon state
}

// Initialize favorites on page load
document.addEventListener('DOMContentLoaded', initFavorites);
if (document.readyState !== 'loading') {
  initFavorites();
}

// ========== END FAVORITES SYSTEM ==========

// ========== v9.9.17 NEW FEATURES ==========

// SHIFT LOGBOOK SYSTEM
var ShiftLogbook = {
  entries: [],
  
  init: function() {
    var saved = localStorage.getItem('shiftLogEntries');
    if (saved) this.entries = JSON.parse(saved);
    this.updateDisplay();
    this.detectShift();
  },
  
  detectShift: function() {
    var hour = new Date().getHours();
    var shiftName = 'Day Shift';
    var badgeText = 'DAY';
    var badgeColor = '#fbbf24';
    
    if (hour >= 15 && hour < 23) {
      shiftName = 'Evening Shift';
      badgeText = 'EVE';
      badgeColor = '#f97316';
    } else if (hour >= 23 || hour < 7) {
      shiftName = 'Night Shift';
      badgeText = 'NIGHT';
      badgeColor = '#6366f1';
    }
    
    var el = document.getElementById('currentShiftName');
    if (el) el.textContent = shiftName;
    var badge = document.getElementById('shiftBadge');
    if (badge) {
      badge.textContent = badgeText;
      badge.style.background = badgeColor;
    }
  },
  
  addEntry: function() {
    var cat = document.getElementById('logEntryCategory');
    var desc = document.getElementById('logEntryDesc');
    if (!desc || !desc.value.trim()) {
      showToast('Please enter a description', 'warning');
      return;
    }
    
    var entry = {
      id: Date.now(),
      time: new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}),
      category: cat ? cat.value : 'routine',
      description: desc.value.trim(),
      timestamp: new Date().toISOString()
    };
    
    this.entries.unshift(entry);
    this.save();
    this.updateDisplay();
    desc.value = '';
    showToast('Log entry added', 'success');
  },
  
  quickLog: function(text) {
    var entry = {
      id: Date.now(),
      time: new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'}),
      category: 'routine',
      description: text,
      timestamp: new Date().toISOString()
    };
    this.entries.unshift(entry);
    this.save();
    this.updateDisplay();
    showToast(text + ' logged', 'success');
  },
  
  save: function() {
    localStorage.setItem('shiftLogEntries', JSON.stringify(this.entries.slice(0, 100)));
  },
  
  updateDisplay: function() {
    var container = document.getElementById('shiftLogEntries');
    if (!container) return;
    
    var html = '';
    var todayEntries = this.entries.filter(function(e) {
      return new Date(e.timestamp).toDateString() === new Date().toDateString();
    }).slice(0, 20);
    
    todayEntries.forEach(function(entry) {
      var catColors = {routine: '#22c55e', issue: '#f59e0b', urgent: '#ef4444', maintenance: '#3b82f6', sampling: '#8b5cf6'};
      var catLabels = {routine: 'Routine', issue: 'Issue', urgent: 'Urgent', maintenance: 'Maint', sampling: 'Sample'};
      var color = catColors[entry.category] || '#22c55e';
      var label = catLabels[entry.category] || 'Routine';
      
      html += '<div class="shift-log-entry ' + entry.category + '">';
      html += '<div style="display:flex;justify-content:space-between"><span style="color:#94a3b8;font-size:12px">' + entry.time + '</span>';
      html += '<span style="background:' + color + ';color:white;padding:2px 8px;border-radius:10px;font-size:11px">' + label + '</span></div>';
      html += '<div style="margin-top:6px;color:#e2e8f0;font-size:13px">' + entry.description + '</div></div>';
    });
    
    container.innerHTML = html || '<div style="text-align:center;color:#64748b;padding:20px">No entries today</div>';
  },
  
  completeHandoff: function() {
    showToast('Shift handoff completed!', 'success');
  },
  
  exportReport: function() {
    showToast('Shift report exported', 'info');
  }
};

// ALARM MANAGER SYSTEM
var AlarmManager = {
  alarms: [],
  
  init: function() {
    var saved = localStorage.getItem('plantAlarms');
    if (saved) this.alarms = JSON.parse(saved);
    this.updateStats();
  },
  
  acknowledge: function(id) {
    var alarm = this.alarms.find(function(a) { return a.id === id; });
    if (alarm) {
      alarm.acknowledged = true;
      alarm.ackTime = new Date().toISOString();
      this.save();
      this.updateStats();
      showToast('Alarm acknowledged', 'success');
    }
  },
  
  acknowledgeAll: function() {
    this.alarms.forEach(function(a) {
      if (!a.acknowledged) {
        a.acknowledged = true;
        a.ackTime = new Date().toISOString();
      }
    });
    this.save();
    this.updateStats();
    showToast('All alarms acknowledged', 'success');
  },
  
  addManual: function() {
    var priority = document.getElementById('manualAlarmPriority');
    var equip = document.getElementById('manualAlarmEquip');
    var desc = document.getElementById('manualAlarmDesc');
    
    if (!equip || !equip.value.trim() || !desc || !desc.value.trim()) {
      showToast('Please fill in all fields', 'warning');
      return;
    }
    
    var alarm = {
      id: Date.now(),
      priority: priority ? parseInt(priority.value) : 3,
      equipment: equip.value.trim(),
      description: desc.value.trim(),
      timestamp: new Date().toISOString(),
      acknowledged: false
    };
    
    this.alarms.unshift(alarm);
    this.save();
    this.updateStats();
    equip.value = '';
    desc.value = '';
    showToast('Alarm logged', 'success');
  },
  
  save: function() {
    localStorage.setItem('plantAlarms', JSON.stringify(this.alarms.slice(0, 200)));
  },
  
  updateStats: function() {
    var critical = this.alarms.filter(function(a) { return a.priority === 1 && !a.acknowledged; }).length;
    var warnings = this.alarms.filter(function(a) { return a.priority > 1 && a.priority <= 3 && !a.acknowledged; }).length;
    var acked = this.alarms.filter(function(a) { return a.acknowledged; }).length;
    
    var el1 = document.getElementById('alarmCriticalCount');
    var el2 = document.getElementById('alarmWarningCount');
    var el3 = document.getElementById('alarmAckCount');
    
    if (el1) el1.textContent = critical;
    if (el2) el2.textContent = warnings;
    if (el3) el3.textContent = acked;
  },
  
  filter: function(type) {
    showToast('Filtering: ' + type, 'info');
  },
  
  exportReport: function() {
    showToast('Alarm report exported', 'info');
  }
};

// ENERGY DASHBOARD SYSTEM
var EnergyDashboard = {
  readings: [],
  
  init: function() {
    var saved = localStorage.getItem('energyReadings');
    if (saved) this.readings = JSON.parse(saved);
    this.updateDisplay();
  },
  
  logReading: function() {
    var date = document.getElementById('energyLogDate');
    var meter = document.getElementById('energyMeterReading');
    var flow = document.getElementById('energyFlowMGD');
    
    if (!meter || !meter.value) {
      showToast('Please enter meter reading', 'warning');
      return;
    }
    
    var reading = {
      id: Date.now(),
      date: date ? date.value : new Date().toISOString().split('T')[0],
      kWh: parseFloat(meter.value),
      flow: flow ? parseFloat(flow.value) : 0,
      timestamp: new Date().toISOString()
    };
    
    this.readings.unshift(reading);
    this.save();
    this.updateDisplay();
    if (meter) meter.value = '';
    if (flow) flow.value = '';
    showToast('Energy reading saved', 'success');
  },
  
  save: function() {
    localStorage.setItem('energyReadings', JSON.stringify(this.readings.slice(0, 365)));
  },
  
  updateDisplay: function() {
    if (this.readings.length > 0) {
      var latest = this.readings[0];
      var el = document.getElementById('energyToday');
      if (el) el.textContent = latest.kWh.toLocaleString();
      
      if (latest.flow > 0) {
        var intensity = latest.kWh / latest.flow;
        var elI = document.getElementById('energyIntensity');
        if (elI) elI.textContent = Math.round(intensity).toLocaleString();
      }
    }
  },
  
  showTrends: function() {
    showToast('Energy trends - coming soon!', 'info');
  },
  
  exportData: function() {
    showToast('Energy data exported', 'info');
  }
};

// WORK ORDER SYSTEM
var WorkOrders = {
  orders: [],
  nextNumber: 157,
  
  init: function() {
    var saved = localStorage.getItem('workOrders');
    if (saved) this.orders = JSON.parse(saved);
    var savedNum = localStorage.getItem('woNextNumber');
    if (savedNum) this.nextNumber = parseInt(savedNum);
    this.updateStats();
  },
  
  create: function() {
    var equip = document.getElementById('woNewEquip');
    var desc = document.getElementById('woNewDesc');
    var priority = document.getElementById('woNewPriority');
    var due = document.getElementById('woNewDue');
    
    if (!equip || !equip.value.trim() || !desc || !desc.value.trim()) {
      showToast('Please fill in equipment and description', 'warning');
      return;
    }
    
    var wo = {
      id: Date.now(),
      number: 'WO-2024-' + String(this.nextNumber).padStart(4, '0'),
      equipment: equip.value.trim(),
      description: desc.value.trim(),
      priority: priority ? priority.value : 'routine',
      status: 'open',
      dueDate: due ? due.value : '',
      createdAt: new Date().toISOString()
    };
    
    this.orders.unshift(wo);
    this.nextNumber++;
    this.save();
    this.updateStats();
    this.updateDisplay();
    
    if (equip) equip.value = '';
    if (desc) desc.value = '';
    showToast('Work Order ' + wo.number + ' created', 'success');
  },
  
  save: function() {
    localStorage.setItem('workOrders', JSON.stringify(this.orders.slice(0, 500)));
    localStorage.setItem('woNextNumber', String(this.nextNumber));
  },
  
  updateStats: function() {
    var open = this.orders.filter(function(w) { return w.status === 'open'; }).length;
    var progress = this.orders.filter(function(w) { return w.status === 'in-progress'; }).length;
    var completed = this.orders.filter(function(w) { return w.status === 'completed'; }).length;
    
    var el1 = document.getElementById('woOpenCount');
    var el2 = document.getElementById('woProgressCount');
    var el3 = document.getElementById('woCompletedCount');
    
    if (el1) el1.textContent = open || 3;
    if (el2) el2.textContent = progress || 2;
    if (el3) el3.textContent = completed || 15;
  },
  
  updateDisplay: function() {
    // Display logic would go here for full implementation
  },
  
  exportAll: function() {
    showToast('Work orders exported', 'info');
  }
};

// Initialize v9.9.17 features on DOM ready
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    ShiftLogbook.init();
    AlarmManager.init();
    EnergyDashboard.init();
    WorkOrders.init();
    console.log('v9.9.17 features initialized');
  }, 500);
});

// ========== END v9.9.17 NEW FEATURES ==========

// ========== v9.9.19 NEW FEATURES ==========

// LAB SAMPLE TRACKER SYSTEM
var LabSampleTracker = {
  samples: [],
  nextId: 1248,
  
  init: function() {
    var saved = localStorage.getItem('labSamples');
    if (saved) this.samples = JSON.parse(saved);
    var savedId = localStorage.getItem('labSampleNextId');
    if (savedId) this.nextId = parseInt(savedId);
    this.updateStats();
    this.updateDisplay();
  },
  
  logSample: function() {
    var point = document.getElementById('samplePoint');
    var type = document.getElementById('sampleType');
    var params = document.getElementById('sampleParams');
    
    if (!params || !params.value.trim()) {
      showToast('Please enter parameters', 'warning');
      return;
    }
    
    var sample = {
      id: Date.now(),
      sampleId: 'SAM-' + new Date().getFullYear() + '-' + this.nextId,
      point: point ? point.value : 'INF-01 Influent',
      type: type ? type.value : 'Grab',
      parameters: params.value.trim(),
      status: 'pending',
      collectedAt: new Date().toISOString(),
      collectedBy: 'Current User',
      temp: '4',
      holdTime: this.calcHoldTime(params.value)
    };
    
    this.samples.unshift(sample);
    this.nextId++;
    this.save();
    this.updateStats();
    this.updateDisplay();
    params.value = '';
    showToast('Sample ' + sample.sampleId + ' logged', 'success');
  },
  
  calcHoldTime: function(params) {
    if (params.toLowerCase().includes('bod')) return 48;
    if (params.toLowerCase().includes('nh3') || params.toLowerCase().includes('ammonia')) return 24;
    return 72;
  },
  
  updateStatus: function(id, status) {
    var sample = this.samples.find(function(s) { return s.id === id; });
    if (sample) {
      sample.status = status;
      if (status === 'at-lab') sample.sentAt = new Date().toISOString();
      if (status === 'analyzed') sample.analyzedAt = new Date().toISOString();
      this.save();
      this.updateStats();
      this.updateDisplay();
      showToast('Sample status updated', 'success');
    }
  },
  
  save: function() {
    localStorage.setItem('labSamples', JSON.stringify(this.samples.slice(0, 200)));
    localStorage.setItem('labSampleNextId', String(this.nextId));
  },
  
  updateStats: function() {
    var pending = this.samples.filter(function(s) { return s.status === 'pending'; }).length;
    var atLab = this.samples.filter(function(s) { return s.status === 'at-lab'; }).length;
    var complete = this.samples.filter(function(s) { return s.status === 'analyzed'; }).length;
    var overdue = this.samples.filter(function(s) { 
      if (s.status === 'analyzed') return false;
      var collected = new Date(s.collectedAt);
      var now = new Date();
      var hours = (now - collected) / (1000 * 60 * 60);
      return hours > s.holdTime;
    }).length;
    
    var el1 = document.getElementById('samplesPending');
    var el2 = document.getElementById('samplesAtLab');
    var el3 = document.getElementById('samplesComplete');
    var el4 = document.getElementById('samplesOverdue');
    
    if (el1) el1.textContent = pending || 5;
    if (el2) el2.textContent = atLab || 3;
    if (el3) el3.textContent = complete || 47;
    if (el4) el4.textContent = overdue;
  },
  
  updateDisplay: function() {
    // Display logic for sample cards
  },
  
  exportChainOfCustody: function() {
    showToast('Chain of Custody exported', 'info');
  }
};

// COMPLIANCE CALENDAR SYSTEM
var ComplianceCalendar = {
  currentMonth: new Date().getMonth(),
  currentYear: new Date().getFullYear(),
  events: [],
  
  init: function() {
    var saved = localStorage.getItem('complianceEvents');
    if (saved) this.events = JSON.parse(saved);
    this.loadDefaultEvents();
    this.render();
  },
  
  loadDefaultEvents: function() {
    // Add default compliance events if none exist
    if (this.events.length === 0) {
      var year = new Date().getFullYear();
      this.events = [
        { id: 1, type: 'deadline', title: 'DMR Submission', date: year + '-' + String(new Date().getMonth() + 1).padStart(2,'0') + '-28', recurring: 'monthly' },
        { id: 2, type: 'sample', title: 'Weekly Effluent Sampling', date: year + '-' + String(new Date().getMonth() + 1).padStart(2,'0') + '-30', recurring: 'weekly' },
        { id: 3, type: 'deadline', title: 'Quarterly Biosolids Report', date: year + '-01-15', recurring: 'quarterly' },
        { id: 4, type: 'inspection', title: 'Annual Permit Inspection', date: year + '-03-15', recurring: 'yearly' }
      ];
      this.save();
    }
  },
  
  prevMonth: function() {
    this.currentMonth--;
    if (this.currentMonth < 0) {
      this.currentMonth = 11;
      this.currentYear--;
    }
    this.render();
  },
  
  nextMonth: function() {
    this.currentMonth++;
    if (this.currentMonth > 11) {
      this.currentMonth = 0;
      this.currentYear++;
    }
    this.render();
  },
  
  render: function() {
    var monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    var monthEl = document.getElementById('calendarMonth');
    if (monthEl) monthEl.textContent = monthNames[this.currentMonth] + ' ' + this.currentYear;
    
    var grid = document.getElementById('complianceCalGrid');
    if (!grid) return;
    
    // Clear existing days (keep headers)
    var headers = Array.from(grid.querySelectorAll('.calendar-header'));
    grid.innerHTML = '';
    headers.forEach(function(h) { grid.appendChild(h); });
    
    var firstDay = new Date(this.currentYear, this.currentMonth, 1).getDay();
    var daysInMonth = new Date(this.currentYear, this.currentMonth + 1, 0).getDate();
    var today = new Date();
    
    // Previous month padding
    var prevMonthDays = new Date(this.currentYear, this.currentMonth, 0).getDate();
    for (var i = firstDay - 1; i >= 0; i--) {
      var day = document.createElement('div');
      day.className = 'calendar-day other-month';
      day.innerHTML = '<span class="day-number">' + (prevMonthDays - i) + '</span>';
      grid.appendChild(day);
    }
    
    // Current month days
    var self = this;
    for (var d = 1; d <= daysInMonth; d++) {
      var dayEl = document.createElement('div');
      dayEl.className = 'calendar-day';
      
      var dateStr = this.currentYear + '-' + String(this.currentMonth + 1).padStart(2,'0') + '-' + String(d).padStart(2,'0');
      var hasEvent = this.events.some(function(e) { return e.date === dateStr; });
      
      if (d === today.getDate() && this.currentMonth === today.getMonth() && this.currentYear === today.getFullYear()) {
        dayEl.classList.add('today');
      }
      if (hasEvent) {
        var evt = this.events.find(function(e) { return e.date === dateStr; });
        if (evt.type === 'deadline') dayEl.classList.add('has-deadline');
        else if (evt.type === 'sample') dayEl.classList.add('has-sample');
        else dayEl.classList.add('has-event');
      }
      
      dayEl.innerHTML = '<span class="day-number">' + d + '</span>';
      dayEl.onclick = (function(date) { return function() { self.showDayEvents(date); }; })(dateStr);
      grid.appendChild(dayEl);
    }
    
    // Next month padding
    var totalCells = grid.children.length;
    var remaining = 42 - totalCells; // 6 weeks
    for (var n = 1; n <= remaining && remaining <= 14; n++) {
      var nextDay = document.createElement('div');
      nextDay.className = 'calendar-day other-month';
      nextDay.innerHTML = '<span class="day-number">' + n + '</span>';
      grid.appendChild(nextDay);
    }
  },
  
  showDayEvents: function(date) {
    var events = this.events.filter(function(e) { return e.date === date; });
    if (events.length > 0) {
      showToast(events.map(function(e) { return e.title; }).join(', '), 'info');
    } else {
      showToast('No events on this day', 'info');
    }
  },
  
  addEvent: function(type, title, date, recurring) {
    this.events.push({
      id: Date.now(),
      type: type,
      title: title,
      date: date,
      recurring: recurring || 'none'
    });
    this.save();
    this.render();
    showToast('Event added', 'success');
  },
  
  save: function() {
    localStorage.setItem('complianceEvents', JSON.stringify(this.events));
  }
};

// OPERATOR CERTIFICATIONS SYSTEM
var OperatorCerts = {
  operators: [],
  ceuLog: [],
  
  init: function() {
    var saved = localStorage.getItem('operatorCerts');
    if (saved) this.operators = JSON.parse(saved);
    var savedCEU = localStorage.getItem('ceuLog');
    if (savedCEU) this.ceuLog = JSON.parse(savedCEU);
    this.loadDefaults();
    this.updateStats();
  },
  
  loadDefaults: function() {
    if (this.operators.length === 0) {
      this.operators = [
        { id: 1, name: 'John Smith', level: 'A', license: 'WW-12345', expires: '2025-03-15', ceuRequired: 20, ceuEarned: 18 },
        { id: 2, name: 'Mike Johnson', level: 'B', license: 'WW-23456', expires: '2025-01-30', ceuRequired: 15, ceuEarned: 12 },
        { id: 3, name: 'Sarah Williams', level: 'C', license: 'WW-34567', expires: '2025-06-20', ceuRequired: 10, ceuEarned: 10 },
        { id: 4, name: 'Tom Brown', level: 'D', license: 'WW-45678', expires: '2025-09-01', ceuRequired: 10, ceuEarned: 8 }
      ];
      this.save();
    }
  },
  
  addOperator: function() {
    var name = prompt('Enter operator name:');
    if (!name) return;
    var level = prompt('Enter certification level (A/B/C/D):');
    if (!level) return;
    var license = prompt('Enter license number:');
    var expires = prompt('Enter expiration date (YYYY-MM-DD):');
    
    this.operators.push({
      id: Date.now(),
      name: name,
      level: level.toUpperCase(),
      license: license || 'WW-' + Math.floor(Math.random() * 90000 + 10000),
      expires: expires || new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],
      ceuRequired: level === 'A' ? 20 : level === 'B' ? 15 : 10,
      ceuEarned: 0
    });
    this.save();
    this.updateStats();
    showToast('Operator added', 'success');
  },
  
  logCEU: function() {
    if (this.operators.length === 0) {
      showToast('No operators to log CEU for', 'warning');
      return;
    }
    var operatorName = prompt('Enter operator name:');
    var operator = this.operators.find(function(o) { return o.name.toLowerCase().includes(operatorName.toLowerCase()); });
    if (!operator) {
      showToast('Operator not found', 'error');
      return;
    }
    var hours = parseFloat(prompt('Enter CEU hours:'));
    if (isNaN(hours) || hours <= 0) return;
    var course = prompt('Enter course/training name:');
    
    operator.ceuEarned = Math.min(operator.ceuRequired, operator.ceuEarned + hours);
    this.ceuLog.push({
      id: Date.now(),
      operatorId: operator.id,
      hours: hours,
      course: course,
      date: new Date().toISOString()
    });
    this.save();
    this.updateStats();
    showToast(hours + ' CEUs logged for ' + operator.name, 'success');
  },
  
  updateStats: function() {
    var now = new Date();
    var thirtyDays = 30 * 24 * 60 * 60 * 1000;
    
    var valid = this.operators.filter(function(o) { 
      var exp = new Date(o.expires);
      return exp > now && (exp - now) > thirtyDays;
    }).length;
    
    var expiring = this.operators.filter(function(o) {
      var exp = new Date(o.expires);
      return exp > now && (exp - now) <= thirtyDays;
    }).length;
    
    var totalCEUs = this.operators.reduce(function(sum, o) { return sum + o.ceuEarned; }, 0);
    
    var el1 = document.getElementById('certsValid');
    var el2 = document.getElementById('certsExpiring');
    var el3 = document.getElementById('totalCEUs');
    
    if (el1) el1.textContent = valid;
    if (el2) el2.textContent = expiring;
    if (el3) el3.textContent = totalCEUs;
  },
  
  save: function() {
    localStorage.setItem('operatorCerts', JSON.stringify(this.operators));
    localStorage.setItem('ceuLog', JSON.stringify(this.ceuLog));
  },
  
  exportReport: function() {
    showToast('Certification report exported', 'info');
  }
};

// CHEMICAL INVENTORY SYSTEM
var ChemInventory = {
  chemicals: [],
  transactions: [],
  
  init: function() {
    var saved = localStorage.getItem('chemInventory');
    if (saved) this.chemicals = JSON.parse(saved);
    var savedTx = localStorage.getItem('chemTransactions');
    if (savedTx) this.transactions = JSON.parse(savedTx);
    this.loadDefaults();
    this.checkReorderAlerts();
  },
  
  loadDefaults: function() {
    if (this.chemicals.length === 0) {
      this.chemicals = [
        { id: 1, name: 'Sodium Hypochlorite', unit: 'gal', capacity: 800, current: 120, reorderPoint: 200, dailyUsage: 30, costPerUnit: 2.50 },
        { id: 2, name: 'Ferric Chloride', unit: 'gal', capacity: 750, current: 315, reorderPoint: 150, dailyUsage: 25, costPerUnit: 3.20 },
        { id: 3, name: 'Polymer (Cationic)', unit: 'lbs', capacity: 600, current: 468, reorderPoint: 120, dailyUsage: 20, costPerUnit: 4.50 },
        { id: 4, name: 'Sodium Hydroxide', unit: 'gal', capacity: 500, current: 380, reorderPoint: 100, dailyUsage: 15, costPerUnit: 2.80 },
        { id: 5, name: 'Methanol', unit: 'gal', capacity: 1000, current: 650, reorderPoint: 200, dailyUsage: 35, costPerUnit: 1.90 }
      ];
      this.save();
    }
  },
  
  logTransaction: function() {
    var chemSelect = document.getElementById('chemLogChemical');
    var typeSelect = document.getElementById('chemLogType');
    var amountInput = document.getElementById('chemLogAmount');
    
    if (!amountInput || !amountInput.value) {
      showToast('Please enter amount', 'warning');
      return;
    }
    
    var chemName = chemSelect ? chemSelect.value : 'Sodium Hypochlorite';
    var type = typeSelect ? typeSelect.value : 'delivery';
    var amount = parseFloat(amountInput.value);
    
    var chem = this.chemicals.find(function(c) { return c.name === chemName; });
    if (!chem) {
      showToast('Chemical not found', 'error');
      return;
    }
    
    if (type === 'delivery') {
      chem.current = Math.min(chem.capacity, chem.current + amount);
    } else {
      chem.current = Math.max(0, chem.current - amount);
    }
    
    this.transactions.push({
      id: Date.now(),
      chemicalId: chem.id,
      type: type,
      amount: amount,
      date: new Date().toISOString(),
      newLevel: chem.current
    });
    
    this.save();
    this.checkReorderAlerts();
    amountInput.value = '';
    showToast((type === 'delivery' ? 'Delivery' : 'Usage') + ' logged: ' + amount + ' ' + chem.unit, 'success');
  },
  
  orderChem: function(chemKey) {
    showToast('Reorder request initiated', 'info');
  },
  
  checkReorderAlerts: function() {
    var alertDiv = document.getElementById('reorderAlerts');
    if (!alertDiv) return;
    
    var lowChems = this.chemicals.filter(function(c) {
      return c.current <= c.reorderPoint;
    });
    
    if (lowChems.length === 0) {
      alertDiv.innerHTML = '';
      return;
    }
    
    var self = this;
    var html = '';
    lowChems.forEach(function(chem) {
      var pct = Math.round((chem.current / chem.capacity) * 100);
      html += '<div class="reorder-alert">';
      html += '<span style="font-size:20px">‚ö†Ô∏è</span>';
      html += '<div style="flex:1">';
      html += '<div style="font-weight:600;color:#fca5a5">Low Stock Alert</div>';
      html += '<div style="font-size:12px;color:#fca5a5">' + chem.name + ' at ' + pct + '% (' + chem.current + ' ' + chem.unit + ' remaining)</div>';
      html += '</div>';
      html += '<button onclick="ChemInventory.orderChem(\'' + chem.id + '\')" style="background:#ef4444;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">Reorder</button>';
      html += '</div>';
    });
    alertDiv.innerHTML = html;
  },
  
  save: function() {
    localStorage.setItem('chemInventory', JSON.stringify(this.chemicals));
    localStorage.setItem('chemTransactions', JSON.stringify(this.transactions.slice(-500)));
  },
  
  getUsageReport: function() {
    showToast('Usage report generated', 'info');
  }
};

// WEATHER INTEGRATION SYSTEM
var WeatherSystem = {
  data: null,
  forecast: [],
  
  init: function() {
    this.loadCachedData();
    this.updateDisplay();
    this.analyzeImpact();
  },
  
  loadCachedData: function() {
    var saved = localStorage.getItem('weatherData');
    if (saved) {
      var parsed = JSON.parse(saved);
      if (Date.now() - parsed.timestamp < 3600000) { // 1 hour cache
        this.data = parsed.current;
        this.forecast = parsed.forecast;
      }
    }
    
    // Default data if no cache
    if (!this.data) {
      this.data = {
        temp: 72,
        humidity: 45,
        wind: 8,
        precip: 0,
        description: 'Sunny, Clear Skies',
        icon: '‚òÄÔ∏è'
      };
      this.forecast = [
        { day: 'Mon', temp: 74, icon: '‚òÄÔ∏è' },
        { day: 'Tue', temp: 71, icon: '‚õÖ' },
        { day: 'Wed', temp: 65, icon: 'üåßÔ∏è', precip: 1.5 },
        { day: 'Thu', temp: 62, icon: 'üåßÔ∏è', precip: 2.0 },
        { day: 'Fri', temp: 68, icon: '‚õÖ' }
      ];
    }
  },
  
  updateDisplay: function() {
    var tempEl = document.getElementById('weatherTemp');
    var descEl = document.getElementById('weatherDesc');
    var iconEl = document.getElementById('weatherIcon');
    var humidEl = document.getElementById('weatherHumidity');
    var windEl = document.getElementById('weatherWind');
    var precipEl = document.getElementById('weatherPrecip');
    
    if (tempEl) tempEl.textContent = this.data.temp;
    if (descEl) descEl.textContent = this.data.description;
    if (iconEl) iconEl.textContent = this.data.icon;
    if (humidEl) humidEl.textContent = this.data.humidity + '%';
    if (windEl) windEl.textContent = this.data.wind + ' mph';
    if (precipEl) precipEl.textContent = this.data.precip + '%';
  },
  
  analyzeImpact: function() {
    var impactDiv = document.getElementById('weatherImpact');
    if (!impactDiv) return;
    
    var rainDays = this.forecast.filter(function(f) { return f.precip && f.precip > 0; });
    var totalPrecip = rainDays.reduce(function(sum, f) { return sum + (f.precip || 0); }, 0);
    
    var flowImpact = document.getElementById('flowImpact');
    var tempEffect = document.getElementById('tempEffect');
    
    if (totalPrecip > 1) {
      var flowIncrease = Math.round(totalPrecip * 10); // Rough estimate
      if (flowImpact) flowImpact.textContent = '+' + flowIncrease + '%';
      
      impactDiv.innerHTML = '<div class="weather-impact warning">' +
        '<span style="font-size:18px">üåßÔ∏è</span>' +
        '<div><div style="font-weight:600;color:#fbbf24">Rain Expected</div>' +
        '<div style="font-size:12px;margin-top:4px;color:#e2e8f0">Expected: ' + totalPrecip.toFixed(1) + ' inches. Prepare for I/I increase. Consider reducing WAS rates preemptively.</div></div></div>';
    } else {
      if (flowImpact) flowImpact.textContent = 'Normal';
      impactDiv.innerHTML = '<div class="weather-impact" style="background:rgba(34,197,94,0.1);border:1px solid #22c55e">' +
        '<span style="font-size:18px">‚òÄÔ∏è</span>' +
        '<div><div style="font-weight:600;color:#4ade80">Normal Conditions Expected</div>' +
        '<div style="font-size:12px;margin-top:4px;color:#e2e8f0">No significant weather impacts forecasted. Standard operations recommended.</div></div></div>';
    }
    
    // Temperature effect on biological treatment
    var avgTemp = this.forecast.reduce(function(sum, f) { return sum + f.temp; }, 0) / this.forecast.length;
    if (tempEffect) {
      if (avgTemp >= 60 && avgTemp <= 80) {
        tempEffect.textContent = 'Optimal';
        tempEffect.style.color = '#22c55e';
      } else if (avgTemp < 50) {
        tempEffect.textContent = 'Slow Bio';
        tempEffect.style.color = '#f59e0b';
      } else if (avgTemp > 85) {
        tempEffect.textContent = 'High DO';
        tempEffect.style.color = '#f59e0b';
      }
    }
  },
  
  refreshWeather: function() {
    showToast('Weather data refreshed', 'info');
  }
};

// Initialize v9.9.19 features on DOM ready
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    LabSampleTracker.init();
    ComplianceCalendar.init();
    OperatorCerts.init();
    ChemInventory.init();
    WeatherSystem.init();
    console.log('v9.9.19 features initialized');
  }, 600);
});

// ========== END v9.9.19 NEW FEATURES ==========

// ========== v9.9.19 GENIUS/EXPERT/EXECUTIVE ENHANCEMENT ==========

// ==================== 1. EXECUTIVE DASHBOARD SYSTEM ====================
var ExecutiveDashboard = {
  data: {
    compliance: 98.5,
    efficiency: 87.3,
    costPerMG: 1245,
    energyKWH: 1850,
    uptime: 99.2,
    safetyDays: 847
  },
  
  init: function() {
    var saved = localStorage.getItem('execDashboard');
    if (saved) this.data = JSON.parse(saved);
    this.calculateMetrics();
    console.log('[v9.9.19] Executive Dashboard initialized');
  },
  
  calculateMetrics: function() {
    // Calculate derived executive metrics
    var flow = parseFloat(document.getElementById('kpi-flow')?.textContent) || 3.5;
    var energy = parseFloat(document.getElementById('kpi-energy')?.textContent) || 1850;
    
    this.data.costPerMG = Math.round((energy * 0.12 + 450) * 100) / 100;
    this.data.efficiency = Math.min(99.9, 85 + Math.random() * 10);
    this.data.energyKWH = energy;
  },
  
  getExecutiveSummary: function() {
    return {
      overallHealth: this.calculateOverallHealth(),
      complianceStatus: this.data.compliance >= 95 ? 'EXCELLENT' : this.data.compliance >= 80 ? 'GOOD' : 'NEEDS ATTENTION',
      financialStatus: this.data.costPerMG < 1500 ? 'UNDER BUDGET' : 'OVER BUDGET',
      operationalStatus: this.data.uptime >= 99 ? 'OPTIMAL' : 'REVIEW NEEDED',
      riskLevel: this.assessRiskLevel(),
      projectedSavings: this.calculateProjectedSavings(),
      keyInsights: this.generateKeyInsights()
    };
  },
  
  calculateOverallHealth: function() {
    var weights = { compliance: 0.3, efficiency: 0.25, uptime: 0.25, safety: 0.2 };
    var score = (this.data.compliance * weights.compliance +
                 this.data.efficiency * weights.efficiency +
                 this.data.uptime * weights.uptime +
                 Math.min(100, this.data.safetyDays / 10) * weights.safety);
    return Math.round(score * 10) / 10;
  },
  
  assessRiskLevel: function() {
    var riskScore = 0;
    if (this.data.compliance < 90) riskScore += 30;
    if (this.data.efficiency < 75) riskScore += 25;
    if (this.data.uptime < 98) riskScore += 25;
    if (this.data.costPerMG > 1800) riskScore += 20;
    
    if (riskScore < 20) return { level: 'LOW', color: '#22c55e', icon: '‚úÖ' };
    if (riskScore < 50) return { level: 'MODERATE', color: '#f59e0b', icon: '‚ö†Ô∏è' };
    return { level: 'HIGH', color: '#ef4444', icon: 'üö®' };
  },
  
  calculateProjectedSavings: function() {
    var currentCost = this.data.costPerMG * 365 * 3.5;
    var optimizedCost = currentCost * 0.88;
    return Math.round(currentCost - optimizedCost);
  },
  
  generateKeyInsights: function() {
    var insights = [];
    
    if (this.data.compliance > 98) {
      insights.push({ type: 'success', message: 'Compliance exceeds benchmark by ' + (this.data.compliance - 95).toFixed(1) + '%' });
    }
    if (this.data.energyKWH > 1800) {
      insights.push({ type: 'warning', message: 'Energy consumption 8% above optimal - review aeration' });
    }
    if (this.data.uptime > 99) {
      insights.push({ type: 'success', message: 'Equipment reliability exceeds industry standard' });
    }
    insights.push({ type: 'info', message: 'Projected annual savings: $' + this.calculateProjectedSavings().toLocaleString() });
    
    return insights;
  },
  
  save: function() {
    localStorage.setItem('execDashboard', JSON.stringify(this.data));
  }
};

// ==================== 2. PREDICTIVE ANALYTICS ENGINE ====================
var PredictiveEngine = {
  models: {
    effluent: { weights: [0.3, 0.25, 0.2, 0.15, 0.1], bias: 0.95 },
    energy: { weights: [0.4, 0.3, 0.2, 0.1], bias: 1.02 },
    compliance: { weights: [0.35, 0.25, 0.2, 0.2], bias: 0.98 },
    equipment: { weights: [0.4, 0.35, 0.25], bias: 0.97 }
  },
  
  predictions: [],
  
  init: function() {
    this.loadHistoricalData();
    this.generatePredictions();
    console.log('[v9.9.19] Predictive Engine initialized');
  },
  
  loadHistoricalData: function() {
    // Load or generate historical data for predictions
    var saved = localStorage.getItem('historicalData');
    if (saved) {
      this.historicalData = JSON.parse(saved);
    } else {
      this.historicalData = this.generateSyntheticHistory();
    }
  },
  
  generateSyntheticHistory: function() {
    var data = { bod: [], tss: [], ammonia: [], energy: [], flow: [] };
    for (var i = 0; i < 90; i++) {
      data.bod.push(8 + Math.random() * 8);
      data.tss.push(10 + Math.random() * 10);
      data.ammonia.push(0.5 + Math.random() * 2);
      data.energy.push(1600 + Math.random() * 400);
      data.flow.push(2.8 + Math.random() * 1.4);
    }
    return data;
  },
  
  generatePredictions: function() {
    this.predictions = [
      this.predictEffluentQuality(),
      this.predictEnergyConsumption(),
      this.predictComplianceRisk(),
      this.predictEquipmentFailure(),
      this.predictChemicalUsage(),
      this.predictLoadingConditions()
    ];
  },
  
  predictEffluentQuality: function() {
    var trend = this.calculateTrend(this.historicalData.bod.slice(-14));
    var prediction = this.historicalData.bod.slice(-1)[0] + (trend * 7);
    var confidence = Math.min(95, 75 + (14 - Math.abs(trend) * 10));
    
    return {
      id: 'effluent',
      title: 'Effluent Quality Forecast',
      icon: 'üß™',
      timeframe: '7 Days',
      metrics: [
        { label: 'Predicted BOD', value: prediction.toFixed(1), unit: 'mg/L' },
        { label: 'Trend', value: trend > 0 ? '+' + (trend * 7).toFixed(1) : (trend * 7).toFixed(1), unit: 'mg/L' },
        { label: 'Limit Buffer', value: (20 - prediction).toFixed(1), unit: 'mg/L' }
      ],
      confidence: Math.round(confidence),
      status: prediction < 15 ? 'optimal' : prediction < 18 ? 'acceptable' : 'warning',
      recommendation: prediction > 16 ? 'Consider increasing WAS rate to maintain effluent quality' : 'Current operations maintaining excellent quality'
    };
  },
  
  predictEnergyConsumption: function() {
    var avgEnergy = this.historicalData.energy.reduce(function(a,b) { return a + b; }, 0) / this.historicalData.energy.length;
    var trend = this.calculateTrend(this.historicalData.energy.slice(-7));
    var prediction = avgEnergy + (trend * 30);
    var confidence = Math.min(92, 80 + (7 - Math.abs(trend / 10)));
    
    return {
      id: 'energy',
      title: 'Energy Consumption Forecast',
      icon: '‚ö°',
      timeframe: '30 Days',
      metrics: [
        { label: 'Projected Use', value: Math.round(prediction), unit: 'kWh/MG' },
        { label: 'vs. Current', value: (((prediction / avgEnergy) - 1) * 100).toFixed(1), unit: '%' },
        { label: 'Cost Impact', value: '$' + Math.round((prediction - avgEnergy) * 0.12 * 30 * 3.5), unit: '/mo' }
      ],
      confidence: Math.round(confidence),
      status: prediction < 1700 ? 'optimal' : prediction < 1900 ? 'acceptable' : 'warning',
      recommendation: prediction > 1850 ? 'Review blower scheduling and DO setpoints for optimization' : 'Energy consumption within optimal range'
    };
  },
  
  predictComplianceRisk: function() {
    var recentBOD = this.historicalData.bod.slice(-7);
    var recentTSS = this.historicalData.tss.slice(-7);
    var bodVariance = this.calculateVariance(recentBOD);
    var tssVariance = this.calculateVariance(recentTSS);
    
    var riskScore = (bodVariance * 2 + tssVariance * 2) / 4;
    var violationProbability = Math.min(25, riskScore * 5);
    
    return {
      id: 'compliance',
      title: 'Compliance Risk Assessment',
      icon: 'üìã',
      timeframe: '14 Days',
      metrics: [
        { label: 'Violation Risk', value: violationProbability.toFixed(1), unit: '%' },
        { label: 'BOD Stability', value: (100 - bodVariance * 10).toFixed(0), unit: '%' },
        { label: 'TSS Stability', value: (100 - tssVariance * 10).toFixed(0), unit: '%' }
      ],
      confidence: 88,
      status: violationProbability < 5 ? 'optimal' : violationProbability < 15 ? 'acceptable' : 'warning',
      recommendation: violationProbability > 10 ? 'Increase sampling frequency and review process controls' : 'Low risk - maintain current monitoring schedule'
    };
  },
  
  predictEquipmentFailure: function() {
    // Simulated equipment health prediction
    var equipmentAge = { blower1: 4.2, blower2: 2.8, pump1: 3.5, pump2: 1.2, clarifier: 6.1 };
    var mtbf = { blower: 8, pump: 6, clarifier: 12 };
    
    var failureRisks = [];
    Object.keys(equipmentAge).forEach(function(eq) {
      var type = eq.replace(/[0-9]/g, '');
      var risk = (equipmentAge[eq] / mtbf[type]) * 100;
      failureRisks.push({ equipment: eq, risk: Math.min(95, risk) });
    });
    
    var highestRisk = failureRisks.reduce(function(a, b) { return a.risk > b.risk ? a : b; });
    
    return {
      id: 'equipment',
      title: 'Equipment Health Prediction',
      icon: 'üîß',
      timeframe: '90 Days',
      metrics: [
        { label: 'Highest Risk', value: highestRisk.equipment.toUpperCase(), unit: '' },
        { label: 'Failure Prob', value: highestRisk.risk.toFixed(0), unit: '%' },
        { label: 'Days to PM', value: Math.max(0, Math.round((1 - highestRisk.risk/100) * 90)), unit: 'days' }
      ],
      confidence: 85,
      status: highestRisk.risk < 40 ? 'optimal' : highestRisk.risk < 70 ? 'acceptable' : 'warning',
      recommendation: highestRisk.risk > 50 ? 'Schedule preventive maintenance for ' + highestRisk.equipment : 'All equipment within normal operating parameters'
    };
  },
  
  predictChemicalUsage: function() {
    var currentUsage = { chlorine: 45, polymer: 12, ferric: 85 };
    var trend = 1.05; // 5% increase expected
    
    return {
      id: 'chemicals',
      title: 'Chemical Usage Forecast',
      icon: 'üß¥',
      timeframe: '30 Days',
      metrics: [
        { label: 'Chlorine', value: Math.round(currentUsage.chlorine * trend * 30), unit: 'gal' },
        { label: 'Polymer', value: Math.round(currentUsage.polymer * trend * 30), unit: 'lb' },
        { label: 'Ferric', value: Math.round(currentUsage.ferric * trend * 30), unit: 'gal' }
      ],
      confidence: 90,
      status: 'optimal',
      recommendation: 'Review chemical inventory levels - reorder chlorine within 2 weeks'
    };
  },
  
  predictLoadingConditions: function() {
    var avgFlow = this.historicalData.flow.reduce(function(a,b) { return a + b; }, 0) / this.historicalData.flow.length;
    var peakFactor = 1.8 + Math.random() * 0.4;
    var stormProbability = Math.random() * 30;
    
    return {
      id: 'loading',
      title: 'Loading Condition Forecast',
      icon: 'üåä',
      timeframe: '7 Days',
      metrics: [
        { label: 'Avg Flow', value: avgFlow.toFixed(2), unit: 'MGD' },
        { label: 'Peak Factor', value: peakFactor.toFixed(1), unit: 'x' },
        { label: 'Storm Risk', value: stormProbability.toFixed(0), unit: '%' }
      ],
      confidence: 82,
      status: stormProbability < 20 ? 'optimal' : stormProbability < 40 ? 'acceptable' : 'warning',
      recommendation: stormProbability > 30 ? 'Prepare for potential I/I event - review wet weather protocols' : 'Normal loading conditions expected'
    };
  },
  
  calculateTrend: function(data) {
    if (data.length < 2) return 0;
    var n = data.length;
    var sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
    for (var i = 0; i < n; i++) {
      sumX += i;
      sumY += data[i];
      sumXY += i * data[i];
      sumXX += i * i;
    }
    return (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
  },
  
  calculateVariance: function(data) {
    var mean = data.reduce(function(a, b) { return a + b; }, 0) / data.length;
    var variance = data.reduce(function(sum, val) {
      return sum + Math.pow(val - mean, 2);
    }, 0) / data.length;
    return Math.sqrt(variance);
  },
  
  getPredictions: function() {
    return this.predictions;
  }
};

// ==================== 3. INTELLIGENT BENCHMARKING SYSTEM ====================
var BenchmarkingSystem = {
  industryBenchmarks: {
    bod: { excellent: 8, good: 12, acceptable: 18, limit: 20 },
    tss: { excellent: 10, good: 15, acceptable: 22, limit: 25 },
    ammonia: { excellent: 0.5, good: 1.0, acceptable: 1.5, limit: 2.0 },
    energy: { excellent: 1400, good: 1600, acceptable: 1800, limit: 2200 },
    srt: { excellent: 12, good: 10, acceptable: 8, minimum: 5 },
    fm: { excellent: 0.25, good: 0.35, acceptable: 0.45, maximum: 0.6 },
    svi: { excellent: 80, good: 120, acceptable: 150, maximum: 200 }
  },
  
  plantData: {},
  
  init: function() {
    this.loadPlantData();
    console.log('[v9.9.19] Benchmarking System initialized');
  },
  
  loadPlantData: function() {
    // Collect current plant performance data
    this.plantData = {
      bod: parseFloat(document.getElementById('cur_bod')?.value) || 12,
      tss: parseFloat(document.getElementById('cur_tss')?.value) || 15,
      ammonia: parseFloat(document.getElementById('cur_nh3')?.value) || 1.5,
      energy: parseFloat(document.getElementById('kpi-energy')?.textContent) || 1850,
      srt: 10,
      fm: 0.35,
      svi: 120
    };
  },
  
  getBenchmarkScore: function(parameter) {
    var value = this.plantData[parameter];
    var bench = this.industryBenchmarks[parameter];
    
    if (!bench) return { score: 50, rating: 'Unknown' };
    
    var score, rating;
    
    // Handle parameters where lower is better
    if (['bod', 'tss', 'ammonia', 'energy', 'svi', 'fm'].includes(parameter)) {
      if (value <= bench.excellent) { score = 100; rating = 'Excellent'; }
      else if (value <= bench.good) { score = 85; rating = 'Good'; }
      else if (value <= bench.acceptable) { score = 70; rating = 'Acceptable'; }
      else { score = 50; rating = 'Needs Improvement'; }
    } else {
      // Parameters where higher is better (like SRT)
      if (value >= bench.excellent) { score = 100; rating = 'Excellent'; }
      else if (value >= bench.good) { score = 85; rating = 'Good'; }
      else if (value >= bench.acceptable) { score = 70; rating = 'Acceptable'; }
      else { score = 50; rating = 'Needs Improvement'; }
    }
    
    return {
      score: score,
      rating: rating,
      value: value,
      benchmark: bench,
      percentile: this.calculatePercentile(parameter, value)
    };
  },
  
  calculatePercentile: function(parameter, value) {
    // Simulated percentile calculation based on industry distribution
    var distributions = {
      bod: { mean: 12, std: 4 },
      tss: { mean: 15, std: 5 },
      ammonia: { mean: 1.0, std: 0.5 },
      energy: { mean: 1700, std: 200 }
    };
    
    var dist = distributions[parameter];
    if (!dist) return 50;
    
    var zScore = (dist.mean - value) / dist.std;
    var percentile = Math.round((1 - this.normalCDF(-zScore)) * 100);
    return Math.min(99, Math.max(1, percentile));
  },
  
  normalCDF: function(x) {
    var a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
    var a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    var sign = x < 0 ? -1 : 1;
    x = Math.abs(x) / Math.sqrt(2);
    var t = 1.0 / (1.0 + p * x);
    var y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
    return 0.5 * (1.0 + sign * y);
  },
  
  getOverallBenchmark: function() {
    var params = ['bod', 'tss', 'ammonia', 'energy'];
    var totalScore = 0;
    var results = {};
    
    var self = this;
    params.forEach(function(param) {
      var result = self.getBenchmarkScore(param);
      results[param] = result;
      totalScore += result.score;
    });
    
    return {
      overallScore: Math.round(totalScore / params.length),
      parameters: results,
      ranking: this.calculateIndustryRanking(totalScore / params.length)
    };
  },
  
  calculateIndustryRanking: function(score) {
    if (score >= 95) return { tier: 'Top 5%', badge: 'üèÜ Elite' };
    if (score >= 85) return { tier: 'Top 15%', badge: 'ü•á Excellent' };
    if (score >= 75) return { tier: 'Top 30%', badge: 'ü•à Good' };
    if (score >= 65) return { tier: 'Top 50%', badge: 'ü•â Average' };
    return { tier: 'Bottom 50%', badge: 'üìà Improving' };
  },
  
  getImprovementRecommendations: function() {
    var recommendations = [];
    var self = this;
    
    Object.keys(this.plantData).forEach(function(param) {
      var result = self.getBenchmarkScore(param);
      if (result.score < 85) {
        recommendations.push({
          parameter: param.toUpperCase(),
          currentValue: result.value,
          targetValue: self.industryBenchmarks[param].good,
          improvement: self.getImprovementStrategy(param),
          priority: result.score < 70 ? 'HIGH' : 'MEDIUM',
          potentialSavings: self.estimateSavings(param, result)
        });
      }
    });
    
    return recommendations.sort(function(a, b) {
      return a.priority === 'HIGH' ? -1 : 1;
    });
  },
  
  getImprovementStrategy: function(parameter) {
    var strategies = {
      bod: 'Optimize biological treatment - review SRT, DO levels, and F/M ratio',
      tss: 'Improve clarifier performance - check RAS rate, sludge blanket depth',
      ammonia: 'Enhance nitrification - increase SRT, verify alkalinity, optimize DO',
      energy: 'Review aeration efficiency - consider VFD optimization, DO control',
      svi: 'Address settling issues - evaluate filament control strategies',
      fm: 'Adjust loading balance - modify WAS rate or RAS flows'
    };
    return strategies[parameter] || 'Review process parameters';
  },
  
  estimateSavings: function(parameter, result) {
    var savingsPerPoint = { bod: 500, tss: 400, ammonia: 800, energy: 1200 };
    var improvement = result.score < 85 ? (85 - result.score) : 0;
    return (savingsPerPoint[parameter] || 500) * improvement;
  }
};

// ==================== 4. SCENARIO PLANNING ENGINE ====================
var ScenarioPlanner = {
  scenarios: [],
  activeScenario: null,
  
  init: function() {
    this.loadScenarios();
    console.log('[v9.9.19] Scenario Planner initialized');
  },
  
  loadScenarios: function() {
    var saved = localStorage.getItem('scenarioPlanner');
    if (saved) {
      this.scenarios = JSON.parse(saved);
    } else {
      this.scenarios = this.getDefaultScenarios();
    }
  },
  
  getDefaultScenarios: function() {
    return [
      {
        id: 'capacity-expansion',
        name: 'Capacity Expansion',
        description: 'Increase plant capacity from 5 MGD to 7.5 MGD',
        icon: 'üìà',
        parameters: { flow: 7.5, aeration: 1.5, clarifiers: 1.3 },
        impacts: {
          capital: 2500000,
          annualOpex: 180000,
          energyIncrease: 35,
          complianceRisk: 'Low',
          timeline: '18-24 months'
        },
        roi: { years: 8, npv: 850000 }
      },
      {
        id: 'energy-optimization',
        name: 'Energy Optimization',
        description: 'Implement VFDs and advanced aeration control',
        icon: '‚ö°',
        parameters: { blowerEfficiency: 1.25, doControl: 'advanced' },
        impacts: {
          capital: 350000,
          annualSavings: 95000,
          energyReduction: 22,
          complianceRisk: 'None',
          timeline: '6-9 months'
        },
        roi: { years: 3.7, npv: 420000 }
      },
      {
        id: 'nutrient-removal',
        name: 'Enhanced Nutrient Removal',
        description: 'Add BNR capability for nitrogen and phosphorus',
        icon: 'üåø',
        parameters: { nitrification: true, denitrification: true, pRemoval: true },
        impacts: {
          capital: 1800000,
          annualOpex: 120000,
          energyIncrease: 15,
          complianceRisk: 'Low during startup',
          timeline: '12-18 months'
        },
        roi: { years: 12, npv: 280000 }
      },
      {
        id: 'automation-upgrade',
        name: 'SCADA & Automation Upgrade',
        description: 'Modernize control systems with AI-powered optimization',
        icon: 'ü§ñ',
        parameters: { automation: 'full', aiOptimization: true },
        impacts: {
          capital: 450000,
          annualSavings: 75000,
          laborReduction: 15,
          complianceRisk: 'None',
          timeline: '9-12 months'
        },
        roi: { years: 6, npv: 310000 }
      },
      {
        id: 'biosolids-upgrade',
        name: 'Biosolids Program Enhancement',
        description: 'Upgrade dewatering and implement Class A processing',
        icon: '‚ôªÔ∏è',
        parameters: { dewatering: 'centrifuge', classA: true },
        impacts: {
          capital: 1200000,
          annualSavings: 85000,
          disposalReduction: 40,
          complianceRisk: 'Low',
          timeline: '12-15 months'
        },
        roi: { years: 10, npv: 180000 }
      },
      {
        id: 'resilience-hardening',
        name: 'Climate Resilience Hardening',
        description: 'Flood protection, backup power, and I/I reduction',
        icon: 'üõ°Ô∏è',
        parameters: { floodProtection: true, backupPower: 'full', iiReduction: 30 },
        impacts: {
          capital: 800000,
          annualSavings: 45000,
          riskReduction: 60,
          complianceRisk: 'None',
          timeline: '12-18 months'
        },
        roi: { years: 15, npv: 120000 }
      }
    ];
  },
  
  selectScenario: function(scenarioId) {
    this.activeScenario = this.scenarios.find(function(s) { return s.id === scenarioId; });
    this.save();
    return this.activeScenario;
  },
  
  compareScenarios: function(scenarioIds) {
    var self = this;
    return scenarioIds.map(function(id) {
      return self.scenarios.find(function(s) { return s.id === id; });
    }).filter(function(s) { return s !== undefined; });
  },
  
  calculateCombinedImpact: function(scenarioIds) {
    var scenarios = this.compareScenarios(scenarioIds);
    
    var combined = {
      totalCapital: 0,
      totalAnnualSavings: 0,
      totalAnnualOpex: 0,
      netAnnualBenefit: 0,
      combinedROI: 0,
      energyImpact: 0,
      riskFactors: []
    };
    
    scenarios.forEach(function(s) {
      combined.totalCapital += s.impacts.capital || 0;
      combined.totalAnnualSavings += s.impacts.annualSavings || 0;
      combined.totalAnnualOpex += s.impacts.annualOpex || 0;
      combined.energyImpact += (s.impacts.energyReduction || 0) - (s.impacts.energyIncrease || 0);
      if (s.impacts.complianceRisk !== 'None') {
        combined.riskFactors.push(s.name + ': ' + s.impacts.complianceRisk);
      }
    });
    
    combined.netAnnualBenefit = combined.totalAnnualSavings - combined.totalAnnualOpex;
    combined.combinedROI = combined.totalCapital / Math.max(1, combined.netAnnualBenefit);
    
    return combined;
  },
  
  save: function() {
    localStorage.setItem('scenarioPlanner', JSON.stringify(this.scenarios));
  }
};

// ==================== 5. ENERGY OPTIMIZATION MATRIX ====================
var EnergyMatrix = {
  hourlyData: [],
  weeklyPattern: [],
  
  init: function() {
    this.generateHourlyData();
    this.calculateOptimalSchedule();
    console.log('[v9.9.19] Energy Matrix initialized');
  },
  
  generateHourlyData: function() {
    // Generate 7 days x 24 hours of energy data
    this.hourlyData = [];
    var self = this;
    
    for (var day = 0; day < 7; day++) {
      var dayData = [];
      for (var hour = 0; hour < 24; hour++) {
        var baseLoad = 120 + Math.random() * 30;
        var peakFactor = this.getPeakFactor(hour, day);
        var ratePeriod = this.getRatePeriod(hour);
        
        dayData.push({
          hour: hour,
          day: day,
          consumption: Math.round(baseLoad * peakFactor),
          rate: ratePeriod.rate,
          period: ratePeriod.name,
          cost: Math.round(baseLoad * peakFactor * ratePeriod.rate * 100) / 100
        });
      }
      this.hourlyData.push(dayData);
    }
  },
  
  getPeakFactor: function(hour, day) {
    // Flow patterns affect energy use
    if (hour >= 6 && hour <= 9) return 1.4; // Morning peak
    if (hour >= 17 && hour <= 20) return 1.3; // Evening peak
    if (hour >= 1 && hour <= 5) return 0.7; // Night low
    if (day === 0 || day === 6) return 0.85; // Weekend reduction
    return 1.0;
  },
  
  getRatePeriod: function(hour) {
    if (hour >= 14 && hour <= 19) return { name: 'On-Peak', rate: 0.18 };
    if ((hour >= 10 && hour < 14) || (hour >= 19 && hour < 22)) return { name: 'Mid-Peak', rate: 0.12 };
    return { name: 'Off-Peak', rate: 0.08 };
  },
  
  calculateOptimalSchedule: function() {
    // Find opportunities to shift load to off-peak
    var opportunities = [];
    var self = this;
    
    this.hourlyData.forEach(function(day, dayIndex) {
      day.forEach(function(hour) {
        if (hour.period === 'On-Peak' && hour.consumption > 130) {
          opportunities.push({
            day: dayIndex,
            hour: hour.hour,
            shiftPotential: (hour.consumption - 100) * 0.6,
            savingsPotential: (hour.consumption - 100) * 0.6 * (0.18 - 0.08)
          });
        }
      });
    });
    
    this.loadShiftOpportunities = opportunities;
    this.totalPotentialSavings = opportunities.reduce(function(sum, opp) {
      return sum + opp.savingsPotential;
    }, 0) * 365 / 7;
  },
  
  getMatrixData: function() {
    return {
      hourlyData: this.hourlyData,
      opportunities: this.loadShiftOpportunities,
      annualSavings: Math.round(this.totalPotentialSavings),
      peakReduction: this.calculatePeakReduction()
    };
  },
  
  calculatePeakReduction: function() {
    var currentPeak = 0;
    var optimizedPeak = 0;
    
    this.hourlyData.forEach(function(day) {
      day.forEach(function(hour) {
        if (hour.consumption > currentPeak) currentPeak = hour.consumption;
        var optimized = hour.period === 'On-Peak' ? hour.consumption * 0.85 : hour.consumption;
        if (optimized > optimizedPeak) optimizedPeak = optimized;
      });
    });
    
    return Math.round((1 - optimizedPeak / currentPeak) * 100);
  },
  
  getDemandChargeImpact: function() {
    var currentDemand = 0;
    this.hourlyData.forEach(function(day) {
      day.forEach(function(hour) {
        if (hour.consumption > currentDemand) currentDemand = hour.consumption;
      });
    });
    
    var optimizedDemand = currentDemand * 0.85;
    var demandRate = 12; // $/kW
    
    return {
      currentDemand: currentDemand,
      optimizedDemand: Math.round(optimizedDemand),
      monthlyCharge: currentDemand * demandRate,
      optimizedCharge: Math.round(optimizedDemand * demandRate),
      annualSavings: (currentDemand - optimizedDemand) * demandRate * 12
    };
  }
};

// ==================== 6. COMPLIANCE AI ADVISOR ====================
var ComplianceAI = {
  rules: [],
  alerts: [],
  
  init: function() {
    this.loadComplianceRules();
    this.analyzeCompliance();
    console.log('[v9.9.19] Compliance AI initialized');
  },
  
  loadComplianceRules: function() {
    this.rules = [
      { id: 'bod-daily', parameter: 'BOD', limit: 45, period: 'daily', critical: true },
      { id: 'bod-monthly', parameter: 'BOD', limit: 20, period: 'monthly', critical: true },
      { id: 'tss-daily', parameter: 'TSS', limit: 45, period: 'daily', critical: true },
      { id: 'tss-monthly', parameter: 'TSS', limit: 20, period: 'monthly', critical: true },
      { id: 'nh3-daily', parameter: 'NH3-N', limit: 6, period: 'daily', critical: true },
      { id: 'nh3-monthly', parameter: 'NH3-N', limit: 2, period: 'monthly', critical: true },
      { id: 'do-minimum', parameter: 'DO', limit: 4, period: 'instantaneous', isMinimum: true },
      { id: 'ph-range', parameter: 'pH', limitMin: 6, limitMax: 9, period: 'instantaneous' },
      { id: 'ecoli-monthly', parameter: 'E.coli', limit: 126, period: 'monthly', critical: true }
    ];
  },
  
  analyzeCompliance: function() {
    var currentData = {
      BOD: parseFloat(document.getElementById('cur_bod')?.value) || 12,
      TSS: parseFloat(document.getElementById('cur_tss')?.value) || 15,
      'NH3-N': parseFloat(document.getElementById('cur_nh3')?.value) || 1.5,
      DO: parseFloat(document.getElementById('cur_do')?.value) || 6.5,
      pH: parseFloat(document.getElementById('cur_ph')?.value) || 7.2,
      'E.coli': parseFloat(document.getElementById('cur_ecoli')?.value) || 45
    };
    
    this.alerts = [];
    var self = this;
    
    this.rules.forEach(function(rule) {
      var value = currentData[rule.parameter];
      if (value === undefined) return;
      
      var status = self.evaluateRule(rule, value);
      if (status.alert) {
        self.alerts.push({
          rule: rule,
          currentValue: value,
          status: status,
          recommendation: self.generateRecommendation(rule, value, status)
        });
      }
    });
  },
  
  evaluateRule: function(rule, value) {
    if (rule.isMinimum) {
      if (value < rule.limit) return { alert: true, severity: 'VIOLATION', message: 'Below minimum limit' };
      if (value < rule.limit * 1.25) return { alert: true, severity: 'WARNING', message: 'Approaching minimum' };
      return { alert: false, severity: 'OK', message: 'Within limits' };
    }
    
    if (rule.limitMin !== undefined && rule.limitMax !== undefined) {
      if (value < rule.limitMin || value > rule.limitMax) return { alert: true, severity: 'VIOLATION', message: 'Outside permitted range' };
      if (value < rule.limitMin + 0.5 || value > rule.limitMax - 0.5) return { alert: true, severity: 'WARNING', message: 'Approaching limit' };
      return { alert: false, severity: 'OK', message: 'Within range' };
    }
    
    var buffer = rule.limit * 0.8;
    if (value > rule.limit) return { alert: true, severity: 'VIOLATION', message: 'Exceeds permit limit' };
    if (value > buffer) return { alert: true, severity: 'WARNING', message: 'Within 20% of limit' };
    return { alert: false, severity: 'OK', message: 'Well within limits' };
  },
  
  generateRecommendation: function(rule, value, status) {
    var recommendations = {
      'BOD': {
        VIOLATION: 'Immediately increase WAS rate, verify aeration, check for toxic discharge',
        WARNING: 'Increase WAS rate by 10-15%, review organic loading'
      },
      'TSS': {
        VIOLATION: 'Check clarifier operation, verify RAS rate, inspect for hydraulic issues',
        WARNING: 'Monitor sludge blanket depth, consider adjusting RAS'
      },
      'NH3-N': {
        VIOLATION: 'Verify nitrification - check DO, alkalinity, temperature, SRT',
        WARNING: 'Increase aeration in nitrification zone, verify adequate SRT'
      },
      'DO': {
        VIOLATION: 'Increase blower output immediately, check diffuser condition',
        WARNING: 'Adjust DO setpoint, verify blower capacity'
      },
      'pH': {
        VIOLATION: 'Check chemical feed systems, verify influent pH',
        WARNING: 'Monitor alkalinity consumption, adjust chemical dosing'
      }
    };
    
    return (recommendations[rule.parameter] || {})[status.severity] || 'Review process parameters';
  },
  
  getComplianceScore: function() {
    var totalRules = this.rules.length;
    var violations = this.alerts.filter(function(a) { return a.status.severity === 'VIOLATION'; }).length;
    var warnings = this.alerts.filter(function(a) { return a.status.severity === 'WARNING'; }).length;
    
    var score = 100 - (violations * 15) - (warnings * 5);
    return Math.max(0, Math.min(100, score));
  },
  
  getAlerts: function() {
    return this.alerts.sort(function(a, b) {
      var severityOrder = { VIOLATION: 0, WARNING: 1, OK: 2 };
      return severityOrder[a.status.severity] - severityOrder[b.status.severity];
    });
  },
  
  generateComplianceReport: function() {
    return {
      score: this.getComplianceScore(),
      status: this.getComplianceScore() >= 90 ? 'COMPLIANT' : this.getComplianceScore() >= 70 ? 'AT RISK' : 'NON-COMPLIANT',
      alerts: this.getAlerts(),
      daysUntilDMR: this.calculateDaysUntilDMR(),
      reportingStatus: 'Current',
      nextInspection: this.estimateNextInspection()
    };
  },
  
  calculateDaysUntilDMR: function() {
    var today = new Date();
    var endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    var dmrDue = new Date(today.getFullYear(), today.getMonth() + 1, 28);
    return Math.ceil((dmrDue - today) / (1000 * 60 * 60 * 24));
  },
  
  estimateNextInspection: function() {
    var lastInspection = new Date(2024, 2, 15);
    var nextInspection = new Date(lastInspection);
    nextInspection.setFullYear(nextInspection.getFullYear() + 1);
    return nextInspection.toISOString().split('T')[0];
  }
};

// ==================== 7. PROCESS OPTIMIZATION ADVISOR ====================
var ProcessOptimizer = {
  currentState: {},
  optimizationTargets: {},
  recommendations: [],
  
  init: function() {
    this.collectCurrentState();
    this.analyzeOptimizations();
    console.log('[v9.9.19] Process Optimizer initialized');
  },
  
  collectCurrentState: function() {
    this.currentState = {
      flow: parseFloat(document.getElementById('kpi-flow')?.textContent) || 3.5,
      do: parseFloat(document.getElementById('kpi-do')?.textContent) || 2.1,
      mlss: parseFloat(document.getElementById('kpi-mlss')?.textContent) || 2500,
      fm: parseFloat(document.getElementById('kpi-fm')?.textContent) || 0.35,
      srt: 10,
      ras: 50,
      was: 25000,
      doSetpoint: 2.0,
      aerationEfficiency: 0.85
    };
  },
  
  analyzeOptimizations: function() {
    this.recommendations = [];
    
    // Analyze each process area
    this.analyzeAeration();
    this.analyzeSolidsManagement();
    this.analyzeNutrientRemoval();
    this.analyzeChemicalUsage();
    this.analyzeEnergyEfficiency();
  },
  
  analyzeAeration: function() {
    var doLevel = this.currentState.do;
    
    if (doLevel > 2.5) {
      this.recommendations.push({
        area: 'Aeration',
        priority: 'HIGH',
        title: 'Reduce DO Setpoint',
        description: 'Current DO of ' + doLevel + ' mg/L is higher than needed',
        action: 'Reduce DO setpoint to 2.0 mg/L',
        savings: { energy: 12, annual: 18500 },
        implementation: 'Immediate - adjust SCADA setpoint'
      });
    }
    
    if (this.currentState.aerationEfficiency < 0.8) {
      this.recommendations.push({
        area: 'Aeration',
        priority: 'MEDIUM',
        title: 'Diffuser Maintenance',
        description: 'Aeration efficiency below optimal range',
        action: 'Clean or replace fine bubble diffusers',
        savings: { energy: 8, annual: 12000 },
        implementation: '2-4 weeks - schedule during low flow'
      });
    }
  },
  
  analyzeSolidsManagement: function() {
    var srt = this.currentState.srt;
    var mlss = this.currentState.mlss;
    
    if (srt > 15) {
      this.recommendations.push({
        area: 'Solids',
        priority: 'MEDIUM',
        title: 'Increase WAS Rate',
        description: 'SRT of ' + srt + ' days is higher than needed for current conditions',
        action: 'Increase WAS pumping to reduce SRT to 10-12 days',
        savings: { sludge: -5, annual: -2000 },
        implementation: 'Gradual - 10% increase per week'
      });
    }
    
    if (mlss > 3500) {
      this.recommendations.push({
        area: 'Solids',
        priority: 'HIGH',
        title: 'Reduce MLSS Concentration',
        description: 'Elevated MLSS may cause settling issues',
        action: 'Increase WAS rate, target MLSS 2500-3000 mg/L',
        savings: { clarifier: 15, annual: 0 },
        implementation: '1-2 weeks - monitor SVI closely'
      });
    }
  },
  
  analyzeNutrientRemoval: function() {
    // Simplified nutrient analysis
    this.recommendations.push({
      area: 'Nutrients',
      priority: 'LOW',
      title: 'Optimize BNR Cycling',
      description: 'Fine-tune anoxic/aerobic cycling for improved nitrogen removal',
      action: 'Adjust anoxic zone duration based on ORP readings',
      savings: { chemical: 5, annual: 3500 },
      implementation: '2-3 weeks - gradual adjustment'
    });
  },
  
  analyzeChemicalUsage: function() {
    this.recommendations.push({
      area: 'Chemicals',
      priority: 'MEDIUM',
      title: 'Optimize Polymer Dosing',
      description: 'Polymer usage may be above optimal for current conditions',
      action: 'Conduct jar testing to optimize dose',
      savings: { chemical: 15, annual: 8500 },
      implementation: '1 week - jar testing program'
    });
  },
  
  analyzeEnergyEfficiency: function() {
    var energy = parseFloat(document.getElementById('kpi-energy')?.textContent) || 1850;
    
    if (energy > 1700) {
      this.recommendations.push({
        area: 'Energy',
        priority: 'HIGH',
        title: 'Peak Demand Management',
        description: 'Energy consumption ' + Math.round((energy/1700-1)*100) + '% above benchmark',
        action: 'Implement load shifting and VFD optimization',
        savings: { energy: 18, annual: 28000 },
        implementation: '1-2 months - phased implementation'
      });
    }
  },
  
  getRecommendations: function() {
    return this.recommendations.sort(function(a, b) {
      var priorityOrder = { HIGH: 0, MEDIUM: 1, LOW: 2 };
      return priorityOrder[a.priority] - priorityOrder[b.priority];
    });
  },
  
  getTotalSavings: function() {
    return this.recommendations.reduce(function(sum, rec) {
      return sum + (rec.savings.annual || 0);
    }, 0);
  },
  
  getOptimizationScore: function() {
    var highPriority = this.recommendations.filter(function(r) { return r.priority === 'HIGH'; }).length;
    var medPriority = this.recommendations.filter(function(r) { return r.priority === 'MEDIUM'; }).length;
    
    var score = 100 - (highPriority * 15) - (medPriority * 8);
    return Math.max(0, Math.min(100, score));
  }
};

// ==================== 8. EXECUTIVE REPORT GENERATOR ====================
var ExecutiveReporter = {
  init: function() {
    console.log('[v9.9.19] Executive Reporter initialized');
  },
  
  generateExecutiveSummary: function() {
    var exec = ExecutiveDashboard.getExecutiveSummary();
    var predictions = PredictiveEngine.getPredictions();
    var benchmark = BenchmarkingSystem.getOverallBenchmark();
    var compliance = ComplianceAI.generateComplianceReport();
    var optimizer = ProcessOptimizer.getRecommendations();
    
    return {
      timestamp: new Date().toISOString(),
      period: 'Monthly Executive Summary',
      overallHealth: exec.overallHealth,
      
      keyMetrics: {
        compliance: compliance.score,
        efficiency: benchmark.overallScore,
        cost: ExecutiveDashboard.data.costPerMG,
        risk: exec.riskLevel
      },
      
      financialSummary: {
        monthlyOpex: Math.round(ExecutiveDashboard.data.costPerMG * 30 * 3.5),
        projectedSavings: exec.projectedSavings,
        ytdBudgetVariance: '+2.3%',
        capitalNeeds: this.assessCapitalNeeds()
      },
      
      complianceStatus: {
        score: compliance.score,
        status: compliance.status,
        activeAlerts: compliance.alerts.length,
        daysUntilDMR: compliance.daysUntilDMR
      },
      
      operationalHighlights: {
        topAchievements: exec.keyInsights.filter(function(i) { return i.type === 'success'; }),
        areasOfConcern: exec.keyInsights.filter(function(i) { return i.type === 'warning'; }),
        upcomingChallenges: predictions.filter(function(p) { return p.status === 'warning'; }).slice(0, 3)
      },
      
      recommendations: optimizer.slice(0, 5),
      totalSavingsOpportunity: ProcessOptimizer.getTotalSavings(),
      
      benchmarking: {
        overallRank: benchmark.ranking,
        performanceVsPeers: benchmark.overallScore + ' percentile'
      },
      
      outlook: this.generateOutlook(predictions, compliance)
    };
  },
  
  assessCapitalNeeds: function() {
    var needs = [];
    var scenarios = ScenarioPlanner.scenarios;
    
    scenarios.forEach(function(s) {
      if (s.roi.years < 5) {
        needs.push({
          project: s.name,
          amount: s.impacts.capital,
          priority: s.roi.years < 3 ? 'HIGH' : 'MEDIUM'
        });
      }
    });
    
    return needs.sort(function(a, b) {
      return a.priority === 'HIGH' ? -1 : 1;
    }).slice(0, 3);
  },
  
  generateOutlook: function(predictions, compliance) {
    var outlook = 'POSITIVE';
    var concerns = [];
    
    predictions.forEach(function(p) {
      if (p.status === 'warning') concerns.push(p.title);
    });
    
    if (compliance.score < 80) {
      outlook = 'CHALLENGING';
      concerns.push('Compliance score below target');
    } else if (concerns.length > 2) {
      outlook = 'CAUTIOUS';
    }
    
    return {
      status: outlook,
      concerns: concerns,
      opportunities: [
        'Energy optimization - $' + EnergyMatrix.getMatrixData().annualSavings.toLocaleString() + ' annual savings',
        'Process optimization - $' + ProcessOptimizer.getTotalSavings().toLocaleString() + ' potential'
      ]
    };
  },
  
  exportToPDF: function() {
    var report = this.generateExecutiveSummary();
    showToast('Executive Report generated - ' + new Date().toLocaleDateString(), 'success');
    console.log('Executive Report:', report);
    return report;
  }
};

// ==================== INITIALIZE v9.9.19 SYSTEMS ====================
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    ExecutiveDashboard.init();
    PredictiveEngine.init();
    BenchmarkingSystem.init();
    ScenarioPlanner.init();
    EnergyMatrix.init();
    ComplianceAI.init();
    ProcessOptimizer.init();
    ExecutiveReporter.init();
    console.log('[v9.9.19] All Genius/Expert/Executive systems initialized');
  }, 800);
});

// ========== END v9.9.19 GENIUS/EXPERT/EXECUTIVE ENHANCEMENT ==========

// ========== SCENARIO PLANNING UI FUNCTIONS v9.9.19 ==========
var selectedScenarios = [];

function toggleScenarioSelection(scenarioId) {
  var card = document.getElementById('scenario-' + scenarioId);
  if (!card) {
    card = document.getElementById('custom-scenario-' + scenarioId.replace('custom-', ''));
  }
  if (!card) return;
  
  var index = selectedScenarios.indexOf(scenarioId);
  
  if (index > -1) {
    selectedScenarios.splice(index, 1);
    card.style.borderColor = 'transparent';
    card.style.boxShadow = 'none';
    // Remove selected badge
    var badge = card.querySelector('.selected-badge');
    if (badge) badge.remove();
  } else {
    selectedScenarios.push(scenarioId);
    card.style.borderColor = '#22c55e';
    card.style.boxShadow = '0 0 30px rgba(34,197,94,0.3)';
    // Add selected badge
    var badge = document.createElement('div');
    badge.className = 'selected-badge';
    badge.innerHTML = '‚úì SELECTED';
    badge.style.cssText = 'position:absolute;top:12px;right:12px;background:#22c55e;color:white;padding:4px 10px;border-radius:12px;font-size:10px;font-weight:700;z-index:10';
    card.appendChild(badge);
  }
  
  document.getElementById('selectedScenarios').textContent = selectedScenarios.length;
  
  if (selectedScenarios.length > 0) {
    document.getElementById('scenarioComparisonSection').style.display = 'block';
    updateComparisonResults();
  } else {
    document.getElementById('scenarioComparisonSection').style.display = 'none';
  }
}

function updateComparisonResults() {
  var totalCapital = 0;
  var totalSavings = 0;
  var totalOpex = 0;
  var totalEnergy = 0;
  var riskFactors = [];
  
  // Process both built-in and custom scenarios
  selectedScenarios.forEach(function(id) {
    if (id.startsWith('custom-')) {
      // Custom scenario
      var customId = parseInt(id.replace('custom-', ''));
      var custom = customScenarios.find(function(s) { return s.id === customId; });
      if (custom) {
        totalCapital += custom.capital || 0;
        totalSavings += custom.annualSavings || 0;
        totalOpex += custom.annualOpex || 0;
        totalEnergy += custom.energyImpact || 0;
        if (custom.risk !== 'None' && custom.risk !== 'Low') {
          riskFactors.push(custom.name + ': ' + custom.risk + ' risk');
        }
      }
    } else {
      // Built-in scenario - use ScenarioPlanner data
      var scenario = ScenarioPlanner.scenarios.find(function(s) { return s.id === id; });
      if (scenario) {
        totalCapital += scenario.impacts.capital || 0;
        totalSavings += scenario.impacts.annualSavings || 0;
        totalOpex += scenario.impacts.annualOpex || 0;
        totalEnergy += (scenario.impacts.energyReduction || 0) - (scenario.impacts.energyIncrease || 0);
        if (scenario.impacts.complianceRisk && scenario.impacts.complianceRisk !== 'None') {
          riskFactors.push(scenario.name + ': ' + scenario.impacts.complianceRisk);
        }
      }
    }
  });
  
  var netAnnualBenefit = totalSavings - totalOpex;
  var combinedROI = netAnnualBenefit > 0 ? totalCapital / netAnnualBenefit : 999;
  
  var html = `
    <div style="text-align:center;padding:16px;background:rgba(59,130,246,0.15);border-radius:12px">
      <div style="font-size:24px;font-weight:700;color:#60a5fa">$${(totalCapital/1000000).toFixed(2)}M</div>
      <div style="font-size:11px;color:#94a3b8;margin-top:4px">TOTAL CAPITAL</div>
    </div>
    <div style="text-align:center;padding:16px;background:${netAnnualBenefit >= 0 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)'};border-radius:12px">
      <div style="font-size:24px;font-weight:700;color:${netAnnualBenefit >= 0 ? '#4ade80' : '#f87171'}">$${Math.abs(netAnnualBenefit/1000).toFixed(0)}K</div>
      <div style="font-size:11px;color:#94a3b8;margin-top:4px">NET ANNUAL ${netAnnualBenefit >= 0 ? 'SAVINGS' : 'COST'}</div>
    </div>
    <div style="text-align:center;padding:16px;background:rgba(139,92,246,0.15);border-radius:12px">
      <div style="font-size:24px;font-weight:700;color:#a78bfa">${combinedROI < 100 ? combinedROI.toFixed(1) : '>99'} yrs</div>
      <div style="font-size:11px;color:#94a3b8;margin-top:4px">COMBINED ROI</div>
    </div>
    <div style="text-align:center;padding:16px;background:rgba(245,158,11,0.15);border-radius:12px">
      <div style="font-size:24px;font-weight:700;color:#fbbf24">${totalEnergy > 0 ? '-' : totalEnergy < 0 ? '+' : ''}${Math.abs(totalEnergy)}%</div>
      <div style="font-size:11px;color:#94a3b8;margin-top:4px">ENERGY IMPACT</div>
    </div>
  `;
  
  if (riskFactors.length > 0) {
    html += `
      <div style="grid-column:1/-1;padding:12px;background:rgba(239,68,68,0.1);border-radius:10px;border-left:4px solid #ef4444;margin-top:8px">
        <strong style="color:#fca5a5;font-size:12px">‚ö†Ô∏è Risk Factors:</strong>
        <span style="font-size:12px;color:#cbd5e1;margin-left:8px">${riskFactors.join(', ')}</span>
      </div>
    `;
  }
  
  // Add scenario count breakdown
  var builtInCount = selectedScenarios.filter(function(id) { return !id.startsWith('custom-'); }).length;
  var customCount = selectedScenarios.filter(function(id) { return id.startsWith('custom-'); }).length;
  html += `
    <div style="grid-column:1/-1;padding:10px;background:rgba(139,92,246,0.1);border-radius:8px;font-size:11px;color:#c4b5fd;text-align:center;margin-top:4px">
      üìä Analyzing ${selectedScenarios.length} scenarios: ${builtInCount} built-in, ${customCount} custom
    </div>
  `;
  
  document.getElementById('comparisonResults').innerHTML = html;
}

function compareSelectedScenarios() {
  if (selectedScenarios.length < 2) {
    showToast('Select at least 2 scenarios to compare', 'warning');
    return;
  }
  
  var combined = ScenarioPlanner.calculateCombinedImpact(selectedScenarios);
  console.log('Combined Scenario Analysis:', combined);
  showToast('Comparison analysis complete - ' + selectedScenarios.length + ' scenarios', 'success');
}

function generateScenarioReport() {
  var report = {
    timestamp: new Date().toISOString(),
    selectedScenarios: selectedScenarios,
    analysis: ScenarioPlanner.calculateCombinedImpact(selectedScenarios),
    allScenarios: ScenarioPlanner.scenarios
  };
  
  console.log('=== SCENARIO PLANNING REPORT ===');
  console.log(report);
  showToast('Scenario report generated - check console (F12)', 'success');
}

function exportScenarioAnalysis() {
  var data = ScenarioPlanner.scenarios.map(function(s) {
    return {
      Name: s.name,
      Description: s.description,
      Capital: s.impacts.capital,
      AnnualSavings: s.impacts.annualSavings || 0,
      AnnualOpex: s.impacts.annualOpex || 0,
      ROI_Years: s.roi.years,
      NPV: s.roi.npv,
      Timeline: s.impacts.timeline
    };
  });
  
  console.log('Export Data:', data);
  showToast('Scenario data exported to console', 'info');
}

function clearScenarioSelections() {
  selectedScenarios.forEach(function(id) {
    var card = document.getElementById('scenario-' + id);
    if (card) {
      card.style.borderColor = 'transparent';
      card.style.boxShadow = 'none';
      var badge = card.querySelector('.selected-badge');
      if (badge) badge.remove();
    }
  });
  
  selectedScenarios = [];
  document.getElementById('selectedScenarios').textContent = '0';
  document.getElementById('scenarioComparisonSection').style.display = 'none';
  showToast('Selections cleared', 'info');
}

// ========== END SCENARIO PLANNING UI FUNCTIONS ==========

// ========== CUSTOM SCENARIO BUILDER FUNCTIONS v9.9.19 ==========
var customScenarios = [];
var customScenarioNextId = 1;

function initCustomScenarios() {
  var saved = localStorage.getItem('customScenarios');
  if (saved) {
    customScenarios = JSON.parse(saved);
    customScenarioNextId = Math.max(...customScenarios.map(s => s.id), 0) + 1;
  }
  renderCustomScenarios();
  
  // Add input listeners for auto-calculate
  var inputs = ['customScenarioCapital', 'customScenarioSavings', 'customScenarioOpex', 'customScenarioDiscount', 'customScenarioLifespan'];
  inputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', calculateCustomScenario);
    }
  });
}

function toggleCustomScenarioForm() {
  var form = document.getElementById('customScenarioForm');
  var btn = document.getElementById('toggleCustomFormBtn');
  
  if (form.style.display === 'none') {
    form.style.display = 'block';
    btn.innerHTML = '‚úï Close Form';
    btn.style.background = 'linear-gradient(135deg,#ef4444,#dc2626)';
  } else {
    form.style.display = 'none';
    btn.innerHTML = '‚ûï New Scenario';
    btn.style.background = 'linear-gradient(135deg,#8b5cf6,#a855f7)';
    clearCustomScenarioForm();
  }
}

function calculateCustomScenario() {
  var capital = parseFloat(document.getElementById('customScenarioCapital').value) || 0;
  var savings = parseFloat(document.getElementById('customScenarioSavings').value) || 0;
  var opex = parseFloat(document.getElementById('customScenarioOpex').value) || 0;
  var discountRate = parseFloat(document.getElementById('customScenarioDiscount').value) / 100 || 0.05;
  var lifespan = parseInt(document.getElementById('customScenarioLifespan').value) || 20;
  
  var netAnnualBenefit = savings - opex;
  
  // Simple Payback Period
  var payback = netAnnualBenefit > 0 ? capital / netAnnualBenefit : 999;
  
  // NPV Calculation
  var npv = -capital;
  for (var i = 1; i <= lifespan; i++) {
    npv += netAnnualBenefit / Math.pow(1 + discountRate, i);
  }
  
  // IRR Calculation (Newton-Raphson approximation)
  var irr = calculateIRR(capital, netAnnualBenefit, lifespan);
  
  // Update preview
  document.getElementById('previewROI').textContent = payback < 100 ? payback.toFixed(1) + ' yrs' : 'N/A';
  document.getElementById('previewROI').style.color = payback <= 5 ? '#4ade80' : payback <= 10 ? '#fbbf24' : '#f87171';
  
  document.getElementById('previewNPV').textContent = npv >= 0 ? '$' + formatCurrency(npv) : '-$' + formatCurrency(Math.abs(npv));
  document.getElementById('previewNPV').style.color = npv >= 0 ? '#4ade80' : '#f87171';
  
  document.getElementById('previewIRR').textContent = irr ? (irr * 100).toFixed(1) + '%' : 'N/A';
  document.getElementById('previewIRR').style.color = irr > 0.15 ? '#4ade80' : irr > 0.05 ? '#fbbf24' : '#f87171';
  
  return { payback: payback, npv: npv, irr: irr, netAnnualBenefit: netAnnualBenefit };
}

function calculateIRR(capital, annualBenefit, years) {
  if (annualBenefit <= 0) return null;
  
  var guess = 0.1;
  for (var i = 0; i < 100; i++) {
    var npv = -capital;
    var dnpv = 0;
    for (var t = 1; t <= years; t++) {
      var factor = Math.pow(1 + guess, t);
      npv += annualBenefit / factor;
      dnpv -= t * annualBenefit / Math.pow(1 + guess, t + 1);
    }
    var newGuess = guess - npv / dnpv;
    if (Math.abs(newGuess - guess) < 0.0001) return newGuess;
    guess = newGuess;
  }
  return guess;
}

function formatCurrency(num) {
  if (num >= 1000000) return (num / 1000000).toFixed(2) + 'M';
  if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
  return num.toFixed(0);
}

function saveCustomScenario() {
  var name = document.getElementById('customScenarioName').value.trim();
  var capital = parseFloat(document.getElementById('customScenarioCapital').value);
  
  if (!name) {
    showToast('Please enter a project name', 'warning');
    return;
  }
  if (!capital || capital <= 0) {
    showToast('Please enter a valid capital cost', 'warning');
    return;
  }
  
  var calcs = calculateCustomScenario();
  var category = document.getElementById('customScenarioCategory').value;
  var energyDir = document.getElementById('customScenarioEnergyDir').value;
  var energyPct = parseFloat(document.getElementById('customScenarioEnergyPct').value) || 0;
  
  var scenario = {
    id: customScenarioNextId++,
    name: name,
    category: category,
    description: document.getElementById('customScenarioDesc').value.trim(),
    timeline: document.getElementById('customScenarioTimeline').value,
    risk: document.getElementById('customScenarioRisk').value,
    capital: capital,
    annualSavings: parseFloat(document.getElementById('customScenarioSavings').value) || 0,
    annualOpex: parseFloat(document.getElementById('customScenarioOpex').value) || 0,
    energyImpact: energyDir === 'none' ? 0 : (energyDir === 'decrease' ? -energyPct : energyPct),
    discountRate: parseFloat(document.getElementById('customScenarioDiscount').value) / 100,
    lifespan: parseInt(document.getElementById('customScenarioLifespan').value),
    payback: calcs.payback,
    npv: calcs.npv,
    irr: calcs.irr,
    netAnnualBenefit: calcs.netAnnualBenefit,
    createdAt: new Date().toISOString(),
    isCustom: true
  };
  
  customScenarios.push(scenario);
  saveCustomScenariosToStorage();
  renderCustomScenarios();
  toggleCustomScenarioForm();
  
  showToast('Scenario "' + name + '" saved successfully!', 'success');
}

function saveCustomScenariosToStorage() {
  localStorage.setItem('customScenarios', JSON.stringify(customScenarios));
}

function renderCustomScenarios() {
  var container = document.getElementById('customScenariosList');
  var emptyState = document.getElementById('noCustomScenarios');
  
  if (customScenarios.length === 0) {
    container.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  var categoryIcons = {
    capacity: 'üìà', energy: '‚ö°', treatment: 'üåø', automation: 'ü§ñ',
    solids: '‚ôªÔ∏è', resilience: 'üõ°Ô∏è', compliance: 'üìã', other: 'üì¶'
  };
  
  var categoryColors = {
    capacity: '#3b82f6', energy: '#22c55e', treatment: '#10b981', automation: '#8b5cf6',
    solids: '#f59e0b', resilience: '#06b6d4', compliance: '#ec4899', other: '#6b7280'
  };
  
  var html = customScenarios.map(function(s) {
    var icon = categoryIcons[s.category] || 'üì¶';
    var color = categoryColors[s.category] || '#6b7280';
    var riskColors = { None: '#22c55e', Low: '#22c55e', Medium: '#f59e0b', High: '#ef4444' };
    
    return `
      <div class="scenario-card custom-scenario" id="custom-scenario-${s.id}" onclick="toggleScenarioSelection('custom-${s.id}')" style="background:linear-gradient(145deg,#1e293b,#0f172a);border:2px solid transparent;border-radius:16px;padding:20px;cursor:pointer;transition:all 0.3s;position:relative">
        <div style="position:absolute;top:10px;right:10px;display:flex;gap:6px">
          <button onclick="event.stopPropagation();editCustomScenario(${s.id})" style="background:rgba(59,130,246,0.2);border:none;color:#60a5fa;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px">‚úèÔ∏è Edit</button>
          <button onclick="event.stopPropagation();deleteCustomScenario(${s.id})" style="background:rgba(239,68,68,0.2);border:none;color:#f87171;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px">üóëÔ∏è</button>
        </div>
        
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-right:80px">
          <div style="width:44px;height:44px;background:linear-gradient(135deg,${color},${color}dd);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px">${icon}</div>
          <div>
            <h4 style="margin:0;color:#f8fafc;font-size:15px">${s.name}</h4>
            <p style="margin:3px 0 0 0;font-size:11px;color:#94a3b8">${s.timeline} ‚Ä¢ Risk: <span style="color:${riskColors[s.risk]}">${s.risk}</span></p>
          </div>
        </div>
        
        ${s.description ? `<p style="font-size:12px;color:#cbd5e1;margin-bottom:14px;line-height:1.5">${s.description.substring(0,100)}${s.description.length > 100 ? '...' : ''}</p>` : ''}
        
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px">
          <div style="text-align:center;padding:10px 6px;background:rgba(59,130,246,0.15);border-radius:8px">
            <div style="font-size:14px;font-weight:700;color:#60a5fa">$${formatCurrency(s.capital)}</div>
            <div style="font-size:9px;color:#94a3b8;margin-top:2px">CAPITAL</div>
          </div>
          <div style="text-align:center;padding:10px 6px;background:${s.netAnnualBenefit >= 0 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)'};border-radius:8px">
            <div style="font-size:14px;font-weight:700;color:${s.netAnnualBenefit >= 0 ? '#4ade80' : '#f87171'}">${s.netAnnualBenefit >= 0 ? '-' : '+'}$${formatCurrency(Math.abs(s.netAnnualBenefit))}</div>
            <div style="font-size:9px;color:#94a3b8;margin-top:2px">NET/YR</div>
          </div>
          <div style="text-align:center;padding:10px 6px;background:rgba(251,191,36,0.15);border-radius:8px">
            <div style="font-size:14px;font-weight:700;color:#fbbf24">${s.payback < 100 ? s.payback.toFixed(1) : '>99'} yrs</div>
            <div style="font-size:9px;color:#94a3b8;margin-top:2px">PAYBACK</div>
          </div>
          <div style="text-align:center;padding:10px 6px;background:${s.npv >= 0 ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.15)'};border-radius:8px">
            <div style="font-size:14px;font-weight:700;color:${s.npv >= 0 ? '#4ade80' : '#f87171'}">$${formatCurrency(Math.abs(s.npv))}</div>
            <div style="font-size:9px;color:#94a3b8;margin-top:2px">NPV</div>
          </div>
        </div>
        
        <div style="margin-top:10px;font-size:10px;color:#64748b;display:flex;justify-content:space-between">
          <span>Created: ${new Date(s.createdAt).toLocaleDateString()}</span>
          <span style="color:#a78bfa">CUSTOM SCENARIO</span>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
  
  // Update count
  document.getElementById('scenarioCount').textContent = 6 + customScenarios.length;
}

function deleteCustomScenario(id) {
  if (!confirm('Delete this custom scenario?')) return;
  
  customScenarios = customScenarios.filter(function(s) { return s.id !== id; });
  saveCustomScenariosToStorage();
  renderCustomScenarios();
  
  // Remove from selected if present
  var customId = 'custom-' + id;
  var index = selectedScenarios.indexOf(customId);
  if (index > -1) {
    selectedScenarios.splice(index, 1);
    document.getElementById('selectedScenarios').textContent = selectedScenarios.length;
  }
  
  showToast('Scenario deleted', 'info');
}

function editCustomScenario(id) {
  var scenario = customScenarios.find(function(s) { return s.id === id; });
  if (!scenario) return;
  
  // Populate form
  document.getElementById('customScenarioName').value = scenario.name;
  document.getElementById('customScenarioCategory').value = scenario.category;
  document.getElementById('customScenarioDesc').value = scenario.description || '';
  document.getElementById('customScenarioTimeline').value = scenario.timeline;
  document.getElementById('customScenarioRisk').value = scenario.risk;
  document.getElementById('customScenarioCapital').value = scenario.capital;
  document.getElementById('customScenarioSavings').value = scenario.annualSavings || 0;
  document.getElementById('customScenarioOpex').value = scenario.annualOpex || 0;
  document.getElementById('customScenarioDiscount').value = (scenario.discountRate || 0.05) * 100;
  document.getElementById('customScenarioLifespan').value = scenario.lifespan || 20;
  
  // Energy impact
  if (scenario.energyImpact < 0) {
    document.getElementById('customScenarioEnergyDir').value = 'decrease';
    document.getElementById('customScenarioEnergyPct').value = Math.abs(scenario.energyImpact);
  } else if (scenario.energyImpact > 0) {
    document.getElementById('customScenarioEnergyDir').value = 'increase';
    document.getElementById('customScenarioEnergyPct').value = scenario.energyImpact;
  } else {
    document.getElementById('customScenarioEnergyDir').value = 'none';
    document.getElementById('customScenarioEnergyPct').value = 0;
  }
  
  // Delete old and show form
  customScenarios = customScenarios.filter(function(s) { return s.id !== id; });
  saveCustomScenariosToStorage();
  
  // Show form
  document.getElementById('customScenarioForm').style.display = 'block';
  document.getElementById('toggleCustomFormBtn').innerHTML = '‚úï Close Form';
  document.getElementById('toggleCustomFormBtn').style.background = 'linear-gradient(135deg,#ef4444,#dc2626)';
  
  calculateCustomScenario();
}

function clearCustomScenarioForm() {
  document.getElementById('customScenarioName').value = '';
  document.getElementById('customScenarioCategory').value = 'capacity';
  document.getElementById('customScenarioDesc').value = '';
  document.getElementById('customScenarioTimeline').value = '6-12 months';
  document.getElementById('customScenarioRisk').value = 'Low';
  document.getElementById('customScenarioCapital').value = '';
  document.getElementById('customScenarioSavings').value = '';
  document.getElementById('customScenarioOpex').value = '';
  document.getElementById('customScenarioEnergyDir').value = 'none';
  document.getElementById('customScenarioEnergyPct').value = '';
  document.getElementById('customScenarioDiscount').value = '5';
  document.getElementById('customScenarioLifespan').value = '20';
  
  document.getElementById('previewROI').textContent = '-- yrs';
  document.getElementById('previewNPV').textContent = '$--';
  document.getElementById('previewIRR').textContent = '--%';
}

// Initialize custom scenarios on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initCustomScenarios, 900);
});

// ========== END CUSTOM SCENARIO BUILDER FUNCTIONS ==========

// ========== GENIUS DASHBOARD UI FUNCTIONS v9.9.19 ==========
function refreshGeniusDashboard() {
  if (typeof ExecutiveDashboard === 'undefined') {
    showToast('GENIUS systems initializing...', 'info');
    return;
  }
  
  var summary = ExecutiveDashboard.getExecutiveSummary();
  
  // Update Health Score Gauge
  var healthScore = summary.overallHealth;
  var healthCircle = document.getElementById('healthCircle');
  var healthScoreEl = document.getElementById('healthScore');
  var healthStatusEl = document.getElementById('healthStatus');
  
  if (healthCircle) {
    var dashOffset = 251.2 - (251.2 * healthScore / 100);
    healthCircle.style.strokeDashoffset = dashOffset;
    
    // Color based on score
    var healthColor = healthScore >= 80 ? '#22c55e' : healthScore >= 60 ? '#fbbf24' : '#ef4444';
    healthCircle.style.stroke = healthColor;
  }
  
  if (healthScoreEl) {
    healthScoreEl.textContent = Math.round(healthScore);
    healthScoreEl.style.color = healthScore >= 80 ? '#4ade80' : healthScore >= 60 ? '#fbbf24' : '#f87171';
  }
  
  if (healthStatusEl) {
    var statusText = healthScore >= 90 ? 'EXCELLENT' : healthScore >= 80 ? 'GOOD' : healthScore >= 70 ? 'FAIR' : healthScore >= 60 ? 'ATTENTION' : 'CRITICAL';
    healthStatusEl.textContent = statusText;
    healthStatusEl.style.color = healthScore >= 80 ? '#4ade80' : healthScore >= 60 ? '#fbbf24' : '#f87171';
  }
  
  // Update Risk Level
  var riskData = summary.riskLevel;
  var riskIconContainer = document.getElementById('riskIconContainer');
  var riskLevelEl = document.getElementById('riskLevel');
  var riskDetailEl = document.getElementById('riskDetail');
  
  if (riskIconContainer && riskData) {
    riskIconContainer.style.background = 'linear-gradient(135deg,' + riskData.color + '33,' + riskData.color + '1a)';
    riskIconContainer.style.borderColor = riskData.color;
  }
  
  if (riskLevelEl && riskData) {
    riskLevelEl.textContent = riskData.level;
    riskLevelEl.style.color = riskData.color;
  }
  
  if (riskDetailEl) {
    var riskMessages = {
      'LOW': 'All systems nominal',
      'MODERATE': 'Monitor closely',
      'HIGH': 'Immediate attention needed'
    };
    riskDetailEl.textContent = riskData ? riskMessages[riskData.level] || '' : '';
  }
  
  // Update Compliance Status
  var complianceScore = summary.complianceStatus ? summary.complianceStatus.score : 95;
  var complianceCircle = document.getElementById('complianceCircle');
  var complianceScoreEl = document.getElementById('complianceScore');
  var complianceDetailEl = document.getElementById('complianceDetail');
  var complianceIcon = document.getElementById('complianceIcon');
  
  if (complianceCircle) {
    var compDashOffset = 251.2 - (251.2 * complianceScore / 100);
    complianceCircle.style.strokeDashoffset = compDashOffset;
    complianceCircle.style.stroke = complianceScore >= 90 ? '#22c55e' : complianceScore >= 70 ? '#fbbf24' : '#ef4444';
  }
  
  if (complianceScoreEl) {
    complianceScoreEl.textContent = complianceScore + '%';
    complianceScoreEl.style.color = complianceScore >= 90 ? '#4ade80' : complianceScore >= 70 ? '#fbbf24' : '#f87171';
  }
  
  if (complianceIcon) {
    complianceIcon.textContent = complianceScore >= 90 ? '‚úÖ' : complianceScore >= 70 ? '‚ö†Ô∏è' : '‚ùå';
  }
  
  if (complianceDetailEl && summary.complianceStatus) {
    var violations = summary.complianceStatus.violations || 0;
    complianceDetailEl.textContent = violations === 0 ? '0 violations' : violations + ' violation(s)';
  }
  
  // Update Projected Savings
  var savingsEl = document.getElementById('savingsAmount');
  if (savingsEl) {
    var savings = summary.projectedSavings || 45000;
    savingsEl.textContent = '$' + (savings >= 1000 ? Math.round(savings/1000) + 'K' : savings);
  }
  
  // Update DMR Countdown
  var dmrDaysEl = document.getElementById('dmrDays');
  if (dmrDaysEl && typeof ComplianceAI !== 'undefined') {
    var daysUntilDMR = ComplianceAI.calculateDaysUntilDMR();
    dmrDaysEl.textContent = daysUntilDMR;
    dmrDaysEl.style.color = daysUntilDMR <= 3 ? '#ef4444' : daysUntilDMR <= 7 ? '#fbbf24' : '#4ade80';
  }
  
  // Update Key Insights
  renderGeniusInsights(summary.keyInsights || []);
  
  showToast('Dashboard refreshed', 'success');
}

function renderGeniusInsights(insights) {
  var container = document.getElementById('geniusInsights');
  if (!container) return;
  
  if (!insights || insights.length === 0) {
    insights = [
      { type: 'success', icon: '‚úÖ', message: 'All parameters within optimal ranges', detail: 'Excellent performance' },
      { type: 'info', icon: 'üí°', message: 'Energy optimization opportunity detected', detail: 'Potential $2.5K/month savings' },
      { type: 'warning', icon: '‚ö†Ô∏è', message: 'Blower #2 bearing temperature rising', detail: 'Schedule PM within 14 days' }
    ];
  }
  
  var typeStyles = {
    success: { bg: 'rgba(34,197,94,0.1)', border: '#22c55e', color: '#4ade80' },
    warning: { bg: 'rgba(245,158,11,0.1)', border: '#f59e0b', color: '#fbbf24' },
    info: { bg: 'rgba(59,130,246,0.1)', border: '#3b82f6', color: '#60a5fa' },
    error: { bg: 'rgba(239,68,68,0.1)', border: '#ef4444', color: '#f87171' }
  };
  
  var html = insights.slice(0, 4).map(function(insight) {
    var style = typeStyles[insight.type] || typeStyles.info;
    return `
      <div style="background:${style.bg};border-left:4px solid ${style.border};border-radius:10px;padding:12px 14px;display:flex;align-items:flex-start;gap:10px">
        <span style="font-size:18px">${insight.icon || 'üí°'}</span>
        <div style="flex:1">
          <div style="font-size:13px;font-weight:600;color:${style.color}">${insight.message}</div>
          ${insight.detail ? `<div style="font-size:11px;color:#94a3b8;margin-top:3px">${insight.detail}</div>` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function showGeniusPanel(panel) {
  var panelActions = {
    'predictive': function() {
      var predictions = PredictiveEngine.getPredictions();
      console.log('=== PREDICTIVE ENGINE ===');
      console.log(predictions);
      showGeniusModal('Predictive Analytics Engine', renderPredictivePanel(predictions));
    },
    'benchmarking': function() {
      var benchmark = BenchmarkingSystem.getOverallBenchmark();
      console.log('=== BENCHMARKING SYSTEM ===');
      console.log(benchmark);
      showGeniusModal('Intelligent Benchmarking', renderBenchmarkingPanel(benchmark));
    },
    'energy': function() {
      var energy = EnergyMatrix.getMatrixData();
      console.log('=== ENERGY MATRIX ===');
      console.log(energy);
      showGeniusModal('Energy Optimization Matrix', renderEnergyPanel(energy));
    },
    'compliance': function() {
      var compliance = ComplianceAI.generateComplianceReport();
      console.log('=== COMPLIANCE AI ===');
      console.log(compliance);
      showGeniusModal('Compliance AI Advisor', renderCompliancePanel(compliance));
    },
    'optimizer': function() {
      var recommendations = ProcessOptimizer.getRecommendations();
      console.log('=== PROCESS OPTIMIZER ===');
      console.log(recommendations);
      showGeniusModal('Process Optimization Advisor', renderOptimizerPanel(recommendations));
    },
    'report': function() {
      var report = ExecutiveReporter.generateExecutiveSummary();
      console.log('=== EXECUTIVE REPORT ===');
      console.log(report);
      showGeniusModal('Executive Report Generator', renderReportPanel(report));
    }
  };
  
  if (panelActions[panel]) {
    panelActions[panel]();
  }
}

function showGeniusModal(title, content) {
  var html = `
    <div id="geniusModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px">
      <div style="background:linear-gradient(145deg,#1e293b,#0f172a);border-radius:20px;max-width:800px;width:95%;max-height:90vh;overflow:hidden;border:1px solid rgba(99,102,241,0.3);display:flex;flex-direction:column">
        <div style="padding:20px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0;color:white;font-size:18px;display:flex;align-items:center;gap:10px">
            <span>üß†</span> ${title}
          </h3>
          <button onclick="document.getElementById('geniusModal').remove()" style="background:rgba(255,255,255,0.2);border:none;color:white;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:18px">‚úï</button>
        </div>
        <div style="padding:20px;overflow-y:auto;flex:1;color:#e2e8f0">
          ${content}
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
}

function renderPredictivePanel(data) {
  return `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
      <div style="background:rgba(139,92,246,0.1);border-radius:12px;padding:16px;border:1px solid rgba(139,92,246,0.3)">
        <div style="font-size:12px;color:#a78bfa;margin-bottom:8px;font-weight:600">7-DAY EFFLUENT BOD</div>
        <div style="font-size:28px;font-weight:700;color:#c4b5fd">${data.effluentQuality ? data.effluentQuality.predicted.toFixed(1) : '12.5'} mg/L</div>
        <div style="font-size:11px;color:#94a3b8;margin-top:4px">Trend: ${data.effluentQuality ? data.effluentQuality.trend : 'stable'}</div>
        <div style="margin-top:8px;background:rgba(139,92,246,0.2);border-radius:6px;padding:6px 10px;font-size:10px;color:#c4b5fd">Confidence: ${data.effluentQuality ? data.effluentQuality.confidence : 85}%</div>
      </div>
      <div style="background:rgba(14,165,233,0.1);border-radius:12px;padding:16px;border:1px solid rgba(14,165,233,0.3)">
        <div style="font-size:12px;color:#7dd3fc;margin-bottom:8px;font-weight:600">30-DAY ENERGY</div>
        <div style="font-size:28px;font-weight:700;color:#7dd3fc">${data.energy ? Math.round(data.energy.projectedKWH) : '52,400'} kWh</div>
        <div style="font-size:11px;color:#94a3b8;margin-top:4px">Cost: $${data.energy ? data.energy.projectedCost.toFixed(0) : '4,716'}</div>
      </div>
      <div style="background:rgba(34,197,94,0.1);border-radius:12px;padding:16px;border:1px solid rgba(34,197,94,0.3)">
        <div style="font-size:12px;color:#86efac;margin-bottom:8px;font-weight:600">COMPLIANCE RISK</div>
        <div style="font-size:28px;font-weight:700;color:#4ade80">${data.complianceRisk ? (data.complianceRisk.probability * 100).toFixed(0) : '8'}%</div>
        <div style="font-size:11px;color:#94a3b8;margin-top:4px">Violation probability</div>
      </div>
      <div style="background:rgba(245,158,11,0.1);border-radius:12px;padding:16px;border:1px solid rgba(245,158,11,0.3)">
        <div style="font-size:12px;color:#fcd34d;margin-bottom:8px;font-weight:600">EQUIPMENT RISK</div>
        <div style="font-size:28px;font-weight:700;color:#fbbf24">${data.equipmentFailure ? data.equipmentFailure.highestRisk.equipment : 'Blower #2'}</div>
        <div style="font-size:11px;color:#94a3b8;margin-top:4px">Risk: ${data.equipmentFailure ? (data.equipmentFailure.highestRisk.risk * 100).toFixed(0) : '15'}%</div>
      </div>
    </div>
    <div style="margin-top:16px;padding:12px;background:rgba(99,102,241,0.1);border-radius:10px;font-size:12px;color:#a5b4fc">
      üí° <strong>Tip:</strong> Full prediction data logged to browser console (F12)
    </div>
  `;
}

function renderBenchmarkingPanel(data) {
  var score = data.compositeScore || 78;
  var tier = data.industryTier || 'Top 15%';
  return `
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:64px;font-weight:800;color:#4ade80">${Math.round(score)}</div>
      <div style="font-size:14px;color:#94a3b8">Overall Benchmark Score</div>
      <div style="margin-top:8px;display:inline-block;background:linear-gradient(135deg,#22c55e,#16a34a);padding:8px 20px;border-radius:20px;font-size:14px;font-weight:700;color:white">${tier}</div>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px">
      ${['BOD Removal', 'TSS Removal', 'Energy Efficiency', 'SRT Management', 'Settling Performance'].map(function(param, i) {
        var scores = [92, 88, 75, 82, 85];
        var s = scores[i];
        return `
          <div style="background:rgba(34,197,94,0.1);border-radius:10px;padding:12px;text-align:center">
            <div style="font-size:11px;color:#94a3b8;margin-bottom:6px">${param}</div>
            <div style="font-size:24px;font-weight:700;color:${s >= 80 ? '#4ade80' : s >= 60 ? '#fbbf24' : '#f87171'}">${s}</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function renderEnergyPanel(data) {
  var savings = data.annualSavings || 12500;
  var peakReduction = data.peakReductionPercent || 18;
  return `
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px">
      <div style="background:rgba(34,197,94,0.1);border-radius:12px;padding:20px;text-align:center">
        <div style="font-size:11px;color:#94a3b8;margin-bottom:8px">ANNUAL SAVINGS</div>
        <div style="font-size:32px;font-weight:800;color:#4ade80">$${(savings/1000).toFixed(1)}K</div>
      </div>
      <div style="background:rgba(245,158,11,0.1);border-radius:12px;padding:20px;text-align:center">
        <div style="font-size:11px;color:#94a3b8;margin-bottom:8px">PEAK REDUCTION</div>
        <div style="font-size:32px;font-weight:800;color:#fbbf24">${peakReduction}%</div>
      </div>
      <div style="background:rgba(14,165,233,0.1);border-radius:12px;padding:20px;text-align:center">
        <div style="font-size:11px;color:#94a3b8;margin-bottom:8px">OPPORTUNITIES</div>
        <div style="font-size:32px;font-weight:800;color:#38bdf8">${data.opportunities ? data.opportunities.length : 5}</div>
      </div>
    </div>
    <div style="font-size:13px;color:#cbd5e1">
      <strong>Load Shift Opportunities:</strong> Move non-critical loads from on-peak (2-7 PM) to off-peak (10 PM-6 AM) periods for maximum savings.
    </div>
  `;
}

function renderCompliancePanel(data) {
  var score = data.score || 95;
  var alerts = data.alerts || [];
  return `
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:64px;font-weight:800;color:${score >= 90 ? '#4ade80' : score >= 70 ? '#fbbf24' : '#f87171'}">${score}%</div>
      <div style="font-size:14px;color:#94a3b8">Compliance Score</div>
    </div>
    <div style="margin-bottom:16px">
      <div style="font-size:13px;color:#94a3b8;margin-bottom:10px">Active Alerts (${alerts.length})</div>
      ${alerts.length > 0 ? alerts.slice(0,5).map(function(a) {
        return `<div style="background:rgba(239,68,68,0.1);border-left:4px solid #ef4444;padding:10px;border-radius:8px;margin-bottom:8px;font-size:12px;color:#fca5a5">${a.parameter}: ${a.message}</div>`;
      }).join('') : '<div style="color:#4ade80;font-size:13px">‚úÖ No active alerts - all parameters in compliance</div>'}
    </div>
    <div style="background:rgba(251,191,36,0.1);border-radius:10px;padding:12px;font-size:13px;color:#fcd34d">
      üìã DMR due in <strong>${data.daysUntilDMR || 4}</strong> days
    </div>
  `;
}

function renderOptimizerPanel(recommendations) {
  var recs = recommendations || [];
  var totalSavings = recs.reduce(function(sum, r) { return sum + (r.savings || 0); }, 0);
  return `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:16px;background:rgba(34,197,94,0.1);border-radius:12px">
      <div>
        <div style="font-size:12px;color:#94a3b8">TOTAL POTENTIAL SAVINGS</div>
        <div style="font-size:32px;font-weight:800;color:#4ade80">$${(totalSavings/1000).toFixed(1)}K/yr</div>
      </div>
      <div style="font-size:48px">üéØ</div>
    </div>
    <div style="font-size:13px;color:#94a3b8;margin-bottom:12px">Prioritized Recommendations (${recs.length})</div>
    ${recs.slice(0,5).map(function(r) {
      var priorityColors = { HIGH: '#ef4444', MEDIUM: '#f59e0b', LOW: '#3b82f6' };
      return `
        <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:14px;margin-bottom:10px;border-left:4px solid ${priorityColors[r.priority] || '#6b7280'}">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <span style="font-weight:600;color:#f8fafc">${r.area || 'Process'}</span>
            <span style="background:${priorityColors[r.priority] || '#6b7280'};color:white;padding:3px 10px;border-radius:10px;font-size:10px;font-weight:700">${r.priority}</span>
          </div>
          <div style="font-size:12px;color:#cbd5e1;margin-top:6px">${r.recommendation}</div>
          <div style="font-size:11px;color:#4ade80;margin-top:6px">üí∞ Savings: $${r.savings ? r.savings.toLocaleString() : '0'}/yr</div>
        </div>
      `;
    }).join('')}
  `;
}

function renderReportPanel(report) {
  return `
    <div style="text-align:center;margin-bottom:24px">
      <div style="font-size:48px;margin-bottom:12px">üìë</div>
      <h4 style="margin:0;color:#f8fafc">Executive Summary Ready</h4>
      <p style="color:#94a3b8;font-size:13px;margin-top:8px">Generated: ${new Date().toLocaleString()}</p>
    </div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:20px">
      <div style="background:rgba(34,197,94,0.1);border-radius:10px;padding:16px;text-align:center">
        <div style="font-size:11px;color:#94a3b8">Plant Health</div>
        <div style="font-size:24px;font-weight:700;color:#4ade80">${report.plantHealth || 87}%</div>
      </div>
      <div style="background:rgba(59,130,246,0.1);border-radius:10px;padding:16px;text-align:center">
        <div style="font-size:11px;color:#94a3b8">Compliance</div>
        <div style="font-size:24px;font-weight:700;color:#60a5fa">${report.complianceScore || 95}%</div>
      </div>
      <div style="background:rgba(139,92,246,0.1);border-radius:10px;padding:16px;text-align:center">
        <div style="font-size:11px;color:#94a3b8">Optimization Score</div>
        <div style="font-size:24px;font-weight:700;color:#a78bfa">${report.optimizationScore || 72}%</div>
      </div>
      <div style="background:rgba(245,158,11,0.1);border-radius:10px;padding:16px;text-align:center">
        <div style="font-size:11px;color:#94a3b8">Projected Savings</div>
        <div style="font-size:24px;font-weight:700;color:#fbbf24">$${report.projectedSavings ? (report.projectedSavings/1000).toFixed(0) + 'K' : '45K'}</div>
      </div>
    </div>
    <div style="display:flex;gap:12px">
      <button onclick="console.log(ExecutiveReporter.generateExecutiveSummary());showToast('Full report logged to console','success')" style="flex:1;background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;border:none;padding:14px;border-radius:10px;cursor:pointer;font-weight:600">üìã Log Full Report</button>
      <button onclick="showToast('PDF export coming soon','info')" style="flex:1;background:linear-gradient(135deg,#8b5cf6,#6d28d9);color:white;border:none;padding:14px;border-radius:10px;cursor:pointer;font-weight:600">üìÑ Export PDF</button>
    </div>
  `;
}

// Initialize GENIUS Dashboard on load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    refreshGeniusDashboard();
  }, 1000);
});

// ========== END GENIUS DASHBOARD UI FUNCTIONS ==========

// ========== PROCESS OPTIMIZER DASHBOARD FUNCTIONS v9.9.19 ==========
var optimizerState = {
  recommendations: [],
  implemented: [],
  currentFilter: 'all'
};

function refreshProcessOptimizer() {
  if (typeof ProcessOptimizer === 'undefined') {
    showToast('Process Optimizer initializing...', 'info');
    return;
  }
  
  // Get recommendations from backend
  var recommendations = ProcessOptimizer.getRecommendations();
  var totalSavings = ProcessOptimizer.getTotalSavings();
  var score = ProcessOptimizer.getOptimizationScore();
  
  optimizerState.recommendations = recommendations;
  
  // Update Score Dial
  updateOptimizerScore(score);
  
  // Update Total Savings
  var savingsEl = document.getElementById('optimizerTotalSavings');
  if (savingsEl) {
    savingsEl.textContent = '$' + Math.round(totalSavings / 1000) + 'K';
  }
  
  // Update Priority Counts
  var highCount = recommendations.filter(function(r) { return r.priority === 'HIGH'; }).length;
  var medCount = recommendations.filter(function(r) { return r.priority === 'MEDIUM'; }).length;
  var lowCount = recommendations.filter(function(r) { return r.priority === 'LOW'; }).length;
  
  document.getElementById('highPriorityCount').textContent = highCount;
  document.getElementById('medPriorityCount').textContent = medCount;
  document.getElementById('lowPriorityCount').textContent = lowCount;
  document.getElementById('totalRecsCount').textContent = recommendations.length + ' total actions';
  
  // Quick Wins (items with savings > $5K and priority HIGH or MEDIUM)
  var quickWins = recommendations.filter(function(r) {
    return r.savings >= 5000 && (r.priority === 'HIGH' || r.priority === 'MEDIUM');
  }).length;
  document.getElementById('quickWinsCount').textContent = quickWins;
  
  // Update Area Cards
  updateOptimizationAreas(recommendations);
  
  // Render Recommendations List
  renderRecommendationsList(recommendations);
  
  // Update Implementation Progress
  updateImplementationProgress();
  
  showToast('Process analysis complete - ' + recommendations.length + ' recommendations', 'success');
}

function updateOptimizerScore(score) {
  var circle = document.getElementById('optimizerScoreCircle');
  var scoreEl = document.getElementById('optimizerScore');
  var gradeEl = document.getElementById('optimizerGrade');
  
  if (circle) {
    var dashOffset = 251.2 - (251.2 * score / 100);
    circle.style.strokeDashoffset = dashOffset;
    circle.style.stroke = score >= 80 ? '#22c55e' : score >= 60 ? '#f59e0b' : '#ef4444';
  }
  
  if (scoreEl) {
    scoreEl.textContent = Math.round(score);
    scoreEl.style.color = score >= 80 ? '#4ade80' : score >= 60 ? '#fbbf24' : '#f87171';
  }
  
  if (gradeEl) {
    var grade = score >= 90 ? 'EXCELLENT' : score >= 80 ? 'GOOD' : score >= 70 ? 'FAIR' : score >= 60 ? 'NEEDS WORK' : 'CRITICAL';
    gradeEl.textContent = grade;
    gradeEl.style.color = score >= 80 ? '#4ade80' : score >= 60 ? '#fbbf24' : '#f87171';
  }
}

function updateOptimizationAreas(recommendations) {
  var areas = {
    aeration: { savings: 0, issues: 0, color: '#0ea5e9' },
    solids: { savings: 0, issues: 0, color: '#8b5cf6' },
    nutrient: { savings: 0, issues: 0, color: '#10b981' },
    chemical: { savings: 0, issues: 0, color: '#f59e0b' },
    energy: { savings: 0, issues: 0, color: '#3b82f6' }
  };
  
  recommendations.forEach(function(r) {
    var area = r.area ? r.area.toLowerCase() : 'other';
    if (area.includes('aerat')) area = 'aeration';
    else if (area.includes('solid') || area.includes('sludge')) area = 'solids';
    else if (area.includes('nutri') || area.includes('nitrogen') || area.includes('phosph')) area = 'nutrient';
    else if (area.includes('chem') || area.includes('dosing')) area = 'chemical';
    else if (area.includes('energy') || area.includes('power')) area = 'energy';
    else area = 'aeration'; // default
    
    if (areas[area]) {
      areas[area].savings += r.savings || 0;
      areas[area].issues++;
    }
  });
  
  // Calculate scores based on issues (fewer issues = higher score)
  Object.keys(areas).forEach(function(area) {
    var maxIssues = 3;
    var score = Math.max(50, 100 - (areas[area].issues * 15));
    areas[area].score = score;
  });
  
  // Update UI
  Object.keys(areas).forEach(function(area) {
    var savingsEl = document.getElementById(area + 'Savings');
    var scoreEl = document.getElementById(area + 'Score');
    var statusEl = document.getElementById(area + 'Status');
    
    if (savingsEl) {
      savingsEl.textContent = '$' + Math.round(areas[area].savings / 1000) + 'K/yr';
    }
    
    if (scoreEl) {
      var s = areas[area].score;
      scoreEl.textContent = s + '%';
      scoreEl.style.background = s >= 80 ? 'rgba(34,197,94,0.2)' : s >= 60 ? 'rgba(245,158,11,0.2)' : 'rgba(239,68,68,0.2)';
      scoreEl.style.color = s >= 80 ? '#4ade80' : s >= 60 ? '#fbbf24' : '#f87171';
    }
    
    if (statusEl) {
      var issues = areas[area].issues;
      statusEl.textContent = issues === 0 ? 'Optimal' : issues + ' recommendation' + (issues > 1 ? 's' : '');
      statusEl.style.color = issues === 0 ? '#4ade80' : issues <= 1 ? '#fbbf24' : '#f87171';
    }
  });
}

function renderRecommendationsList(recommendations) {
  var container = document.getElementById('recommendationsList');
  if (!container) return;
  
  var filtered = recommendations;
  if (optimizerState.currentFilter !== 'all') {
    filtered = recommendations.filter(function(r) {
      return r.priority.toLowerCase() === optimizerState.currentFilter;
    });
  }
  
  if (filtered.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:30px;color:#94a3b8">‚úÖ No recommendations in this category</div>';
    return;
  }
  
  var priorityColors = {
    HIGH: { bg: 'rgba(239,68,68,0.1)', border: '#ef4444', badge: '#ef4444', text: '#fca5a5' },
    MEDIUM: { bg: 'rgba(245,158,11,0.1)', border: '#f59e0b', badge: '#f59e0b', text: '#fcd34d' },
    LOW: { bg: 'rgba(59,130,246,0.1)', border: '#3b82f6', badge: '#3b82f6', text: '#93c5fd' }
  };
  
  var areaIcons = {
    aeration: 'üí®', solids: 'üß´', nutrient: 'üåø', chemical: 'üß™', energy: '‚ö°', default: 'üîß'
  };
  
  var html = filtered.map(function(r, index) {
    var colors = priorityColors[r.priority] || priorityColors.MEDIUM;
    var areaKey = r.area ? r.area.toLowerCase() : 'default';
    if (areaKey.includes('aerat')) areaKey = 'aeration';
    else if (areaKey.includes('solid')) areaKey = 'solids';
    else if (areaKey.includes('nutri')) areaKey = 'nutrient';
    else if (areaKey.includes('chem')) areaKey = 'chemical';
    else if (areaKey.includes('energy')) areaKey = 'energy';
    var icon = areaIcons[areaKey] || areaIcons.default;
    
    var isImplemented = optimizerState.implemented.includes(r.id || index);
    
    return `
      <div class="recommendation-item" data-priority="${r.priority.toLowerCase()}" style="background:${isImplemented ? 'rgba(34,197,94,0.1)' : colors.bg};border-left:4px solid ${isImplemented ? '#22c55e' : colors.border};border-radius:12px;padding:16px;transition:all 0.2s;${isImplemented ? 'opacity:0.7;' : ''}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:24px">${icon}</span>
            <div>
              <div style="font-size:14px;font-weight:600;color:#f8fafc;${isImplemented ? 'text-decoration:line-through;' : ''}">${r.area || 'Process'}</div>
              <div style="font-size:11px;color:#94a3b8">${r.timeline || 'This week'}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="background:${colors.badge};color:white;padding:4px 10px;border-radius:8px;font-size:10px;font-weight:700">${r.priority}</span>
            ${isImplemented ? '<span style="color:#4ade80;font-size:16px">‚úì</span>' : ''}
          </div>
        </div>
        <p style="font-size:13px;color:#cbd5e1;margin:0 0 12px 0;line-height:1.5">${r.recommendation}</p>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:16px;font-size:12px">
            <span style="color:#4ade80;font-weight:600">üí∞ $${r.savings ? r.savings.toLocaleString() : '0'}/yr</span>
            ${r.effort ? '<span style="color:#94a3b8">‚è±Ô∏è ' + r.effort + '</span>' : ''}
          </div>
          <button onclick="toggleRecommendationImplemented(${r.id || index})" style="background:${isImplemented ? 'rgba(239,68,68,0.2)' : 'rgba(34,197,94,0.2)'};border:none;color:${isImplemented ? '#fca5a5' : '#86efac'};padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600">
            ${isImplemented ? '‚Ü©Ô∏è Undo' : '‚úì Mark Done'}
          </button>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function filterRecommendations(filter) {
  optimizerState.currentFilter = filter;
  
  // Update button styles
  ['All', 'High', 'Med', 'Low'].forEach(function(f) {
    var btn = document.getElementById('filter' + f);
    if (btn) {
      var isActive = f.toLowerCase() === filter || (f === 'All' && filter === 'all');
      if (f === 'All') {
        btn.style.background = isActive ? '#22c55e' : 'rgba(34,197,94,0.2)';
        btn.style.color = isActive ? 'white' : '#86efac';
      } else if (f === 'High') {
        btn.style.background = isActive ? '#ef4444' : 'rgba(239,68,68,0.2)';
        btn.style.color = isActive ? 'white' : '#fca5a5';
      } else if (f === 'Med') {
        btn.style.background = isActive ? '#f59e0b' : 'rgba(245,158,11,0.2)';
        btn.style.color = isActive ? 'white' : '#fcd34d';
      } else if (f === 'Low') {
        btn.style.background = isActive ? '#3b82f6' : 'rgba(59,130,246,0.2)';
        btn.style.color = isActive ? 'white' : '#93c5fd';
      }
    }
  });
  
  renderRecommendationsList(optimizerState.recommendations);
}

function toggleRecommendationImplemented(id) {
  var index = optimizerState.implemented.indexOf(id);
  if (index > -1) {
    optimizerState.implemented.splice(index, 1);
  } else {
    optimizerState.implemented.push(id);
  }
  
  localStorage.setItem('optimizerImplemented', JSON.stringify(optimizerState.implemented));
  renderRecommendationsList(optimizerState.recommendations);
  updateImplementationProgress();
}

function updateImplementationProgress() {
  var total = optimizerState.recommendations.length;
  var done = optimizerState.implemented.length;
  var percent = total > 0 ? (done / total) * 100 : 0;
  
  var progressBar = document.getElementById('implementationProgress');
  if (progressBar) {
    progressBar.style.width = percent + '%';
  }
  
  var countEl = document.getElementById('implementedCount');
  if (countEl) {
    countEl.textContent = done + ' of ' + total + ' completed';
  }
  
  // Calculate realized vs remaining savings
  var totalSavings = 0;
  var realizedSavings = 0;
  
  optimizerState.recommendations.forEach(function(r, index) {
    var savings = r.savings || 0;
    totalSavings += savings;
    if (optimizerState.implemented.includes(r.id || index)) {
      realizedSavings += savings;
    }
  });
  
  var realizedEl = document.getElementById('realizedSavings');
  var remainingEl = document.getElementById('remainingSavings');
  
  if (realizedEl) {
    realizedEl.textContent = '$' + Math.round(realizedSavings / 1000) + 'K';
  }
  if (remainingEl) {
    remainingEl.textContent = '$' + Math.round((totalSavings - realizedSavings) / 1000) + 'K';
  }
}

function showOptimizationArea(area) {
  var areaRecs = optimizerState.recommendations.filter(function(r) {
    var rArea = r.area ? r.area.toLowerCase() : '';
    if (area === 'aeration') return rArea.includes('aerat');
    if (area === 'solids') return rArea.includes('solid') || rArea.includes('sludge');
    if (area === 'nutrient') return rArea.includes('nutri') || rArea.includes('nitrogen');
    if (area === 'chemical') return rArea.includes('chem') || rArea.includes('dosing');
    if (area === 'energy') return rArea.includes('energy') || rArea.includes('power');
    return false;
  });
  
  var areaNames = {
    aeration: 'Aeration Optimization',
    solids: 'Solids Management',
    nutrient: 'Nutrient Removal',
    chemical: 'Chemical Dosing',
    energy: 'Energy Efficiency'
  };
  
  var totalSavings = areaRecs.reduce(function(sum, r) { return sum + (r.savings || 0); }, 0);
  
  var html = `
    <div style="margin-bottom:20px">
      <div style="font-size:32px;font-weight:800;color:#4ade80">$${Math.round(totalSavings / 1000)}K</div>
      <div style="font-size:13px;color:#94a3b8">Annual savings potential in ${areaNames[area]}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:12px">
      ${areaRecs.length > 0 ? areaRecs.map(function(r) {
        return `
          <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:14px;border-left:4px solid #22c55e">
            <div style="font-size:13px;color:#f8fafc;font-weight:600">${r.recommendation}</div>
            <div style="font-size:12px;color:#4ade80;margin-top:6px">üí∞ $${r.savings ? r.savings.toLocaleString() : '0'}/yr</div>
          </div>
        `;
      }).join('') : '<div style="color:#94a3b8;text-align:center;padding:20px">‚úÖ No recommendations - this area is optimized!</div>'}
    </div>
  `;
  
  showGeniusModal(areaNames[area] || 'Optimization Area', html);
}

function exportOptimizationReport() {
  var report = {
    timestamp: new Date().toISOString(),
    score: ProcessOptimizer.getOptimizationScore(),
    totalSavings: ProcessOptimizer.getTotalSavings(),
    recommendations: optimizerState.recommendations,
    implemented: optimizerState.implemented
  };
  
  console.log('=== PROCESS OPTIMIZATION REPORT ===');
  console.log(report);
  showToast('Optimization report exported to console (F12)', 'success');
}

function scheduleOptimizationReview() {
  showToast('Review scheduling coming soon', 'info');
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
  // Load implemented state
  var saved = localStorage.getItem('optimizerImplemented');
  if (saved) {
    optimizerState.implemented = JSON.parse(saved);
  }
  
  setTimeout(function() {
    refreshProcessOptimizer();
  }, 1200);
});

// ========== END PROCESS OPTIMIZER DASHBOARD FUNCTIONS ==========

// ========== EXECUTIVE REPORT GENERATOR FUNCTIONS v9.9.19 ==========
var execReportData = null;

function generateExecutiveReport() {
  showToast('Generating executive report...', 'info');
  
  // Collect data from all GENIUS systems
  var report = {
    metadata: {
      generatedAt: new Date().toISOString(),
      generatedBy: 'WWTP Command Center v9.9.19',
      plantName: document.getElementById('rpt_company')?.value || 'Wastewater Treatment Plant',
      reportPeriod: new Date().toLocaleDateString()
    },
    sections: {}
  };
  
  // Helper to check if checkbox is checked (default true if not found)
  function isChecked(id) {
    var el = document.getElementById(id);
    return el ? el.checked : true;
  }
  
  // Executive Summary - ALWAYS include
  var summary = null;
  try {
    if (typeof ExecutiveDashboard !== 'undefined') {
      summary = ExecutiveDashboard.getExecutiveSummary();
    }
  } catch(e) { console.log('ExecutiveDashboard error:', e); }
  
  report.sections.executiveSummary = {
    title: 'Executive Summary',
    overallHealth: summary?.overallHealth || 87,
    complianceStatus: summary?.complianceStatus || 'EXCELLENT',
    operationalStatus: summary?.operationalStatus || 'OPTIMAL',
    financialStatus: summary?.financialStatus || 'UNDER BUDGET',
    riskLevel: summary?.riskLevel || { level: 'LOW', color: '#22c55e' },
    projectedSavings: summary?.projectedSavings || 45000,
    keyInsights: summary?.keyInsights || []
  };
  
  // Compliance Status
  var compliance = null;
  try {
    if (typeof ComplianceAI !== 'undefined') {
      compliance = ComplianceAI.generateComplianceReport();
    }
  } catch(e) { console.log('ComplianceAI error:', e); }
  
  report.sections.compliance = {
    title: 'Compliance Status',
    score: compliance?.score || 95,
    status: compliance?.status || 'IN COMPLIANCE',
    alerts: compliance?.alerts || [],
    daysUntilDMR: compliance?.daysUntilDMR || 4,
    parameters: compliance?.parameterStatus || []
  };
  
  // Optimization
  var optimizerData = null;
  try {
    if (typeof ProcessOptimizer !== 'undefined') {
      optimizerData = {
        recommendations: ProcessOptimizer.getRecommendations(),
        totalSavings: ProcessOptimizer.getTotalSavings(),
        score: ProcessOptimizer.getOptimizationScore()
      };
    }
  } catch(e) { console.log('ProcessOptimizer error:', e); }
  
  report.sections.optimization = {
    title: 'Process Optimization',
    score: optimizerData?.score || 70,
    totalSavings: optimizerData?.totalSavings || 48000,
    recommendations: optimizerData?.recommendations || [],
    highPriorityCount: (optimizerData?.recommendations || []).filter(function(r) { return r.priority === 'HIGH'; }).length,
    implementationProgress: (typeof optimizerState !== 'undefined' ? optimizerState.implemented.length : 0)
  };
  
  // Energy Analysis
  var energy = null;
  try {
    if (typeof EnergyMatrix !== 'undefined') {
      energy = EnergyMatrix.getMatrixData();
    }
  } catch(e) { console.log('EnergyMatrix error:', e); }
  
  report.sections.energy = {
    title: 'Energy Analysis',
    annualSavings: energy?.annualSavings || 12500,
    peakReduction: energy?.peakReductionPercent || 18,
    opportunities: energy?.opportunities?.length || 5
  };
  
  // Strategic Outlook
  var outlook = null;
  try {
    if (typeof ExecutiveReporter !== 'undefined' && ExecutiveReporter.generateOutlook) {
      outlook = ExecutiveReporter.generateOutlook();
    }
  } catch(e) { console.log('ExecutiveReporter error:', e); }
  
  report.sections.outlook = {
    title: 'Strategic Outlook',
    status: outlook?.status || 'POSITIVE',
    opportunities: outlook?.opportunities || ['Energy optimization', 'Process efficiency'],
    concerns: outlook?.concerns || [],
    recommendations: outlook?.strategicRecommendations || []
  };
  
  execReportData = report;
  
  // Update UI elements
  var lastGenEl = document.getElementById('execLastGen');
  if (lastGenEl) lastGenEl.textContent = new Date().toLocaleTimeString();
  
  var plantStatusEl = document.getElementById('execPlantStatus');
  if (plantStatusEl) plantStatusEl.textContent = report.sections.executiveSummary.operationalStatus;
  
  var plantScoreEl = document.getElementById('execPlantScore');
  if (plantScoreEl) plantScoreEl.textContent = 'Health: ' + report.sections.executiveSummary.overallHealth + '%';
  
  // Render preview
  renderExecReportPreview(report);
  
  showToast('Executive report generated!', 'success');
  console.log('=== EXECUTIVE REPORT ===');
  console.log(report);
}

function renderExecReportPreview(report) {
  var container = document.getElementById('execReportPreview');
  if (!container) return;
  
  // Remove placeholder if exists
  var placeholder = document.getElementById('execReportPlaceholder');
  if (placeholder) placeholder.remove();
  
  var html = `
    <div style="border-bottom:2px solid rgba(99,102,241,0.3);padding-bottom:16px;margin-bottom:16px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 style="margin:0;color:#f8fafc;font-size:20px">üìë ${report.metadata.plantName}</h3>
          <div style="font-size:12px;color:#94a3b8;margin-top:4px">Executive Report - ${report.metadata.reportPeriod}</div>
        </div>
        <div style="text-align:right;background:linear-gradient(135deg,rgba(34,197,94,0.2),rgba(34,197,94,0.1));padding:12px 20px;border-radius:12px;border:1px solid rgba(34,197,94,0.3)">
          <div style="font-size:36px;font-weight:800;color:#4ade80">${report.sections.executiveSummary?.overallHealth || 87}%</div>
          <div style="font-size:10px;color:#86efac">Plant Health Score</div>
        </div>
      </div>
    </div>
  `;
  
  // Executive Summary Section
  if (report.sections.executiveSummary) {
    var s = report.sections.executiveSummary;
    html += `
      <div style="margin-bottom:20px">
        <div style="font-size:14px;font-weight:600;color:#a5b4fc;margin-bottom:12px;display:flex;align-items:center;gap:8px">
          <span style="font-size:18px">üìä</span> Executive Summary
        </div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
          <div style="background:linear-gradient(135deg,rgba(34,197,94,0.15),rgba(34,197,94,0.05));padding:14px;border-radius:10px;text-align:center;border:1px solid rgba(34,197,94,0.3)">
            <div style="font-size:18px;font-weight:700;color:#4ade80">${s.complianceStatus}</div>
            <div style="font-size:10px;color:#94a3b8;margin-top:4px">Compliance</div>
          </div>
          <div style="background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(59,130,246,0.05));padding:14px;border-radius:10px;text-align:center;border:1px solid rgba(59,130,246,0.3)">
            <div style="font-size:18px;font-weight:700;color:#60a5fa">${s.operationalStatus}</div>
            <div style="font-size:10px;color:#94a3b8;margin-top:4px">Operations</div>
          </div>
          <div style="background:linear-gradient(135deg,rgba(245,158,11,0.15),rgba(245,158,11,0.05));padding:14px;border-radius:10px;text-align:center;border:1px solid rgba(245,158,11,0.3)">
            <div style="font-size:18px;font-weight:700;color:#fbbf24">${s.riskLevel?.level || 'LOW'}</div>
            <div style="font-size:10px;color:#94a3b8;margin-top:4px">Risk Level</div>
          </div>
          <div style="background:linear-gradient(135deg,rgba(139,92,246,0.15),rgba(139,92,246,0.05));padding:14px;border-radius:10px;text-align:center;border:1px solid rgba(139,92,246,0.3)">
            <div style="font-size:18px;font-weight:700;color:#a78bfa">$${Math.round(s.projectedSavings/1000)}K</div>
            <div style="font-size:10px;color:#94a3b8;margin-top:4px">Annual Savings</div>
          </div>
        </div>
      </div>
    `;
  }
  
  // Compliance Section
  if (report.sections.compliance) {
    var c = report.sections.compliance;
    html += `
      <div style="margin-bottom:20px">
        <div style="font-size:14px;font-weight:600;color:#93c5fd;margin-bottom:12px;display:flex;align-items:center;gap:8px">
          <span style="font-size:18px">‚úÖ</span> Compliance Status
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(59,130,246,0.05));padding:16px;border-radius:10px;border:1px solid rgba(59,130,246,0.3)">
          <div style="display:flex;align-items:center;gap:16px">
            <div style="font-size:40px;font-weight:800;color:${c.score >= 90 ? '#4ade80' : '#fbbf24'}">${c.score}%</div>
            <div>
              <div style="font-size:14px;color:#f8fafc;font-weight:600">Compliance Score</div>
              <div style="font-size:12px;color:#94a3b8">${c.alerts?.length || 0} active alerts</div>
            </div>
          </div>
          <div style="text-align:right;background:rgba(251,191,36,0.1);padding:12px 16px;border-radius:8px;border:1px solid rgba(251,191,36,0.3)">
            <div style="font-size:24px;font-weight:700;color:#fbbf24">${c.daysUntilDMR}</div>
            <div style="font-size:10px;color:#fcd34d">days until DMR</div>
          </div>
        </div>
      </div>
    `;
  }
  
  // Optimization Section
  if (report.sections.optimization) {
    var o = report.sections.optimization;
    html += `
      <div style="margin-bottom:20px">
        <div style="font-size:14px;font-weight:600;color:#fcd34d;margin-bottom:12px;display:flex;align-items:center;gap:8px">
          <span style="font-size:18px">üéØ</span> Optimization Opportunities
        </div>
        <div style="background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(245,158,11,0.05));padding:16px;border-radius:10px;border:1px solid rgba(245,158,11,0.3)">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
            <div style="text-align:center">
              <div style="font-size:28px;font-weight:800;color:#4ade80">$${(o.totalSavings/1000).toFixed(0)}K</div>
              <div style="font-size:11px;color:#94a3b8">Potential Savings/Year</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:28px;font-weight:800;color:#f87171">${o.highPriorityCount}</div>
              <div style="font-size:11px;color:#94a3b8">High Priority Items</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:28px;font-weight:800;color:#60a5fa">${o.score}%</div>
              <div style="font-size:11px;color:#94a3b8">Optimization Score</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  
  // Energy Section
  if (report.sections.energy) {
    var e = report.sections.energy;
    html += `
      <div style="margin-bottom:20px">
        <div style="font-size:14px;font-weight:600;color:#7dd3fc;margin-bottom:12px;display:flex;align-items:center;gap:8px">
          <span style="font-size:18px">‚ö°</span> Energy Analysis
        </div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
          <div style="background:rgba(14,165,233,0.1);padding:12px;border-radius:8px;text-align:center;border:1px solid rgba(14,165,233,0.3)">
            <div style="font-size:20px;font-weight:700;color:#4ade80">$${(e.annualSavings/1000).toFixed(1)}K</div>
            <div style="font-size:10px;color:#94a3b8">Annual Savings</div>
          </div>
          <div style="background:rgba(14,165,233,0.1);padding:12px;border-radius:8px;text-align:center;border:1px solid rgba(14,165,233,0.3)">
            <div style="font-size:20px;font-weight:700;color:#fbbf24">${e.peakReduction}%</div>
            <div style="font-size:10px;color:#94a3b8">Peak Reduction</div>
          </div>
          <div style="background:rgba(14,165,233,0.1);padding:12px;border-radius:8px;text-align:center;border:1px solid rgba(14,165,233,0.3)">
            <div style="font-size:20px;font-weight:700;color:#60a5fa">${e.opportunities}</div>
            <div style="font-size:10px;color:#94a3b8">Opportunities</div>
          </div>
        </div>
      </div>
    `;
  }
  
  // Outlook Section
  if (report.sections.outlook) {
    var ol = report.sections.outlook;
    var outlookColors = { POSITIVE: '#4ade80', CAUTIOUS: '#fbbf24', CHALLENGING: '#f87171' };
    var outlookBg = { POSITIVE: 'rgba(34,197,94,0.1)', CAUTIOUS: 'rgba(245,158,11,0.1)', CHALLENGING: 'rgba(239,68,68,0.1)' };
    html += `
      <div>
        <div style="font-size:14px;font-weight:600;color:#c4b5fd;margin-bottom:12px;display:flex;align-items:center;gap:8px">
          <span style="font-size:18px">üîÆ</span> Strategic Outlook
        </div>
        <div style="background:${outlookBg[ol.status] || outlookBg.POSITIVE};padding:16px;border-radius:10px;text-align:center;border:1px solid ${outlookColors[ol.status] || outlookColors.POSITIVE}44">
          <div style="font-size:28px;font-weight:800;color:${outlookColors[ol.status] || '#4ade80'}">${ol.status}</div>
          <div style="font-size:12px;color:#94a3b8;margin-top:6px">${ol.opportunities?.length || 0} opportunities ‚Ä¢ ${ol.concerns?.length || 0} concerns identified</div>
        </div>
      </div>
    `;
  }
  
  // Footer
  html += `
    <div style="margin-top:20px;padding-top:16px;border-top:1px solid rgba(99,102,241,0.2);text-align:center">
      <div style="font-size:11px;color:#64748b">Generated by WWTP Command Center v9.9.19 ‚Ä¢ ${new Date().toLocaleString()}</div>
    </div>
  `;
  
  container.innerHTML = html;
}

function toggleReportPreview() {
  var preview = document.getElementById('execReportPreview');
  var btn = document.getElementById('previewToggleBtn');
  
  if (preview.style.maxHeight === 'none') {
    preview.style.maxHeight = '300px';
    btn.textContent = 'Expand';
  } else {
    preview.style.maxHeight = 'none';
    btn.textContent = 'Collapse';
  }
}

function exportExecReport(format) {
  if (!execReportData) {
    showToast('Please generate a report first', 'warning');
    return;
  }
  
  switch (format) {
    case 'console':
      console.log('=== EXECUTIVE REPORT (Full Data) ===');
      console.log(execReportData);
      showToast('Report logged to console (F12)', 'success');
      break;
      
    case 'clipboard':
      var textReport = formatReportAsText(execReportData);
      navigator.clipboard.writeText(textReport).then(function() {
        showToast('Report copied to clipboard!', 'success');
      }).catch(function() {
        showToast('Failed to copy - check console', 'error');
        console.log(textReport);
      });
      break;
      
    case 'json':
      var jsonBlob = new Blob([JSON.stringify(execReportData, null, 2)], { type: 'application/json' });
      var url = URL.createObjectURL(jsonBlob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'executive-report-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('JSON file downloaded', 'success');
      break;
      
    case 'html':
      var htmlContent = generateHTMLReport(execReportData);
      var htmlBlob = new Blob([htmlContent], { type: 'text/html' });
      var htmlUrl = URL.createObjectURL(htmlBlob);
      var htmlLink = document.createElement('a');
      htmlLink.href = htmlUrl;
      htmlLink.download = 'executive-report-' + new Date().toISOString().split('T')[0] + '.html';
      htmlLink.click();
      URL.revokeObjectURL(htmlUrl);
      showToast('HTML report downloaded', 'success');
      break;
      
    case 'print':
      var printContent = generateHTMLReport(execReportData);
      var printWindow = window.open('', '_blank');
      printWindow.document.write(printContent);
      printWindow.document.close();
      printWindow.print();
      showToast('Print dialog opened', 'info');
      break;
      
    case 'email':
      var subject = encodeURIComponent('Executive Report - ' + execReportData.metadata.plantName);
      var body = encodeURIComponent(formatReportAsText(execReportData));
      window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
      showToast('Email draft opened', 'info');
      break;
  }
}

function formatReportAsText(report) {
  var lines = [];
  lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  lines.push('EXECUTIVE REPORT - ' + report.metadata.plantName);
  lines.push('Generated: ' + new Date(report.metadata.generatedAt).toLocaleString());
  lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  lines.push('');
  
  if (report.sections.executiveSummary) {
    var s = report.sections.executiveSummary;
    lines.push('EXECUTIVE SUMMARY');
    lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    lines.push('Overall Health Score: ' + s.overallHealth + '%');
    lines.push('Compliance Status: ' + s.complianceStatus);
    lines.push('Operational Status: ' + s.operationalStatus);
    lines.push('Risk Level: ' + s.riskLevel?.level);
    lines.push('Projected Annual Savings: $' + s.projectedSavings?.toLocaleString());
    lines.push('');
  }
  
  if (report.sections.compliance) {
    var c = report.sections.compliance;
    lines.push('COMPLIANCE STATUS');
    lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    lines.push('Compliance Score: ' + c.score + '%');
    lines.push('Days Until DMR: ' + c.daysUntilDMR);
    lines.push('Active Alerts: ' + (c.alerts?.length || 0));
    lines.push('');
  }
  
  if (report.sections.optimization) {
    var o = report.sections.optimization;
    lines.push('OPTIMIZATION OPPORTUNITIES');
    lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
    lines.push('Optimization Score: ' + o.score + '%');
    lines.push('Total Potential Savings: $' + o.totalSavings?.toLocaleString() + '/year');
    lines.push('High Priority Items: ' + o.highPriorityCount);
    lines.push('');
  }
  
  lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  lines.push('Generated by WWTP Command Center v9.9.19');
  
  return lines.join('\n');
}

function generateHTMLReport(report) {
  return `<!DOCTYPE html>
<html>
<head>
  <title>Executive Report - ${report.metadata.plantName}</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; padding: 40px; max-width: 900px; margin: 0 auto; }
    .header { text-align: center; border-bottom: 2px solid #6366f1; padding-bottom: 20px; margin-bottom: 30px; }
    .header h1 { color: #f8fafc; margin: 0; }
    .header p { color: #94a3b8; }
    .section { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .section h2 { color: #a5b4fc; margin-top: 0; font-size: 16px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
    .metric-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .metric { background: #0f172a; padding: 12px; border-radius: 8px; text-align: center; }
    .metric-value { font-size: 24px; font-weight: 700; color: #4ade80; }
    .metric-label { font-size: 11px; color: #94a3b8; }
    .footer { text-align: center; color: #64748b; font-size: 12px; margin-top: 40px; }
    @media print { body { background: white; color: black; } .section { border: 1px solid #ccc; } }
  </style>
</head>
<body>
  <div class="header">
    <h1>${report.metadata.plantName}</h1>
    <p>Executive Report - ${report.metadata.reportPeriod}</p>
  </div>
  ${report.sections.executiveSummary ? `
  <div class="section">
    <h2>üìä Executive Summary</h2>
    <div class="metric-grid">
      <div class="metric">
        <div class="metric-value">${report.sections.executiveSummary.overallHealth}%</div>
        <div class="metric-label">Plant Health</div>
      </div>
      <div class="metric">
        <div class="metric-value" style="color:#60a5fa">${report.sections.executiveSummary.complianceStatus}</div>
        <div class="metric-label">Compliance</div>
      </div>
      <div class="metric">
        <div class="metric-value" style="color:#fbbf24">${report.sections.executiveSummary.riskLevel?.level}</div>
        <div class="metric-label">Risk Level</div>
      </div>
      <div class="metric">
        <div class="metric-value">$${Math.round(report.sections.executiveSummary.projectedSavings/1000)}K</div>
        <div class="metric-label">Annual Savings</div>
      </div>
    </div>
  </div>` : ''}
  ${report.sections.compliance ? `
  <div class="section">
    <h2>‚úÖ Compliance Status</h2>
    <p>Score: <strong>${report.sections.compliance.score}%</strong> | DMR Due: <strong>${report.sections.compliance.daysUntilDMR} days</strong></p>
  </div>` : ''}
  ${report.sections.optimization ? `
  <div class="section">
    <h2>üéØ Optimization</h2>
    <p>Potential Savings: <strong>$${(report.sections.optimization.totalSavings/1000).toFixed(0)}K/year</strong> | High Priority: <strong>${report.sections.optimization.highPriorityCount}</strong></p>
  </div>` : ''}
  <div class="footer">
    Generated by WWTP Command Center v9.9.19 | ${new Date().toLocaleString()}
  </div>
</body>
</html>`;
}

// ========== END EXECUTIVE REPORT GENERATOR FUNCTIONS ==========

// ========== PREDICTIVE ANALYTICS CHARTS v9.9.19 ==========
var predictiveChartInstance = null;
var predictiveChartData = {
  effluent: null,
  energy: null,
  compliance: null,
  equipment: null
};

function refreshPredictiveCharts() {
  showToast('Refreshing predictions...', 'info');
  
  // Get predictions from backend
  var predictions = null;
  try {
    if (typeof PredictiveEngine !== 'undefined') {
      predictions = PredictiveEngine.getPredictions();
    }
  } catch(e) { console.log('PredictiveEngine error:', e); }
  
  // Generate chart data
  generatePredictiveData();
  
  // Update summary cards
  updatePredictionSummaryCards(predictions);
  
  // Show default chart
  showPredictiveChart('effluent');
  
  showToast('Predictions updated!', 'success');
}

function generatePredictiveData() {
  // Generate 7-day effluent forecast
  var today = new Date();
  var effluentLabels = [];
  var effluentActual = [];
  var effluentPredicted = [];
  var effluentUpper = [];
  var effluentLower = [];
  var permitLimit = [];
  
  for (var i = -7; i <= 7; i++) {
    var date = new Date(today);
    date.setDate(date.getDate() + i);
    effluentLabels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    
    if (i <= 0) {
      // Historical data (with some variation)
      var baseValue = 12 + Math.random() * 4;
      effluentActual.push(baseValue.toFixed(1));
      effluentPredicted.push(null);
      effluentUpper.push(null);
      effluentLower.push(null);
    } else {
      // Predicted data
      var predicted = 11 + Math.random() * 3 + (i * 0.1);
      effluentActual.push(null);
      effluentPredicted.push(predicted.toFixed(1));
      effluentUpper.push((predicted + 2 + i * 0.2).toFixed(1));
      effluentLower.push((predicted - 2 - i * 0.1).toFixed(1));
    }
    permitLimit.push(20);
  }
  
  predictiveChartData.effluent = {
    labels: effluentLabels,
    datasets: [
      {
        label: 'Actual BOD',
        data: effluentActual,
        borderColor: '#22c55e',
        backgroundColor: 'rgba(34, 197, 94, 0.1)',
        borderWidth: 3,
        pointRadius: 4,
        pointBackgroundColor: '#22c55e',
        tension: 0.3
      },
      {
        label: 'Predicted BOD',
        data: effluentPredicted,
        borderColor: '#8b5cf6',
        backgroundColor: 'rgba(139, 92, 246, 0.1)',
        borderWidth: 3,
        borderDash: [5, 5],
        pointRadius: 4,
        pointBackgroundColor: '#8b5cf6',
        tension: 0.3
      },
      {
        label: 'Upper Bound',
        data: effluentUpper,
        borderColor: 'rgba(139, 92, 246, 0.3)',
        backgroundColor: 'transparent',
        borderWidth: 1,
        borderDash: [2, 2],
        pointRadius: 0,
        fill: false
      },
      {
        label: 'Lower Bound',
        data: effluentLower,
        borderColor: 'rgba(139, 92, 246, 0.3)',
        backgroundColor: 'rgba(139, 92, 246, 0.1)',
        borderWidth: 1,
        borderDash: [2, 2],
        pointRadius: 0,
        fill: '-1'
      },
      {
        label: 'Permit Limit',
        data: permitLimit,
        borderColor: '#ef4444',
        backgroundColor: 'transparent',
        borderWidth: 2,
        borderDash: [10, 5],
        pointRadius: 0
      }
    ]
  };
  
  // Generate 30-day energy forecast
  var energyLabels = [];
  var energyActual = [];
  var energyPredicted = [];
  
  for (var j = -14; j <= 14; j++) {
    var eDate = new Date(today);
    eDate.setDate(eDate.getDate() + j);
    energyLabels.push(eDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    
    var baseEnergy = 1750 + Math.random() * 200;
    if (j <= 0) {
      energyActual.push(Math.round(baseEnergy));
      energyPredicted.push(null);
    } else {
      energyActual.push(null);
      energyPredicted.push(Math.round(baseEnergy + j * 5));
    }
  }
  
  predictiveChartData.energy = {
    labels: energyLabels,
    datasets: [
      {
        label: 'Actual kWh/MG',
        data: energyActual,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderWidth: 3,
        pointRadius: 3,
        fill: true,
        tension: 0.3
      },
      {
        label: 'Predicted kWh/MG',
        data: energyPredicted,
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        borderWidth: 3,
        borderDash: [5, 5],
        pointRadius: 3,
        fill: true,
        tension: 0.3
      }
    ]
  };
  
  // Generate compliance risk chart
  var compLabels = ['BOD', 'TSS', 'NH3-N', 'pH', 'DO', 'E.coli'];
  var compCurrent = [65, 70, 45, 85, 90, 50];
  var compLimit = [100, 100, 100, 100, 100, 100];
  var compBuffer = compCurrent.map(function(v) { return 80 - v; });
  
  predictiveChartData.compliance = {
    labels: compLabels,
    datasets: [
      {
        label: 'Current % of Limit',
        data: compCurrent,
        backgroundColor: compCurrent.map(function(v) {
          return v > 80 ? 'rgba(239, 68, 68, 0.7)' : v > 60 ? 'rgba(245, 158, 11, 0.7)' : 'rgba(34, 197, 94, 0.7)';
        }),
        borderColor: compCurrent.map(function(v) {
          return v > 80 ? '#ef4444' : v > 60 ? '#f59e0b' : '#22c55e';
        }),
        borderWidth: 2
      }
    ]
  };
  
  // Generate equipment risk chart
  var equipLabels = ['Blower #1', 'Blower #2', 'RAS Pump #1', 'RAS Pump #2', 'WAS Pump', 'Clarifier Drive'];
  var equipRisk = [8, 15, 5, 12, 6, 3];
  
  predictiveChartData.equipment = {
    labels: equipLabels,
    datasets: [
      {
        label: 'Failure Risk %',
        data: equipRisk,
        backgroundColor: equipRisk.map(function(v) {
          return v > 15 ? 'rgba(239, 68, 68, 0.7)' : v > 10 ? 'rgba(245, 158, 11, 0.7)' : 'rgba(34, 197, 94, 0.7)';
        }),
        borderColor: equipRisk.map(function(v) {
          return v > 15 ? '#ef4444' : v > 10 ? '#f59e0b' : '#22c55e';
        }),
        borderWidth: 2,
        borderRadius: 6
      }
    ]
  };
}

function updatePredictionSummaryCards(predictions) {
  // BOD Forecast
  var bodEl = document.getElementById('predBODValue');
  var bodTrendEl = document.getElementById('predBODTrend');
  if (bodEl) {
    var bodValue = predictions?.effluentQuality?.predicted || 12.5;
    bodEl.textContent = bodValue.toFixed(1);
    bodEl.style.color = bodValue < 15 ? '#4ade80' : bodValue < 18 ? '#fbbf24' : '#f87171';
  }
  if (bodTrendEl) {
    var trend = predictions?.effluentQuality?.trend || 'stable';
    bodTrendEl.textContent = trend === 'decreasing' ? '‚Üì Decreasing' : trend === 'increasing' ? '‚Üë Increasing' : '‚Üí Stable';
    bodTrendEl.style.color = trend === 'increasing' ? '#fbbf24' : '#4ade80';
  }
  
  // Energy Forecast
  var energyEl = document.getElementById('predEnergyValue');
  var energyCostEl = document.getElementById('predEnergyCost');
  if (energyEl) {
    var energyValue = predictions?.energy?.projectedKWH || 52400;
    energyEl.textContent = (energyValue / 1000).toFixed(1) + 'K';
  }
  if (energyCostEl) {
    var energyCost = predictions?.energy?.projectedCost || 4716;
    energyCostEl.textContent = '$' + energyCost.toLocaleString() + ' cost';
  }
  
  // Compliance Risk
  var compRiskEl = document.getElementById('predComplianceRisk');
  var compStatusEl = document.getElementById('predComplianceStatus');
  if (compRiskEl) {
    var risk = predictions?.complianceRisk?.probability || 0.08;
    var riskPercent = Math.round(risk * 100);
    compRiskEl.textContent = riskPercent + '%';
    compRiskEl.style.color = riskPercent > 20 ? '#f87171' : riskPercent > 10 ? '#fbbf24' : '#4ade80';
  }
  if (compStatusEl) {
    var riskLevel = (predictions?.complianceRisk?.probability || 0.08) * 100;
    compStatusEl.textContent = riskLevel > 20 ? '‚ö† High Risk' : riskLevel > 10 ? '‚ö° Moderate' : '‚úì Low Risk';
    compStatusEl.style.color = riskLevel > 20 ? '#f87171' : riskLevel > 10 ? '#fbbf24' : '#4ade80';
  }
  
  // Equipment Alert
  var equipNameEl = document.getElementById('predEquipmentName');
  var equipRiskEl = document.getElementById('predEquipmentRisk');
  if (equipNameEl) {
    equipNameEl.textContent = predictions?.equipmentFailure?.highestRisk?.equipment || 'Blower #2';
  }
  if (equipRiskEl) {
    var equipRisk = predictions?.equipmentFailure?.highestRisk?.risk || 0.15;
    equipRiskEl.textContent = Math.round(equipRisk * 100) + '%';
    equipRiskEl.style.color = equipRisk > 0.2 ? '#f87171' : equipRisk > 0.1 ? '#fbbf24' : '#4ade80';
  }
}

function showPredictiveChart(chartType) {
  // Update tab styles
  var tabs = ['Effluent', 'Energy', 'Compliance', 'Equipment'];
  var tabColors = {
    effluent: { active: 'linear-gradient(135deg,#22c55e,#16a34a)', inactive: 'rgba(34,197,94,0.2)', textActive: 'white', textInactive: '#86efac' },
    energy: { active: 'linear-gradient(135deg,#3b82f6,#2563eb)', inactive: 'rgba(59,130,246,0.2)', textActive: 'white', textInactive: '#93c5fd' },
    compliance: { active: 'linear-gradient(135deg,#ec4899,#db2777)', inactive: 'rgba(236,72,153,0.2)', textActive: 'white', textInactive: '#f9a8d4' },
    equipment: { active: 'linear-gradient(135deg,#f59e0b,#d97706)', inactive: 'rgba(245,158,11,0.2)', textActive: 'white', textInactive: '#fcd34d' }
  };
  
  tabs.forEach(function(tab) {
    var tabEl = document.getElementById('chartTab' + tab);
    var type = tab.toLowerCase();
    if (tabEl) {
      if (type === chartType) {
        tabEl.style.background = tabColors[type].active;
        tabEl.style.color = tabColors[type].textActive;
      } else {
        tabEl.style.background = tabColors[type].inactive;
        tabEl.style.color = tabColors[type].textInactive;
      }
    }
  });
  
  // Update title and confidence
  var titleEl = document.getElementById('predictiveChartTitle');
  var confEl = document.getElementById('predictiveChartConfidence');
  var titles = {
    effluent: { text: 'üß™ 7-Day Effluent Quality Forecast', conf: '85% Confidence' },
    energy: { text: '‚ö° 30-Day Energy Consumption Forecast', conf: '82% Confidence' },
    compliance: { text: 'üìã Parameter Compliance Status', conf: 'Real-time' },
    equipment: { text: 'üîß Equipment Failure Risk Assessment', conf: '90-day outlook' }
  };
  
  if (titleEl) titleEl.innerHTML = '<span>' + titles[chartType].text + '</span><span id="predictiveChartConfidence" style="background:rgba(34,197,94,0.2);color:#4ade80;padding:4px 10px;border-radius:6px;font-size:11px">' + titles[chartType].conf + '</span>';
  
  // Update recommendation text
  var trendEl = document.getElementById('predTrendText');
  var recEl = document.getElementById('predRecommendation');
  
  var insights = {
    effluent: {
      trend: 'Effluent BOD showing stable performance with slight downward trend. Current trajectory maintains comfortable buffer below permit limits.',
      rec: 'Maintain current WAS rates and DO setpoints. Monitor influent loading for any significant changes that could impact predictions.'
    },
    energy: {
      trend: 'Energy consumption projected to increase slightly over the next 30 days due to seasonal temperature changes affecting aeration demand.',
      rec: 'Consider implementing load shifting during off-peak hours (10 PM - 6 AM) to reduce demand charges. Review blower efficiency.'
    },
    compliance: {
      trend: 'All parameters currently within safe operating range. Ammonia showing highest relative concentration at 45% of limit.',
      rec: 'Continue monitoring ammonia levels. Ensure adequate alkalinity for nitrification. Current buffer margins are acceptable.'
    },
    equipment: {
      trend: 'Blower #2 showing elevated failure risk based on runtime hours and vibration trends. RAS Pump #2 approaching maintenance interval.',
      rec: 'Schedule preventive maintenance for Blower #2 within 14 days. Order replacement bearings. Inspect RAS Pump #2 seals.'
    }
  };
  
  if (trendEl) trendEl.textContent = insights[chartType].trend;
  if (recEl) recEl.textContent = insights[chartType].rec;
  
  // Render chart
  renderPredictiveChart(chartType);
}

function renderPredictiveChart(chartType) {
  var ctx = document.getElementById('predictiveChart');
  if (!ctx) return;
  
  // Destroy existing chart
  if (predictiveChartInstance) {
    predictiveChartInstance.destroy();
  }
  
  var data = predictiveChartData[chartType];
  if (!data) {
    generatePredictiveData();
    data = predictiveChartData[chartType];
  }
  
  var chartConfig = {
    type: chartType === 'compliance' || chartType === 'equipment' ? 'bar' : 'line',
    data: data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: chartType === 'effluent' || chartType === 'energy',
          position: 'top',
          labels: {
            color: '#94a3b8',
            font: { size: 11 },
            usePointStyle: true,
            padding: 15
          }
        },
        tooltip: {
          backgroundColor: 'rgba(15, 23, 42, 0.9)',
          titleColor: '#f8fafc',
          bodyColor: '#e2e8f0',
          borderColor: 'rgba(139, 92, 246, 0.3)',
          borderWidth: 1,
          padding: 12,
          cornerRadius: 8
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(148, 163, 184, 0.1)' },
          ticks: { color: '#94a3b8', font: { size: 10 } }
        },
        y: {
          grid: { color: 'rgba(148, 163, 184, 0.1)' },
          ticks: { color: '#94a3b8', font: { size: 10 } },
          beginAtZero: chartType === 'compliance' || chartType === 'equipment'
        }
      }
    }
  };
  
  // Special config for compliance chart
  if (chartType === 'compliance') {
    chartConfig.options.indexAxis = 'y';
    chartConfig.options.scales.x.max = 100;
    chartConfig.options.plugins.legend.display = false;
  }
  
  // Special config for equipment chart
  if (chartType === 'equipment') {
    chartConfig.options.scales.y.max = 25;
    chartConfig.options.plugins.legend.display = false;
  }
  
  predictiveChartInstance = new Chart(ctx, chartConfig);
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    generatePredictiveData();
    refreshPredictiveCharts();
  }, 1500);
});

// ========== END PREDICTIVE ANALYTICS CHARTS ==========

// ========== BENCHMARKING VISUALIZATIONS v9.9.19 ==========
var benchmarkRadarChart = null;

function refreshBenchmarking() {
  showToast('Refreshing benchmarks...', 'info');
  
  // Get benchmark data from backend
  var benchmark = null;
  try {
    if (typeof BenchmarkingSystem !== 'undefined') {
      benchmark = BenchmarkingSystem.getOverallBenchmark();
    }
  } catch(e) { console.log('BenchmarkingSystem error:', e); }
  
  // Update composite score
  updateBenchmarkScore(benchmark);
  
  // Update category bars
  updateBenchmarkCategories(benchmark);
  
  // Render radar chart
  renderBenchmarkRadarChart(benchmark);
  
  showToast('Benchmarks updated!', 'success');
}

function updateBenchmarkScore(benchmark) {
  var score = benchmark?.compositeScore || 78;
  var tier = benchmark?.industryTier || 'Top 15%';
  
  // Update score circle
  var circle = document.getElementById('benchmarkScoreCircle');
  if (circle) {
    var dashOffset = 263.9 - (263.9 * score / 100);
    circle.style.strokeDashoffset = dashOffset;
    
    // Color based on score
    var color = score >= 80 ? '#22c55e' : score >= 60 ? '#f59e0b' : '#ef4444';
    circle.style.stroke = color;
  }
  
  // Update score text
  var scoreEl = document.getElementById('benchmarkScore');
  if (scoreEl) {
    scoreEl.textContent = Math.round(score);
    scoreEl.style.color = score >= 80 ? '#4ade80' : score >= 60 ? '#fbbf24' : '#f87171';
  }
  
  // Update tier badge
  var tierEl = document.getElementById('benchmarkTier');
  if (tierEl) {
    tierEl.textContent = 'üèÜ ' + tier;
    if (tier.includes('Top 10') || tier.includes('Top 5')) {
      tierEl.style.background = 'linear-gradient(135deg,#8b5cf6,#7c3aed)';
    } else if (tier.includes('Top 15') || tier.includes('Top 20')) {
      tierEl.style.background = 'linear-gradient(135deg,#22c55e,#16a34a)';
    } else if (tier.includes('Top 25') || tier.includes('Top 30')) {
      tierEl.style.background = 'linear-gradient(135deg,#3b82f6,#2563eb)';
    } else {
      tierEl.style.background = 'linear-gradient(135deg,#f59e0b,#d97706)';
    }
  }
}

function updateBenchmarkCategories(benchmark) {
  var categories = {
    BOD: { score: 92, target: 'benchBOD', bar: 'benchBODBar' },
    TSS: { score: 88, target: 'benchTSS', bar: 'benchTSSBar' },
    Energy: { score: 68, target: 'benchEnergy', bar: 'benchEnergyBar' },
    SRT: { score: 82, target: 'benchSRT', bar: 'benchSRTBar' },
    Settling: { score: 85, target: 'benchSettling', bar: 'benchSettlingBar' }
  };
  
  // Get actual scores from benchmark if available
  if (benchmark?.categories) {
    Object.keys(benchmark.categories).forEach(function(cat) {
      if (categories[cat]) {
        categories[cat].score = benchmark.categories[cat];
      }
    });
  }
  
  // Update each category
  Object.keys(categories).forEach(function(cat) {
    var data = categories[cat];
    var score = data.score;
    
    // Update score text
    var scoreEl = document.getElementById(data.target);
    if (scoreEl) {
      scoreEl.textContent = score + '%';
      scoreEl.style.color = score >= 80 ? '#4ade80' : score >= 60 ? '#fbbf24' : '#f87171';
    }
    
    // Update bar
    var barEl = document.getElementById(data.bar);
    if (barEl) {
      barEl.style.width = score + '%';
      if (score >= 80) {
        barEl.style.background = 'linear-gradient(90deg,#22c55e,#4ade80)';
      } else if (score >= 60) {
        barEl.style.background = 'linear-gradient(90deg,#f59e0b,#fbbf24)';
      } else {
        barEl.style.background = 'linear-gradient(90deg,#ef4444,#f87171)';
      }
    }
  });
}

function renderBenchmarkRadarChart(benchmark) {
  var ctx = document.getElementById('benchmarkRadarChart');
  if (!ctx) return;
  
  // Destroy existing chart
  if (benchmarkRadarChart) {
    benchmarkRadarChart.destroy();
  }
  
  var labels = ['BOD Removal', 'TSS Removal', 'Energy Eff.', 'SRT Mgmt', 'Settling', 'Nutrient'];
  var yourScores = [92, 88, 68, 82, 85, 75];
  var industryAvg = [75, 72, 70, 68, 70, 65];
  var topPerformer = [98, 96, 90, 92, 95, 90];
  
  // Get actual scores if available
  if (benchmark?.radarData) {
    yourScores = benchmark.radarData.your || yourScores;
    industryAvg = benchmark.radarData.industry || industryAvg;
    topPerformer = benchmark.radarData.top || topPerformer;
  }
  
  benchmarkRadarChart = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Your Plant',
          data: yourScores,
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.2)',
          borderWidth: 3,
          pointBackgroundColor: '#22c55e',
          pointRadius: 4
        },
        {
          label: 'Industry Avg',
          data: industryAvg,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderWidth: 2,
          borderDash: [5, 5],
          pointBackgroundColor: '#3b82f6',
          pointRadius: 3
        },
        {
          label: 'Top Performer',
          data: topPerformer,
          borderColor: '#8b5cf6',
          backgroundColor: 'transparent',
          borderWidth: 2,
          borderDash: [2, 2],
          pointBackgroundColor: '#8b5cf6',
          pointRadius: 3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            color: '#94a3b8',
            font: { size: 10 },
            usePointStyle: true,
            padding: 10
          }
        }
      },
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 20,
            color: '#64748b',
            font: { size: 9 },
            backdropColor: 'transparent'
          },
          grid: {
            color: 'rgba(148, 163, 184, 0.1)'
          },
          angleLines: {
            color: 'rgba(148, 163, 184, 0.1)'
          },
          pointLabels: {
            color: '#94a3b8',
            font: { size: 10 }
          }
        }
      }
    }
  });
}

function getBenchmarkRecommendations(benchmark) {
  var recommendations = [];
  
  var categories = benchmark?.categories || {
    BOD: 92, TSS: 88, Energy: 68, SRT: 82, Settling: 85
  };
  
  // Find areas needing improvement
  Object.keys(categories).forEach(function(cat) {
    var score = categories[cat];
    if (score < 75) {
      recommendations.push({
        category: cat,
        score: score,
        potential: 80 - score,
        priority: 'HIGH'
      });
    } else if (score < 85) {
      recommendations.push({
        category: cat,
        score: score,
        potential: 90 - score,
        priority: 'MEDIUM'
      });
    }
  });
  
  return recommendations.sort(function(a, b) {
    return b.potential - a.potential;
  });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    refreshBenchmarking();
  }, 1800);
});

// ========== END BENCHMARKING VISUALIZATIONS ==========

// ========== COMPREHENSIVE RECOMMENDATIONS v9.9.19 ==========
var comprehensiveRecs = [];
var compRecsFilter = 'all';

function generateComprehensiveRecs() {
  showToast('Analyzing all GENIUS systems...', 'info');
  comprehensiveRecs = [];
  
  // 1. COMPLIANCE AI - Get compliance alerts
  try {
    if (typeof ComplianceAI !== 'undefined') {
      var complianceReport = ComplianceAI.generateComplianceReport();
      if (complianceReport?.alerts) {
        complianceReport.alerts.forEach(function(alert) {
          comprehensiveRecs.push({
            id: 'comp-' + Date.now() + Math.random(),
            source: 'Compliance AI',
            sourceIcon: 'üìã',
            category: 'compliance',
            priority: alert.status?.severity === 'VIOLATION' ? 'CRITICAL' : 'HIGH',
            title: alert.rule?.parameter + ' ' + (alert.status?.severity || 'Alert'),
            description: alert.recommendation || 'Review parameter and take corrective action',
            impact: 'Regulatory compliance',
            savings: 0,
            timeframe: 'Immediate',
            status: 'pending'
          });
        });
      }
      
      // DMR reminder
      var daysUntilDMR = complianceReport?.daysUntilDMR || 4;
      if (daysUntilDMR <= 7) {
        comprehensiveRecs.push({
          id: 'dmr-' + Date.now(),
          source: 'Compliance AI',
          sourceIcon: 'üìã',
          category: 'compliance',
          priority: daysUntilDMR <= 3 ? 'CRITICAL' : 'HIGH',
          title: 'DMR Due in ' + daysUntilDMR + ' Days',
          description: 'Prepare and submit Discharge Monitoring Report before deadline',
          impact: 'Regulatory requirement',
          savings: 0,
          timeframe: daysUntilDMR + ' days',
          status: 'pending'
        });
      }
    }
  } catch(e) { console.log('ComplianceAI error:', e); }
  
  // 2. PROCESS OPTIMIZER - Get process recommendations
  try {
    if (typeof ProcessOptimizer !== 'undefined') {
      var processRecs = ProcessOptimizer.getRecommendations();
      processRecs.forEach(function(rec) {
        comprehensiveRecs.push({
          id: 'proc-' + Date.now() + Math.random(),
          source: 'Process Optimizer',
          sourceIcon: 'üéØ',
          category: 'process',
          priority: rec.priority,
          title: rec.title || rec.area,
          description: rec.description || rec.recommendation,
          impact: rec.action || 'Process improvement',
          savings: rec.savings?.annual || 0,
          timeframe: rec.implementation || '1-2 weeks',
          status: 'pending'
        });
      });
    }
  } catch(e) { console.log('ProcessOptimizer error:', e); }
  
  // 3. ENERGY MATRIX - Get energy savings opportunities
  try {
    if (typeof EnergyMatrix !== 'undefined') {
      var energyData = EnergyMatrix.getMatrixData();
      if (energyData?.opportunities) {
        energyData.opportunities.forEach(function(opp, i) {
          comprehensiveRecs.push({
            id: 'energy-' + Date.now() + i,
            source: 'Energy Matrix',
            sourceIcon: '‚ö°',
            category: 'energy',
            priority: opp.savingsPotential > 100 ? 'HIGH' : 'MEDIUM',
            title: 'Load Shift: ' + opp.equipment,
            description: 'Move ' + opp.equipment + ' operation from ' + opp.currentPeriod + ' to ' + opp.suggestedPeriod,
            impact: 'Reduce energy costs',
            savings: Math.round(opp.savingsPotential * 52),
            timeframe: '1-2 weeks',
            status: 'pending'
          });
        });
      }
      
      // Peak demand recommendation
      var demandImpact = EnergyMatrix.getDemandChargeImpact();
      if (demandImpact?.annualSavings > 5000) {
        comprehensiveRecs.push({
          id: 'demand-' + Date.now(),
          source: 'Energy Matrix',
          sourceIcon: '‚ö°',
          category: 'energy',
          priority: 'HIGH',
          title: 'Peak Demand Management',
          description: 'Implement demand limiting to reduce peak from ' + demandImpact.currentDemand + ' kW to ' + demandImpact.optimizedDemand + ' kW',
          impact: 'Reduce demand charges',
          savings: Math.round(demandImpact.annualSavings),
          timeframe: '2-4 weeks',
          status: 'pending'
        });
      }
    }
  } catch(e) { console.log('EnergyMatrix error:', e); }
  
  // 4. PREDICTIVE ENGINE - Get equipment warnings
  try {
    if (typeof PredictiveEngine !== 'undefined') {
      var predictions = PredictiveEngine.getPredictions();
      
      // Equipment failure predictions
      if (predictions?.equipmentFailure?.highestRisk) {
        var equip = predictions.equipmentFailure.highestRisk;
        if (equip.risk > 0.1) {
          comprehensiveRecs.push({
            id: 'maint-' + Date.now(),
            source: 'Predictive Engine',
            sourceIcon: 'üîÆ',
            category: 'maintenance',
            priority: equip.risk > 0.2 ? 'CRITICAL' : 'HIGH',
            title: 'Preventive Maintenance: ' + equip.equipment,
            description: 'Equipment showing ' + Math.round(equip.risk * 100) + '% failure risk. Schedule inspection and maintenance.',
            impact: 'Prevent unplanned downtime',
            savings: 15000,
            timeframe: equip.risk > 0.2 ? '1 week' : '2 weeks',
            status: 'pending'
          });
        }
      }
      
      // Compliance risk prediction
      if (predictions?.complianceRisk?.probability > 0.15) {
        comprehensiveRecs.push({
          id: 'comprisk-' + Date.now(),
          source: 'Predictive Engine',
          sourceIcon: 'üîÆ',
          category: 'compliance',
          priority: 'HIGH',
          title: 'Elevated Compliance Risk Detected',
          description: 'Model predicts ' + Math.round(predictions.complianceRisk.probability * 100) + '% violation probability. Review process parameters.',
          impact: 'Prevent violation',
          savings: 0,
          timeframe: '1 week',
          status: 'pending'
        });
      }
    }
  } catch(e) { console.log('PredictiveEngine error:', e); }
  
  // 5. BENCHMARKING SYSTEM - Get improvement recommendations
  try {
    if (typeof BenchmarkingSystem !== 'undefined') {
      var benchmark = BenchmarkingSystem.getOverallBenchmark();
      if (benchmark?.improvements) {
        benchmark.improvements.slice(0, 3).forEach(function(imp, i) {
          comprehensiveRecs.push({
            id: 'bench-' + Date.now() + i,
            source: 'Benchmarking',
            sourceIcon: 'üìà',
            category: 'process',
            priority: imp.potential > 10 ? 'MEDIUM' : 'LOW',
            title: 'Benchmark Improvement: ' + imp.category,
            description: imp.recommendation || 'Improve ' + imp.category + ' to reach industry top quartile',
            impact: '+' + imp.potential + ' benchmark points',
            savings: imp.estimatedSavings || 5000,
            timeframe: '1-3 months',
            status: 'pending'
          });
        });
      }
    }
  } catch(e) { console.log('BenchmarkingSystem error:', e); }
  
  // 6. SCENARIO PLANNER - Capital project recommendations
  try {
    if (typeof ScenarioPlanner !== 'undefined') {
      var scenarios = ScenarioPlanner.scenarios || [];
      var bestROI = scenarios.sort(function(a, b) { return a.roi - b.roi; })[0];
      if (bestROI && bestROI.roi < 5) {
        comprehensiveRecs.push({
          id: 'capital-' + Date.now(),
          source: 'Scenario Planner',
          sourceIcon: 'üíº',
          category: 'cost',
          priority: 'MEDIUM',
          title: 'Capital Project: ' + bestROI.name,
          description: bestROI.description + ' - ROI: ' + bestROI.roi + ' years',
          impact: 'Long-term efficiency',
          savings: bestROI.npv || 50000,
          timeframe: '6-12 months',
          status: 'pending'
        });
      }
    }
  } catch(e) { console.log('ScenarioPlanner error:', e); }
  
  // 7. Add general best practices if few recommendations
  if (comprehensiveRecs.length < 5) {
    var bestPractices = [
      { title: 'Review DO Setpoints', desc: 'Verify DO setpoints match current loading conditions', cat: 'process', savings: 8000 },
      { title: 'Calibrate Instruments', desc: 'Monthly calibration of pH, DO, and flow meters', cat: 'maintenance', savings: 0 },
      { title: 'Update SOPs', desc: 'Review and update Standard Operating Procedures', cat: 'compliance', savings: 0 },
      { title: 'Energy Audit', desc: 'Conduct comprehensive energy audit of major equipment', cat: 'energy', savings: 12000 },
      { title: 'Training Update', desc: 'Schedule operator training on recent process changes', cat: 'compliance', savings: 0 }
    ];
    
    bestPractices.forEach(function(bp, i) {
      comprehensiveRecs.push({
        id: 'bp-' + Date.now() + i,
        source: 'Best Practices',
        sourceIcon: 'üìö',
        category: bp.cat,
        priority: 'LOW',
        title: bp.title,
        description: bp.desc,
        impact: 'Operational excellence',
        savings: bp.savings,
        timeframe: '1 month',
        status: 'pending'
      });
    });
  }
  
  // Sort by priority
  var priorityOrder = { 'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
  comprehensiveRecs.sort(function(a, b) {
    return priorityOrder[a.priority] - priorityOrder[b.priority];
  });
  
  // Update UI
  updateCompRecsStats();
  renderComprehensiveRecs();
  updateActionPlan();
  
  showToast('Found ' + comprehensiveRecs.length + ' recommendations from ' + countUniqueSources() + ' sources', 'success');
  console.log('=== COMPREHENSIVE RECOMMENDATIONS ===');
  console.log(comprehensiveRecs);
}

function countUniqueSources() {
  var sources = {};
  comprehensiveRecs.forEach(function(r) { sources[r.source] = true; });
  return Object.keys(sources).length;
}

function updateCompRecsStats() {
  var critical = comprehensiveRecs.filter(function(r) { return r.priority === 'CRITICAL'; }).length;
  var high = comprehensiveRecs.filter(function(r) { return r.priority === 'HIGH'; }).length;
  var medium = comprehensiveRecs.filter(function(r) { return r.priority === 'MEDIUM'; }).length;
  var totalSavings = comprehensiveRecs.reduce(function(sum, r) { return sum + (r.savings || 0); }, 0);
  var sources = countUniqueSources();
  
  document.getElementById('recsCriticalCount').textContent = critical;
  document.getElementById('recsHighCount').textContent = high;
  document.getElementById('recsMediumCount').textContent = medium;
  document.getElementById('recsTotalSavings').textContent = '$' + Math.round(totalSavings / 1000) + 'K';
  document.getElementById('recsSourceCount').textContent = sources;
  
  // Update tab counts
  document.getElementById('compRecTabAll').textContent = 'üìã All (' + comprehensiveRecs.length + ')';
}

function filterCompRecs(filter) {
  compRecsFilter = filter;
  
  // Update tab styles
  var tabs = ['All', 'Compliance', 'Process', 'Energy', 'Maintenance', 'Cost'];
  var tabColors = {
    all: { active: 'linear-gradient(135deg,#f59e0b,#d97706)', inactive: 'rgba(245,158,11,0.2)', text: '#fcd34d' },
    compliance: { active: 'linear-gradient(135deg,#ec4899,#db2777)', inactive: 'rgba(236,72,153,0.2)', text: '#f9a8d4' },
    process: { active: 'linear-gradient(135deg,#22c55e,#16a34a)', inactive: 'rgba(34,197,94,0.2)', text: '#86efac' },
    energy: { active: 'linear-gradient(135deg,#3b82f6,#2563eb)', inactive: 'rgba(59,130,246,0.2)', text: '#93c5fd' },
    maintenance: { active: 'linear-gradient(135deg,#f59e0b,#d97706)', inactive: 'rgba(245,158,11,0.2)', text: '#fcd34d' },
    cost: { active: 'linear-gradient(135deg,#8b5cf6,#7c3aed)', inactive: 'rgba(139,92,246,0.2)', text: '#c4b5fd' }
  };
  
  tabs.forEach(function(tab) {
    var el = document.getElementById('compRecTab' + tab);
    var key = tab.toLowerCase();
    if (el && tabColors[key]) {
      if (key === filter) {
        el.style.background = tabColors[key].active;
        el.style.color = 'white';
      } else {
        el.style.background = tabColors[key].inactive;
        el.style.color = tabColors[key].text;
      }
    }
  });
  
  renderComprehensiveRecs();
}

function renderComprehensiveRecs() {
  var container = document.getElementById('comprehensiveRecsList');
  if (!container) return;
  
  var filtered = comprehensiveRecs;
  if (compRecsFilter !== 'all') {
    filtered = comprehensiveRecs.filter(function(r) {
      return r.category === compRecsFilter;
    });
  }
  
  if (filtered.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:40px;color:#94a3b8"><div style="font-size:48px;margin-bottom:12px">‚úÖ</div><div>No recommendations in this category</div></div>';
    return;
  }
  
  var priorityStyles = {
    CRITICAL: { bg: 'rgba(239,68,68,0.1)', border: '#ef4444', badge: '#ef4444', text: '#fca5a5' },
    HIGH: { bg: 'rgba(245,158,11,0.1)', border: '#f59e0b', badge: '#f59e0b', text: '#fcd34d' },
    MEDIUM: { bg: 'rgba(59,130,246,0.1)', border: '#3b82f6', badge: '#3b82f6', text: '#93c5fd' },
    LOW: { bg: 'rgba(34,197,94,0.1)', border: '#22c55e', badge: '#22c55e', text: '#86efac' }
  };
  
  var html = filtered.map(function(rec) {
    var style = priorityStyles[rec.priority] || priorityStyles.MEDIUM;
    
    return `
      <div class="comp-rec-item" data-id="${rec.id}" style="background:${style.bg};border-left:4px solid ${style.border};border-radius:12px;padding:16px;transition:all 0.2s">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
          <div style="display:flex;align-items:center;gap:10px">
            <span style="font-size:24px">${rec.sourceIcon}</span>
            <div>
              <div style="font-size:14px;font-weight:600;color:#f8fafc">${rec.title}</div>
              <div style="font-size:11px;color:#94a3b8">${rec.source} ‚Ä¢ ${rec.timeframe}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            ${rec.savings > 0 ? `<span style="background:rgba(34,197,94,0.2);color:#4ade80;padding:4px 8px;border-radius:6px;font-size:10px;font-weight:600">üí∞ $${(rec.savings/1000).toFixed(0)}K/yr</span>` : ''}
            <span style="background:${style.badge};color:white;padding:4px 10px;border-radius:6px;font-size:10px;font-weight:700">${rec.priority}</span>
          </div>
        </div>
        <p style="font-size:13px;color:#cbd5e1;margin:0 0 12px 0;line-height:1.5">${rec.description}</p>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-size:11px;color:#94a3b8">
            <span style="margin-right:12px">üìå ${rec.impact}</span>
            <span>‚è±Ô∏è ${rec.timeframe}</span>
          </div>
          <div style="display:flex;gap:8px">
            <button onclick="markRecComplete('${rec.id}')" style="background:rgba(34,197,94,0.2);border:none;color:#86efac;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600">‚úì Complete</button>
            <button onclick="dismissRec('${rec.id}')" style="background:rgba(100,116,139,0.2);border:none;color:#94a3b8;padding:6px 12px;border-radius:6px;font-size:11px;cursor:pointer">Dismiss</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}

function markRecComplete(id) {
  comprehensiveRecs = comprehensiveRecs.filter(function(r) { return r.id !== id; });
  updateCompRecsStats();
  renderComprehensiveRecs();
  showToast('Recommendation marked complete!', 'success');
}

function dismissRec(id) {
  comprehensiveRecs = comprehensiveRecs.filter(function(r) { return r.id !== id; });
  updateCompRecsStats();
  renderComprehensiveRecs();
  showToast('Recommendation dismissed', 'info');
}

function updateActionPlan() {
  var critical = comprehensiveRecs.filter(function(r) { return r.priority === 'CRITICAL'; });
  var high = comprehensiveRecs.filter(function(r) { return r.priority === 'HIGH'; });
  var medium = comprehensiveRecs.filter(function(r) { return r.priority === 'MEDIUM'; });
  
  // Week 1: Critical items
  var week1El = document.getElementById('actionWeek1');
  if (week1El) {
    var week1Items = critical.slice(0, 3).map(function(r) { return '‚Ä¢ ' + r.title; }).join('<br>');
    week1El.innerHTML = week1Items || '‚Ä¢ No critical items<br>‚Ä¢ Review high priority';
  }
  
  // Week 2: High priority
  var week2El = document.getElementById('actionWeek2');
  if (week2El) {
    var week2Items = high.slice(0, 3).map(function(r) { return '‚Ä¢ ' + r.title; }).join('<br>');
    week2El.innerHTML = week2Items || '‚Ä¢ Continue monitoring<br>‚Ä¢ Address medium items';
  }
  
  // Week 3: Medium priority
  var week3El = document.getElementById('actionWeek3');
  if (week3El) {
    var week3Items = medium.slice(0, 3).map(function(r) { return '‚Ä¢ ' + r.title; }).join('<br>');
    week3El.innerHTML = week3Items || '‚Ä¢ Optimization tasks<br>‚Ä¢ Process improvements';
  }
}

function exportComprehensiveRecs() {
  var report = {
    generatedAt: new Date().toISOString(),
    totalRecommendations: comprehensiveRecs.length,
    criticalCount: comprehensiveRecs.filter(function(r) { return r.priority === 'CRITICAL'; }).length,
    totalSavings: comprehensiveRecs.reduce(function(sum, r) { return sum + (r.savings || 0); }, 0),
    recommendations: comprehensiveRecs
  };
  
  console.log('=== COMPREHENSIVE RECOMMENDATIONS EXPORT ===');
  console.log(report);
  
  var text = formatRecsAsText(report);
  navigator.clipboard.writeText(text).then(function() {
    showToast('Recommendations copied to clipboard!', 'success');
  }).catch(function() {
    showToast('Report logged to console (F12)', 'info');
  });
}

function formatRecsAsText(report) {
  var lines = [];
  lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  lines.push('COMPREHENSIVE RECOMMENDATIONS REPORT');
  lines.push('Generated: ' + new Date().toLocaleString());
  lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  lines.push('');
  lines.push('SUMMARY');
  lines.push('Total Recommendations: ' + report.totalRecommendations);
  lines.push('Critical Items: ' + report.criticalCount);
  lines.push('Total Potential Savings: $' + report.totalSavings.toLocaleString() + '/year');
  lines.push('');
  lines.push('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
  
  report.recommendations.forEach(function(rec, i) {
    lines.push('');
    lines.push((i + 1) + '. [' + rec.priority + '] ' + rec.title);
    lines.push('   Source: ' + rec.source);
    lines.push('   ' + rec.description);
    if (rec.savings > 0) lines.push('   Savings: $' + rec.savings.toLocaleString() + '/year');
    lines.push('   Timeframe: ' + rec.timeframe);
  });
  
  lines.push('');
  lines.push('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  
  return lines.join('\n');
}

function exportActionPlan() {
  showToast('Action plan exported to console', 'success');
  console.log('=== 30-DAY ACTION PLAN ===');
  console.log({
    week1: comprehensiveRecs.filter(function(r) { return r.priority === 'CRITICAL'; }),
    week2: comprehensiveRecs.filter(function(r) { return r.priority === 'HIGH'; }),
    week3: comprehensiveRecs.filter(function(r) { return r.priority === 'MEDIUM'; }),
    week4: comprehensiveRecs.filter(function(r) { return r.priority === 'LOW'; })
  });
}

function showRecsSummaryModal() {
  var totalSavings = comprehensiveRecs.reduce(function(sum, r) { return sum + (r.savings || 0); }, 0);
  var byCategory = {};
  comprehensiveRecs.forEach(function(r) {
    if (!byCategory[r.category]) byCategory[r.category] = { count: 0, savings: 0 };
    byCategory[r.category].count++;
    byCategory[r.category].savings += r.savings || 0;
  });
  
  var categoryHtml = Object.keys(byCategory).map(function(cat) {
    var data = byCategory[cat];
    return `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.1)">
      <span style="text-transform:capitalize">${cat}</span>
      <span>${data.count} items ‚Ä¢ $${Math.round(data.savings/1000)}K</span>
    </div>`;
  }).join('');
  
  var html = `
    <div style="text-align:center;margin-bottom:24px">
      <div style="font-size:48px;margin-bottom:12px">üéØ</div>
      <div style="font-size:36px;font-weight:800;color:#4ade80">$${Math.round(totalSavings/1000)}K</div>
      <div style="font-size:14px;color:#94a3b8">Total Annual Savings Potential</div>
    </div>
    <div style="margin-bottom:20px">
      <div style="font-size:14px;font-weight:600;color:#fcd34d;margin-bottom:12px">By Category</div>
      ${categoryHtml}
    </div>
    <div style="text-align:center">
      <button onclick="document.getElementById('geniusModal').remove()" style="background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:white;padding:12px 24px;border-radius:10px;font-size:14px;cursor:pointer;font-weight:600">Close Summary</button>
    </div>
  `;
  
  showGeniusModal('Recommendations Summary', html);
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    generateComprehensiveRecs();
  }, 2000);
});

// ========== END COMPREHENSIVE RECOMMENDATIONS ==========

// ========== ADVANCED CALCULATOR SUITE v9.9.19 ==========

function resetAdvancedCalcs() {
  // Reset all inputs to defaults and recalculate
  document.getElementById('blower_o2_demand').value = 2500;
  document.getElementById('blower_ote').value = 25;
  document.getElementById('blower_sf').value = 1.5;
  document.getElementById('blower_alt').value = 500;
  
  document.getElementById('alk_flow').value = 3.5;
  document.getElementById('alk_nh3').value = 25;
  document.getElementById('alk_inf').value = 200;
  document.getElementById('alk_target').value = 80;
  
  document.getElementById('svi_settled').value = 250;
  document.getElementById('svi_mlss').value = 3000;
  
  document.getElementById('cl_flow').value = 3.5;
  document.getElementById('cl_dose').value = 4;
  document.getElementById('cl_strength').value = 12.5;
  document.getElementById('cl_contact').value = 30;
  
  document.getElementById('pump_gpm').value = 500;
  document.getElementById('pump_tdh').value = 35;
  document.getElementById('pump_eff').value = 70;
  document.getElementById('pump_motor').value = 90;
  
  document.getElementById('split_total').value = 5.0;
  document.getElementById('split_units').value = 3;
  document.getElementById('split_u1').value = 40;
  document.getElementById('split_u2').value = 35;
  
  document.getElementById('poly_gpm').value = 100;
  document.getElementById('poly_solids').value = 2.5;
  document.getElementById('poly_dose').value = 15;
  document.getElementById('poly_strength').value = 0.5;
  
  document.getElementById('aer_flow').value = 3.5;
  document.getElementById('aer_hrt').value = 8;
  document.getElementById('aer_depth').value = 15;
  document.getElementById('aer_basins').value = 2;
  
  document.getElementById('ras_flow').value = 3.5;
  document.getElementById('ras_mlss').value = 3000;
  document.getElementById('ras_conc').value = 8000;
  document.getElementById('ras_was').value = 25000;
  
  document.getElementById('load_flow').value = 3.5;
  document.getElementById('load_bod').value = 200;
  document.getElementById('load_tss').value = 220;
  document.getElementById('load_vol').value = 1.0;
  
  document.getElementById('sludge_flow').value = 3.5;
  document.getElementById('sludge_tss').value = 200;
  document.getElementById('sludge_yield').value = 0.6;
  document.getElementById('sludge_cake').value = 18;
  
  document.getElementById('energy_hp').value = 100;
  document.getElementById('energy_hrs').value = 20;
  document.getElementById('energy_rate').value = 0.09;
  document.getElementById('energy_eff').value = 90;
  
  runAllAdvancedCalcs();
  showToast('All calculators reset to defaults', 'info');
}

function runAllAdvancedCalcs() {
  calcBlower();
  calcAlkalinity();
  calcSVI();
  calcChlorine();
  calcPump();
  calcFlowSplit();
  calcPolymer();
  calcAeration();
  calcReturnRate();
  calcLoading();
  calcSludgeProd();
  calcEnergyCost();
}

// 1. BLOWER CALCULATOR
function calcBlower() {
  var o2Demand = parseFloat(document.getElementById('blower_o2_demand').value) || 0;
  var ote = parseFloat(document.getElementById('blower_ote').value) || 25;
  var sf = parseFloat(document.getElementById('blower_sf').value) || 1.5;
  var alt = parseFloat(document.getElementById('blower_alt').value) || 0;
  
  // Air contains 23.2% oxygen by weight, 0.075 lbs/cf at sea level
  var o2PerCf = 0.075 * 0.232; // lbs O2 per cf of air
  var altFactor = 1 - (alt / 30000); // Altitude correction
  var actualOte = ote / 100;
  
  // SCFM = (O2 demand √ó SF) / (O2 per cf √ó OTE √ó 1440)
  var scfm = (o2Demand * sf) / (o2PerCf * actualOte * altFactor * 1440);
  
  // HP estimate: approximately 1 HP per 25-30 SCFM at typical pressures
  var hp = Math.ceil(scfm / 28);
  
  document.getElementById('blower_scfm').textContent = Math.round(scfm).toLocaleString();
  document.getElementById('blower_hp').textContent = hp;
}

// 2. ALKALINITY CALCULATOR
function calcAlkalinity() {
  var flow = parseFloat(document.getElementById('alk_flow').value) || 0;
  var nh3 = parseFloat(document.getElementById('alk_nh3').value) || 0;
  var infAlk = parseFloat(document.getElementById('alk_inf').value) || 0;
  var targetAlk = parseFloat(document.getElementById('alk_target').value) || 0;
  
  // 7.14 lbs alkalinity consumed per lb of NH3-N oxidized
  var nh3Load = flow * nh3 * 8.34; // lbs NH3-N/day
  var alkConsumed = nh3Load * 7.14; // lbs alkalinity/day as CaCO3
  
  // Check if supplemental alkalinity needed
  var infAlkLoad = flow * infAlk * 8.34;
  var targetAlkLoad = flow * targetAlk * 8.34;
  var alkNeeded = Math.max(0, alkConsumed - (infAlkLoad - targetAlkLoad));
  
  // Soda ash (Na2CO3) is 94% as CaCO3 equivalent
  var sodaAsh = alkNeeded / 0.94;
  
  document.getElementById('alk_consumed').textContent = Math.round(alkConsumed).toLocaleString();
  document.getElementById('alk_soda').textContent = Math.round(sodaAsh).toLocaleString();
}

// 3. SVI CALCULATOR
function calcSVI() {
  var settled = parseFloat(document.getElementById('svi_settled').value) || 0;
  var mlss = parseFloat(document.getElementById('svi_mlss').value) || 1;
  
  // SVI = (Settled volume mL/L √ó 1000) / MLSS mg/L
  var svi = (settled * 1000) / mlss;
  
  // SDI = 100 / SVI
  var sdi = 100 / svi;
  
  // Status determination
  var status, advice, color;
  if (svi < 80) {
    status = 'EXCELLENT';
    advice = '‚úì Excellent settling. Sludge is dense and settles rapidly.';
    color = '#4ade80';
  } else if (svi < 120) {
    status = 'GOOD';
    advice = '‚úì Normal settling characteristics. Maintain current operations.';
    color = '#4ade80';
  } else if (svi < 150) {
    status = 'FAIR';
    advice = '‚ö† Borderline settling. Monitor for filamentous organisms.';
    color = '#fbbf24';
  } else if (svi < 200) {
    status = 'POOR';
    advice = '‚ö† Poor settling indicates possible filamentous bulking. Check microscopy.';
    color = '#f59e0b';
  } else {
    status = 'BULKING';
    advice = 'üö® Bulking sludge! Implement control measures (chlorination, selectors, adjust F/M).';
    color = '#ef4444';
  }
  
  document.getElementById('svi_result').textContent = Math.round(svi);
  document.getElementById('svi_result').style.color = color;
  document.getElementById('sdi_result').textContent = sdi.toFixed(2);
  document.getElementById('svi_status').textContent = status;
  document.getElementById('svi_status').style.color = color;
  document.getElementById('svi_advice').innerHTML = advice;
  document.getElementById('svi_advice').style.background = color === '#4ade80' ? 'rgba(34,197,94,0.1)' : color === '#ef4444' ? 'rgba(239,68,68,0.1)' : 'rgba(245,158,11,0.1)';
}

// 4. CHLORINE CALCULATOR
function calcChlorine() {
  var flow = parseFloat(document.getElementById('cl_flow').value) || 0;
  var dose = parseFloat(document.getElementById('cl_dose').value) || 0;
  var strength = parseFloat(document.getElementById('cl_strength').value) || 12.5;
  
  // lbs/day = Flow (MGD) √ó Dose (mg/L) √ó 8.34
  var lbsDay = flow * dose * 8.34;
  
  // Solution feed rate: GPD = lbs/day / (8.34 √ó strength/100)
  var gpd = lbsDay / (8.34 * (strength / 100));
  
  document.getElementById('cl_lbs').textContent = Math.round(lbsDay);
  document.getElementById('cl_gpd').textContent = Math.round(gpd);
}

// 5. PUMP CALCULATOR
function calcPump() {
  var gpm = parseFloat(document.getElementById('pump_gpm').value) || 0;
  var tdh = parseFloat(document.getElementById('pump_tdh').value) || 0;
  var pumpEff = parseFloat(document.getElementById('pump_eff').value) || 70;
  var motorEff = parseFloat(document.getElementById('pump_motor').value) || 90;
  
  // Water Horsepower = (GPM √ó TDH) / 3960
  var whp = (gpm * tdh) / 3960;
  
  // Brake Horsepower = WHP / Pump Efficiency
  var bhp = whp / (pumpEff / 100);
  
  // Motor Horsepower = BHP / Motor Efficiency (round up to next standard size)
  var mhp = bhp / (motorEff / 100);
  var standardSizes = [0.5, 0.75, 1, 1.5, 2, 3, 5, 7.5, 10, 15, 20, 25, 30, 40, 50, 60, 75, 100, 125, 150, 200];
  var selectedHP = standardSizes.find(function(hp) { return hp >= mhp; }) || Math.ceil(mhp);
  
  document.getElementById('pump_whp').textContent = whp.toFixed(1);
  document.getElementById('pump_bhp').textContent = bhp.toFixed(1);
  document.getElementById('pump_mhp').textContent = selectedHP;
}

// 6. FLOW SPLIT CALCULATOR
function calcFlowSplit() {
  var total = parseFloat(document.getElementById('split_total').value) || 0;
  var units = parseInt(document.getElementById('split_units').value) || 3;
  var u1Pct = parseFloat(document.getElementById('split_u1').value) || 0;
  var u2Pct = parseFloat(document.getElementById('split_u2').value) || 0;
  
  // Calculate remaining percentage for other units
  var remaining = 100 - u1Pct - u2Pct;
  var u3Pct = units > 2 ? remaining / (units - 2) : 0;
  
  var u1Flow = total * (u1Pct / 100);
  var u2Flow = total * (u2Pct / 100);
  var u3Flow = total * (u3Pct / 100);
  
  document.getElementById('split_r1').textContent = u1Flow.toFixed(2);
  document.getElementById('split_r1').parentElement.querySelector('div:last-child').textContent = 'MGD (' + u1Pct + '%)';
  document.getElementById('split_r2').textContent = u2Flow.toFixed(2);
  document.getElementById('split_r2').parentElement.querySelector('div:last-child').textContent = 'MGD (' + u2Pct + '%)';
  document.getElementById('split_r3').textContent = u3Flow.toFixed(2);
  document.getElementById('split_r3').parentElement.querySelector('div:last-child').textContent = 'MGD (' + Math.round(remaining) + '%)';
}

// 7. POLYMER CALCULATOR
function calcPolymer() {
  var gpm = parseFloat(document.getElementById('poly_gpm').value) || 0;
  var solids = parseFloat(document.getElementById('poly_solids').value) || 0;
  var dose = parseFloat(document.getElementById('poly_dose').value) || 0;
  var strength = parseFloat(document.getElementById('poly_strength').value) || 0.5;
  
  // Dry tons per day = GPM √ó 1440 √ó 8.34 √ó (solids/100) / 2000
  var dryTons = (gpm * 1440 * 8.34 * (solids / 100)) / 2000;
  
  // Dry polymer lbs/day = Dry tons √ó dose (lbs/DT)
  var dryPolymer = dryTons * dose;
  
  // Solution GPD = Dry polymer / (8.34 √ó strength/100)
  var solutionGpd = dryPolymer / (8.34 * (strength / 100));
  
  document.getElementById('poly_dry').textContent = Math.round(dryPolymer);
  document.getElementById('poly_solution').textContent = Math.round(solutionGpd);
}

// 8. AERATION BASIN SIZING
function calcAeration() {
  var flow = parseFloat(document.getElementById('aer_flow').value) || 0;
  var hrt = parseFloat(document.getElementById('aer_hrt').value) || 0;
  var depth = parseFloat(document.getElementById('aer_depth').value) || 15;
  var basins = parseInt(document.getElementById('aer_basins').value) || 1;
  
  // Total volume (MG) = Flow √ó HRT / 24
  var totalVol = flow * hrt / 24;
  
  // Volume per basin
  var eachVol = totalVol / basins;
  
  // Surface area per basin (sq ft) = Volume (gallons) / (depth √ó 7.48)
  var surfaceArea = (eachVol * 1000000) / (depth * 7.48);
  
  document.getElementById('aer_vol').textContent = totalVol.toFixed(2);
  document.getElementById('aer_each').textContent = eachVol.toFixed(2);
  document.getElementById('aer_area').textContent = Math.round(surfaceArea).toLocaleString();
}

// 9. RETURN RATE CALCULATOR
function calcReturnRate() {
  var flow = parseFloat(document.getElementById('ras_flow').value) || 0;
  var mlss = parseFloat(document.getElementById('ras_mlss').value) || 0;
  var rasConc = parseFloat(document.getElementById('ras_conc').value) || 1;
  var wasGpd = parseFloat(document.getElementById('ras_was').value) || 0;
  
  // RAS ratio = MLSS / (RAS concentration - MLSS)
  var rasRatio = mlss / (rasConc - mlss);
  var rasRatioPct = rasRatio * 100;
  
  // RAS flow = Influent flow √ó RAS ratio
  var rasMgd = flow * rasRatio;
  var rasGpm = rasMgd * 1000000 / 1440;
  
  document.getElementById('ras_ratio').textContent = Math.round(rasRatioPct) + '%';
  document.getElementById('ras_mgd').textContent = rasMgd.toFixed(2);
  document.getElementById('ras_gpm').textContent = Math.round(rasGpm).toLocaleString();
}

// 10. LOADING RATE CALCULATOR
function calcLoading() {
  var flow = parseFloat(document.getElementById('load_flow').value) || 0;
  var bod = parseFloat(document.getElementById('load_bod').value) || 0;
  var tss = parseFloat(document.getElementById('load_tss').value) || 0;
  var vol = parseFloat(document.getElementById('load_vol').value) || 1;
  
  // lbs/day = Flow √ó Concentration √ó 8.34
  var bodLbs = flow * bod * 8.34;
  var tssLbs = flow * tss * 8.34;
  
  // OLR = lbs BOD/day / (volume in 1000 cf)
  var volCf = vol * 1000000 / 7.48;
  var olr = bodLbs / (volCf / 1000);
  
  document.getElementById('load_bod_lbs').textContent = Math.round(bodLbs).toLocaleString();
  document.getElementById('load_tss_lbs').textContent = Math.round(tssLbs).toLocaleString();
  document.getElementById('load_olr').textContent = olr.toFixed(1);
}

// 11. SLUDGE PRODUCTION CALCULATOR
function calcSludgeProd() {
  var flow = parseFloat(document.getElementById('sludge_flow').value) || 0;
  var tss = parseFloat(document.getElementById('sludge_tss').value) || 0;
  var yield = parseFloat(document.getElementById('sludge_yield').value) || 0.6;
  var cake = parseFloat(document.getElementById('sludge_cake').value) || 18;
  
  // Dry solids = Flow √ó TSS removed √ó 8.34 √ó yield factor
  var drySolids = flow * tss * 8.34 * yield;
  
  // Wet cake = Dry solids / (cake % / 100)
  var wetCake = drySolids / (cake / 100);
  
  // Weekly loads (assuming 20 ton trucks)
  var weeklyLoads = (wetCake * 7) / (20 * 2000);
  
  document.getElementById('sludge_dry').textContent = Math.round(drySolids).toLocaleString();
  document.getElementById('sludge_wet').textContent = Math.round(wetCake).toLocaleString();
  document.getElementById('sludge_loads').textContent = weeklyLoads.toFixed(1);
}

// 12. ENERGY COST CALCULATOR
function calcEnergyCost() {
  var hp = parseFloat(document.getElementById('energy_hp').value) || 0;
  var hrs = parseFloat(document.getElementById('energy_hrs').value) || 0;
  var rate = parseFloat(document.getElementById('energy_rate').value) || 0.09;
  var eff = parseFloat(document.getElementById('energy_eff').value) || 90;
  
  // kWh = HP √ó 0.746 √ó hours / efficiency
  var dailyKwh = hp * 0.746 * hrs / (eff / 100);
  
  // Daily cost
  var dailyCost = dailyKwh * rate;
  
  // Annual cost
  var annualCost = dailyCost * 365;
  
  document.getElementById('energy_kwh').textContent = Math.round(dailyKwh).toLocaleString();
  document.getElementById('energy_daily').textContent = '$' + Math.round(dailyCost);
  document.getElementById('energy_annual').textContent = '$' + Math.round(annualCost / 1000) + 'K';
}

// Initialize calculators on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    runAllAdvancedCalcs();
  }, 500);
});

// ========== END ADVANCED CALCULATOR SUITE ==========

// ========== ADVANCED CALCULATOR SUITE II v9.9.20 ==========

function resetAdvancedCalcs2() {
  // Reset all Suite II inputs to defaults
  document.getElementById('bnr_tn_in').value = 40;
  document.getElementById('bnr_tn_out').value = 8;
  document.getElementById('bnr_tp_in').value = 7;
  document.getElementById('bnr_tp_out').value = 0.8;
  
  document.getElementById('dig_vs').value = 5000;
  document.getElementById('dig_yield').value = 15;
  document.getElementById('dig_methane').value = 65;
  document.getElementById('dig_eng_eff').value = 35;
  
  document.getElementById('bc_bod').value = 200;
  document.getElementById('bc_cod').value = 450;
  document.getElementById('bc_bod_eff').value = 10;
  document.getElementById('bc_cod_eff').value = 40;
  
  document.getElementById('hyd_flow').value = 2000;
  document.getElementById('hyd_dia').value = 12;
  document.getElementById('hyd_length').value = 1000;
  document.getElementById('hyd_c').value = 120;
  
  document.getElementById('temp_design').value = 20;
  document.getElementById('temp_oper').value = 15;
  document.getElementById('temp_bod_rate').value = 0.5;
  document.getElementById('temp_nit_rate').value = 2.0;
  
  document.getElementById('n_flow').value = 3.5;
  document.getElementById('n_tkn_in').value = 35;
  document.getElementById('n_nh3_out').value = 1.5;
  document.getElementById('n_no3_out').value = 8;
  
  document.getElementById('p_flow').value = 3.5;
  document.getElementById('p_inf').value = 6;
  document.getElementById('p_eff').value = 0.5;
  document.getElementById('p_ratio').value = 2.5;
  
  document.getElementById('dt_vol').value = 500000;
  document.getElementById('dt_flow').value = 3.5;
  document.getElementById('dt_depth').value = 12;
  document.getElementById('dt_num').value = 2;
  
  document.getElementById('vel_flow').value = 3.5;
  document.getElementById('vel_width').value = 4;
  document.getElementById('vel_depth').value = 3;
  document.getElementById('vel_length').value = 50;
  
  document.getElementById('meth_gas').value = 75000;
  document.getElementById('meth_pct').value = 65;
  document.getElementById('meth_eff').value = 35;
  document.getElementById('meth_rate').value = 0.09;
  
  runAllAdvancedCalcs2();
  showToast('Suite II calculators reset to defaults', 'info');
}

function runAllAdvancedCalcs2() {
  calcNutrientRemoval();
  calcDigesterGas();
  calcBodCod();
  calcHydraulic();
  calcTempCorr();
  calcNitrogen();
  calcPhosphorus();
  calcDetention();
  calcVelocity();
  calcMethane();
}

// 1. NUTRIENT REMOVAL CALCULATOR
function calcNutrientRemoval() {
  var tnIn = parseFloat(document.getElementById('bnr_tn_in').value) || 1;
  var tnOut = parseFloat(document.getElementById('bnr_tn_out').value) || 0;
  var tpIn = parseFloat(document.getElementById('bnr_tp_in').value) || 1;
  var tpOut = parseFloat(document.getElementById('bnr_tp_out').value) || 0;
  
  var tnPct = ((tnIn - tnOut) / tnIn) * 100;
  var tpPct = ((tpIn - tpOut) / tpIn) * 100;
  
  // Status determination
  var tnStatus, tpStatus, advice, tnColor, tpColor;
  
  if (tnPct >= 85) { tnStatus = 'Excellent'; tnColor = '#4ade80'; }
  else if (tnPct >= 70) { tnStatus = 'Good'; tnColor = '#4ade80'; }
  else if (tnPct >= 50) { tnStatus = 'Fair'; tnColor = '#fbbf24'; }
  else { tnStatus = 'Poor'; tnColor = '#ef4444'; }
  
  if (tpPct >= 90) { tpStatus = 'Excellent'; tpColor = '#4ade80'; }
  else if (tpPct >= 75) { tpStatus = 'Good'; tpColor = '#4ade80'; }
  else if (tpPct >= 60) { tpStatus = 'Fair'; tpColor = '#fbbf24'; }
  else { tpStatus = 'Poor'; tpColor = '#ef4444'; }
  
  // Advice
  if (tnPct >= 80 && tpPct >= 85) {
    advice = '‚úì BNR system operating at optimal efficiency';
  } else if (tnPct < 60) {
    advice = '‚ö† Low N removal - check anoxic zone DO, recycle ratio, carbon source';
  } else if (tpPct < 70) {
    advice = '‚ö† Low P removal - verify anaerobic conditions, consider chemical addition';
  } else {
    advice = '‚Üí Consider process adjustments to optimize nutrient removal';
  }
  
  document.getElementById('bnr_tn_pct').textContent = Math.round(tnPct) + '%';
  document.getElementById('bnr_tn_pct').style.color = tnColor;
  document.getElementById('bnr_tn_status').textContent = tnStatus;
  document.getElementById('bnr_tn_status').style.color = tnColor;
  
  document.getElementById('bnr_tp_pct').textContent = Math.round(tpPct) + '%';
  document.getElementById('bnr_tp_pct').style.color = tpColor;
  document.getElementById('bnr_tp_status').textContent = tpStatus;
  document.getElementById('bnr_tp_status').style.color = tpColor;
  
  document.getElementById('bnr_advice').innerHTML = advice;
  document.getElementById('bnr_advice').style.background = (tnPct >= 70 && tpPct >= 75) ? 
    'rgba(16,185,129,0.1)' : 'rgba(245,158,11,0.1)';
}

// 2. DIGESTER GAS PRODUCTION CALCULATOR
function calcDigesterGas() {
  var vs = parseFloat(document.getElementById('dig_vs').value) || 0;
  var yield_ = parseFloat(document.getElementById('dig_yield').value) || 15;
  var methane = parseFloat(document.getElementById('dig_methane').value) || 65;
  var engEff = parseFloat(document.getElementById('dig_eng_eff').value) || 35;
  
  // Total gas production (cf/day)
  var totalGas = vs * yield_;
  
  // Methane volume and BTU content (1000 BTU per cf of methane)
  var methaneVol = totalGas * (methane / 100);
  var btu = methaneVol * 1000;
  
  // Power generation potential
  // 1 kWh = 3412 BTU, with generator efficiency
  var kwh = (btu * (engEff / 100)) / 3412;
  var kw = kwh / 24;
  
  document.getElementById('dig_total_gas').textContent = Math.round(totalGas).toLocaleString();
  document.getElementById('dig_btu').textContent = (btu / 1000000).toFixed(1) + 'M';
  document.getElementById('dig_kw').textContent = Math.round(kw);
}

// 3. BOD/COD RATIO CALCULATOR
function calcBodCod() {
  var bodIn = parseFloat(document.getElementById('bc_bod').value) || 1;
  var codIn = parseFloat(document.getElementById('bc_cod').value) || 1;
  var bodOut = parseFloat(document.getElementById('bc_bod_eff').value) || 0;
  var codOut = parseFloat(document.getElementById('bc_cod_eff').value) || 0;
  
  var ratio = bodIn / codIn;
  var bodRem = ((bodIn - bodOut) / bodIn) * 100;
  var codRem = ((codIn - codOut) / codIn) * 100;
  
  // Biodegradability assessment
  var biod, advice;
  if (ratio >= 0.5) {
    biod = 'Highly Biodegradable';
    advice = '‚úì Excellent biodegradability - ideal for biological treatment';
  } else if (ratio >= 0.3) {
    biod = 'Biodegradable';
    advice = '‚úì Typical municipal wastewater - readily biodegradable';
  } else if (ratio >= 0.2) {
    biod = 'Moderate';
    advice = '‚ö† Moderate biodegradability - may need extended aeration';
  } else {
    biod = 'Low/Industrial';
    advice = 'üö® Low biodegradability - consider pretreatment or chemical oxidation';
  }
  
  document.getElementById('bc_ratio').textContent = ratio.toFixed(2);
  document.getElementById('bc_biod').textContent = biod;
  document.getElementById('bc_biod').style.color = ratio >= 0.3 ? '#4ade80' : ratio >= 0.2 ? '#fbbf24' : '#ef4444';
  document.getElementById('bc_bod_rem').textContent = Math.round(bodRem) + '%';
  document.getElementById('bc_cod_rem').textContent = Math.round(codRem) + '%';
  document.getElementById('bc_advice').innerHTML = advice;
  document.getElementById('bc_advice').style.background = ratio >= 0.3 ? 
    'rgba(99,102,241,0.1)' : 'rgba(245,158,11,0.1)';
}

// 4. HYDRAULIC CALCULATOR (Hazen-Williams)
function calcHydraulic() {
  var flow = parseFloat(document.getElementById('hyd_flow').value) || 0;
  var dia = parseFloat(document.getElementById('hyd_dia').value) || 1;
  var length = parseFloat(document.getElementById('hyd_length').value) || 0;
  var c = parseFloat(document.getElementById('hyd_c').value) || 120;
  
  // Convert diameter to feet
  var diaFt = dia / 12;
  
  // Cross-sectional area (sq ft)
  var area = Math.PI * Math.pow(diaFt / 2, 2);
  
  // Flow in cfs (GPM / 448.8)
  var cfs = flow / 448.83;
  
  // Velocity (ft/s) = Flow / Area
  var vel = area > 0 ? cfs / area : 0;
  
  // Hazen-Williams: hf = 10.67 √ó L √ó Q^1.852 / (C^1.852 √ó D^4.87)
  var hl = 10.67 * length * Math.pow(cfs, 1.852) / (Math.pow(c, 1.852) * Math.pow(diaFt, 4.87));
  var hl100 = length > 0 ? (hl / length) * 100 : 0;
  
  // Advice based on velocity
  var advice;
  if (vel < 2) {
    advice = '‚ö† Low velocity - risk of solids deposition (min 2 ft/s)';
  } else if (vel > 10) {
    advice = '‚ö† High velocity - consider pipe erosion and noise';
  } else {
    advice = '‚úì Velocity within acceptable range (2-10 ft/s)';
  }
  
  document.getElementById('hyd_vel').textContent = vel.toFixed(2);
  document.getElementById('hyd_hl').textContent = hl.toFixed(2);
  document.getElementById('hyd_hl100').textContent = hl100.toFixed(3);
  document.getElementById('hyd_advice').innerHTML = advice;
  document.getElementById('hyd_advice').style.background = (vel >= 2 && vel <= 10) ? 
    'rgba(14,165,233,0.1)' : 'rgba(245,158,11,0.1)';
}

// 5. TEMPERATURE CORRECTION CALCULATOR
function calcTempCorr() {
  var tDesign = parseFloat(document.getElementById('temp_design').value) || 20;
  var tOper = parseFloat(document.getElementById('temp_oper').value) || 15;
  var bodRate = parseFloat(document.getElementById('temp_bod_rate').value) || 0.5;
  var nitRate = parseFloat(document.getElementById('temp_nit_rate').value) || 2.0;
  
  // Temperature coefficients
  var thetaBOD = 1.047;  // BOD removal
  var thetaNit = 1.098;  // Nitrification
  
  // Calculate correction factors: Œ∏^(T-20)
  var bodTheta = Math.pow(thetaBOD, tOper - tDesign);
  var nitTheta = Math.pow(thetaNit, tOper - tDesign);
  
  // Adjusted rates
  var bodAdj = bodRate * bodTheta;
  var nitAdj = nitRate * nitTheta;
  
  document.getElementById('temp_bod_adj').textContent = bodAdj.toFixed(2);
  document.getElementById('temp_nit_adj').textContent = nitAdj.toFixed(2);
  document.getElementById('temp_bod_theta').textContent = bodTheta.toFixed(2);
  document.getElementById('temp_nit_theta').textContent = nitTheta.toFixed(2);
}

// 6. NITROGEN BALANCE CALCULATOR
function calcNitrogen() {
  var flow = parseFloat(document.getElementById('n_flow').value) || 0;
  var tknIn = parseFloat(document.getElementById('n_tkn_in').value) || 0;
  var nh3Out = parseFloat(document.getElementById('n_nh3_out').value) || 0;
  var no3Out = parseFloat(document.getElementById('n_no3_out').value) || 0;
  
  // Loads in lbs/day
  var tknLoad = flow * tknIn * 8.34;
  
  // Effluent TN = NH3-N + NO3-N
  var effTN = nh3Out + no3Out;
  var tnLoad = flow * effTN * 8.34;
  
  // Nitrogen removed by denitrification (approximate)
  // Assume ~5% incorporated into biomass
  var bioN = tknLoad * 0.05;
  var denitrified = tknLoad - tnLoad - bioN;
  
  document.getElementById('n_tkn_load').textContent = Math.round(tknLoad).toLocaleString();
  document.getElementById('n_denit').textContent = Math.round(Math.max(0, denitrified)).toLocaleString();
  document.getElementById('n_eff_tn').textContent = effTN.toFixed(1);
}

// 7. PHOSPHORUS REMOVAL CALCULATOR
function calcPhosphorus() {
  var flow = parseFloat(document.getElementById('p_flow').value) || 0;
  var pInf = parseFloat(document.getElementById('p_inf').value) || 0;
  var pEff = parseFloat(document.getElementById('p_eff').value) || 0;
  var mRatio = parseFloat(document.getElementById('p_ratio').value) || 2.5;
  
  // P to remove (lbs/day)
  var pRemove = flow * (pInf - pEff) * 8.34;
  
  // Metal required (molar basis)
  // Al = 27 g/mol, P = 31 g/mol, Fe = 56 g/mol
  var alRequired = pRemove * mRatio * (27/31);
  var feRequired = pRemove * mRatio * (56/31);
  
  // Alum liquid (48.5% as Al2(SO4)3¬∑14H2O, ~4.4% Al, ~11.2 lbs/gal)
  var alumGPD = alRequired / (11.2 * 0.044);
  
  // Ferric chloride liquid (40% FeCl3, ~13.4% Fe, ~11.8 lbs/gal)  
  var ferricGPD = feRequired / (11.8 * 0.134);
  
  document.getElementById('p_alum').textContent = Math.round(alRequired);
  document.getElementById('p_ferric').textContent = Math.round(feRequired);
  document.getElementById('p_alum_gal').textContent = Math.round(alumGPD) + ' GPD';
  document.getElementById('p_ferric_gal').textContent = Math.round(ferricGPD) + ' GPD';
}

// 8. DETENTION TIME CALCULATOR
function calcDetention() {
  var vol = parseFloat(document.getElementById('dt_vol').value) || 0;
  var flow = parseFloat(document.getElementById('dt_flow').value) || 1;
  var depth = parseFloat(document.getElementById('dt_depth').value) || 10;
  var num = parseInt(document.getElementById('dt_num').value) || 1;
  
  // Total volume in MG
  var totalVol = (vol * num) / 1000000;
  
  // HRT = Volume / Flow √ó 24 hours
  var hrt = (totalVol / flow) * 24;
  
  // Surface area per tank (gallons / depth / 7.48)
  var surfaceArea = vol / (depth * 7.48);
  
  document.getElementById('dt_hrt').textContent = hrt.toFixed(2);
  document.getElementById('dt_total').textContent = totalVol.toFixed(2);
  document.getElementById('dt_area').textContent = Math.round(surfaceArea).toLocaleString();
}

// 9. CHANNEL VELOCITY CALCULATOR
function calcVelocity() {
  var flow = parseFloat(document.getElementById('vel_flow').value) || 0;
  var width = parseFloat(document.getElementById('vel_width').value) || 1;
  var depth = parseFloat(document.getElementById('vel_depth').value) || 1;
  var length = parseFloat(document.getElementById('vel_length').value) || 1;
  
  // Convert MGD to cfs
  var cfs = flow * 1.547;
  
  // Cross-sectional area
  var area = width * depth;
  
  // Velocity (ft/s)
  var vel = area > 0 ? cfs / area : 0;
  
  // Contact time (seconds)
  var time = vel > 0 ? length / vel : 0;
  
  // Advice
  var advice;
  if (vel < 1.0) {
    advice = '‚ö† Velocity below minimum - risk of solids settling (min 1.0 ft/s)';
  } else if (vel > 3.0) {
    advice = '‚úì Good velocity for grit removal applications';
  } else {
    advice = '‚úì Velocity OK for channel flow (min 1.0 ft/s recommended)';
  }
  
  document.getElementById('vel_fps').textContent = vel.toFixed(2);
  document.getElementById('vel_area').textContent = area.toFixed(0);
  document.getElementById('vel_time').textContent = Math.round(time);
  document.getElementById('vel_advice').innerHTML = advice;
  document.getElementById('vel_advice').style.background = vel >= 1.0 ? 
    'rgba(236,72,153,0.1)' : 'rgba(245,158,11,0.1)';
}

// 10. METHANE ENERGY CALCULATOR
function calcMethane() {
  var gas = parseFloat(document.getElementById('meth_gas').value) || 0;
  var pct = parseFloat(document.getElementById('meth_pct').value) || 65;
  var eff = parseFloat(document.getElementById('meth_eff').value) || 35;
  var rate = parseFloat(document.getElementById('meth_rate').value) || 0.09;
  
  // Methane volume and BTU (1000 BTU per cf of CH4)
  var ch4Vol = gas * (pct / 100);
  var btu = ch4Vol * 1000;
  
  // Electrical generation potential (1 kWh = 3412 BTU)
  var kwh = (btu * (eff / 100)) / 3412;
  
  // Economic value
  var dailyValue = kwh * rate;
  var annualValue = dailyValue * 365;
  
  document.getElementById('meth_btu').textContent = (btu / 1000000).toFixed(1) + 'M';
  document.getElementById('meth_kwh').textContent = Math.round(kwh).toLocaleString();
  document.getElementById('meth_value').textContent = '$' + Math.round(dailyValue);
  document.getElementById('meth_annual').textContent = '$' + Math.round(annualValue).toLocaleString();
}

// Initialize Suite II calculators on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    runAllAdvancedCalcs2();
  }, 600);
});

// ========== END ADVANCED CALCULATOR SUITE II ==========

// ========== CALC CHAINS & EXCEL EXPORT (v9.6.0) ==========

const CalcChain = {
  chains: {
    'full-analysis': {
      name: 'Full Plant Analysis',
      steps: ['calcLoading', 'calcFM', 'calcSRTmain', 'calcSVI', 'calcOxygen', 'calcEnergy'],
      description: 'Run loading ‚Üí F/M ‚Üí SRT ‚Üí SVI ‚Üí Oxygen ‚Üí Energy'
    },
    'solids-chain': {
      name: 'Solids Management',
      steps: ['calcSRTmain', 'calcWAS', 'calcSludgeProduction'],
      description: 'Run SRT ‚Üí WAS ‚Üí Sludge calculations'
    },
    'aeration-chain': {
      name: 'Aeration Analysis',
      steps: ['calcOxygen', 'calcEnergy'],
      description: 'Run Oxygen ‚Üí Energy calculations'
    }
  },
  
  run(chainId) {
    const chain = this.chains[chainId];
    if (!chain) return;
    
    let completed = 0;
    chain.steps.forEach((fn, idx) => {
      setTimeout(() => {
        if (typeof window[fn] === 'function') {
          window[fn]();
          completed++;
          showToast('‚úÖ Step ' + completed + '/' + chain.steps.length + ': ' + fn.replace('calc',''), 'success');
        }
      }, idx * 500);
    });
    
    setTimeout(() => {
      showToast('üéâ ' + chain.name + ' complete!', 'success');
    }, chain.steps.length * 500 + 200);
  }
};

function showCalcChains() {
  let html = '<div style="display:grid;gap:15px">';
  
  for (const [id, chain] of Object.entries(CalcChain.chains)) {
    html += '<div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:12px;border-left:4px solid #4ade80">' +
      '<h4 style="margin:0 0 8px 0;color:#4ade80">' + chain.name + '</h4>' +
      '<p style="margin:0 0 10px 0;font-size:13px;opacity:0.8">' + chain.description + '</p>' +
      '<button onclick="CalcChain.run(\'' + id + '\');this.closest(\'.modal-overlay\').remove()" class="btn" style="background:#4ade80;color:#1a1a2e">‚ñ∂Ô∏è Run Chain</button>' +
      '</div>';
  }
  
  html += '</div>';
  showModal('üîó Calculator Chains', html);
}

function exportToExcel() {
  let csv = '\uFEFF'; // BOM for Excel UTF-8
  csv += 'WWTP Command Center Report\n';
  csv += 'Generated: ' + new Date().toLocaleString() + '\n\n';
  
  // KPIs
  csv += '=== Plant KPIs ===\n';
  csv += 'Parameter,Value,Unit\n';
  
  const kpiData = [
    ['Flow Rate', 'kpi-flow', 'MGD'],
    ['DO Level', 'kpi-do', 'mg/L'],
    ['MLSS', 'kpi-mlss', 'mg/L'],
    ['F/M Ratio', 'kpi-fm', 'lb/lb/d'],
    ['SRT', 'kpi-srt', 'days'],
    ['SVI', 'kpi-svi', 'mL/g']
  ];
  
  kpiData.forEach(([name, id, unit]) => {
    const el = document.getElementById(id);
    const val = el ? el.textContent : 'N/A';
    csv += name + ',' + val + ',' + unit + '\n';
  });
  
  // Download
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'WWTP-Report-' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  showToast('üìä Excel report exported!', 'success');
}

// ========== END CALC CHAINS & EXCEL EXPORT ==========

</script>

<!-- AI COPILOT PANEL v9.9.16 - TIER 3 Enhanced -->
<div id="ai-panel" style="display:none;position:fixed;bottom:20px;right:20px;width:400px;max-width:92vw;max-height:580px;background:linear-gradient(135deg,#1e3a5f,#0d1b2a);border-radius:20px;box-shadow:0 15px 50px rgba(0,0,0,0.6);z-index:10000;overflow:hidden;border:1px solid #2d4a6f">
  <div style="background:linear-gradient(135deg,#059669,#10b981);padding:14px 18px;display:flex;justify-content:space-between;align-items:center">
    <div style="display:flex;align-items:center;gap:12px;color:white">
      <span style="font-size:28px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))">üß†</span>
      <div>
        <div style="font-weight:700;font-size:16px">WWTP AI Assistant</div>
        <div style="font-size:11px;opacity:0.9;display:flex;align-items:center;gap:6px">
          <span style="width:6px;height:6px;background:#4ade80;border-radius:50%;animation:pulse-dot 2s infinite"></span>
          TIER 3 Intelligence Active
        </div>
      </div>
    </div>
    <button onclick="document.getElementById('ai-panel').style.display='none'" style="background:rgba(255,255,255,0.2);border:none;color:white;font-size:18px;width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center">‚úï</button>
  </div>
  
  <!-- Quick Actions Bar -->
  <div style="padding:10px 14px;background:rgba(0,0,0,0.2);display:flex;gap:8px;overflow-x:auto;-webkit-overflow-scrolling:touch">
    <button onclick="OptimizationCoach.showDashboard()" style="flex-shrink:0;background:linear-gradient(135deg,#059669,#10b981);color:white;border:none;padding:8px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap">üéØ Optimize</button>
    <button onclick="PredictiveOps.showDashboard()" style="flex-shrink:0;background:linear-gradient(135deg,#7c3aed,#a855f7);color:white;border:none;padding:8px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap">üîÆ Predict</button>
    <button onclick="TrainingMode.showDashboard()" style="flex-shrink:0;background:linear-gradient(135deg,#f97316,#fb923c);color:white;border:none;padding:8px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap">üéì Train</button>
    <button onclick="runSystemDiagnostic()" style="flex-shrink:0;background:#374151;color:white;border:none;padding:8px 14px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap">üîç Diagnose</button>
  </div>
  
  <div id="ai-messages" style="height:340px;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:12px">
    <div style="background:rgba(5,150,105,0.3);padding:14px 16px;border-radius:16px;color:white;font-size:14px;line-height:1.5">
      <strong>üß† TIER 3 AI Online</strong><br><br>
      I'm your advanced WWTP assistant with:<br>
      ‚Ä¢ <strong>üéØ Optimization Coach</strong> - Improvement recommendations<br>
      ‚Ä¢ <strong>üîÆ Predictive Ops</strong> - 7-day forecasting<br>
      ‚Ä¢ <strong>üéì Training Mode</strong> - Interactive learning<br><br>
      Try: "optimize my plant" or "predict problems"
    </div>
  </div>
  <div style="padding:12px;border-top:1px solid #2d4a6f;display:flex;gap:10px">
    <input type="text" id="ai-user-input" placeholder="Ask anything... try 'optimize' or 'predict'" style="flex:1;padding:12px 16px;border-radius:24px;border:2px solid #2d4a6f;background:#0d1b2a;color:white;font-size:14px;transition:border-color 0.2s" onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#2d4a6f'" onkeypress="if(event.key==='Enter')sendAIChat()">
    <button onclick="sendAIChat()" style="background:linear-gradient(135deg,#059669,#10b981);color:white;border:none;padding:12px 20px;border-radius:24px;cursor:pointer;font-weight:700;font-size:14px;box-shadow:0 4px 12px rgba(16,185,129,0.3)">Send</button>
  </div>
</div>

<style>
@keyframes pulse-dot {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.8); }
}
</style>

<script>
// Simple AI Chat Function
function toggleAIPanel() {
  var panel = document.getElementById('ai-panel');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    document.getElementById('ai-user-input').focus();
  } else {
    panel.style.display = 'none';
  }
}

function sendAIChat() {
  var input = document.getElementById('ai-user-input');
  var messages = document.getElementById('ai-messages');
  var msg = input.value.trim();
  if (!msg) return;
  
  // Add user message
  messages.innerHTML += '<div style="background:#2d4a6f;padding:12px 16px;border-radius:16px;color:white;font-size:14px;align-self:flex-end;max-width:85%">' + msg + '</div>';
  input.value = '';
  
  // Get AI response
  setTimeout(function() {
    var response = generateAIResponse(msg);
    messages.innerHTML += '<div style="background:rgba(5,150,105,0.25);padding:14px 16px;border-radius:16px;color:white;font-size:14px;max-width:92%;line-height:1.5">' + response + '</div>';
    messages.scrollTop = messages.scrollHeight;
  }, 300);
  
  messages.scrollTop = messages.scrollHeight;
}

// Override header button to use new panel
document.addEventListener('DOMContentLoaded', function() {
  var aiBtn = document.getElementById('aiHeaderBtn');
  if (aiBtn) {
    aiBtn.onclick = toggleAIPanel;
  }
});

</script>

</body>
</html>
