<!DOCTYPE html>

<html lang="en" class="dark"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport">
<title>WWTP Command Center v9.6.0</title>

<meta name="theme-color" content="#023e8a">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WWTP Command">
<meta name="description" content="Professional wastewater treatment plant analysis platform - Works Offline">
<meta name="application-name" content="WWTP Command Center">

<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIldXVFAgQ29tbWFuZCBDZW50ZXIiLAogICJzaG9ydF9uYW1lIjogIldXVFAiLAogICJkZXNjcmlwdGlvbiI6ICJQcm9mZXNzaW9uYWwgd2FzdGV3YXRlciB0cmVhdG1lbnQgcGxhbnQgYW5hbHlzaXMgcGxhdGZvcm0iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzAyM2U4YSIsCiAgInRoZW1lX2NvbG9yIjogIiMwMjNlOGEiLAogICJvcmllbnRhdGlvbiI6ICJhbnkiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDEwMCAxMDAnJTNFJTNDcmVjdCBmaWxsPSclMjMwMjNlOGEnIHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyByeD0nMjAnLyUzRSUzQ3RleHQgeD0nNTAnIHk9JzY1JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSclM0Xwn4ytJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0KfQ==">

<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23023e8a' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üè≠</text></svg>">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
/* v9.5.0 PANEL FIX - TABLET SCROLL FIX */
.panel { display: none !important; position: absolute !important; left: -9999px !important; visibility: hidden !important; }
.panel.active { display: block !important; position: relative !important; left: auto !important; visibility: visible !important; }

/* PWA Offline/Online Indicator */
.pwa-status { position: fixed; bottom: 20px; left: 20px; padding: 10px 16px; border-radius: 25px; font-size: 13px; font-weight: 600; z-index: 99999; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: all 0.3s; }
.pwa-status.online { background: linear-gradient(135deg, #10b981, #059669); color: white; }
.pwa-status.offline { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; animation: pulse-offline 2s infinite; }
.pwa-status .status-dot { width: 10px; height: 10px; border-radius: 50%; background: currentColor; }
.pwa-status.online .status-dot { animation: pulse-online 2s infinite; }
@keyframes pulse-online { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
@keyframes pulse-offline { 0%, 100% { background: #ef4444; } 50% { background: #b91c1c; } }

/* PWA Install Button - Top Right */
/* PWA Install Button - REMOVED v9.5.0 */

/* Install Modal */
.install-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100001; padding:20px; align-items:center; justify-content:center; }
.install-modal.show { display:flex; }
.install-modal-content { background:var(--bg-container); border-radius:16px; max-width:400px; width:100%; padding:24px; text-align:center; }
.install-modal h3 { margin:0 0 16px 0; font-size:22px; }
.install-modal .install-steps { text-align:left; margin:20px 0; padding:16px; background:var(--bg-section); border-radius:8px; }
.install-modal .install-steps li { margin:10px 0; line-height:1.5; }
.install-modal .close-btn { margin-top:16px; padding:12px 24px; background:var(--bg-tabs); border:none; border-radius:8px; cursor:pointer; font-weight:600; color:var(--text-primary); }

/* Offline Data Sync Indicator */
.sync-pending { position: relative; }
.sync-pending::after { content: '‚è≥'; position: absolute; top: -5px; right: -5px; font-size: 12px; }

/* PWA Update Available Banner */
.pwa-update-banner { position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px 20px; text-align: center; z-index: 100000; display: none; align-items: center; justify-content: center; gap: 15px; }
.pwa-update-banner.show { display: flex; }
.pwa-update-banner button { background: white; color: #d97706; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; }

/* Unit Toggle Styles */
.unit-toggle { background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important; color: white !important; font-weight: bold !important; min-width: 75px; }
.unit-toggle.metric { background: linear-gradient(135deg, #10b981, #059669) !important; }
[data-unit-imperial] { display: inline; }
[data-unit-metric] { display: none; }
.metric-mode [data-unit-imperial] { display: none; }
.metric-mode [data-unit-metric] { display: inline; }

/* Quick Reference Modal Styles */
.qref-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:100000; overflow-y:auto; padding:20px; }
.qref-modal.active { display:flex; align-items:flex-start; justify-content:center; }
.qref-content { background:var(--bg-container); border-radius:16px; max-width:900px; width:100%; margin:20px auto; box-shadow:0 25px 50px rgba(0,0,0,0.5); max-height:90vh; overflow:hidden; display:flex; flex-direction:column; }
.qref-header { background:linear-gradient(135deg,#7c3aed,#9333ea); color:white; padding:20px 24px; display:flex; justify-content:space-between; align-items:center; }
.qref-header h2 { margin:0; font-size:18px; }
.qref-close { background:rgba(255,255,255,0.2); border:none; color:white; font-size:18px; width:40px; height:40px; border-radius:50%; cursor:pointer; }
.qref-close:hover { background:rgba(255,255,255,0.3); }
.qref-search { padding:16px 24px; border-bottom:1px solid var(--border); }
.qref-search input { width:100%; padding:12px 16px; border:2px solid var(--border); border-radius:8px; font-size:16px; background:var(--bg-section); color:var(--text-primary); }
.qref-tabs { display:flex; gap:4px; padding:12px 24px; border-bottom:1px solid var(--border); flex-wrap:wrap; }
.qref-tab { padding:8px 16px; border:none; background:var(--bg-section); color:var(--text-primary); border-radius:8px; cursor:pointer; font-weight:500; }
.qref-tab:hover { background:var(--bg-tabs); }
.qref-tab.active { background:linear-gradient(135deg,#7c3aed,#9333ea); color:white; }
.qref-body { padding:24px; overflow-y:auto; flex:1; }
.qref-section { margin-bottom:24px; }
.qref-section h3 { color:var(--text-accent); margin:0 0 12px 0; font-size:18px; border-bottom:2px solid var(--border); padding-bottom:8px; }
.qref-table { width:100%; border-collapse:collapse; font-size:14px; }
.qref-table th { background:var(--bg-section-header); padding:10px 12px; text-align:left; font-weight:600; }
.qref-table td { padding:10px 12px; border-bottom:1px solid var(--border); }
.qref-table tr:hover { background:var(--bg-note); }
.qref-range { display:inline-block; padding:2px 8px; border-radius:4px; font-weight:600; font-size:12px; }
.qref-range.optimal { background:#d1fae5; color:#065f46; }
.qref-range.warning { background:#fef3c7; color:#92400e; }
.qref-range.critical { background:#fee2e2; color:#991b1b; }
.qref-trouble { background:var(--bg-section); border-radius:8px; padding:16px; margin-bottom:12px; }
.qref-trouble h4 { margin:0 0 8px 0; color:var(--text-section); }
.qref-trouble ul { margin:8px 0 0 20px; padding:0; }
.qref-trouble li { margin:4px 0; color:var(--text-primary); }
.qref-hidden { display:none !important; }

:root{
--bg-body:linear-gradient(135deg,#0077b6 0%,#00b4d8 100%);
--bg-container:#fff;
--bg-header:linear-gradient(135deg,#0077b6 0%,#023e8a 100%);
--bg-tabs:#f0f9ff;
--bg-tab-active:#fff;
--bg-section:#fff;
--bg-section-header:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);
--bg-table-th:#f0f9ff;
--bg-col-header:#bae6fd;
--bg-row-header:#f0f9ff;
--bg-input:#fff;
--bg-result:#bae6fd;
--bg-note:#e0f2fe;
--bg-card:#ffffff;
--text:#0c1929;
--text-header:#fff;
--text-accent:#0077b6;
--text-unit:#64748b;
--text-section:#1e3a5f;
--border:#e0f2fe;
--border-input:#bae6fd;
--border-focus:#0077b6;
--border-note:#00b4d8;
--ok:#06d6a0;
--warn:#ffd166;
--bad:#ef476f;
--info:#00b4d8;
--purple:#5856d6;
--indigo:#0077b6;
--pink:#ef476f;
--teal:#06d6a0;
--cyan:#00b4d8;
--orange:#ffd166;
--gradient-1:linear-gradient(135deg,#0077b6 0%,#00b4d8 100%);
--gradient-2:linear-gradient(135deg,#00b4d8 0%,#48cae4 100%);
--gradient-3:linear-gradient(135deg,#023e8a 0%,#0077b6 100%);
--shadow-sm:0 2px 4px rgba(0,119,182,.08);
--shadow-md:0 4px 12px rgba(0,119,182,.12);
--shadow-lg:0 8px 24px rgba(0,119,182,.16);
--shadow-xl:0 20px 40px rgba(0,119,182,.20);
--font-xs:11px;
--font-sm:13px;
--font-base:15px;
--font-md:17px;
--font-lg:21px;
--font-xl:28px;
--font-2xl:34px;
--leading-tight:1.25;
--leading-normal:1.5;
--leading-relaxed:1.75;
--tracking-tight:-0.02em;
--tracking-normal:0;
--tracking-wide:0.02em;
}
html.dark{
--bg-body:linear-gradient(135deg,#0c1929 0%,#1a2744 100%);
--bg-container:#1a2744;
--bg-header:linear-gradient(135deg,#0077b6 0%,#023e8a 100%);
--bg-tabs:#0c1929;
--bg-tab-active:#1a2744;
--bg-section:#243b55;
--bg-section-header:linear-gradient(135deg,#1a2744 0%,#0c1929 100%);
--bg-table-th:#0c1929;
--bg-col-header:#0077b6;
--bg-row-header:#1a2744;
--bg-input:#1a2744;
--bg-result:#0077b6;
--bg-note:#023e8a;
--bg-card:#243b55;
--text:#e0e7ef;
--text-header:#f8fafc;
--text-accent:#48cae4;
--text-unit:#90cdf4;
--text-section:#90cdf4;
--border:#1e3a5f;
--border-input:#0077b6;
--border-focus:#00b4d8;
--border-note:#48cae4;
--ok:#06d6a0;
--warn:#ffd166;
--bad:#ef476f;
--info:#00b4d8;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;min-height:100vh;background:var(--bg-body);color:var(--text);padding:10px;overflow-x:hidden;font-size:15px;line-height:1.5;letter-spacing:-0.01em;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
.wrap{max-width:1920px;margin:0 auto;background:var(--bg-container);border-radius:18px;box-shadow:var(--shadow-xl);animation:fadeIn .5s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.6;transform:scale(1.1)}}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideInUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes glow{0%,100%{box-shadow:0 0 5px var(--text-accent)}50%{box-shadow:0 0 20px var(--text-accent)}}
@keyframes typing{from{width:0}to{width:100%}}
@keyframes blink{50%{border-color:transparent}}
.header{background:var(--bg-header);color:var(--text-header);padding:24px 32px;position:relative}
.sticky-header{position:sticky;top:0;z-index:100;background:var(--bg-header);box-shadow:0 2px 10px rgba(0,0,0,0.3)}
.header h1{font-size:var(--font-xl);font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;letter-spacing:var(--tracking-tight);line-height:var(--leading-tight)}
.live-indicator{width:12px;height:12px;background:#4ADE80;border-radius:50%;animation:pulse 2s infinite;box-shadow:0 0 12px #4ADE80}
.badge{display:inline-block;padding:5px 14px;border-radius:6px;font-size:var(--font-xs);font-weight:600;text-transform:uppercase;margin-left:8px;letter-spacing:var(--tracking-wide)}
.badge.pro{background:linear-gradient(135deg,#f093fb,#f5576c);color:#fff;box-shadow:0 4px 12px rgba(240,147,251,.4)}
.badge.new{background:#e83e8c;color:#fff}
.badge.beta{background:#17a2b8;color:#fff}
.badge.ai{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;animation:glow 2s infinite}
.muted{opacity:.9;font-size:0.95rem}
.header-controls{position:absolute;right:24px;top:24px;display:flex;gap:12px;flex-wrap:wrap}
.toggle{width:44px;height:44px;border-radius:999px;border:1px solid rgba(255,255,255,.25);display:grid;place-items:center;background:rgba(255,255,255,.09);color:#fff;cursor:pointer;transition:all .3s;font-size:18px}
.toggle:hover{background:rgba(255,255,255,.15);transform:rotate(180deg) scale(1.05)}
.toggle.active{background:var(--ok);animation:glow 2s infinite}
.status-bar{display:flex;gap:24px;margin-top:14px;flex-wrap:wrap}
.status-item{display:flex;align-items:center;gap:8px;font-size:13px;opacity:.9;padding:6px 12px;background:rgba(255,255,255,.1);border-radius:8px}
.status-item .dot{width:8px;height:8px;border-radius:50%;background:currentColor}
.row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-top:14px}
input,select,textarea{width:100%;padding:11px 14px;border-radius:10px;border:2px solid var(--border-input);background:var(--bg-input);color:var(--text);transition:all .3s;font-size:14px;font-family:inherit}
input:focus,select:focus,textarea:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 4px rgba(44,90,160,.12);transform:translateY(-2px)}
input:hover,select:hover{border-color:var(--text-accent)}
.input-group{margin:16px 0}
.input-group label{display:block;margin-bottom:8px;font-weight:600;color:var(--text-section);font-size:14px}
.input-with-icon{position:relative}
.input-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--text-unit);pointer-events:none}
.tabs{display:flex;flex-wrap:wrap;gap:2px;background:var(--bg-tabs);border-bottom:2px solid var(--border);scrollbar-width:thin}
.tab{padding:16px 18px;border:0;background:transparent;color:var(--text-unit);cursor:pointer;white-space:nowrap;font-weight:600;transition:all .2s;font-size:14px;position:relative}
.tab:hover{background:var(--bg-note);transform:translateY(-2px)}
.tab[aria-selected="true"]{background:var(--bg-tab-active);color:var(--text-accent);border-bottom:4px solid var(--text-accent)}
.tab.active{background:var(--bg-tab-active);color:#48cae4;border-bottom:4px solid #48cae4 !important}

.tab[aria-selected="true"]::after{content:'';position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:20px;height:3px;background:var(--text-accent);border-radius:2px}
.content{padding:24px}
/* NUCLEAR PANEL VISIBILITY CONTROL */
.panel{display:none !important;visibility:hidden !important;position:absolute !important;left:-9999px !important;top:0 !important;width:100% !important;pointer-events:none !important;}
.panel.force-visible{display:block !important;visibility:visible !important;height:auto !important;overflow:visible !important;opacity:1 !important;position:relative !important;left:auto !important;z-index:100 !important;pointer-events:auto !important;}
.panel.active{display:block !important;visibility:visible !important;position:relative !important;left:auto !important;animation:fadeIn .3s;pointer-events:auto !important;}
.section{background:var(--bg-section);border:1px solid var(--border);border-radius:14px;overflow:visible;margin-bottom:24px;transition:all .3s}
.section:hover{box-shadow:var(--shadow-md);transform:translateY(-2px)}
.section-h{background:var(--bg-section-header);padding:16px 20px;font-weight:600;font-size:var(--font-md);color:var(--text-section);display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none;letter-spacing:var(--tracking-tight)}
.section-h:hover{background:var(--bg-note)}
.section-content{padding:24px;display:block !important;max-height:none !important;overflow:visible !important}
.section-actions{display:flex;gap:8px}
.icon-btn{background:rgba(44,90,160,.1);border:none;padding:8px 12px;cursor:pointer;color:var(--text-accent);transition:all .2s;border-radius:8px;font-weight:500;font-size:var(--font-sm)}
.icon-btn:hover{background:var(--text-accent);color:#fff;transform:scale(1.05)}
.table{width:100%;border-collapse:collapse;font-size:var(--font-base)}
.table th,.table td{padding:14px;border-bottom:1px solid var(--border);text-align:left}
.table th{background:var(--bg-table-th);position:sticky;top:0;z-index:10;font-weight:600;text-transform:uppercase;font-size:var(--font-xs);letter-spacing:var(--tracking-wide)}
.table tbody tr{transition:all .2s}
.table tbody tr:hover{background:var(--bg-section-header);transform:scale(1.01)}
.col{background:var(--bg-col-header);color:var(--text-accent);font-weight:700}
.rowh{background:var(--bg-row-header);min-width:150px;font-weight:600}
.result{font-weight:700;color:var(--text-accent);background:var(--bg-result);padding:8px 12px;border-radius:8px;font-variant-numeric:tabular-nums;display:inline-block}
.status{font-weight:700;padding:6px 12px;border-radius:8px;font-size:13px;display:inline-block}
.ok{color:var(--ok);background:rgba(40,167,69,.15)}
.warn{color:var(--warn);background:rgba(255,193,7,.15)}
.bad{color:var(--bad);background:rgba(220,53,69,.15)}
.info{color:var(--info);background:rgba(23,162,184,.15)}
.btns{display:flex;flex-wrap:wrap;gap:12px;margin:14px 0}
.btn{padding:13px 22px;border-radius:12px;border:0;cursor:pointer;color:#fff;background:var(--text-accent);font-weight:500;transition:all .2s;font-size:var(--font-base);box-shadow:var(--shadow-sm);position:relative;overflow:hidden;letter-spacing:var(--tracking-wide)}
.btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;border-radius:50%;background:rgba(255,255,255,.3);transform:translate(-50%,-50%);transition:width .3s,height .3s}
.btn:hover::before{width:300px;height:300px}
.btn:hover{opacity:.95;transform:translateY(-3px);box-shadow:var(--shadow-md)}
.btn:active{transform:translateY(-1px)}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn.gray{background:#6c757d}
.btn.green{background:var(--ok)}
.btn.red{background:var(--bad)}
.btn.purple{background:var(--purple)}
.btn.orange{background:var(--orange)}
.btn.teal{background:var(--teal)}
.btn.pink{background:var(--pink)}
.btn.indigo{background:var(--indigo)}
.btn.gradient{background:var(--gradient-1)}
.btn.active{box-shadow:0 0 0 3px rgba(74,222,128,0.5);transform:translateY(-2px)}
.note{background:var(--bg-note);border-left:5px solid var(--border-note);padding:16px;border-radius:0 12px 12px 0;color:var(--text);margin-top:12px;font-size:14px;line-height:1.7}
.note.success{background:rgba(40,167,69,.1);border-left-color:var(--ok)}
.note.warning{background:rgba(255,193,7,.1);border-left-color:var(--warn)}
.note.error{background:rgba(220,53,69,.1);border-left-color:var(--bad)}
.chart-container{position:relative;height:360px;width:100%;margin:24px 0;padding:20px;background:var(--bg-card);border-radius:14px;box-shadow:var(--shadow-sm)}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin:24px 0}
.kpi-card{background:var(--bg-card);padding:24px;border-radius:14px;text-align:center;border:2px solid var(--border);transition:all .3s;cursor:pointer;position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:5px;background:var(--gradient-1);transform:scaleX(0);transition:transform .3s;border-radius:14px 14px 0 0}
.kpi-card:hover{transform:translateY(-6px);box-shadow:var(--shadow-lg);border-color:var(--text-accent)}
.kpi-card:hover::before{transform:scaleX(1)}
.kpi-card h4{margin:0 0 12px 0;color:var(--text-section);font-size:13px;text-transform:uppercase;letter-spacing:1px;font-weight:700}
.kpi-card p{margin:0;font-size:2.2em;font-weight:800;color:var(--text-accent);font-variant-numeric:tabular-nums}
.kpi-card .trend{font-size:0.45em;margin-top:8px;font-weight:600}
.kpi-card .trend.up{color:var(--ok)}
.kpi-card .trend.down{color:var(--bad)}
.kpi-card .trend.stable{color:var(--text-unit)}
.small{font-size:12px;color:var(--text-unit);margin-top:4px}
.gauge-container{display:flex;justify-content:center;align-items:center;margin:24px 0}
.gauge{font-size:2.8em;font-weight:800;padding:35px;border-radius:50%;width:200px;height:200px;display:flex;align-items:center;justify-content:center;border:10px solid;text-align:center;line-height:1.2;position:relative}
.gauge::after{content:'';position:absolute;inset:15px;border-radius:50%;background:var(--bg-container);z-index:-1}
.gauge.good{color:var(--ok);border-color:var(--ok);background:radial-gradient(circle,rgba(40,167,69,.2),transparent)}
.gauge.caution{color:var(--warn);border-color:var(--warn);background:radial-gradient(circle,rgba(255,193,7,.2),transparent)}
.gauge.critical{color:var(--bad);border-color:var(--bad);background:radial-gradient(circle,rgba(220,53,69,.2),transparent)}
.score-badge{display:inline-block;padding:8px 16px;border-radius:10px;font-weight:700;font-size:15px;box-shadow:var(--shadow-sm)}
.score-excellent{background:rgba(40,167,69,.25);color:var(--ok)}
.score-good{background:rgba(44,90,160,.25);color:var(--text-accent)}
.score-fair{background:rgba(255,193,7,.25);color:var(--warn)}
.score-poor{background:rgba(220,53,69,.25);color:var(--bad)}
.alert-box{background:var(--bg-card);border:2px solid var(--border);border-radius:14px;padding:18px;margin:16px 0;display:flex;gap:16px;align-items:start;transition:all .3s}
.alert-box:hover{box-shadow:var(--shadow-md);transform:translateX(4px)}
.alert-box.alert-critical{border-left:6px solid var(--bad);background:rgba(220,53,69,.05)}
.alert-box.alert-warning{border-left:6px solid var(--warn);background:rgba(255,193,7,.05)}
.alert-box.alert-info{border-left:6px solid var(--info);background:rgba(23,162,184,.05)}
.alert-icon{font-size:20px;flex-shrink:0}
.alert-content{flex:1}
.alert-title{font-weight:700;margin-bottom:6px;font-size:15px}
.alert-message{font-size:14px;color:var(--text-unit);line-height:1.6}
.alert-time{font-size:12px;color:var(--text-unit);margin-top:8px}
.toast{position:fixed;top:24px;right:24px;background:var(--bg-container);border:2px solid var(--border);border-radius:14px;padding:18px 26px;box-shadow:var(--shadow-xl);z-index:9999;animation:slideInRight .3s;max-width:450px;min-width:320px}
.toast.success{border-left:6px solid var(--ok)}
.toast.error{border-left:6px solid var(--bad)}
.toast.warning{border-left:6px solid var(--warn)}
.toast.info{border-left:6px solid var(--info)}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:10000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal.active{display:flex}
.modal-content{background:var(--bg-container);border-radius:18px;padding:32px;max-width:800px;width:90%;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow-xl);animation:slideInUp .3s}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid var(--border)}
.modal-header h2{color:var(--text-accent);margin:0;font-size:18px;font-weight:700}
.modal-close{background:rgba(220,53,69,.1);border:none;font-size:20px;cursor:pointer;color:var(--bad);padding:4px;width:36px;height:36px;display:grid;place-items:center;border-radius:50%;transition:all .2s}
.modal-close:hover{background:var(--bad);color:#fff;transform:rotate(90deg)}
.tool-card{background:var(--bg-card);padding:28px;border-radius:14px;border:2px solid var(--border);margin-bottom:24px;transition:all .3s;position:relative;overflow:hidden}
.tool-card::before{content:'';position:absolute;top:0;left:0;width:100%;height:4px;background:var(--gradient-1)}
.tool-card:hover{border-color:var(--text-accent);box-shadow:var(--shadow-lg);transform:translateY(-4px)}
.tool-card h3{margin:0 0 18px 0;color:var(--text-accent);font-size:20px;font-weight:700}
.tool-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:18px;margin:18px 0}
.scenario-card{padding:24px;border:2px solid var(--border);border-radius:14px;background:var(--bg-card);cursor:pointer;transition:all .3s;text-align:center;position:relative;overflow:hidden}
.scenario-card::before{content:'';position:absolute;inset:0;background:var(--gradient-1);opacity:0;transition:opacity .3s}
.scenario-card:hover{border-color:var(--text-accent);transform:translateY(-6px);box-shadow:var(--shadow-lg)}
.scenario-card:hover::before{opacity:.05}
.scenario-card .icon{font-size:48px;margin-bottom:12px;position:relative;z-index:1}
.scenario-card strong{display:block;margin:12px 0 8px;color:var(--text);font-size:18px;position:relative;z-index:1}
.scenario-card p{margin:0;color:var(--text-unit);font-size:14px;position:relative;z-index:1}
.metric-card{background:var(--bg-card);padding:20px;border-radius:12px;border:1px solid var(--border);transition:all .3s}
.metric-card:hover{box-shadow:var(--shadow-md);border-color:var(--text-accent)}
.metric-card h5{margin:0 0 8px 0;color:var(--text-section);font-size:13px;text-transform:uppercase;font-weight:600}
.metric-card .value{font-size:20px;font-weight:700;color:var(--text-accent);margin:8px 0}
.metric-card .change{font-size:13px;font-weight:600}
.metric-card .change.positive{color:var(--ok)}
.metric-card .change.negative{color:var(--bad)}
.progress-bar{width:100%;height:12px;background:var(--border);border-radius:999px;overflow:hidden;margin:12px 0}
.progress-fill{height:100%;background:var(--gradient-1);border-radius:999px;transition:width .3s;position:relative}
.progress-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 2s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:20px 0}
.stat-item{text-align:center;padding:20px;background:var(--bg-card);border-radius:12px;border:2px solid var(--border)}
.stat-label{font-size:13px;color:var(--text-unit);text-transform:uppercase;font-weight:600;margin-bottom:8px}
.stat-value{font-size:32px;font-weight:800;color:var(--text-accent);margin:8px 0}
.stat-unit{font-size:14px;color:var(--text-unit)}
.timeline{position:relative;padding:20px 0}
.timeline-item{display:flex;gap:16px;margin-bottom:24px;position:relative}
.timeline-item::before{content:'';position:absolute;left:19px;top:40px;bottom:-24px;width:2px;background:var(--border)}
.timeline-item:last-child::before{display:none}
.timeline-icon{width:40px;height:40px;border-radius:50%;background:var(--text-accent);color:#fff;display:grid;place-items:center;font-weight:700;flex-shrink:0;box-shadow:var(--shadow-sm)}
.timeline-content{flex:1;padding:12px 16px;background:var(--bg-card);border-radius:12px;border:1px solid var(--border)}
.timeline-title{font-weight:700;margin-bottom:6px}
.timeline-time{font-size:12px;color:var(--text-unit)}
.accordion-item{border:1px solid var(--border);border-radius:12px;margin-bottom:12px;overflow:hidden}
.accordion-header{padding:16px 20px;background:var(--bg-section-header);cursor:pointer;font-weight:600;display:flex;justify-content:space-between;align-items:center;transition:all .2s}
.accordion-header:hover{background:var(--bg-note)}
.accordion-header::after{content:'‚ñº';transition:transform .3s}
.accordion-header.active::after{transform:rotate(180deg)}
.accordion-content{max-height:0;overflow:hidden;transition:max-height .3s}
.accordion-content.active{max-height:1000px;padding:20px}
.split-view{display:grid;grid-template-columns:1fr 1fr;gap:24px}
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}
.loading-spinner{border:4px solid var(--border);border-top:4px solid var(--text-accent);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-unit)}
.empty-state-icon{font-size:64px;margin-bottom:16px;opacity:.5}
.empty-state-title{font-size:20px;font-weight:600;margin-bottom:8px;color:var(--text)}
.empty-state-message{font-size:14px;margin-bottom:24px}
.tag{display:inline-block;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;text-transform:uppercase;margin:2px}
.tag.success{background:rgba(40,167,69,.2);color:var(--ok)}
.tag.warning{background:rgba(255,193,7,.2);color:var(--warn)}
.tag.danger{background:rgba(220,53,69,.2);color:var(--bad)}
.tag.info{background:rgba(23,162,184,.2);color:var(--info)}

/* AI-Specific Styles */
.ai-chat-container{background:var(--bg-card);border-radius:14px;border:2px solid var(--border);padding:24px;min-height:500px;display:flex;flex-direction:column;gap:16px}
.ai-messages{flex:1;overflow-y:auto;max-height:600px;padding:16px;background:var(--bg-section);border-radius:12px;display:flex;flex-direction:column;gap:12px}
.ai-message{padding:14px 18px;border-radius:12px;max-width:80%;animation:slideInUp .3s;line-height:1.6}
.ai-message.user{background:var(--text-accent);color:#fff;align-self:flex-end;border-bottom-right-radius:4px}
.ai-message.assistant{background:var(--bg-note);color:var(--text);align-self:flex-start;border-bottom-left-radius:4px;border-left:4px solid var(--text-accent)}
.ai-message.assistant::before{content:'ü§ñ';margin-right:8px;font-size:1.2em}
.ai-input-area{display:flex;gap:12px;align-items:center}
.ai-input{flex:1}
.ai-thinking{display:none;align-items:center;gap:8px;color:var(--text-accent);font-style:italic;padding:10px;background:var(--bg-note);border-radius:8px;margin:8px 0}
.ai-thinking.active{display:flex}
.ai-thinking::before{content:'';width:20px;height:20px;border:3px solid var(--text-accent);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
.diagnostic-card{background:var(--bg-card);border:2px solid var(--border);border-radius:14px;padding:24px;margin:16px 0;transition:all .3s}
.diagnostic-card:hover{border-color:var(--text-accent);box-shadow:var(--shadow-lg)}
.diagnostic-card .severity{display:inline-block;padding:6px 14px;border-radius:8px;font-weight:700;font-size:12px;text-transform:uppercase;margin-bottom:12px}
.diagnostic-card .severity.high{background:rgba(220,53,69,.2);color:var(--bad)}
.diagnostic-card .severity.medium{background:rgba(255,193,7,.2);color:var(--warn)}
.diagnostic-card .severity.low{background:rgba(23,162,184,.2);color:var(--info)}
.solution-step{background:var(--bg-section);border-left:4px solid var(--text-accent);padding:16px;border-radius:0 12px 12px 0;margin:12px 0}
.solution-step h5{margin:0 0 8px 0;color:var(--text-accent);font-size:15px}
.solution-step p{margin:0;line-height:1.6;color:var(--text-unit)}
.knowledge-item{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:18px;margin:12px 0;cursor:pointer;transition:all .3s}
.knowledge-item:hover{border-color:var(--text-accent);transform:translateX(4px);box-shadow:var(--shadow-md)}
.knowledge-item h4{margin:0 0 8px 0;color:var(--text-accent);font-size:16px}
.knowledge-item p{margin:0;color:var(--text-unit);font-size:14px;line-height:1.6}
.confidence-bar{width:100%;height:8px;background:var(--border);border-radius:999px;overflow:hidden;margin:8px 0}
.confidence-fill{height:100%;background:var(--gradient-1);border-radius:999px;transition:width .5s}
.symptom-checker{background:var(--bg-section);border-radius:12px;padding:20px;margin:16px 0}
.symptom-option{display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border:2px solid var(--border);border-radius:10px;margin:8px 0;cursor:pointer;transition:all .2s}
.symptom-option:hover{border-color:var(--text-accent);transform:translateX(4px)}
.symptom-option input[type="checkbox"]{width:20px;height:20px;cursor:pointer}
.issue-history-item{background:var(--bg-card);border-left:4px solid var(--info);padding:16px;border-radius:0 12px 12px 0;margin:12px 0;transition:all .3s}
.issue-history-item:hover{box-shadow:var(--shadow-md);transform:translateX(4px)}
.issue-history-item.resolved{border-left-color:var(--ok);opacity:.7}
.issue-history-item .issue-date{font-size:12px;color:var(--text-unit);margin-bottom:6px}
.issue-history-item .issue-title{font-weight:700;margin-bottom:6px;color:var(--text-accent)}
.issue-history-item .issue-desc{font-size:14px;color:var(--text-unit);line-height:1.6}

@media(max-width:1024px){
.split-view{grid-template-columns:1fr}
.tool-grid,.card-grid{grid-template-columns:1fr}
}
@media(max-width:768px){
.content{padding:16px}
.table{font-size:12px}
.table th,.table td{padding:10px}
.header h1{font-size:18px}
.header-controls{position:relative;right:auto;top:auto;margin-top:12px}
.kpi-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
.modal-content{padding:20px}
.ai-message{max-width:95%}
}

/* ==================== ENHANCED RESPONSIVE DESIGN v9.5.0 ==================== */

/* Mobile Menu Toggle */
.mobile-menu-toggle{display:none;position:fixed;bottom:20px;right:20px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);border:none;color:white;font-size:18px;cursor:pointer;z-index:1000;box-shadow:0 4px 20px rgba(102,126,234,0.4);transition:all 0.3s}
.mobile-menu-toggle:hover{transform:scale(1.1)}
.mobile-menu-toggle:active{transform:scale(0.95)}

/* Tab Navigation Improvements */
.tabs{overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}

/* ===== TABLET LANDSCAPE (1024px - 1280px) ===== */
@media(min-width:1024px) and (max-width:1280px){
  body{padding:15px}
  .wrap{max-width:100%;border-radius:16px}

  /* Header */
  .header{padding:20px 24px}
  .header h1{font-size:26px}

  /* Tabs - comfortable spacing */
  .tabs{padding:10px 12px;gap:6px;justify-content:center;flex-wrap:wrap}
  .tab{padding:12px 16px;font-size:13px;border-radius:8px}

  /* Content */
  .content{padding:20px}
  .section{margin-bottom:20px}
  .section-h{padding:14px 18px;font-size:15px}

  /* Grids - 3 columns */
  .row{grid-template-columns:repeat(3,1fr);gap:14px}
  .kpi-grid{grid-template-columns:repeat(3,1fr);gap:14px}
  .tool-grid{grid-template-columns:repeat(3,1fr)}

  /* Tables */
  .table{font-size:13px}
  .table th,.table td{padding:12px}

  /* Inputs - comfortable size */
  .input-group input,.input-group select{padding:12px;font-size:15px;min-height:46px}
}

/* ===== TABLET PORTRAIT (768px - 1024px) - ENHANCED v9.5.0 ===== */
@media(min-width:768px) and (max-width:1024px){
  body{padding:0;background:var(--bg-body)}
  .wrap{border-radius:0;min-height:100vh}

  /* Header - Compact & Sticky */
  .header{
    padding:12px 16px;
    text-align:left;
    position:sticky;
    top:0;
    z-index:100;
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
    gap:10px
  }
  .header h1{font-size:20px;margin:0;flex:1}
  .header h1 .badge{display:none}
  .header p{display:none}
  .header-controls{
    position:static;
    margin:0;
    display:flex;
    gap:6px;
    flex-wrap:nowrap
  }
  .header-controls .toggle{width:36px;height:36px;font-size:16px;padding:0;display:flex;align-items:center;justify-content:center}

  /* Tabs - WRAPPED GRID like landscape mode */
  .tabs{
    padding:10px 16px;
    gap:6px;
    justify-content:center;
    flex-wrap:wrap;
    overflow-x:visible;
    background:var(--bg-tabs);
    position:sticky;
    top:60px;
    z-index:99
  }
  .tab{
    padding:10px 14px;
    font-size:12px;
    border-radius:8px;
    flex-shrink:0;
    white-space:nowrap;
    min-width:auto
  }
  .tab .badge{display:none}

  /* Content */
  .content{padding:14px;position:relative;overflow:hidden}

  /* CRITICAL: Panel isolation for tablet scroll fix */
  .panel{position:absolute !important;left:-9999px !important;visibility:hidden !important;display:none !important}
  .panel.active{position:relative !important;left:auto !important;visibility:visible !important;display:block !important}

  .section{margin-bottom:14px;border-radius:12px}
  .section-h{padding:12px 14px;font-size:14px}
  .section-content{padding:14px}

  /* KPI Grid - 3 columns for better use of space */
  .kpi-grid{
    display:grid !important;
    grid-template-columns:repeat(3,1fr) !important;
    gap:10px !important
  }

  /* KPI Cards - Optimized for tablet */
  .kpi-card{
    padding:14px 10px;
    border-radius:10px;
    text-align:center
  }
  .kpi-card h4{
    font-size:10px;
    margin-bottom:4px;
    text-transform:uppercase;
    letter-spacing:0.5px
  }
  .kpi-card p{
    font-size:22px;
    font-weight:700;
    margin:4px 0
  }
  .kpi-card small{
    font-size:9px;
    opacity:0.8
  }

  /* Input grids - 2 columns */
  .row{grid-template-columns:repeat(2,1fr);gap:10px}
  .tool-grid{grid-template-columns:repeat(2,1fr)}
  .card-grid{grid-template-columns:repeat(2,1fr)}
  .stats-row{grid-template-columns:repeat(2,1fr)}

  /* Tables - Responsive */
  .table{font-size:11px;display:block;overflow-x:auto}
  .table th,.table td{padding:8px 6px;white-space:nowrap}
  .rowh{min-width:100px}

  /* Buttons - Touch friendly */
  .btn{padding:12px 16px;font-size:13px;min-height:44px;border-radius:10px}
  .btns{flex-wrap:wrap;gap:8px}
  .btns .btn{flex:1 1 45%}

  /* Inputs - Touch friendly */
  .input-group{margin:10px 0}
  .input-group label{font-size:13px;margin-bottom:6px}
  .input-group input,.input-group select{
    padding:12px;
    font-size:16px;
    min-height:48px;
    border-radius:10px;
    -webkit-appearance:none
  }

  /* Prevent zoom on focus (iOS) */
  input[type="text"],input[type="number"],input[type="email"],input[type="tel"],select,textarea{
    font-size:16px !important
  }

  /* Charts */
  .chart-container{height:240px;padding:12px}
  canvas{max-height:220px !important}

  /* Modals */
  .modal{padding:10px}
  .modal-content{width:95%;max-height:90vh;border-radius:14px}

  /* Notes */
  .note{padding:12px;font-size:13px;border-radius:10px}

  /* Quick Reference Modal */
  .qref-content{max-width:98%;max-height:95vh;margin:10px auto}
  .qref-header{padding:14px 16px}
  .qref-header h2{font-size:18px}
  .qref-tabs{flex-wrap:wrap;gap:4px;padding:10px 14px}
  .qref-tab{padding:8px 12px;font-size:12px}
  .qref-body{padding:14px}

  /* AI Recommendations section */
  .ai-recommendations,.note.info,.note.warning{
    font-size:13px;
    padding:12px
  }

  /* Floating widgets */
  #floatingUnitConverter{bottom:80px;right:12px}
  .cost-floating-widget{bottom:80px;left:12px}
  #fabMenu{bottom:12px;right:12px}
  #fabMenu button{width:44px;height:44px;font-size:18px}

  /* PWA Status */
  .pwa-status{bottom:12px;left:12px;padding:6px 10px;font-size:11px}

  /* Show mobile bottom nav on tablet portrait */
  .mobile-bottom-nav{
    display:flex !important;
    padding:8px 12px;
    padding-bottom:max(8px, env(safe-area-inset-bottom))
  }
  .mobile-nav-icon{font-size:20px}
  .mobile-nav-label{font-size:9px}

  /* Footer padding for bottom nav */
  .panel{padding-bottom:70px}

  /* Dashboard specific improvements */
  #dashboard .section:first-of-type .section-content{
    padding:10px
  }
}

/* ===== TABLET PORTRAIT ORIENTATION - WRAPPED TABS ===== */
@media(min-width:768px) and (max-width:1024px) and (orientation:portrait){
  /* Disable sticky header on tablet to prevent overlap */
  .sticky-header{position:relative !important}

  /* Hide floating buttons that overlap content */
  #favoritesFloatingBtn, #favoritesPanel, .realtime-badge, #csvImportBtn, .pwa-status{display:none !important}

  .tabs{
    flex-wrap:wrap !important;
    overflow-x:visible !important;
    justify-content:center !important;
    padding:12px 16px !important;
    gap:8px !important
  }
  .tab{
    padding:10px 16px !important;
    font-size:12px !important
  }
}

/* ===== TABLET PORTRAIT DARK MODE FIXES ===== */
@media(min-width:768px) and (max-width:1024px){
  /* Fix panel overlap - add top padding */
  .content{padding-top:10px}
  .panel.active{margin-top:0;padding-top:10px}

  /* Hide ALL floating bottom buttons on tablet */
  #favoritesFloatingBtn, #favoritesPanel, .realtime-badge, #csvImportBtn, .pwa-status, .mobile-menu-toggle{display:none !important}

  html.dark .tabs{
    background:linear-gradient(180deg, #0c1929 0%, #1a2744 100%);
    border-bottom:1px solid #334155
  }
  html.dark .tab{
    color:#94a3b8
  }
  html.dark .tab.active{
    background:linear-gradient(135deg, #1a2744, #243b55);
    color:#48cae4;
    border-bottom:2px solid #48cae4
  }
  html.dark .header{
    background:linear-gradient(135deg, #023e8a 0%, #0077b6 100%);
    box-shadow:0 2px 10px rgba(0,0,0,0.3)
  }
  html.dark .kpi-card{
    background:linear-gradient(135deg, #1a2744 0%, #243b55 100%);
    border:1px solid #334155
  }
}

/* ===== MOBILE STYLES (480px - 767px) ===== */
@media(min-width:480px) and (max-width:767px){
  body{padding:0;background:var(--bg-body)}
  .wrap{border-radius:0;min-height:100vh}

  /* Header - Compact */
  .header{padding:14px 16px;text-align:center}
  .header h1{font-size:20px;margin-bottom:4px;justify-content:center}
  .header p{display:none}
  .header-controls{position:static;margin-top:10px;justify-content:center;flex-wrap:wrap;gap:8px}
  .toggle{width:40px;height:40px;font-size:16px}

  /* Show mobile menu toggle */
  .mobile-menu-toggle{display:flex;align-items:center;justify-content:center}

  /* Tabs - Horizontal scroll */
  .tabs{padding:8px 10px;gap:6px;justify-content:flex-start;overflow-x:auto;flex-wrap:nowrap}
  .tab{padding:10px 14px;font-size:12px;border-radius:8px;min-width:auto;flex-shrink:0;white-space:nowrap}
  .tab .badge{display:none}

  /* Content */
  .content{padding:12px}

  /* Sections */
  .section{margin-bottom:14px;border-radius:12px}
  .section-h{padding:12px 14px;font-size:14px;border-radius:12px 12px 0 0}
  .section-content{padding:14px}

  /* Grids - 2 columns for larger phones */
  .row{grid-template-columns:repeat(2,1fr);gap:10px}
  .kpi-grid{grid-template-columns:repeat(2,1fr);gap:10px}
  .tool-grid{grid-template-columns:repeat(2,1fr)}
  .card-grid{grid-template-columns:1fr}

  /* Tables */
  .table{font-size:11px;display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .table th,.table td{padding:8px 6px;white-space:nowrap}
  .rowh{min-width:100px}

  /* Touch-friendly buttons */
  .btn{padding:14px 18px;font-size:14px;border-radius:10px;min-height:48px}
  .btns{flex-direction:row;flex-wrap:wrap;gap:8px}
  .btns .btn{flex:1 1 45%}

  /* Touch-friendly inputs */
  .input-group{margin:10px 0}
  .input-group label{font-size:13px;margin-bottom:6px}
  .input-group input,.input-group select,.input-group textarea{
    padding:14px 12px;
    font-size:16px;
    border-radius:10px;
    min-height:50px;
    -webkit-appearance:none;
    appearance:none
  }

  /* Select dropdown arrow */
  .input-group select{
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 14px center;
    padding-right:40px
  }

  /* KPI Cards */
  .kpi-card{padding:14px;border-radius:10px}
  .kpi-card h4{font-size:11px}
  .kpi-card p{font-size:22px}

  /* Charts */
  .chart-container{height:220px;padding:12px}
  canvas{max-height:200px !important}

  /* Modals - Nearly full screen */
  .modal{padding:10px}
  .modal-content{width:100%;max-height:90vh;border-radius:16px}

  /* Footer padding for FAB */
  .panel{padding-bottom:80px}
}

/* ===== SMALL MOBILE (< 480px) ===== */
@media(max-width:479px){
  body{padding:0;background:var(--bg-body)}
  .wrap{border-radius:0;min-height:100vh}

  /* Header - Very compact */
  .header{padding:12px 14px;text-align:center}
  .header h1{font-size:18px;margin-bottom:4px;justify-content:center;flex-wrap:wrap}
  .header p{display:none}
  .header-controls{position:static;margin-top:8px;justify-content:center;flex-wrap:wrap;gap:6px}
  .toggle{width:38px;height:38px;font-size:15px}
  .header-controls span{font-size:10px;padding:4px 8px}

  /* Mobile menu toggle */
  .mobile-menu-toggle{display:flex;width:56px;height:56px;font-size:22px}

  /* Tabs - Compact horizontal scroll */
  .tabs{padding:6px 8px;gap:4px}
  .tab{padding:8px 12px;font-size:11px;border-radius:6px}

  /* Content */
  .content{padding:10px}

  /* Sections */
  .section{margin-bottom:12px;border-radius:10px}
  .section-h{padding:10px 12px;font-size:13px}
  .section-content{padding:12px}

  /* Grids - Single column */
  .row{grid-template-columns:1fr !important;gap:8px}
  .kpi-grid{grid-template-columns:repeat(2,1fr);gap:8px}
  .tool-grid{grid-template-columns:1fr}
  .card-grid{grid-template-columns:1fr}
  .stats-row{grid-template-columns:1fr}
  .split-view{grid-template-columns:1fr !important}

  /* Force single column on inline styles */
  [style*="grid-template-columns: 1fr 1fr"],
  [style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr !important}
  [style*="grid-template-columns: repeat(2"],
  [style*="grid-template-columns:repeat(2"]{grid-template-columns:1fr !important}
  [style*="grid-template-columns: repeat(3"],
  [style*="grid-template-columns:repeat(3"]{grid-template-columns:1fr !important}
  [style*="grid-template-columns: repeat(4"],
  [style*="grid-template-columns:repeat(4"]{grid-template-columns:repeat(2,1fr) !important}

  /* Tables - Compact */
  .table{font-size:10px;display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .table th,.table td{padding:6px 4px;white-space:nowrap}
  .rowh{min-width:90px;font-size:10px}

  /* Buttons - Full width, touch optimized */
  .btns{flex-direction:column;gap:8px}
  .btns .btn{width:100%}
  .btn{padding:14px 16px;font-size:14px;border-radius:10px;min-height:48px;touch-action:manipulation}
  .btn.small{padding:12px 14px;min-height:44px}

  /* Touch-optimized inputs (min 44px touch target) */
  .input-group{margin:8px 0}
  .input-group label{font-size:12px;margin-bottom:5px}
  .input-group input,.input-group select,.input-group textarea{
    padding:14px 12px;
    font-size:16px;
    border-radius:10px;
    min-height:50px;
    -webkit-appearance:none;
    appearance:none;
    touch-action:manipulation
  }

  /* Select dropdown arrow */
  .input-group select{
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7280' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right 12px center;
    padding-right:36px
  }

  /* KPI Cards - Compact */
  .kpi-card{padding:12px;border-radius:10px}
  .kpi-card h4{font-size:10px;margin-bottom:3px}
  .kpi-card p{font-size:20px}
  .kpi-card small{font-size:9px}

  /* Notes */
  .note{padding:10px;font-size:12px;border-radius:8px;line-height:1.5}

  /* Modals - Full screen */
  .modal{padding:0}
  .modal-content{width:100%;height:100%;max-height:100%;border-radius:0;margin:0}
  .modal-header{position:sticky;top:0;z-index:10;padding:12px 14px}
  .modal-body{padding:12px;padding-bottom:80px}

  /* Charts */
  .chart-container{height:200px;padding:10px}
  canvas{max-height:180px !important}

  /* AI Chat */
  .ai-chat-container{height:280px}
  .ai-message{max-width:90%;font-size:13px;padding:10px}
  .ai-input-area{padding:8px}
  .ai-input-area input{font-size:16px;padding:12px;min-height:48px}

  /* Gauge */
  .gauge{width:100px;height:100px;font-size:18px}

  /* Results display */
  .result{font-size:15px;padding:6px 10px}
  .status{padding:5px 8px;font-size:11px}

  /* Checklist items - large touch targets */
  .checklist-item{padding:12px;min-height:48px;display:flex;align-items:center}
  .checklist-item input[type="checkbox"]{width:24px;height:24px;min-width:24px;margin-right:12px}

  /* Quick Reference Modal */
  .qref-content{width:100%;max-width:100%;max-height:100%;border-radius:0;margin:0}
  .qref-header{padding:14px 16px}
  .qref-header h2{font-size:18px}
  .qref-search{padding:12px}
  .qref-search input{padding:12px;font-size:16px;min-height:48px}
  .qref-tabs{padding:10px 12px;gap:6px}
  .qref-tab{padding:8px 12px;font-size:12px}
  .qref-body{padding:14px}
  .qref-section h3{font-size:15px}
  .qref-table{font-size:11px}
  .qref-table th,.qref-table td{padding:8px 6px}

  /* Floating widgets - Bottom corners */
  #floatingUnitConverter{bottom:80px;right:10px;max-width:calc(100vw - 20px)}
  .cost-floating-widget{bottom:80px;left:10px;max-width:calc(100vw - 20px)}
  #fabMenu{bottom:12px;right:12px}
  #fabMenu button{width:48px;height:48px;font-size:18px}

  /* PWA Status - Smaller */
  .pwa-status{bottom:12px;left:12px;padding:8px 12px;font-size:11px;border-radius:20px}

  /* Footer padding for FAB */
  .panel{padding-bottom:90px}

  /* Hide desktop-only elements */
  .desktop-only{display:none !important}
}

/* ===== EXTRA SMALL MOBILE (< 360px) ===== */
@media(max-width:359px){
  .header h1{font-size:16px}
  .header-controls{gap:4px}
  .toggle{width:34px;height:34px;font-size:14px}
  .tab{padding:6px 8px;font-size:10px}
  .kpi-grid{grid-template-columns:1fr}
  .kpi-card p{font-size:18px}
  .btn{font-size:13px;padding:12px}
  .table{font-size:9px}
  .table th,.table td{padding:5px 3px}
  .section-h{font-size:12px;padding:8px 10px}
  .input-group label{font-size:11px}
  .input-group input,.input-group select{padding:12px 10px;font-size:16px;min-height:48px}
  .qref-header h2{font-size:16px}
  .qref-tab{padding:6px 10px;font-size:11px}
}

/* ===== LAPTOP/DESKTOP (> 1280px) ===== */
@media(min-width:1281px){
  body{padding:20px}
  .wrap{max-width:1800px}

  /* Tabs - all visible */
  .tabs{justify-content:center;flex-wrap:wrap;padding:12px}
  .tab{padding:14px 18px;font-size:14px}

/* ===== LANDSCAPE TABLET/PHONE - ENHANCED v9.5.0 ===== */
@media(max-width:1024px) and (orientation:landscape){
  body{padding:0}
  .wrap{border-radius:0;min-height:100vh}

  /* Header - Ultra compact, side controls */
  .header{
    padding:6px 16px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:sticky;
    top:0;
    z-index:100
  }
  .header h1{
    font-size:16px;
    margin:0;
    white-space:nowrap
  }
  .header h1 .badge,.header h1 .live-indicator{display:none}
  .header p{display:none}
  .header-controls{
    position:static;
    margin:0;
    display:flex;
    gap:6px
  }
  .header-controls .toggle{width:32px;height:32px;font-size:14px}
  .header-controls span:not(.toggle):not(#appVersion){display:none}
  #appVersion{display:inline-block !important;font-size:10px;padding:3px 8px}

  /* Tabs - Compact horizontal scroll */
  .tabs{
    padding:4px 10px;
    gap:3px;
    flex-wrap:nowrap;
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
    position:sticky;
    top:44px;
    z-index:99
  }
  .tabs::-webkit-scrollbar{display:none}
  .tab{
    padding:6px 10px;
    font-size:10px;
    border-radius:6px;
    flex-shrink:0
  }
  .tab .badge{display:none}

  /* Content - Maximize space */
  .content{padding:8px 12px}
  .section{margin-bottom:10px;border-radius:10px}
  .section-h{padding:8px 12px;font-size:12px}
  .section-content{padding:10px}

  /* KPI Grid - 6 columns in landscape for all KPIs visible */
  .kpi-grid{
    display:grid !important;
    grid-template-columns:repeat(6,1fr) !important;
    gap:6px !important
  }

  /* KPI Cards - Ultra compact */
  .kpi-card{
    padding:8px 6px;
    border-radius:8px;
    text-align:center
  }
  .kpi-card h4{
    font-size:8px;
    margin-bottom:2px;
    text-transform:uppercase;
    letter-spacing:0.3px;
    line-height:1.2
  }
  .kpi-card p{
    font-size:16px;
    font-weight:700;
    margin:2px 0;
    line-height:1.1
  }
  .kpi-card small{
    font-size:8px;
    display:block;
    margin-top:2px
  }

  /* Input grids - 3-4 columns */
  .row{grid-template-columns:repeat(4,1fr) !important;gap:8px}
  .tool-grid{grid-template-columns:repeat(3,1fr)}
  .card-grid{grid-template-columns:repeat(3,1fr)}
  .stats-row{grid-template-columns:repeat(4,1fr)}

  /* Input groups - Compact */
  .input-group{margin:6px 0}
  .input-group label{font-size:11px;margin-bottom:4px}
  .input-group input,.input-group select{
    padding:8px 10px;
    font-size:14px;
    min-height:36px;
    border-radius:6px
  }

  /* Tables - Compact */
  .table{font-size:10px}
  .table th,.table td{padding:5px 4px}
  .rowh{min-width:80px;font-size:9px}

  /* Buttons - Compact row */
  .btn{padding:8px 12px;font-size:12px;min-height:36px;border-radius:8px}
  .btns{flex-direction:row;flex-wrap:wrap;gap:6px}
  .btns .btn{flex:0 0 auto}

  /* Charts - Short for landscape */
  .chart-container{height:150px;padding:8px}
  canvas{max-height:130px !important}

  /* Notes - Compact */
  .note{padding:8px 10px;font-size:11px;border-radius:6px}
  .note.info,.note.warning{padding:8px 10px;font-size:11px}

  /* AI Recommendations - Compact */
  .ai-recommendations{font-size:11px}
  .ai-recommendations h4{font-size:12px;margin-bottom:6px}

  /* Hide bottom nav in landscape - use tab bar */
  .mobile-bottom-nav{display:none !important}

  /* FAB Menu - Smaller */
  #fabMenu{bottom:8px;right:8px}
  #fabMenu button{width:36px;height:36px;font-size:14px}

  /* Floating widgets */
  #floatingUnitConverter{bottom:8px;right:50px;max-width:280px}
  .cost-floating-widget{bottom:8px;left:8px;max-width:280px}

  /* PWA Status - Minimal */
  .pwa-status{
    bottom:8px;
    left:8px;
    padding:4px 8px;
    font-size:9px;
    border-radius:12px
  }
  .pwa-status .status-dot{width:6px;height:6px}

  /* Modals - Landscape optimized */
  .modal{padding:8px}
  .modal-content{
    width:95%;
    max-width:none;
    max-height:90vh;
    border-radius:10px
  }
  .modal-header{padding:10px 14px}
  .modal-body{padding:10px 14px}

  /* Quick Reference Modal */
  .qref-content{
    max-width:98%;
    max-height:95vh;
    margin:5px auto
  }
  .qref-header{padding:10px 14px}
  .qref-header h2{font-size:16px}
  .qref-tabs{padding:6px 10px;gap:4px}
  .qref-tab{padding:6px 10px;font-size:10px}
  .qref-body{padding:10px}
  .qref-table{font-size:10px}
  .qref-table th,.qref-table td{padding:5px 4px}

  /* Results - Compact */
  .result{font-size:14px;padding:4px 8px}
  .status{font-size:10px;padding:3px 6px}

  /* Panel - No extra bottom padding */
  .panel{padding-bottom:10px}

  /* Two-column layout for main content when possible */
  .split-view{grid-template-columns:1fr 1fr !important;gap:10px}
}

/* ===== LANDSCAPE DARK MODE ===== */
@media(max-width:1024px) and (orientation:landscape){
  html.dark .header{
    background:linear-gradient(90deg, #023e8a 0%, #0077b6 100%);
    box-shadow:0 1px 8px rgba(0,0,0,0.3)
  }
  html.dark .tabs{
    background:linear-gradient(180deg, #0c1929 0%, #1a2744 100%);
    border-bottom:1px solid #334155
  }
  html.dark .kpi-card{
    background:linear-gradient(135deg, #1a2744 0%, #243b55 100%);
    border:1px solid #334155
  }
}

/* ===== SMALL LANDSCAPE (phones) ===== */
@media(max-height:500px) and (orientation:landscape){
  .header{padding:4px 12px}
  .header h1{font-size:14px}
  .header-controls .toggle{width:28px;height:28px;font-size:12px}

  .tabs{padding:3px 8px;top:36px}
  .tab{padding:4px 8px;font-size:9px}

  .content{padding:6px 10px}
  .section{margin-bottom:8px}
  .section-h{padding:6px 10px;font-size:11px}
  .section-content{padding:8px}

  .kpi-grid{gap:4px !important}
  .kpi-card{padding:6px 4px}
  .kpi-card h4{font-size:7px}
  .kpi-card p{font-size:14px}

  .chart-container{height:120px}
  canvas{max-height:100px !important}

  .input-group input,.input-group select{
    padding:6px 8px;
    min-height:32px;
    font-size:13px
  }
}

/* ===== SCROLLING OPTIMIZATION ===== */
.is-scrolling .section{
  will-change:transform;
}

.is-scrolling .chart-container canvas{
  will-change:auto;
}

/* ===== TOUCH DEVICE OPTIMIZATIONS ===== */
.is-touch .btn{
  cursor:pointer;
  -webkit-tap-highlight-color:transparent;
}

.is-touch .tab{
  -webkit-tap-highlight-color:transparent;
}

.is-touch input,.is-touch select,.is-touch textarea{
  -webkit-tap-highlight-color:transparent;
}

/* Larger hit areas for touch */
.is-touch .section-h{
  min-height:48px;
}

.is-touch .checklist-item{
  min-height:52px;
}

/* Active states for touch */
.is-touch .btn:active{
  transform:scale(0.97);
  opacity:0.9;
}

.is-touch .tab:active{
  transform:scale(0.98);
}

.is-touch .kpi-card:active{
  transform:scale(0.98);
}

/* ===== iOS SAFE AREA SUPPORT ===== */
@supports(padding: max(0px)){
  .header{
    padding-top:max(12px, env(safe-area-inset-top));
    padding-left:max(16px, env(safe-area-inset-left));
    padding-right:max(16px, env(safe-area-inset-right));
  }

  .mobile-bottom-nav{
    padding-bottom:max(12px, env(safe-area-inset-bottom));
    padding-left:max(16px, env(safe-area-inset-left));
    padding-right:max(16px, env(safe-area-inset-right));
  }

  .panel{
    padding-bottom:max(80px, calc(60px + env(safe-area-inset-bottom)));
  }

  .modal-content{
    padding-bottom:max(20px, env(safe-area-inset-bottom));
  }
}

/* ===== HIGH DPI / RETINA DISPLAYS ===== */
@media(-webkit-min-device-pixel-ratio:2),(min-resolution:192dpi){
  .section{
    border-width:0.5px;
  }

  .table th,.table td{
    border-bottom-width:0.5px;
  }

  input,select,textarea{
    border-width:1px;
  }
}

/* ===== HOVER ONLY FOR NON-TOUCH ===== */
@media(hover:hover) and (pointer:fine){
  .btn:hover{
    transform:translateY(-2px);
    box-shadow:0 6px 20px rgba(0,0,0,0.15);
  }

  .tab:hover{
    background:var(--bg-note);
    transform:translateY(-2px);
  }

  .section:hover{
    box-shadow:0 8px 24px rgba(0,0,0,0.12);
  }

  .kpi-card:hover{
    transform:translateY(-4px);
    box-shadow:0 12px 30px rgba(0,0,0,0.15);
  }
}

/* ===== REDUCED MOTION PREFERENCE ===== */
@media(prefers-reduced-motion:reduce){
  *{
    animation:none !important;
    transition:none !important;
  }

  .is-touch .btn:active,
  .is-touch .tab:active,
  .is-touch .kpi-card:active{
    transform:none;
  }
}
  .content{padding:24px}

  /* Grids */
  .row{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}
  .kpi-grid{grid-template-columns:repeat(4,1fr)}
  .tool-grid{grid-template-columns:repeat(3,1fr)}

  /* Tables */
  .table{font-size:14px}
  .table th,.table td{padding:14px}

  /* Hide mobile elements */
  .mobile-menu-toggle{display:none !important}
  .mobile-only{display:none !important}
}

/* ===== LARGE DESKTOP (> 1440px) ===== */
@media(min-width:1441px){
  .wrap{max-width:1900px}
  .kpi-grid{grid-template-columns:repeat(5,1fr)}
  .tool-grid{grid-template-columns:repeat(4,1fr)}
  .row{grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
}

/* ===== TOUCH DEVICE IMPROVEMENTS ===== */
@media(hover:none) and (pointer:coarse){
  /* Larger touch targets */
  .btn{min-height:48px}
  .tab{min-height:44px}
  .input-group input,.input-group select{min-height:48px}
  .checklist-item{min-height:52px}

  /* Remove hover effects that don't work on touch */
  .btn:hover{transform:none}
  .tab:hover{transform:none;background:transparent}
  .table tbody tr:hover{transform:none}
  .section:hover{transform:none}

  /* Add active states instead */
  .btn:active{transform:scale(0.98);opacity:0.9}
  .tab:active{background:var(--bg-note)}
}

/* ===== PRINT STYLES ===== */
/* ===== ENHANCED PRINT STYLES v9.5.0 ===== */
@media print{
  /* Force light mode for printing */
  :root, html, html.dark {
    --bg-body: white !important;
    --bg-container: white !important;
    --bg-section: white !important;
    --bg-section-header: #f8fafc !important;
    --bg-tabs: white !important;
    --bg-tab-active: white !important;
    --bg-table-th: #f1f5f9 !important;
    --bg-col-header: #e2e8f0 !important;
    --bg-row-header: #f8fafc !important;
    --bg-input: white !important;
    --bg-result: #e0f2fe !important;
    --bg-note: #f0f9ff !important;
    --bg-card: white !important;
    --text: #1e293b !important;
    --text-header: #0f172a !important;
    --text-accent: #0077b6 !important;
    --text-unit: #475569 !important;
    --text-section: #1e3a5f !important;
    --border: #cbd5e1 !important;
    --border-input: #94a3b8 !important;
  }

  body {
    background: white !important;
    padding: 0 !important;
    color: #1e293b !important;
    font-size: 11px !important;
  }

  .wrap {
    box-shadow: none !important;
    border-radius: 0 !important;
    background: white !important;
  }

  .header {
    background: #0077b6 !important;
    color: white !important;
    padding: 15px 20px !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  /* Hide non-essential elements */
  .tabs, .header-controls, .btns, .mobile-menu-toggle,
  .mobile-nav, #fabMenu, .pwa-status, .pwa-install-btn,
  .pwa-update-banner, #floatingUnitConverter, .toast,
  .qref-modal, .install-modal, #aiChatWidget, .cost-floating-widget,
  #timeTrackerWidget, .portal-banner {
    display: none !important;
  }

  /* Show all panels for comprehensive print */
  .panel {
    display: block !important;
    visibility: visible !important;
    page-break-inside: avoid !important;
    margin-bottom: 20px !important;
  }

  .section {
    break-inside: avoid !important;
    page-break-inside: avoid !important;
    border: 1px solid #cbd5e1 !important;
    margin-bottom: 15px !important;
    background: white !important;
  }

  .section-h {
    background: #f1f5f9 !important;
    color: #1e3a5f !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  .table {
    font-size: 9px !important;
    width: 100% !important;
  }

  .table th {
    background: #f1f5f9 !important;
    color: #1e3a5f !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  .result {
    background: #e0f2fe !important;
    color: #0077b6 !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  .note {
    background: #f0f9ff !important;
    border-left-color: #0077b6 !important;
    color: #1e3a5f !important;
  }

  /* Status colors for print */
  .ok { background: #d1fae5 !important; color: #065f46 !important; }
  .warn { background: #fef3c7 !important; color: #92400e !important; }
  .bad { background: #fee2e2 !important; color: #991b1b !important; }

  /* Chart containers - show placeholder */
  .chart-container {
    border: 1px dashed #cbd5e1 !important;
    background: #f8fafc !important;
    height: auto !important;
    min-height: 100px !important;
  }

  /* Page breaks */
  h1, h2, h3, .section-h {
    page-break-after: avoid !important;
  }

  /* Print header/footer */
  @page {
    margin: 0.5in;
    @top-center { content: "WWTP Command Center Report"; }
    @bottom-center { content: "Page " counter(page) " of " counter(pages); }
  }
}

/* ===== DARK MODE MOBILE ADJUSTMENTS ===== */
@media(max-width:767px){
  html.dark .tabs{background:#111827;border-bottom:1px solid #374151}
  html.dark .tab{color:#9CA3AF}
  html.dark .tab.active{color:#4ade80;background:#1F2937}
  html.dark .section{background:#1F2937}
  html.dark .input-group input,html.dark .input-group select{background:#374151;border-color:#4B5563}
}

/* ===== ENHANCED THEME TRANSITIONS v9.5.0 ===== */
html {
  transition: background 0.3s ease;
}

body, .wrap, .header, .tabs, .tab, .section, .section-h, .section-content,
input, select, textarea, .btn, .note, .result, .table, .table th, .table td,
.kpi-card, .chart-container, .modal-content, .qref-content, .qref-modal,
.toast, .status-bar, .row, .input-group, .input-group label {
  transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
}

/* Light Mode Enhancements */
html:not(.dark) {
  --shadow-soft: 0 2px 8px rgba(0, 119, 182, 0.08);
  --shadow-card: 0 4px 12px rgba(0, 119, 182, 0.1);
}

html:not(.dark) .section {
  box-shadow: var(--shadow-soft);
}

html:not(.dark) .section:hover {
  box-shadow: var(--shadow-card);
}

html:not(.dark) .kpi-card {
  background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
  border-color: #bae6fd;
}

html:not(.dark) .section-h {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  color: #023e8a;
}

html:not(.dark) .tab.active {
  background: white;
  color: #0077b6;
  border-bottom: 3px solid #0077b6;
  box-shadow: 0 -2px 8px rgba(0, 119, 182, 0.1);
}

html:not(.dark) .result {
  background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
  color: #023e8a;
}

html:not(.dark) .note {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-left-color: #0077b6;
  color: #1e3a5f !important;
}

html:not(.dark) .note.info {
  background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
  border-left-color: #00b4d8;
  color: #0c4a6e !important;
}

html:not(.dark) .note.warning {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border-left-color: #f59e0b;
  color: #78350f !important;
}

html:not(.dark) .note.success {
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  border-left-color: #10b981;
  color: #064e3b !important;
}

/* LIGHT MODE - Comprehensive text color fixes */
html:not(.dark) .section-content {
  color: #1e3a5f !important;
}

html:not(.dark) .section-content p,
html:not(.dark) .section-content span,
html:not(.dark) .section-content div,
html:not(.dark) .section-content strong,
html:not(.dark) .section-content label {
  color: #1e3a5f;
}

html:not(.dark) .kpi-card {
  background: white;
  color: #1e3a5f;
}

html:not(.dark) .kpi-card h4 {
  color: #64748b;
}

html:not(.dark) .kpi-card p {
  color: #0077b6;
}

html:not(.dark) .table td,
html:not(.dark) .table th {
  color: #1e3a5f;
}

html:not(.dark) #aiRecommendations .note strong {
  color: inherit;
}

html:not(.dark) input, html:not(.dark) select, html:not(.dark) textarea {
  background: white;
  border-color: #bae6fd;
}

html:not(.dark) input:focus, html:not(.dark) select:focus {
  border-color: #0077b6;
  box-shadow: 0 0 0 3px rgba(0, 119, 182, 0.15);
}

/* Dark Mode Enhancements */
html.dark {
  --shadow-soft: 0 2px 8px rgba(0, 0, 0, 0.3);
  --shadow-card: 0 4px 16px rgba(0, 0, 0, 0.4);
}

html.dark body {
  background: linear-gradient(135deg, #0c1929 0%, #1a2744 100%);
}

html.dark .section {
  background: linear-gradient(135deg, #1a2744 0%, #243b55 100%);
  border-color: #334155;
  box-shadow: var(--shadow-soft);
}

html.dark .section:hover {
  box-shadow: var(--shadow-card);
  border-color: #475569;
}

html.dark .section-h {
  background: linear-gradient(135deg, #243b55 0%, #1a2744 100%);
  color: #90e0ef;
}

html.dark .kpi-card {
  background: linear-gradient(135deg, #243b55 0%, #1a2744 100%);
  border-color: #475569;
}

html.dark .kpi-card:hover {
  border-color: #48cae4;
  box-shadow: 0 0 20px rgba(72, 202, 228, 0.2);
}

html.dark .tab.active {
  background: linear-gradient(135deg, #1a2744 0%, #243b55 100%);
  color: #48cae4;
  border-bottom: 3px solid #48cae4;
}

html.dark .result {
  background: linear-gradient(135deg, #023e8a 0%, #0077b6 100%);
  color: #e0f2fe;
}

html.dark .note {
  background: linear-gradient(135deg, #1a2744 0%, #023e8a 100%);
  border-left-color: #48cae4;
  color: #e0f2fe;
}

html.dark .note.info {
  background: linear-gradient(135deg, #023e8a 0%, #0077b6 100%);
  border-left-color: #00b4d8;
}

html.dark .note.warning {
  background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
  border-left-color: #fbbf24;
  color: #fef3c7;
}

html.dark .note.success {
  background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
  border-left-color: #34d399;
  color: #d1fae5;
}

html.dark input, html.dark select, html.dark textarea {
  background: #1a2744;
  border-color: #475569;
  color: #e0f2fe;
}

html.dark input:focus, html.dark select:focus {
  border-color: #48cae4;
  box-shadow: 0 0 0 3px rgba(72, 202, 228, 0.2);
}

html.dark input::placeholder {
  color: #64748b;
}

html.dark .table th {
  background: linear-gradient(135deg, #0c1929 0%, #1a2744 100%);
  color: #90e0ef;
}

html.dark .table tbody tr:hover {
  background: rgba(72, 202, 228, 0.1);
}

html.dark .btn {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

html.dark .btn:hover {
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
}

/* Modal Consistency */
html.dark .qref-content,
html.dark .install-modal-content,
html.dark .modal-content {
  background: linear-gradient(135deg, #1a2744 0%, #243b55 100%);
  border: 1px solid #475569;
}

html.dark .qref-header {
  background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
}

html.dark .qref-tab {
  background: #1a2744;
  color: #94a3b8;
}

html.dark .qref-tab:hover {
  background: #243b55;
}

html.dark .qref-tab.active {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

html.dark .qref-table th {
  background: #0c1929;
  color: #90e0ef;
}

html.dark .qref-table tr:hover {
  background: rgba(72, 202, 228, 0.1);
}

html.dark .qref-trouble {
  background: #1a2744;
  border: 1px solid #334155;
}

/* Cost Calculator Widget Dark Mode */
html.dark .cost-floating-widget {
  background: linear-gradient(135deg, #1a2744 0%, #243b55 100%) !important;
  border-color: #475569 !important;
}

/* Time Tracker Widget Dark Mode */
html.dark #timeTrackerWidget {
  background: linear-gradient(135deg, #1a2744 0%, #243b55 100%) !important;
  border-color: #475569 !important;
}

/* Toast Notifications Consistency */
html.dark .toast {
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
}

/* Status Colors - Both Modes */
.ok, .status-ok {
  color: #059669 !important;
  background: rgba(16, 185, 129, 0.15) !important;
}
.warn, .status-warn {
  color: #d97706 !important;
  background: rgba(245, 158, 11, 0.15) !important;
}
.bad, .status-bad {
  color: #dc2626 !important;
  background: rgba(239, 68, 68, 0.15) !important;
}

html.dark .ok, html.dark .status-ok {
  color: #34d399 !important;
  background: rgba(52, 211, 153, 0.2) !important;
}
html.dark .warn, html.dark .status-warn {
  color: #fbbf24 !important;
  background: rgba(251, 191, 36, 0.2) !important;
}
html.dark .bad, html.dark .status-bad {
  color: #f87171 !important;
  background: rgba(248, 113, 113, 0.2) !important;
}

/* Floating Action Buttons Dark Mode */
html.dark #fabMenu button {
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
}

/* Header Theme Button Enhancement */
.toggle#themeBtn {
  background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
  border: none !important;
}

html.dark .toggle#themeBtn {
  background: linear-gradient(135deg, #3b82f6, #1d4ed8) !important;
}

.toggle#themeBtn:hover {
  transform: rotate(360deg) scale(1.1) !important;
}

/* ===== ACCESSIBILITY ===== */
@media(prefers-reduced-motion:reduce){
  *{animation:none !important;transition:none !important}
}

/* High contrast mode support */
@media(prefers-contrast:high){
  .btn{border:2px solid currentColor}
  .input-group input,.input-group select{border-width:2px}
  .section{border:2px solid var(--border)}
}

/* ========== ENHANCED CALCULATOR STYLES ========== */

/* Result Cards */
.calc-result-card {
  background: linear-gradient(135deg, #1e3a5f, #243b55);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  border: 2px solid transparent;
  transition: all 0.3s;
}
.calc-result-card.optimal {
  border-color: #10b981;
  box-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
}
.calc-result-card.warning {
  border-color: #f59e0b;
  box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
}
.calc-result-card.critical {
  border-color: #ef4444;
  box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
}
.calc-result-card .value {
  font-size: 32px;
  font-weight: bold;
  color: white;
  margin: 8px 0;
}
.calc-result-card .label {
  font-size: 14px;
  color: #94a3b8;
  margin-bottom: 4px;
}
.calc-result-card .unit {
  font-size: 13px;
  color: #64748b;
}
.calc-result-card .status-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
  margin-top: 8px;
}
.calc-result-card .status-badge.optimal { background: #10b981; color: white; }
.calc-result-card .status-badge.warning { background: #f59e0b; color: #1e3a5f; }
.calc-result-card .status-badge.critical { background: #ef4444; color: white; }

/* Gauge Chart */
.gauge-container {
  position: relative;
  width: 150px;
  height: 90px;
  margin: 0 auto;
}
.gauge-bg {
  fill: none;
  stroke: #1e3a5f;
  stroke-width: 12;
}
.gauge-fill {
  fill: none;
  stroke-width: 12;
  stroke-linecap: round;
  transition: stroke-dashoffset 0.5s ease;
}
.gauge-value {
  font-size: 24px;
  font-weight: bold;
  fill: white;
  text-anchor: middle;
}
.gauge-label {
  font-size: 11px;
  fill: #94a3b8;
  text-anchor: middle;
}

/* Input Validation */
.input-group input.valid {
  border-color: #10b981 !important;
  box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);
}
.input-group input.invalid {
  border-color: #ef4444 !important;
  box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
}
.input-group input.warning-range {
  border-color: #f59e0b !important;
  box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
}

/* Trend Arrows */
.trend-up { color: #ef4444; }
.trend-down { color: #10b981; }
.trend-stable { color: #64748b; }
.trend-arrow { font-size: 18px; margin-right: 4px; }

/* Unit Toggle */
.unit-toggle {
  display: inline-flex;
  background: #1e3a5f;
  border-radius: 8px;
  padding: 4px;
  gap: 4px;
}
.unit-toggle button {
  padding: 6px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: bold;
  background: transparent;
  color: #94a3b8;
  transition: all 0.2s;
}
.unit-toggle button.active {
  background: #3b82f6;
  color: white;
}

/* Formula Display */
.formula-box {
  background: #0c1929;
  border: 1px solid #3b82f6;
  border-radius: 8px;
  padding: 12px 16px;
  font-family: 'Courier New', monospace;
  font-size: 14px;
  color: #60a5fa;
  margin-top: 12px;
  display: none;
}
.formula-box.visible {
  display: block;
}

/* Calculator History */
.calc-history-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: rgba(255,255,255,0.05);
  border-radius: 8px;
  margin-bottom: 8px;
}
.calc-history-item .timestamp {
  font-size: 12px;
  color: #64748b;
}
.calc-history-item .values {
  font-size: 14px;
  color: white;
}

/* Compare Mode */
.compare-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}
.compare-column {
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  padding: 16px;
}
.compare-column h4 {
  margin: 0 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

/* Auto-calculate indicator */
.auto-calc-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  background: #10b981;
  color: white;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: bold;
}
.auto-calc-badge::before {
  content: '‚ö°';
}

</style>

<meta name="description" content="WWTP Command Center APEX - The absolute theoretical maximum with AI, Voice, Digital Twin">
<meta name="keywords" content="WWTP,wastewater,AI,voice,digital-twin,apex">
<meta name="version" content="6.0 ABSOLUTE APEX">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<link rel="manifest" href="/wwtp-app/manifest.json" id="pwa-manifest">
<meta name="theme-color" content="#023e8a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WWTP APEX">
<link rel="apple-touch-icon" href="data:image/svg+xml,&lt;svg xmlns=&#39;http://www.w3.org/2000/svg&#39; viewBox=&#39;0 0 100 100&#39;&gt;&lt;text y=&#39;75&#39; font-size=&#39;75&#39;&gt;%F0%9F%91%91&lt;/text&gt;&lt;/svg&gt;">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,user-scalable=yes">
<style>
/* APEX EDITION - REVOLUTIONARY STYLES */
/* AI Copilot Interface */
.ai-copilot{position:fixed;bottom:80px;right:30px;width:400px;max-height:600px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);z-index:9999;display:none;flex-direction:column;overflow:hidden;animation:slideInUp .3s}
.ai-copilot.active{display:flex}
.ai-header{background:rgba(0,0,0,0.2);padding:20px;display:flex;justify-content:space-between;align-items:center;color:white}
.ai-avatar{width:50px;height:50px;border-radius:50%;background:white;display:flex;align-items:center;justify-content:center;font-size:20px;animation:pulse 2s infinite}
.ai-chat{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:15px;background:white}
.ai-message{padding:12px 16px;border-radius:12px;max-width:85%;animation:fadeIn .3s}
.ai-message.bot{background:linear-gradient(135deg,#667eea,#764ba2);color:white;align-self:flex-start;margin-right:auto}
.ai-message.user{background:#e9ecef;color:#333;align-self:flex-end;margin-left:auto}
.ai-input-area{padding:15px;background:rgba(0,0,0,0.05);display:flex;gap:10px}
.ai-input{flex:1;padding:12px;border:none;border-radius:10px;font-size:14px;outline:none}
.ai-send-btn{padding:12px 20px;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;border-radius:10px;cursor:pointer;font-weight:700;transition:all .3s}
.ai-send-btn:hover{transform:scale(1.05);box-shadow:0 5px 15px rgba(102,126,234,0.4)}
/* Digital Twin Visualization */
.digital-twin{background:linear-gradient(135deg,#1e3c72,#2a5298);color:white;border-radius:15px;padding:30px;margin:20px 0}
.twin-container{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin:20px 0}
.twin-component{background:rgba(255,255,255,0.1);border-radius:12px;padding:20px;backdrop-filter:blur(10px);transition:all .3s;cursor:pointer}
.twin-component:hover{background:rgba(255,255,255,0.2);transform:scale(1.05)}
.twin-status{display:flex;align-items:center;justify-content:space-between;margin-top:15px}
.twin-indicator{width:12px;height:12px;border-radius:50%;animation:pulse 2s infinite}
.twin-indicator.optimal{background:#4ade80}
.twin-indicator.warning{background:#fbbf24}
.twin-indicator.critical{background:#ef4444}
/* Machine Learning Panel */
.ml-panel{background:linear-gradient(135deg,#2c3e50,#3498db);color:white;border-radius:15px;padding:30px}
.ml-insight{background:rgba(255,255,255,0.15);border-left:4px solid #3498db;padding:15px 20px;margin:15px 0;border-radius:8px;backdrop-filter:blur(10px)}
.ml-confidence{display:inline-block;background:rgba(255,255,255,0.2);padding:4px 12px;border-radius:15px;font-size:12px;font-weight:700;margin-left:10px}
.learning-indicator{position:relative;height:8px;background:rgba(255,255,255,0.2);border-radius:4px;margin-top:10px;overflow:hidden}
.learning-progress{position:absolute;top:0;left:0;height:100%;background:linear-gradient(90deg,#3498db,#2ecc71);border-radius:4px;animation:slideInLeft 2s}
/* Blockchain Audit Trail */
.blockchain-panel{background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);color:white;border-radius:15px;padding:30px}
.block-chain{display:flex;flex-direction:column;gap:15px}
.block{background:rgba(255,255,255,0.1);border-radius:10px;padding:20px;border-left:4px solid #00d4ff;backdrop-filter:blur(10px);position:relative}
.block::after{content:'üîó';position:absolute;left:50%;bottom:-20px;font-size:20px;transform:translateX(-50%)}
.block:last-child::after{display:none}
.block-hash{font-family:monospace;font-size:11px;opacity:0.7;margin-top:10px}
.verified-badge{background:#00d4ff;color:#000;padding:4px 10px;border-radius:15px;font-size:11px;font-weight:700;display:inline-block}
/* IoT Sensor Dashboard */
.iot-dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0}
.sensor-card{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:15px;padding:25px;box-shadow:0 10px 30px rgba(0,0,0,0.2);position:relative;overflow:hidden}
.sensor-card::before{content:'';position:absolute;top:0;right:0;width:100px;height:100px;background:radial-gradient(circle,rgba(255,255,255,0.2),transparent);border-radius:50%}
.sensor-value{font-size:42px;font-weight:900;margin:15px 0}
.sensor-trend{display:flex;align-items:center;gap:10px;font-size:14px;margin-top:10px}
.live-indicator{width:10px;height:10px;background:#4ade80;border-radius:50%;animation:pulse 1s infinite;box-shadow:0 0 10px #4ade80}
/* Natural Language Query */
.nl-query-panel{background:linear-gradient(135deg,#8e44ad,#c0392b);color:white;border-radius:15px;padding:30px;margin:20px 0}
.nl-input-wrapper{display:flex;gap:15px;margin-top:20px}
.nl-input{flex:1;padding:15px 20px;border:none;border-radius:30px;font-size:16px;outline:none}
.nl-submit{padding:15px 30px;background:white;color:#8e44ad;border:none;border-radius:30px;font-weight:700;cursor:pointer;transition:all .3s}
.nl-submit:hover{transform:scale(1.05);box-shadow:0 5px 20px rgba(255,255,255,0.3)}
.nl-examples{display:flex;flex-wrap:wrap;gap:10px;margin-top:15px}
.nl-example{background:rgba(255,255,255,0.2);padding:8px 16px;border-radius:20px;font-size:13px;cursor:pointer;transition:all .3s}
.nl-example:hover{background:rgba(255,255,255,0.3)}
/* Advanced 3D Visualization */
.viz-3d-container{background:#000;border-radius:15px;padding:40px;margin:20px 0;min-height:400px;position:relative;overflow:hidden}
.viz-3d-placeholder{color:white;text-align:center;padding:100px 20px}
.viz-controls{position:absolute;top:20px;right:20px;display:flex;gap:10px}
.viz-control-btn{background:rgba(255,255,255,0.2);color:white;border:none;padding:10px 15px;border-radius:8px;cursor:pointer;backdrop-filter:blur(10px)}
/* Quantum Analytics Ready */
.quantum-panel{background:linear-gradient(135deg,#000428,#004e92);color:white;border-radius:15px;padding:30px;position:relative;overflow:hidden}
.quantum-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-top:20px}
.quantum-bit{width:100%;aspect-ratio:1;background:linear-gradient(135deg,#00d4ff,#0066ff);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:900;animation:float 3s ease-in-out infinite;cursor:pointer}
.quantum-bit:hover{animation:none;transform:scale(1.1) rotate(180deg)}
/* Advanced Animations */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideInLeft{from{width:0}to{width:var(--progress,80%)}}
@keyframes float{0%,100%{transform:translateY(0) rotate(0)}25%{transform:translateY(-5px) rotate(5deg)}75%{transform:translateY(-5px) rotate(-5deg)}}

/* SUPREME EDITION ENHANCEMENTS */
/* Mobile-First Responsive Design */
@media(max-width:480px){
.quick-actions{grid-template-columns:repeat(2,1fr);gap:8px}
.quick-action-btn{padding:8px 12px;font-size:12px}
.quick-action-btn span{font-size:16px}
.summary-cards{grid-template-columns:1fr}
.analytics-grid{grid-template-columns:1fr}
.comparison-panel{grid-template-columns:1fr}
.modal-content{padding:15px;max-width:95%}
}
@media(max-width:768px)and(min-width:481px){
.quick-actions{grid-template-columns:repeat(3,1fr)}
.summary-cards{grid-template-columns:repeat(2,1fr)}
}
/* Real-Time Status Indicators - HIDDEN (redundant) */
.realtime-badge{display:none !important}
.realtime-badge.syncing{background:var(--info)}
.realtime-badge.offline{background:var(--bad)}
.realtime-badge.online{background:var(--ok)}
/* Advanced Dashboard */
.dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin:20px 0}
.dashboard-widget{background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:var(--shadow-md);position:relative;cursor:move;transition:all .3s}
.dashboard-widget:hover{transform:translateY(-5px);box-shadow:var(--shadow-xl)}
.widget-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
.widget-title{font-size:16px;font-weight:700;color:var(--text-accent)}
.widget-actions{display:flex;gap:8px}
.widget-action-btn{background:none;border:none;color:var(--text-unit);cursor:pointer;font-size:18px;padding:4px;transition:all .3s}
.widget-action-btn:hover{color:var(--text-accent);transform:scale(1.2)}
.widget-body{min-height:100px}
/* Automation Rules */
.rule-card{background:var(--bg-section);border-left:4px solid var(--text-accent);padding:15px;margin:10px 0;border-radius:8px;transition:all .3s}
.rule-card:hover{background:var(--bg-tabs);transform:translateX(5px)}
.rule-status{display:inline-block;padding:4px 12px;border-radius:12px;font-size:11px;font-weight:700;text-transform:uppercase}
.rule-status.active{background:var(--ok);color:white}
.rule-status.inactive{background:var(--text-unit);color:white}
.rule-status.triggered{background:var(--warn);color:white;animation:pulse 1s infinite}
/* Smart Alerts */
.alert-panel{position:fixed;top:80px;right:20px;max-width:350px;z-index:9999}
.alert-item{background:var(--bg-container);border-radius:10px;padding:15px;margin-bottom:10px;box-shadow:var(--shadow-xl);border-left:4px solid var(--info);animation:slideInRight .3s}
.alert-item.critical{border-left-color:var(--bad)}
.alert-item.warning{border-left-color:var(--warn)}
.alert-item.info{border-left-color:var(--info)}
.alert-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.alert-title{font-weight:700;font-size:14px}
.alert-time{font-size:11px;color:var(--text-unit)}
.alert-body{font-size:13px;line-height:1.4}
.alert-actions{margin-top:10px;display:flex;gap:8px}
.alert-btn{padding:6px 12px;border:none;border-radius:6px;font-size:12px;cursor:pointer;transition:all .3s}
.alert-btn.primary{background:var(--text-accent);color:white}
.alert-btn.secondary{background:var(--bg-section);color:var(--text)}
/* Performance Monitor */
.performance-panel{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;padding:20px;margin:20px 0}
.perf-metric{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,0.1);border-radius:8px;margin:8px 0}
.perf-label{font-size:14px;opacity:0.9}
.perf-value{font-size:18px;font-weight:700}
.perf-indicator{width:60px;height:60px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:20px}
/* Advanced Export Options */
.export-format-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin:20px 0}
.format-card{background:var(--bg-card);border:2px solid var(--border);border-radius:10px;padding:15px;text-align:center;cursor:pointer;transition:all .3s}
.format-card:hover{border-color:var(--text-accent);transform:scale(1.05)}
.format-icon{font-size:32px;margin-bottom:8px}
.format-name{font-weight:600;font-size:14px}
.format-desc{font-size:11px;color:var(--text-unit);margin-top:4px}
/* API Integration */
.integration-card{background:var(--bg-card);border-radius:10px;padding:20px;margin:15px 0;border:1px solid var(--border)}
.integration-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
.integration-icon{width:50px;height:50px;border-radius:10px;background:var(--text-accent);display:flex;align-items:center;justify-content:center;font-size:18px;color:white}
.integration-info{flex:1}
.integration-name{font-size:16px;font-weight:700;margin-bottom:4px}
.integration-status{font-size:12px;color:var(--text-unit)}
.integration-actions{display:flex;gap:10px}
/* Mobile Optimization */
.mobile-only{display:none}
@media(max-width:768px){
.mobile-only{display:block}
.desktop-only{display:none}
.tab-content{padding:10px}
}
/* Offline Indicator */
.offline-banner{position:fixed;top:0;left:0;right:0;background:var(--warn);color:white;padding:10px;text-align:center;font-weight:700;z-index:10000;display:none}
.offline-banner.show{display:block}
/* Loading States */
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9998;display:none;align-items:center;justify-content:center}
.loading-overlay.active{display:flex}
.loading-spinner{width:60px;height:60px;border:4px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
@keyframes slideInRight{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}

/* ENTERPRISE MAX ADDITIONAL STYLES */
.visualization-panel{background:var(--bg-card);border-radius:12px;padding:25px;margin:20px 0;box-shadow:var(--shadow-lg)}
.chart-wrapper{position:relative;height:350px;margin:20px 0}
.chart-controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
.chart-type-btn{padding:8px 16px;border:2px solid var(--border);background:var(--bg-section);border-radius:8px;cursor:pointer;transition:all .3s;font-weight:600}
.chart-type-btn:hover{border-color:var(--text-accent);transform:translateY(-2px)}
.chart-type-btn.active{background:var(--text-accent);color:white;border-color:var(--text-accent)}
.theme-selector{position:fixed;top:20px;right:20px;z-index:1000;background:var(--bg-card);padding:15px;border-radius:12px;box-shadow:var(--shadow-xl);display:none}
.theme-selector.active{display:block}
.theme-option{padding:12px 20px;margin:8px 0;border-radius:8px;cursor:pointer;transition:all .3s;border:2px solid transparent}
.theme-option:hover{border-color:var(--text-accent);transform:scale(1.05)}
.theme-preview{display:flex;gap:8px;margin-top:8px}
.theme-color{width:30px;height:30px;border-radius:50%;border:2px solid white;box-shadow:var(--shadow-md)}
.report-builder{background:var(--bg-card);border-radius:12px;padding:25px;margin:20px 0}
.report-section{border:2px dashed var(--border);border-radius:8px;padding:20px;margin:10px 0;cursor:move;transition:all .3s}
.report-section:hover{border-color:var(--text-accent);background:var(--bg-section)}
.report-section.dragging{opacity:0.5}
.widget-gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0}
.widget-card{background:var(--bg-section);border:2px solid var(--border);border-radius:10px;padding:15px;text-align:center;cursor:pointer;transition:all .3s}
.widget-card:hover{border-color:var(--text-accent);transform:scale(1.05);box-shadow:var(--shadow-lg)}
.widget-icon{font-size:36px;margin-bottom:10px}
.widget-name{font-size:14px;font-weight:600}
.predictive-panel{background:linear-gradient(135deg,#667eea,#764ba2);color:white;border-radius:12px;padding:25px;margin:20px 0}
.prediction-card{background:rgba(255,255,255,0.15);backdrop-filter:blur(10px);border-radius:10px;padding:20px;margin:15px 0}
.prediction-value{font-size:32px;font-weight:700;margin:10px 0}
.prediction-trend{display:flex;align-items:center;gap:10px;font-size:18px;margin-top:10px}
.trend-up{color:#4ade80}
.trend-down{color:#f87171}
.trend-stable{color:#fbbf24}
.analytics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin:20px 0}
.analytics-card{background:var(--bg-card);border-radius:12px;padding:20px;box-shadow:var(--shadow-md)}
.mini-chart{height:100px;margin-top:15px}
.theme-dark{--bg-container:#1a1a2e;--bg-card:#16213e;--bg-section:#0f3460;--bg-tabs:#0a2647;--bg-input:#16213e;--text:#e8e8e8;--text-accent:#64ffda;--text-unit:#a0aec0;--border:#2d3748;--purple:#bb86fc;--teal:#03dac6;--ok:#4ade80;--warn:#fbbf24;--bad:#f87171;--info:#60a5fa}
.theme-ocean{--bg-container:#001845;--bg-card:#023e7d;--bg-section:#0466c8;--bg-tabs:#0353a4;--bg-input:#002855;--text:#f0f4f8;--text-accent:#4cc9f0;--text-unit:#90caf9;--border:#1565c0;--purple:#7b2cbf;--teal:#06ffa5;--ok:#43a047;--warn:#ffa726;--bad:#e53935;--info:#42a5f5}
.theme-forest{--bg-container:#1b4332;--bg-card:#2d6a4f;--bg-section:#40916c;--bg-tabs:#386641;--bg-input:#1b4332;--text:#f1faee;--text-accent:#95d5b2;--text-unit:#b7e4c7;--border:#52b788;--purple:#9d4edd;--teal:#06ffa5;--ok:#52b788;--warn:#f77f00;--bad:#d62828;--info:#4ea8de}
.theme-sunset{--bg-container:#370617;--bg-card:#6a040f;--bg-section:#9d0208;--bg-tabs:#560319;--bg-input:#370617;--text:#fefae0;--text-accent:#ffba08;--text-unit:#faa307;--border:#9d0208;--purple:#d00000;--teal:#06ffa5;--ok:#52b788;--warn:#fb8500;--bad:#dc2f02;--info:#4ea8de}
.install-prompt{position:fixed;bottom:20px;right:20px;background:var(--text-accent);color:white;padding:20px;border-radius:12px;box-shadow:var(--shadow-xl);z-index:10000;max-width:300px;animation:slideInRight .5s}
.install-btn{background:white;color:var(--text-accent);padding:12px 24px;border:none;border-radius:8px;font-weight:700;cursor:pointer;margin-top:15px;width:100%;transition:all .3s}
.install-btn:hover{transform:scale(1.05);box-shadow:var(--shadow-lg)}
.collaboration-panel{background:var(--bg-card);border-radius:12px;padding:25px;margin:20px 0;border-left:4px solid var(--text-accent)}
.user-avatar{width:40px;height:40px;border-radius:50%;background:var(--text-accent);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;margin-right:10px}
.activity-feed{max-height:400px;overflow-y:auto}
.activity-item{display:flex;align-items:center;padding:12px;border-radius:8px;margin:8px 0;background:var(--bg-section);transition:all .3s}
.activity-item:hover{transform:translateX(5px);background:var(--bg-tabs)}
.activity-time{font-size:12px;color:var(--text-unit);margin-left:auto}

/* ==================== v9.5.0 ENHANCEMENTS ==================== */

/* Client Portal Mode */
.portal-mode {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg-body);
  z-index: 10000;
  overflow-y: auto;
}
.portal-header {
  background: linear-gradient(135deg, #2563eb, #7c3aed);
  padding: 30px;
  color: white;
  text-align: center;
}
.portal-logo {
  font-size: 48px;
  margin-bottom: 10px;
}
.portal-card {
  background: var(--bg-card);
  border-radius: 16px;
  padding: 24px;
  margin: 20px;
  box-shadow: var(--shadow-lg);
}
.portal-stat {
  background: linear-gradient(135deg, var(--bg-section), var(--bg-card));
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  border: 2px solid var(--border);
}
.portal-stat-value {
  font-size: 32px;
  font-weight: 800;
  color: var(--text-accent);
}
.portal-stat-label {
  font-size: 12px;
  color: var(--text-unit);
  text-transform: uppercase;
}

/* Time Tracking */
.time-tracker {
  background: linear-gradient(135deg, #0f172a, #1e293b);
  border-radius: 16px;
  padding: 24px;
  margin: 20px 0;
}
.time-display {
  font-size: 48px;
  font-weight: 800;
  font-family: 'Courier New', monospace;
  text-align: center;
  color: #4ade80;
  text-shadow: 0 0 20px rgba(74, 222, 128, 0.5);
  margin: 20px 0;
}
.time-entry {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: rgba(255,255,255,0.05);
  border-radius: 10px;
  margin: 10px 0;
  border-left: 4px solid var(--text-accent);
}
.time-entry:hover {
  background: rgba(255,255,255,0.1);
  transform: translateX(5px);
}
.time-entry-hours {
  font-size: 24px;
  font-weight: 700;
  color: var(--ok);
  min-width: 80px;
}
.timer-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  flex-wrap: wrap;
}
.timer-btn {
  padding: 15px 30px;
  border-radius: 50px;
  border: none;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s;
}
.timer-btn.start {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
}
.timer-btn.stop {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}
.timer-btn.pause {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
}
.timer-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
}

/* AI Enhancement Panel */
.ai-enhance-panel {
  background: linear-gradient(135deg, #1e1b4b, #312e81);
  border-radius: 16px;
  padding: 24px;
  position: relative;
  overflow: hidden;
}
.ai-enhance-panel::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(139,92,246,0.3) 0%, transparent 70%);
  animation: aiGlow 3s ease-in-out infinite;
}
@keyframes aiGlow {
  0%, 100% { opacity: 0.5; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.2); }
}
.ai-suggestion {
  background: rgba(255,255,255,0.1);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 20px;
  margin: 15px 0;
  border-left: 4px solid #8b5cf6;
  position: relative;
  z-index: 1;
}
.ai-suggestion-title {
  color: #c4b5fd;
  font-weight: 700;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.ai-confidence {
  display: inline-block;
  background: linear-gradient(135deg, #22c55e, #16a34a);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  color: white;
}
.ai-action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-top: 20px;
}
.ai-action-btn {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  border: none;
  padding: 15px 20px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
  text-align: center;
}
.ai-action-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
}

/* Enhanced Proposal Generator */
.proposal-preview {
  background: white;
  color: #1a1a1a;
  padding: 40px;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.2);
  max-width: 800px;
  margin: 20px auto;
}
.proposal-header-logo {
  border-bottom: 3px solid #0077b6;
  padding-bottom: 20px;
  margin-bottom: 20px;
}
.proposal-section-title {
  background: linear-gradient(135deg, #0077b6, #00b4d8);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  margin: 20px 0 15px;
}
.proposal-table {
  width: 100%;
  border-collapse: collapse;
  margin: 15px 0;
}
.proposal-table th {
  background: #f8fafc;
  padding: 12px;
  text-align: left;
  border-bottom: 2px solid #e2e8f0;
}
.proposal-table td {
  padding: 12px;
  border-bottom: 1px solid #e2e8f0;
}
.proposal-total-row {
  background: linear-gradient(135deg, #059669, #06d6a0);
  color: white;
  font-weight: 700;
}

/* Offline Mode Enhancements */
.offline-indicator {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: linear-gradient(135deg, #dc2626, #ef4444);
  color: white;
  padding: 10px 20px;
  text-align: center;
  font-weight: 600;
  z-index: 9999;
  display: none;
}
.offline-indicator.visible {
  display: block;
  animation: slideDown 0.3s ease;
}
.sync-status {
  position: fixed;
  bottom: 80px;
  left: 20px;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 12px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  box-shadow: var(--shadow-lg);
  z-index: 1000;
}
.sync-icon {
  width: 20px;
  height: 20px;
  border: 3px solid var(--text-accent);
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
.sync-icon.synced {
  border: none;
  animation: none;
  color: var(--ok);
}
</style>
<style>
.checklist-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background: #0c1929;
  border-radius: 6px;
  margin-bottom: 8px;
  cursor: pointer;
  color: #e0f2fe;
  transition: all 0.2s;
}
.checklist-item:hover {
  background: #1e3a5f;
}
.checklist-item input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}
.checklist-item input[type="checkbox"]:checked + span,
.checklist-item:has(input:checked) {
  text-decoration: line-through;
  color: #06d6a0;
}
.wizard-card:hover, .formula-card:hover {
  border-color: #4ade80 !important;
  transform: translateY(-2px);
}
</style>

</head>
<body class="theme-dark">

<div class="wrap">

<div class="sticky-header">
<header class="header">
<div style="display:flex;align-items:center;gap:12px;flex:1">
  <span style="font-size:20px">üè≠</span>
  <div>
    <h1 style="margin:0;font-size:20px;font-weight:700;display:flex;align-items:center;gap:8px">
      WWTP Command Center
      <span id="appVersion" style="background:#667eea;padding:3px 8px;border-radius:10px;font-size:10px;font-weight:600">v9.6.0</span>
    </h1>
  </div>
</div>
<div class="header-controls">
<button class="toggle" id="geniusBtn" title="WWTP Genius AI" onclick="toggleGeniusPanel()" style="background:linear-gradient(135deg,#8b5cf6,#6366f1);color:white">üß†</button>
<button class="toggle" id="quickRefBtn" title="Quick Reference" onclick="openQuickRef()" style="background:linear-gradient(135deg,#7c3aed,#9333ea);color:white">üìö</button>
<button class="toggle" id="unitToggleBtn" title="Toggle Units" onclick="toggleUnits()">üá∫üá∏</button>
<button class="toggle" id="clearCacheBtn" title="Reset App" onclick="clearCacheReload()">üîÑ</button>
<button class="toggle" id="portalBtn" title="Client Portal" onclick="toggleClientPortal()">üëÅÔ∏è</button>
<button class="toggle" id="timerBtn" title="Time Tracker" onclick="toggleTimeTracker()">‚è±Ô∏è</button>
<button class="toggle" id="themeBtn" title="Dark/Light Mode" onclick="toggleThemeWithMemory()">‚òæ</button>
</div>
</header>
<nav class="tabs" role="tablist">
<button aria-selected="true" class="tab active" data-panel="dashboard" role="tab" onclick="switchPanel('dashboard')">üìä Dashboard</button>
<button class="tab" data-panel="daily-ops" role="tab" onclick="switchPanel('daily-ops')">üë∑ Daily Operations</button>
<button class="tab" data-panel="process-control" role="tab" onclick="switchPanel('process-control')">‚öôÔ∏è Process Control</button>
<button class="tab" data-panel="reactors" role="tab" onclick="switchPanel('reactors')">üîÑ Reactors<span class="badge pro">SBR/MBR/MBBR</span></button>
<button class="tab" data-panel="hydraulics" role="tab" onclick="switchPanel('hydraulics')">üìê Hydraulics</button>
<button class="tab" data-panel="aeration" role="tab" onclick="switchPanel('aeration')">üí® Aeration & Energy</button>
<button class="tab" data-panel="chemicals" role="tab" onclick="switchPanel('chemicals')">‚öóÔ∏è Chemical Systems</button>
<button class="tab" data-panel="solids" role="tab" onclick="switchPanel('solids')">üóëÔ∏è Solids Handling</button>
<button class="tab" data-panel="compliance" role="tab" onclick="switchPanel('compliance')">üìã Compliance<span class="badge pro">TCEQ</span></button>
<button class="tab" data-panel="wizards" role="tab" onclick="switchPanel('wizards')">üß≠ Wizards<span class="badge ai">AI</span></button>
<button class="tab" data-panel="maintenance" role="tab" onclick="switchPanel('maintenance')">üîß Maintenance</button>
<button class="tab" data-panel="reports" role="tab" onclick="switchPanel('reports')">üìë Reports</button>
<button class="tab" data-panel="profiles" role="tab" onclick="switchPanel('profiles')">üè≠ Profiles</button>
<button class="tab" data-panel="business" role="tab" onclick="switchPanel('business')">üíº Business<span class="badge new">BIZ</span></button>
<button class="tab" data-panel="multiplant" role="tab" onclick="switchPanel('multiplant')">üè≠ Multi-Plant</button>
</nav>
</div>
<div class="content">

<div class="panel active" id="dashboard">

<div class="kpi-grid">
<div class="kpi-card">
<h4>Flow Rate</h4>
<p id="kpi-flow">3.50</p>
<div class="small">MGD</div>
<div class="trend up">‚Üë 2.3%</div>
</div>
<div class="kpi-card">
<h4>DO Level</h4>
<p id="kpi-do">2.1</p>
<div class="small">mg/L</div>
<div class="trend stable">‚Üí Stable</div>
</div>
<div class="kpi-card">
<h4>MLSS</h4>
<p id="kpi-mlss">2500</p>
<div class="small">mg/L</div>
<div class="trend up">‚Üë Target</div>
</div>
<div class="kpi-card">
<h4>F/M Ratio</h4>
<p id="kpi-fm">0.35</p>
<div class="small">lb/lb/d</div>
<div class="trend up">‚úì Optimal</div>
</div>
<div class="kpi-card">
<h4>Energy Use</h4>
<p id="kpi-energy">1850</p>
<div class="small">kWh/MG</div>
<div class="trend up">‚Üì 5.2%</div>
</div>
<div class="kpi-card">
<h4>Daily Cost</h4>
<p id="kpi-cost">$4,250</p>
<div class="small">$/day</div>
<div class="trend down">‚Üë 1.8%</div>
</div>
</div>
<div class="section">
<div class="section-h">ü§ñ AI-Powered Recommendations</div>
<div class="section-content">
<div id="aiRecommendations">
<div class="note success">
<strong>‚úì Optimal Operating Conditions</strong><br>
System is running within optimal parameters. F/M ratio (0.35) and MCRT (8.2 days) are well-balanced for efficient BOD removal and nitrification.
</div>
<div class="note warning">
<strong>‚ö† Energy Optimization Opportunity</strong><br>
Consider reducing aeration by 8% during low-load periods (2AM-6AM). Potential savings: $450/month based on current energy rates.
</div>
<div class="note info">
<strong>üí° Predictive Maintenance Alert</strong><br>
Blower #2 bearing temperature trending upward. Schedule inspection within 14 days to prevent unplanned downtime.
</div>
</div>
</div>
</div>

<div class="section" id="alertSystemSection">
<div class="section-h" style="background:linear-gradient(135deg,#dc2626,#ef4444);color:white">
‚ö†Ô∏è Alarm & Alert System
<div class="section-actions">
<button class="icon-btn" onclick="toggleAlertSettings()" style="background:rgba(255,255,255,0.2);color:white">‚öôÔ∏è Settings</button>
<button class="icon-btn" onclick="viewAlertHistory()" style="background:rgba(255,255,255,0.2);color:white">üìú History</button>
</div>
</div>
<div class="section-content">

<div id="activeAlerts" style="margin-bottom:15px">
<div class="note success" id="noAlertsMsg">
<strong>‚úì All Systems Normal</strong><br>
No active alerts. All parameters within limits.
</div>
</div>

<div id="alertSettings" style="display:none;background:#1e3a5f;padding:20px;border-radius:12px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#f87171">‚öôÔ∏è Alert Thresholds</h4>
<div class="row" style="gap:12px">
<div class="input-group">
<label style="color:#fca5a5">Effluent BOD Max (mg/L)</label>
<input type="number" id="alert_bod_max" value="30" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#fca5a5">Effluent TSS Max (mg/L)</label>
<input type="number" id="alert_tss_max" value="30" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#fca5a5">Effluent NH‚ÇÉ Max (mg/L)</label>
<input type="number" id="alert_nh3_max" value="5" onchange="saveAlertSettings()">
</div>
</div>
<div class="row" style="gap:12px;margin-top:10px">
<div class="input-group">
<label style="color:#fbbf24">MLSS Min (mg/L)</label>
<input type="number" id="alert_mlss_min" value="1500" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#fbbf24">MLSS Max (mg/L)</label>
<input type="number" id="alert_mlss_max" value="4500" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#fbbf24">DO Min (mg/L)</label>
<input type="number" id="alert_do_min" value="1.0" step="0.1" onchange="saveAlertSettings()">
</div>
</div>
<div class="row" style="gap:12px;margin-top:10px">
<div class="input-group">
<label style="color:#4ade80">SVI Max</label>
<input type="number" id="alert_svi_max" value="150" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#4ade80">Flow Max (MGD)</label>
<input type="number" id="alert_flow_max" value="10" step="0.1" onchange="saveAlertSettings()">
</div>
<div class="input-group">
<label style="color:#60a5fa">pH Range</label>
<div style="display:flex;gap:5px">
<input type="number" id="alert_ph_min" value="6.0" step="0.1" style="width:50%" onchange="saveAlertSettings()">
<input type="number" id="alert_ph_max" value="9.0" step="0.1" style="width:50%" onchange="saveAlertSettings()">
</div>
</div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn green" onclick="saveAlertSettings()">üíæ Save Settings</button>
<button class="btn" onclick="loadDefaultAlerts()">üîÑ Reset Defaults</button>
<button class="btn red" onclick="testAlert()">üîî Test Alert</button>
</div>
</div>

<div id="alertHistory" style="display:none;background:#1e3a5f;padding:20px;border-radius:12px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">üìú Alert History (Last 7 Days)</h4>
<div id="alertHistoryList" style="max-height:200px;overflow-y:auto">
<div style="padding:10px;border-bottom:1px solid #374151;display:flex;justify-content:space-between">
<span><span style="color:#4ade80">‚óè</span> System started - All clear</span>
<span style="opacity:0.7;font-size:12px">Just now</span>
</div>
</div>
<div class="btns" style="margin-top:10px">
<button class="btn gray" onclick="clearAlertHistory()">üóëÔ∏è Clear History</button>
<button class="btn blue" onclick="exportAlertHistory()">üì§ Export</button>
</div>
</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:15px">
<div class="alert-indicator" id="ind_bod" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">BOD</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
<div class="alert-indicator" id="ind_tss" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">TSS</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
<div class="alert-indicator" id="ind_nh3" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">NH‚ÇÉ</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
<div class="alert-indicator" id="ind_do" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">DO</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
<div class="alert-indicator" id="ind_mlss" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">MLSS</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
<div class="alert-indicator" id="ind_ph" style="background:#1e3a5f;padding:12px;border-radius:8px;text-align:center;border-left:4px solid #4ade80">
<div style="font-size:11px;opacity:0.7">pH</div>
<div style="font-size:18px;font-weight:bold;color:#4ade80">‚úì OK</div>
</div>
</div>

</div>
</div>
<div class="section">
<div class="section-h">
üéØ Quick Actions
<div class="section-actions">
<button class="icon-btn" onclick="refreshDashboard()">üîÑ Refresh</button>
</div>
</div>
<div class="section-content">
<div class="btns">
<button class="btn gradient" onclick="calcAll()">üîÑ Calculate All</button>
<button class="btn green" onclick="runOptimization()">üöÄ Run Optimization</button>
<button class="btn purple" onclick="openAIAssistant()">ü§ñ Ask AI Assistant</button>
<button class="btn orange" onclick="predictTrends()">üîÆ Predict Trends</button>
<button class="btn blue" onclick="importCSVData()">üì• Import CSV</button>
<button class="btn teal" onclick="showCalcChains()">üîó Calc Chains</button>
<button class="btn" onclick="saveProfile()">üíæ Save Profile</button>
<button class="btn gray" onclick="loadProfile()">üìÇ Load Profile</button>
<button class="btn green" onclick="exportToExcel()">üìä Export Excel</button>
<button class="btn purple" onclick="exportFullReport()">üìë Full Report</button>
</div>
</div>
</div>
<div class="split-view">
<div class="section">
<div class="section-h">ü©∫ System Health Score</div>
<div class="section-content">
<div style="display:flex;gap:40px;align-items:center;justify-content:center;flex-wrap:wrap">
<div class="gauge good" id="healthGauge">
<div>
<div style="font-size:0.35em">HEALTH</div>
95
<div style="font-size:0.28em">/100</div>
</div>
</div>
<div style="flex:1;min-width:300px">
<h4 style="margin-bottom:16px">Performance Metrics</h4>
<div style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>BOD Removal</span><strong style="color:var(--ok)">95%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:95%"></div>
</div>
</div>
<div style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>TSS Removal</span><strong style="color:var(--ok)">93%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:93%"></div>
</div>
</div>
<div style="margin-bottom:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>Energy Efficiency</span><strong style="color:var(--ok)">92%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:92%"></div>
</div>
</div>
<div>
<div style="display:flex;justify-content:space-between;margin-bottom:4px">
<span>Compliance Score</span><strong style="color:var(--ok)">98%</strong>
</div>
<div class="progress-bar">
<div class="progress-fill" style="width:98%"></div>
</div>
</div>
</div>
</div>
</div>

<div class="note info">
<strong>‚ÑπÔ∏è Predictive Maintenance Alert</strong><br>
Blower #2 vibration trending upward. Schedule inspection within 14 days to prevent unplanned downtime.
</div>
</div>
</div>
</div>

<div class="panel" id="reactors">
<div id="REACTORS_HEADER_MARKER" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üîÑ REACTORS</h2>
</div>
<div style="background:linear-gradient(135deg,#023e8a 0%,#023e8a 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üîÑ Advanced Reactor Systems</h2>
<p style="margin:0;opacity:0.9">SBR, MBR, and MBBR calculators and troubleshooting guides</p>
</div>

<div class="section" style="border:3px solid #0ea5e9;box-shadow:0 0 15px rgba(14,165,233,0.3)">
<div class="section-h" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:white">
‚öôÔ∏è Reactor Master Settings
<div class="section-actions">
<button class="icon-btn" onclick="syncReactorMaster()" style="background:rgba(255,255,255,0.2);color:white">üîÑ Sync All</button>
<button class="icon-btn" onclick="saveReactorSettings()" style="background:rgba(255,255,255,0.2);color:white">üíæ Save</button>
</div>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Set master parameters for each reactor type. Values auto-sync to all related calculators.</p>

<div style="display:flex;gap:5px;margin-bottom:20px;border-bottom:2px solid #374151;padding-bottom:10px">
<button class="btn gradient" id="rmTab_sbr" onclick="showReactorMasterTab('sbr')" style="flex:1">üîÑ SBR</button>
<button class="btn gray" id="rmTab_mbr" onclick="showReactorMasterTab('mbr')" style="flex:1">üî¨ MBR</button>
<button class="btn gray" id="rmTab_mbbr" onclick="showReactorMasterTab('mbbr')" style="flex:1">üß´ MBBR</button>
</div>

<div id="reactorMaster_sbr" style="display:block">
<h4 style="margin:0 0 15px 0;color:#38bdf8">üîÑ SBR Master Parameters</h4>
<div class="row">
<div class="input-group">
<label style="color:#38bdf8">Design Flow (MGD)</label>
<input type="number" id="rm_sbr_flow" value="2.0" step="0.1" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#38bdf8">Number of Basins</label>
<input type="number" id="rm_sbr_basins" value="2" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#38bdf8">Basin Volume (MG)</label>
<input type="number" id="rm_sbr_vol" value="0.5" step="0.1" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Fill Time (min)</label>
<input type="number" id="rm_sbr_fill" value="60" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>React Time (min)</label>
<input type="number" id="rm_sbr_react" value="120" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Settle Time (min)</label>
<input type="number" id="rm_sbr_settle" value="60" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Decant Time (min)</label>
<input type="number" id="rm_sbr_decant" value="30" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Idle Time (min)</label>
<input type="number" id="rm_sbr_idle" value="30" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="rm_sbr_bod" value="200" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>TKN (mg/L)</label>
<input type="number" id="rm_sbr_tkn" value="40" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Target Eff BOD (mg/L)</label>
<input type="number" id="rm_sbr_eff_bod" value="10" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Target Eff NH‚ÇÉ (mg/L)</label>
<input type="number" id="rm_sbr_eff_nh3" value="1" onchange="syncReactorMaster()">
</div>
</div>
</div>

<div id="reactorMaster_mbr" style="display:none">
<h4 style="margin:0 0 15px 0;color:#a78bfa">üî¨ MBR Master Parameters</h4>
<div class="row">
<div class="input-group">
<label style="color:#a78bfa">Design Flow (MGD)</label>
<input type="number" id="rm_mbr_flow" value="1.5" step="0.1" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#a78bfa">Number of Trains</label>
<input type="number" id="rm_mbr_trains" value="2" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#a78bfa">Membrane Area (ft¬≤)</label>
<input type="number" id="rm_mbr_area" value="50000" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Design Flux (gfd)</label>
<input type="number" id="rm_mbr_flux" value="12" step="0.5" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>TMP Max (psi)</label>
<input type="number" id="rm_mbr_tmp" value="8" step="0.5" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="rm_mbr_mlss" value="10000" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Backwash Freq (min)</label>
<input type="number" id="rm_mbr_bw_freq" value="10" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Backwash Duration (sec)</label>
<input type="number" id="rm_mbr_bw_dur" value="30" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>CIP Interval (days)</label>
<input type="number" id="rm_mbr_cip" value="30" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="rm_mbr_bod" value="200" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Aeration Basin Vol (MG)</label>
<input type="number" id="rm_mbr_vol" value="0.8" step="0.1" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>SRT (days)</label>
<input type="number" id="rm_mbr_srt" value="15" onchange="syncReactorMaster()">
</div>
</div>
</div>

<div id="reactorMaster_mbbr" style="display:none">
<h4 style="margin:0 0 15px 0;color:#4ade80">üß´ MBBR Master Parameters</h4>
<div class="row">
<div class="input-group">
<label style="color:#4ade80">Design Flow (MGD)</label>
<input type="number" id="rm_mbbr_flow" value="2.0" step="0.1" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#4ade80">Reactor Volume (MG)</label>
<input type="number" id="rm_mbbr_vol" value="0.6" step="0.1" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label style="color:#4ade80">Number of Stages</label>
<input type="number" id="rm_mbbr_stages" value="2" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Media Fill (%)</label>
<input type="number" id="rm_mbbr_fill" value="50" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Media SSA (m¬≤/m¬≥)</label>
<input type="number" id="rm_mbbr_ssa" value="500" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Protected Surface (%)</label>
<input type="number" id="rm_mbbr_protected" value="67" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="rm_mbbr_bod" value="200" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>BOD Loading Rate (g/m¬≤/d)</label>
<input type="number" id="rm_mbbr_bod_rate" value="10" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>NH‚ÇÉ Loading Rate (g/m¬≤/d)</label>
<input type="number" id="rm_mbbr_nh3_rate" value="1.5" step="0.1" onchange="syncReactorMaster()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Target DO (mg/L)</label>
<input type="number" id="rm_mbbr_do" value="4.0" step="0.5" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Temperature (¬∞C)</label>
<input type="number" id="rm_mbbr_temp" value="20" onchange="syncReactorMaster()">
</div>
<div class="input-group">
<label>Target Eff BOD (mg/L)</label>
<input type="number" id="rm_mbbr_eff_bod" value="10" onchange="syncReactorMaster()">
</div>
</div>
</div>

<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="syncReactorMaster()">üîÑ Sync to Calculators</button>
<button class="btn green" onclick="saveReactorSettings()">üíæ Save Settings</button>
<button class="btn blue" onclick="loadReactorSettings()">üìÇ Load Saved</button>
</div>
</div>
</div>

<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn gradient active" onclick="showReactorSection('sbr')" id="btn-sbr">üîÑ SBR (Sequencing Batch)</button>
<button class="btn gray" onclick="showReactorSection('mbr')" id="btn-mbr">üî¨ MBR (Membrane)</button>
<button class="btn gray" onclick="showReactorSection('mbbr')" id="btn-mbbr">üß´ MBBR (Moving Bed)</button>
</div>

<div id="reactor-sbr" style="display:block">

<div id="sbr-content" style="display:block">
<h2 style="margin-bottom:20px;color:var(--text-accent)">üîÑ Sequencing Batch Reactor (SBR) Analysis</h2>

<div class="section">
<div class="section-h">‚è±Ô∏è SBR Cycle Time Optimization</div>
<div class="section-content">
<div class="note info">Optimize fill, react, settle, decant, and idle phases</div>
<div class="row">
<div class="input-group"><label>Design Flow (MGD)</label><input type="number" id="sbr_flow" value="2.0" step="0.1"></div>
<div class="input-group"><label>Number of Basins</label><input type="number" id="sbr_basins" value="2"></div>
<div class="input-group"><label>Basin Volume (MG)</label><input type="number" id="sbr_vol" value="0.5" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>Fill Time (min)</label><input type="number" id="sbr_fill" value="60"></div>
<div class="input-group"><label>React Time (min)</label><input type="number" id="sbr_react" value="120"></div>
<div class="input-group"><label>Settle Time (min)</label><input type="number" id="sbr_settle" value="60"></div>
</div>
<div class="row">
<div class="input-group"><label>Decant Time (min)</label><input type="number" id="sbr_decant" value="30"></div>
<div class="input-group"><label>Idle Time (min)</label><input type="number" id="sbr_idle" value="30"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRCycle()">Calculate</button>
<button class="btn" onclick="resetSBRCycle()">Reset</button>
</div>
<div id="sbr_cycle_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üí® SBR Aeration & Oxygen Demand</div>
<div class="section-content">
<div class="note info">Calculate oxygen requirements for BOD and nitrogen removal</div>
<div class="row">
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="sbr_bod_in" value="200"></div>
<div class="input-group"><label>Effluent BOD (mg/L)</label><input type="number" id="sbr_bod_out" value="10"></div>
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="sbr_aer_flow" value="2.0" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>TKN (mg/L)</label><input type="number" id="sbr_tkn" value="40"></div>
<div class="input-group"><label>Effluent NH3 (mg/L)</label><input type="number" id="sbr_nh3_out" value="1"></div>
<div class="input-group"><label>React Time (hrs)</label><input type="number" id="sbr_react_hr" value="2.0" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRAeration()">Calculate</button>
<button class="btn" onclick="resetSBRAeration()">Reset</button>
</div>
<div id="sbr_aeration_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">‚¨áÔ∏è SBR Settling Performance</div>
<div class="section-content">
<div class="note info">Analyze settling characteristics and decant performance</div>
<div class="row">
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="sbr_mlss" value="3500"></div>
<div class="input-group"><label>SVI (mL/g)</label><input type="number" id="sbr_svi" value="120"></div>
<div class="input-group"><label>Basin Depth (ft)</label><input type="number" id="sbr_depth" value="15"></div>
</div>
<div class="row">
<div class="input-group"><label>Settle Time (min)</label><input type="number" id="sbr_settle_t" value="60"></div>
<div class="input-group"><label>Decant Volume (%)</label><input type="number" id="sbr_decant_pct" value="25"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRSettling()">Calculate</button>
<button class="btn" onclick="resetSBRSettling()">Reset</button>
</div>
<div id="sbr_settling_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üìä SBR Loading Parameters</div>
<div class="section-content">
<div class="note info">Calculate F/M ratio, volumetric loading, and MLSS inventory</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="sbr_load_flow" value="2.0" step="0.1"></div>
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="sbr_load_bod" value="200"></div>
<div class="input-group"><label>Basin Volume (MG)</label><input type="number" id="sbr_load_vol" value="0.5" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="sbr_load_mlss" value="3500"></div>
<div class="input-group"><label>MLVSS/MLSS Ratio</label><input type="number" id="sbr_vss_ratio" value="0.8" step="0.05"></div>
<div class="input-group"><label>Number of Basins</label><input type="number" id="sbr_load_basins" value="2"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRLoading()">Calculate</button>
<button class="btn" onclick="resetSBRLoading()">Reset</button>
</div>
<div id="sbr_loading_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üöø SBR Waste Sludge (WAS)</div>
<div class="section-content">
<div class="note info">Calculate waste activated sludge requirements</div>
<div class="row">
<div class="input-group"><label>Target SRT (days)</label><input type="number" id="sbr_srt" value="12"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="sbr_was_mlss" value="3500"></div>
<div class="input-group"><label>Total Basin Vol (MG)</label><input type="number" id="sbr_was_vol" value="1.0" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>Effluent TSS (mg/L)</label><input type="number" id="sbr_eff_tss" value="10"></div>
<div class="input-group"><label>Effluent Flow (MGD)</label><input type="number" id="sbr_eff_flow" value="2.0" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRWAS()">Calculate</button>
<button class="btn" onclick="resetSBRWAS()">Reset</button>
</div>
<div id="sbr_was_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üåø SBR Nutrient Removal (BNR)</div>
<div class="section-content">
<div class="note info">Evaluate nitrogen and phosphorus removal performance</div>
<div class="row">
<div class="input-group"><label>Influent TN (mg/L)</label><input type="number" id="sbr_tn_in" value="40"></div>
<div class="input-group"><label>Effluent TN (mg/L)</label><input type="number" id="sbr_tn_out" value="8"></div>
<div class="input-group"><label>Influent TP (mg/L)</label><input type="number" id="sbr_tp_in" value="6"></div>
</div>
<div class="row">
<div class="input-group"><label>Effluent TP (mg/L)</label><input type="number" id="sbr_tp_out" value="1"></div>
<div class="input-group"><label>Anoxic Time (min)</label><input type="number" id="sbr_anoxic" value="60"></div>
<div class="input-group"><label>Anaerobic Time (min)</label><input type="number" id="sbr_anaerobic" value="30"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRNutrient()">Calculate</button>
<button class="btn" onclick="resetSBRNutrient()">Reset</button>
</div>
<div id="sbr_nutrient_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üîß SBR Troubleshooting Guide</div>
<div class="section-content">
<div class="note info">Diagnose common SBR operational issues and get recommended solutions</div>
<div class="row">
<div class="input-group"><label>Effluent Quality Issue</label>
<select id="sbr_eff_issue">
<option value="none">None - Effluent OK</option>
<option value="high_tss">High TSS/Turbidity</option>
<option value="high_bod">High BOD</option>
<option value="high_nh3">High Ammonia</option>
<option value="high_no3">High Nitrate</option>
<option value="high_phos">High Phosphorus</option>
</select></div>
<div class="input-group"><label>Settling Problem</label>
<select id="sbr_settle_issue">
<option value="none">None - Settling OK</option>
<option value="poor">Poor Settling (High SVI)</option>
<option value="bulking">Filamentous Bulking</option>
<option value="rising">Rising Sludge</option>
<option value="pin_floc">Pin Floc</option>
<option value="foam">Excessive Foam</option>
</select></div>
</div>
<div class="row">
<div class="input-group"><label>Operational Issue</label>
<select id="sbr_op_issue">
<option value="none">None</option>
<option value="short_cycle">Insufficient Treatment Time</option>
<option value="uneven_decant">Uneven Decant</option>
<option value="carryover">Solids Carryover During Decant</option>
<option value="low_do">Low DO During React</option>
<option value="high_do">Excessive DO (Energy Waste)</option>
<option value="odor">Odor Problems</option>
</select></div>
<div class="input-group"><label>Current SVI (mL/g)</label>
<input type="number" id="sbr_diag_svi" value="150" min="50" max="400">
</div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcSBRTroubleshoot()">üîç Diagnose & Recommend</button>
<button class="btn" onclick="resetSBRTroubleshoot()">Reset</button>
</div>
<div id="sbr_troubleshoot_results"></div>
</div>
</div>

</div>

</div>

<div id="reactor-mbr" style="display:none">

<div id="mbr-content">
<h2 style="margin-bottom:20px;color:var(--text-accent)">üî¨ Membrane Bioreactor (MBR) Analysis</h2>

<div class="section">
<div class="section-h">üíß Membrane Flux & Permeability</div>
<div class="section-content">
<div class="note info">Calculate membrane performance and capacity</div>
<div class="row">
<div class="input-group"><label>Permeate Flow (GPM)</label><input type="number" id="mbr_perm_flow" value="500"></div>
<div class="input-group"><label>Membrane Area (sf)</label><input type="number" id="mbr_mem_area" value="50000"></div>
<div class="input-group"><label>TMP (psi)</label><input type="number" id="mbr_tmp" value="5" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>Temperature (¬∞C)</label><input type="number" id="mbr_temp" value="20"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBRFlux()">Calculate</button>
<button class="btn" onclick="resetMBRFlux()">Reset</button>
</div>
<div id="mbr_flux_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üí® MBR Aeration (Process + Scour)</div>
<div class="section-content">
<div class="note info">Calculate process aeration and membrane scour air requirements</div>
<div class="row">
<div class="input-group"><label>BOD Load (lb/day)</label><input type="number" id="mbr_bod_load" value="2000"></div>
<div class="input-group"><label>TKN Load (lb/day)</label><input type="number" id="mbr_tkn_load" value="400"></div>
<div class="input-group"><label>Membrane Area (sf)</label><input type="number" id="mbr_scour_area" value="50000"></div>
</div>
<div class="row">
<div class="input-group"><label>Scour Rate (SCFM/sf)</label><input type="number" id="mbr_scour_rate" value="0.03" step="0.01"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBRAeration()">Calculate</button>
<button class="btn" onclick="resetMBRAeration()">Reset</button>
</div>
<div id="mbr_aeration_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">‚ö° MBR Energy Analysis</div>
<div class="section-content">
<div class="note info">Calculate energy consumption and costs</div>
<div class="row">
<div class="input-group"><label>Permeate Pump HP</label><input type="number" id="mbr_perm_hp" value="25"></div>
<div class="input-group"><label>Blower HP</label><input type="number" id="mbr_blower_hp" value="100"></div>
<div class="input-group"><label>Hours/Day</label><input type="number" id="mbr_run_hrs" value="24"></div>
</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbr_energy_flow" value="1.0" step="0.1"></div>
<div class="input-group"><label>Electric Rate ($/kWh)</label><input type="number" id="mbr_elec_rate" value="0.10" step="0.01"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBREnergy()">Calculate</button>
<button class="btn" onclick="resetMBREnergy()">Reset</button>
</div>
<div id="mbr_energy_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üßπ MBR Cleaning & Recovery</div>
<div class="section-content">
<div class="note info">Track membrane fouling and cleaning effectiveness</div>
<div class="row">
<div class="input-group"><label>Initial Permeability (LMH/bar)</label><input type="number" id="mbr_perm_init" value="300"></div>
<div class="input-group"><label>Current Permeability (LMH/bar)</label><input type="number" id="mbr_perm_curr" value="200"></div>
<div class="input-group"><label>Days Since CIP</label><input type="number" id="mbr_days_cip" value="30"></div>
</div>
<div class="row">
<div class="input-group"><label>Post-CIP Permeability (LMH/bar)</label><input type="number" id="mbr_perm_post" value="280"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBRCleaning()">Calculate</button>
<button class="btn" onclick="resetMBRCleaning()">Reset</button>
</div>
<div id="mbr_cleaning_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üìä MBR Loading & SRT</div>
<div class="section-content">
<div class="note info">Calculate loading rates and solids retention time</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbr_srt_flow" value="1.0" step="0.1"></div>
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="mbr_srt_bod" value="200"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="mbr_srt_mlss" value="8000"></div>
</div>
<div class="row">
<div class="input-group"><label>Reactor Volume (MG)</label><input type="number" id="mbr_srt_vol" value="0.3" step="0.1"></div>
<div class="input-group"><label>WAS Flow (GPD)</label><input type="number" id="mbr_was_flow" value="5000"></div>
<div class="input-group"><label>WAS Conc (mg/L)</label><input type="number" id="mbr_was_conc" value="10000"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBRLoading()">Calculate</button>
<button class="btn" onclick="resetMBRLoading()">Reset</button>
</div>
<div id="mbr_loading_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üîß MBR Troubleshooting Guide</div>
<div class="section-content">
<div class="note info">Diagnose common MBR operational issues</div>
<div class="row">
<div class="input-group"><label>TMP Trend</label>
<select id="mbr_tmp_trend">
<option value="stable">Stable</option>
<option value="gradual">Gradual Increase</option>
<option value="rapid">Rapid Increase</option>
<option value="jump">Sudden Jump</option>
</select></div>
<div class="input-group"><label>Permeability Trend</label>
<select id="mbr_perm_trend">
<option value="stable">Stable</option>
<option value="declining">Declining</option>
<option value="rapid_decline">Rapid Decline</option>
</select></div>
</div>
<div class="row">
<div class="input-group"><label>Foam Present?</label>
<select id="mbr_foam">
<option value="none">None</option>
<option value="light">Light</option>
<option value="heavy">Heavy/Persistent</option>
</select></div>
<div class="input-group"><label>Permeate Quality</label>
<select id="mbr_perm_quality">
<option value="clear">Clear</option>
<option value="slight">Slight Turbidity</option>
<option value="turbid">Turbid</option>
</select></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBRTroubleshoot()">Diagnose</button>
</div>
<div id="mbr_troubleshoot_results"></div>
</div>
</div>
</div>

</div>

<div id="reactor-mbbr" style="display:none">

<div id="mbbr-content">
<h2 style="margin-bottom:20px;color:var(--text-accent)">üß´ Moving Bed Biofilm Reactor (MBBR) Analysis</h2>

<div class="section">
<div class="section-h">üéØ MBBR Media & Surface Area</div>
<div class="section-content">
<div class="note info">Calculate effective biofilm surface area and media requirements</div>
<div class="row">
<div class="input-group"><label>Reactor Volume (MG)</label><input type="number" id="mbbr_vol" value="0.5" step="0.1"></div>
<div class="input-group"><label>Media Fill (%)</label><input type="number" id="mbbr_fill" value="50"></div>
<div class="input-group"><label>Specific Surface Area (m¬≤/m¬≥)</label><input type="number" id="mbbr_ssa" value="500"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRMedia()">Calculate</button>
<button class="btn" onclick="resetMBBRMedia()">Reset</button>
</div>
<div id="mbbr_media_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üî¨ MBBR BOD Removal Design</div>
<div class="section-content">
<div class="note info">Calculate surface area loading rate for BOD removal</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbbr_bod_flow" value="1.0" step="0.1"></div>
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="mbbr_bod_in" value="200"></div>
<div class="input-group"><label>Target Effluent BOD (mg/L)</label><input type="number" id="mbbr_bod_out" value="20"></div>
</div>
<div class="row">
<div class="input-group"><label>Temperature (¬∞C)</label><input type="number" id="mbbr_bod_temp" value="20"></div>
<div class="input-group"><label>SALR (g/m¬≤/d)</label><input type="number" id="mbbr_salr" value="10"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRBOD()">Calculate</button>
<button class="btn" onclick="resetMBBRBOD()">Reset</button>
</div>
<div id="mbbr_bod_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üí® MBBR Aeration Requirements</div>
<div class="section-content">
<div class="note info">Calculate process and mixing air requirements</div>
<div class="row">
<div class="input-group"><label>BOD Load (lb/day)</label><input type="number" id="mbbr_aer_bod" value="1500"></div>
<div class="input-group"><label>NH3 Load (lb/day)</label><input type="number" id="mbbr_aer_nh3" value="200"></div>
<div class="input-group"><label>Media Volume (cf)</label><input type="number" id="mbbr_media_vol" value="10000"></div>
</div>
<div class="row">
<div class="input-group"><label>Mixing Air (SCFM/cf media)</label><input type="number" id="mbbr_mix_rate" value="1.0" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRAeration()">Calculate</button>
<button class="btn" onclick="resetMBBRAeration()">Reset</button>
</div>
<div id="mbbr_aeration_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üåø MBBR Nitrification Design</div>
<div class="section-content">
<div class="note info">Calculate surface area for ammonia removal</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbbr_nit_flow" value="1.0" step="0.1"></div>
<div class="input-group"><label>Influent NH3-N (mg/L)</label><input type="number" id="mbbr_nh3_in" value="30"></div>
<div class="input-group"><label>Effluent NH3-N (mg/L)</label><input type="number" id="mbbr_nh3_out" value="2"></div>
</div>
<div class="row">
<div class="input-group"><label>Temperature (¬∞C)</label><input type="number" id="mbbr_nit_temp" value="15"></div>
<div class="input-group"><label>DO (mg/L)</label><input type="number" id="mbbr_do" value="4"></div>
<div class="input-group"><label>SANR (g N/m¬≤/d)</label><input type="number" id="mbbr_sanr" value="1.2" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRNitrification()">Calculate</button>
<button class="btn" onclick="resetMBBRNitrification()">Reset</button>
</div>
<div id="mbbr_nit_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üåä MBBR Hydraulic Design</div>
<div class="section-content">
<div class="note info">Verify hydraulic parameters and retention screens</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbbr_hyd_flow" value="1.0" step="0.1"></div>
<div class="input-group"><label>Reactor Volume (MG)</label><input type="number" id="mbbr_hyd_vol" value="0.2" step="0.1"></div>
<div class="input-group"><label>Reactor Length (ft)</label><input type="number" id="mbbr_length" value="40"></div>
</div>
<div class="row">
<div class="input-group"><label>Reactor Width (ft)</label><input type="number" id="mbbr_width" value="20"></div>
<div class="input-group"><label>Water Depth (ft)</label><input type="number" id="mbbr_wat_depth" value="15"></div>
<div class="input-group"><label>Screen Area (sf)</label><input type="number" id="mbbr_screen" value="50"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRHydraulic()">Calculate</button>
<button class="btn" onclick="resetMBBRHydraulic()">Reset</button>
</div>
<div id="mbbr_hydraulic_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üìà MBBR Performance Monitoring</div>
<div class="section-content">
<div class="note info">Track and evaluate MBBR performance</div>
<div class="row">
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="mbbr_perf_bod_in" value="150"></div>
<div class="input-group"><label>Effluent BOD (mg/L)</label><input type="number" id="mbbr_perf_bod_out" value="15"></div>
<div class="input-group"><label>Influent NH3 (mg/L)</label><input type="number" id="mbbr_perf_nh3_in" value="25"></div>
</div>
<div class="row">
<div class="input-group"><label>Effluent NH3 (mg/L)</label><input type="number" id="mbbr_perf_nh3_out" value="2"></div>
<div class="input-group"><label>Active Surface Area (m¬≤)</label><input type="number" id="mbbr_perf_sa" value="5000"></div>
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mbbr_perf_flow" value="1.0" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRPerformance()">Calculate</button>
<button class="btn" onclick="resetMBBRPerformance()">Reset</button>
</div>
<div id="mbbr_perf_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üîó IFAS (Integrated Fixed-Film Activated Sludge)</div>
<div class="section-content">
<div class="note info">Calculate combined suspended and attached growth</div>
<div class="row">
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="ifas_mlss" value="3000"></div>
<div class="input-group"><label>Reactor Volume (MG)</label><input type="number" id="ifas_vol" value="0.5" step="0.1"></div>
<div class="input-group"><label>Media Fill (%)</label><input type="number" id="ifas_fill" value="40"></div>
</div>
<div class="row">
<div class="input-group"><label>Biofilm Density (g/m¬≤)</label><input type="number" id="ifas_biofilm" value="10"></div>
<div class="input-group"><label>Media SSA (m¬≤/m¬≥)</label><input type="number" id="ifas_ssa" value="500"></div>
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="ifas_flow" value="2.0" step="0.1"></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcIFAS()">Calculate</button>
<button class="btn" onclick="resetIFAS()">Reset</button>
</div>
<div id="ifas_results"></div>
</div>
</div>

<div class="section">
<div class="section-h">üîß MBBR Troubleshooting Guide</div>
<div class="section-content">
<div class="note info">Diagnose common MBBR/IFAS operational issues and get recommended solutions</div>
<div class="row">
<div class="input-group"><label>Media Issue</label>
<select id="mbbr_media_issue">
<option value="none">None - Media OK</option>
<option value="clogging">Media Clogging</option>
<option value="loss">Media Loss at Screens</option>
<option value="poor_mixing">Poor Media Mixing</option>
<option value="accumulation">Media Accumulation in Corners</option>
<option value="breakage">Media Breakage</option>
</select></div>
<div class="input-group"><label>Performance Issue</label>
<select id="mbbr_perf_issue">
<option value="none">None - Performance OK</option>
<option value="low_bod">Low BOD Removal</option>
<option value="low_nh3">Low Nitrification</option>
<option value="variable">Variable Performance</option>
<option value="declining">Declining Performance Over Time</option>
</select></div>
</div>
<div class="row">
<div class="input-group"><label>Biofilm Issue</label>
<select id="mbbr_biofilm_issue">
<option value="none">None - Biofilm OK</option>
<option value="thin">Thin/Patchy Biofilm</option>
<option value="thick">Excessive Biofilm Thickness</option>
<option value="sloughing">Frequent Sloughing</option>
<option value="dark">Dark/Unhealthy Biofilm</option>
</select></div>
<div class="input-group"><label>Aeration Issue</label>
<select id="mbbr_air_issue">
<option value="none">None - Aeration OK</option>
<option value="uneven">Uneven Air Distribution</option>
<option value="low_do">Low DO Despite Aeration</option>
<option value="fouled_diff">Fouled Diffusers</option>
<option value="channeling">Air Channeling</option>
</select></div>
</div>
<div class="btn-row">
<button class="btn primary" onclick="calcMBBRTroubleshoot()">üîç Diagnose & Recommend</button>
<button class="btn" onclick="resetMBBRTroubleshoot()">Reset</button>
</div>
<div id="mbbr_troubleshoot_results"></div>
</div>
</div>
</div>

</div>
</div>

<div class="panel" id="compliance">
<div id="COMPLIANCE_HEADER_MARKER" style="background:linear-gradient(135deg,#eab308 0%,#facc15 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìã COMPLIANCE & LAB</h2>
</div>
<div style="background:linear-gradient(135deg,#023e8a 0%,#0077b6 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìã TCEQ Compliance & Laboratory Module</h2>
<p style="margin:0;opacity:0.9">Permit Tracking, DMR Preparation, Sample Entry & QA/QC</p>
</div>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#ef4444,#f87171);color:white">üî¨ Laboratory Sample Entry</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sample Date</label><input type="date" id="lab_date"></div>
<div class="input-group"><label>Sample Location</label>
<select id="lab_location">
<option value="inf">Influent</option>
<option value="pe">Primary Effluent</option>
<option value="mlss">MLSS</option>
<option value="ras">RAS</option>
<option value="eff">Final Effluent</option>
</select>
</div>
<div class="input-group"><label>Sampler</label><input type="text" id="lab_sampler" placeholder="Initials"></div>
</div>
<div class="row">
<div class="input-group"><label>BOD (mg/L)</label><input type="number" id="lab_bod" step="1"></div>
<div class="input-group"><label>TSS (mg/L)</label><input type="number" id="lab_tss" step="1"></div>
<div class="input-group"><label>NH3-N (mg/L)</label><input type="number" id="lab_nh3" step="0.1"></div>
<div class="input-group"><label>TP (mg/L)</label><input type="number" id="lab_tp" step="0.1"></div>
<div class="input-group"><label>pH</label><input type="number" id="lab_ph" step="0.1" min="0" max="14"></div>
<div class="input-group"><label>DO (mg/L)</label><input type="number" id="lab_do" step="0.1"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="saveLabResult()">üíæ Save Result</button>
<button class="btn blue" onclick="viewLabHistory()">üìä View History</button>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üèõÔ∏è Permit Information</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Permit Number</label><input type="text" id="tceq_permit_num" placeholder="WQ0012345000"></div>
<div class="input-group"><label>Facility Name</label><input type="text" id="tceq_facility" placeholder="North Regional WWTP"></div>
<div class="input-group"><label>Permitted Flow (MGD)</label><input type="number" id="tceq_permitted_flow" value="5.0" step="0.1"></div>
</div>
<div class="row">
<div class="input-group"><label>Permit Effective Date</label><input type="date" id="tceq_eff_date"></div>
<div class="input-group"><label>Permit Expiration Date</label><input type="date" id="tceq_exp_date"></div>
<div class="input-group"><label>Outfall Number</label><input type="text" id="tceq_outfall" value="001"></div>
</div>
<div class="btns">
<button class="btn green" onclick="savePermitInfo()">üíæ Save Permit Info</button>
<button class="btn blue" onclick="loadPermitInfo()">üìÇ Load Saved</button>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìä Effluent Limits & Monitoring</div>
<div class="section-content">
<div class="note info">Enter your TPDES permit limits. System will track compliance and alert on exceedances.</div>
<table class="table" style="margin-top:15px">
<thead>
<tr style="background:var(--bg-table-th)">
<th>Parameter</th>
<th>Daily Max</th>
<th>Weekly Avg</th>
<th>Monthly Avg</th>
<th>Units</th>
<th>Current Value</th>
<th>Status</th>
</tr>
</thead>
<tbody id="tceq_limits_table">
<tr>
<td><strong>BOD‚ÇÖ</strong></td>
<td><input type="number" id="lim_bod_daily" value="45" style="width:70px"></td>
<td><input type="number" id="lim_bod_weekly" value="30" style="width:70px"></td>
<td><input type="number" id="lim_bod_monthly" value="20" style="width:70px"></td>
<td>mg/L</td>
<td><input type="number" id="cur_bod" value="12" style="width:70px"></td>
<td><span class="status ok" id="stat_bod">‚úì OK</span></td>
</tr>
<tr>
<td><strong>TSS</strong></td>
<td><input type="number" id="lim_tss_daily" value="45" style="width:70px"></td>
<td><input type="number" id="lim_tss_weekly" value="30" style="width:70px"></td>
<td><input type="number" id="lim_tss_monthly" value="20" style="width:70px"></td>
<td>mg/L</td>
<td><input type="number" id="cur_tss" value="15" style="width:70px"></td>
<td><span class="status ok" id="stat_tss">‚úì OK</span></td>
</tr>
<tr>
<td><strong>NH‚ÇÉ-N</strong></td>
<td><input type="number" id="lim_nh3_daily" value="6" style="width:70px"></td>
<td><input type="number" id="lim_nh3_weekly" value="4" style="width:70px"></td>
<td><input type="number" id="lim_nh3_monthly" value="2" style="width:70px"></td>
<td>mg/L</td>
<td><input type="number" id="cur_nh3" value="1.5" style="width:70px" step="0.1"></td>
<td><span class="status ok" id="stat_nh3">‚úì OK</span></td>
</tr>
<tr>
<td><strong>E. coli</strong></td>
<td><input type="number" id="lim_ecoli_daily" value="394" style="width:70px"></td>
<td>-</td>
<td><input type="number" id="lim_ecoli_monthly" value="126" style="width:70px"></td>
<td>MPN/100mL</td>
<td><input type="number" id="cur_ecoli" value="45" style="width:70px"></td>
<td><span class="status ok" id="stat_ecoli">‚úì OK</span></td>
</tr>
<tr>
<td><strong>DO</strong></td>
<td colspan="3"><input type="number" id="lim_do_min" value="4.0" style="width:70px" step="0.1"> mg/L minimum</td>
<td>mg/L</td>
<td><input type="number" id="cur_do" value="6.5" style="width:70px" step="0.1"></td>
<td><span class="status ok" id="stat_do">‚úì OK</span></td>
</tr>
<tr>
<td><strong>pH</strong></td>
<td colspan="3"><input type="number" id="lim_ph_min" value="6.0" style="width:50px" step="0.1"> - <input type="number" id="lim_ph_max" value="9.0" style="width:50px" step="0.1"></td>
<td>S.U.</td>
<td><input type="number" id="cur_ph" value="7.2" style="width:70px" step="0.1"></td>
<td><span class="status ok" id="stat_ph">‚úì OK</span></td>
</tr>
<tr>
<td><strong>Total P</strong></td>
<td><input type="number" id="lim_tp_daily" value="2" style="width:70px" step="0.1"></td>
<td><input type="number" id="lim_tp_weekly" value="1.5" style="width:70px" step="0.1"></td>
<td><input type="number" id="lim_tp_monthly" value="1" style="width:70px" step="0.1"></td>
<td>mg/L</td>
<td><input type="number" id="cur_tp" value="0.8" style="width:70px" step="0.1"></td>
<td><span class="status ok" id="stat_tp">‚úì OK</span></td>
</tr>
</tbody>
</table>
<div class="btns" style="margin-top:15px">
<button class="btn green" onclick="checkCompliance()">‚úÖ Check Compliance</button>
<button class="btn orange" onclick="saveLimits()">üíæ Save Limits</button>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìù DMR (Discharge Monitoring Report) Generator</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Reporting Period</label>
<select id="dmr_period">
<option value="monthly">Monthly</option>
<option value="quarterly">Quarterly</option>
</select></div>
<div class="input-group"><label>Month</label>
<select id="dmr_month">
<option value="1">January</option><option value="2">February</option><option value="3">March</option>
<option value="4">April</option><option value="5">May</option><option value="6">June</option>
<option value="7">July</option><option value="8">August</option><option value="9">September</option>
<option value="10">October</option><option value="11">November</option><option value="12">December</option>
</select></div>
<div class="input-group"><label>Year</label><input type="number" id="dmr_year" value="2025"></div>
</div>
<div id="dmr_data_entry" style="margin-top:15px">
<h4 style="margin-bottom:10px">Daily Monitoring Data Entry</h4>
<div style="max-height:300px;overflow-y:auto;background:#1a2744;padding:15px;border-radius:8px">
<table class="table" id="dmr_daily_table">
<thead>
<tr><th>Date</th><th>Flow (MGD)</th><th>BOD (mg/L)</th><th>TSS (mg/L)</th><th>NH3 (mg/L)</th><th>pH</th><th>DO (mg/L)</th></tr>
</thead>
<tbody id="dmr_daily_body">
</tbody>
</table>
</div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn purple" onclick="generateDMRTable()">üìã Generate Data Table</button>
<button class="btn green" onclick="calculateDMRStats()">üìä Calculate Statistics</button>
<button class="btn blue" onclick="exportDMR()">üì§ Export DMR Data</button>
</div>
<div id="dmr_results" style="margin-top:15px"></div>
</div>
</div>

<div class="section">
<div class="section-h">üìÖ Compliance Calendar & Deadlines</div>
<div class="section-content">
<div class="kpi-grid">
<div class="kpi-card" style="border-left:4px solid #ef4444">
<h4>DMR Due</h4>
<p id="next_dmr_due">Jan 25, 2025</p>
<div class="small">Monthly Report</div>
</div>
<div class="kpi-card" style="border-left:4px solid #ffd166">
<h4>Permit Expires</h4>
<p id="permit_exp_display">Dec 31, 2027</p>
<div class="small">Renewal Required</div>
</div>
<div class="kpi-card" style="border-left:4px solid #06d6a0">
<h4>Days Compliant</h4>
<p id="days_compliant">365</p>
<div class="small">This Year</div>
</div>
<div class="kpi-card" style="border-left:4px solid #0077b6">
<h4>Violations YTD</h4>
<p id="violations_ytd">0</p>
<div class="small">Year to Date</div>
</div>
</div>
<div id="upcoming_deadlines" style="margin-top:20px">
<h4>Upcoming Deadlines</h4>
<div style="background:#1a2744;padding:15px;border-radius:8px;margin-top:10px">
<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #374151">
<span>üìã December DMR Submission</span>
<span style="color:#ffd166">Due: Jan 25, 2025</span>
</div>
<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #374151">
<span>üî¨ Quarterly Biomonitoring (WET Test)</span>
<span style="color:#ffd166">Due: Jan 31, 2025</span>
</div>
<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #374151">
<span>üìä Annual Sludge Report</span>
<span style="color:#0077b6">Due: Feb 19, 2025</span>
</div>
<div style="display:flex;justify-content:space-between;padding:10px 0">
<span>üèõÔ∏è Permit Renewal Application</span>
<span style="color:#0077b6">Due: Jun 30, 2027</span>
</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#ef4444,#f87171);color:white">‚úÖ Laboratory QA/QC Status</div>
<div class="section-content">
<div class="kpi-grid">
<div class="kpi-card"><h4>Duplicates</h4><p style="color:#4ade80">98.5%</p><small>RPD < 20%</small></div>
<div class="kpi-card"><h4>Blanks</h4><p style="color:#4ade80">Pass</p><small>All < MDL</small></div>
<div class="kpi-card"><h4>Standards</h4><p style="color:#4ade80">99.2%</p><small>Recovery</small></div>
<div class="kpi-card"><h4>Hold Times</h4><p style="color:#4ade80">100%</p><small>Compliance</small></div>
</div>
</div>
</div>

</div>
</div>

<div class="panel" id="profiles">
<div id="PROFILES_HEADER_MARKER" style="background:linear-gradient(135deg,#7c3aed 0%,#a855f7 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üè≠ PLANT PROFILES</h2>
</div>

<div class="section" style="background:linear-gradient(135deg,#059669,#06d6a0);border-radius:12px;margin-bottom:20px">
<div class="section-h" style="color:white;font-size:18px;font-weight:bold">
üéõÔ∏è Master Settings - Auto-Populate All Calculators
</div>
<div class="section-content" style="background:rgba(0,0,0,0.2);border-radius:0 0 12px 12px">
<div class="note" style="background:rgba(255,255,255,0.1);border-left-color:#4ade80;color:white;margin-bottom:15px">
Set master values below. When you save a profile, these values are stored. When you load a profile, these auto-populate.
</div>
<div class="row" style="gap:15px">
<div class="input-group">
<label style="color:#a7f3d0">Flow Rate (MGD)</label>
<input id="masterFlow" type="number" step="0.1" value="5.0" onchange="syncMasterSettings()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">Aeration Volume (MG)</label>
<input id="masterAerVol" type="number" step="0.1" value="1.0" onchange="syncMasterSettings()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">BOD (mg/L)</label>
<input id="masterBOD" type="number" step="1" value="200" onchange="syncMasterSettings()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">MLSS (mg/L)</label>
<input id="masterMLSS" type="number" step="100" value="3000" onchange="syncMasterSettings()" style="font-size:16px;font-weight:bold">
</div>
</div>
<div class="btns" style="margin-top:15px;gap:10px">
<button onclick="syncMasterSettings()" class="btn" style="background:#047857;color:white;font-weight:bold">üì° Sync to All Calculators</button>
<button onclick="syncAndCalculateAll()" class="btn" style="background:#fbbf24;color:#1e3a5f;font-weight:bold">‚ö° Sync & Calculate All</button>
</div>
</div>
</div>

<div class="section" style="background:linear-gradient(135deg,#7c3aed,#a855f7);border-radius:12px;margin-bottom:20px">
<div class="section-h" style="color:white;font-size:18px;font-weight:bold">
üìÇ Save & Load Plant Profiles
</div>
<div class="section-content" style="background:rgba(0,0,0,0.2);border-radius:0 0 12px 12px">
<div class="note" style="background:rgba(255,255,255,0.1);border-left-color:#c4b5fd;color:white;margin-bottom:15px">
Save plant configurations for different clients. Load a profile to auto-populate all values instantly.
</div>

<div class="row" style="gap:15px;margin-bottom:15px">
<div class="input-group" style="flex:2">
<label style="color:#e9d5ff">üìÇ Select Profile</label>
<select id="profileSelect" onchange="previewProfile()" style="font-size:16px;font-weight:bold;padding:12px">
<option value="">-- Select a Plant Profile --</option>
</select>
</div>
<div class="input-group" style="flex:1">
<label style="color:#e9d5ff">Actions</label>
<div style="display:flex;gap:8px">
<button onclick="loadSelectedProfile()" class="btn" style="background:#10b981;color:white;flex:1;font-weight:bold">üì• Load</button>
<button onclick="deleteSelectedProfile()" class="btn" style="background:#ef4444;color:white;flex:1">üóëÔ∏è</button>
</div>
</div>
</div>

<div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px;margin-bottom:15px">
<div style="font-weight:bold;margin-bottom:12px;color:#e9d5ff">üíæ Save Current Values as New Profile</div>
<div class="row" style="gap:15px">
<div class="input-group" style="flex:2">
<label style="color:#e9d5ff">Profile Name</label>
<input id="newProfileName" type="text" placeholder="e.g., ABC Corp WWTP, City Plant #2" style="font-size:16px">
</div>
<div class="input-group" style="flex:1">
<label style="color:#e9d5ff">&nbsp;</label>
<button onclick="saveNewProfile()" class="btn" style="background:#fbbf24;color:#1e3a5f;font-weight:bold;width:100%">üíæ Save Profile</button>
</div>
</div>
</div>

<div id="profilePreview" style="display:none;background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;margin-bottom:15px">
<div style="font-weight:bold;margin-bottom:10px;color:#fbbf24">üìã Profile Preview</div>
<div id="profilePreviewContent" style="font-size:14px;line-height:1.8"></div>
</div>

</div>
</div>

<div class="section">
<div class="section-h">‚öôÔ∏è Extended Profile Parameters</div>
<div class="section-content">
<div class="note">Optional details for each plant profile. These are saved with the profile.</div>

<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label>Plant Name</label>
<input id="profilePlantName" type="text" placeholder="Full plant name">
</div>
<div class="input-group">
<label>Client/Owner</label>
<input id="profileClient" type="text" placeholder="Client name">
</div>
<div class="input-group">
<label>Permit #</label>
<input id="profilePermit" type="text" placeholder="TPDES/NPDES #">
</div>
</div>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label>Design Flow (MGD)</label>
<input id="profileDesignFlow" type="number" step="0.1" placeholder="Design capacity">
</div>
<div class="input-group">
<label>Process Type</label>
<select id="profileProcessType">
<option value="conv_as">Conventional AS</option>
<option value="ext_aer">Extended Aeration</option>
<option value="sbr">SBR</option>
<option value="mbr">MBR</option>
<option value="mbbr">MBBR</option>
<option value="oxidation_ditch">Oxidation Ditch</option>
<option value="trickling">Trickling Filter</option>
<option value="lagoon">Lagoon</option>
<option value="other">Other</option>
</select>
</div>
<div class="input-group">
<label># of Clarifiers</label>
<input id="profileClarifiers" type="number" step="1" placeholder="2">
</div>
</div>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label>Clarifier Diameter (ft)</label>
<input id="profileClarifierDia" type="number" step="1" placeholder="60">
</div>
<div class="input-group">
<label>SWD (ft)</label>
<input id="profileSWD" type="number" step="0.5" placeholder="12">
</div>
<div class="input-group">
<label>Target SRT (days)</label>
<input id="profileTargetSRT" type="number" step="1" placeholder="10">
</div>
</div>
<div class="input-group">
<label>Notes</label>
<textarea id="profileNotes" rows="3" placeholder="Additional notes about this plant..." style="width:100%;resize:vertical"></textarea>
</div>

</div>
</div>

<div class="section">
<div class="section-h">üì§ Import & Export Profiles</div>
<div class="section-content">
<div class="note">Backup your profiles or transfer them between devices.</div>
<div class="btns" style="gap:10px;flex-wrap:wrap">
<button onclick="exportProfiles()" class="btn" style="background:#0ea5e9;color:white">üì§ Export All Profiles</button>
<button onclick="importProfiles()" class="btn" style="background:#8b5cf6;color:white">üì• Import Profiles</button>
<button onclick="showProfileCount()" class="btn" style="background:#6b7280;color:white">üìä Profile Stats</button>
</div>
<input type="file" id="profileImportFile" accept=".json" style="display:none" onchange="handleProfileImport(event)">
</div>
</div>

</div>

<div class="panel" id="business">
<div id="BUSINESS_HEADER_MARKER" style="background:linear-gradient(135deg,#ec4899 0%,#f472b6 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üíº BUSINESS</h2>
</div>
<div style="background:linear-gradient(135deg,#0096c7 0%,#48cae4 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üíº Business & Consulting Tools</h2>
<p style="margin:0;opacity:0.9">Client management, proposals, and ROI analysis for your consulting practice</p>
</div>

<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn gradient" onclick="showBusinessSection('clients')" id="btn-clients">üë• Clients & Projects</button>
<button class="btn blue" onclick="showBusinessSection('proposals')" id="btn-proposals">üìù Proposal Generator</button>
<button class="btn green" onclick="showBusinessSection('roi')" id="btn-roi">üíµ ROI Calculator</button>
<button class="btn orange" onclick="showBusinessSection('timetracking')" id="btn-timetracking">‚è±Ô∏è Time Tracking</button>
<button class="btn purple" onclick="showBusinessSection('ai-enhance')" id="btn-ai">ü§ñ AI Enhancement</button>
<button class="btn" onclick="showBusinessSection('costcalc')" id="btn-costcalc" style="background:linear-gradient(135deg,#059669,#10b981);color:white">üí∞ Cost Calculator</button>
<button class="btn" onclick="showBusinessSection('sheets')" id="btn-sheets" style="background:linear-gradient(135deg,#34a853,#4285f4);color:white">üìä Google Sheets Sync</button>
<button class="btn" onclick="showBusinessSection('serviceprop')" id="btn-serviceprop" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white">üìã Service Proposal</button>
</div>

<div id="biz-costcalc" style="display:none">
<h3 style="color:var(--text-accent);margin-bottom:20px">üí∞ Operations Cost Calculator</h3>

<div class="kpi-grid" style="margin-bottom:24px">
<div class="kpi-card" style="border-left:4px solid #10b981">
<h4>Daily Cost</h4>
<p id="cost_daily">$0.00</p>
<small style="color:#10b981">Operating</small>
</div>
<div class="kpi-card" style="border-left:4px solid #3b82f6">
<h4>Monthly Cost</h4>
<p id="cost_monthly">$0.00</p>
<small style="color:#3b82f6">30-day avg</small>
</div>
<div class="kpi-card" style="border-left:4px solid #8b5cf6">
<h4>Annual Cost</h4>
<p id="cost_annual">$0.00</p>
<small style="color:#8b5cf6">Projected</small>
</div>
<div class="kpi-card" style="border-left:4px solid #f59e0b">
<h4>Cost per MG</h4>
<p id="cost_per_mg">$0.00</p>
<small style="color:#f59e0b">$/MG treated</small>
</div>
</div>

<div class="section">
<div class="section-h">üè≠ Plant Information</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Average Daily Flow (MGD)</label><input type="number" id="cost_flow_mgd" value="5.0" step="0.1" onchange="calculateAllCosts()"></div>
<div class="input-group"><label>Operating Days per Year</label><input type="number" id="cost_op_days" value="365" onchange="calculateAllCosts()"></div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üß™ Chemical Costs</div>
<div class="section-content">
<table class="table" id="chemCostTable">
<thead>
<tr><th>Chemical</th><th>Dose (mg/L)</th><th>Unit Cost ($/lb)</th><th>Daily Use (lb)</th><th>Daily Cost</th><th>Monthly Cost</th></tr>
</thead>
<tbody>
<tr>
<td><input type="text" value="Chlorine" style="width:100px" class="chem-name"></td>
<td><input type="number" value="2" step="0.1" class="chem-dose" onchange="calculateAllCosts()"></td>
<td><input type="number" value="0.35" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>
<td class="chem-daily-use">-</td>
<td class="chem-daily-cost">-</td>
<td class="chem-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Polymer" style="width:100px" class="chem-name"></td>
<td><input type="number" value="5" step="0.1" class="chem-dose" onchange="calculateAllCosts()"></td>
<td><input type="number" value="2.50" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>
<td class="chem-daily-use">-</td>
<td class="chem-daily-cost">-</td>
<td class="chem-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Alum" style="width:100px" class="chem-name"></td>
<td><input type="number" value="50" step="1" class="chem-dose" onchange="calculateAllCosts()"></td>
<td><input type="number" value="0.12" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>
<td class="chem-daily-use">-</td>
<td class="chem-daily-cost">-</td>
<td class="chem-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Caustic Soda" style="width:100px" class="chem-name"></td>
<td><input type="number" value="0" step="1" class="chem-dose" onchange="calculateAllCosts()"></td>
<td><input type="number" value="0.25" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>
<td class="chem-daily-use">-</td>
<td class="chem-daily-cost">-</td>
<td class="chem-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Ferric Chloride" style="width:100px" class="chem-name"></td>
<td><input type="number" value="0" step="1" class="chem-dose" onchange="calculateAllCosts()"></td>
<td><input type="number" value="0.18" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>
<td class="chem-daily-use">-</td>
<td class="chem-daily-cost">-</td>
<td class="chem-monthly-cost">-</td>
</tr>
</tbody>
<tfoot>
<tr style="font-weight:bold;background:var(--bg-section-header)">
<td colspan="4">Chemical Subtotal</td>
<td id="chem_daily_total">$0.00</td>
<td id="chem_monthly_total">$0.00</td>
</tr>
</tfoot>
</table>
<button class="btn green" style="margin-top:10px" onclick="addChemicalRow()">‚ûï Add Chemical</button>
</div>
</div>

<div class="section">
<div class="section-h">‚ö° Energy Costs</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Electricity Rate ($/kWh)</label><input type="number" id="cost_kwh_rate" value="0.08" step="0.01" onchange="calculateAllCosts()"></div>
<div class="input-group"><label>Demand Charge ($/kW/mo)</label><input type="number" id="cost_demand_rate" value="10.00" step="0.5" onchange="calculateAllCosts()"></div>
</div>
<table class="table" id="energyCostTable">
<thead>
<tr><th>Equipment</th><th>HP/kW</th><th>Qty</th><th>Hours/Day</th><th>Daily kWh</th><th>Daily Cost</th><th>Monthly Cost</th></tr>
</thead>
<tbody>
<tr>
<td><input type="text" value="Blowers" style="width:100px" class="equip-name"></td>
<td><input type="number" value="100" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>
<td><input type="number" value="2" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>
<td><input type="number" value="24" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>
<td class="equip-daily-kwh">-</td>
<td class="equip-daily-cost">-</td>
<td class="equip-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="RAS Pumps" style="width:100px" class="equip-name"></td>
<td><input type="number" value="25" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>
<td><input type="number" value="2" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>
<td><input type="number" value="24" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>
<td class="equip-daily-kwh">-</td>
<td class="equip-daily-cost">-</td>
<td class="equip-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Influent Pumps" style="width:100px" class="equip-name"></td>
<td><input type="number" value="50" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>
<td><input type="number" value="2" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>
<td><input type="number" value="18" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>
<td class="equip-daily-kwh">-</td>
<td class="equip-daily-cost">-</td>
<td class="equip-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="Mixers" style="width:100px" class="equip-name"></td>
<td><input type="number" value="10" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>
<td><input type="number" value="4" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>
<td><input type="number" value="24" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>
<td class="equip-daily-kwh">-</td>
<td class="equip-daily-cost">-</td>
<td class="equip-monthly-cost">-</td>
</tr>
<tr>
<td><input type="text" value="UV System" style="width:100px" class="equip-name"></td>
<td><input type="number" value="30" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>
<td><input type="number" value="1" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>
<td><input type="number" value="24" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>
<td class="equip-daily-kwh">-</td>
<td class="equip-daily-cost">-</td>
<td class="equip-monthly-cost">-</td>
</tr>
</tbody>
<tfoot>
<tr style="font-weight:bold;background:var(--bg-section-header)">
<td colspan="4">Energy Subtotal</td>
<td id="energy_daily_kwh">0</td>
<td id="energy_daily_total">$0.00</td>
<td id="energy_monthly_total">$0.00</td>
</tr>
</tfoot>
</table>
<button class="btn green" style="margin-top:10px" onclick="addEquipmentRow()">‚ûï Add Equipment</button>
</div>
</div>

<div class="section">
<div class="section-h">üöõ Solids Disposal Costs</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sludge Production (dry tons/day)</label><input type="number" id="cost_sludge_tons" value="2.5" step="0.1" onchange="calculateAllCosts()"></div>
<div class="input-group"><label>Disposal Cost ($/wet ton)</label><input type="number" id="cost_disposal_rate" value="45.00" step="1" onchange="calculateAllCosts()"></div>
<div class="input-group"><label>Cake Solids (%)</label><input type="number" id="cost_cake_solids" value="22" step="1" onchange="calculateAllCosts()"></div>
<div class="input-group"><label>Hauling Cost ($/load)</label><input type="number" id="cost_hauling" value="350" step="10" onchange="calculateAllCosts()"></div>
</div>
<div class="row">
<div class="input-group"><label>Tons per Load</label><input type="number" id="cost_tons_per_load" value="20" step="1" onchange="calculateAllCosts()"></div>
</div>
<table class="table">
<tr><td>Wet Tons per Day</td><td id="solids_wet_tons">-</td><td>wet tons/day</td></tr>
<tr><td>Loads per Month</td><td id="solids_loads_month">-</td><td>loads</td></tr>
<tr><td>Disposal Cost</td><td id="solids_disposal_cost">-</td><td>$/month</td></tr>
<tr><td>Hauling Cost</td><td id="solids_hauling_cost">-</td><td>$/month</td></tr>
<tr style="font-weight:bold;background:var(--bg-section-header)"><td>Solids Subtotal</td><td id="solids_monthly_total">$0.00</td><td>/month</td></tr>
</table>
</div>
</div>

<div class="section" style="background:linear-gradient(135deg,#065f46,#059669);color:white;border:none">
<div class="section-h" style="background:transparent;color:white">üìä Total Cost Summary</div>
<div class="section-content">
<table class="table" style="color:white">
<tr><td>Chemical Costs</td><td id="sum_chem_monthly">$0.00</td><td>/month</td><td id="sum_chem_annual">$0.00</td><td>/year</td></tr>
<tr><td>Energy Costs</td><td id="sum_energy_monthly">$0.00</td><td>/month</td><td id="sum_energy_annual">$0.00</td><td>/year</td></tr>
<tr><td>Solids Disposal</td><td id="sum_solids_monthly">$0.00</td><td>/month</td><td id="sum_solids_annual">$0.00</td><td>/year</td></tr>
<tr style="font-size:1.2em;border-top:2px solid rgba(255,255,255,0.3)"><td><strong>TOTAL</strong></td><td id="sum_total_monthly"><strong>$0.00</strong></td><td>/month</td><td id="sum_total_annual"><strong>$0.00</strong></td><td>/year</td></tr>
<tr style="background:rgba(255,255,255,0.1)"><td><strong>Cost per MG Treated</strong></td><td colspan="4" id="sum_cost_per_mg" style="font-size:1.3em"><strong>$0.00/MG</strong></td></tr>
</table>
<div class="btns" style="margin-top:15px">
<button class="btn" style="background:white;color:#059669" onclick="calculateAllCosts()">üîÑ Recalculate</button>
<button class="btn" style="background:rgba(255,255,255,0.2);color:white" onclick="exportCostReport()">üìÑ Export Report</button>
<button class="btn" style="background:rgba(255,255,255,0.2);color:white" onclick="saveCostData()">üíæ Save Data</button>
</div>
</div>
</div>

</div>

<div id="biz-clients">

<div id="clients-content" style="display:block">
<h3 style="color:var(--text-accent);margin-bottom:20px">üë• Client & Project Management</h3>

<div class="kpi-grid" style="margin-bottom:24px">
<div class="kpi-card">
<h4>Total Clients</h4>
<p id="stat_total_clients">0</p>
</div>
<div class="kpi-card">
<h4>Active Projects</h4>
<p id="stat_active_projects">0</p>
</div>
<div class="kpi-card">
<h4>Plants Managed</h4>
<p id="stat_plants_managed">0</p>
</div>
<div class="kpi-card">
<h4>Revenue YTD</h4>
<p id="stat_revenue_ytd">$0</p>
</div>
</div>

<div class="section">
<div class="section-h">‚ûï Add New Client</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Client/Company Name *</label><input type="text" id="client_name" placeholder="City of Houston"></div>
<div class="input-group"><label>Contact Person</label><input type="text" id="client_contact" placeholder="John Smith"></div>
<div class="input-group"><label>Email</label><input type="email" id="client_email" placeholder="jsmith@cityofhouston.gov"></div>
</div>
<div class="row">
<div class="input-group"><label>Phone</label><input type="tel" id="client_phone" placeholder="(713) 555-1234"></div>
<div class="input-group"><label>City</label><input type="text" id="client_city" placeholder="Houston"></div>
<div class="input-group"><label>Client Type</label>
<select id="client_type">
<option value="municipal">Municipal</option>
<option value="industrial">Industrial</option>
<option value="private_utility">Private Utility</option>
<option value="consultant">Consultant/Engineer</option>
<option value="other">Other</option>
</select></div>
</div>
<div class="row">
<div class="input-group" style="flex:2"><label>Notes</label><textarea id="client_notes" rows="2" placeholder="Initial consultation scheduled..."></textarea></div>
</div>
<div class="btns">
<button class="btn green" onclick="addClient()">‚ûï Add Client</button>
<button class="btn gray" onclick="clearClientForm()">Clear Form</button>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìã Client Database</div>
<div class="section-content">
<div class="btns" style="margin-bottom:15px">
<input type="text" id="client_search" placeholder="üîç Search clients..." style="flex:1;padding:10px;border-radius:8px;border:1px solid var(--border)">
<button class="btn blue" onclick="filterClients()">Search</button>
<button class="btn purple" onclick="exportClients()">üì§ Export CSV</button>
</div>
<div id="client_list" style="max-height:400px;overflow-y:auto">
<div class="note">No clients added yet. Add your first client above!</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìÅ Projects</div>
<div class="section-content">
<div class="btns" style="margin-bottom:15px">
<button class="btn green" onclick="showAddProjectModal()">‚ûï New Project</button>
<button class="btn orange" onclick="filterProjects('active')">Active Only</button>
<button class="btn gray" onclick="filterProjects('all')">Show All</button>
</div>
<div id="project_list" style="max-height:400px;overflow-y:auto">
<div class="note">No projects yet. Create a project after adding clients.</div>
</div>
</div>
</div>
</div>

</div>

<div id="biz-proposals" style="display:none">

<div id="proposals-content" style="display:none">
<h3 style="color:var(--text-accent);margin-bottom:20px">üìù Proposal Generator</h3>

<div class="section">
<div class="section-h">üìã Create New Proposal</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Proposal Number</label><input type="text" id="prop_number" value="PROP-2025-001"></div>
<div class="input-group"><label>Date</label><input type="date" id="prop_date"></div>
<div class="input-group"><label>Valid Until</label><input type="date" id="prop_valid"></div>
</div>
<div class="row">
<div class="input-group"><label>Client Name *</label><input type="text" id="prop_client" placeholder="Select or enter client name"></div>
<div class="input-group"><label>Project Name *</label><input type="text" id="prop_project" placeholder="WWTP Optimization Study"></div>
</div>
<div class="row">
<div class="input-group"><label>Facility Name</label><input type="text" id="prop_facility" placeholder="North Regional WWTP"></div>
<div class="input-group"><label>Facility Capacity (MGD)</label><input type="number" id="prop_capacity" value="5.0" step="0.1"></div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üîß Services & Scope</div>
<div class="section-content">
<div class="note info">Select services to include in your proposal. Prices are customizable.</div>
<div id="service_selection" style="margin-top:15px">
<div style="display:grid;gap:10px">

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_assessment" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Process Assessment & Evaluation</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Comprehensive review of treatment processes, performance data, and optimization opportunities</p>
</div>
<input type="number" id="price_assessment" value="3500" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_compliance" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Compliance Review & Support</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">TCEQ permit review, DMR preparation assistance, compliance strategy development</p>
</div>
<input type="number" id="price_compliance" value="2500" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_training" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Operator Training (On-site)</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Customized training for plant staff on process control, troubleshooting, and best practices</p>
</div>
<input type="number" id="price_training" value="2000" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_energy" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Energy Optimization Study</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Aeration efficiency audit, blower optimization, energy cost reduction strategies</p>
</div>
<input type="number" id="price_energy" value="4000" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_capacity" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Capacity Analysis & Planning</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Current capacity assessment, growth projections, expansion recommendations</p>
</div>
<input type="number" id="price_capacity" value="5000" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_troubleshoot" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Troubleshooting & Problem Resolution</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">On-site investigation of operational issues, root cause analysis, corrective actions</p>
</div>
<input type="number" id="price_troubleshoot" value="3000" style="width:100px" onchange="updateProposalTotal()">
</label>

<label class="service-item" style="display:flex;align-items:center;gap:15px;background:#1a2744;padding:15px;border-radius:8px;cursor:pointer">
<input type="checkbox" id="svc_monthly" onchange="updateProposalTotal()">
<div style="flex:1">
<strong style="color:#4ade80">Monthly Retainer Services</strong>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Ongoing support, data review, phone consultations, quarterly site visits</p>
</div>
<input type="number" id="price_monthly" value="1500" style="width:100px" onchange="updateProposalTotal()">
<span style="color:#94a3b8">/month</span>
</label>

</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üí∞ Proposal Summary</div>
<div class="section-content">
<div style="background:#1a2744;padding:20px;border-radius:12px">
<div style="display:flex;justify-content:space-between;margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid #374151">
<span>Selected Services Subtotal:</span>
<strong id="prop_subtotal">$0.00</strong>
</div>
<div class="row" style="margin-bottom:15px">
<div class="input-group"><label>Discount (%)</label><input type="number" id="prop_discount" value="0" min="0" max="50" onchange="updateProposalTotal()"></div>
<div class="input-group"><label>Travel/Expenses</label><input type="number" id="prop_expenses" value="500" onchange="updateProposalTotal()"></div>
</div>
<div style="display:flex;justify-content:space-between;font-size:18px;color:#4ade80">
<span>Total Proposal:</span>
<strong id="prop_total">$0.00</strong>
</div>
</div>
<div class="btns" style="margin-top:20px">
<button class="btn gradient" onclick="generateProposal()">üìÑ Generate Proposal</button>
<button class="btn blue" onclick="generateProposalPreview()">üëÅÔ∏è Preview</button>
<button class="btn blue" onclick="saveProposal()">üíæ Save Draft</button>
<button class="btn purple" onclick="emailProposal()">üìß Email to Client</button>
<button class="btn gray" onclick="clearProposal()">üóëÔ∏è Clear</button>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìÇ Saved Proposals</div>
<div class="section-content">
<div id="saved_proposals">
<div class="note">No saved proposals yet.</div>
</div>
</div>
</div>
</div>

</div>

<div id="biz-roi" style="display:none">

<div id="roi-content" style="display:none">
<h3 style="color:var(--text-accent);margin-bottom:20px">üíµ ROI Calculator</h3>

<div class="section">
<div class="section-h">üìä Current vs Proposed Scenario</div>
<div class="section-content">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">

<div style="background:#1a2744;padding:20px;border-radius:12px;border-top:4px solid #ef4444">
<h4 style="color:#f87171;margin:0 0 15px 0">üìç Current State</h4>
<div class="input-group"><label>Energy Cost ($/month)</label><input type="number" id="roi_energy_current" value="25000"></div>
<div class="input-group"><label>Chemical Cost ($/month)</label><input type="number" id="roi_chem_current" value="8000"></div>
<div class="input-group"><label>Sludge Disposal ($/month)</label><input type="number" id="roi_sludge_current" value="12000"></div>
<div class="input-group"><label>Maintenance Cost ($/month)</label><input type="number" id="roi_maint_current" value="5000"></div>
<div class="input-group"><label>Labor (hrs/week overtime)</label><input type="number" id="roi_labor_current" value="20"></div>
<div class="input-group"><label>Compliance Fines ($/year)</label><input type="number" id="roi_fines_current" value="5000"></div>
<div style="margin-top:15px;padding-top:15px;border-top:1px solid #374151">
<strong>Current Annual Cost: <span id="roi_current_total" style="color:#f87171">$0</span></strong>
</div>
</div>

<div style="background:#1a2744;padding:20px;border-radius:12px;border-top:4px solid #06d6a0">
<h4 style="color:#4ade80;margin:0 0 15px 0">üéØ After Improvements</h4>
<div class="input-group"><label>Energy Cost ($/month)</label><input type="number" id="roi_energy_proposed" value="18000"></div>
<div class="input-group"><label>Chemical Cost ($/month)</label><input type="number" id="roi_chem_proposed" value="6500"></div>
<div class="input-group"><label>Sludge Disposal ($/month)</label><input type="number" id="roi_sludge_proposed" value="10000"></div>
<div class="input-group"><label>Maintenance Cost ($/month)</label><input type="number" id="roi_maint_proposed" value="4000"></div>
<div class="input-group"><label>Labor (hrs/week overtime)</label><input type="number" id="roi_labor_proposed" value="8"></div>
<div class="input-group"><label>Compliance Fines ($/year)</label><input type="number" id="roi_fines_proposed" value="0"></div>
<div style="margin-top:15px;padding-top:15px;border-top:1px solid #374151">
<strong>Proposed Annual Cost: <span id="roi_proposed_total" style="color:#4ade80">$0</span></strong>
</div>
</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üí∞ Investment & Payback Analysis</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Consulting Fee ($)</label><input type="number" id="roi_consulting" value="15000"></div>
<div class="input-group"><label>Equipment/Capital ($)</label><input type="number" id="roi_capital" value="50000"></div>
<div class="input-group"><label>Implementation Cost ($)</label><input type="number" id="roi_implementation" value="10000"></div>
<div class="input-group"><label>Labor Rate ($/hr)</label><input type="number" id="roi_labor_rate" value="35"></div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="calculateROI()">üìä Calculate ROI</button>
<button class="btn gray" onclick="resetROI()">Reset</button>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìà ROI Results</div>
<div class="section-content">
<div id="roi_results">
<div class="note">Enter current and proposed values, then click "Calculate ROI" to see results.</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìä Savings Breakdown</div>
<div class="section-content">
<div class="chart-container" style="height:300px">
<canvas id="roiChart"></canvas>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìÑ Client Report</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Client Name</label><input type="text" id="roi_client_name" placeholder="City of Houston"></div>
<div class="input-group"><label>Facility Name</label><input type="text" id="roi_facility_name" placeholder="North Regional WWTP"></div>
<div class="input-group"><label>Prepared By</label><input type="text" id="roi_prepared_by" placeholder="Your Name"></div>
</div>
<div class="btns">
<button class="btn green" onclick="generateROIReport()">üìÑ Generate PDF Report</button>
<button class="btn blue" onclick="exportROIData()">üì§ Export Data</button>
<button class="btn purple" onclick="addToProposal()">üìù Add to Proposal</button>
</div>
</div>
</div>
</div>

</div>

<div id="biz-timetracking" style="display:none">

<h3 style="color:var(--text-accent);margin-bottom:20px">‚è±Ô∏è Time Tracking</h3>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#059669,#06d6a0);color:white">‚è±Ô∏è Active Timer</div>
<div class="section-content">
<div class="time-tracker">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
<div class="input-group">
<label style="color:#a7f3d0">Client</label>
<select id="timer_client" style="padding:12px;font-size:14px">
<option value="">Select Client...</option>
</select>
</div>
<div class="input-group">
<label style="color:#a7f3d0">Project</label>
<select id="timer_project" style="padding:12px;font-size:14px">
<option value="">Select Project...</option>
</select>
</div>
</div>
<div class="input-group">
<label style="color:#a7f3d0">Task Description</label>
<input type="text" id="timer_task" placeholder="e.g., Process evaluation, DMR review..." style="padding:12px;font-size:14px">
</div>
<div class="input-group">
<label style="color:#a7f3d0">Activity Type</label>
<select id="timer_type" style="padding:12px;font-size:14px">
<option value="site_visit">Site Visit</option>
<option value="analysis">Data Analysis</option>
<option value="reporting">Report Writing</option>
<option value="consulting">Consulting/Advisory</option>
<option value="training">Training</option>
<option value="travel">Travel</option>
<option value="admin">Administrative</option>
</select>
</div>

<div class="time-display" id="timer_display">00:00:00</div>

<div class="timer-controls">
<button class="timer-btn start" id="timer_start" onclick="startTimer()">‚ñ∂ Start</button>
<button class="timer-btn pause" id="timer_pause" onclick="pauseTimer()" style="display:none">‚è∏ Pause</button>
<button class="timer-btn stop" id="timer_stop" onclick="stopTimer()" style="display:none">‚èπ Stop & Save</button>
</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">‚ûï Manual Time Entry</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Date</label><input type="date" id="manual_date"></div>
<div class="input-group"><label>Hours</label><input type="number" id="manual_hours" value="1.0" step="0.25" min="0.25" max="24"></div>
<div class="input-group"><label>Billable Rate ($/hr)</label><input type="number" id="manual_rate" value="150" step="5"></div>
</div>
<div class="row">
<div class="input-group" style="flex:2"><label>Description</label><input type="text" id="manual_desc" placeholder="Describe the work performed..."></div>
</div>
<div class="btns">
<button class="btn green" onclick="addManualTime()">‚ûï Add Entry</button>
<button class="btn gray" onclick="clearTimeForm()">Clear</button>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìä Time Log</div>
<div class="section-content">
<div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap">
<select id="time_filter_period" style="padding:10px;border-radius:8px;min-width:150px">
<option value="today">Today</option>
<option value="week" selected>This Week</option>
<option value="month">This Month</option>
<option value="all">All Time</option>
</select>
<select id="time_filter_client" style="padding:10px;border-radius:8px;min-width:150px">
<option value="">All Clients</option>
</select>
<button class="btn blue" onclick="filterTimeLog()">üîç Filter</button>
<button class="btn purple" onclick="exportTimeLog()">üì§ Export</button>
</div>

<div class="kpi-grid" style="margin-bottom:20px">
<div class="kpi-card">
<h4>Total Hours</h4>
<p id="time_total_hours">0</p>
</div>
<div class="kpi-card">
<h4>Billable Hours</h4>
<p id="time_billable_hours">0</p>
</div>
<div class="kpi-card">
<h4>Unbilled Amount</h4>
<p id="time_unbilled">$0</p>
</div>
<div class="kpi-card">
<h4>Avg Hours/Day</h4>
<p id="time_avg_daily">0</p>
</div>
</div>

<div id="time_entries_list" style="max-height:400px;overflow-y:auto">
<div class="note">No time entries yet. Start the timer or add manual entries above.</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìà Weekly Summary</div>
<div class="section-content">
<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:20px">
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Mon</div>
<div style="font-size:18px;font-weight:700;color:#4ade80" id="week_mon">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Tue</div>
<div style="font-size:18px;font-weight:700;color:#4ade80" id="week_tue">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Wed</div>
<div style="font-size:18px;font-weight:700;color:#4ade80" id="week_wed">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Thu</div>
<div style="font-size:18px;font-weight:700;color:#4ade80" id="week_thu">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Fri</div>
<div style="font-size:18px;font-weight:700;color:#4ade80" id="week_fri">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Sat</div>
<div style="font-size:18px;font-weight:700;color:#60a5fa" id="week_sat">0</div>
</div>
<div style="text-align:center;padding:15px;background:#1a2744;border-radius:8px">
<div style="font-size:12px;color:#94a3b8">Sun</div>
<div style="font-size:18px;font-weight:700;color:#60a5fa" id="week_sun">0</div>
</div>
</div>
<div class="btns">
<button class="btn gradient" onclick="generateTimesheet()">üìÑ Generate Timesheet</button>
<button class="btn blue" onclick="generateInvoice()">üí∞ Generate Invoice</button>
</div>
</div>
</div>

</div>

<div id="biz-ai-enhance" style="display:none">

<h3 style="color:var(--text-accent);margin-bottom:20px">ü§ñ AI Enhancement</h3>

<div class="ai-enhance-panel">
<div style="color:white;position:relative;z-index:1">
<h3 style="margin:0 0 10px 0;display:flex;align-items:center;gap:10px">
üß† Intelligent Process Analysis
<span class="ai-confidence">AI Powered</span>
</h3>
<p style="opacity:0.8;margin:0">Let AI analyze your plant data and provide optimization recommendations</p>

<div class="ai-action-grid">
<button class="ai-action-btn" onclick="runAIAnalysis('process')">
üìä Process Analysis
</button>
<button class="ai-action-btn" onclick="runAIAnalysis('energy')">
‚ö° Energy Optimization
</button>
<button class="ai-action-btn" onclick="runAIAnalysis('compliance')">
üìã Compliance Check
</button>
<button class="ai-action-btn" onclick="runAIAnalysis('troubleshoot')">
üîß Troubleshooting
</button>
</div>
</div>
</div>

<div class="section" style="margin-top:20px">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:white">
üîÆ AI Insights & Recommendations
</div>
<div class="section-content" id="ai_results">
<div class="note info">Click an analysis type above to generate AI-powered insights based on your current plant data.</div>

<div class="ai-suggestion" style="display:none" id="ai_suggestion_1">
<div class="ai-suggestion-title">
üí° Process Optimization
<span class="ai-confidence">92% Confidence</span>
</div>
<p style="color:white;opacity:0.9">Based on current F/M ratio and MLSS levels, consider increasing RAS rate by 8-12% to improve settling and reduce SVI.</p>
</div>

<div class="ai-suggestion" style="display:none" id="ai_suggestion_2">
<div class="ai-suggestion-title">
‚ö° Energy Saving Opportunity
<span class="ai-confidence">87% Confidence</span>
</div>
<p style="color:white;opacity:0.9">DO levels are consistently above setpoint. Reducing blower output by 15% during 2AM-6AM could save approximately $2,400/month.</p>
</div>

<div class="ai-suggestion" style="display:none" id="ai_suggestion_3">
<div class="ai-suggestion-title">
‚ö†Ô∏è Predictive Alert
<span class="ai-confidence">78% Confidence</span>
</div>
<p style="color:white;opacity:0.9">SVI trend indicates potential filamentous bulking in 7-10 days. Consider implementing chlorination or nutrient adjustment.</p>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üõ†Ô∏è Quick AI Tools</div>
<div class="section-content">
<div class="tool-grid">
<div class="scenario-card" onclick="showAITool('report-writer')">
<div class="icon">üìù</div>
<strong>AI Report Writer</strong>
<p>Generate professional reports from your data</p>
</div>
<div class="scenario-card" onclick="showAITool('troubleshoot')">
<div class="icon">üîç</div>
<strong>Smart Troubleshooter</strong>
<p>Diagnose issues with intelligent questioning</p>
</div>
<div class="scenario-card" onclick="showAITool('optimizer')">
<div class="icon">üìà</div>
<strong>Process Optimizer</strong>
<p>Get real-time optimization suggestions</p>
</div>
<div class="scenario-card" onclick="showAITool('compliance')">
<div class="icon">‚úÖ</div>
<strong>Compliance Advisor</strong>
<p>TCEQ regulation guidance and DMR review</p>
</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üí¨ AI Assistant Chat</div>
<div class="section-content">
<div class="ai-chat-container">
<div class="ai-messages" id="ai_chat_messages">
<div class="ai-message assistant">
Hello! I'm your WWTP AI assistant. I can help you with process optimization, troubleshooting, compliance questions, and more. What would you like to discuss?
</div>
</div>
<div class="ai-thinking" id="ai_thinking">
Analyzing...
</div>
<div class="ai-input-area">
<input type="text" id="ai_chat_input" class="ai-input" placeholder="Ask me anything about wastewater treatment..." onkeypress="if(event.key==='Enter')sendAIMessage()">
<button class="btn gradient" onclick="sendAIMessage()">Send</button>
</div>
</div>
</div>
</div>

</div>

<div id="biz-sheets" style="display:none">
<h3 style="color:var(--text-accent);margin-bottom:20px">üìä Google Sheets Sync</h3>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#34a853,#4285f4);color:white">üîó Connect to Google Sheets</div>
<div class="section-content">
<p style="margin:0 0 20px 0;opacity:0.8">Export plant data to Google Sheets for tracking, reporting, and analysis.</p>

<div style="background:#1e3a5f;padding:20px;border-radius:12px;margin-bottom:20px">
<div style="display:flex;align-items:center;gap:15px;margin-bottom:15px">
<div style="width:12px;height:12px;border-radius:50%;background:#ef4444" id="sheets_status_dot"></div>
<span id="sheets_status_text">Not Connected</span>
</div>
<div class="row">
<div class="input-group">
<label>Google Sheet URL</label>
<input type="text" id="sheets_url" placeholder="https://docs.google.com/spreadsheets/d/..." style="font-size:12px">
</div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="connectGoogleSheet()">üîó Connect Sheet</button>
<button class="btn blue" onclick="testSheetConnection()">üß™ Test Connection</button>
</div>
</div>

<div style="background:#243b55;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4285f4">üì§ Export Data to Sheet</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">

<div style="background:#1e3a5f;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#4ade80">üìä Daily Operations</h5>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_flow" checked> Flow Data
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_do" checked> DO Readings
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_mlss" checked> MLSS/SVI
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_sludge" checked> Sludge Data
</label>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#fbbf24">üß™ Lab Results</h5>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_bod" checked> BOD/COD
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_tss" checked> TSS
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_nutrients" checked> Nutrients (N, P)
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_ph"> pH/Alkalinity
</label>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#a78bfa">üí∞ Costs</h5>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_chem"> Chemical Costs
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_energy"> Energy Costs
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_disposal"> Disposal Costs
</label>
<label style="display:flex;align-items:center;gap:8px;margin:5px 0;cursor:pointer">
<input type="checkbox" id="exp_labor"> Labor Hours
</label>
</div>

</div>

<div class="btns" style="margin-top:20px">
<button class="btn gradient" onclick="exportToSheets()">üì§ Export Selected Data</button>
<button class="btn blue" onclick="scheduleAutoSync()">üîÑ Schedule Auto-Sync</button>
<button class="btn orange" onclick="downloadCSV()">üíæ Download as CSV</button>
</div>
</div>

<div style="background:#1e3a5f;padding:20px;border-radius:12px">
<h4 style="margin:0 0 15px 0;color:#34a853">üîÑ Auto-Sync Settings</h4>
<div class="row">
<div class="input-group">
<label>Sync Frequency</label>
<select id="sync_freq" style="font-size:14px">
<option value="manual">Manual Only</option>
<option value="daily">Daily</option>
<option value="weekly">Weekly</option>
<option value="monthly">Monthly</option>
</select>
</div>
<div class="input-group">
<label>Sync Time</label>
<input type="time" id="sync_time" value="06:00">
</div>
<div class="input-group">
<label>Last Sync</label>
<input type="text" id="last_sync" value="Never" readonly style="background:#0f172a">
</div>
</div>
</div>

<div id="sheets_results" style="margin-top:20px"></div>
</div>
</div>
</div>

<div id="biz-serviceprop" style="display:none">
<h3 style="color:var(--text-accent);margin-bottom:20px">üìã Service Proposal Generator</h3>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white">üìã Create Professional Proposal</div>
<div class="section-content">
<p style="margin:0 0 20px 0;opacity:0.8">Generate customized service proposals for wastewater consulting engagements.</p>

<div style="background:#1e3a5f;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#8b5cf6">üë§ Client Information</h4>
<div class="row">
<div class="input-group">
<label>Client/Company Name</label>
<input type="text" id="prop_client" placeholder="ABC Water District">
</div>
<div class="input-group">
<label>Contact Person</label>
<input type="text" id="prop_contact" placeholder="John Smith">
</div>
<div class="input-group">
<label>Title</label>
<input type="text" id="prop_title" placeholder="Plant Superintendent">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Email</label>
<input type="email" id="prop_email" placeholder="jsmith@abcwater.com">
</div>
<div class="input-group">
<label>Phone</label>
<input type="tel" id="prop_phone" placeholder="(555) 123-4567">
</div>
<div class="input-group">
<label>Address</label>
<input type="text" id="prop_address" placeholder="123 Main St, City, TX">
</div>
</div>
</div>

<div style="background:#243b55;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üè≠ Facility Information</h4>
<div class="row">
<div class="input-group">
<label>Facility Name</label>
<input type="text" id="prop_facility" placeholder="Main WWTP">
</div>
<div class="input-group">
<label>Design Capacity (MGD)</label>
<input type="number" id="prop_capacity" value="5.0" step="0.1">
</div>
<div class="input-group">
<label>Current Flow (MGD)</label>
<input type="number" id="prop_flow" value="3.5" step="0.1">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Treatment Type</label>
<select id="prop_treatment" style="font-size:14px">
<option value="activated_sludge">Activated Sludge</option>
<option value="sbr">SBR</option>
<option value="mbr">MBR</option>
<option value="oxidation_ditch">Oxidation Ditch</option>
<option value="trickling_filter">Trickling Filter</option>
<option value="lagoon">Lagoon</option>
<option value="other">Other</option>
</select>
</div>
<div class="input-group">
<label>Permit Type</label>
<select id="prop_permit" style="font-size:14px">
<option value="npdes">NPDES</option>
<option value="state">State Permit</option>
<option value="reuse">Reuse Permit</option>
</select>
</div>
<div class="input-group">
<label>Current Issues</label>
<input type="text" id="prop_issues" placeholder="High TSS, ammonia">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üõ†Ô∏è Services Offered</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px">

<div style="background:#243b55;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#60a5fa">üìã Routine Services</h5>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_monthly" checked> Monthly Site Visits
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_process"> Process Optimization
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_troubleshoot"> Troubleshooting Support
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_training"> Operator Training
</label>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#4ade80">üìä Reports & Compliance</h5>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_dmr"> DMR Review & Support
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_reports"> Monthly Reports
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_permit"> Permit Assistance
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_audit"> Compliance Audits
</label>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px">
<h5 style="margin:0 0 10px 0;color:#f97316">üîß Special Projects</h5>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_startup"> Startup Assistance
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_upgrade"> Upgrade Planning
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_study"> Process Study
</label>
<label style="display:flex;align-items:center;gap:8px;margin:8px 0;cursor:pointer">
<input type="checkbox" id="svc_emergency"> Emergency Response
</label>
</div>

</div>
</div>

<div style="background:#243b55;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#ef4444">üí∞ Pricing</h4>
<div class="row">
<div class="input-group">
<label>Hourly Rate ($)</label>
<input type="number" id="prop_hourly" value="150" step="5">
</div>
<div class="input-group">
<label>Monthly Retainer ($)</label>
<input type="number" id="prop_retainer" value="2500" step="100">
</div>
<div class="input-group">
<label>Site Visit Rate ($)</label>
<input type="number" id="prop_visit" value="500" step="25">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Travel Rate ($/mile)</label>
<input type="number" id="prop_mileage" value="0.67" step="0.01">
</div>
<div class="input-group">
<label>Estimated Miles</label>
<input type="number" id="prop_miles" value="50">
</div>
<div class="input-group">
<label>Contract Term</label>
<select id="prop_term" style="font-size:14px">
<option value="monthly">Month-to-Month</option>
<option value="6month">6 Months</option>
<option value="annual" selected>Annual</option>
<option value="2year">2 Years</option>
</select>
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="generateServiceProposal()">üìã Generate Proposal</button>
<button class="btn blue" onclick="previewProposal()">üëÅÔ∏è Preview</button>
<button class="btn orange" onclick="saveProposalTemplate()">üíæ Save as Template</button>
<button class="btn gray" onclick="clearProposalForm()">üîÑ Clear Form</button>
</div>

<div id="proposal_preview" style="margin-top:20px"></div>
</div>
</div>
</div>

</div>
<div class="panel" id="daily-ops">
<div id="DAILY-OPS_HEADER_MARKER" style="background:linear-gradient(135deg,#14b8a6 0%,#2dd4bf 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìÖ DAILY OPERATIONS</h2>
</div>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#059669,#06d6a0);color:white;padding:12px 15px;border-radius:8px">
üìã Daily Rounds Checklist
<button onclick="resetDailyChecklist()" style="float:right;background:rgba(255,255,255,0.2);border:none;color:white;padding:5px 10px;border-radius:5px;cursor:pointer">Reset</button>
</div>
<div class="section-content">
<div class="note info">Complete all items during your shift. Progress is saved automatically.</div>

<div id="dailyChecklist" style="display:grid;gap:10px;margin-top:15px">

<div class="checklist-category" style="background:#1a2744;padding:15px;border-radius:8px">
<h4 style="color:#60a5fa;margin:0 0 10px 0">üåÖ Morning Checks (6:00 AM)</h4>
<label class="checklist-item"><input type="checkbox" id="chk_do" onchange="saveChecklist()"> Check DO levels in all basins</label>
<label class="checklist-item"><input type="checkbox" id="chk_mlss" onchange="saveChecklist()"> Record MLSS settleometer reading</label>
<label class="checklist-item"><input type="checkbox" id="chk_flows" onchange="saveChecklist()"> Verify influent/effluent flow meters</label>
<label class="checklist-item"><input type="checkbox" id="chk_blowers" onchange="saveChecklist()"> Check blower operation & pressures</label>
<label class="checklist-item"><input type="checkbox" id="chk_clarifier" onchange="saveChecklist()"> Inspect clarifier blanket levels</label>
</div>

<div class="checklist-category" style="background:#1a2744;padding:15px;border-radius:8px">
<h4 style="color:#ffd166;margin:0 0 10px 0">‚òÄÔ∏è Midday Checks (12:00 PM)</h4>
<label class="checklist-item"><input type="checkbox" id="chk_ph" onchange="saveChecklist()"> Check pH levels</label>
<label class="checklist-item"><input type="checkbox" id="chk_chlorine" onchange="saveChecklist()"> Verify chlorine residual</label>
<label class="checklist-item"><input type="checkbox" id="chk_pumps" onchange="saveChecklist()"> Inspect all pump operations</label>
<label class="checklist-item"><input type="checkbox" id="chk_chemicals" onchange="saveChecklist()"> Check chemical feed rates & inventory</label>
<label class="checklist-item"><input type="checkbox" id="chk_scum" onchange="saveChecklist()"> Remove scum from clarifiers</label>
</div>

<div class="checklist-category" style="background:#1a2744;padding:15px;border-radius:8px">
<h4 style="color:#48cae4;margin:0 0 10px 0">üåô Evening Checks (6:00 PM)</h4>
<label class="checklist-item"><input type="checkbox" id="chk_was" onchange="saveChecklist()"> Adjust WAS rate if needed</label>
<label class="checklist-item"><input type="checkbox" id="chk_ras" onchange="saveChecklist()"> Verify RAS flow rates</label>
<label class="checklist-item"><input type="checkbox" id="chk_uv" onchange="saveChecklist()"> Check UV system operation</label>
<label class="checklist-item"><input type="checkbox" id="chk_safety" onchange="saveChecklist()"> Complete safety walkthrough</label>
<label class="checklist-item"><input type="checkbox" id="chk_logbook" onchange="saveChecklist()"> Update operator logbook</label>
</div>

</div>

<div style="margin-top:15px;padding:15px;background:#0c1929;border-radius:8px">
<div style="display:flex;justify-content:space-between;align-items:center">
<span style="color:#94a3b8">Progress:</span>
<span id="checklistProgress" style="color:#06d6a0;font-weight:bold">0 / 15 (0%)</span>
</div>
<div style="background:#243b55;height:10px;border-radius:5px;margin-top:10px;overflow:hidden">
<div id="checklistBar" style="background:linear-gradient(90deg,#06d6a0,#34d399);height:100%;width:0%;transition:width 0.3s"></div>
</div>
</div>

</div>
</div>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#0096c7,#48cae4);color:white;padding:12px 15px;border-radius:8px">üßô Calculation Wizards</div>
<div class="section-content">
<div class="note">Guided step-by-step calculations for common tasks. Perfect for new operators!</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:15px;margin-top:15px">

<div class="wizard-card" onclick="startWizard('fm')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">‚öñÔ∏è F/M Ratio Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate Food to Microorganism ratio step by step</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">5 steps ‚Ä¢ ~2 min</div>
</div>

<div class="wizard-card" onclick="startWizard('srt')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">‚è±Ô∏è SRT Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate Solids Retention Time with guidance</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">6 steps ‚Ä¢ ~3 min</div>
</div>

<div class="wizard-card" onclick="startWizard('was')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üöø WAS Rate Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Determine optimal waste activated sludge rate</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">4 steps ‚Ä¢ ~2 min</div>
</div>

<div class="wizard-card" onclick="startWizard('chlorine')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üß™ Chlorine Dose Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate chlorine dosing requirements</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">4 steps ‚Ä¢ ~2 min</div>
</div>
<div class="wizard-card" onclick="startWizard('svi')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üß™ SVI Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate Sludge Volume Index step by step</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">3 steps ‚Ä¢ ~1 min</div>
</div>

<div class="wizard-card" onclick="startWizard('bod_removal')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üìâ BOD Removal Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate BOD removal efficiency</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">4 steps ‚Ä¢ ~2 min</div>
</div>

<div class="wizard-card" onclick="startWizard('ras')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üîÑ RAS Rate Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate Return Activated Sludge rate</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">4 steps ‚Ä¢ ~2 min</div>
</div>

<div class="wizard-card" onclick="startWizard('detention')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">‚è∞ Detention Time Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate hydraulic detention time</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">3 steps ‚Ä¢ ~1 min</div>
</div>

<div class="wizard-card" onclick="startWizard('sor')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üåä Clarifier SOR Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate Surface Overflow Rate</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">3 steps ‚Ä¢ ~1 min</div>
</div>

<div class="wizard-card" onclick="startWizard('polymer')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üß¥ Polymer Dose Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate polymer dosing for dewatering</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">5 steps ‚Ä¢ ~2 min</div>
</div>

<div class="wizard-card" onclick="startWizard('blower')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">üí® Blower Air Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate aeration requirements</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">5 steps ‚Ä¢ ~3 min</div>
</div>

<div class="wizard-card" onclick="startWizard('ct')" style="background:linear-gradient(135deg,#1e3a5f,#2d5a87);padding:20px;border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.3s">
<h4 style="color:#4ade80;margin:0">‚è±Ô∏è CT Disinfection Wizard</h4>
<p style="color:#94a3b8;margin:10px 0 0 0;font-size:14px">Calculate CT for disinfection compliance</p>
<div style="color:#60a5fa;font-size:12px;margin-top:10px">4 steps ‚Ä¢ ~2 min</div>
</div>

<div id="wizardModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;justify-content:center;align-items:center">
<div style="background:#1a2744;padding:30px;border-radius:16px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto">
<div id="wizardContent"></div>
</div>
</div>

</div>
</div>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#dc2626,#ef4444);color:white;padding:12px 15px;border-radius:8px">üéì Operator Training</div>
<div class="section-content">
<div class="note warning">Interactive training modules for new operators. Complete all modules to earn certification!</div>

<div id="trainingModules" style="margin-top:15px">

<div class="training-module" style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:15px;border-left:4px solid #06d6a0">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<h4 style="color:#fff;margin:0">Module 1: Activated Sludge Basics</h4>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Understanding biological treatment fundamentals</p>
</div>
<button onclick="startTraining(1)" style="background:#06d6a0;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer">Start</button>
</div>
<div style="margin-top:15px;display:none" id="training1Content">
<div class="training-content" style="background:#0c1929;padding:15px;border-radius:8px">
<h5 style="color:#60a5fa;margin:0 0 10px 0">What is Activated Sludge?</h5>
<p style="color:#e0f2fe;line-height:1.6">Activated sludge is a biological process that uses microorganisms to break down organic matter in wastewater. The "activated" refers to the active mass of microorganisms that consume pollutants.</p>
<h5 style="color:#60a5fa;margin:15px 0 10px 0">Key Components:</h5>
<ul style="color:#e0f2fe;line-height:1.8">
<li><strong>Aeration Basin:</strong> Where microorganisms mix with wastewater and oxygen</li>
<li><strong>Secondary Clarifier:</strong> Separates treated water from biomass</li>
<li><strong>Return Activated Sludge (RAS):</strong> Recycles microorganisms back to aeration</li>
<li><strong>Waste Activated Sludge (WAS):</strong> Removes excess biomass from system</li>
</ul>
<div style="margin-top:15px">
<button onclick="completeModule(1)" style="background:#06d6a0;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;width:100%">‚úì Mark as Complete</button>
</div>
</div>
</div>
</div>

<div class="training-module" style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:15px;border-left:4px solid #ffd166">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<h4 style="color:#fff;margin:0">Module 2: Key Process Parameters</h4>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">MLSS, SVI, F/M, SRT, and what they mean</p>
</div>
<button onclick="startTraining(2)" style="background:#ffd166;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer">Start</button>
</div>
<div style="margin-top:15px;display:none" id="training2Content">
<div class="training-content" style="background:#0c1929;padding:15px;border-radius:8px">
<h5 style="color:#60a5fa;margin:0 0 10px 0">Essential Parameters Every Operator Must Know:</h5>
<div style="display:grid;gap:15px">
<div style="background:#1a2744;padding:12px;border-radius:8px">
<strong style="color:#4ade80">MLSS (Mixed Liquor Suspended Solids)</strong>
<p style="color:#94a3b8;margin:5px 0 0 0">Concentration of microorganisms in aeration basin. Typical: 2,000-4,000 mg/L</p>
</div>
<div style="background:#1a2744;padding:12px;border-radius:8px">
<strong style="color:#4ade80">SVI (Sludge Volume Index)</strong>
<p style="color:#94a3b8;margin:5px 0 0 0">Settleability indicator. Good: 80-150 mL/g. High SVI = poor settling (bulking)</p>
</div>
<div style="background:#1a2744;padding:12px;border-radius:8px">
<strong style="color:#4ade80">F/M (Food to Microorganism Ratio)</strong>
<p style="color:#94a3b8;margin:5px 0 0 0">BOD loading per unit biomass. Typical: 0.2-0.5 lb BOD/lb MLVSS/day</p>
</div>
<div style="background:#1a2744;padding:12px;border-radius:8px">
<strong style="color:#4ade80">SRT (Solids Retention Time)</strong>
<p style="color:#94a3b8;margin:5px 0 0 0">Average time solids stay in system. Typical: 5-15 days for conventional activated sludge</p>
</div>
</div>
<div style="margin-top:15px">
<button onclick="completeModule(2)" style="background:#ffd166;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;width:100%">‚úì Mark as Complete</button>
</div>
</div>
</div>
</div>

<div class="training-module" style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:15px;border-left:4px solid #0077b6">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<h4 style="color:#fff;margin:0">Module 3: Troubleshooting Common Problems</h4>
<p style="color:#94a3b8;margin:5px 0 0 0;font-size:14px">Identify and fix operational issues</p>
</div>
<button onclick="startTraining(3)" style="background:#0077b6;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer">Start</button>
</div>
<div style="margin-top:15px;display:none" id="training3Content">
<div class="training-content" style="background:#0c1929;padding:15px;border-radius:8px">
<h5 style="color:#ef4444;margin:0 0 15px 0">‚ö†Ô∏è Common Problems & Solutions:</h5>
<div style="display:grid;gap:15px">
<div style="background:#1a2744;padding:12px;border-radius:8px;border-left:3px solid #ef4444">
<strong style="color:#ef4444">Sludge Bulking (High SVI > 150)</strong>
<p style="color:#94a3b8;margin:5px 0">Causes: Low DO, low F/M, nutrient deficiency</p>
<p style="color:#06d6a0;margin:5px 0">Fix: Increase DO, add nutrients, consider chlorination of RAS</p>
</div>
<div style="background:#1a2744;padding:12px;border-radius:8px;border-left:3px solid #ffd166">
<strong style="color:#ffd166">Rising Sludge in Clarifier</strong>
<p style="color:#94a3b8;margin:5px 0">Causes: Denitrification, long sludge detention</p>
<p style="color:#06d6a0;margin:5px 0">Fix: Increase RAS rate, decrease SRT, improve sludge removal</p>
</div>
<div style="background:#1a2744;padding:12px;border-radius:8px;border-left:3px solid #0077b6">
<strong style="color:#0077b6">Foaming</strong>
<p style="color:#94a3b8;margin:5px 0">Causes: Nocardia, high SRT, grease accumulation</p>
<p style="color:#06d6a0;margin:5px 0">Fix: Reduce SRT, spray water, remove scum, check for industrial discharge</p>
</div>
</div>
<div style="margin-top:15px">
<button onclick="completeModule(3)" style="background:#0077b6;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;width:100%">‚úì Mark as Complete</button>
</div>
</div>
</div>
</div>

</div>

<div style="margin-top:15px;padding:15px;background:#0c1929;border-radius:8px">
<div style="display:flex;justify-content:space-between;align-items:center">
<span style="color:#94a3b8">Training Progress:</span>
<span id="trainingProgress" style="color:#ffd166;font-weight:bold">0 / 3 modules</span>
</div>
</div>

</div>
</div>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#0891b2,#48cae4);color:white;padding:12px 15px;border-radius:8px">üìö Formula Reference</div>
<div class="section-content">
<div class="note">Quick reference guide with all essential wastewater formulas. Click any formula for detailed explanation!</div>

<div style="display:grid;gap:10px;margin-top:15px">

<div class="formula-card" onclick="showFormulaDetail('fm')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">F/M Ratio</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">F/M = (BOD √ó Flow √ó 8.34) / (MLVSS √ó Volume √ó 8.34)</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('srt')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">SRT (Sludge Retention Time)</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">SRT = System Solids (lb) / Solids Wasted (lb/day)</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('svi')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">SVI (Sludge Volume Index)</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">SVI = (Settled Volume mL/L √ó 1000) / MLSS mg/L</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('bod')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">BOD Loading</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">BOD Load (lb/day) = BOD (mg/L) √ó Flow (MGD) √ó 8.34</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('removal')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">Percent Removal</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">% Removal = ((In - Out) / In) √ó 100</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('detention')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">Detention Time</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">DT (hours) = (Volume gal √ó 24) / (Flow GPD)</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('sor')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">Surface Overflow Rate</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">SOR = Flow (GPD) / Surface Area (sq ft)</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

<div class="formula-card" onclick="showFormulaDetail('ct')" style="background:#1a2744;padding:15px;border-radius:8px;cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<strong style="color:#4ade80">CT (Disinfection)</strong>
<div style="color:#e0f2fe;font-family:monospace;margin-top:5px">CT = Chlorine Residual (mg/L) √ó Contact Time (min)</div>
</div>
<span style="color:#60a5fa">‚ÑπÔ∏è</span>
</div>
</div>

</div>

<div id="formulaModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;justify-content:center;align-items:center">
<div style="background:#1a2744;padding:30px;border-radius:16px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto">
<div id="formulaDetail"></div>
<button onclick="closeFormulaModal()" style="background:#ef4444;color:white;border:none;padding:10px 30px;border-radius:8px;cursor:pointer;margin-top:20px;width:100%">Close</button>
</div>
</div>

</div>
</div>

</div>
</div>

<div class="panel" id="process-control">
<div id="PROCESS-CONTROL_HEADER_MARKER" style="background:linear-gradient(135deg,#f97316 0%,#fb923c 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">‚öôÔ∏è PROCESS CONTROL</h2>
</div>

<div id="masterSettingsSection" class="section" style="background:linear-gradient(135deg,#059669,#06d6a0);border-radius:12px;margin-bottom:20px">
<div class="section-h" style="color:white;font-size:18px;font-weight:bold">
üéõÔ∏è Master Settings - Auto-Populate All Calculators
</div>
<div class="section-content" style="background:rgba(0,0,0,0.2);border-radius:0 0 12px 12px">
<div class="note" style="background:rgba(255,255,255,0.1);border-left-color:#4ade80;color:white;margin-bottom:15px">
Set values here to populate all calculators, update Dashboard KPIs, and feed Enhanced Calculators below.
</div>
<div class="row" style="gap:15px">
<div class="input-group">
<label style="color:#a7f3d0">Flow Rate (MGD)</label>
<input id="masterFlowPC" type="number" step="0.1" value="3.5" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">Aeration Volume (MG)</label>
<input id="masterAerVolPC" type="number" step="0.1" value="1.0" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">BOD (mg/L)</label>
<input id="masterBODPC" type="number" step="1" value="200" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">MLSS (mg/L)</label>
<input id="masterMLSSPC" type="number" step="100" value="3000" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
</div>
<div class="row" style="gap:15px;margin-top:15px">
<div class="input-group">
<label style="color:#a7f3d0">Clarifier Diameter (ft)</label>
<input id="masterClarDia" type="number" step="1" value="80" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0"># of Clarifiers</label>
<input id="masterClarNum" type="number" step="1" value="2" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">Weir Length (ft)</label>
<input id="masterWeirLen" type="number" step="1" value="500" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
<div class="input-group">
<label style="color:#a7f3d0">WAS Flow (GPD)</label>
<input id="masterWAS" type="number" step="1000" value="25000" oninput="syncMasterToAll()" style="font-size:16px;font-weight:bold">
</div>
</div>
<div class="btns" style="margin-top:15px;gap:10px">
<button onclick="syncMasterToAll()" class="btn" style="background:#047857;color:white;font-weight:bold">üì° Sync All Now</button>
<button onclick="syncAndCalculateAll()" class="btn" style="background:#fbbf24;color:#1e3a5f;font-weight:bold">‚ö° Sync & Calculate</button>
<button onclick="switchPanel('profiles')" class="btn" style="background:#7c3aed;color:white">üè≠ Load Profile</button>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üì• Influent Loading Parameters</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Flow Rate (MGD)</label>
<div class="input-with-icon">
<input id="flow" step="0.1" type="number" value="3.5">
<span class="input-icon">üíß</span>
</div>
</div>
<div class="input-group">
<label>BOD (mg/L)</label>
<input id="bod" step="1" type="number" value="200">
</div>
<div class="input-group">
<label>TSS (mg/L)</label>
<input id="tss" step="1" type="number" value="220">
</div>
<div class="input-group">
<label>TKN (mg/L)</label>
<input id="tkn" step="1" type="number" value="40">
</div>
<div class="input-group">
<label>TP (mg/L)</label>
<input id="tp" step="0.1" type="number" value="8">
</div>
<div class="input-group">
<label>COD (mg/L)</label>
<input id="cod" step="1" type="number" value="450">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcLoading()">Calculate Loading</button>
<button class="btn gray" onclick="resetLoading()">Reset</button>
<button class="btn orange" onclick="compareHistorical()">Compare Historical</button>
</div>
</div>
</div>
<div class="section">
<div class="section-h">üìä Loading Results &amp; Analysis</div>
<div class="section-content">
<table class="table">
<thead>
<tr>
<th class="col">Parameter</th>
<th class="col">Value</th>
<th class="col">Unit</th>
<th class="col">7-Day Avg</th>
<th class="col">Trend</th>
<th class="col">Status</th>
</tr>
</thead>
<tbody>
<tr>
<td class="rowh">BOD Load</td>
<td><span class="result" id="r_bodLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_bodLoad">-</span></td>
<td><span id="trend_bodLoad">-</span></td>
<td><span class="status" id="s_bodLoad">-</span></td>
</tr>
<tr>
<td class="rowh">TSS Load</td>
<td><span class="result" id="r_tssLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_tssLoad">-</span></td>
<td><span id="trend_tssLoad">-</span></td>
<td><span class="status" id="s_tssLoad">-</span></td>
</tr>
<tr>
<td class="rowh">TKN Load</td>
<td><span class="result" id="r_tknLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_tknLoad">-</span></td>
<td><span id="trend_tknLoad">-</span></td>
<td><span class="status" id="s_tknLoad">-</span></td>
</tr>
<tr>
<td class="rowh">TP Load</td>
<td><span class="result" id="r_tpLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_tpLoad">-</span></td>
<td><span id="trend_tpLoad">-</span></td>
<td><span class="status" id="s_tpLoad">-</span></td>
</tr>
<tr>
<td class="rowh">COD Load</td>
<td><span class="result" id="r_codLoad">-</span></td>
<td>lb/d</td>
<td><span id="avg_codLoad">-</span></td>
<td><span id="trend_codLoad">-</span></td>
<td><span class="status" id="s_codLoad">-</span></td>
</tr>
</tbody>
</table>
<div class="stats-row">
<div class="stat-item">
<div class="stat-label">Organic Loading Rate</div>
<div class="stat-value" id="stat_olr">0.42</div>
<div class="stat-unit">lb BOD/lb MLVSS/d</div>
</div>
<div class="stat-item">
<div class="stat-label">Volumetric Loading</div>
<div class="stat-value" id="stat_volLoad">58.3</div>
<div class="stat-unit">lb BOD/1000 ft¬≥/d</div>
</div>
<div class="stat-item">
<div class="stat-label">BOD:N:P Ratio</div>
<div class="stat-value" id="stat_ratio">100:20:4</div>
<div class="stat-unit">Actual</div>
</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#0096c7,#48cae4);color:white;padding:10px 15px;border-radius:8px;margin-top:20px">üß´ Sludge Management</div>
<div class="section-content">
<div class="note info">Sludge management parameters for activated sludge process control.</div>
</div>
</div>

<div class="section">
<div class="section-h">üß´ Activated Sludge Parameters</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>MLSS (mg/L)</label>
<input id="mlss" step="10" type="number" value="3000">
</div>
<div class="input-group">
<label>MLVSS (mg/L)</label>
<input id="mlvss" step="10" type="number" value="2000">
</div>
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input id="aerVol" step="0.1" type="number" value="1.2">
</div>
<div class="input-group">
<label>RAS Flow (MGD)</label>
<input id="rasFlow" step="0.1" type="number" value="1.5">
</div>
<div class="input-group">
<label>WAS Flow (MGD)</label>
<input id="wasFlow" step="0.01" type="number" value="0.05">
</div>
<div class="input-group">
<label>WAS TSS (mg/L)</label>
<input id="wasTss" step="100" type="number" value="8000">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSludge()">Calculate Sludge</button>
<button class="btn gray" onclick="resetSludge()">Reset</button>
</div>
</div>
</div>
<div class="section">
<div class="section-h">üìä Sludge Results</div>
<div class="section-content">
<table class="table">
<thead>
<tr>
<th class="col">Parameter</th>
<th class="col">Value</th>
<th class="col">Unit</th>
<th class="col">Status</th>
</tr>
</thead>
<tbody>
<tr>
<td class="rowh">F/M Ratio</td>
<td><span class="result" id="r_fm_dash">-</span></td>
<td>lb BOD/lb MLVSS/d</td>
<td><span class="status" id="s_fm">-</span></td>
</tr>
<tr>
<td class="rowh">MCRT (Sludge Age)</td>
<td><span class="result" id="r_mcrt_dash">-</span></td>
<td>days</td>
<td><span class="status" id="s_mcrt">-</span></td>
</tr>
<tr>
<td class="rowh">SVI</td>
<td><span class="result" id="r_svi_dash">-</span></td>
<td>mL/g</td>
<td><span class="status" id="s_svi">-</span></td>
</tr>
<tr>
<td class="rowh">MLSS Inventory</td>
<td><span class="result" id="r_mlss_inv">-</span></td>
<td>lbs</td>
<td><span class="status" id="s_mlss_inv">-</span></td>
</tr>
<tr>
<td class="rowh">WAS Solids</td>
<td><span class="result" id="r_was_solids">-</span></td>
<td>lbs/day</td>
<td><span class="status" id="s_was_solids">-</span></td>
</tr>
<tr>
<td class="rowh">RAS Rate</td>
<td><span class="result" id="r_ras_rate">-</span></td>
<td>% of Q</td>
<td><span class="status" id="s_ras_rate">-</span></td>
</tr>
</tbody>
</table>
</div>
</div>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#0891b2,#48cae4);color:white;padding:10px 15px;border-radius:8px;margin-top:20px">üí® Oxygen & Aeration</div>
</div>

<div class="section">
<div class="section-h">üí® Oxygen Requirements</div>
<div class="section-content">
<div class="row">
<div class="input-group">
<label>Current DO (mg/L)</label>
<input id="doNow" step="0.1" type="number" value="2.0">
</div>
<div class="input-group">
<label>Target DO (mg/L)</label>
<input id="doTarget" step="0.1" type="number" value="2.5">
</div>
<div class="input-group">
<label>Peak Factor</label>
<input id="peakFactor" step="0.1" type="number" value="1.5">
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcOxygen()">Calculate Oxygen</button>
<button class="btn gray" onclick="resetOxygen()">Reset</button>
</div>
<div class="stats-row" style="margin-top:20px">
<div class="stat-item">
<div class="stat-label">O‚ÇÇ Required</div>
<div class="stat-value" id="r_o2req">-</div>
<div class="stat-unit">lb O‚ÇÇ/d</div>
</div>
<div class="stat-item">
<div class="stat-label">Peak Demand</div>
<div class="stat-value" id="r_o2peak">-</div>
<div class="stat-unit">lb O‚ÇÇ/hr</div>
</div>
<div class="stat-item">
<div class="stat-label">Airflow</div>
<div class="stat-value" id="r_airflow">-</div>
<div class="stat-unit">CFM</div>
</div>
</div>
</div>
</div>

<div class="section" style="background:linear-gradient(135deg,#1e1b4b,#312e81);border-radius:16px;margin-top:20px;border:3px solid #6366f1">
<div class="section-h" style="color:white;font-size:20px;background:linear-gradient(135deg,#4f46e5,#6366f1);padding:16px;border-radius:12px 12px 0 0">
üßÆ Enhanced Calculators <span class="auto-calc-badge">Auto-Calculate</span>
<div style="float:right;display:flex;gap:10px;align-items:center">
<div class="unit-toggle" id="unitToggle">
<button class="active" onclick="setUnits('us')">US</button>
<button onclick="setUnits('metric')">Metric</button>
</div>
</div>
</div>
<div class="section-content" style="background:rgba(0,0,0,0.3)">

<div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
<button onclick="toggleFormulaDisplay()" class="btn" style="background:#3b82f6;color:white">üìê Show Formulas</button>
<button onclick="saveCalcResults()" class="btn" style="background:#10b981;color:white">üíæ Save Results</button>
<button onclick="toggleCompareMode()" class="btn" style="background:#8b5cf6;color:white">‚öñÔ∏è Compare Mode</button>
<button onclick="showCalcHistory()" class="btn" style="background:#f59e0b;color:#1e3a5f">üìú History</button>
<button onclick="exportCalcResults()" class="btn" style="background:#06b6d4;color:white">üì§ Export</button>
</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px">

<div class="calc-result-card" id="fmCard">
<div class="label">F/M Ratio</div>
<div class="gauge-container">
<svg viewBox="0 0 150 90" style="width:100%;height:auto">
<path class="gauge-bg" d="M 20 80 A 55 55 0 0 1 130 80" />
<path class="gauge-fill" id="fmGauge" d="M 20 80 A 55 55 0 0 1 130 80" stroke="#10b981" style="stroke-dasharray:173;stroke-dashoffset:130" />
<text class="gauge-value" x="75" y="70" id="fmGaugeValue">0.25</text>
<text class="gauge-label" x="75" y="85">lb BOD/lb MLVSS/day</text>
</svg>
</div>
<div class="status-badge optimal" id="fmStatus">‚úì Optimal</div>
<div style="margin-top:8px;font-size:11px;color:#64748b">Target: 0.2 - 0.5</div>
</div>

<div class="calc-result-card" id="sviCard">
<div class="label">SVI</div>
<div class="gauge-container">
<svg viewBox="0 0 150 90" style="width:100%;height:auto">
<path class="gauge-bg" d="M 20 80 A 55 55 0 0 1 130 80" />
<path class="gauge-fill" id="sviGauge" d="M 20 80 A 55 55 0 0 1 130 80" stroke="#10b981" style="stroke-dasharray:173;stroke-dashoffset:100" />
<text class="gauge-value" x="75" y="70" id="sviGaugeValue">120</text>
<text class="gauge-label" x="75" y="85">mL/g</text>
</svg>
</div>
<div class="status-badge optimal" id="sviStatus">‚úì Good Settling</div>
<div style="margin-top:8px;font-size:11px;color:#64748b">Target: 80 - 150</div>
</div>

<div class="calc-result-card" id="srtCard">
<div class="label">SRT (Sludge Age)</div>
<div class="gauge-container">
<svg viewBox="0 0 150 90" style="width:100%;height:auto">
<path class="gauge-bg" d="M 20 80 A 55 55 0 0 1 130 80" />
<path class="gauge-fill" id="srtGauge" d="M 20 80 A 55 55 0 0 1 130 80" stroke="#10b981" style="stroke-dasharray:173;stroke-dashoffset:86" />
<text class="gauge-value" x="75" y="70" id="srtGaugeValue">10</text>
<text class="gauge-label" x="75" y="85">days</text>
</svg>
</div>
<div class="status-badge optimal" id="srtStatus">‚úì Optimal</div>
<div style="margin-top:8px;font-size:11px;color:#64748b">Target: 5 - 15 days</div>
</div>

<div class="calc-result-card" id="mlssCard">
<div class="label">MLSS Inventory</div>
<div class="value" id="mlssInvValue">25,000</div>
<div class="unit">lbs</div>
<div class="status-badge optimal" id="mlssStatus">‚úì Normal</div>
<div style="margin-top:8px;font-size:11px;color:#64748b;display:flex;justify-content:center;align-items:center;gap:4px">
<span class="trend-arrow trend-stable">‚Üí</span> Stable
</div>
</div>

</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:24px">

<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
‚è±Ô∏è Detention Time Calculator
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">Tank Volume</label>
<input id="dt_volume" type="number" step="0.1" value="1.0" oninput="calcDetentionTime()" style="font-size:14px">
<span style="font-size:11px;color:#64748b" id="dt_vol_unit">MG</span>
</div>
<div class="input-group">
<label style="font-size:13px">Flow Rate</label>
<input id="dt_flow" type="number" step="0.1" value="3.5" oninput="calcDetentionTime()" style="font-size:14px">
<span style="font-size:11px;color:#64748b" id="dt_flow_unit">MGD</span>
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Detention Time</div>
<div style="font-size:20px;font-weight:bold;color:white" id="dt_result">6.86</div>
<div style="font-size:13px;color:#64748b" id="dt_result_unit">hours</div>
</div>
<div class="formula-box" id="dt_formula">HRT = (Volume √ó 24) / Flow = (1.0 MG √ó 24) / 3.5 MGD = 6.86 hrs</div>
</div>

<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
üìê Surface Overflow Rate
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">Flow Rate</label>
<input id="sor_flow" type="number" step="0.1" value="3.5" oninput="calcSOR()" style="font-size:14px">
<span style="font-size:11px;color:#64748b">MGD</span>
</div>
<div class="input-group">
<label style="font-size:13px">Clarifier Diameter</label>
<input id="sor_dia" type="number" step="1" value="80" oninput="calcSOR()" style="font-size:14px">
<span style="font-size:11px;color:#64748b">ft</span>
</div>
<div class="input-group">
<label style="font-size:13px"># Clarifiers</label>
<input id="sor_num" type="number" step="1" value="2" oninput="calcSOR()" style="font-size:14px">
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Surface Overflow Rate</div>
<div style="font-size:20px;font-weight:bold" id="sor_result" style="color:#10b981">348</div>
<div style="font-size:13px;color:#64748b">GPD/sq ft</div>
<div style="font-size:11px;margin-top:4px" id="sor_status" style="color:#10b981">‚úì Good (300-800 typical)</div>
</div>
<div class="formula-box" id="sor_formula">SOR = Flow / Area = 3,500,000 GPD / 10,053 sq ft = 348 GPD/ft¬≤</div>
</div>

<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
üåä Weir Loading Rate
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">Flow Rate</label>
<input id="weir_flow" type="number" step="0.1" value="3.5" oninput="calcWeirLoading()" style="font-size:14px">
<span style="font-size:11px;color:#64748b">MGD</span>
</div>
<div class="input-group">
<label style="font-size:13px">Weir Length</label>
<input id="weir_length" type="number" step="1" value="500" oninput="calcWeirLoading()" style="font-size:14px">
<span style="font-size:11px;color:#64748b">ft</span>
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Weir Loading</div>
<div style="font-size:20px;font-weight:bold" id="weir_result" style="color:#10b981">7,000</div>
<div style="font-size:13px;color:#64748b">GPD/ft</div>
<div style="font-size:11px;margin-top:4px" id="weir_status" style="color:#10b981">‚úì Good (&lt;10,000 typical)</div>
</div>
<div class="formula-box" id="weir_formula">WLR = Flow / Weir Length = 3,500,000 / 500 = 7,000 GPD/ft</div>
</div>

<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
üí® Oxygen Requirement
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">BOD Removed (lb/d)</label>
<input id="o2_bod" type="number" step="100" value="5000" oninput="calcOxygenReq()" style="font-size:14px">
</div>
<div class="input-group">
<label style="font-size:13px">TKN Oxidized (lb/d)</label>
<input id="o2_tkn" type="number" step="10" value="400" oninput="calcOxygenReq()" style="font-size:14px">
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Oxygen Required</div>
<div style="font-size:20px;font-weight:bold;color:white" id="o2_result">8,320</div>
<div style="font-size:13px;color:#64748b">lb O‚ÇÇ/day</div>
<div style="font-size:11px;margin-top:4px;color:#94a3b8" id="o2_hourly">347 lb/hr</div>
</div>
<div class="formula-box" id="o2_formula">O‚ÇÇ = 1.5√óBOD + 4.6√óTKN = 1.5√ó5000 + 4.6√ó400 = 8,320 lb/d</div>
</div>

<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
üí∞ Chemical Cost Calculator
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">Flow (MGD)</label>
<input id="chem_flow" type="number" step="0.1" value="3.5" oninput="calcChemCost()" style="font-size:14px">
</div>
<div class="input-group">
<label style="font-size:13px">Dose (mg/L)</label>
<input id="chem_dose" type="number" step="1" value="50" oninput="calcChemCost()" style="font-size:14px">
</div>
<div class="input-group">
<label style="font-size:13px">Cost ($/lb)</label>
<input id="chem_cost" type="number" step="0.01" value="0.25" oninput="calcChemCost()" style="font-size:14px">
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Daily Chemical Cost</div>
<div style="font-size:20px;font-weight:bold;color:#fbbf24" id="chem_daily">$365</div>
<div style="font-size:13px;color:#64748b">per day</div>
<div style="font-size:11px;margin-top:4px;color:#94a3b8" id="chem_monthly">$10,950/month ‚Ä¢ $133,225/year</div>
</div>
<div class="formula-box" id="chem_formula">lbs/d = Flow √ó Dose √ó 8.34 = 3.5 √ó 50 √ó 8.34 = 1,460 lb/d √ó $0.25 = $365/d</div>
</div>

<div style="background:rgba(255,255,255,0.05);padding:20px;border-radius:12px;border:1px solid rgba(255,255,255,0.1)">
<h4 style="margin:0 0 16px 0;color:#60a5fa;display:flex;align-items:center;gap:8px">
üìÖ SRT / Sludge Age
<span style="font-size:11px;background:#3b82f6;padding:2px 8px;border-radius:10px;color:white">Auto</span>
</h4>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">Aeration Vol (MG)</label>
<input id="srt_vol" type="number" step="0.1" value="1.0" oninput="calcSRT()" style="font-size:14px">
</div>
<div class="input-group">
<label style="font-size:13px">MLSS (mg/L)</label>
<input id="srt_mlss" type="number" step="100" value="3000" oninput="calcSRT()" style="font-size:14px">
</div>
</div>
<div class="row" style="gap:12px;margin-bottom:12px">
<div class="input-group">
<label style="font-size:13px">WAS Flow (GPD)</label>
<input id="srt_was" type="number" step="1000" value="25000" oninput="calcSRT()" style="font-size:14px">
</div>
<div class="input-group">
<label style="font-size:13px">WAS TSS (mg/L)</label>
<input id="srt_wastss" type="number" step="100" value="8000" oninput="calcSRT()" style="font-size:14px">
</div>
</div>
<div style="background:#1e3a5f;padding:16px;border-radius:10px;text-align:center">
<div style="font-size:13px;color:#94a3b8">Sludge Retention Time</div>
<div style="font-size:20px;font-weight:bold" id="srt_result" style="color:#10b981">15.0</div>
<div style="font-size:13px;color:#64748b">days</div>
<div style="font-size:11px;margin-top:4px" id="srt_status" style="color:#10b981">‚úì Good for nitrification</div>
</div>
<div class="formula-box" id="srt_formula">SRT = (Vol √ó MLSS √ó 8.34) / (WAS √ó WAS_TSS √ó 8.34)</div>
</div>

</div>

<div id="calcHistoryModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:99999;padding:20px;overflow-y:auto">
<div style="max-width:600px;margin:0 auto;background:#1e1b4b;border-radius:16px;padding:24px;border:3px solid #6366f1">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h3 style="margin:0;color:white">üìú Calculation History</h3>
<button onclick="closeCalcHistory()" style="background:#ef4444;border:none;color:white;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:18px">‚úï</button>
</div>
<div id="calcHistoryList" style="max-height:60vh;overflow-y:auto">
<p style="color:#94a3b8;text-align:center">No saved calculations yet.</p>
</div>
<div style="margin-top:20px;display:flex;gap:10px">
<button onclick="clearCalcHistory()" class="btn" style="background:#ef4444;color:white;flex:1">üóëÔ∏è Clear History</button>
<button onclick="exportCalcHistory()" class="btn" style="background:#10b981;color:white;flex:1">üì§ Export CSV</button>
</div>
</div>
</div>

<div id="compareModePanel" style="display:none;background:rgba(99,102,241,0.1);border:2px solid #6366f1;border-radius:12px;padding:20px;margin-top:20px">
<h4 style="margin:0 0 16px 0;color:#a5b4fc">‚öñÔ∏è Compare Mode - Side by Side Analysis</h4>
<div class="compare-grid">
<div class="compare-column">
<h4 style="color:#60a5fa">Scenario A (Current)</h4>
<div id="compareA">Values will appear here...</div>
</div>
<div class="compare-column">
<h4 style="color:#f59e0b">Scenario B (What-If)</h4>
<div id="compareB">Adjust values to compare...</div>
</div>
</div>
</div>

</div>
</div>

</div>
<div class="panel" id="aeration">
<div id="AERATION_HEADER_MARKER" style="background:linear-gradient(135deg,#06b6d4 0%,#22d3ee 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üí® AERATION & ENERGY</h2>
</div>
<div style="background:linear-gradient(135deg,#0077b6 0%,#0096c7 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üí® Aeration & Energy</h2>
<p style="margin:0;opacity:0.9">Oxygen transfer, blower performance, and energy optimization</p>
</div>

<div class="section">
<div class="section-h">üí® Oxygen Transfer Efficiency (OTE)</div>
<div class="section-content">
<div class="note info">Calculate actual oxygen transfer rate from standard conditions</div>
<div class="row">
<div class="input-group"><label>SOTR (lb O‚ÇÇ/hr)</label><input type="number" id="aer_sotr" value="150" step="10"></div>
<div class="input-group"><label>Water Temp (¬∞C)</label><input type="number" id="aer_temp" value="20" step="1"></div>
<div class="input-group"><label>Operating DO (mg/L)</label><input type="number" id="aer_do" value="2.0" step="0.1"></div>
<div class="input-group"><label>Saturation DO (mg/L)</label><input type="number" id="aer_do_sat" value="9.1" step="0.1"></div>
<div class="input-group"><label>Alpha Factor</label><input type="number" id="aer_alpha" value="0.85" step="0.05"></div>
<div class="input-group"><label>Beta Factor</label><input type="number" id="aer_beta" value="0.95" step="0.05"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcAOTR()">üí® Calculate AOTR</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td class="rowh">Theta Correction</td><td><span class="result" id="r_aer_theta">-</span></td><td></td></tr>
<tr><td class="rowh">AOTR</td><td><span class="result" id="r_aer_aotr">-</span></td><td>lb O‚ÇÇ/hr</td></tr>
<tr><td class="rowh">Transfer Efficiency</td><td><span class="result" id="r_aer_eff">-</span></td><td>%</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üåÄ Blower Performance</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Air Flow Required (SCFM)</label><input type="number" id="aer_scfm" value="5000" step="100"></div>
<div class="input-group"><label>Discharge Pressure (psig)</label><input type="number" id="aer_psi" value="8" step="0.5"></div>
<div class="input-group"><label>Inlet Temp (¬∞F)</label><input type="number" id="aer_inlet_temp" value="70" step="5"></div>
<div class="input-group"><label>Blower Efficiency (%)</label><input type="number" id="aer_blower_eff" value="70" step="5"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcBlowerPower()">üåÄ Calculate Power</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td class="rowh">Brake HP</td><td><span class="result" id="r_blower_bhp">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Motor HP (w/ SF)</td><td><span class="result" id="r_blower_motor">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Power Draw</td><td><span class="result" id="r_blower_kw">-</span></td><td>kW</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">‚ö° Energy Cost Analysis</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Blower Power (HP)</label><input id="eng_blower_hp" type="number" value="200" step="10"></div>
<div class="input-group"><label>Pump Power (HP)</label><input id="eng_pump_hp" type="number" value="100" step="10"></div>
<div class="input-group"><label>Other Equipment (HP)</label><input id="eng_other_hp" type="number" value="50" step="10"></div>
<div class="input-group"><label>Hours/Day Operating</label><input id="eng_hours" type="number" value="24" step="1"></div>
<div class="input-group"><label>Electricity Rate ($/kWh)</label><input id="eng_rate" type="number" value="0.12" step="0.01"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcEnergyUse()">‚ö° Calculate Energy</button>
</div>
<div class="kpi-grid" style="margin-top:15px">
<div class="kpi-card"><h4>Daily kWh</h4><p id="r_eng_daily">-</p></div>
<div class="kpi-card"><h4>Monthly Cost</h4><p id="r_eng_monthly">-</p></div>
<div class="kpi-card"><h4>Annual Cost</h4><p id="r_eng_annual">-</p></div>
<div class="kpi-card"><h4>kWh/MG</h4><p id="r_eng_intensity">-</p></div>
</div>
</div>
</div>

</div>

<div class="panel" id="chemicals">
<div id="CHEMICALS_HEADER_MARKER" style="background:linear-gradient(135deg,#84cc16 0%,#a3e635 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üß™ CHEMICAL SYSTEMS</h2>
</div>
<div style="background:linear-gradient(135deg,#0096c7 0%,#5b21b6 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px">
<div>
<h2 style="margin:0 0 8px 0;font-size:20px">‚öóÔ∏è Chemical Systems</h2>
<p style="margin:0;opacity:0.9">Chemical feed optimization, dosing calculations, and disinfection</p>
</div>
<button class="btn" onclick="resetAllChemicals()" style="background:rgba(255,255,255,0.2);border:2px solid white;color:white;font-weight:bold">üîÑ Reset All Calculators</button>
</div>
</div>

<div class="section">
<div class="section-h">üéØ Chemical Feed Optimizer</div>
<div class="section-content">
<div class="note info">Optimize coagulant/flocculant dosing for phosphorus removal</div>
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="chem_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Influent P (mg/L)</label><input type="number" id="chem_p_in" value="6.0" step="0.5"></div>
<div class="input-group"><label>Target P (mg/L)</label><input type="number" id="chem_p_target" value="1.0" step="0.1"></div>
<div class="input-group"><label>Chemical Type</label>
<select id="chem_type">
<option value="alum">Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ)</option>
<option value="ferric">Ferric Chloride (FeCl‚ÇÉ)</option>
<option value="pac">PAC (Polyaluminum Chloride)</option>
</select>
</div>
<div class="input-group"><label>Solution Strength (%)</label><input type="number" id="chem_strength" value="48" step="1"></div>
<div class="input-group"><label>Chemical Cost ($/gal)</label><input type="number" id="chem_cost" value="2.50" step="0.10"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcChemFeed()">üéØ Optimize Feed Rate</button>
</div>
<div class="kpi-grid" style="margin-top:15px">
<div class="kpi-card"><h4>Me:P Ratio</h4><p id="r_chem_ratio">-</p></div>
<div class="kpi-card"><h4>Dose (mg/L)</h4><p id="r_chem_dose">-</p></div>
<div class="kpi-card"><h4>Feed Rate (gpd)</h4><p id="r_chem_gpd">-</p></div>
<div class="kpi-card"><h4>Daily Cost</h4><p id="r_chem_daily_cost">-</p></div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">‚ò£Ô∏è Chlorine Disinfection</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="cl_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Target Dose (mg/L)</label><input type="number" id="cl_dose" value="5.0" step="0.5"></div>
<div class="input-group"><label>Solution Strength (%)</label><input type="number" id="cl_strength" value="12.5" step="0.5"></div>
<div class="input-group"><label>Contact Time (min)</label><input type="number" id="cl_contact" value="30" step="5"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcChlorine()">‚ò£Ô∏è Calculate Chlorine</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td class="rowh">Cl‚ÇÇ Required</td><td><span class="result" id="r_cl_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_cl_gpd">-</span></td><td>gpd</td></tr>
<tr><td class="rowh">CT Value</td><td><span class="result" id="r_cl_ct">-</span></td><td>mg¬∑min/L</td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="jarTestSection" style="border:2px solid #f59e0b">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white">
üß´ Jar Test Optimizer
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Coagulant & Polymer</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Record jar test results to determine optimal chemical doses and costs.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">‚öôÔ∏è Test Setup</h4>
<div class="row">
<div class="input-group">
<label style="color:#fbbf24">Sample Source</label>
<select id="jt_source" style="font-size:14px">
<option value="raw">Raw Influent</option>
<option value="primary">Primary Effluent</option>
<option value="secondary">Secondary Effluent</option>
<option value="sidestream">Sidestream</option>
</select>
</div>
<div class="input-group">
<label style="color:#fbbf24">Coagulant Type</label>
<select id="jt_coag_type" style="font-size:14px" onchange="updateCoagCost()">
<option value="alum">Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ)</option>
<option value="ferric">Ferric Chloride (FeCl‚ÇÉ)</option>
<option value="ferrous">Ferrous Sulfate (FeSO‚ÇÑ)</option>
<option value="pac">PAC (Polyaluminum Chloride)</option>
<option value="sodium_aluminate">Sodium Aluminate</option>
</select>
</div>
<div class="input-group">
<label style="color:#fbbf24">Coagulant Cost ($/lb)</label>
<input type="number" id="jt_coag_cost" value="0.15" step="0.01">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Polymer Type</label>
<select id="jt_poly_type" style="font-size:14px">
<option value="none">None</option>
<option value="cationic">Cationic</option>
<option value="anionic">Anionic</option>
<option value="nonionic">Nonionic</option>
</select>
</div>
<div class="input-group">
<label>Polymer Cost ($/lb)</label>
<input type="number" id="jt_poly_cost" value="2.50" step="0.10">
</div>
<div class="input-group">
<label>Plant Flow (MGD)</label>
<input type="number" id="jt_plant_flow" value="5.0" step="0.1">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Initial Turbidity (NTU)</label>
<input type="number" id="jt_init_turb" value="25" step="1">
</div>
<div class="input-group">
<label>Initial pH</label>
<input type="number" id="jt_init_ph" value="7.2" step="0.1">
</div>
<div class="input-group">
<label>Target Turbidity (NTU)</label>
<input type="number" id="jt_target_turb" value="5" step="1">
</div>
</div>
<div class="row">
<div class="input-group">
<label style="color:#60a5fa">Jar Volume (mL)</label>
<select id="jt_jar_vol" style="font-size:14px" onchange="calcSyringeDoses()">
<option value="1000">1000 mL (1 L)</option>
<option value="2000" selected>2000 mL (2 L)</option>
</select>
</div>
<div class="input-group">
<label style="color:#60a5fa">Stock Solution (%)</label>
<input type="number" id="jt_stock_pct" value="1.0" step="0.1" onchange="calcSyringeDoses()">
<small style="opacity:0.7">1% = 10,000 mg/L</small>
</div>
<div class="input-group">
<label style="color:#60a5fa">Syringe Size</label>
<select id="jt_syringe" style="font-size:14px">
<option value="5">5 mL</option>
<option value="10" selected>10 mL</option>
<option value="20">20 mL</option>
</select>
</div>
</div>

<div style="margin-top:15px;padding:12px;background:#0d3a5c;border-radius:8px;border:1px solid #60a5fa">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
<div><strong style="color:#60a5fa">üíâ Syringe Dose Calculator</strong></div>
<button class="btn" style="padding:5px 12px;font-size:12px" onclick="calcSyringeDoses()">üìä Calculate mL to Add</button>
</div>
<div id="jt_syringe_results" style="margin-top:10px;font-size:13px"></div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üß™ Jar Test Results (6 Jars)</h4>
<div class="note info" style="margin-bottom:15px">Enter coagulant dose and results for each jar. Leave unused jars blank.</div>

<div style="overflow-x:auto">
<table class="table" style="font-size:13px;min-width:700px">
<thead>
<tr>
<th style="width:60px">Jar #</th>
<th>Coag Dose<br>(mg/L)</th>
<th>Polymer<br>(mg/L)</th>
<th>Flash Mix<br>pH</th>
<th>Floc Size<br>(1-5)</th>
<th>Settle Time<br>(min)</th>
<th>Final Turb<br>(NTU)</th>
<th>Final pH</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">1</td>
<td><input type="number" id="jt_1_coag" value="10" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_1_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_1_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_1_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_1_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_1_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_1_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">2</td>
<td><input type="number" id="jt_2_coag" value="20" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_2_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_2_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_2_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_2_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_2_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_2_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">3</td>
<td><input type="number" id="jt_3_coag" value="30" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_3_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_3_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_3_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_3_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_3_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_3_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">4</td>
<td><input type="number" id="jt_4_coag" value="40" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_4_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_4_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_4_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_4_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_4_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_4_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">5</td>
<td><input type="number" id="jt_5_coag" value="50" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_5_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_5_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_5_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_5_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_5_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_5_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
<tr>
<td style="text-align:center;font-weight:bold;color:#fbbf24">6</td>
<td><input type="number" id="jt_6_coag" value="60" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_6_poly" value="0" step="0.1" style="width:70px;text-align:center"></td>
<td><input type="number" id="jt_6_ph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
<td><select id="jt_6_floc" style="width:70px"><option value="">-</option><option value="1">1-Pin</option><option value="2">2-Small</option><option value="3">3-Med</option><option value="4">4-Large</option><option value="5">5-XL</option></select></td>
<td><input type="number" id="jt_6_settle" value="15" style="width:60px;text-align:center"></td>
<td><input type="number" id="jt_6_turb" value="" step="0.1" style="width:70px;text-align:center" placeholder="-"></td>
<td><input type="number" id="jt_6_fph" value="" step="0.1" style="width:60px;text-align:center" placeholder="-"></td>
</tr>
</tbody>
</table>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="analyzeJarTest()">üß´ Analyze Results</button>
<button class="btn blue" onclick="showJarTestChart()">üìà Show Dose Curve</button>
<button class="btn green" onclick="saveJarTest()">üíæ Save Test</button>
<button class="btn gray" onclick="resetJarTest()">üîÑ Reset</button>
</div>

<div id="jt_results" style="margin-top:20px"></div>

<div id="jt_chart_container" style="display:none;margin-top:20px;background:#1e3a5f;padding:15px;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#60a5fa">üìà Dose-Response Curve</h4>
<canvas id="jarTestChart" height="200"></canvas>
</div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#f59e0b">üìö Jar Test Reference Guide</h4>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
<div style="background:#243b55;padding:12px;border-radius:8px">
<strong style="color:#4ade80">Floc Size Scale:</strong>
<div style="font-size:12px;margin-top:5px">
1 = Pin floc (poor)<br>
2 = Small, slow settling<br>
3 = Medium, good<br>
4 = Large, fast settling<br>
5 = Extra large, excellent
</div>
</div>
<div style="background:#243b55;padding:12px;border-radius:8px">
<strong style="color:#4ade80">Typical Doses:</strong>
<div style="font-size:12px;margin-top:5px">
Alum: 10-50 mg/L<br>
Ferric: 10-50 mg/L<br>
PAC: 5-30 mg/L<br>
Polymer: 0.5-3 mg/L
</div>
</div>
<div style="background:#243b55;padding:12px;border-radius:8px">
<strong style="color:#4ade80">Optimal pH Ranges:</strong>
<div style="font-size:12px;margin-top:5px">
Alum: 5.5-7.5<br>
Ferric: 4.0-9.0<br>
PAC: 5.0-8.5<br>
Lime: >10.5
</div>
</div>
</div>
</div>

</div>
</div>

<div class="section">
<div class="section-h">üíä Polymer Dosing</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sludge Flow (gpm)</label><input type="number" id="poly_flow" value="50" step="5"></div>
<div class="input-group"><label>Sludge Solids (%)</label><input type="number" id="poly_solids" value="3.0" step="0.1"></div>
<div class="input-group"><label>Target Dose (lb/DT)</label><input type="number" id="poly_dose" value="12" step="1"></div>
<div class="input-group"><label>Polymer Solution (%)</label><input type="number" id="poly_conc" value="0.5" step="0.1"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcPolymer()">üíä Calculate Polymer</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td class="rowh">Dry Tons/Day</td><td><span class="result" id="r_poly_dt">-</span></td><td>DT/day</td></tr>
<tr><td class="rowh">Polymer Required</td><td><span class="result" id="r_poly_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_poly_gpm">-</span></td><td>gpm</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">‚öóÔ∏è Alkalinity Adjustment</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="alk_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Current Alk (mg/L as CaCO‚ÇÉ)</label><input type="number" id="alk_current" value="120" step="10"></div>
<div class="input-group"><label>Target Alk (mg/L as CaCO‚ÇÉ)</label><input type="number" id="alk_target" value="200" step="10"></div>
<div class="input-group"><label>Chemical</label>
<select id="alk_chem">
<option value="naoh">Caustic (NaOH 50%)</option>
<option value="lime">Lime (Ca(OH)‚ÇÇ)</option>
<option value="soda">Soda Ash (Na‚ÇÇCO‚ÇÉ)</option>
</select>
</div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcAlkalinity()">‚öóÔ∏è Calculate Dose</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td class="rowh">Alk Increase Needed</td><td><span class="result" id="r_alk_increase">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Chemical Required</td><td><span class="result" id="r_alk_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Feed</td><td><span class="result" id="r_alk_gpd">-</span></td><td>gpd</td></tr>
</tbody></table>
</div>
</div>

</div>

<div class="panel" id="maintenance">
<div id="MAINTENANCE_HEADER_MARKER" style="background:linear-gradient(135deg,#a855f7 0%,#c084fc 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üîß MAINTENANCE</h2>
</div>
<div style="background:linear-gradient(135deg,#475569 0%,#243b55 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üîß Maintenance</h2>
<p style="margin:0;opacity:0.9">Equipment tracking, PM schedules, and calibration management</p>
</div>

<div class="section">
<div class="section-h">üìÖ Preventive Maintenance Schedule</div>
<div class="section-content">
<div class="note info">Track equipment maintenance schedules and upcoming tasks</div>
<table class="table">
<thead><tr><th>Equipment</th><th>Last Service</th><th>Interval</th><th>Next Due</th><th>Status</th></tr></thead>
<tbody>
<tr><td>Blower #1</td><td>2024-11-15</td><td>Monthly</td><td>2024-12-15</td><td><span class="status warn">Due Soon</span></td></tr>
<tr><td>RAS Pump #1</td><td>2024-10-01</td><td>Quarterly</td><td>2025-01-01</td><td><span class="status good">OK</span></td></tr>
<tr><td>Clarifier Drive</td><td>2024-09-01</td><td>Semi-Annual</td><td>2025-03-01</td><td><span class="status good">OK</span></td></tr>
<tr><td>UV System</td><td>2024-11-01</td><td>Monthly</td><td>2024-12-01</td><td><span class="status bad">Overdue</span></td></tr>
</tbody>
</table>
</div>
</div>

<div class="section">
<div class="section-h">üî¨ Calibration Tracking</div>
<div class="section-content">
<table class="table">
<thead><tr><th>Instrument</th><th>Location</th><th>Last Cal</th><th>Due</th><th>Status</th></tr></thead>
<tbody>
<tr><td>DO Probe #1</td><td>Aeration Basin</td><td>2024-11-20</td><td>2024-12-20</td><td><span class="status good">OK</span></td></tr>
<tr><td>pH Analyzer</td><td>Effluent</td><td>2024-11-25</td><td>2024-12-25</td><td><span class="status good">OK</span></td></tr>
<tr><td>Flow Meter</td><td>Influent</td><td>2024-06-01</td><td>2024-12-01</td><td><span class="status bad">Overdue</span></td></tr>
<tr><td>Turbidity</td><td>Effluent</td><td>2024-11-01</td><td>2024-12-01</td><td><span class="status warn">Due Soon</span></td></tr>
</tbody>
</table>
</div>
</div>

<div class="section">
<div class="section-h">üõ†Ô∏è Work Order Log</div>
<div class="section-content">
<div class="btns" style="margin-bottom:15px">
<button class="btn gradient" onclick="showAddWorkOrder()">‚ûï New Work Order</button>
<button class="btn blue" onclick="filterWO('open')">Open</button>
<button class="btn green" onclick="filterWO('complete')">Complete</button>
<button class="btn gray" onclick="filterWO('all')">All</button>
</div>
<div id="workOrderList">
<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #ffd166">
<div style="display:flex;justify-content:space-between"><strong>WO-2024-142</strong><span class="status warn">In Progress</span></div>
<div style="color:#94a3b8;margin-top:5px">Blower #2 bearing replacement</div>
<div style="color:#64748b;font-size:12px;margin-top:5px">Assigned: John D. | Due: 12/10/2024</div>
</div>
<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #ef4444">
<div style="display:flex;justify-content:space-between"><strong>WO-2024-143</strong><span class="status bad">Urgent</span></div>
<div style="color:#94a3b8;margin-top:5px">UV lamp replacement - Bank A</div>
<div style="color:#64748b;font-size:12px;margin-top:5px">Assigned: Mike S. | Due: 12/08/2024</div>
</div>
</div>
</div>
</div>

</div>

<div class="panel" id="reports">
<div id="REPORTS_HEADER_MARKER" style="background:linear-gradient(135deg,#6366f1 0%,#818cf8 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìë REPORTS</h2>
</div>

<div class="section" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);border-radius:12px;margin-bottom:20px">
<div class="section-h" style="color:white;font-size:18px;font-weight:bold">
üè¢ Company Branding
</div>
<div class="section-content" style="background:rgba(0,0,0,0.2);border-radius:0 0 12px 12px">
<div class="row" style="gap:15px">
<div class="input-group">
<label style="color:#bae6fd">Company Name</label>
<input type="text" id="rpt_company" value="Frazier Environmental Consulting" style="font-size:15px">
</div>
<div class="input-group">
<label style="color:#bae6fd">Consultant Name</label>
<input type="text" id="rpt_consultant" placeholder="Your Name" style="font-size:15px">
</div>
</div>
<div class="row" style="gap:15px;margin-top:10px">
<div class="input-group">
<label style="color:#bae6fd">Phone</label>
<input type="tel" id="rpt_phone" placeholder="(555) 123-4567" style="font-size:15px">
</div>
<div class="input-group">
<label style="color:#bae6fd">Email</label>
<input type="email" id="rpt_email" placeholder="email@company.com" style="font-size:15px">
</div>
<div class="input-group">
<label style="color:#bae6fd">License #</label>
<input type="text" id="rpt_license" placeholder="TCEQ License #" style="font-size:15px">
</div>
</div>
<div class="btns" style="margin-top:15px;gap:10px">
<button onclick="saveBrandingSettings()" class="btn" style="background:#047857;color:white">üíæ Save Branding</button>
<button onclick="loadBrandingSettings()" class="btn" style="background:#6366f1;color:white">üìÇ Load Saved</button>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üìÑ Select Report Type</div>
<div class="section-content">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px">

<div class="report-card" onclick="selectReportType('daily')" id="rptCard_daily" style="background:linear-gradient(135deg,#059669,#10b981);padding:20px;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.3s">
<div style="font-size:36px;margin-bottom:10px">üìÖ</div>
<h4 style="margin:0 0 8px 0;color:white">Daily Operations Report</h4>
<p style="margin:0;font-size:13px;color:rgba(255,255,255,0.8)">Date, plant values, checklist status, daily notes, operator signature</p>
</div>

<div class="report-card" onclick="selectReportType('process')" id="rptCard_process" style="background:linear-gradient(135deg,#f97316,#fb923c);padding:20px;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.3s">
<div style="font-size:36px;margin-bottom:10px">‚öôÔ∏è</div>
<h4 style="margin:0 0 8px 0;color:white">Process Summary Report</h4>
<p style="margin:0;font-size:13px;color:rgba(255,255,255,0.8)">All calculator results, status indicators, formulas used</p>
</div>

<div class="report-card" onclick="selectReportType('visit')" id="rptCard_visit" style="background:linear-gradient(135deg,#8b5cf6,#a78bfa);padding:20px;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.3s">
<div style="font-size:36px;margin-bottom:10px">üè≠</div>
<h4 style="margin:0 0 8px 0;color:white">Client Visit Report</h4>
<p style="margin:0;font-size:13px;color:rgba(255,255,255,0.8)">Plant profile, findings, recommendations, action items</p>
</div>

<div class="report-card" onclick="selectReportType('calc')" id="rptCard_calc" style="background:linear-gradient(135deg,#0ea5e9,#38bdf8);padding:20px;border-radius:12px;cursor:pointer;border:3px solid transparent;transition:all 0.3s">
<div style="font-size:36px;margin-bottom:10px">üßÆ</div>
<h4 style="margin:0 0 8px 0;color:white">Calculation Report</h4>
<p style="margin:0;font-size:13px;color:rgba(255,255,255,0.8)">All inputs, outputs, formulas, with professional formatting</p>
</div>

</div>
</div>
</div>

<div class="section" id="reportConfigSection" style="display:none">
<div class="section-h" id="reportConfigTitle">üìã Report Configuration</div>
<div class="section-content">

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="color:#60a5fa;margin:0 0 12px 0">üè≠ Plant Information</h4>
<div class="row" style="gap:12px">
<div class="input-group">
<label>Plant Name</label>
<input type="text" id="rpt_plant" placeholder="Enter plant name or load from profile">
</div>
<div class="input-group">
<label>Client/Owner</label>
<input type="text" id="rpt_client" placeholder="Client name">
</div>
<div class="input-group">
<label>Permit #</label>
<input type="text" id="rpt_permit" placeholder="TPDES/NPDES #">
</div>
</div>
<div class="row" style="gap:12px;margin-top:10px">
<div class="input-group">
<label>Report Date</label>
<input type="date" id="rpt_date">
</div>
<div class="input-group">
<label>Process Type</label>
<select id="rpt_process">
<option value="Conventional AS">Conventional Activated Sludge</option>
<option value="Extended Aeration">Extended Aeration</option>
<option value="SBR">SBR</option>
<option value="MBR">MBR</option>
<option value="MBBR">MBBR</option>
<option value="Oxidation Ditch">Oxidation Ditch</option>
<option value="Other">Other</option>
</select>
</div>
<div class="input-group">
<label>Design Flow (MGD)</label>
<input type="number" id="rpt_designflow" step="0.1" placeholder="Design capacity">
</div>
</div>
<button onclick="loadProfileToReport()" class="btn" style="background:#7c3aed;color:white;margin-top:10px">üè≠ Load from Profile</button>
</div>

<div id="dailyFields" style="display:none;background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="color:#4ade80;margin:0 0 12px 0">üìÖ Daily Values</h4>
<div class="row" style="gap:12px">
<div class="input-group">
<label>Influent Flow (MGD)</label>
<input type="number" id="rpt_flow" step="0.1" value="3.5">
</div>
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="rpt_bod" step="1" value="200">
</div>
<div class="input-group">
<label>Influent TSS (mg/L)</label>
<input type="number" id="rpt_tss" step="1" value="220">
</div>
</div>
<div class="row" style="gap:12px;margin-top:10px">
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="rpt_mlss" step="100" value="3000">
</div>
<div class="input-group">
<label>DO (mg/L)</label>
<input type="number" id="rpt_do" step="0.1" value="2.0">
</div>
<div class="input-group">
<label>pH</label>
<input type="number" id="rpt_ph" step="0.1" value="7.2">
</div>
</div>
<div class="row" style="gap:12px;margin-top:10px">
<div class="input-group">
<label>Effluent BOD (mg/L)</label>
<input type="number" id="rpt_eff_bod" step="1" value="8">
</div>
<div class="input-group">
<label>Effluent TSS (mg/L)</label>
<input type="number" id="rpt_eff_tss" step="1" value="10">
</div>
<div class="input-group">
<label>Effluent NH‚ÇÉ (mg/L)</label>
<input type="number" id="rpt_eff_nh3" step="0.1" value="1.5">
</div>
</div>
<button onclick="loadMasterToReport()" class="btn" style="background:#059669;color:white;margin-top:10px">üéõÔ∏è Load from Master Settings</button>
</div>

<div id="visitFields" style="display:none;background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="color:#a78bfa;margin:0 0 12px 0">üè≠ Visit Details</h4>
<div class="row" style="gap:12px">
<div class="input-group">
<label>Visit Purpose</label>
<select id="rpt_purpose">
<option value="Routine Inspection">Routine Inspection</option>
<option value="Process Optimization">Process Optimization</option>
<option value="Troubleshooting">Troubleshooting</option>
<option value="Compliance Assistance">Compliance Assistance</option>
<option value="Training">Training</option>
<option value="Other">Other</option>
</select>
</div>
<div class="input-group">
<label>Time On-Site</label>
<input type="text" id="rpt_time" placeholder="e.g., 8:00 AM - 12:00 PM">
</div>
</div>
<div class="input-group" style="margin-top:10px">
<label>Key Findings</label>
<textarea id="rpt_findings" rows="3" placeholder="Summarize observations from site visit..." style="width:100%;resize:vertical"></textarea>
</div>
<div class="input-group" style="margin-top:10px">
<label>Recommendations</label>
<textarea id="rpt_recommendations" rows="3" placeholder="List recommended actions..." style="width:100%;resize:vertical"></textarea>
</div>
<div class="input-group" style="margin-top:10px">
<label>Action Items</label>
<textarea id="rpt_actions" rows="3" placeholder="Specific action items with responsible parties..." style="width:100%;resize:vertical"></textarea>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="color:#fbbf24;margin:0 0 12px 0">üìù Notes & Comments</h4>
<textarea id="rpt_notes" rows="4" placeholder="Additional notes for the report..." style="width:100%;resize:vertical"></textarea>
</div>

<div class="btns" style="gap:12px;flex-wrap:wrap">
<button onclick="previewReport()" class="btn" style="background:#6366f1;color:white;font-size:16px;padding:12px 24px">üëÅÔ∏è Preview Report</button>
<button onclick="generatePDFReport()" class="btn" style="background:#10b981;color:white;font-size:16px;padding:12px 24px">üìÑ Generate PDF</button>
<button onclick="printReport()" class="btn" style="background:#0ea5e9;color:white;font-size:16px;padding:12px 24px">üñ®Ô∏è Print</button>
</div>

</div>
</div>

<div id="reportPreviewArea" style="display:none;margin-top:20px">
<div class="section">
<div class="section-h" style="display:flex;justify-content:space-between;align-items:center">
<span>üëÅÔ∏è Report Preview</span>
<button onclick="closeReportPreview()" style="background:#ef4444;border:none;color:white;padding:6px 12px;border-radius:6px;cursor:pointer">‚úï Close</button>
</div>
<div class="section-content">
<div id="reportPreviewContent" style="background:white;color:#1e3a5f;padding:30px;border-radius:8px;max-height:70vh;overflow-y:auto">

</div>
</div>
</div>
</div>

<div class="section">
<div class="section-h">üì§ Quick Export</div>
<div class="section-content">
<div class="btns" style="gap:10px;flex-wrap:wrap">
<button onclick="exportAllCalculations()" class="btn" style="background:#059669;color:white">üìä Export All Calculations (CSV)</button>
<button onclick="exportDailyLog()" class="btn" style="background:#f97316;color:white">üìÖ Export Daily Log</button>
<button onclick="exportCalcHistory()" class="btn" style="background:#8b5cf6;color:white">üìú Export Calc History</button>
</div>
</div>
</div>

</div>
<div class="panel" id="hydraulics" data-panel-name="HYDRAULICS-PANEL">
<div id="HYDRAULICS_HEADER_MARKER" style="background:linear-gradient(135deg,#dc2626 0%,#f87171 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üìê HYDRAULICS</h2>
</div>

<div class="section">
<div class="section-h" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
<span>üßÆ Process Calculators</span>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button onclick="calculateAll()" style="background:#06d6a0;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">‚ö° Calc All</button>
<button onclick="resetAll()" style="background:#6b7280;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">üîÑ Reset All</button>
<button onclick="printPanel()" style="background:#00b4d8;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:12px">üñ®Ô∏è Print</button>
</div>
</div>
</div>

<div class="section" id="olrCalcSection">
<div class="section-h">üß´ Organic Loading Rate (OLR)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>BOD Concentration (mg/L)</label><input type="number" id="olr_bod" value="200"></div>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="olr_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="olr_vol" value="1.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcOLR()">Calculate OLR</button>
<button class="btn gray" onclick="resetOLR()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">BOD Loading</td><td><span class="result" id="r_olr_load">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Organic Loading Rate</td><td><span class="result" id="r_olr">-</span></td><td>lb BOD/1000 cf/day</td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="fmCalcSection">
<div class="section-h">‚öñÔ∏è F/M Ratio (Food to Microorganism)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>BOD Loading (lb/day)</label><input type="number" id="fm_bod" value="8340"></div>
<div class="input-group"><label>MLVSS (mg/L)</label><input type="number" id="fm_mlvss" value="2000"></div>
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="fm_vol" value="1.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcFM()">Calculate F/M</button>
<button class="btn gray" onclick="resetFM()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">MLVSS Mass</td><td><span class="result" id="r_fm_mass">-</span></td><td>lb</td></tr>
<tr><td class="rowh">F/M Ratio</td><td><span class="result" id="r_fm">-</span></td><td>lb BOD/lb MLVSS/day</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_fm_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">‚è±Ô∏è Sludge Retention Time (SRT)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="srt_mlss" value="3000"></div>
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="srt_vol" value="1.2" step="0.1"></div>
<div class="input-group"><label>WAS Flow (MGD)</label><input type="number" id="srt_was" value="0.05" step="0.01"></div>
<div class="input-group"><label>WAS TSS (mg/L)</label><input type="number" id="srt_was_tss" value="8000"></div>
<div class="input-group"><label>Effluent Flow (MGD)</label><input type="number" id="srt_eff" value="5.0" step="0.1"></div>
<div class="input-group"><label>Effluent TSS (mg/L)</label><input type="number" id="srt_eff_tss" value="10"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSRTmain()">Calculate SRT</button>
<button class="btn gray" onclick="resetSRTmain()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">System Solids</td><td><span class="result" id="r_srt_solids">-</span></td><td>lb</td></tr>
<tr><td class="rowh">Solids Wasted</td><td><span class="result" id="r_srt_wasted">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">SRT (Sludge Age)</td><td><span class="result" id="r_srt">-</span></td><td>days</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_srt_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üïê Hydraulic Detention Time (HRT)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Tank Volume (gallons)</label><input type="number" id="hrt_vol" value="500000"></div>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="hrt_flow" value="2.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcHRT()">Calculate HRT</button>
<button class="btn gray" onclick="resetHRT()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Detention Time</td><td><span class="result" id="r_hrt">-</span></td><td>hours</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_hrt_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üìâ BOD Removal Efficiency</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="bod_in" value="200"></div>
<div class="input-group"><label>Effluent BOD (mg/L)</label><input type="number" id="bod_out" value="10"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcBODeff()">Calculate Efficiency</button>
<div class="result-box" style="margin-top:10px;padding:10px;background:var(--bg-card);border-radius:8px">
<span>Removal Efficiency: </span><strong id="bod_eff_result">-</strong><span> %</span>
</div>
<button class="btn gray" onclick="resetBODeff()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">BOD Removed</td><td><span class="result" id="r_bod_removed">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Removal Efficiency</td><td><span class="result" id="r_bod_eff">-</span></td><td>%</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_bod_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="sviCalcSection">
<div class="section-h">üß™ Sludge Volume Index (SVI)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>30-min Settled Volume (mL/L)</label><input type="number" id="svi_vol" value="250"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="svi_mlss" value="3000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSVI()">Calculate SVI</button>
<button class="btn gray" onclick="resetSVI()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">SVI</td><td><span class="result" id="r_svi">-</span></td><td>mL/g</td></tr>
<tr><td class="rowh">Settling Quality</td><td><span class="result" id="r_svi_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üöø Waste Activated Sludge (WAS)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Target SRT (days)</label><input type="number" id="was_srt" value="10"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="was_mlss" value="3000"></div>
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="was_vol" value="1.0" step="0.1"></div>
<div class="input-group"><label>WAS Concentration (mg/L)</label><input type="number" id="was_conc" value="8000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcWAS()">Calculate WAS</button>
<button class="btn gray" onclick="resetWAS()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Required WAS Flow</td><td><span class="result" id="r_was_flow">-</span></td><td>GPD</td></tr>
<tr><td class="rowh">Solids Wasted</td><td><span class="result" id="r_was_lb">-</span></td><td>lb/day</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üîÑ Return Activated Sludge (RAS)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent Flow (MGD)</label><input type="number" id="ras_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="ras_mlss" value="3000"></div>
<div class="input-group"><label>RAS TSS (mg/L)</label><input type="number" id="ras_tss" value="8000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcRAS()">Calculate RAS</button>
<button class="btn gray" onclick="resetRAS()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">RAS Ratio</td><td><span class="result" id="r_ras_ratio">-</span></td><td>%</td></tr>
<tr><td class="rowh">RAS Flow</td><td><span class="result" id="r_ras_flow">-</span></td><td>MGD</td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="chlorineCalcSection">
<div class="section-h">‚ò£Ô∏è Chlorine Dosing</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="cl_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Target Dose (mg/L)</label><input type="number" id="cl_dose" value="5.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcChlorine()">Calculate Chlorine</button>
<button class="btn gray" onclick="resetChlorine()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Chlorine Required</td><td><span class="result" id="r_cl_lb">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution (12.5%)</td><td><span class="result" id="r_cl_gal">-</span></td><td>gal/day</td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="polymerCalcSection">
<div class="section-h">üíä Polymer Dosing</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sludge Flow (GPM)</label><input type="number" id="poly_flow" value="50"></div>
<div class="input-group"><label>Solids Concentration (%)</label><input type="number" id="poly_solids" value="1.0" step="0.1"></div>
<div class="input-group"><label>Dose Rate (lb/dry ton)</label><input type="number" id="poly_dose" value="8"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPolymer()">Calculate Polymer</button>
<button class="btn gray" onclick="resetPolymer()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Dry Solids</td><td><span class="result" id="r_poly_dry">-</span></td><td>lb/hr</td></tr>
<tr><td class="rowh">Polymer Required</td><td><span class="result" id="r_poly_lb">-</span></td><td>lb/hr</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">‚õΩ Pumping & Hydraulics</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (GPM)</label><input type="number" id="pump_flow" value="500"></div>
<div class="input-group"><label>Total Dynamic Head (ft)</label><input type="number" id="pump_tdh" value="50"></div>
<div class="input-group"><label>Pump Efficiency (%)</label><input type="number" id="pump_eff" value="70"></div>
<div class="input-group"><label>Motor Efficiency (%)</label><input type="number" id="motor_eff" value="90"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPump()">Calculate Pump</button>
<button class="btn gray" onclick="resetPump()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Water Horsepower</td><td><span class="result" id="r_pump_whp">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Brake Horsepower</td><td><span class="result" id="r_pump_bhp">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Motor Horsepower</td><td><span class="result" id="r_pump_mhp">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Power Draw</td><td><span class="result" id="r_pump_kw">-</span></td><td>kW</td></tr>
</tbody></table>

<div class="section">
<div class="section-h">‚öóÔ∏è Alkalinity Requirements</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>TKN Removed (mg/L)</label><input type="number" id="alk_tkn" value="25"></div>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="alk_flow" value="5.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcAlkalinity()">Calculate</button>
<button class="btn gray" onclick="resetAlkalinity()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Alkalinity Consumed</td><td><span class="result" id="r_alk_consumed">-</span></td><td>mg/L as CaCO3</td></tr>
<tr><td class="rowh">Daily Alk Required</td><td><span class="result" id="r_alk_daily">-</span></td><td>lb/day</td></tr>
</tbody></table>
</div>
</div

<div class="section">
<div class="section-h">üåä Surface Overflow Rate (SOR)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="sor_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Clarifier Area (sq ft)</label><input type="number" id="sor_area" value="5000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSOR()">Calculate SOR</button>
<button class="btn gray" onclick="resetSOR()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Surface Overflow Rate</td><td><span class="result" id="r_sor">-</span></td><td>gpd/sq ft</td><td><span class="status" id="s_sor">-</span></td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_sor_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üîÑ Weir Overflow Rate (WOR)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="wor_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Weir Length (ft)</label><input type="number" id="wor_length" value="150"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcWOR()">Calculate WOR</button>
<button class="btn gray" onclick="resetWOR()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Weir Overflow Rate</td><td><span class="result" id="r_wor">-</span></td><td>gpd/ft</td><td><span class="status" id="s_wor">-</span></td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_wor_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üìä Solids Loading Rate (SLR)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="slr_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="slr_mlss" value="3000"></div>
<div class="input-group"><label>RAS Flow (MGD)</label><input type="number" id="slr_ras" value="2.0" step="0.1"></div>
<div class="input-group"><label>Clarifier Area (sq ft)</label><input type="number" id="slr_area" value="5000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSLR()">Calculate SLR</button>
<button class="btn gray" onclick="resetSLR()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Solids Loading Rate</td><td><span class="result" id="r_slr">-</span></td><td>lb/sq ft/day</td><td><span class="status" id="s_slr">-</span></td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_slr_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">‚è±Ô∏è Mean Cell Residence Time (MCRT)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="mcrt_vol" value="1.5" step="0.1"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="mcrt_mlss" value="3000"></div>
<div class="input-group"><label>WAS Flow (MGD)</label><input type="number" id="mcrt_was" value="0.05" step="0.01"></div>
<div class="input-group"><label>WAS TSS (mg/L)</label><input type="number" id="mcrt_was_tss" value="8000"></div>
<div class="input-group"><label>Effluent Flow (MGD)</label><input type="number" id="mcrt_eff" value="5.0" step="0.1"></div>
<div class="input-group"><label>Effluent TSS (mg/L)</label><input type="number" id="mcrt_eff_tss" value="10"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcMCRT()">Calculate MCRT</button>
<button class="btn gray" onclick="resetMCRT()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">System Solids</td><td><span class="result" id="r_mcrt_solids">-</span></td><td>lb</td></tr>
<tr><td class="rowh">Solids Wasted</td><td><span class="result" id="r_mcrt_wasted">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">MCRT</td><td><span class="result" id="r_mcrt">-</span></td><td>days</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_mcrt_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üí® Oxygen Uptake Rate (OUR)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>DO Start (mg/L)</label><input type="number" id="our_do1" value="6.0" step="0.1"></div>
<div class="input-group"><label>DO End (mg/L)</label><input type="number" id="our_do2" value="2.0" step="0.1"></div>
<div class="input-group"><label>Time (minutes)</label><input type="number" id="our_time" value="15"></div>
<div class="input-group"><label>MLVSS (mg/L)</label><input type="number" id="our_mlvss" value="2000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcOUR()">Calculate OUR</button>
<button class="btn gray" onclick="resetOUR()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">OUR</td><td><span class="result" id="r_our">-</span></td><td>mg/L/hr</td></tr>
<tr><td class="rowh">SOUR</td><td><span class="result" id="r_sour">-</span></td><td>mg O2/g MLVSS/hr</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_our_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="sludgeAgeCalculator" style="border:2px solid #8b5cf6">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);color:white">
üìÖ Sludge Age Calculator (Multiple Methods)
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">5 Methods</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate SRT/MCRT using different methods. Compare results to verify accuracy.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#a78bfa">üìä System Parameters</h4>
<div class="row">
<div class="input-group">
<label style="color:#a78bfa">Aeration Volume (MG)</label>
<input type="number" id="sa_vol" value="1.5" step="0.1" onchange="calcAllSludgeAge()">
</div>
<div class="input-group">
<label style="color:#a78bfa">MLSS (mg/L)</label>
<input type="number" id="sa_mlss" value="3000" onchange="calcAllSludgeAge()">
</div>
<div class="input-group">
<label style="color:#a78bfa">MLVSS (mg/L)</label>
<input type="number" id="sa_mlvss" value="2400" onchange="calcAllSludgeAge()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Clarifier Volume (MG)</label>
<input type="number" id="sa_clar_vol" value="0.3" step="0.1" onchange="calcAllSludgeAge()">
</div>
<div class="input-group">
<label>Clarifier TSS (mg/L)</label>
<input type="number" id="sa_clar_tss" value="5000" onchange="calcAllSludgeAge()">
</div>
<div class="input-group">
<label>Water Temperature (¬∞C)</label>
<input type="number" id="sa_temp" value="20" onchange="calcAllSludgeAge()">
</div>
</div>
</div>

<div style="display:flex;flex-wrap:wrap;gap:5px;margin-bottom:15px">
<button class="btn" id="sa_tab_1" onclick="showSAMethod(1)" style="flex:1;min-width:80px;padding:8px;font-size:12px;background:#8b5cf6">üìä Standard</button>
<button class="btn gray" id="sa_tab_2" onclick="showSAMethod(2)" style="flex:1;min-width:80px;padding:8px;font-size:12px">‚è±Ô∏è MCRT</button>
<button class="btn gray" id="sa_tab_3" onclick="showSAMethod(3)" style="flex:1;min-width:80px;padding:8px;font-size:12px">üå°Ô∏è Aerobic</button>
<button class="btn gray" id="sa_tab_4" onclick="showSAMethod(4)" style="flex:1;min-width:80px;padding:8px;font-size:12px">‚öñÔ∏è F/M Based</button>
<button class="btn gray" id="sa_tab_5" onclick="showSAMethod(5)" style="flex:1;min-width:80px;padding:8px;font-size:12px">üßÆ Kinetic</button>
</div>

<div id="sa_method_1" class="sa-method-panel" style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üìä Method 1: Standard SRT</h4>
<div class="note info" style="margin-bottom:15px">SRT = Total System Solids √∑ Solids Wasted per Day</div>
<div class="row">
<div class="input-group">
<label>WAS Flow (GPD)</label>
<input type="number" id="sa1_was_flow" value="25000" onchange="calcSA1()">
</div>
<div class="input-group">
<label>WAS TSS (mg/L)</label>
<input type="number" id="sa1_was_tss" value="8000" onchange="calcSA1()">
</div>
</div>
<div class="btns"><button class="btn gradient" onclick="calcSA1()">Calculate Standard SRT</button></div>
<div id="sa1_result" style="margin-top:15px"></div>
</div>

<div id="sa_method_2" class="sa-method-panel" style="display:none;background:#243b55;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">‚è±Ô∏è Method 2: MCRT (Mean Cell Residence Time)</h4>
<div class="note info" style="margin-bottom:15px">MCRT = Total Solids √∑ (WAS Solids + Effluent Solids Loss)</div>
<div class="row">
<div class="input-group">
<label>WAS Flow (GPD)</label>
<input type="number" id="sa2_was_flow" value="25000" onchange="calcSA2()">
</div>
<div class="input-group">
<label>WAS TSS (mg/L)</label>
<input type="number" id="sa2_was_tss" value="8000" onchange="calcSA2()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Effluent Flow (MGD)</label>
<input type="number" id="sa2_eff_flow" value="5.0" step="0.1" onchange="calcSA2()">
</div>
<div class="input-group">
<label>Effluent TSS (mg/L)</label>
<input type="number" id="sa2_eff_tss" value="10" onchange="calcSA2()">
</div>
</div>
<div class="btns"><button class="btn gradient" onclick="calcSA2()">Calculate MCRT</button></div>
<div id="sa2_result" style="margin-top:15px"></div>
</div>

<div id="sa_method_3" class="sa-method-panel" style="display:none;background:#243b55;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üå°Ô∏è Method 3: Aerobic SRT (Nitrification Design)</h4>
<div class="note info" style="margin-bottom:15px">Minimum SRT for nitrification based on temperature and safety factor</div>
<div class="row">
<div class="input-group">
<label>Design Temperature (¬∞C)</label>
<input type="number" id="sa3_temp" value="15" onchange="calcSA3()">
</div>
<div class="input-group">
<label>Safety Factor</label>
<input type="number" id="sa3_sf" value="2.0" step="0.1" onchange="calcSA3()">
</div>
<div class="input-group">
<label>Max Nitrifier Growth (1/d)</label>
<input type="number" id="sa3_umax" value="0.75" step="0.05" onchange="calcSA3()">
</div>
</div>
<div class="btns"><button class="btn gradient" onclick="calcSA3()">Calculate Min Aerobic SRT</button></div>
<div id="sa3_result" style="margin-top:15px"></div>
</div>

<div id="sa_method_4" class="sa-method-panel" style="display:none;background:#243b55;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#f97316">‚öñÔ∏è Method 4: F/M Ratio Based SRT</h4>
<div class="note info" style="margin-bottom:15px">SRT estimated from F/M ratio: SRT ‚âà 1 / (Y √ó F/M - kd)</div>
<div class="row">
<div class="input-group">
<label>BOD Loading (lb/day)</label>
<input type="number" id="sa4_bod" value="4170" onchange="calcSA4()">
</div>
<div class="input-group">
<label>Yield Coefficient (Y)</label>
<input type="number" id="sa4_y" value="0.6" step="0.05" onchange="calcSA4()">
</div>
<div class="input-group">
<label>Decay Rate (kd, 1/d)</label>
<input type="number" id="sa4_kd" value="0.06" step="0.01" onchange="calcSA4()">
</div>
</div>
<div class="btns"><button class="btn gradient" onclick="calcSA4()">Calculate from F/M</button></div>
<div id="sa4_result" style="margin-top:15px"></div>
</div>

<div id="sa_method_5" class="sa-method-panel" style="display:none;background:#243b55;padding:15px;border-radius:10px;margin-bottom:15px">
<h4 style="margin:0 0 15px 0;color:#ec4899">üßÆ Method 5: Kinetic Model (Monod)</h4>
<div class="note info" style="margin-bottom:15px">SRT from Monod kinetics: SRT = (Ks + S) / (Œºmax √ó S - kd √ó (Ks + S))</div>
<div class="row">
<div class="input-group">
<label>Effluent BOD (S, mg/L)</label>
<input type="number" id="sa5_s" value="10" onchange="calcSA5()">
</div>
<div class="input-group">
<label>Half-sat Constant (Ks)</label>
<input type="number" id="sa5_ks" value="60" onchange="calcSA5()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Max Growth Rate (Œºmax, 1/d)</label>
<input type="number" id="sa5_umax" value="3.0" step="0.1" onchange="calcSA5()">
</div>
<div class="input-group">
<label>Decay Rate (kd, 1/d)</label>
<input type="number" id="sa5_kd" value="0.06" step="0.01" onchange="calcSA5()">
</div>
</div>
<div class="btns"><button class="btn gradient" onclick="calcSA5()">Calculate Kinetic SRT</button></div>
<div id="sa5_result" style="margin-top:15px"></div>
</div>

<div class="btns">
<button class="btn blue" onclick="compareAllSA()" style="font-size:16px;padding:12px 24px">üìä Compare All Methods</button>
<button class="btn gray" onclick="resetAllSA()">üîÑ Reset All</button>
</div>

<div id="sa_comparison" style="margin-top:20px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#8b5cf6">üìö SRT Guidelines by Process Type</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>Process Type</th><th>SRT (days)</th><th>F/M (lb/lb/d)</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>High-Rate AS</td><td>2-4</td><td>0.4-1.0</td><td>BOD removal only</td></tr>
<tr><td>Conventional AS</td><td>4-8</td><td>0.2-0.4</td><td>Good BOD removal</td></tr>
<tr style="background:rgba(74,222,128,0.1)"><td>Nitrification</td><td>8-15</td><td>0.1-0.2</td><td>Complete nitrification</td></tr>
<tr><td>Extended Aeration</td><td>15-30</td><td>0.05-0.1</td><td>Low sludge production</td></tr>
<tr><td>MBR Systems</td><td>15-50</td><td>0.05-0.15</td><td>High MLSS operation</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">üå°Ô∏è Min SRT for Nitrification:</strong>
<div style="font-size:12px;margin-top:5px">
20¬∞C: 4-5 days<br>
15¬∞C: 6-8 days<br>
10¬∞C: 10-15 days<br>
5¬∞C: 20+ days
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">‚ö†Ô∏è Common Issues:</strong>
<div style="font-size:12px;margin-top:5px">
SRT too low: Poor nitrification<br>
SRT too high: Pin floc, high DO demand<br>
Variable SRT: Inconsistent performance
</div>
</div>
</div>
</div>

</div>
</div>

<div class="section">
<div class="section-h">üß™ Ammonia/TKN Removal</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent NH3-N (mg/L)</label><input type="number" id="nh3_in" value="25" step="0.1"></div>
<div class="input-group"><label>Effluent NH3-N (mg/L)</label><input type="number" id="nh3_out" value="1.0" step="0.1"></div>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="nh3_flow" value="5.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcNH3()">Calculate Removal</button>
<button class="btn gray" onclick="resetNH3()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">NH3-N Removed</td><td><span class="result" id="r_nh3_removed">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Removal Efficiency</td><td><span class="result" id="r_nh3_eff">-</span></td><td>%</td></tr>
<tr><td class="rowh">Mass Removed</td><td><span class="result" id="r_nh3_mass">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Alkalinity Consumed</td><td><span class="result" id="r_nh3_alk">-</span></td><td>lb/day as CaCO3</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üî¨ Phosphorus Removal</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent TP (mg/L)</label><input type="number" id="phos_in" value="6.0" step="0.1"></div>
<div class="input-group"><label>Effluent TP (mg/L)</label><input type="number" id="phos_out" value="0.5" step="0.1"></div>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="phos_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Chemical (Alum/Ferric)</label><select id="phos_chem"><option value="alum">Alum</option><option value="ferric">Ferric Chloride</option></select></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPhos()">Calculate Removal</button>
<button class="btn gray" onclick="resetPhos()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">TP Removed</td><td><span class="result" id="r_phos_removed">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Removal Efficiency</td><td><span class="result" id="r_phos_eff">-</span></td><td>%</td></tr>
<tr><td class="rowh">Chemical Dose Required</td><td><span class="result" id="r_phos_dose">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Molar Ratio</td><td><span class="result" id="r_phos_ratio">-</span></td><td>mol/mol P</td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="nutrientBalanceCalculator" style="border:2px solid #22c55e">
<div class="section-h" style="background:linear-gradient(135deg,#16a34a,#22c55e);color:white">
üåø Nutrient Balance Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">BNR Analysis</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Complete nitrogen and phosphorus balance through the treatment process.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#22c55e">üì• Influent Characteristics</h4>
<div class="row">
<div class="input-group">
<label style="color:#22c55e">Flow (MGD)</label>
<input type="number" id="nb_flow" value="5.0" step="0.1" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label style="color:#22c55e">BOD (mg/L)</label>
<input type="number" id="nb_bod" value="200" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label style="color:#22c55e">TSS (mg/L)</label>
<input type="number" id="nb_tss" value="220" onchange="calcNutrientBalance()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>TKN (mg/L)</label>
<input type="number" id="nb_tkn" value="40" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>NH3-N (mg/L)</label>
<input type="number" id="nb_nh3" value="28" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>Organic-N (mg/L)</label>
<input type="number" id="nb_orgn" value="12" onchange="calcNutrientBalance()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Total P (mg/L)</label>
<input type="number" id="nb_tp" value="7" step="0.5" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>Ortho-P (mg/L)</label>
<input type="number" id="nb_op" value="5" step="0.5" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>Temperature (¬∞C)</label>
<input type="number" id="nb_temp" value="20" onchange="calcNutrientBalance()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">‚öôÔ∏è Process Configuration</h4>
<div class="row">
<div class="input-group">
<label>Process Type</label>
<select id="nb_process" style="font-size:14px" onchange="updateNBDefaults()">
<option value="conv">Conventional (BOD only)</option>
<option value="nit" selected>Nitrification</option>
<option value="ndn">Nitrification-Denitrification</option>
<option value="bnr">Full BNR (N+P)</option>
<option value="ebpr">Enhanced Bio-P (EBPR)</option>
</select>
</div>
<div class="input-group">
<label>SRT (days)</label>
<input type="number" id="nb_srt" value="12" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="nb_mlss" value="3000" onchange="calcNutrientBalance()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Anoxic Fraction (%)</label>
<input type="number" id="nb_anoxic" value="33" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>Internal Recycle Ratio</label>
<input type="number" id="nb_ir" value="3" step="0.5" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>RAS Ratio</label>
<input type="number" id="nb_ras" value="0.5" step="0.1" onchange="calcNutrientBalance()">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üéØ Effluent Targets/Limits</h4>
<div class="row">
<div class="input-group">
<label>NH3-N Limit (mg/L)</label>
<input type="number" id="nb_nh3_lim" value="2" step="0.5" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>TN Limit (mg/L)</label>
<input type="number" id="nb_tn_lim" value="10" onchange="calcNutrientBalance()">
</div>
<div class="input-group">
<label>TP Limit (mg/L)</label>
<input type="number" id="nb_tp_lim" value="1" step="0.1" onchange="calcNutrientBalance()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#a78bfa">‚öóÔ∏è Chemical Addition (if needed)</h4>
<div class="row">
<div class="input-group">
<label>Carbon Source</label>
<select id="nb_carbon" style="font-size:14px">
<option value="none">None (endogenous)</option>
<option value="methanol">Methanol</option>
<option value="acetate">Acetic Acid</option>
<option value="glycerol">Glycerol</option>
<option value="microc">MicroC</option>
</select>
</div>
<div class="input-group">
<label>P Removal Chemical</label>
<select id="nb_pchem" style="font-size:14px">
<option value="none">None (Bio-P only)</option>
<option value="alum">Alum</option>
<option value="ferric">Ferric Chloride</option>
<option value="ferrous">Ferrous Sulfate</option>
</select>
</div>
<div class="input-group">
<label>Alkalinity Available (mg/L)</label>
<input type="number" id="nb_alk" value="200" onchange="calcNutrientBalance()">
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcNutrientBalance()">üåø Calculate Balance</button>
<button class="btn blue" onclick="showNutrientDiagram()">üìä Show Flow Diagram</button>
<button class="btn gray" onclick="resetNutrientBalance()">üîÑ Reset</button>
</div>

<div id="nb_results" style="margin-top:20px"></div>

<div id="nb_diagram" style="margin-top:15px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#22c55e">üìö Nutrient Removal Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Process</th><th>TN Achievable</th><th>TP Achievable</th><th>Key Requirements</th></tr>
</thead>
<tbody>
<tr><td>Conventional</td><td>25-35 mg/L</td><td>4-6 mg/L</td><td>BOD removal only</td></tr>
<tr><td>Nitrification</td><td>20-30 mg/L</td><td>4-6 mg/L</td><td>SRT >8d @ 20¬∞C</td></tr>
<tr style="background:rgba(74,222,128,0.1)"><td>Nit-Denit</td><td>8-12 mg/L</td><td>4-6 mg/L</td><td>Anoxic zone, carbon</td></tr>
<tr><td>BNR (MLE)</td><td>6-10 mg/L</td><td>1-2 mg/L</td><td>Bio-P + denit</td></tr>
<tr><td>Advanced BNR</td><td>3-5 mg/L</td><td>0.1-0.5 mg/L</td><td>Multiple stages, chem-P</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">N Stoichiometry:</strong>
<div style="font-size:11px;margin-top:5px">
Nitrification: 4.6 lb O‚ÇÇ/lb N<br>
Denitrification: 2.9 lb BOD/lb N<br>
Alkalinity: 7.1 lb CaCO‚ÇÉ/lb N (nit)<br>
Recovery: 3.6 lb CaCO‚ÇÉ/lb N (denit)
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">P Stoichiometry:</strong>
<div style="font-size:11px;margin-top:5px">
Bio-P uptake: 0.01-0.02 lb P/lb BOD<br>
Alum: 10:1 Al:P molar ratio<br>
Ferric: 2:1 Fe:P molar ratio<br>
Sludge P content: 2-7% in EBPR
</div>
</div>
</div>
</div>

</div>
</div>

<div class="section">
<div class="section-h">üß´ TSS/VSS Removal Efficiency</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent TSS (mg/L)</label><input type="number" id="tss_in" value="250"></div>
<div class="input-group"><label>Effluent TSS (mg/L)</label><input type="number" id="tss_out" value="10"></div>
<div class="input-group"><label>Influent VSS (mg/L)</label><input type="number" id="vss_in" value="200"></div>
<div class="input-group"><label>Effluent VSS (mg/L)</label><input type="number" id="vss_out" value="8"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcTSS()">Calculate Removal</button>
<button class="btn gray" onclick="resetTSS()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">TSS Removal</td><td><span class="result" id="r_tss_eff">-</span></td><td>%</td></tr>
<tr><td class="rowh">VSS Removal</td><td><span class="result" id="r_vss_eff">-</span></td><td>%</td></tr>
<tr><td class="rowh">VSS/TSS Ratio (In)</td><td><span class="result" id="r_vss_tss_in">-</span></td><td></td></tr>
<tr><td class="rowh">VSS/TSS Ratio (Out)</td><td><span class="result" id="r_vss_tss_out">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">‚öôÔ∏è Grit Chamber Sizing</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Peak Flow (MGD)</label><input type="number" id="grit_flow" value="10.0" step="0.1"></div>
<div class="input-group"><label>Detention Time (min)</label><input type="number" id="grit_dt" value="3"></div>
<div class="input-group"><label>Depth (ft)</label><input type="number" id="grit_depth" value="10"></div>
<div class="input-group"><label>Width (ft)</label><input type="number" id="grit_width" value="8"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcGrit()">Calculate Grit</button>
<button class="btn gray" onclick="resetGrit()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Volume Required</td><td><span class="result" id="r_grit_vol">-</span></td><td>cu ft</td></tr>
<tr><td class="rowh">Length Required</td><td><span class="result" id="r_grit_length">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Surface Area</td><td><span class="result" id="r_grit_area">-</span></td><td>sq ft</td></tr>
<tr><td class="rowh">Horizontal Velocity</td><td><span class="result" id="r_grit_vel">-</span></td><td>ft/min</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üî• Anaerobic Digester Loading</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sludge Volume (gpd)</label><input type="number" id="dig_vol" value="50000"></div>
<div class="input-group"><label>Sludge Solids (%)</label><input type="number" id="dig_solids" value="5" step="0.1"></div>
<div class="input-group"><label>VS/TS Ratio</label><input type="number" id="dig_vs" value="0.75" step="0.01"></div>
<div class="input-group"><label>Digester Volume (cu ft)</label><input type="number" id="dig_tank" value="50000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcDigester()">Calculate Loading</button>
<button class="btn gray" onclick="resetDigester()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">VS Loading</td><td><span class="result" id="r_dig_vs">-</span></td><td>lb VS/day</td></tr>
<tr><td class="rowh">Volumetric Loading</td><td><span class="result" id="r_dig_vlr">-</span></td><td>lb VS/cu ft/day</td></tr>
<tr><td class="rowh">HRT</td><td><span class="result" id="r_dig_hrt">-</span></td><td>days</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_dig_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

>

<div class="section" id="mlssCalcSection">
<div class="section-h">üî¨ MLSS/MLVSS Calculator</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="mlss_val" value="3000"></div>
<div class="input-group"><label>VSS Ratio (%)</label><input type="number" id="mlss_vss" value="75"></div>
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="mlss_vol" value="1.5" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcMLSS()">Calculate</button>
<button class="btn gray" onclick="resetMLSS()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">MLVSS</td><td><span class="result" id="r_mlvss">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Total Solids</td><td><span class="result" id="r_mlss_lb">-</span></td><td>lb</td></tr>
<tr><td class="rowh">Volatile Solids</td><td><span class="result" id="r_mlvss_lb">-</span></td><td>lb</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üåä Clarifier Loading Rates</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="clar_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Clarifier Diameter (ft)</label><input type="number" id="clar_diam" value="65"></div>
<div class="input-group"><label>RAS Flow (MGD)</label><input type="number" id="clar_ras_flow" value="1.5" step="0.1"></div>
<div class="input-group"><label>Weir Length (ft)</label><input type="number" id="clar_weir" value="204"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="clar_mlss" value="3000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcClarifier()">Calculate</button>
<button class="btn gray" onclick="resetClarifier()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Surface Overflow Rate</td><td><span class="result" id="r_clar_sor">-</span></td><td>gpd/sq ft</td></tr>
<tr><td class="rowh">Weir Overflow Rate</td><td><span class="result" id="r_clar_wor">-</span></td><td>gpd/ft</td></tr>
<tr><td class="rowh">Solids Loading</td><td><span class="result" id="r_clar_slr">-</span></td><td>lb/sq ft/day</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_clar_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üí® Oxygen Transfer Efficiency</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Airflow (SCFM)</label><input type="number" id="ote_air" value="2000"></div>
<div class="input-group"><label>Diffuser Depth (ft)</label><input type="number" id="ote_depth" value="15"></div>
<div class="input-group"><label>OTE at STP (%)</label><input type="number" id="ote_stp" value="25"></div>
<div class="input-group"><label>Temperature (¬∞C)</label><input type="number" id="ote_temp" value="20"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcOTESimple()">Calculate</button>
<button class="btn gray" onclick="resetOTESimple()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Field OTE</td><td><span class="result" id="r_ote_field">-</span></td><td>%</td></tr>
<tr><td class="rowh">O2 Delivered</td><td><span class="result" id="r_ote_o2">-</span></td><td>lb O2/hr</td></tr>
<tr><td class="rowh">SOTR</td><td><span class="result" id="r_ote_sotr">-</span></td><td>lb O2/hr</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üî• Digester Gas Production</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>VS Destroyed (lb/day)</label><input type="number" id="gas_vs" value="5000"></div>
<div class="input-group"><label>Gas Production (cf/lb VS)</label><input type="number" id="gas_rate" value="15"></div>
<div class="input-group"><label>Methane Content (%)</label><input type="number" id="gas_ch4" value="65"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcGas()">Calculate</button>
<button class="btn gray" onclick="resetGas()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Total Gas</td><td><span class="result" id="r_gas_total">-</span></td><td>cf/day</td></tr>
<tr><td class="rowh">Methane Volume</td><td><span class="result" id="r_gas_ch4">-</span></td><td>cf/day</td></tr>
<tr><td class="rowh">Energy Value</td><td><span class="result" id="r_gas_btu">-</span></td><td>BTU/day</td></tr>
<tr><td class="rowh">Power Potential</td><td><span class="result" id="r_gas_kw">-</span></td><td>kW</td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="dewateringCalculator" style="border:2px solid #ec4899">
<div class="section-h" style="background:linear-gradient(135deg,#db2777,#ec4899);color:white">
üóúÔ∏è Belt Press / Centrifuge Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Dewatering</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Comprehensive dewatering analysis for belt filter press and centrifuge operations.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#ec4899">‚öôÔ∏è Equipment Configuration</h4>
<div class="row">
<div class="input-group">
<label style="color:#ec4899">Equipment Type</label>
<select id="dw_type" style="font-size:14px" onchange="updateDewateringDefaults()">
<option value="bfp" selected>Belt Filter Press (BFP)</option>
<option value="centrifuge">Centrifuge</option>
<option value="screw">Screw Press</option>
<option value="plate">Plate & Frame Press</option>
</select>
</div>
<div class="input-group">
<label style="color:#ec4899">Number of Units</label>
<input type="number" id="dw_units" value="2" min="1" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label style="color:#ec4899">Units in Service</label>
<input type="number" id="dw_service" value="1" min="1" onchange="calcDewatering2()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Belt Width / Bowl Diameter (m)</label>
<input type="number" id="dw_size" value="2.0" step="0.1" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Operating Hours/Day</label>
<input type="number" id="dw_hours" value="8" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Days per Week</label>
<input type="number" id="dw_days" value="5" onchange="calcDewatering2()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üì• Feed Sludge Characteristics</h4>
<div class="row">
<div class="input-group">
<label>Sludge Type</label>
<select id="dw_sludge" style="font-size:14px" onchange="updateSludgeDefaults()">
<option value="primary">Primary Sludge</option>
<option value="was">WAS (Thickened)</option>
<option value="mixed" selected>Mixed (Primary + WAS)</option>
<option value="digested">Anaerobically Digested</option>
<option value="aerobic">Aerobically Digested</option>
</select>
</div>
<div class="input-group">
<label>Feed Rate (GPM)</label>
<input type="number" id="dw_feed_gpm" value="150" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Feed Solids (%)</label>
<input type="number" id="dw_feed_pct" value="3.5" step="0.1" onchange="calcDewatering2()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Daily Sludge Volume (gal/day)</label>
<input type="number" id="dw_daily_vol" value="72000" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>VS/TS Ratio</label>
<input type="number" id="dw_vs_ratio" value="0.70" step="0.01" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Specific Gravity</label>
<input type="number" id="dw_sg" value="1.02" step="0.01" onchange="calcDewatering2()">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üìä Performance Parameters</h4>
<div class="row">
<div class="input-group">
<label>Target Cake Solids (%)</label>
<input type="number" id="dw_cake_pct" value="22" step="0.5" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Solids Capture (%)</label>
<input type="number" id="dw_capture" value="95" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Hydraulic Loading (GPM/m)</label>
<input type="number" id="dw_hyd_load" value="75" onchange="calcDewatering2()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Solids Loading (lb/hr/m)</label>
<input type="number" id="dw_sol_load" value="1000" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Belt Speed (m/min)</label>
<input type="number" id="dw_belt_speed" value="3" step="0.5" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Belt Tension (psi)</label>
<input type="number" id="dw_tension" value="60" onchange="calcDewatering2()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#a78bfa">‚öóÔ∏è Polymer Conditioning</h4>
<div class="row">
<div class="input-group">
<label>Polymer Type</label>
<select id="dw_poly_type" style="font-size:14px">
<option value="emulsion" selected>Emulsion (liquid)</option>
<option value="dry">Dry Powder</option>
<option value="mannich">Mannich</option>
</select>
</div>
<div class="input-group">
<label>Polymer Dose (lb/DT)</label>
<input type="number" id="dw_poly_dose" value="12" step="0.5" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Polymer Solution (%)</label>
<input type="number" id="dw_poly_soln" value="0.25" step="0.05" onchange="calcDewatering2()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Polymer Cost ($/lb active)</label>
<input type="number" id="dw_poly_cost" value="2.50" step="0.10" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Wash Water (GPM)</label>
<input type="number" id="dw_wash" value="80" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Electricity Cost ($/kWh)</label>
<input type="number" id="dw_elec_cost" value="0.10" step="0.01" onchange="calcDewatering2()">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#ef4444">üöõ Disposal</h4>
<div class="row">
<div class="input-group">
<label>Disposal Method</label>
<select id="dw_disposal" style="font-size:14px">
<option value="landfill" selected>Landfill</option>
<option value="compost">Composting</option>
<option value="incineration">Incineration</option>
<option value="land_app">Land Application</option>
</select>
</div>
<div class="input-group">
<label>Disposal Cost ($/wet ton)</label>
<input type="number" id="dw_disp_cost" value="50" onchange="calcDewatering2()">
</div>
<div class="input-group">
<label>Truck Capacity (cubic yards)</label>
<input type="number" id="dw_truck_cy" value="20" onchange="calcDewatering2()">
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcDewatering2()">üóúÔ∏è Calculate Dewatering</button>
<button class="btn blue" onclick="compareDewateringEquip()">üìä Compare Equipment</button>
<button class="btn orange" onclick="optimizePolymer()">‚öóÔ∏è Optimize Polymer</button>
<button class="btn gray" onclick="resetDewatering2()">üîÑ Reset</button>
</div>

<div id="dw2_results" style="margin-top:20px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#ec4899">üìö Dewatering Equipment Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Parameter</th><th>Belt Press</th><th>Centrifuge</th><th>Screw Press</th></tr>
</thead>
<tbody>
<tr><td>Cake Solids (%)</td><td>18-25</td><td>20-30</td><td>15-25</td></tr>
<tr><td>Capture (%)</td><td>90-98</td><td>90-98</td><td>90-95</td></tr>
<tr><td>Polymer (lb/DT)</td><td>8-15</td><td>15-25</td><td>5-10</td></tr>
<tr><td>Energy (kWh/DT)</td><td>10-20</td><td>30-60</td><td>5-15</td></tr>
<tr><td>Wash Water</td><td>High</td><td>None</td><td>Low</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">Typical Cake Solids:</strong>
<div style="font-size:11px;margin-top:5px">
Primary: 28-34%<br>
WAS: 15-20%<br>
Mixed: 20-28%<br>
Digested: 22-30%
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">Polymer Dose Range:</strong>
<div style="font-size:11px;margin-top:5px">
Primary: 3-8 lb/DT<br>
WAS: 15-25 lb/DT<br>
Digested: 10-18 lb/DT<br>
Mixed: 8-15 lb/DT
</div>
</div>
</div>
</div>

</div>
</div>

</div>
</div>

<div class="section">
<div class="section-h">üí® Blower Air Requirements</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>O2 Required (lb/day)</label><input type="number" id="blower_o2" value="5000"></div>
<div class="input-group"><label>Transfer Efficiency (%)</label><input type="number" id="blower_eff" value="25"></div>
<div class="input-group"><label>Diffuser Depth (ft)</label><input type="number" id="blower_depth" value="15"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcBlower()">Calculate</button>
<button class="btn gray" onclick="resetBlower()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Air Required</td><td><span class="result" id="r_blower_air">-</span></td><td>SCFM</td></tr>
<tr><td class="rowh">Blower HP (est)</td><td><span class="result" id="r_blower_hp">-</span></td><td>HP</td></tr>
<tr><td class="rowh">Annual Energy</td><td><span class="result" id="r_blower_kwh">-</span></td><td>kWh/yr</td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="uvDisinfectionCalculator" style="border:2px solid #06b6d4">
<div class="section-h" style="background:linear-gradient(135deg,#0891b2,#06b6d4);color:white">
‚òÄÔ∏è UV Disinfection Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Comprehensive</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Design and evaluate UV disinfection systems for various applications.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#06b6d4">‚öôÔ∏è System Configuration</h4>
<div class="row">
<div class="input-group">
<label style="color:#06b6d4">Design Flow (MGD)</label>
<input type="number" id="uv_flow" value="5.0" step="0.1" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label style="color:#06b6d4">Peak Flow Factor</label>
<input type="number" id="uv_pf" value="2.0" step="0.1" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label style="color:#06b6d4">Number of Channels</label>
<input type="number" id="uv_channels" value="2" min="1" onchange="calcUVSystem()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>UV System Type</label>
<select id="uv_type" style="font-size:14px" onchange="updateUVDefaults()">
<option value="lp">Low Pressure (LP)</option>
<option value="lpho" selected>Low Pressure High Output (LPHO)</option>
<option value="mp">Medium Pressure (MP)</option>
</select>
</div>
<div class="input-group">
<label>Application</label>
<select id="uv_app" style="font-size:14px" onchange="updateUVDose()">
<option value="secondary">Secondary Effluent</option>
<option value="tertiary" selected>Tertiary/Filtered</option>
<option value="reuse">Reuse/Title 22</option>
<option value="drinking">Drinking Water</option>
</select>
</div>
<div class="input-group">
<label>Redundancy</label>
<select id="uv_redund" style="font-size:14px" onchange="calcUVSystem()">
<option value="n">N (No redundancy)</option>
<option value="n1" selected>N+1 (One standby)</option>
<option value="n2">N+2 (Two standby)</option>
</select>
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üíß Water Quality Parameters</h4>
<div class="row">
<div class="input-group">
<label>UVT - UV Transmittance (%)</label>
<input type="number" id="uv_uvt" value="65" min="30" max="99" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>TSS (mg/L)</label>
<input type="number" id="uv_tss" value="10" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Iron (mg/L)</label>
<input type="number" id="uv_iron" value="0.1" step="0.1" onchange="calcUVSystem()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Turbidity (NTU)</label>
<input type="number" id="uv_turb" value="2" step="0.5" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Color (CU)</label>
<input type="number" id="uv_color" value="5" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Hardness (mg/L as CaCO3)</label>
<input type="number" id="uv_hard" value="150" onchange="calcUVSystem()">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">‚ò¢Ô∏è Dose Requirements</h4>
<div class="row">
<div class="input-group">
<label>Target Pathogen</label>
<select id="uv_pathogen" style="font-size:14px" onchange="updateUVDose()">
<option value="ecoli">E. coli</option>
<option value="fecal" selected>Fecal Coliform</option>
<option value="entero">Enterococci</option>
<option value="crypto">Cryptosporidium</option>
<option value="giardia">Giardia</option>
<option value="virus">Virus (Adenovirus)</option>
</select>
</div>
<div class="input-group">
<label>Target Log Reduction</label>
<input type="number" id="uv_log" value="4" step="0.5" min="1" max="6" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Design UV Dose (mJ/cm¬≤)</label>
<input type="number" id="uv_dose" value="40" onchange="calcUVSystem()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>End-of-Lamp Factor</label>
<input type="number" id="uv_elf" value="0.7" step="0.05" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Fouling Factor</label>
<input type="number" id="uv_ff" value="0.8" step="0.05" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Safety Factor</label>
<input type="number" id="uv_sf" value="1.2" step="0.1" onchange="calcUVSystem()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#a78bfa">üí∞ Operating Costs</h4>
<div class="row">
<div class="input-group">
<label>Electricity Cost ($/kWh)</label>
<input type="number" id="uv_elec" value="0.10" step="0.01" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Lamp Cost ($)</label>
<input type="number" id="uv_lamp_cost" value="150" onchange="calcUVSystem()">
</div>
<div class="input-group">
<label>Lamp Life (hours)</label>
<input type="number" id="uv_lamp_life" value="12000" onchange="calcUVSystem()">
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcUVSystem()">‚òÄÔ∏è Calculate UV System</button>
<button class="btn blue" onclick="compareUVSystems()">üìä Compare LP vs MP</button>
<button class="btn gray" onclick="resetUVSystem()">üîÑ Reset</button>
</div>

<div id="uv_results" style="margin-top:20px"></div>

<div id="uv_comparison" style="margin-top:15px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#06b6d4">üìö UV Dose Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Pathogen</th><th>Log Reduction</th><th>Dose (mJ/cm¬≤)</th></tr>
</thead>
<tbody>
<tr><td>E. coli</td><td>4-log</td><td>20-25</td></tr>
<tr><td>Fecal Coliform</td><td>4-log</td><td>30-40</td></tr>
<tr><td>Giardia</td><td>3-log</td><td>11</td></tr>
<tr><td>Cryptosporidium</td><td>3-log</td><td>12</td></tr>
<tr><td>Virus (Adeno)</td><td>4-log</td><td>186</td></tr>
<tr style="background:rgba(74,222,128,0.1)"><td>CA Title 22 Reuse</td><td>5-log virus</td><td>100-140</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">UVT Guidelines:</strong>
<div style="font-size:11px;margin-top:5px">
Secondary: 55-65%<br>
Tertiary: 65-75%<br>
Reuse: 70-85%<br>
Drinking: >90%
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">Lamp Types:</strong>
<div style="font-size:11px;margin-top:5px">
LP: 254nm, efficient, longer life<br>
LPHO: Higher output, fewer lamps<br>
MP: Broad spectrum, compact
</div>
</div>
</div>
</div>

</div>
</div>

<div class="section">
<div class="section-h">üîÑ Sludge Thickening</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Feed Flow (GPM)</label><input type="number" id="thick_flow" value="100"></div>
<div class="input-group"><label>Feed Solids (%)</label><input type="number" id="thick_feed" value="0.8" step="0.1"></div>
<div class="input-group"><label>Thickened Solids (%)</label><input type="number" id="thick_out" value="5.0" step="0.1"></div>
<div class="input-group"><label>Capture Rate (%)</label><input type="number" id="thick_capture" value="95"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcThickening()">Calculate</button>
<button class="btn gray" onclick="resetThickening()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Dry Solids In</td><td><span class="result" id="r_thick_in">-</span></td><td>lb/hr</td></tr>
<tr><td class="rowh">Thickened Flow</td><td><span class="result" id="r_thick_flowout">-</span></td><td>GPM</td></tr>
<tr><td class="rowh">Solids Captured</td><td><span class="result" id="r_thick_captured">-</span></td><td>lb/hr</td></tr>
<tr><td class="rowh">Volume Reduction</td><td><span class="result" id="r_thick_reduction">-</span></td><td>%</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">‚öñÔ∏è Equalization Basin Sizing</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Peak Flow (MGD)</label><input type="number" id="eq_peak" value="8.0" step="0.1"></div>
<div class="input-group"><label>Average Flow (MGD)</label><input type="number" id="eq_avg" value="5.0" step="0.1"></div>
<div class="input-group"><label>Peak Duration (hrs)</label><input type="number" id="eq_duration" value="4"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcEQ()">Calculate</button>
<button class="btn gray" onclick="resetEQ()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Storage Volume</td><td><span class="result" id="r_eq_vol">-</span></td><td>MG</td></tr>
<tr><td class="rowh">Storage Volume</td><td><span class="result" id="r_eq_gal">-</span></td><td>gallons</td></tr>
<tr><td class="rowh">Peak-to-Avg Ratio</td><td><span class="result" id="r_eq_ratio">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="wetWeatherCalculator" style="border:2px solid #0ea5e9">
<div class="section-h" style="background:linear-gradient(135deg,#0284c7,#0ea5e9);color:white">
üåßÔ∏è Wet Weather & I/I Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Storm Analysis</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Analyze wet weather impacts, I&I contribution, and treatment capacity during storm events.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#0ea5e9">üìä Baseline (Dry Weather) Conditions</h4>
<div class="row">
<div class="input-group">
<label style="color:#0ea5e9">Avg Dry Weather Flow (MGD)</label>
<input type="number" id="ww_dwf" value="5.0" step="0.1" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label style="color:#0ea5e9">Min Daily Flow (MGD)</label>
<input type="number" id="ww_min" value="3.0" step="0.1" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label style="color:#0ea5e9">Max Dry Weather Flow (MGD)</label>
<input type="number" id="ww_max_dry" value="7.0" step="0.1" onchange="calcWetWeather()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Service Area (acres)</label>
<input type="number" id="ww_area" value="5000" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Population Served</label>
<input type="number" id="ww_pop" value="50000" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Sewer Length (miles)</label>
<input type="number" id="ww_sewer_mi" value="100" onchange="calcWetWeather()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üåßÔ∏è Storm Event Data</h4>
<div class="row">
<div class="input-group">
<label>Peak Wet Weather Flow (MGD)</label>
<input type="number" id="ww_wwf" value="15.0" step="0.5" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Storm Duration (hours)</label>
<input type="number" id="ww_duration" value="6" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Rainfall Amount (inches)</label>
<input type="number" id="ww_rain" value="1.5" step="0.1" onchange="calcWetWeather()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Storm Recurrence (years)</label>
<select id="ww_recurrence" style="font-size:14px" onchange="calcWetWeather()">
<option value="1">1-year (frequent)</option>
<option value="2" selected>2-year</option>
<option value="5">5-year</option>
<option value="10">10-year</option>
<option value="25">25-year</option>
</select>
</div>
<div class="input-group">
<label>Groundwater Level</label>
<select id="ww_gw" style="font-size:14px" onchange="calcWetWeather()">
<option value="low">Low (deep)</option>
<option value="normal" selected>Normal</option>
<option value="high">High (shallow)</option>
</select>
</div>
<div class="input-group">
<label>Season</label>
<select id="ww_season" style="font-size:14px" onchange="calcWetWeather()">
<option value="dry">Dry Season</option>
<option value="wet" selected>Wet Season</option>
<option value="spring">Spring Thaw</option>
</select>
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üè≠ Treatment Capacity</h4>
<div class="row">
<div class="input-group">
<label>Design Capacity (MGD)</label>
<input type="number" id="ww_capacity" value="10.0" step="0.5" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Peak Hydraulic Capacity (MGD)</label>
<input type="number" id="ww_peak_cap" value="15.0" step="0.5" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Bypass/SSO Threshold (MGD)</label>
<input type="number" id="ww_bypass" value="18.0" step="0.5" onchange="calcWetWeather()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>EQ/Storage Available (MG)</label>
<input type="number" id="ww_storage" value="2.0" step="0.1" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Avg Influent BOD (mg/L)</label>
<input type="number" id="ww_bod_dry" value="200" onchange="calcWetWeather()">
</div>
<div class="input-group">
<label>Permit BOD Limit (mg/L)</label>
<input type="number" id="ww_bod_lim" value="30" onchange="calcWetWeather()">
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcWetWeather()">üåßÔ∏è Analyze Storm Event</button>
<button class="btn blue" onclick="calcIandI()">üíß Calculate I&I</button>
<button class="btn orange" onclick="calcStorageNeeded()">üèóÔ∏è Storage Requirements</button>
<button class="btn gray" onclick="resetWetWeather()">üîÑ Reset</button>
</div>

<div id="ww_results" style="margin-top:20px"></div>

<div id="ww_ii_results" style="margin-top:15px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#0ea5e9">üìö Wet Weather Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Parameter</th><th>Typical Range</th><th>Concern Level</th></tr>
</thead>
<tbody>
<tr><td>Peak/Avg Flow Ratio</td><td>2.0-3.0</td><td>&gt;4.0 = High I&I</td></tr>
<tr><td>I&I Rate (gpd/mi)</td><td>2,000-5,000</td><td>&gt;10,000 = Excessive</td></tr>
<tr><td>I&I Rate (gpd/capita)</td><td>20-50</td><td>&gt;100 = Excessive</td></tr>
<tr><td>RDII (gal/in/acre)</td><td>500-2,000</td><td>&gt;5,000 = High</td></tr>
<tr><td>Peaking Factor</td><td>2.5-3.5</td><td>&gt;5.0 = I&I issues</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#ef4444">I&I Sources:</strong>
<div style="font-size:11px;margin-top:5px">
<strong>Inflow:</strong> Direct connections<br>
- Roof drains, sump pumps<br>
- Cross-connections<br>
<strong>Infiltration:</strong> Groundwater<br>
- Cracked pipes, joints<br>
- Manholes, laterals
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#4ade80">Treatment Impacts:</strong>
<div style="font-size:11px;margin-top:5px">
- Diluted influent (low BOD)<br>
- Hydraulic overload<br>
- Solids washout risk<br>
- Reduced SRT<br>
- Nitrification loss<br>
- SSO/bypass risk
</div>
</div>
</div>
</div>

</div>
</div>

<div class="section">
<div class="section-h">üß™ Chemical Feed Rate</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="chem_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Target Dose (mg/L)</label><input type="number" id="chem_dose" value="50"></div>
<div class="input-group"><label>Solution Strength (%)</label><input type="number" id="chem_strength" value="50"></div>
<div class="input-group"><label>Specific Gravity</label><input type="number" id="chem_sg" value="1.2" step="0.01"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcChemFeed()">Calculate</button>
<button class="btn gray" onclick="resetChemFeed()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Chemical (dry)</td><td><span class="result" id="r_chem_dry">-</span></td><td>lb/day</td></tr>
<tr><td class="rowh">Solution Volume</td><td><span class="result" id="r_chem_gal">-</span></td><td>gal/day</td></tr>
<tr><td class="rowh">Feed Rate</td><td><span class="result" id="r_chem_gph">-</span></td><td>gal/hr</td></tr>
<tr><td class="rowh">Feed Rate</td><td><span class="result" id="r_chem_mlmin">-</span></td><td>mL/min</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üóëÔ∏è Screenings & Grit Estimation</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Average Flow (MGD)</label><input type="number" id="screen_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Screen Opening (in)</label><input type="number" id="screen_opening" value="0.25" step="0.05"></div>
<div class="input-group"><label>Population Served</label><input type="number" id="screen_pop" value="50000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcScreenings()">Calculate</button>
<button class="btn gray" onclick="resetScreenings()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Screenings</td><td><span class="result" id="r_screen_vol">-</span></td><td>cu ft/day</td></tr>
<tr><td class="rowh">Screenings</td><td><span class="result" id="r_screen_cy">-</span></td><td>cu yd/month</td></tr>
<tr><td class="rowh">Grit Volume</td><td><span class="result" id="r_grit_vol2">-</span></td><td>cu ft/day</td></tr>
<tr><td class="rowh">Grit</td><td><span class="result" id="r_grit_cy">-</span></td><td>cu yd/month</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üèóÔ∏è Primary Clarifier Performance</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="prim_bod_in" value="250"></div>
<div class="input-group"><label>Influent TSS (mg/L)</label><input type="number" id="prim_tss_in" value="300"></div>
<div class="input-group"><label>Surface Overflow Rate (gpd/sf)</label><input type="number" id="prim_sor" value="800"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPrimary()">Calculate</button>
<button class="btn gray" onclick="resetPrimary()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Est. BOD Removal</td><td><span class="result" id="r_prim_bod_rem">-</span></td><td>%</td></tr>
<tr><td class="rowh">Est. TSS Removal</td><td><span class="result" id="r_prim_tss_rem">-</span></td><td>%</td></tr>
<tr><td class="rowh">Effluent BOD</td><td><span class="result" id="r_prim_bod_out">-</span></td><td>mg/L</td></tr>
<tr><td class="rowh">Effluent TSS</td><td><span class="result" id="r_prim_tss_out">-</span></td><td>mg/L</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üîÑ Trickling Filter Loading</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="tf_flow" value="2.0" step="0.1"></div>
<div class="input-group"><label>BOD (mg/L)</label><input type="number" id="tf_bod" value="150"></div>
<div class="input-group"><label>Media Volume (cu ft)</label><input type="number" id="tf_vol" value="50000"></div>
<div class="input-group"><label>Recirculation Ratio</label><input type="number" id="tf_recirc" value="1.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcTF()">Calculate</button>
<button class="btn gray" onclick="resetTF()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Organic Loading</td><td><span class="result" id="r_tf_olr">-</span></td><td>lb BOD/1000 cf/day</td></tr>
<tr><td class="rowh">Hydraulic Loading</td><td><span class="result" id="r_tf_hlr">-</span></td><td>gpd/sq ft</td></tr>
<tr><td class="rowh">Est. BOD Removal</td><td><span class="result" id="r_tf_removal">-</span></td><td>%</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üå± Biosolids Land Application</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Dry Tons/Year</label><input type="number" id="bio_tons" value="500"></div>
<div class="input-group"><label>% Nitrogen</label><input type="number" id="bio_n" value="4" step="0.1"></div>
<div class="input-group"><label>N Application Rate (lb/ac/yr)</label><input type="number" id="bio_rate" value="150"></div>
<div class="input-group"><label>% Available N</label><input type="number" id="bio_avail" value="40"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcBiosolids()">Calculate</button>
<button class="btn gray" onclick="resetBiosolids()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Total N</td><td><span class="result" id="r_bio_total_n">-</span></td><td>lb/yr</td></tr>
<tr><td class="rowh">Available N</td><td><span class="result" id="r_bio_avail_n">-</span></td><td>lb/yr</td></tr>
<tr><td class="rowh">Land Required</td><td><span class="result" id="r_bio_acres">-</span></td><td>acres</td></tr>
<tr><td class="rowh">Application Rate</td><td><span class="result" id="r_bio_tons_ac">-</span></td><td>dry tons/acre</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üìê Hydraulic Profile Calculator</div>
<div class="section-content">
<div class="note info">Calculate water surface elevations (WSE) through treatment units. Enter starting elevation and head losses to generate the hydraulic grade line.</div>

<div style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="color:#4ade80;margin:0 0 15px 0">üìç Starting Conditions</h4>
<div class="row">
<div class="input-group"><label>Design Flow (MGD)</label><input type="number" id="hydr_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Peak Flow Factor</label><input type="number" id="hydr_peak" value="2.5" step="0.1"></div>
<div class="input-group"><label>Outfall WSE (ft)</label><input type="number" id="hydr_outfall" value="100.00" step="0.01"></div>
</div>
</div>

<div style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="color:#60a5fa;margin:0 0 15px 0">üè≠ Unit Process Head Losses (ft)</h4>
<p style="color:#94a3b8;font-size:13px;margin-bottom:15px">Enter head loss across each unit at peak flow. Use 0 for units not present.</p>

<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:15px">

<div style="background:#374151;padding:15px;border-radius:8px">
<h5 style="color:#fbbf24;margin:0 0 10px 0">Preliminary Treatment</h5>
<div class="input-group"><label>Bar Screen</label><input type="number" id="hl_barscreen" value="0.50" step="0.01"></div>
<div class="input-group"><label>Grit Chamber</label><input type="number" id="hl_grit" value="0.25" step="0.01"></div>
<div class="input-group"><label>Flow Measurement</label><input type="number" id="hl_parshall" value="0.30" step="0.01"></div>
</div>

<div style="background:#374151;padding:15px;border-radius:8px">
<h5 style="color:#fbbf24;margin:0 0 10px 0">Primary Treatment</h5>
<div class="input-group"><label>Primary Clarifier Inlet</label><input type="number" id="hl_prim_in" value="0.20" step="0.01"></div>
<div class="input-group"><label>Primary Clarifier</label><input type="number" id="hl_prim" value="0.50" step="0.01"></div>
<div class="input-group"><label>Primary Effluent Weir</label><input type="number" id="hl_prim_weir" value="0.15" step="0.01"></div>
</div>

<div style="background:#374151;padding:15px;border-radius:8px">
<h5 style="color:#fbbf24;margin:0 0 10px 0">Secondary Treatment</h5>
<div class="input-group"><label>Aeration Basin Inlet</label><input type="number" id="hl_aer_in" value="0.25" step="0.01"></div>
<div class="input-group"><label>Aeration Basin</label><input type="number" id="hl_aeration" value="0.50" step="0.01"></div>
<div class="input-group"><label>Secondary Clarifier Inlet</label><input type="number" id="hl_sec_in" value="0.30" step="0.01"></div>
<div class="input-group"><label>Secondary Clarifier</label><input type="number" id="hl_secondary" value="0.50" step="0.01"></div>
<div class="input-group"><label>Secondary Effluent Weir</label><input type="number" id="hl_sec_weir" value="0.20" step="0.01"></div>
</div>

<div style="background:#374151;padding:15px;border-radius:8px">
<h5 style="color:#fbbf24;margin:0 0 10px 0">Tertiary/Effluent</h5>
<div class="input-group"><label>Filters</label><input type="number" id="hl_filters" value="0.00" step="0.01"></div>
<div class="input-group"><label>UV/Disinfection</label><input type="number" id="hl_disinfect" value="0.25" step="0.01"></div>
<div class="input-group"><label>Effluent Piping</label><input type="number" id="hl_eff_pipe" value="0.50" step="0.01"></div>
<div class="input-group"><label>Cascade Aerator</label><input type="number" id="hl_cascade" value="0.00" step="0.01"></div>
</div>

</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcHydraulicProfile()">üìê Calculate Profile</button>
<button class="btn blue" onclick="exportHydraulicProfile()">üì§ Export CSV</button>
<button class="btn gray" onclick="resetHydraulicProfile()">Reset</button>
</div>

<div id="hydraulic_results" style="margin-top:20px"></div>

<div id="hydraulic_chart_container" style="display:none;margin-top:20px">
<h4 style="color:#4ade80;margin-bottom:15px">üìä Hydraulic Profile Chart</h4>
<div style="background:#1a2744;padding:20px;border-radius:12px">
<canvas id="hydraulicChart" height="250"></canvas>
</div>
</div>

</div>
</div>

<div class="section">
<div class="section-h">üîß Pipe Headloss (Hazen-Williams)</div>
<div class="section-content">
<div class="note info">Calculate friction headloss in pipes using Hazen-Williams equation</div>
<div class="row">
<div class="input-group"><label>Flow Rate (GPM)</label><input type="number" id="pipe_flow" value="1000"></div>
<div class="input-group"><label>Pipe Diameter (in)</label><input type="number" id="pipe_dia" value="8"></div>
<div class="input-group"><label>Pipe Length (ft)</label><input type="number" id="pipe_length" value="500"></div>
</div>
<div class="row">
<div class="input-group"><label>C-Factor</label>
<select id="pipe_c">
<option value="150">PVC/HDPE (150)</option>
<option value="140">New Ductile Iron (140)</option>
<option value="130" selected>Concrete (130)</option>
<option value="120">Aged Ductile Iron (120)</option>
<option value="100">Old Cast Iron (100)</option>
</select></div>
<div class="input-group"><label>Fittings K-value</label><input type="number" id="pipe_k" value="2.5" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPipeHeadloss()">Calculate</button>
<button class="btn gray" onclick="resetPipeHeadloss()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Velocity</td><td><span class="result" id="r_pipe_vel">-</span></td><td>ft/s</td></tr>
<tr><td class="rowh">Friction Loss</td><td><span class="result" id="r_pipe_friction">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Fitting Losses</td><td><span class="result" id="r_pipe_fittings">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Total Head Loss</td><td><span class="result" id="r_pipe_total">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Head Loss per 100 ft</td><td><span class="result" id="r_pipe_per100">-</span></td><td>ft/100 ft</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üåä Weir & Orifice Head Loss</div>
<div class="section-content">
<div class="note info">Calculate head over weirs and through orifices</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">

<div style="background:#1a2744;padding:15px;border-radius:8px">
<h5 style="color:#4ade80;margin:0 0 10px 0">Rectangular Weir</h5>
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="weir_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Weir Length (ft)</label><input type="number" id="weir_length" value="20"></div>
<div class="input-group"><label>Weir Coefficient</label><input type="number" id="weir_coef" value="3.33" step="0.01"></div>
<button class="btn green" onclick="calcWeir()" style="margin-top:10px">Calculate</button>
<div style="margin-top:10px">
<span style="color:#94a3b8">Head over Weir: </span><strong id="r_weir_head" style="color:#4ade80">-</strong> ft
</div>
</div>

<div style="background:#1a2744;padding:15px;border-radius:8px">
<h5 style="color:#60a5fa;margin:0 0 10px 0">Circular Orifice</h5>
<div class="input-group"><label>Flow (GPM)</label><input type="number" id="orif_flow" value="500"></div>
<div class="input-group"><label>Orifice Diameter (in)</label><input type="number" id="orif_dia" value="6"></div>
<div class="input-group"><label>Discharge Coefficient</label><input type="number" id="orif_cd" value="0.62" step="0.01"></div>
<button class="btn blue" onclick="calcOrifice()" style="margin-top:10px">Calculate</button>
<div style="margin-top:10px">
<span style="color:#94a3b8">Head Required: </span><strong id="r_orif_head" style="color:#60a5fa">-</strong> ft
</div>
</div>

</div>
</div>
</div>

<div class="section">
<div class="section-h">„Ä∞Ô∏è Open Channel Flow (Manning's)</div>
<div class="section-content">
<div class="note info">Calculate flow depth and velocity in open channels using Manning's equation</div>
<div class="row">
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="chan_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Channel Width (ft)</label><input type="number" id="chan_width" value="4"></div>
<div class="input-group"><label>Channel Slope (ft/ft)</label><input type="number" id="chan_slope" value="0.001" step="0.0001"></div>
</div>
<div class="row">
<div class="input-group"><label>Manning's n</label>
<select id="chan_n">
<option value="0.013">Concrete (0.013)</option>
<option value="0.015" selected>Concrete w/ gravel (0.015)</option>
<option value="0.022">Corrugated Metal (0.022)</option>
<option value="0.030">Earth Channel (0.030)</option>
</select></div>
<div class="input-group"><label>Side Slope (H:V, 0=vertical)</label><input type="number" id="chan_ss" value="0" step="0.5"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcChannelFlow()">Calculate</button>
<button class="btn gray" onclick="resetChannelFlow()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Normal Depth</td><td><span class="result" id="r_chan_depth">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Flow Area</td><td><span class="result" id="r_chan_area">-</span></td><td>sq ft</td></tr>
<tr><td class="rowh">Wetted Perimeter</td><td><span class="result" id="r_chan_wp">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Hydraulic Radius</td><td><span class="result" id="r_chan_rh">-</span></td><td>ft</td></tr>
<tr><td class="rowh">Velocity</td><td><span class="result" id="r_chan_vel">-</span></td><td>ft/s</td></tr>
<tr><td class="rowh">Froude Number</td><td><span class="result" id="r_chan_froude">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">‚öóÔ∏è Chemical Feed Rate Optimizer</div>
<div class="section-content">
<div class="note info">Optimize chemical dosing based on target removal and real-time conditions</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#4ade80;margin:0 0 15px 0">üìä Current Conditions</h4>
<div class="input-group"><label>Flow Rate (MGD)</label><input type="number" id="cfo_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Influent Phosphorus (mg/L)</label><input type="number" id="cfo_p_in" value="6.0" step="0.1"></div>
<div class="input-group"><label>Target Effluent P (mg/L)</label><input type="number" id="cfo_p_target" value="1.0" step="0.1"></div>
<div class="input-group"><label>Current pH</label><input type="number" id="cfo_ph" value="7.2" step="0.1"></div>
<div class="input-group"><label>Alkalinity (mg/L as CaCO3)</label><input type="number" id="cfo_alk" value="200"></div>
</div>

<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#60a5fa;margin:0 0 15px 0">üíä Chemical Selection</h4>
<div class="input-group"><label>Primary Chemical</label>
<select id="cfo_chem1">
<option value="alum">Alum (Al‚ÇÇ(SO‚ÇÑ)‚ÇÉ)</option>
<option value="ferric">Ferric Chloride (FeCl‚ÇÉ)</option>
<option value="ferrous">Ferrous Sulfate (FeSO‚ÇÑ)</option>
<option value="pac">PAC (Poly Aluminum Chloride)</option>
</select></div>
<div class="input-group"><label>Solution Strength (%)</label><input type="number" id="cfo_strength" value="48"></div>
<div class="input-group"><label>Specific Gravity</label><input type="number" id="cfo_sg" value="1.33" step="0.01"></div>
<div class="input-group"><label>Chemical Cost ($/lb)</label><input type="number" id="cfo_cost" value="0.15" step="0.01"></div>
<div class="input-group"><label>Molar Ratio Target (Me:P)</label><input type="number" id="cfo_ratio" value="2.0" step="0.1"></div>
</div>
</div>

<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="optimizeChemFeed()">üéØ Optimize Feed Rate</button>
<button class="btn blue" onclick="calcChemCost()">üí∞ Calculate Costs</button>
<button class="btn gray" onclick="resetChemOptimizer()">Reset</button>
</div>

<div id="cfo_results" style="margin-top:20px"></div>
</div>
</div>

<div class="section">
<div class="section-h">üåä Equalization Basin Sizing</div>
<div class="section-content">
<div class="note info">Size EQ basins for flow and load equalization based on diurnal patterns</div>

<div class="row">
<div class="input-group"><label>Average Daily Flow (MGD)</label><input type="number" id="eq_avg_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Peak Hour Flow (MGD)</label><input type="number" id="eq_peak_flow" value="8.0" step="0.1"></div>
<div class="input-group"><label>Minimum Hour Flow (MGD)</label><input type="number" id="eq_min_flow" value="2.5" step="0.1"></div>
<div class="input-group"><label>Target Equalized Flow (MGD)</label><input type="number" id="eq_target" value="5.5" step="0.1"></div>
</div>

<div class="row">
<div class="input-group"><label>Operating Depth (ft)</label><input type="number" id="eq_depth" value="12"></div>
<div class="input-group"><label>Freeboard (ft)</label><input type="number" id="eq_freeboard" value="2"></div>
<div class="input-group"><label>Safety Factor</label><input type="number" id="eq_sf" value="1.25" step="0.05"></div>
</div>

<div style="background:#1a2744;padding:15px;border-radius:8px;margin:15px 0">
<h5 style="color:#fbbf24;margin:0 0 10px 0">üìà Hourly Flow Pattern (24-hr)</h5>
<p style="color:#94a3b8;font-size:13px;margin-bottom:10px">Enter flows as % of average (default pattern loaded)</p>
<div style="display:grid;grid-template-columns:repeat(12, 1fr);gap:5px;font-size:12px">
<div><label>12AM</label><input type="number" id="eq_h0" value="50" style="width:100%"></div>
<div><label>2AM</label><input type="number" id="eq_h2" value="40" style="width:100%"></div>
<div><label>4AM</label><input type="number" id="eq_h4" value="45" style="width:100%"></div>
<div><label>6AM</label><input type="number" id="eq_h6" value="80" style="width:100%"></div>
<div><label>8AM</label><input type="number" id="eq_h8" value="130" style="width:100%"></div>
<div><label>10AM</label><input type="number" id="eq_h10" value="120" style="width:100%"></div>
<div><label>12PM</label><input type="number" id="eq_h12" value="115" style="width:100%"></div>
<div><label>2PM</label><input type="number" id="eq_h14" value="110" style="width:100%"></div>
<div><label>4PM</label><input type="number" id="eq_h16" value="105" style="width:100%"></div>
<div><label>6PM</label><input type="number" id="eq_h18" value="125" style="width:100%"></div>
<div><label>8PM</label><input type="number" id="eq_h20" value="110" style="width:100%"></div>
<div><label>10PM</label><input type="number" id="eq_h22" value="70" style="width:100%"></div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcEQBasin()">üìê Size Basin</button>
<button class="btn orange" onclick="loadTypicalPattern()">üìä Load Typical Pattern</button>
<button class="btn gray" onclick="resetEQBasin()">Reset</button>
</div>

<div id="eq_results" style="margin-top:20px"></div>
</div>
</div>

<div class="section">
<div class="section-h">‚ö†Ô∏è Violation Risk Predictor</div>
<div class="section-content">
<div class="note info">Predict probability of permit violations based on current performance and variability</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#ef4444;margin:0 0 15px 0">üìã Permit Limits</h4>
<div class="input-group"><label>BOD Daily Max (mg/L)</label><input type="number" id="vr_bod_limit" value="45"></div>
<div class="input-group"><label>BOD Monthly Avg (mg/L)</label><input type="number" id="vr_bod_monthly" value="30"></div>
<div class="input-group"><label>TSS Daily Max (mg/L)</label><input type="number" id="vr_tss_limit" value="45"></div>
<div class="input-group"><label>TSS Monthly Avg (mg/L)</label><input type="number" id="vr_tss_monthly" value="30"></div>
<div class="input-group"><label>NH3-N Daily Max (mg/L)</label><input type="number" id="vr_nh3_limit" value="4.0" step="0.1"></div>
</div>

<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#4ade80;margin:0 0 15px 0">üìä Current Performance (30-day)</h4>
<div class="input-group"><label>BOD Average (mg/L)</label><input type="number" id="vr_bod_avg" value="18"></div>
<div class="input-group"><label>BOD Std Deviation</label><input type="number" id="vr_bod_std" value="5"></div>
<div class="input-group"><label>TSS Average (mg/L)</label><input type="number" id="vr_tss_avg" value="15"></div>
<div class="input-group"><label>TSS Std Deviation</label><input type="number" id="vr_tss_std" value="4"></div>
<div class="input-group"><label>NH3-N Average (mg/L)</label><input type="number" id="vr_nh3_avg" value="1.5" step="0.1"></div>
<div class="input-group"><label>NH3-N Std Deviation</label><input type="number" id="vr_nh3_std" value="0.8" step="0.1"></div>
</div>
</div>

<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="predictViolationRisk()">üé≤ Calculate Risk</button>
<button class="btn purple" onclick="showRiskTrend()">üìà Show Trend</button>
<button class="btn gray" onclick="resetViolationRisk()">Reset</button>
</div>

<div id="vr_results" style="margin-top:20px"></div>
</div>
</div>

<div class="section" id="massBalanceSection">
<div class="section-h">‚öñÔ∏è Mass Balance Calculator</div>
<div class="section-content">
<div class="note info">Calculate mass balances for BOD, TSS, nitrogen, and phosphorus through the treatment process</div>

<div style="background:#1a2744;padding:20px;border-radius:12px;margin-bottom:20px">
<h4 style="color:#4ade80;margin:0 0 15px 0">üì• Influent Conditions</h4>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="mb_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>BOD (mg/L)</label><input type="number" id="mb_bod_in" value="200"></div>
<div class="input-group"><label>TSS (mg/L)</label><input type="number" id="mb_tss_in" value="220"></div>
<div class="input-group"><label>TKN (mg/L)</label><input type="number" id="mb_tkn_in" value="40"></div>
<div class="input-group"><label>Total P (mg/L)</label><input type="number" id="mb_tp_in" value="7"></div>
</div>
</div>

<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;margin-bottom:20px">
<div style="background:#1a2744;padding:15px;border-radius:8px">
<h5 style="color:#fbbf24;margin:0 0 10px 0">Primary Treatment</h5>
<div class="input-group"><label>BOD Removal (%)</label><input type="number" id="mb_prim_bod" value="30"></div>
<div class="input-group"><label>TSS Removal (%)</label><input type="number" id="mb_prim_tss" value="60"></div>
</div>
<div style="background:#1a2744;padding:15px;border-radius:8px">
<h5 style="color:#60a5fa;margin:0 0 10px 0">Secondary Treatment</h5>
<div class="input-group"><label>BOD Removal (%)</label><input type="number" id="mb_sec_bod" value="90"></div>
<div class="input-group"><label>TSS Removal (%)</label><input type="number" id="mb_sec_tss" value="85"></div>
<div class="input-group"><label>TKN Removal (%)</label><input type="number" id="mb_sec_tkn" value="80"></div>
</div>
<div style="background:#1a2744;padding:15px;border-radius:8px">
<h5 style="color:#a78bfa;margin:0 0 10px 0">Tertiary/Chemical</h5>
<div class="input-group"><label>P Removal (%)</label><input type="number" id="mb_tert_tp" value="85"></div>
<div class="input-group"><label>Additional TSS (%)</label><input type="number" id="mb_tert_tss" value="50"></div>
</div>
</div>

<div class="row">
<div class="input-group"><label>Sludge Yield (lb VSS/lb BOD)</label><input type="number" id="mb_yield" value="0.6" step="0.05"></div>
<div class="input-group"><label>VSS/TSS Ratio</label><input type="number" id="mb_vss_tss" value="0.75" step="0.05"></div>
<div class="input-group"><label>Primary Sludge (% solids)</label><input type="number" id="mb_prim_pct" value="4"></div>
<div class="input-group"><label>WAS (% solids)</label><input type="number" id="mb_was_pct" value="0.8" step="0.1"></div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcMassBalance()">‚öñÔ∏è Calculate Mass Balance</button>
<button class="btn blue" onclick="showMassBalanceDiagram()">üìä Show Diagram</button>
<button class="btn gray" onclick="resetMassBalance()">Reset</button>
</div>

<div id="mb_results" style="margin-top:20px"></div>
</div>
</div>

<div class="section" id="oteCalcSection">
<div class="section-h">üí® Oxygen Transfer Efficiency (OTE) Calculator</div>
<div class="section-content">
<div class="note info">Calculate actual oxygen transfer rate (AOTR) from standard conditions and evaluate aeration efficiency</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#4ade80;margin:0 0 15px 0">üîß System Parameters</h4>
<div class="input-group"><label>Diffuser Type</label>
<select id="ote_diffuser">
<option value="fine">Fine Bubble (SOTE 25-35%)</option>
<option value="coarse">Coarse Bubble (SOTE 10-15%)</option>
<option value="membrane">Membrane (SOTE 30-40%)</option>
<option value="jet">Jet Aerator (SOTE 20-30%)</option>
</select></div>
<div class="input-group"><label>SOTE @ SWD (%)</label><input type="number" id="ote_sote" value="28"></div>
<div class="input-group"><label>Submergence Depth (ft)</label><input type="number" id="ote_depth" value="15"></div>
<div class="input-group"><label>Airflow Rate (SCFM)</label><input type="number" id="ote_airflow" value="3000"></div>
<div class="input-group"><label>Number of Diffusers</label><input type="number" id="ote_num_diff" value="500"></div>
</div>

<div style="background:#1a2744;padding:20px;border-radius:12px">
<h4 style="color:#60a5fa;margin:0 0 15px 0">üå°Ô∏è Process Conditions</h4>
<div class="input-group"><label>Water Temperature (¬∞C)</label><input type="number" id="ote_temp" value="20"></div>
<div class="input-group"><label>Operating DO (mg/L)</label><input type="number" id="ote_do" value="2.0" step="0.1"></div>
<div class="input-group"><label>Altitude (ft)</label><input type="number" id="ote_altitude" value="500"></div>
<div class="input-group"><label>Alpha Factor (Œ±)</label><input type="number" id="ote_alpha" value="0.5" step="0.05"></div>
<div class="input-group"><label>Beta Factor (Œ≤)</label><input type="number" id="ote_beta" value="0.95" step="0.01"></div>
<div class="input-group"><label>Fouling Factor (F)</label><input type="number" id="ote_fouling" value="0.9" step="0.05"></div>
</div>
</div>

<div class="row" style="margin-top:15px">
<div class="input-group"><label>Oxygen Required (lb O‚ÇÇ/day)</label><input type="number" id="ote_o2_req" value="5000"></div>
<div class="input-group"><label>Blower Efficiency (%)</label><input type="number" id="ote_blower_eff" value="70"></div>
<div class="input-group"><label>Motor Efficiency (%)</label><input type="number" id="ote_motor_eff" value="95"></div>
<div class="input-group"><label>Electricity Cost ($/kWh)</label><input type="number" id="ote_elec_cost" value="0.10" step="0.01"></div>
</div>

<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="calcOTE()">üí® Calculate OTE</button>
<button class="btn orange" onclick="compareAerators()">üìä Compare Systems</button>
<button class="btn gray" onclick="resetOTE()">Reset</button>
</div>

<div id="ote_results" style="margin-top:20px"></div>
</div>
</div>

<div class="section" id="pumpStationCalculator" style="border:2px solid #14b8a6">
<div class="section-h" style="background:linear-gradient(135deg,#0d9488,#14b8a6);color:white">
üîÑ Pump Station Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Lift Station</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Design and analyze pump stations: wet well sizing, pump selection, cycle times, and energy costs.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#14b8a6">üìä Design Flows</h4>
<div class="row">
<div class="input-group">
<label style="color:#14b8a6">Average Daily Flow (MGD)</label>
<input type="number" id="ps_avg_flow" value="1.0" step="0.1" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label style="color:#14b8a6">Peak Hour Flow (MGD)</label>
<input type="number" id="ps_peak_flow" value="2.5" step="0.1" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label style="color:#14b8a6">Peaking Factor</label>
<input type="number" id="ps_pf" value="2.5" step="0.1" onchange="calcPumpStation()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Min Flow (MGD)</label>
<input type="number" id="ps_min_flow" value="0.3" step="0.1" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Design Life (years)</label>
<input type="number" id="ps_life" value="20" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Growth Factor (%/yr)</label>
<input type="number" id="ps_growth" value="2" step="0.5" onchange="calcPumpStation()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">ü™£ Wet Well Design</h4>
<div class="row">
<div class="input-group">
<label>Wet Well Shape</label>
<select id="ps_shape" style="font-size:14px" onchange="calcPumpStation()">
<option value="circular" selected>Circular</option>
<option value="rectangular">Rectangular</option>
</select>
</div>
<div class="input-group">
<label>Diameter / Length (ft)</label>
<input type="number" id="ps_dim1" value="10" step="0.5" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Width (ft) - Rect only</label>
<input type="number" id="ps_dim2" value="8" step="0.5" onchange="calcPumpStation()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Lead Pump On (ft from bottom)</label>
<input type="number" id="ps_lead_on" value="6" step="0.5" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Lead Pump Off (ft)</label>
<input type="number" id="ps_lead_off" value="3" step="0.5" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Lag Pump On (ft)</label>
<input type="number" id="ps_lag_on" value="8" step="0.5" onchange="calcPumpStation()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>High Level Alarm (ft)</label>
<input type="number" id="ps_hla" value="10" step="0.5" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Min Submergence (ft)</label>
<input type="number" id="ps_subm" value="2" step="0.5" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Freeboard (ft)</label>
<input type="number" id="ps_freeboard" value="2" step="0.5" onchange="calcPumpStation()">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">‚öôÔ∏è Pump Configuration</h4>
<div class="row">
<div class="input-group">
<label>Number of Pumps</label>
<select id="ps_num_pumps" style="font-size:14px" onchange="calcPumpStation()">
<option value="2" selected>2 (1 duty + 1 standby)</option>
<option value="3">3 (2 duty + 1 standby)</option>
<option value="4">4 (3 duty + 1 standby)</option>
</select>
</div>
<div class="input-group">
<label>Pump Capacity Each (GPM)</label>
<input type="number" id="ps_pump_gpm" value="700" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Pump Type</label>
<select id="ps_pump_type" style="font-size:14px">
<option value="submersible" selected>Submersible</option>
<option value="drypit">Dry Pit</option>
<option value="vertical">Vertical Turbine</option>
</select>
</div>
</div>
<div class="row">
<div class="input-group">
<label>Total Dynamic Head (ft)</label>
<input type="number" id="ps_tdh" value="45" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Pump Efficiency (%)</label>
<input type="number" id="ps_eff" value="70" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Motor Efficiency (%)</label>
<input type="number" id="ps_motor_eff" value="92" onchange="calcPumpStation()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üí∞ Energy & Costs</h4>
<div class="row">
<div class="input-group">
<label>Electricity Cost ($/kWh)</label>
<input type="number" id="ps_elec" value="0.10" step="0.01" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>Demand Charge ($/kW)</label>
<input type="number" id="ps_demand" value="12" onchange="calcPumpStation()">
</div>
<div class="input-group">
<label>VFD Installed?</label>
<select id="ps_vfd" style="font-size:14px" onchange="calcPumpStation()">
<option value="no">No - Constant Speed</option>
<option value="yes" selected>Yes - Variable Speed</option>
</select>
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcPumpStation()">üîÑ Calculate Pump Station</button>
<button class="btn blue" onclick="calcCycleTime()">‚è±Ô∏è Cycle Time Analysis</button>
<button class="btn orange" onclick="calcVFDSavings()">üí° VFD Savings</button>
<button class="btn gray" onclick="resetPumpStation()">üîÑ Reset</button>
</div>

<div id="ps_results" style="margin-top:20px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#14b8a6">üìö Pump Station Design Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Parameter</th><th>Typical Range</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>Min Cycle Time</td><td>5-10 min</td><td>Prevents motor overheating</td></tr>
<tr><td>Max Starts/Hour</td><td>6-12</td><td>Check motor rating</td></tr>
<tr><td>Detention Time</td><td>&lt;30 min</td><td>Prevents septicity</td></tr>
<tr><td>Min Velocity</td><td>2-3 fps</td><td>Prevents settling</td></tr>
<tr><td>VFD Savings</td><td>20-50%</td><td>Affinity laws (cube of speed)</td></tr>
</tbody>
</table>
</div>

</div>
</div>

<div class="section" id="membraneCalculator" style="border:2px solid #8b5cf6">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#8b5cf6);color:white">
üî¨ Membrane Calculator (MBR/RO/UF)
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Filtration</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Design and analyze membrane systems: MBR, UF, MF, RO, and NF applications.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#8b5cf6">‚öôÔ∏è System Configuration</h4>
<div class="row">
<div class="input-group">
<label style="color:#8b5cf6">Membrane Type</label>
<select id="mem_type" style="font-size:14px" onchange="updateMembraneDefaults()">
<option value="mbr" selected>MBR (Membrane Bioreactor)</option>
<option value="uf">UF (Ultrafiltration)</option>
<option value="mf">MF (Microfiltration)</option>
<option value="ro">RO (Reverse Osmosis)</option>
<option value="nf">NF (Nanofiltration)</option>
</select>
</div>
<div class="input-group">
<label style="color:#8b5cf6">Design Flow (MGD)</label>
<input type="number" id="mem_design_flow" value="1.0" step="0.1" onchange="calcMembrane()">
</div>
<div class="input-group">
<label style="color:#8b5cf6">Peak Factor</label>
<input type="number" id="mem_peak" value="1.5" step="0.1" onchange="calcMembrane()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Recovery (%)</label>
<input type="number" id="mem_recovery" value="85" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>Number of Trains</label>
<input type="number" id="mem_trains" value="2" min="1" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>Temperature (¬∞C)</label>
<input type="number" id="mem_temp" value="20" onchange="calcMembrane()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üìà Operating Parameters</h4>
<div class="row">
<div class="input-group">
<label>Design Flux (GFD)</label>
<input type="number" id="mem_flux" value="15" step="1" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>TMP (psi)</label>
<input type="number" id="mem_tmp" value="3" step="0.5" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>Clean Permeability (GFD/psi)</label>
<input type="number" id="mem_perm" value="150" onchange="calcMembrane()">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">üîß Module Specifications</h4>
<div class="row">
<div class="input-group">
<label>Module Area (sq ft)</label>
<input type="number" id="mem_mod_area" value="400" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>Modules per Cassette</label>
<input type="number" id="mem_mods_cass" value="8" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>Module Cost ($)</label>
<input type="number" id="mem_mod_cost" value="3000" onchange="calcMembrane()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Module Life (years)</label>
<input type="number" id="mem_mod_life" value="7" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>CIP Interval (days)</label>
<input type="number" id="mem_cip_interval" value="90" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>CIP Duration (hours)</label>
<input type="number" id="mem_cip_duration" value="4" onchange="calcMembrane()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üí∞ Operating Costs</h4>
<div class="row">
<div class="input-group">
<label>Electricity ($/kWh)</label>
<input type="number" id="mem_elec" value="0.10" step="0.01" onchange="calcMembrane()">
</div>
<div class="input-group">
<label>CIP Chemical Cost ($/clean)</label>
<input type="number" id="mem_cip_cost" value="500" onchange="calcMembrane()">
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcMembrane()">üî¨ Calculate Membrane System</button>
<button class="btn gray" onclick="resetMembrane()">üîÑ Reset</button>
</div>

<div id="mem_results" style="margin-top:20px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#8b5cf6">üìö Membrane Design Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Type</th><th>Typical Flux (GFD)</th><th>TMP (psi)</th><th>Recovery</th><th>Life (yrs)</th></tr>
</thead>
<tbody>
<tr><td>MBR</td><td>10-20</td><td>1-5</td><td>N/A</td><td>7-10</td></tr>
<tr><td>UF</td><td>30-60</td><td>10-30</td><td>90-95%</td><td>5-7</td></tr>
<tr><td>MF</td><td>40-80</td><td>5-15</td><td>90-95%</td><td>5-7</td></tr>
<tr><td>RO</td><td>15-25</td><td>150-400</td><td>75-85%</td><td>3-5</td></tr>
<tr><td>NF</td><td>20-35</td><td>75-150</td><td>80-90%</td><td>3-5</td></tr>
</tbody>
</table>
</div>

</div>
</div>

<div class="section" id="dafCalculator" style="border:2px solid #f59e0b">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white">
ü´ß DAF Calculator (Dissolved Air Flotation)
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Flotation</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Design dissolved air flotation systems for TSS, FOG, and algae removal.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#f59e0b">üìä Design Parameters</h4>
<div class="row">
<div class="input-group">
<label style="color:#f59e0b">Design Flow (MGD)</label>
<input type="number" id="daf_flow" value="1.0" step="0.1" onchange="calcDAF()">
</div>
<div class="input-group">
<label style="color:#f59e0b">Peak Factor</label>
<input type="number" id="daf_peak" value="1.5" step="0.1" onchange="calcDAF()">
</div>
<div class="input-group">
<label style="color:#f59e0b">Number of Units</label>
<input type="number" id="daf_units" value="2" min="1" onchange="calcDAF()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">üì• Influent Characteristics</h4>
<div class="row">
<div class="input-group">
<label>Influent TSS (mg/L)</label>
<input type="number" id="daf_inf_tss" value="200" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Influent FOG (mg/L)</label>
<input type="number" id="daf_inf_fog" value="100" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="daf_inf_bod" value="300" onchange="calcDAF()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Temperature (¬∞C)</label>
<input type="number" id="daf_temp" value="20" onchange="calcDAF()">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">‚öôÔ∏è Design Criteria</h4>
<div class="row">
<div class="input-group">
<label>Surface Loading (lb TSS/sf/d)</label>
<input type="number" id="daf_slr" value="2.0" step="0.1" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Hydraulic Loading (GPM/sf)</label>
<input type="number" id="daf_hlr" value="4.0" step="0.5" onchange="calcDAF()">
</div>
<div class="input-group">
<label>A/S Ratio (lb air/lb solids)</label>
<input type="number" id="daf_as" value="0.02" step="0.005" onchange="calcDAF()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Recycle Rate (%)</label>
<input type="number" id="daf_recycle" value="30" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Saturator Pressure (psi)</label>
<input type="number" id="daf_pressure" value="60" onchange="calcDAF()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üéØ Performance Targets</h4>
<div class="row">
<div class="input-group">
<label>TSS Removal (%)</label>
<input type="number" id="daf_tss_rem" value="90" onchange="calcDAF()">
</div>
<div class="input-group">
<label>FOG Removal (%)</label>
<input type="number" id="daf_fog_rem" value="95" onchange="calcDAF()">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#ef4444">üí∞ Operating Costs</h4>
<div class="row">
<div class="input-group">
<label>Electricity ($/kWh)</label>
<input type="number" id="daf_elec" value="0.10" step="0.01" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Polymer Dose (mg/L)</label>
<input type="number" id="daf_poly" value="5" onchange="calcDAF()">
</div>
<div class="input-group">
<label>Polymer Cost ($/lb)</label>
<input type="number" id="daf_poly_cost" value="2.50" step="0.10" onchange="calcDAF()">
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcDAF()">ü´ß Calculate DAF System</button>
<button class="btn gray" onclick="resetDAF()">üîÑ Reset</button>
</div>

<div id="daf_results" style="margin-top:20px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#f59e0b">üìö DAF Design Guidelines</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Parameter</th><th>Typical Range</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>A/S Ratio</td><td>0.01-0.05</td><td>lb air/lb solids removed</td></tr>
<tr><td>Recycle Rate</td><td>20-50%</td><td>Of influent flow</td></tr>
<tr><td>Saturator Pressure</td><td>40-80 psi</td><td>Higher = more air dissolved</td></tr>
<tr><td>Hydraulic Loading</td><td>2-6 GPM/sf</td><td>Based on total flow</td></tr>
<tr><td>Solids Loading</td><td>1-4 lb/sf/day</td><td>TSS basis</td></tr>
<tr><td>Float Solids</td><td>2-6%</td><td>Typical without thickening</td></tr>
</tbody>
</table>
</div>

</div>
</div>

</div>
</div>

<div class="panel" id="solids" data-panel-name="SOLIDS-HANDLING-PANEL">
<div id="SOLIDS_HEADER_MARKER" style="background:linear-gradient(135deg,#8b5cf6 0%,#a855f7 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üóëÔ∏è SOLIDS HANDLING</h2>
</div>

<div class="section">
<div class="section-h">üìä Sludge Production Estimator</div>
<div class="section-content">
<div class="note info">Estimate daily sludge production from primary and secondary treatment</div>
<div class="row">
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="sp_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Influent TSS (mg/L)</label><input type="number" id="sp_tss_in" value="220"></div>
<div class="input-group"><label>Primary TSS Removal (%)</label><input type="number" id="sp_prim_rem" value="60"></div>
<div class="input-group"><label>Influent BOD (mg/L)</label><input type="number" id="sp_bod_in" value="200"></div>
<div class="input-group"><label>Yield Coefficient (lb VSS/lb BOD)</label><input type="number" id="sp_yield" value="0.6" step="0.05"></div>
<div class="input-group"><label>VSS/TSS Ratio</label><input type="number" id="sp_vss_tss" value="0.75" step="0.05"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcSludgeProduction()">üóëÔ∏è Calculate Production</button>
<button class="btn gray" onclick="resetSludgeProduction()">Reset</button>
</div>
<div id="sp_results" style="margin-top:15px"></div>
</div>
</div>

<div class="section" id="wasCalculatorSection">
<div class="section-h">üöø WAS (Waste Activated Sludge) Calculator</div>
<div class="section-content">
<div class="note info">Calculate WAS rate based on target SRT</div>
<div class="row">
<div class="input-group"><label>Aeration Volume (MG)</label><input type="number" id="was_vol" value="1.5" step="0.1"></div>
<div class="input-group"><label>MLSS (mg/L)</label><input type="number" id="was_mlss" value="3000"></div>
<div class="input-group"><label>Target SRT (days)</label><input type="number" id="was_srt" value="10"></div>
<div class="input-group"><label>WAS Concentration (mg/L)</label><input type="number" id="was_conc" value="8000"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcWASRate()">üöø Calculate WAS</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td>Aeration Inventory</td><td><span class="result" id="r_was_inv">-</span></td><td>lb</td></tr>
<tr><td>WAS Rate (mass)</td><td><span class="result" id="r_was_mass">-</span></td><td>lb/day</td></tr>
<tr><td>WAS Rate (volume)</td><td><span class="result" id="r_was_gpd">-</span></td><td>gpd</td></tr>
<tr><td>WAS Rate</td><td><span class="result" id="r_was_gpm">-</span></td><td>gpm</td></tr>
</tbody></table>
</div>
</div>

<div class="section" id="advancedWasCalculator" style="border:2px solid #a855f7">
<div class="section-h" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:white">
üöø Advanced WAS Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Multiple Methods</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate WAS using different control strategies. Select your preferred method.</p>

<div style="display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn gradient" id="wasTab_srt" onclick="showWASMethod('srt')" style="flex:1;min-width:120px">üìÖ SRT Control</button>
<button class="btn gray" id="wasTab_mcrt" onclick="showWASMethod('mcrt')" style="flex:1;min-width:120px">‚è±Ô∏è MCRT Control</button>
<button class="btn gray" id="wasTab_fm" onclick="showWASMethod('fm')" style="flex:1;min-width:120px">‚öñÔ∏è F/M Control</button>
<button class="btn gray" id="wasTab_mlss" onclick="showWASMethod('mlss')" style="flex:1;min-width:120px">üìä MLSS Control</button>
</div>

<div id="wasMethod_srt" style="display:block">
<h4 style="margin:0 0 15px 0;color:#a855f7">üìÖ SRT (Solids Retention Time) Control</h4>
<div class="note info" style="margin-bottom:15px">Most common method. WAS rate = Total solids inventory √∑ Target SRT</div>
<div class="row">
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input type="number" id="was2_srt_vol" value="1.5" step="0.1">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="was2_srt_mlss" value="3000">
</div>
<div class="input-group">
<label>Target SRT (days)</label>
<input type="number" id="was2_srt_target" value="10">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Clarifier Volume (MG)</label>
<input type="number" id="was2_srt_clarvol" value="0.3" step="0.05">
</div>
<div class="input-group">
<label>Blanket Depth (ft)</label>
<input type="number" id="was2_srt_blanket" value="2" step="0.5">
</div>
<div class="input-group">
<label>RAS Concentration (mg/L)</label>
<input type="number" id="was2_srt_ras" value="8000">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Effluent TSS (mg/L)</label>
<input type="number" id="was2_srt_efftss" value="10">
</div>
<div class="input-group">
<label>Effluent Flow (MGD)</label>
<input type="number" id="was2_srt_effq" value="5.0" step="0.1">
</div>
<div class="input-group">
<label>WAS Concentration (mg/L)</label>
<input type="number" id="was2_srt_wasconc" value="8000">
</div>
</div>
</div>

<div id="wasMethod_mcrt" style="display:none">
<h4 style="margin:0 0 15px 0;color:#f59e0b">‚è±Ô∏è MCRT (Mean Cell Residence Time) Control</h4>
<div class="note warning" style="margin-bottom:15px">Accounts for solids in clarifier and effluent losses</div>
<div class="row">
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input type="number" id="was2_mcrt_vol" value="1.5" step="0.1">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="was2_mcrt_mlss" value="3000">
</div>
<div class="input-group">
<label>Target MCRT (days)</label>
<input type="number" id="was2_mcrt_target" value="12">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Effluent TSS (mg/L)</label>
<input type="number" id="was2_mcrt_efftss" value="10">
</div>
<div class="input-group">
<label>Effluent Flow (MGD)</label>
<input type="number" id="was2_mcrt_effq" value="5.0" step="0.1">
</div>
<div class="input-group">
<label>WAS Concentration (mg/L)</label>
<input type="number" id="was2_mcrt_wasconc" value="8000">
</div>
</div>
</div>

<div id="wasMethod_fm" style="display:none">
<h4 style="margin:0 0 15px 0;color:#10b981">‚öñÔ∏è F/M (Food to Microorganism) Control</h4>
<div class="note success" style="margin-bottom:15px">Control based on organic loading. Target F/M typically 0.2-0.5 for conventional activated sludge</div>
<div class="row">
<div class="input-group">
<label>Influent Flow (MGD)</label>
<input type="number" id="was2_fm_flow" value="5.0" step="0.1">
</div>
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="was2_fm_bod" value="200">
</div>
<div class="input-group">
<label>Target F/M (lb BOD/lb MLVSS/day)</label>
<input type="number" id="was2_fm_target" value="0.3" step="0.05">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Current MLSS (mg/L)</label>
<input type="number" id="was2_fm_mlss" value="3000">
</div>
<div class="input-group">
<label>VSS/TSS Ratio</label>
<input type="number" id="was2_fm_vss" value="0.80" step="0.05">
</div>
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input type="number" id="was2_fm_vol" value="1.5" step="0.1">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Yield (lb TSS/lb BOD)</label>
<input type="number" id="was2_fm_yield" value="0.6" step="0.05">
</div>
<div class="input-group">
<label>WAS Concentration (mg/L)</label>
<input type="number" id="was2_fm_wasconc" value="8000">
</div>
<div class="input-group">
<label>Decay Rate (1/day)</label>
<input type="number" id="was2_fm_kd" value="0.06" step="0.01">
</div>
</div>
</div>

<div id="wasMethod_mlss" style="display:none">
<h4 style="margin:0 0 15px 0;color:#3b82f6">üìä MLSS (Constant MLSS) Control</h4>
<div class="note info" style="margin-bottom:15px">Maintain target MLSS by wasting growth. Simple operational control.</div>
<div class="row">
<div class="input-group">
<label>Influent Flow (MGD)</label>
<input type="number" id="was2_mlss_flow" value="5.0" step="0.1">
</div>
<div class="input-group">
<label>Influent BOD (mg/L)</label>
<input type="number" id="was2_mlss_bod" value="200">
</div>
<div class="input-group">
<label>Yield (lb TSS/lb BOD)</label>
<input type="number" id="was2_mlss_yield" value="0.6" step="0.05">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Target MLSS (mg/L)</label>
<input type="number" id="was2_mlss_target" value="3000">
</div>
<div class="input-group">
<label>Current MLSS (mg/L)</label>
<input type="number" id="was2_mlss_current" value="3200">
</div>
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input type="number" id="was2_mlss_vol" value="1.5" step="0.1">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Days to Target</label>
<input type="number" id="was2_mlss_days" value="3">
</div>
<div class="input-group">
<label>WAS Concentration (mg/L)</label>
<input type="number" id="was2_mlss_wasconc" value="8000">
</div>
<div class="input-group">
<label>Decay Rate (1/day)</label>
<input type="number" id="was2_mlss_kd" value="0.06" step="0.01">
</div>
</div>
</div>

<div class="btns" style="margin-top:20px">
<button class="btn gradient" onclick="calcAdvancedWAS()">üöø Calculate WAS Rate</button>
<button class="btn blue" onclick="compareWASMethods()">üìä Compare All Methods</button>
<button class="btn gray" onclick="resetAdvancedWAS()">üîÑ Reset</button>
</div>

<div id="was2_results" style="margin-top:20px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#a855f7">üìö Typical WAS Control Parameters</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>Process Type</th><th>SRT (days)</th><th>F/M</th><th>MLSS (mg/L)</th></tr>
</thead>
<tbody>
<tr><td>Conventional AS</td><td>5-15</td><td>0.2-0.5</td><td>1,500-3,000</td></tr>
<tr><td>Extended Aeration</td><td>20-40</td><td>0.04-0.1</td><td>3,000-6,000</td></tr>
<tr><td>Contact Stabilization</td><td>5-10</td><td>0.2-0.6</td><td>1,000-3,000</td></tr>
<tr><td>SBR</td><td>10-30</td><td>0.04-0.1</td><td>2,000-5,000</td></tr>
<tr><td>MBR</td><td>10-25</td><td>0.1-0.4</td><td>8,000-12,000</td></tr>
<tr><td>Nitrification</td><td>10-20</td><td>0.1-0.3</td><td>2,000-4,000</td></tr>
</tbody>
</table>
</div>

</div>
</div>

<div class="section" id="rasCalculatorSection" style="border:2px solid #10b981">
<div class="section-h" style="background:linear-gradient(135deg,#059669,#10b981);color:white">
üîÑ RAS (Return Activated Sludge) Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Multiple Methods</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate optimal RAS rate to maintain target MLSS and prevent settling issues.</p>

<div style="display:flex;gap:5px;margin-bottom:20px;flex-wrap:wrap">
<button class="btn green" id="rasTab_ratio" onclick="showRASMethod('ratio')" style="flex:1;min-width:140px">üìä RAS Ratio</button>
<button class="btn gray" id="rasTab_mlss" onclick="showRASMethod('mlss')" style="flex:1;min-width:140px">üéØ Target MLSS</button>
<button class="btn gray" id="rasTab_blanket" onclick="showRASMethod('blanket')" style="flex:1;min-width:140px">üìè Blanket Control</button>
</div>

<div id="rasMethod_ratio" style="display:block">
<h4 style="margin:0 0 15px 0;color:#10b981">üìä RAS Ratio Method</h4>
<div class="note info" style="margin-bottom:15px">Calculate RAS based on desired RAS/Q ratio. Typical range: 25-100% of influent flow.</div>
<div class="row">
<div class="input-group">
<label style="color:#10b981">Influent Flow (MGD)</label>
<input type="number" id="ras_ratio_flow" value="5.0" step="0.1">
</div>
<div class="input-group">
<label style="color:#10b981">Target RAS Ratio (%)</label>
<input type="number" id="ras_ratio_pct" value="50" step="5">
</div>
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="ras_ratio_mlss" value="3000">
</div>
</div>
<div class="row">
<div class="input-group">
<label>RAS Concentration (mg/L)</label>
<input type="number" id="ras_ratio_conc" value="8000">
</div>
<div class="input-group">
<label>Number of RAS Pumps</label>
<input type="number" id="ras_ratio_pumps" value="2">
</div>
<div class="input-group">
<label>Pump Capacity (gpm each)</label>
<input type="number" id="ras_ratio_pumpcap" value="1500">
</div>
</div>
</div>

<div id="rasMethod_mlss" style="display:none">
<h4 style="margin:0 0 15px 0;color:#3b82f6">üéØ Target MLSS Method</h4>
<div class="note info" style="margin-bottom:15px">Calculate RAS rate needed to achieve target MLSS based on mass balance.</div>
<div class="row">
<div class="input-group">
<label style="color:#3b82f6">Influent Flow (MGD)</label>
<input type="number" id="ras_mlss_flow" value="5.0" step="0.1">
</div>
<div class="input-group">
<label style="color:#3b82f6">Target MLSS (mg/L)</label>
<input type="number" id="ras_mlss_target" value="3000">
</div>
<div class="input-group">
<label>Current MLSS (mg/L)</label>
<input type="number" id="ras_mlss_current" value="2800">
</div>
</div>
<div class="row">
<div class="input-group">
<label>RAS Concentration (mg/L)</label>
<input type="number" id="ras_mlss_conc" value="8000">
</div>
<div class="input-group">
<label>Influent TSS (mg/L)</label>
<input type="number" id="ras_mlss_inftss" value="200">
</div>
<div class="input-group">
<label>Aeration Volume (MG)</label>
<input type="number" id="ras_mlss_vol" value="1.5" step="0.1">
</div>
</div>
</div>

<div id="rasMethod_blanket" style="display:none">
<h4 style="margin:0 0 15px 0;color:#f59e0b">üìè Sludge Blanket Control Method</h4>
<div class="note warning" style="margin-bottom:15px">Adjust RAS to maintain target sludge blanket depth in clarifier.</div>
<div class="row">
<div class="input-group">
<label style="color:#f59e0b">Influent Flow (MGD)</label>
<input type="number" id="ras_blanket_flow" value="5.0" step="0.1">
</div>
<div class="input-group">
<label style="color:#f59e0b">Current Blanket (ft)</label>
<input type="number" id="ras_blanket_current" value="3.0" step="0.5">
</div>
<div class="input-group">
<label style="color:#f59e0b">Target Blanket (ft)</label>
<input type="number" id="ras_blanket_target" value="2.0" step="0.5">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Clarifier Side Water Depth (ft)</label>
<input type="number" id="ras_blanket_swd" value="12">
</div>
<div class="input-group">
<label>Current RAS Rate (MGD)</label>
<input type="number" id="ras_blanket_currentras" value="2.5" step="0.1">
</div>
<div class="input-group">
<label>SVI (mL/g)</label>
<input type="number" id="ras_blanket_svi" value="120">
</div>
</div>
<div class="row">
<div class="input-group">
<label>MLSS (mg/L)</label>
<input type="number" id="ras_blanket_mlss" value="3000">
</div>
<div class="input-group">
<label>Clarifier Surface Area (sf)</label>
<input type="number" id="ras_blanket_area" value="7850">
</div>
<div class="input-group">
<label>Adjustment Factor</label>
<input type="number" id="ras_blanket_adj" value="1.2" step="0.1">
</div>
</div>
</div>

<div class="btns" style="margin-top:20px">
<button class="btn green" onclick="calcRAS()">üîÑ Calculate RAS</button>
<button class="btn blue" onclick="calcRASSettling()">üìâ Check Settling</button>
<button class="btn gray" onclick="resetRASCalc()">üîÑ Reset</button>
</div>

<div id="ras_results" style="margin-top:20px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#10b981">üìö RAS Operating Guidelines</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>Parameter</th><th>Typical Range</th><th>Notes</th></tr>
</thead>
<tbody>
<tr><td>RAS Ratio (RAS/Q)</td><td>25-100%</td><td>Higher during high flows</td></tr>
<tr><td>RAS Concentration</td><td>6,000-12,000 mg/L</td><td>Should be 2-4x MLSS</td></tr>
<tr><td>Sludge Blanket</td><td>1-3 ft</td><td>Keep below weir level</td></tr>
<tr><td>RAS TSS/MLSS Ratio</td><td>2.0-4.0</td><td>Lower indicates poor settling</td></tr>
<tr><td>Clarifier SLR</td><td>20-35 lb/sf/day</td><td>Peak: 50 lb/sf/day max</td></tr>
</tbody>
</table>

<div style="margin-top:15px;padding:12px;background:#243b55;border-radius:8px">
<strong style="color:#fbbf24">‚ö†Ô∏è RAS Troubleshooting:</strong>
<ul style="margin:10px 0 0 20px;font-size:13px">
<li><strong>Rising blanket:</strong> Increase RAS rate or reduce WAS</li>
<li><strong>Low RAS concentration:</strong> Check for denitrification, reduce RAS rate</li>
<li><strong>RAS > 100%:</strong> Check for hydraulic issues, high SVI</li>
<li><strong>Thin blanket:</strong> May reduce RAS, but monitor effluent TSS</li>
</ul>
</div>
</div>

</div>
</div>

<div class="section" id="clarifierSlrCalculator" style="border:2px solid #3b82f6">
<div class="section-h" style="background:linear-gradient(135deg,#2563eb,#3b82f6);color:white">
üèä Clarifier Loading Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">SLR, SOR, WLR</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate solids loading rate (SLR), surface overflow rate (SOR), and weir loading rate (WLR) for secondary clarifiers.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">üèóÔ∏è Clarifier Configuration</h4>
<div class="row">
<div class="input-group">
<label style="color:#60a5fa">Number of Clarifiers</label>
<input type="number" id="clar_num" value="2" min="1" onchange="calcClarifier()">
</div>
<div class="input-group">
<label style="color:#60a5fa">Clarifier Diameter (ft)</label>
<input type="number" id="clar_dia" value="80" onchange="calcClarifier()">
</div>
<div class="input-group">
<label style="color:#60a5fa">Side Water Depth (ft)</label>
<input type="number" id="clar_swd" value="12" onchange="calcClarifier()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Center Well Diameter (ft)</label>
<input type="number" id="clar_cw" value="15" onchange="calcClarifier()">
</div>
<div class="input-group">
<label>Weir Length per Clarifier (ft)</label>
<input type="number" id="clar_weir" value="251" onchange="calcClarifier()">
<small style="opacity:0.7">Perimeter = œÄD</small>
</div>
<div class="input-group">
<label>Clarifiers Online</label>
<input type="number" id="clar_online" value="2" min="1" onchange="calcClarifier()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üíß Flow & Solids Data</h4>
<div class="row">
<div class="input-group">
<label style="color:#4ade80">Influent Flow (MGD)</label>
<input type="number" id="clar_flow" value="5.0" step="0.1" onchange="calcClarifier()">
</div>
<div class="input-group">
<label style="color:#4ade80">RAS Flow (MGD)</label>
<input type="number" id="clar_ras" value="2.5" step="0.1" onchange="calcClarifier()">
</div>
<div class="input-group">
<label style="color:#4ade80">MLSS (mg/L)</label>
<input type="number" id="clar_mlss" value="3000" onchange="calcClarifier()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Peak Flow Factor</label>
<input type="number" id="clar_pf" value="2.5" step="0.1" onchange="calcClarifier()">
</div>
<div class="input-group">
<label>SVI (mL/g)</label>
<input type="number" id="clar_svi" value="120" onchange="calcClarifier()">
</div>
<div class="input-group">
<label>RAS Concentration (mg/L)</label>
<input type="number" id="clar_rasconc" value="8000" onchange="calcClarifier()">
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcClarifier()">üèä Calculate Loading Rates</button>
<button class="btn orange" onclick="calcClarifierPeak()">‚ö° Calculate Peak Conditions</button>
<button class="btn blue" onclick="calcStatePoint()">üìà State Point Analysis</button>
<button class="btn gray" onclick="resetClarifier()">üîÑ Reset</button>
</div>

<div id="clar_results" style="margin-top:20px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#3b82f6">üìö Secondary Clarifier Design Criteria</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>Parameter</th><th>Average</th><th>Peak</th><th>Units</th></tr>
</thead>
<tbody>
<tr><td>Surface Overflow Rate (SOR)</td><td>400-800</td><td>1,000-1,200</td><td>gpd/sf</td></tr>
<tr><td>Solids Loading Rate (SLR)</td><td>20-30</td><td>50</td><td>lb/sf/day</td></tr>
<tr><td>Weir Loading Rate (WLR)</td><td>10,000-20,000</td><td>30,000</td><td>gpd/lf</td></tr>
<tr><td>Hydraulic Detention Time</td><td>1.5-2.5</td><td>-</td><td>hours</td></tr>
<tr><td>Side Water Depth</td><td>12-15</td><td>-</td><td>ft</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px;border-left:3px solid #4ade80">
<strong style="color:#4ade80">‚úì Good Settling</strong>
<div style="font-size:12px;opacity:0.8">SVI &lt; 120, SLR &lt; 25</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px;border-left:3px solid #fbbf24">
<strong style="color:#fbbf24">‚ö†Ô∏è Fair Settling</strong>
<div style="font-size:12px;opacity:0.8">SVI 120-180, SLR 25-35</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px;border-left:3px solid #ef4444">
<strong style="color:#ef4444">‚úó Poor Settling</strong>
<div style="font-size:12px;opacity:0.8">SVI &gt; 180, SLR &gt; 35</div>
</div>
</div>
</div>

</div>
</div>

<div class="section" id="sludgeJudgeCalculator" style="border:2px solid #f59e0b">
<div class="section-h" style="background:linear-gradient(135deg,#d97706,#f59e0b);color:white">
üß™ Sludge Judge / Settleometer
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">30-Min Settling Test</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Record settling test readings and calculate SVI, settling rate, and sludge characteristics.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">‚öôÔ∏è Test Setup</h4>
<div class="row">
<div class="input-group">
<label style="color:#fbbf24">Sample Location</label>
<select id="sj_location" style="font-size:14px">
<option value="mlss">MLSS (Aeration Basin)</option>
<option value="ras">RAS</option>
<option value="effluent">Secondary Effluent</option>
</select>
</div>
<div class="input-group">
<label style="color:#fbbf24">MLSS Concentration (mg/L)</label>
<input type="number" id="sj_mlss" value="3000" onchange="calcSettling()">
</div>
<div class="input-group">
<label style="color:#fbbf24">Cylinder Volume (mL)</label>
<select id="sj_cylinder" style="font-size:14px">
<option value="1000">1000 mL</option>
<option value="2000" selected>2000 mL</option>
</select>
</div>
</div>
<div class="row">
<div class="input-group">
<label>Test Date</label>
<input type="date" id="sj_date">
</div>
<div class="input-group">
<label>Test Time</label>
<input type="time" id="sj_time">
</div>
<div class="input-group">
<label>Stirred Test (SSVI)?</label>
<select id="sj_stirred" style="font-size:14px">
<option value="no">No - Standard SVI</option>
<option value="yes">Yes - SSVI (Stirred)</option>
</select>
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üìè Settling Readings (mL)</h4>
<div class="note info" style="margin-bottom:15px">Enter settled sludge volume at each time interval. Start with initial volume (usually 1000 or 2000 mL).</div>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:10px">
<div class="input-group" style="margin:0">
<label style="font-size:12px">0 min</label>
<input type="number" id="sj_0" value="1000" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">5 min</label>
<input type="number" id="sj_5" placeholder="--" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">10 min</label>
<input type="number" id="sj_10" placeholder="--" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">15 min</label>
<input type="number" id="sj_15" placeholder="--" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">20 min</label>
<input type="number" id="sj_20" placeholder="--" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">25 min</label>
<input type="number" id="sj_25" placeholder="--" style="text-align:center" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px;color:#fbbf24;font-weight:bold">30 min *</label>
<input type="number" id="sj_30" placeholder="--" style="text-align:center;border-color:#fbbf24" onchange="calcSettling()">
</div>
<div class="input-group" style="margin:0">
<label style="font-size:12px">60 min</label>
<input type="number" id="sj_60" placeholder="--" style="text-align:center;opacity:0.7" onchange="calcSettling()">
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcSettling()">üß™ Calculate SVI</button>
<button class="btn blue" onclick="showSettlingCurve()">üìà Show Settling Curve</button>
<button class="btn green" onclick="saveSettlingTest()">üíæ Save Test</button>
<button class="btn gray" onclick="resetSettling()">üîÑ Reset</button>
</div>

<div id="sj_results" style="margin-top:20px"></div>

<div id="sj_chart_container" style="display:none;margin-top:20px;background:#1e3a5f;padding:15px;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#60a5fa">üìà Settling Curve</h4>
<canvas id="settlingChart" height="200"></canvas>
</div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#f59e0b">üìö SVI Interpretation Guide</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>SVI (mL/g)</th><th>Settling Quality</th><th>Sludge Condition</th><th>Action</th></tr>
</thead>
<tbody>
<tr style="background:rgba(74,222,128,0.1)"><td>&lt; 80</td><td style="color:#4ade80">Excellent</td><td>Old sludge, pin floc possible</td><td>May reduce WAS, check effluent TSS</td></tr>
<tr style="background:rgba(74,222,128,0.1)"><td>80-120</td><td style="color:#4ade80">Good</td><td>Normal, healthy sludge</td><td>Maintain current operations</td></tr>
<tr style="background:rgba(251,191,36,0.1)"><td>120-150</td><td style="color:#fbbf24">Fair</td><td>Light bulking beginning</td><td>Monitor closely, check DO/nutrients</td></tr>
<tr style="background:rgba(251,191,36,0.1)"><td>150-200</td><td style="color:#fbbf24">Poor</td><td>Bulking sludge</td><td>Identify filaments, adjust process</td></tr>
<tr style="background:rgba(239,68,68,0.1)"><td>&gt; 200</td><td style="color:#ef4444">Very Poor</td><td>Severe bulking</td><td>Immediate action required</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#60a5fa">SVI Formula:</strong>
<div style="font-size:12px;margin-top:5px">SVI = (Settled Vol mL √ó 1000) / (Cylinder mL √ó MLSS mg/L)</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#60a5fa">Typical Targets:</strong>
<div style="font-size:12px;margin-top:5px">Conventional: 80-150<br>Extended Air: 100-200<br>MBR: N/A (no settling)</div>
</div>
</div>
</div>

</div>
</div>

<div class="section" id="thickenerCalcSection">
<div class="section-h">üîÑ Gravity Thickener Loading</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Sludge Flow (gpd)</label><input type="number" id="gt_flow" value="50000"></div>
<div class="input-group"><label>Feed TSS (%)</label><input type="number" id="gt_feed_tss" value="1.0" step="0.1"></div>
<div class="input-group"><label>Thickener Diameter (ft)</label><input type="number" id="gt_dia" value="30"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcThickenerLoading()">üîÑ Calculate Loading</button>
</div>
<table class="table" style="margin-top:15px"><tbody>
<tr><td>Surface Area</td><td><span class="result" id="r_gt_area">-</span></td><td>sf</td></tr>
<tr><td>Hydraulic Loading</td><td><span class="result" id="r_gt_hyd">-</span></td><td>gpd/sf</td></tr>
<tr><td>Solids Loading</td><td><span class="result" id="r_gt_sol">-</span></td><td>lb/sf/day</td></tr>
<tr><td>Status</td><td colspan="2"><span class="status" id="r_gt_status">-</span></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üóúÔ∏è Dewatering Performance</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Feed Rate (gpm)</label><input type="number" id="dw_feed" value="50"></div>
<div class="input-group"><label>Feed Solids (%)</label><input type="number" id="dw_feed_pct" value="3.0" step="0.1"></div>
<div class="input-group"><label>Cake Solids (%)</label><input type="number" id="dw_cake_pct" value="20" step="0.5"></div>
<div class="input-group"><label>Polymer Dose (lb/DT)</label><input type="number" id="dw_poly" value="12"></div>
<div class="input-group"><label>Polymer Cost ($/lb)</label><input type="number" id="dw_poly_cost" value="2.50" step="0.10"></div>
</div>
<div class="btns">
<button class="btn gradient" onclick="calcDewatering()">üóúÔ∏è Calculate Performance</button>
</div>
<div id="dw_results" style="margin-top:15px"></div>
</div>
</div>

<div class="section">
<div class="section-h">‚öñÔ∏è Plant Mass Balance</div>
<div class="section-content">
<div class="note info">For comprehensive mass balance calculations including BOD, TSS, TKN, and TP through the entire treatment train, see the Mass Balance Calculator in the <strong>üìê Hydraulics</strong> tab.</div>
<button class="btn blue" onclick="switchPanel('hydraulics')">Go to Hydraulics Tab ‚Üí</button>
</div>
</div>

<div class="section" id="biogasCalculator" style="border:2px solid #f97316">
<div class="section-h" style="background:linear-gradient(135deg,#ea580c,#f97316);color:white">
üî• Biogas & Digester Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Comprehensive</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Complete anaerobic digester analysis: loading, gas production, heating, and energy recovery.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#f97316">üèóÔ∏è Digester Configuration</h4>
<div class="row">
<div class="input-group">
<label style="color:#f97316">Number of Digesters</label>
<input type="number" id="bg_num_dig" value="2" min="1" onchange="calcBiogas()">
</div>
<div class="input-group">
<label style="color:#f97316">Digester Diameter (ft)</label>
<input type="number" id="bg_dia" value="60" onchange="calcBiogas()">
</div>
<div class="input-group">
<label style="color:#f97316">Sidewater Depth (ft)</label>
<input type="number" id="bg_swd" value="25" onchange="calcBiogas()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Digester Type</label>
<select id="bg_type" style="font-size:14px" onchange="calcBiogas()">
<option value="standard">Standard Rate (Unmixed)</option>
<option value="high" selected>High Rate (Mixed)</option>
<option value="two_stage">Two-Stage</option>
<option value="egg">Egg-Shaped</option>
</select>
</div>
<div class="input-group">
<label>Operating Temperature (¬∞F)</label>
<input type="number" id="bg_temp" value="95" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>Digesters Online</label>
<input type="number" id="bg_online" value="2" min="1" onchange="calcBiogas()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üì• Sludge Feed</h4>
<div class="row">
<div class="input-group">
<label>Primary Sludge (gpd)</label>
<input type="number" id="bg_ps_flow" value="30000" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>PS Solids (%)</label>
<input type="number" id="bg_ps_pct" value="5.0" step="0.1" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>PS VS/TS Ratio</label>
<input type="number" id="bg_ps_vs" value="0.75" step="0.01" onchange="calcBiogas()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>WAS/Thickened Sludge (gpd)</label>
<input type="number" id="bg_was_flow" value="20000" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>WAS Solids (%)</label>
<input type="number" id="bg_was_pct" value="4.0" step="0.1" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>WAS VS/TS Ratio</label>
<input type="number" id="bg_was_vs" value="0.70" step="0.01" onchange="calcBiogas()">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">‚ö° Performance Parameters</h4>
<div class="row">
<div class="input-group">
<label>VS Destruction (%)</label>
<input type="number" id="bg_vs_dest" value="55" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>Gas Production (cf/lb VS destroyed)</label>
<input type="number" id="bg_gas_rate" value="15" step="0.5" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>Methane Content (%)</label>
<input type="number" id="bg_ch4" value="65" onchange="calcBiogas()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üí∞ Energy & Economics</h4>
<div class="row">
<div class="input-group">
<label>CHP Efficiency (%)</label>
<input type="number" id="bg_chp_eff" value="30" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>Electricity Cost ($/kWh)</label>
<input type="number" id="bg_elec_cost" value="0.10" step="0.01" onchange="calcBiogas()">
</div>
<div class="input-group">
<label>Natural Gas Cost ($/therm)</label>
<input type="number" id="bg_ng_cost" value="1.00" step="0.10" onchange="calcBiogas()">
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcBiogas()">üî• Calculate All</button>
<button class="btn blue" onclick="calcDigesterHeating()">üå°Ô∏è Heating Requirements</button>
<button class="btn gray" onclick="resetBiogas()">üîÑ Reset</button>
</div>

<div id="bg_results" style="margin-top:20px"></div>

<div id="bg_heating_results" style="margin-top:15px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#f97316">üìö Digester Design Guidelines</h4>
<table class="table" style="font-size:13px">
<thead>
<tr><th>Parameter</th><th>Standard Rate</th><th>High Rate</th><th>Two-Stage</th></tr>
</thead>
<tbody>
<tr><td>SRT (days)</td><td>30-60</td><td>10-20</td><td>10-15 (1st)</td></tr>
<tr><td>VS Loading (lb/cf/d)</td><td>0.03-0.10</td><td>0.15-0.40</td><td>0.25-0.50</td></tr>
<tr><td>VS Destruction (%)</td><td>35-50</td><td>50-65</td><td>55-65</td></tr>
<tr><td>Temperature (¬∞F)</td><td>Ambient</td><td>95 (meso)</td><td>95-131</td></tr>
<tr><td>Mixing</td><td>None</td><td>Continuous</td><td>Both stages</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#4ade80">Gas Composition:</strong>
<div style="font-size:12px;margin-top:5px">
CH‚ÇÑ: 60-70%<br>
CO‚ÇÇ: 30-40%<br>
H‚ÇÇS: 0.1-0.5%<br>
Trace: N‚ÇÇ, H‚ÇÇ, etc.
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#4ade80">Energy Content:</strong>
<div style="font-size:12px;margin-top:5px">
Biogas: ~600 BTU/cf<br>
Methane: ~1,000 BTU/cf<br>
1 cf CH‚ÇÑ = 0.01 therm<br>
1 kWh = 3,412 BTU
</div>
</div>
</div>
</div>

</div>
</div>

<div class="section" id="septageCalculator" style="border:2px solid #84cc16">
<div class="section-h" style="background:linear-gradient(135deg,#65a30d,#84cc16);color:white">
üöõ Septage Receiving Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Hauled Waste</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate septage receiving capacity, loading impacts, and revenue potential.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#84cc16">üè≠ Plant Baseline</h4>
<div class="row">
<div class="input-group">
<label style="color:#84cc16">Design Flow (MGD)</label>
<input type="number" id="sep_design" value="5.0" step="0.1" onchange="calcSeptage()">
</div>
<div class="input-group">
<label style="color:#84cc16">Current Avg Flow (MGD)</label>
<input type="number" id="sep_flow" value="4.0" step="0.1" onchange="calcSeptage()">
</div>
<div class="input-group">
<label style="color:#84cc16">Available Capacity (%)</label>
<input type="number" id="sep_avail" value="20" onchange="calcSeptage()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Current BOD Load (lb/day)</label>
<input type="number" id="sep_bod_load" value="6000" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>BOD Capacity (lb/day)</label>
<input type="number" id="sep_bod_cap" value="8000" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Current TSS Load (lb/day)</label>
<input type="number" id="sep_tss_load" value="5500" onchange="calcSeptage()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üöõ Septage Characteristics</h4>
<div class="row">
<div class="input-group">
<label>Septage Type</label>
<select id="sep_type" style="font-size:14px" onchange="updateSeptageDefaults()">
<option value="residential" selected>Residential Septage</option>
<option value="commercial">Commercial Septage</option>
<option value="grease">Grease Trap Waste</option>
<option value="portable">Portable Toilet Waste</option>
<option value="mixed">Mixed Hauled Waste</option>
</select>
</div>
<div class="input-group">
<label>BOD (mg/L)</label>
<input type="number" id="sep_bod" value="6000" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>TSS (mg/L)</label>
<input type="number" id="sep_tss" value="15000" onchange="calcSeptage()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>TKN (mg/L)</label>
<input type="number" id="sep_tkn" value="700" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>NH3-N (mg/L)</label>
<input type="number" id="sep_nh3" value="400" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>FOG (mg/L)</label>
<input type="number" id="sep_fog" value="8000" onchange="calcSeptage()">
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#60a5fa">üì• Receiving Operations</h4>
<div class="row">
<div class="input-group">
<label>Truck Size (gallons)</label>
<input type="number" id="sep_truck" value="3000" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Trucks per Day</label>
<input type="number" id="sep_trucks" value="10" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Operating Hours/Day</label>
<input type="number" id="sep_hours" value="8" onchange="calcSeptage()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Receiving Rate (GPM)</label>
<input type="number" id="sep_rate" value="200" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Max Daily Volume (gal)</label>
<input type="number" id="sep_max_vol" value="50000" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Discharge Point</label>
<select id="sep_discharge" style="font-size:14px">
<option value="headworks">Headworks</option>
<option value="primary">Primary Clarifier</option>
<option value="eq">Equalization Basin</option>
<option value="digester">Digester (solids only)</option>
</select>
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üí∞ Economics</h4>
<div class="row">
<div class="input-group">
<label>Tipping Fee ($/gallon)</label>
<input type="number" id="sep_fee" value="0.08" step="0.01" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Alternative: $/1000 gal</label>
<input type="number" id="sep_fee_k" value="80" onchange="calcSeptage()">
</div>
<div class="input-group">
<label>Treatment Cost ($/gal)</label>
<input type="number" id="sep_cost" value="0.02" step="0.01" onchange="calcSeptage()">
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcSeptage()">üöõ Calculate Septage Impact</button>
<button class="btn blue" onclick="calcSeptageCapacity()">üìä Capacity Analysis</button>
<button class="btn gray" onclick="resetSeptage()">üîÑ Reset</button>
</div>

<div id="sep_results" style="margin-top:20px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#84cc16">üìö Typical Septage Characteristics</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Parameter</th><th>Residential</th><th>Commercial</th><th>Grease Trap</th><th>Portable</th></tr>
</thead>
<tbody>
<tr><td>BOD (mg/L)</td><td>2,000-10,000</td><td>1,500-5,000</td><td>15,000-150,000</td><td>5,000-15,000</td></tr>
<tr><td>TSS (mg/L)</td><td>5,000-30,000</td><td>3,000-15,000</td><td>5,000-50,000</td><td>10,000-40,000</td></tr>
<tr><td>TKN (mg/L)</td><td>200-1,000</td><td>150-500</td><td>50-200</td><td>500-2,000</td></tr>
<tr><td>FOG (mg/L)</td><td>5,000-15,000</td><td>3,000-10,000</td><td>50,000-150,000</td><td>2,000-8,000</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#ef4444">‚ö†Ô∏è Considerations:</strong>
<div style="font-size:11px;margin-top:5px">
- Slug loading impacts<br>
- FOG handling capacity<br>
- Grit removal needs<br>
- Odor control<br>
- Screenings increase
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#4ade80">‚úÖ Best Practices:</strong>
<div style="font-size:11px;margin-top:5px">
- Meter all loads<br>
- Sample periodically<br>
- Controlled discharge rate<br>
- Spread throughout day<br>
- Maintain manifest records
</div>
</div>
</div>
</div>

</div>
</div>

<div class="section" id="sludgeBoxCalculator" style="border:2px solid #78716c">
<div class="section-h" style="background:linear-gradient(135deg,#57534e,#78716c);color:white">
üì¶ Sludge Box (Dry) Haul Calculator
<span style="font-size:12px;background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:10px;margin-left:10px">Roll-off/Dumpster</span>
</div>
<div class="section-content">
<p style="margin:0 0 15px 0;opacity:0.8;font-size:14px">Calculate sludge box capacity, hauling frequency, and costs for dewatered cake disposal.</p>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#78716c">üóúÔ∏è Cake Production</h4>
<div class="row">
<div class="input-group">
<label style="color:#a8a29e">Daily Cake Production</label>
<input type="number" id="sb_cake_day" value="5" step="0.5" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Unit</label>
<select id="sb_cake_unit" style="font-size:14px" onchange="calcSludgeBox()">
<option value="wetton" selected>Wet Tons/Day</option>
<option value="dryton">Dry Tons/Day</option>
<option value="cy">Cubic Yards/Day</option>
<option value="lb">Pounds/Day</option>
</select>
</div>
<div class="input-group">
<label style="color:#a8a29e">Cake Solids (%)</label>
<input type="number" id="sb_cake_pct" value="22" step="1" onchange="calcSludgeBox()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Cake Density (lb/cy)</label>
<input type="number" id="sb_density" value="1200" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Operating Days/Week</label>
<input type="number" id="sb_op_days" value="5" min="1" max="7" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Storage Days Available</label>
<input type="number" id="sb_storage_days" value="3" onchange="calcSludgeBox()">
</div>
</div>
</div>

<div style="background:#243b55;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#fbbf24">üì¶ Box Configuration</h4>
<div class="row">
<div class="input-group">
<label>Box Type</label>
<select id="sb_box_type" style="font-size:14px" onchange="updateBoxDefaults()">
<option value="20cy">20 CY Roll-off</option>
<option value="30cy" selected>30 CY Roll-off</option>
<option value="40cy">40 CY Roll-off</option>
<option value="lugger">Lugger Box (10-15 CY)</option>
<option value="custom">Custom Size</option>
</select>
</div>
<div class="input-group">
<label>Box Capacity (cubic yards)</label>
<input type="number" id="sb_box_cy" value="30" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Fill Percentage (%)</label>
<input type="number" id="sb_fill_pct" value="85" onchange="calcSludgeBox()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Number of Boxes On-Site</label>
<input type="number" id="sb_num_boxes" value="2" min="1" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Max Weight Limit (tons)</label>
<input type="number" id="sb_weight_limit" value="20" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Limiting Factor</label>
<select id="sb_limit" style="font-size:14px">
<option value="auto" selected>Auto-detect</option>
<option value="volume">Volume</option>
<option value="weight">Weight</option>
</select>
</div>
</div>
</div>

<div style="background:#1e3a5f;padding:15px;border-radius:10px;margin-bottom:20px">
<h4 style="margin:0 0 15px 0;color:#4ade80">üí∞ Hauling & Disposal Costs</h4>
<div class="row">
<div class="input-group">
<label>Haul Cost ($/pull)</label>
<input type="number" id="sb_haul_cost" value="350" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Disposal Fee ($/ton)</label>
<input type="number" id="sb_disp_ton" value="45" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Box Rental ($/box/month)</label>
<input type="number" id="sb_rental" value="150" onchange="calcSludgeBox()">
</div>
</div>
<div class="row">
<div class="input-group">
<label>Fuel Surcharge (%)</label>
<input type="number" id="sb_fuel" value="10" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Environmental Fee ($/haul)</label>
<input type="number" id="sb_env_fee" value="15" onchange="calcSludgeBox()">
</div>
<div class="input-group">
<label>Destination</label>
<select id="sb_dest" style="font-size:14px">
<option value="landfill" selected>Landfill</option>
<option value="compost">Composting Facility</option>
<option value="incinerator">Incinerator</option>
<option value="landapp">Land Application</option>
</select>
</div>
</div>
</div>

<div class="btns">
<button class="btn gradient" onclick="calcSludgeBox()">üì¶ Calculate Hauling</button>
<button class="btn blue" onclick="calcBoxSchedule()">üìÖ Weekly Schedule</button>
<button class="btn orange" onclick="optimizeBoxSize()">üìä Optimize Box Size</button>
<button class="btn gray" onclick="resetSludgeBox()">üîÑ Reset</button>
</div>

<div id="sb_results" style="margin-top:20px"></div>

<div id="sb_schedule" style="margin-top:15px"></div>

<div style="margin-top:20px;padding:15px;background:#1e3a5f;border-radius:10px">
<h4 style="margin:0 0 10px 0;color:#78716c">üìö Sludge Box Reference</h4>
<table class="table" style="font-size:12px">
<thead>
<tr><th>Box Size</th><th>Capacity (CY)</th><th>Typical Weight Limit</th><th>Best For</th></tr>
</thead>
<tbody>
<tr><td>Lugger Box</td><td>10-15</td><td>8-12 tons</td><td>Small plants, limited space</td></tr>
<tr><td>20 CY Roll-off</td><td>20</td><td>15-18 tons</td><td>Small-medium plants</td></tr>
<tr style="background:rgba(74,222,128,0.1)"><td>30 CY Roll-off</td><td>30</td><td>20-22 tons</td><td>Most common size</td></tr>
<tr><td>40 CY Roll-off</td><td>40</td><td>20-25 tons</td><td>Large plants, light cake</td></tr>
</tbody>
</table>

<div style="margin-top:15px;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px">
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">Typical Cake Densities:</strong>
<div style="font-size:11px;margin-top:5px">
Belt Press (20%): 1,000-1,200 lb/cy<br>
Centrifuge (25%): 1,200-1,400 lb/cy<br>
Plate Press (35%): 1,400-1,600 lb/cy<br>
Dried (90%+): 800-1,000 lb/cy
</div>
</div>
<div style="background:#243b55;padding:10px;border-radius:8px">
<strong style="color:#fbbf24">Cost Factors:</strong>
<div style="font-size:11px;margin-top:5px">
- Haul distance<br>
- Fuel prices<br>
- Disposal facility type<br>
- Weekend/holiday rates<br>
- Contamination charges
</div>
</div>
</div>
</div>

</div>
</div>

</div>

<div class="panel" id="wizards">
<div id="WIZARDS_HEADER_MARKER" style="background:linear-gradient(135deg,#7c3aed 0%,#a855f7 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üß≠ WIZARDS & DIAGNOSTICS</h2>
</div>

<div class="section">
<div class="section-h" style="background:linear-gradient(135deg,#0077b6,#0096c7);color:white">üìä System Health Score</div>
<div class="section-content">
<div style="display:flex;align-items:center;gap:30px;flex-wrap:wrap">
<div class="gauge good" id="healthGauge" style="margin:0">
<div><div style="font-size:0.4em">Health</div>95<div style="font-size:0.3em">/100</div></div>
</div>
<div style="flex:1;min-width:250px">
<div style="margin-bottom:10px"><span style="color:#4ade80">‚óè</span> Process Control: <strong>Excellent</strong></div>
<div style="margin-bottom:10px"><span style="color:#4ade80">‚óè</span> Effluent Quality: <strong>Good</strong></div>
<div style="margin-bottom:10px"><span style="color:#fbbf24">‚óè</span> Equipment Status: <strong>Monitor</strong></div>
<div><span style="color:#4ade80">‚óè</span> Compliance: <strong>In Limits</strong></div>
</div>
</div>
<div class="btns" style="margin-top:15px">
<button class="btn gradient" onclick="runDiagnostics()">üîç Run Full Diagnostics</button>
</div>
<div id="diagOut" style="margin-top:15px"></div>
</div>
</div>

<div class="section">
<div class="section-h">üß≠ Select a Troubleshooting Wizard</div>
<div class="section-content">
<p style="margin:0 0 20px 0;opacity:0.8;font-size:15px">Choose a problem to diagnose. Each wizard will guide you through step-by-step questions to identify the root cause and recommend solutions.</p>

<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">

<div onclick="startWizard('tss')" style="background:linear-gradient(135deg,#dc2626,#ef4444);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#fca5a5'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üî¥</div>
<h3 style="margin:0 0 8px 0;font-size:20px">High Effluent TSS</h3>
<p style="margin:0;opacity:0.9;font-size:14px">TSS exceeding permit limits? Diagnose clarifier, biological, and hydraulic causes.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">8 Decision Points ‚Üí</div>
</div>

<div onclick="startWizard('bulking')" style="background:linear-gradient(135deg,#d97706,#f59e0b);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#fcd34d'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üü†</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Filamentous Bulking</h3>
<p style="margin:0;opacity:0.9;font-size:14px">SVI > 150? Poor settling? Identify filament type and targeted solutions.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">10 Decision Points ‚Üí</div>
</div>

<div onclick="startWizard('ammonia')" style="background:linear-gradient(135deg,#2563eb,#3b82f6);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#93c5fd'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üîµ</div>
<h3 style="margin:0 0 8px 0;font-size:20px">High Effluent Ammonia</h3>
<p style="margin:0;opacity:0.9;font-size:14px">NH‚ÇÉ-N above limits? Check nitrification, DO, alkalinity, and toxicity.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">9 Decision Points ‚Üí</div>
</div>

<div onclick="startWizard('lowdo')" style="background:linear-gradient(135deg,#059669,#10b981);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#6ee7b7'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üü¢</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Low DO Problems</h3>
<p style="margin:0;opacity:0.9;font-size:14px">Can't maintain DO setpoint? Diagnose aeration, loading, and equipment issues.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">8 Decision Points ‚Üí</div>
</div>

<div onclick="startWizard('foam')" style="background:linear-gradient(135deg,#92400e,#b45309);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#fbbf24'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üü§</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Foam/Scum Issues</h3>
<p style="margin:0;opacity:0.9;font-size:14px">Excessive foam on basins or clarifiers? Identify foam type and control strategies.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">6 Decision Points ‚Üí</div>
</div>

<div onclick="startWizard('odor')" style="background:linear-gradient(135deg,#7c2d12,#9a3412);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#fb923c'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üëÉ</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Odor Control</h3>
<p style="margin:0;opacity:0.9;font-size:14px">H‚ÇÇS or septic odors? Locate sources and implement control measures.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">7 Decision Points ‚Üí</div>
</div>

<div onclick="startWizard('nutrient')" style="background:linear-gradient(135deg,#7e22ce,#9333ea);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#c084fc'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üü£</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Nutrient Removal</h3>
<p style="margin:0;opacity:0.9;font-size:14px">High phosphorus or nitrogen? Optimize Bio-P, chemical, and denitrification.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">10 Decision Points ‚Üí</div>
</div>

<div onclick="startWizard('blower')" style="background:linear-gradient(135deg,#0369a1,#0284c7);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#38bdf8'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">‚ö°</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Blower/Aeration</h3>
<p style="margin:0;opacity:0.9;font-size:14px">Equipment issues, high amps, surge? Diagnose blower and air distribution problems.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">9 Decision Points ‚Üí</div>
</div>

<div onclick="startWizard('clarifier')" style="background:linear-gradient(135deg,#475569,#64748b);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#94a3b8'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üîß</div>
<h3 style="margin:0 0 8px 0;font-size:20px">Clarifier Mechanical</h3>
<p style="margin:0;opacity:0.9;font-size:14px">High torque, scum issues, weir problems? Troubleshoot clarifier equipment.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">8 Decision Points ‚Üí</div>
</div>

<div onclick="startWizard('raswas')" style="background:linear-gradient(135deg,#0891b2,#06b6d4);padding:24px;border-radius:16px;cursor:pointer;transition:all 0.3s;border:3px solid transparent;color:white" onmouseover="this.style.transform='translateY(-4px)';this.style.borderColor='#22d3ee'" onmouseout="this.style.transform='';this.style.borderColor='transparent'">
<div style="font-size:48px;margin-bottom:12px">üíß</div>
<h3 style="margin:0 0 8px 0;font-size:20px">RAS/WAS Optimization</h3>
<p style="margin:0;opacity:0.9;font-size:14px">Sludge return issues? Optimize RAS rate, WAS control, and maintain MLSS.</p>
<div style="margin-top:12px;padding:8px 16px;background:rgba(255,255,255,0.2);border-radius:20px;display:inline-block;font-size:13px;font-weight:bold">8 Decision Points ‚Üí</div>
</div>

</div>
</div>
</div>

<div id="wizardActiveArea" style="display:none">
<div class="section">
<div class="section-h" id="wizardTitle">üß≠ Wizard Active</div>
<div class="section-content">

<div style="margin-bottom:20px">
<div style="display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px">
<span id="wizardProgress">Step 1 of 8</span>
<span id="wizardPercent">12%</span>
</div>
<div style="background:rgba(124,58,237,0.2);height:12px;border-radius:6px;overflow:hidden">
<div id="wizardProgressBar" style="background:linear-gradient(90deg,#7c3aed,#a855f7);height:100%;width:12%;transition:width 0.3s;border-radius:6px"></div>
</div>
</div>

<div id="wizardQuestion" style="background:linear-gradient(135deg,#1e1b4b,#312e81);padding:30px;border-radius:16px;margin-bottom:20px;border:2px solid #7c3aed">
<h3 id="wizardQuestionText" style="margin:0 0 20px 0;font-size:22px;color:white;line-height:1.4">Question will appear here...</h3>
<div id="wizardAnswers" style="display:flex;flex-direction:column;gap:12px">

</div>
</div>

<div id="wizardPath" style="background:rgba(124,58,237,0.1);padding:16px;border-radius:12px;margin-bottom:20px">
<div style="font-size:13px;font-weight:bold;margin-bottom:8px;color:#a855f7">üìç Diagnosis Path:</div>
<div id="wizardBreadcrumb" style="font-size:14px;line-height:1.8;color:var(--text-primary)">Start ‚Üí ...</div>
</div>

<div style="display:flex;gap:12px;flex-wrap:wrap">
<button onclick="wizardBack()" id="wizardBackBtn" class="btn" style="background:#6b7280;color:white" disabled>‚Üê Back</button>
<button onclick="wizardRestart()" class="btn" style="background:#dc2626;color:white">üîÑ Restart</button>
<button onclick="exitWizard()" class="btn" style="background:#374151;color:white">‚úñ Exit Wizard</button>
</div>

</div>
</div>
</div>

<div id="wizardResults" style="display:none">
<div class="section">
<div class="section-h">‚úÖ Diagnosis Complete</div>
<div class="section-content">

<div id="wizardResultContent" style="background:linear-gradient(135deg,#059669,#10b981);padding:30px;border-radius:16px;color:white;margin-bottom:20px">

</div>

<div style="display:flex;gap:12px;flex-wrap:wrap">
<button onclick="generateWizardReport()" class="btn" style="background:#2563eb;color:white">üìÑ Generate Report</button>
<button onclick="wizardRestart()" class="btn" style="background:#7c3aed;color:white">üîÑ Run Again</button>
<button onclick="exitWizard()" class="btn" style="background:#374151;color:white">‚Üê Back to Wizards</button>
</div>

</div>
</div>
</div>

<div class="section">
<div class="section-h">üìú Recent Diagnoses</div>
<div class="section-content">
<div id="wizardHistory" style="font-size:14px;opacity:0.8">
<p>No diagnoses completed yet. Run a wizard to see your history here.</p>
</div>
</div>
</div>

</div>

<div class="panel" id="multiplant">
<div id="MULTIPLANT_HEADER_MARKER" style="background:linear-gradient(135deg,#059669 0%,#34d399 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üè≠ MULTI-PLANT</h2>
</div>
<div class="section">
<div class="section-h">üè≠ Multi-Plant Fleet Management</div>
<div class="section-content">

<div style="background:linear-gradient(135deg,#023e8a 0%,#0077b6 100%);padding:12px 16px;border-radius:10px;margin-bottom:12px;color:white">
<h2 style="margin:0 0 8px 0;font-size:20px">üè≠ Fleet Operations Dashboard</h2>
<p style="margin:0;opacity:0.9">Centralized monitoring and management for multiple treatment facilities</p>
</div>

<div class="btns" style="margin-bottom:20px;flex-wrap:wrap">
<button class="btn green" onclick="addNewPlant()">‚ûï Add Plant</button>
<button class="btn blue" onclick="editSelectedPlant()">‚úèÔ∏è Edit</button>
<button class="btn red" onclick="deleteSelectedPlant()">üóëÔ∏è Delete</button>
<button class="btn orange" onclick="exportPlantData()">üì§ Export CSV</button>
<button class="btn purple" onclick="importPlantData()">üì• Import</button>
<button class="btn teal" onclick="showFleetAnalytics()">üìä Analytics</button>
<button class="btn gray" onclick="comparePlants()">‚öñÔ∏è Compare</button>
</div>

<div class="kpi-grid" style="margin-bottom:24px">
<div class="kpi-card">
<h4>Total Plants</h4>
<p id="fleet-plants">4</p>
</div>
<div class="kpi-card">
<h4>Total Capacity</h4>
<p id="fleet-capacity">18.5 MGD</p>
</div>
<div class="kpi-card">
<h4>Online</h4>
<p id="fleet-online" style="color:#06d6a0">3</p>
</div>
<div class="kpi-card">
<h4>Avg Efficiency</h4>
<p id="fleet-eff">93.1%</p>
</div>
<div class="kpi-card">
<h4>Total Flow</h4>
<p id="fleet-flow">15.1 MGD</p>
</div>
<div class="kpi-card">
<h4>Avg Load</h4>
<p id="fleet-load">82%</p>
</div>
</div>

<div class="section" style="margin-bottom:24px">
<div class="section-h">üìä Fleet Performance Comparison</div>
<div class="section-content">
<canvas id="fleetComparisonChart" style="max-height:300px"></canvas>
</div>
</div>

<div id="plant-cards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px">

<div class="plant-card" data-plant-id="1" onclick="selectPlant(1)" style="background:var(--bg-section);padding:20px;border-radius:12px;border-left:4px solid var(--ok);cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<strong>North Regional WWTP</strong>
<span class="status ok">ONLINE</span>
</div>
<div style="color:var(--text-unit);font-size:14px;margin-bottom:12px">üìç Houston, TX</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
<div>Capacity: <strong>5.0 MGD</strong></div>
<div>Flow: <strong>4.2 MGD</strong></div>
<div>Efficiency: <strong style="color:#06d6a0">94.5%</strong></div>
<div>Load: <strong>84%</strong></div>
</div>
<div style="margin-top:12px;display:flex;gap:8px">
<button class="btn small blue" onclick="event.stopPropagation();viewPlantDetails(1)">View</button>
<button class="btn small orange" onclick="event.stopPropagation();editPlant(1)">Edit</button>
</div>
</div>

<div class="plant-card" data-plant-id="2" onclick="selectPlant(2)" style="background:var(--bg-section);padding:20px;border-radius:12px;border-left:4px solid var(--ok);cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<strong>South Municipal Plant</strong>
<span class="status ok">ONLINE</span>
</div>
<div style="color:var(--text-unit);font-size:14px;margin-bottom:12px">üìç Pearland, TX</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
<div>Capacity: <strong>3.5 MGD</strong></div>
<div>Flow: <strong>2.8 MGD</strong></div>
<div>Efficiency: <strong style="color:#06d6a0">92.1%</strong></div>
<div>Load: <strong>80%</strong></div>
</div>
<div style="margin-top:12px;display:flex;gap:8px">
<button class="btn small blue" onclick="event.stopPropagation();viewPlantDetails(2)">View</button>
<button class="btn small orange" onclick="event.stopPropagation();editPlant(2)">Edit</button>
</div>
</div>

<div class="plant-card" data-plant-id="3" onclick="selectPlant(3)" style="background:var(--bg-section);padding:20px;border-radius:12px;border-left:4px solid var(--warn);cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<strong>East Industrial WWTP</strong>
<span class="status warn">MAINTENANCE</span>
</div>
<div style="color:var(--text-unit);font-size:14px;margin-bottom:12px">üìç Pasadena, TX</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
<div>Capacity: <strong>8.0 MGD</strong></div>
<div>Flow: <strong>6.5 MGD</strong></div>
<div>Efficiency: <strong style="color:#ffd166">89.7%</strong></div>
<div>Load: <strong>81%</strong></div>
</div>
<div style="margin-top:12px;display:flex;gap:8px">
<button class="btn small blue" onclick="event.stopPropagation();viewPlantDetails(3)">View</button>
<button class="btn small orange" onclick="event.stopPropagation();editPlant(3)">Edit</button>
</div>
</div>

<div class="plant-card" data-plant-id="4" onclick="selectPlant(4)" style="background:var(--bg-section);padding:20px;border-radius:12px;border-left:4px solid var(--ok);cursor:pointer;transition:all 0.3s">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
<strong>West Community Plant</strong>
<span class="status ok">ONLINE</span>
</div>
<div style="color:var(--text-unit);font-size:14px;margin-bottom:12px">üìç Katy, TX</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
<div>Capacity: <strong>2.0 MGD</strong></div>
<div>Flow: <strong>1.6 MGD</strong></div>
<div>Efficiency: <strong style="color:#06d6a0">96.2%</strong></div>
<div>Load: <strong>80%</strong></div>
</div>
<div style="margin-top:12px;display:flex;gap:8px">
<button class="btn small blue" onclick="event.stopPropagation();viewPlantDetails(4)">View</button>
<button class="btn small orange" onclick="event.stopPropagation();editPlant(4)">Edit</button>
</div>
</div>

<div class="section">
<div class="section-h">‚è∞ Detention Time (General)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Tank Volume (gallons)</label><input type="number" id="det_vol" value="500000"></div>
<div class="input-group"><label>Flow Rate (GPM)</label><input type="number" id="det_gpm" value="3500"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcDetention()">Calculate</button>
<button class="btn gray" onclick="resetDetention()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Detention Time</td><td><span class="result" id="r_det_min">-</span></td><td>minutes</td></tr>
<tr><td class="rowh">Detention Time</td><td><span class="result" id="r_det_hr">-</span></td><td>hours</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üë• Population Equivalent</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>BOD Load (lb/day)</label><input type="number" id="pe_bod" value="5000"></div>
<div class="input-group"><label>Flow (MGD)</label><input type="number" id="pe_flow" value="5.0" step="0.1"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcPE()">Calculate</button>
<button class="btn gray" onclick="resetPE()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">PE (BOD basis)</td><td><span class="result" id="r_pe_bod">-</span></td><td>people</td></tr>
<tr><td class="rowh">PE (Flow basis)</td><td><span class="result" id="r_pe_flow">-</span></td><td>people</td></tr>
<tr><td class="rowh">GPD per capita</td><td><span class="result" id="r_pe_gpd">-</span></td><td>gpd/person</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üìÖ Sludge Age (Simple)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Aeration Tank MLSS (lb)</label><input type="number" id="sa_mlss" value="25000"></div>
<div class="input-group"><label>WAS Rate (lb/day)</label><input type="number" id="sa_was" value="2500"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcSludgeAge()">Calculate</button>
<button class="btn gray" onclick="resetSludgeAge()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Sludge Age</td><td><span class="result" id="r_sa">-</span></td><td>days</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_sa_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üìâ Percent Removal (Universal)</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Influent Concentration</label><input type="number" id="rem_in" value="200"></div>
<div class="input-group"><label>Effluent Concentration</label><input type="number" id="rem_out" value="20"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcRemoval()">Calculate</button>
<button class="btn gray" onclick="resetRemoval()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Amount Removed</td><td><span class="result" id="r_rem_amt">-</span></td><td>units</td></tr>
<tr><td class="rowh">Percent Removal</td><td><span class="result" id="r_rem_pct">-</span></td><td>%</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üîÑ Flow Unit Converter</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Flow Value</label><input type="number" id="conv_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Input Unit</label>
<select id="conv_unit">
<option value="mgd">MGD</option>
<option value="gpm">GPM</option>
<option value="gpd">GPD</option>
<option value="cfs">CFS</option>
<option value="m3d">m¬≥/day</option>
<option value="lps">L/s</option>
</select>
</div>
</div>
<div class="btns">
<button class="btn green" onclick="calcFlowConv()">Convert</button>
<button class="btn gray" onclick="resetFlowConv()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">MGD</td><td><span class="result" id="r_conv_mgd">-</span></td><td></td></tr>
<tr><td class="rowh">GPM</td><td><span class="result" id="r_conv_gpm">-</span></td><td></td></tr>
<tr><td class="rowh">GPD</td><td><span class="result" id="r_conv_gpd">-</span></td><td></td></tr>
<tr><td class="rowh">CFS</td><td><span class="result" id="r_conv_cfs">-</span></td><td></td></tr>
<tr><td class="rowh">m¬≥/day</td><td><span class="result" id="r_conv_m3d">-</span></td><td></td></tr>
<tr><td class="rowh">L/s</td><td><span class="result" id="r_conv_lps">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üîä Blower Noise Estimation</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Blower HP</label><input type="number" id="noise_hp" value="100"></div>
<div class="input-group"><label>Distance (ft)</label><input type="number" id="noise_dist" value="50"></div>
<div class="input-group"><label>Number of Blowers</label><input type="number" id="noise_num" value="2"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcNoise()">Calculate</button>
<button class="btn gray" onclick="resetNoise()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Est. Sound Level</td><td><span class="result" id="r_noise_db">-</span></td><td>dB(A)</td></tr>
<tr><td class="rowh">Status</td><td><span class="result" id="r_noise_status">-</span></td><td></td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üåç Carbon Footprint Estimator</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Energy Use (kWh/day)</label><input type="number" id="carbon_kwh" value="5000"></div>
<div class="input-group"><label>Chemical Use (lb/day)</label><input type="number" id="carbon_chem" value="500"></div>
<div class="input-group"><label>Biogas Captured (cf/day)</label><input type="number" id="carbon_biogas" value="10000"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcCarbon()">Calculate</button>
<button class="btn gray" onclick="resetCarbon()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Energy CO2</td><td><span class="result" id="r_carbon_energy">-</span></td><td>lb CO2/day</td></tr>
<tr><td class="rowh">Chemical CO2</td><td><span class="result" id="r_carbon_chem">-</span></td><td>lb CO2/day</td></tr>
<tr><td class="rowh">Biogas Offset</td><td><span class="result" id="r_carbon_offset">-</span></td><td>lb CO2/day</td></tr>
<tr><td class="rowh">Net Carbon</td><td><span class="result" id="r_carbon_net">-</span></td><td>lb CO2/day</td></tr>
</tbody></table>
</div>
</div>

<div class="section">
<div class="section-h">üí∞ Treatment Cost Analysis</div>
<div class="section-content">
<div class="row">
<div class="input-group"><label>Daily Flow (MGD)</label><input type="number" id="cost_flow" value="5.0" step="0.1"></div>
<div class="input-group"><label>Energy Cost ($/day)</label><input type="number" id="cost_energy" value="1500"></div>
<div class="input-group"><label>Chemical Cost ($/day)</label><input type="number" id="cost_chem" value="800"></div>
<div class="input-group"><label>Labor Cost ($/day)</label><input type="number" id="cost_labor" value="2000"></div>
<div class="input-group"><label>Sludge Disposal ($/day)</label><input type="number" id="cost_sludge" value="500"></div>
</div>
<div class="btns">
<button class="btn green" onclick="calcTreatmentCost()">Calculate</button>
<button class="btn gray" onclick="resetTreatmentCost()">Reset</button>
</div>
<table class="table"><tbody>
<tr><td class="rowh">Total Daily Cost</td><td><span class="result" id="r_cost_total">-</span></td><td>$/day</td></tr>
<tr><td class="rowh">Cost per MG</td><td><span class="result" id="r_cost_mg">-</span></td><td>$/MG</td></tr>
<tr><td class="rowh">Cost per 1000 gal</td><td><span class="result" id="r_cost_kgal">-</span></td><td>$/1000 gal</td></tr>
<tr><td class="rowh">Monthly Cost</td><td><span class="result" id="r_cost_month">-</span></td><td>$/month</td></tr>
<tr><td class="rowh">Annual Cost</td><td><span class="result" id="r_cost_year">-</span></td><td>$/year</td></tr>
</tbody></table>
</div>
</div>

</div>

<div class="section">
<div class="section-h">üìà Fleet Analytics Summary</div>
<div class="section-content">
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px">
<div style="background:linear-gradient(135deg,#06d6a020,#06d6a010);padding:16px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:#06d6a0">93.1%</div>
<div style="font-size:14px;opacity:0.8">Fleet Avg Efficiency</div>
<div style="font-size:12px;color:#06d6a0;margin-top:4px">‚Üë 2.3% vs last month</div>
</div>
<div style="background:linear-gradient(135deg,#0077b620,#0077b610);padding:16px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:#0077b6">82%</div>
<div style="font-size:14px;opacity:0.8">Avg Capacity Utilization</div>
<div style="font-size:12px;color:#0077b6;margin-top:4px">Optimal Range</div>
</div>
<div style="background:linear-gradient(135deg,#ffd16620,#ffd16610);padding:16px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:#ffd166">$45.2K</div>
<div style="font-size:14px;opacity:0.8">Monthly Operating Cost</div>
<div style="font-size:12px;color:#06d6a0;margin-top:4px">‚Üì 5% vs budget</div>
</div>
<div style="background:linear-gradient(135deg,#00b4d820,#00b4d810);padding:16px;border-radius:12px;text-align:center">
<div style="font-size:32px;font-weight:bold;color:#00b4d8">99.2%</div>
<div style="font-size:14px;opacity:0.8">Compliance Rate</div>
<div style="font-size:12px;color:#00b4d8;margin-top:4px">All permits current</div>
</div>
</div>
</div>
</div>

<div class="note" style="margin-top:24px">
<strong>üí° Tips:</strong> Click on a plant card to select it, then use Edit/Delete buttons. Use Compare to analyze multiple plants side-by-side. Export data to CSV for reporting.
</div>

</div>
</div>
</div>

</div>
</div>
<script>
// ========== APP VERSION ==========
const APP_VERSION = "3.3.0";
const BUILD_DATE = "Dec 2, 2025 - Enhanced";

// Display version info in console
// Core utilities
const $=id=>document.getElementById(id);
const $$=s=>document.querySelectorAll(s);

// ========== CALCULATOR FUNCTIONS (FIXED) ==========

function calcOLR() {
  var bod = parseFloat(document.getElementById('olr_bod').value) || 0;
  var flow = parseFloat(document.getElementById('olr_flow').value) || 0;
  var vol = parseFloat(document.getElementById('olr_vol').value) || 0;
  var load = bod * flow * 8.34;
  var volCf = vol * 1000000 / 7.48;
  var olr = vol > 0 ? (load / volCf) * 1000 : 0;
  document.getElementById('r_olr_load').textContent = load.toFixed(0);
  document.getElementById('r_olr').textContent = olr.toFixed(1);
}
function resetOLR() {
  document.getElementById('olr_bod').value = '200';
  document.getElementById('olr_flow').value = '5.0';
  document.getElementById('olr_vol').value = '1.0';
  document.getElementById('r_olr_load').textContent = '-';
  document.getElementById('r_olr').textContent = '-';
}

function calcFM() {
  var bod = parseFloat(document.getElementById('fm_bod').value) || 0;
  var mlvss = parseFloat(document.getElementById('fm_mlvss').value) || 0;
  var vol = parseFloat(document.getElementById('fm_vol').value) || 0;
  var mass = mlvss * vol * 8.34;
  var fm = mass > 0 ? bod / mass : 0;
  document.getElementById('r_fm_mass').textContent = mass.toFixed(0);
  document.getElementById('r_fm').textContent = fm.toFixed(3);
  var status = fm >= 0.2 && fm <= 0.5 ? 'Optimal' : fm < 0.2 ? 'Low' : 'High';
  document.getElementById('r_fm_status').textContent = status;
  if(typeof CalcHistory!=='undefined') CalcHistory.add('F/M Ratio', {BOD:bod,MLVSS:mlvss,Vol:vol}, fm.toFixed(3)+' ('+status+')');
}
function resetFM() {
  document.getElementById('fm_bod').value = '8340';
  document.getElementById('fm_mlvss').value = '2000';
  document.getElementById('fm_vol').value = '1.0';
  document.getElementById('r_fm_mass').textContent = '-';
  document.getElementById('r_fm').textContent = '-';
  document.getElementById('r_fm_status').textContent = '-';
}

function calcSRTmain() {
  var mlss = parseFloat(document.getElementById('srt_mlss').value) || 0;
  var vol = parseFloat(document.getElementById('srt_vol').value) || 0;
  var was = parseFloat(document.getElementById('srt_was').value) || 0;
  var wasTss = parseFloat(document.getElementById('srt_was_tss').value) || 0;
  var eff = parseFloat(document.getElementById('srt_eff').value) || 0;
  var effTss = parseFloat(document.getElementById('srt_eff_tss').value) || 0;
  var solids = mlss * vol * 8.34;
  var wasted = (was * wasTss * 8.34) + (eff * effTss * 8.34);
  var srt = wasted > 0 ? solids / wasted : 0;
  document.getElementById('r_srt_solids').textContent = solids.toFixed(0);
  document.getElementById('r_srt_wasted').textContent = wasted.toFixed(0);
  document.getElementById('r_srt').textContent = srt.toFixed(1);
  var status = srt >= 5 && srt <= 15 ? 'Optimal' : srt < 5 ? 'Low' : 'High';
  document.getElementById('r_srt_status').textContent = status;
  if(typeof CalcHistory!=='undefined') CalcHistory.add('SRT', {MLSS:mlss,Vol:vol}, srt.toFixed(1)+' days ('+status+')');
}
function resetSRTmain() {
  document.getElementById('srt_mlss').value = '2500';
  document.getElementById('srt_vol').value = '1.2';
  document.getElementById('srt_was').value = '0.05';
  document.getElementById('srt_was_tss').value = '8000';
  document.getElementById('srt_eff').value = '5.0';
  document.getElementById('srt_eff_tss').value = '10';
  document.getElementById('r_srt_solids').textContent = '-';
  document.getElementById('r_srt_wasted').textContent = '-';
  document.getElementById('r_srt').textContent = '-';
  document.getElementById('r_srt_status').textContent = '-';
}

function calcHRT() {
  var vol = parseFloat(document.getElementById('hrt_vol').value) || 0;
  var flow = parseFloat(document.getElementById('hrt_flow').value) || 0;
  var hrt = flow > 0 ? (vol / (flow * 1000000)) * 24 : 0;
  document.getElementById('r_hrt').textContent = hrt.toFixed(2);
  document.getElementById('r_hrt_status').textContent = hrt >= 4 && hrt <= 8 ? 'Optimal' : hrt < 4 ? 'Low' : 'High';
}
function resetHRT() {
  document.getElementById('hrt_vol').value = '500000';
  document.getElementById('hrt_flow').value = '2.0';
  document.getElementById('r_hrt').textContent = '-';
  document.getElementById('r_hrt_status').textContent = '-';
}

function calcBODeff() {
  var bodIn = parseFloat(document.getElementById('bod_in').value) || 0;
  var bodOut = parseFloat(document.getElementById('bod_out').value) || 0;
  var removed = bodIn - bodOut;
  var eff = bodIn > 0 ? (removed / bodIn) * 100 : 0;
  document.getElementById('r_bod_removed').textContent = removed.toFixed(0);
  document.getElementById('r_bod_eff').textContent = eff.toFixed(1);
  document.getElementById('r_bod_status').textContent = eff >= 85 ? 'Good' : 'Low';
}
function resetBODeff() {
  document.getElementById('bod_in').value = '200';
  document.getElementById('bod_out').value = '10';
  document.getElementById('r_bod_removed').textContent = '-';
  document.getElementById('r_bod_eff').textContent = '-';
  document.getElementById('r_bod_status').textContent = '-';
}

function calcSVI() {
  var vol = parseFloat(document.getElementById('svi_vol').value) || 0;
  var mlss = parseFloat(document.getElementById('svi_mlss').value) || 0;
  var svi = mlss > 0 ? (vol * 1000) / mlss : 0;
  document.getElementById('r_svi').textContent = svi.toFixed(0);
  var status = 'Poor';
  if (svi <= 100) status = 'Excellent';
  else if (svi <= 150) status = 'Good';
  else if (svi <= 200) status = 'Fair';
  document.getElementById('r_svi_status').textContent = status;
  if(typeof CalcHistory!=='undefined') CalcHistory.add('SVI', {Vol:vol,MLSS:mlss}, svi.toFixed(0)+' mL/g ('+status+')');
}
function resetSVI() {
  document.getElementById('svi_vol').value = '250';
  document.getElementById('svi_mlss').value = '2500';
  document.getElementById('r_svi').textContent = '-';
  document.getElementById('r_svi_status').textContent = '-';
}

function calcWAS() {
  var srt = parseFloat(document.getElementById('was_srt').value) || 0;
  var mlss = parseFloat(document.getElementById('was_mlss').value) || 0;
  var vol = parseFloat(document.getElementById('was_vol').value) || 0;
  var conc = parseFloat(document.getElementById('was_conc').value) || 0;
  var solids = mlss * vol * 8.34;
  var wasteLb = srt > 0 ? solids / srt : 0;
  var wasFlow = conc > 0 ? (wasteLb / (conc * 8.34)) * 1000000 : 0;
  document.getElementById('r_was_flow').textContent = wasFlow.toFixed(0);
  document.getElementById('r_was_lb').textContent = wasteLb.toFixed(0);
}
function resetWAS() {
  document.getElementById('was_srt').value = '10';
  document.getElementById('was_mlss').value = '2500';
  document.getElementById('was_vol').value = '1.0';
  document.getElementById('was_conc').value = '8000';
  document.getElementById('r_was_flow').textContent = '-';
  document.getElementById('r_was_lb').textContent = '-';
}

function calcRAS() {
  var flow = parseFloat(document.getElementById('ras_flow').value) || 0;
  var mlss = parseFloat(document.getElementById('ras_mlss').value) || 0;
  var tss = parseFloat(document.getElementById('ras_tss').value) || 0;
  var ratio = tss > mlss ? (mlss / (tss - mlss)) * 100 : 0;
  var rasFlow = flow * (ratio / 100);
  document.getElementById('r_ras_ratio').textContent = ratio.toFixed(0);
  document.getElementById('r_ras_flow').textContent = rasFlow.toFixed(2);
}
function resetRAS() {
  document.getElementById('ras_flow').value = '5.0';
  document.getElementById('ras_mlss').value = '2500';
  document.getElementById('ras_tss').value = '8000';
  document.getElementById('r_ras_ratio').textContent = '-';
  document.getElementById('r_ras_flow').textContent = '-';
}

function calcChlorine() {
  var flow = parseFloat(document.getElementById('cl_flow').value) || 0;
  var dose = parseFloat(document.getElementById('cl_dose').value) || 0;
  var lbDay = flow * dose * 8.34;
  var galDay = lbDay / (8.34 * 1.2 * 0.125);
  document.getElementById('r_cl_lb').textContent = lbDay.toFixed(1);
  document.getElementById('r_cl_gal').textContent = galDay.toFixed(1);
}
function resetChlorine() {
  document.getElementById('cl_flow').value = '5.0';
  document.getElementById('cl_dose').value = '5.0';
  document.getElementById('r_cl_lb').textContent = '-';
  document.getElementById('r_cl_gal').textContent = '-';
}

function calcPolymer() {
  var flow = parseFloat(document.getElementById('poly_flow').value) || 0;
  var solids = parseFloat(document.getElementById('poly_solids').value) || 0;
  var dose = parseFloat(document.getElementById('poly_dose').value) || 0;
  var dryLbHr = flow * 60 * 8.34 * (solids / 100);
  var polyLb = (dryLbHr / 2000) * dose;
  document.getElementById('r_poly_dry').textContent = dryLbHr.toFixed(1);
  document.getElementById('r_poly_lb').textContent = polyLb.toFixed(2);
}
function resetPolymer() {
  document.getElementById('poly_flow').value = '50';
  document.getElementById('poly_solids').value = '1.0';
  document.getElementById('poly_dose').value = '8';
  document.getElementById('r_poly_dry').textContent = '-';
  document.getElementById('r_poly_lb').textContent = '-';
}

function calcPump() {
  var gpm = parseFloat(document.getElementById('pump_gpm').value) || 0;
  var tdh = parseFloat(document.getElementById('pump_tdh').value) || 0;
  var pEff = parseFloat(document.getElementById('pump_eff').value) || 0;
  var mEff = parseFloat(document.getElementById('pump_motor').value) || 0;
  var whp = (gpm * tdh) / 3960;
  var bhp = pEff > 0 ? whp / (pEff / 100) : 0;
  var mhp = mEff > 0 ? bhp / (mEff / 100) : 0;
  var kw = mhp * 0.746;
  document.getElementById('r_pump_whp').textContent = whp.toFixed(2);
  document.getElementById('r_pump_bhp').textContent = bhp.toFixed(2);
  document.getElementById('r_pump_mhp').textContent = mhp.toFixed(2);
  document.getElementById('r_pump_kw').textContent = kw.toFixed(2);
}
function resetPump() {
  document.getElementById('pump_gpm').value = '500';
  document.getElementById('pump_tdh').value = '50';
  document.getElementById('pump_eff').value = '70';
  document.getElementById('pump_motor').value = '90';
  document.getElementById('r_pump_whp').textContent = '-';
  document.getElementById('r_pump_bhp').textContent = '-';
  document.getElementById('r_pump_mhp').textContent = '-';
  document.getElementById('r_pump_kw').textContent = '-';
}

// ========== END CALCULATOR FUNCTIONS ==========
const fmt={
n:(v,d=0)=>Number(v).toFixed(d).replace(/\B(?=(\d{3})+(?!\d))/g,','),
f:(v,d=2)=>Number(v).toFixed(d),
p:(v,d=1)=>(Number(v)*100).toFixed(d)+'%'
};

let state={
data:{},
plants:[],
alerts:[],
maintenance:[],
labTests:[],
charts:{},
aiChat:[],
issues:[],
symptoms:[]
};

// AI Knowledge Base
const knowledgeBase=[
{id:1,title:'High SVI Troubleshooting',category:'Sludge',content:'High Sludge Volume Index (SVI >150 mL/g) indicates bulking. Causes: filamentous bacteria, low DO, nutrient deficiency. Solutions: increase DO to 2.5+ mg/L, reduce F/M ratio, add selector zone, chlorinate RAS.',keywords:'svi bulking filamentous settling'},
{id:2,title:'Low DO Recovery',category:'Oxygen',content:'Dissolved oxygen not reaching target indicates insufficient aeration. Check: blower capacity, diffuser fouling, membrane damage. Solutions: clean diffusers, increase airflow, repair/replace damaged equipment.',keywords:'do oxygen aeration blower diffuser'},
{id:3,title:'Ammonia Breakthrough',category:'Nitrification',content:'High effluent ammonia (>2 mg/L) indicates nitrification failure. Causes: low temperature, insufficient MCRT, low DO, toxic shock. Solutions: increase MCRT to 8-12 days, maintain DO >2 mg/L, check alkalinity.',keywords:'ammonia nitrification tkn nitrogen'},
{id:4,title:'Rising Sludge',category:'Sludge',content:'Sludge rising in clarifier indicates denitrification. Causes: excessive RAS detention, low DO in clarifier. Solutions: increase RAS rate, reduce sludge blanket depth, improve aeration.',keywords:'rising sludge clarifier denitrification'},
{id:5,title:'Pin Floc Formation',category:'Sludge',content:'Small, dispersed floc particles indicate old sludge or toxic shock. Causes: extended MCRT, toxicity, low F/M. Solutions: reduce MCRT, increase WAS, investigate toxic discharge.',keywords:'floc pin particle dispersed'},
{id:6,title:'Foam & Scum',category:'Operations',content:'Excessive foam indicates presence of surfactants, NOx in sludge, or Nocardia growth. Solutions: spray foam with water, add antifoam agent, reduce MCRT, investigate industrial discharge.',keywords:'foam scum nocardia surfactant'},
{id:7,title:'Energy Consumption High',category:'Energy',content:'High energy use (>2000 kWh/MG) indicates inefficiency. Check: blower operation, VFD settings, DO setpoints, equipment staging. Solutions: optimize DO control, install VFDs, improve equipment staging.',keywords:'energy power consumption efficiency kwh'},
{id:8,title:'Phosphorus Removal',category:'Nutrients',content:'Biological P removal requires anaerobic zone, adequate VFAs, low DO. Chemical removal uses alum, ferric, or lime. Optimize: F/M ratio 0.3-0.5, anaerobic HRT 1-2 hours, maintain proper pH.',keywords:'phosphorus phosphate ebpr chemical'},
{id:9,title:'Septicity & Odors',category:'Operations',content:'Septic conditions and H2S odors from anaerobic conditions. Causes: long collection system detention, low DO. Solutions: pre-aeration, chemical addition (chlorine, peroxide), improved ventilation.',keywords:'septic odor h2s sulfide smell'},
{id:10,title:'Clarifier Performance',category:'Solids',content:'Poor clarifier performance: high effluent TSS, sludge blanket >50% depth. Causes: hydraulic overload, density currents, short-circuiting. Solutions: reduce flow, adjust RAS, improve baffling.',keywords:'clarifier settling tss effluent solids'}
];

// Common symptoms for troubleshooting
const symptoms=[
{id:'high_eff_bod',text:'High effluent BOD (>30 mg/L)',issues:['underloading','overloading','toxicity','low_do']},
{id:'high_eff_tss',text:'High effluent TSS (>30 mg/L)',issues:['bulking','pinfloc','clarifier_overload']},
{id:'high_eff_nh3',text:'High effluent ammonia',issues:['low_mcrt','low_do','low_temp','toxicity']},
{id:'high_svi',text:'High SVI (>150 mL/g)',issues:['bulking','filamentous']},
{id:'low_svi',text:'Low SVI (<80 mL/g)',issues:['pinfloc','old_sludge']},
{id:'low_do',text:'Low DO (<1.5 mg/L)',issues:['blower_failure','diffuser_fouling','overload']},
{id:'high_mlss',text:'MLSS too high (>4000 mg/L)',issues:['insufficient_was','clarifier_issue']},
{id:'low_mlss',text:'MLSS too low (<1500 mg/L)',issues:['excessive_was','washout']},
{id:'foam',text:'Excessive foam/scum',issues:['nocardia','surfactants','denitrification']},
{id:'odors',text:'Septic odors (H2S)',issues:['septicity','anaerobic']},
{id:'rising_sludge',text:'Rising sludge in clarifier',issues:['denitrification','gas_bubbles']},
{id:'poor_settling',text:'Poor sludge settling',issues:['bulking','temperature','toxicity']},
{id:'brown_foam',text:'Brown/tan foam',issues:['surfactants','young_sludge']},
{id:'white_foam',text:'White billowy foam',issues:['nocardia','actinomycetes']},
{id:'high_energy',text:'High energy consumption',issues:['inefficient_aeration','equipment_issues']}
];

// Issue database for tracking
const issueDatabase={
bulking:{
name:'Sludge Bulking',
severity:'high',
causes:['Filamentous bacteria overgrowth','Low DO (<1.5 mg/L)','Nutrient deficiency (N or P)','Low F/M ratio (<0.2)','Presence of readily biodegradable substrate'],
solutions:[
{step:1,action:'Check and record current SVI, MLSS, DO, F/M ratio'},
{step:2,action:'Perform microscopic exam to identify filament type'},
{step:3,action:'Increase DO to 2.5-3.0 mg/L throughout basin'},
{step:4,action:'If low F/M: reduce MLSS by increasing WAS or reduce aeration volume'},
{step:5,action:'Add selector zone or implement step-feed operation'},
{step:6,action:'Consider chlorination of RAS (5-10 mg/L for 15-30 min contact)'},
{step:7,action:'Monitor daily SVI until <120 mL/g achieved'}
],
prevention:['Maintain DO >2.0 mg/L','Keep F/M ratio 0.3-0.5','Ensure adequate nutrients (100:5:1)','Regular microscopic monitoring']
},
low_do:{
name:'Low Dissolved Oxygen',
severity:'high',
causes:['Blower capacity insufficient','Diffuser fouling/damage','Excessive organic loading','Equipment failure','Control system malfunction'],
solutions:[
{step:1,action:'Check all blowers - verify operation and amperage draw'},
{step:2,action:'Inspect diffusers for fouling, damage, or uneven distribution'},
{step:3,action:'Measure actual airflow with pitot tube or flow meter'},
{step:4,action:'Calculate oxygen requirement vs. delivery capability'},
{step:5,action:'Clean fouled diffusers (acid wash if needed)'},
{step:6,action:'Increase blower output or stage additional blower'},
{step:7,action:'If equipment failure: implement emergency bypass/repairs'},
{step:8,action:'Recalibrate DO probes and control system'}
],
prevention:['Regular diffuser inspection/cleaning (quarterly)','Preventive maintenance on blowers','Spare blower capacity (N+1)','Automated DO control with alarms']
},
high_eff_nh3:{
name:'Ammonia Breakthrough',
severity:'critical',
causes:['MCRT too short (<5 days)','Low DO in aerobic zones','Low temperature (<12¬∞C)','Insufficient alkalinity','Toxic shock load','Nitrifier washout'],
solutions:[
{step:1,action:'Immediately stop or reduce WAS to increase MCRT'},
{step:2,action:'Increase DO setpoint to 2.5-3.0 mg/L'},
{step:3,action:'Test alkalinity - add if <50 mg/L as CaCO3'},
{step:4,action:'Calculate and target MCRT of 10-15 days minimum'},
{step:5,action:'Reduce influent load if possible (equalization, bypass)'},
{step:6,action:'Check for toxic industrial discharge - investigate I/I'},
{step:7,action:'Monitor effluent NH3 daily until <1.0 mg/L'},
{step:8,action:'If chronic: consider bioaugmentation with nitrifiers'}
],
prevention:['Maintain MCRT >8 days year-round','Keep DO >2.0 mg/L','Monitor alkalinity weekly','Industrial pretreatment program','Temperature-based MCRT adjustment']
},
clarifier_overload:{
name:'Clarifier Overload',
severity:'medium',
causes:['Hydraulic overload (SOR >800 gpd/ft¬≤)','Solids overload (SLR >30 lb/ft¬≤/d)','Density currents','Short-circuiting','Equipment malfunction (rake, skimmer)'],
solutions:[
{step:1,action:'Calculate actual SOR and SLR vs. design'},
{step:2,action:'Reduce flow if possible (bypass, equalization)'},
{step:3,action:'Increase RAS rate to reduce sludge blanket'},
{step:4,action:'Check and adjust weir loading'},
{step:5,action:'Inspect baffles for proper positioning'},
{step:6,action:'Verify rake/skimmer operation'},
{step:7,action:'Add polymer for improved settling if needed'},
{step:8,action:'Consider temporary TSS limit variance if critical'}
],
prevention:['Size clarifiers for peak flows','Maintain sludge blanket <30% depth','Regular equipment maintenance','Flow equalization']
}
};

// Initialize
const today=new Date().toISOString().split('T')[0];
if($('calcDate'))$('calcDate').value=today;

// Load saved data
const saved=localStorage.getItem('wwtp_enhanced_data');
if(saved){
try{
const loaded=JSON.parse(saved);
if(loaded.plants)state.plants=loaded.plants;
if(loaded.maintenance)state.maintenance=loaded.maintenance;
if(loaded.alerts)state.alerts=loaded.alerts;
if(loaded.issues)state.issues=loaded.issues;
}catch(e){console.error('Load error:',e)}
}

// Tab switching - v9.5.0 FIXED
function switchPanel(panelId) {

  // Hide all panels
  document.querySelectorAll('.panel').forEach(function(p) {
    p.classList.remove('active');
  });

  // Show target panel
  var target = document.getElementById(panelId);
  if (target) {
    target.classList.add('active');
  }

  // Update tabs
  document.querySelectorAll('.tab').forEach(function(t) {
    t.classList.remove('active');
    if (t.getAttribute('data-panel') === panelId) t.classList.add('active');
  });

  window.scrollTo(0, 0);
}
// ==================== UNIT CONVERSION SYSTEM v9.5.0 ====================
var currentUnits = 'imperial'; // 'imperial' or 'metric'

// Conversion factors (imperial to metric multiplier)
var unitConversions = {
  // Volume flow
  'MGD': { metric: 'm¬≥/day', factor: 3785.41 },
  'GPM': { metric: 'L/min', factor: 3.78541 },
  'GPD': { metric: 'L/day', factor: 3.78541 },
  // Mass
  'lb': { metric: 'kg', factor: 0.453592 },
  'lb/day': { metric: 'kg/day', factor: 0.453592 },
  'lb/hr': { metric: 'kg/hr', factor: 0.453592 },
  'lb/DT': { metric: 'kg/DT', factor: 0.453592 },
  // Length
  'ft': { metric: 'm', factor: 0.3048 },
  'in': { metric: 'cm', factor: 2.54 },
  // Area
  'sf': { metric: 'm¬≤', factor: 0.092903 },
  'ft¬≤': { metric: 'm¬≤', factor: 0.092903 },
  'ac': { metric: 'ha', factor: 0.404686 },
  // Volume
  'gal': { metric: 'L', factor: 3.78541 },
  'MG': { metric: 'ML', factor: 3.78541 },
  'cf': { metric: 'm¬≥', factor: 0.0283168 },
  'cf/day': { metric: 'm¬≥/day', factor: 0.0283168 },
  'cf/lb VS': { metric: 'm¬≥/kg VS', factor: 0.0624 },
  // Pressure
  'psi': { metric: 'kPa', factor: 6.89476 },
  // Power
  'HP': { metric: 'kW', factor: 0.7457 },
  // Energy
  'kWh/yr': { metric: 'kWh/yr', factor: 1 },
  'BTU/day': { metric: 'MJ/day', factor: 0.001055 },
  // Loading rates
  'lb/1000 cf': { metric: 'kg/m¬≥', factor: 0.016018 },
  'lb/1000 cf/day': { metric: 'kg/m¬≥/day', factor: 0.016018 },
  'gpd/sf': { metric: 'L/m¬≤/day', factor: 40.7458 },
  'lb BOD/1000 cf/day': { metric: 'kg BOD/m¬≥/day', factor: 0.016018 },
  'SCFM': { metric: 'm¬≥/min', factor: 0.0283168 },
  // Velocity
  'fps': { metric: 'm/s', factor: 0.3048 },
  'ft/s': { metric: 'm/s', factor: 0.3048 }
};

// Map input IDs to their units (for value conversion)
var inputUnitMap = {
  // Flow inputs
  'olr_flow': 'MGD', 'fm_flow': 'MGD', 'srt_flow': 'MGD', 'mc_flow': 'MGD',
  'eff_flow': 'MGD', 'clar_flow': 'MGD', 'grit_flow': 'MGD', 'sed_flow': 'MGD',
  'hl_flow': 'MGD', 'weir_flow': 'MGD', 'pump_flow': 'GPM', 'bp_rate': 'GPM',
  'was_flow': 'GPD', 'ras_flow': 'GPD',
  // Volume inputs
  'olr_vol': 'MG', 'fm_vol': 'MG', 'srt_vol': 'MG', 'mc_vol': 'MG',
  // Length/depth inputs
  'clar_depth': 'ft', 'grit_depth': 'ft', 'grit_width': 'ft', 'sed_depth': 'ft',
  'sed_length': 'ft', 'sed_width': 'ft', 'weir_length': 'ft', 'hl_length': 'ft',
  'hl_diameter': 'in', 'pump_head': 'ft', 'blower_depth': 'ft',
  // Mass inputs
  'sludge_flow_lb': 'lb/day', 'gas_vs': 'lb/day', 'blower_o2': 'lb/day'
};

// Map result IDs to their units
var resultUnitMap = {
  'r_olr_load': 'lb/day', 'r_olr': 'lb/1000 cf/day',
  'r_sludge': 'lb/day', 'r_was': 'GPD',
  'r_clar_area': 'sf', 'r_clar_vol': 'MG',
  'r_grit_length': 'ft', 'r_grit_vol': 'cf',
  'r_sed_area': 'sf', 'r_sed_vol': 'gal', 'r_sed_dt': 'hr',
  'r_weir_rate': 'GPD', 'r_hl_vel': 'fps', 'r_hl_loss': 'ft',
  'r_pump_hp': 'HP', 'r_pump_kw': 'kW',
  'r_gas_total': 'cf/day', 'r_gas_ch4': 'cf/day', 'r_gas_kw': 'kW',
  'r_bp_dry': 'lb/hr', 'r_bp_cake': 'lb/hr', 'r_bp_polymer': 'lb/hr',
  'r_blower_air': 'SCFM', 'r_blower_hp': 'HP', 'r_blower_kwh': 'kWh/yr'
};

function toggleUnits() {
  var wasMetric = (currentUnits === 'metric');
  currentUnits = wasMetric ? 'imperial' : 'metric';
  var toMetric = !wasMetric;

  var btn = document.getElementById('unitToggleBtn');
  if (btn) {
    if (currentUnits === 'metric') {
      btn.innerHTML = 'üåç MET';
      btn.classList.add('metric');
      document.body.classList.add('metric-mode');
    } else {
      btn.innerHTML = 'üá∫üá∏ IMP';
      btn.classList.remove('metric');
      document.body.classList.remove('metric-mode');
    }
  }

  // Convert input values
  convertInputValues(toMetric);

  // Convert result values
  convertResultValues(toMetric);

  // Update all unit labels in UI
  updateAllUnitLabels(toMetric);

  // Save preference
  localStorage.setItem('wwtp_units', currentUnits);

  // Show toast
  showToast(currentUnits === 'metric' ? 'üåç Switched to Metric Units (values converted)' : 'üá∫üá∏ Switched to Imperial Units (values converted)', 'success');

}

function convertInputValues(toMetric) {
  for (var inputId in inputUnitMap) {
    var input = document.getElementById(inputId);
    if (input && input.value) {
      var unitKey = inputUnitMap[inputId];
      var conv = unitConversions[unitKey];
      if (conv && conv.factor) {
        var oldVal = parseFloat(input.value);
        if (!isNaN(oldVal)) {
          var newVal = toMetric ? oldVal * conv.factor : oldVal / conv.factor;
          // Round appropriately based on magnitude
          if (newVal >= 100) {
            input.value = Math.round(newVal);
          } else if (newVal >= 1) {
            input.value = Math.round(newVal * 100) / 100;
          } else {
            input.value = Math.round(newVal * 10000) / 10000;
          }
        }
      }
    }
  }
}

function convertResultValues(toMetric) {
  for (var resultId in resultUnitMap) {
    var el = document.getElementById(resultId);
    if (el) {
      var text = el.textContent;
      if (text && text !== '-' && text !== 'N/A') {
        var numMatch = text.match(/^[\d,.]+/);
        if (numMatch) {
          var oldVal = parseFloat(numMatch[0].replace(/,/g, ''));
          var unitKey = resultUnitMap[resultId];
          var conv = unitConversions[unitKey];
          if (conv && conv.factor && !isNaN(oldVal)) {
            var newVal = toMetric ? oldVal * conv.factor : oldVal / conv.factor;
            // Format with commas
            if (newVal >= 100) {
              el.textContent = Math.round(newVal).toLocaleString();
            } else if (newVal >= 1) {
              el.textContent = (Math.round(newVal * 100) / 100).toLocaleString();
            } else {
              el.textContent = (Math.round(newVal * 10000) / 10000).toString();
            }
          }
        }
      }
    }
  }
}

function updateAllUnitLabels(toMetric) {
  // Update labels containing unit text in parentheses
  document.querySelectorAll('label').forEach(function(label) {
    var text = label.innerHTML;
    var changed = false;

    if (toMetric) {
      // Imperial to Metric
      for (var imp in unitConversions) {
        var regex = new RegExp('\\(' + escapeRegex(imp) + '\\)', 'g');
        if (regex.test(text)) {
          text = text.replace(regex, '(' + unitConversions[imp].metric + ')');
          changed = true;
        }
      }
    } else {
      // Metric to Imperial
      for (var imp in unitConversions) {
        var regex = new RegExp('\\(' + escapeRegex(unitConversions[imp].metric) + '\\)', 'g');
        if (regex.test(text)) {
          text = text.replace(regex, '(' + imp + ')');
          changed = true;
        }
      }
    }
    if (changed) label.innerHTML = text;
  });

  // Update table unit cells (3rd column typically)
  document.querySelectorAll('td').forEach(function(cell) {
    var text = cell.textContent.trim();
    if (toMetric) {
      if (unitConversions[text]) {
        cell.textContent = unitConversions[text].metric;
      }
    } else {
      for (var imp in unitConversions) {
        if (unitConversions[imp].metric === text) {
          cell.textContent = imp;
          break;
        }
      }
    }
  });
}

function escapeRegex(string) {
  return string.replace(/[.*+?^${}()|[\]\\\/]/g, '\\$&');
}

// Helper functions for calculations to get values in consistent units (imperial)
function getImperialValue(inputId) {
  var input = document.getElementById(inputId);
  if (!input) return 0;
  var val = parseFloat(input.value) || 0;

  if (currentUnits === 'metric') {
    var unitKey = inputUnitMap[inputId];
    if (unitKey && unitConversions[unitKey]) {
      val = val / unitConversions[unitKey].factor; // Convert metric to imperial
    }
  }
  return val;
}

function setResultDisplay(resultId, imperialValue) {
  var el = document.getElementById(resultId);
  if (!el) return;

  var displayVal = imperialValue;
  if (currentUnits === 'metric') {
    var unitKey = resultUnitMap[resultId];
    if (unitKey && unitConversions[unitKey]) {
      displayVal = imperialValue * unitConversions[unitKey].factor;
    }
  }

  // Format nicely
  if (displayVal >= 100) {
    el.textContent = Math.round(displayVal).toLocaleString();
  } else if (displayVal >= 1) {
    el.textContent = (Math.round(displayVal * 100) / 100).toLocaleString();
  } else if (displayVal > 0) {
    el.textContent = (Math.round(displayVal * 10000) / 10000).toString();
  } else {
    el.textContent = '0';
  }
}

// Initialize units on load
document.addEventListener('DOMContentLoaded', function() {
  var savedUnits = localStorage.getItem('wwtp_units');
  if (savedUnits === 'metric') {
    currentUnits = 'imperial'; // Set opposite so toggle switches to metric
    toggleUnits();
  }
});

// ==================== END UNIT CONVERSION SYSTEM ====================

// ==================== QUICK REFERENCE LIBRARY v9.5.0 ====================
function openQuickRef() {
  document.getElementById('quickRefModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeQuickRef() {
  document.getElementById('quickRefModal').classList.remove('active');
  document.body.style.overflow = '';
  document.getElementById('qrefSearch').value = '';
  filterQuickRef(''); // Reset search
}

function showQrefTab(tabName) {

  // Hide all tab contents
  var allContents = document.querySelectorAll('.qref-tab-content');
  allContents.forEach(function(content) {
    content.classList.add('qref-hidden');
    content.style.display = 'none';
  });

  // Deactivate all tabs
  document.querySelectorAll('.qref-tab').forEach(function(tab) {
    tab.classList.remove('active');
  });

  // Show selected tab content
  var contentId = 'qref-' + tabName;
  var content = document.getElementById(contentId);

  if (content) {
    content.classList.remove('qref-hidden');
    content.style.display = 'block';
  } else {
    console.error('[v9.5.0] Tab content not found:', contentId);
  }

  // Activate clicked tab
  document.querySelectorAll('.qref-tab').forEach(function(tab) {
    var onclick = tab.getAttribute('onclick') || '';
    if (onclick.indexOf("'" + tabName + "'") > -1) {
      tab.classList.add('active');
    }
  });
}

function filterQuickRef(searchTerm) {
  var term = searchTerm.toLowerCase().trim();

  // If empty, show all
  if (!term) {
    document.querySelectorAll('.qref-section, .qref-trouble').forEach(function(section) {
      section.style.display = '';
    });
    return;
  }

  // Filter sections
  document.querySelectorAll('.qref-section, .qref-trouble').forEach(function(section) {
    var searchData = section.getAttribute('data-search') || '';
    var textContent = section.textContent.toLowerCase();

    if (searchData.includes(term) || textContent.includes(term)) {
      section.style.display = '';
    } else {
      section.style.display = 'none';
    }
  });

  // Show all tabs when searching
  document.querySelectorAll('.qref-tab-content').forEach(function(content) {
    content.classList.remove('qref-hidden');
  });
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    var modal = document.getElementById('quickRefModal');
    if (modal && modal.classList.contains('active')) {
      closeQuickRef();
    }
  }
});

// ==================== END QUICK REFERENCE LIBRARY ====================

// v9.5.0 Init
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.panel').forEach(function(p) {
    p.classList.remove('active');
  });
  var dash = document.getElementById('dashboard');
  if (dash) dash.classList.add('active');
});

// Initialize tabs when DOM is ready - DISABLED
// if (document.readyState === 'loading') {
//   document.addEventListener('DOMContentLoaded', initTabs);
// } else {
//   initTabs();
// }

// Theme toggle - REMOVED (using toggleThemeWithMemory instead)
// Old duplicate code removed to prevent conflicts

// Toast notifications - using main showToast function defined later

// AI Assistant Functions

function openAIAssistant(){
$$('.tab[data-panel="ai"]')[0].click();
setTimeout(()=>$('aiInput').focus(),300);
}

function sendAIMessage(){
const input=$('aiInput');
const msg=input.value.trim();
if(!msg)return;

addAIMessage(msg,'user');
input.value='';
showAIThinking(true);

setTimeout(()=>{
const response=generateAIResponse(msg);
showAIThinking(false);
addAIMessage(response,'assistant');
},1500+Math.random()*1000);
}

function addAIMessage(text,sender){
const container=$('aiMessages');
const msg=document.createElement('div');
msg.className=`ai-message ${sender}`;
msg.innerHTML=text;
container.appendChild(msg);
scrollAIToBottom();

state.aiChat.push({text,sender,time:new Date()});
}

function scrollAIToBottom(){
const container=$('aiMessages');
setTimeout(()=>{
container.scrollTop=container.scrollHeight;
},100);
}

function showAIThinking(show){
$('aiThinking').classList.toggle('active',show);
}

function generateAIResponse(msg){
const lower=msg.toLowerCase();

// Pattern matching for common questions
if(lower.includes('high svi')||lower.includes('bulking')){
return `<strong>Sludge Bulking Diagnosis</strong><br><br>High SVI indicates bulking sludge, typically caused by filamentous bacteria. Here's what to check:<br><br>
<strong>Immediate Actions:</strong><br>
1. Verify current SVI value and trend<br>
2. Check DO levels - should be >2.0 mg/L throughout basin<br>
3. Perform microscopic exam to identify filament type<br>
4. Calculate F/M ratio - target 0.3-0.5 lb/lb/d<br><br>
<strong>Solutions:</strong><br>
‚Ä¢ Increase DO to 2.5-3.0 mg/L<br>
‚Ä¢ Consider RAS chlorination (5-10 mg/L)<br>
‚Ä¢ Add selector zone if possible<br>
‚Ä¢ Reduce F/M if >0.5<br><br>
Would you like detailed step-by-step instructions?`;
}

if(lower.includes('ammonia')||lower.includes('nitrification')){
return `<strong>Ammonia/Nitrification Issues</strong><br><br>High effluent ammonia indicates nitrification problems. Key factors:<br><br>
<strong>Critical Parameters:</strong><br>
‚Ä¢ MCRT: Must be >8 days (>12 days if temp <15¬∞C)<br>
‚Ä¢ DO: Maintain >2.0 mg/L in aerobic zones<br>
‚Ä¢ Alkalinity: Need ~50 mg/L minimum as CaCO3<br>
‚Ä¢ Temperature: Below 12¬∞C severely impacts rate<br><br>
<strong>Quick Fixes:</strong><br>
1. STOP wasting sludge immediately to increase MCRT<br>
2. Increase aeration/DO setpoint<br>
3. Check for toxic industrial discharge<br>
4. Test and supplement alkalinity if needed<br><br>
Recovery typically takes 1-2 weeks. Monitor daily!`;
}

if(lower.includes('do')||lower.includes('oxygen')||lower.includes('aeration')){
return `<strong>Dissolved Oxygen Management</strong><br><br>
<strong>Target Ranges:</strong><br>
‚Ä¢ Conventional activated sludge: 1.5-3.0 mg/L<br>
‚Ä¢ Nitrification: 2.0-3.0 mg/L<br>
‚Ä¢ Extended aeration: 2.5-4.0 mg/L<br><br>
<strong>Troubleshooting Low DO:</strong><br>
1. Check blower amperage and operation<br>
2. Inspect diffusers for fouling or damage<br>
3. Verify airflow measurement<br>
4. Calculate oxygen transfer rate vs requirement<br>
5. Clean diffusers if OTE has dropped<br><br>
<strong>Energy Optimization:</strong><br>
‚Ä¢ Use DO control with VFDs<br>
‚Ä¢ Vary setpoint based on load<br>
‚Ä¢ Consider fine bubble vs coarse<br><br>
Need help calculating oxygen requirements?`;
}

if(lower.includes('energy')||lower.includes('cost')||lower.includes('power')){
return `<strong>Energy Optimization Strategies</strong><br><br>
Aeration typically represents 50-60% of total plant energy. Here's how to optimize:<br><br>
<strong>Quick Wins:</strong><br>
1. Install VFDs on blowers (15-25% savings)<br>
2. Optimize DO setpoints (reduce excess DO)<br>
3. Use time-of-day scheduling<br>
4. Improve process control<br><br>
<strong>Maintenance:</strong><br>
‚Ä¢ Clean diffusers regularly<br>
‚Ä¢ Fix air leaks<br>
‚Ä¢ Optimize equipment staging<br>
‚Ä¢ Monitor motor efficiency<br><br>
<strong>Benchmark:</strong><br>
Good performance: <1800 kWh/MG<br>
Average: 1800-2200 kWh/MG<br>
Needs improvement: >2200 kWh/MG<br><br>
Your current usage: ${$('kpi-energy')?.textContent||'1850'} kWh/MG`;
}

if(lower.includes('f/m')||lower.includes('food to microorganism')){
return `<strong>F/M Ratio Management</strong><br><br>
The Food-to-Microorganism ratio controls treatment performance:<br><br>
<strong>Typical Ranges:</strong><br>
‚Ä¢ Conventional AS: 0.2-0.5 lb BOD/lb MLVSS/d<br>
‚Ä¢ Extended aeration: 0.05-0.15<br>
‚Ä¢ High-rate: 0.5-1.5<br><br>
<strong>Effects of F/M:</strong><br>
‚Ä¢ Low F/M (<0.2): Better effluent, more stable, higher O2<br>
‚Ä¢ High F/M (>0.5): Poor settling, higher BOD, bulking risk<br><br>
<strong>Adjustment:</strong><br>
To decrease F/M: Increase MLSS or reduce load<br>
To increase F/M: Decrease MLSS (waste more) or accept more load<br><br>
Your current F/M: ${$('kpi-fm')?.textContent||'0.35'} lb/lb/d - Optimal range!`;
}

if(lower.includes('foam')||lower.includes('scum')){
return `<strong>Foam & Scum Troubleshooting</strong><br><br>
<strong>Types of Foam:</strong><br><br>
1. <strong>White billowy foam</strong> (Nocardia/Actinomycetes)<br>
   ‚Ä¢ Caused by: High MCRT, warm temps, fats/oils<br>
   ‚Ä¢ Solution: Reduce MCRT to 5-8 days, spray foam, chlorinate<br><br>
2. <strong>Brown/tan foam</strong> (Young sludge/Surfactants)<br>
   ‚Ä¢ Caused by: Low MCRT, detergents, startup<br>
   ‚Ä¢ Solution: Normal - will improve as sludge matures<br><br>
3. <strong>Thick foam</strong> (Denitrification in clarifier)<br>
   ‚Ä¢ Caused by: Rising sludge, N2 gas<br>
   ‚Ä¢ Solution: Increase RAS rate, reduce sludge blanket<br><br>
<strong>Control Methods:</strong><br>
‚Ä¢ Water spray<br>
‚Ä¢ Anti-foam chemicals<br>
‚Ä¢ Adjust MCRT<br>
‚Ä¢ Investigate industrial FOG sources`;
}

if(lower.includes('help')||lower.includes('what can you')){
return `I can assist with a wide range of wastewater treatment topics:<br><br>
<strong>üîç Diagnostics:</strong> Identify root causes of problems<br>
<strong>ü©∫ Troubleshooting:</strong> Step-by-step solutions<br>
<strong>üìä Calculations:</strong> Loading, F/M, MCRT, oxygen, etc.<br>
<strong>‚öôÔ∏è Operations:</strong> Process control and optimization<br>
<strong>üß´ Biology:</strong> Microbiology and sludge health<br>
<strong>üìã Compliance:</strong> Permit limits and reporting<br>
<strong>‚ö° Energy:</strong> Efficiency and cost reduction<br>
<strong>üîß Maintenance:</strong> Equipment and preventive care<br><br>
Try asking me:<br>
‚Ä¢ "Why is my SVI high?"<br>
‚Ä¢ "How do I improve nitrification?"<br>
‚Ä¢ "What's causing high effluent TSS?"<br>
‚Ä¢ "How can I reduce energy costs?"<br>
‚Ä¢ "Calculate my oxygen requirements"`;
}

// Default response with suggestions
return `I understand you're asking about: "${msg}"<br><br>I can provide detailed guidance on this topic. To give you the most accurate help, could you provide more details such as:<br><br>
‚Ä¢ Current operating parameters (MLSS, DO, F/M, etc.)<br>
‚Ä¢ Specific symptoms or measurements<br>
‚Ä¢ Recent changes in operations<br>
‚Ä¢ Lab results or trends<br><br>
Or try asking a more specific question like:<br>
‚Ä¢ "Why is my [parameter] high/low?"<br>
‚Ä¢ "How do I troubleshoot [issue]?"<br>
‚Ä¢ "What causes [problem]?"<br>
‚Ä¢ "Calculate [parameter]"<br><br>
You can also use the <strong>Full System Diagnostic</strong> button above for a comprehensive analysis!`;
}

function showQuickQuestions(){
addAIMessage(`<strong>Quick Questions - Click to Ask:</strong><br><br>
<div style="display:grid;gap:8px;margin-top:12px">
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('Why is my SVI high?')">‚ùì Why is my SVI high?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('How do I improve nitrification?')">‚ùì How do I improve nitrification?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('What causes high effluent TSS?')">‚ùì What causes high effluent TSS?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('How can I reduce energy costs?')">‚ùì How can I reduce energy costs?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('What is the optimal F/M ratio?')">‚ùì What is the optimal F/M ratio?</button>
<button class="btn" style="text-align:left;padding:12px" onclick="askQuick('How do I fix poor settling?')">‚ùì How do I fix poor settling?</button>
</div>`,'assistant');
}

function askQuick(question){
$('aiInput').value=question;
sendAIMessage();
}

function clearAIChat(){
if(confirm('Clear all chat history?')){
$('aiMessages').innerHTML=`<div class="ai-message assistant">
Chat cleared! How can I assist you today?
</div>`;
state.aiChat=[];
showToast('Chat history cleared','success');
}
}

function runSystemDiagnostic(){
showToast('Running comprehensive system diagnostic...','info');
showAIThinking(true);

setTimeout(()=>{
showAIThinking(false);
$('diagnosticResults').style.display='block';
$('diagnosticContent').innerHTML=generateDiagnosticReport();
showToast('Diagnostic complete - see results below','success');

// Scroll to results
setTimeout(()=>{
$('diagnosticResults').scrollIntoView({behavior:'smooth',block:'start'});
},300);
},2500);
}

function generateDiagnosticReport(){
// Get current data
const flow=parseFloat($('kpi-flow')?.textContent||3.5);
const doVal=parseFloat($('kpi-do')?.textContent||2.1);
const mlss=parseInt($('kpi-mlss')?.textContent||2500);
const fm=parseFloat($('kpi-fm')?.textContent||0.35);
const energy=parseInt($('kpi-energy')?.textContent||1850);

let issues=[];
let recommendations=[];

// Analyze parameters
if(doVal<1.5){
issues.push({severity:'high',title:'Low Dissolved Oxygen',desc:`Current DO (${doVal} mg/L) is below minimum requirement of 1.5 mg/L. This will impact BOD removal and nitrification.`,action:'Increase aeration immediately'});
}else if(doVal>3.5){
issues.push({severity:'medium',title:'Excessive Dissolved Oxygen',desc:`DO (${doVal} mg/L) is higher than necessary. This wastes energy.`,action:'Reduce aeration to save energy'});
}

if(fm<0.2){
issues.push({severity:'low',title:'Low F/M Ratio',desc:`F/M ratio (${fm}) indicates underloading. While effluent quality is likely excellent, energy efficiency may be poor.`,action:'Consider reducing aeration volume or accepting more load'});
}else if(fm>0.5){
issues.push({severity:'medium',title:'High F/M Ratio',desc:`F/M ratio (${fm}) is elevated. Risk of poor settling and effluent quality issues.`,action:'Increase MLSS or reduce organic loading'});
}

if(mlss<1800){
issues.push({severity:'medium',title:'Low MLSS',desc:`MLSS (${mlss} mg/L) is below typical operating range. Risk of washout and poor effluent quality.`,action:'Reduce WAS rate to build inventory'});
}else if(mlss>4000){
issues.push({severity:'medium',title:'High MLSS',desc:`MLSS (${mlss} mg/L) is elevated. Increased oxygen demand and settling issues possible.`,action:'Increase WAS rate or check clarifier performance'});
}

if(energy>2000){
issues.push({severity:'medium',title:'High Energy Consumption',desc:`Energy intensity (${energy} kWh/MG) exceeds industry benchmark of 2000 kWh/MG.`,action:'Review aeration efficiency and equipment staging'});
}

// Generate recommendations
if(doVal>=1.5&&doVal<=3.0&&fm>=0.2&&fm<=0.5&&mlss>=2000&&mlss<=3500){
recommendations.push('‚úì Process is operating within optimal parameters');
recommendations.push('‚Ä¢ Consider fine-tuning DO setpoint for energy savings');
recommendations.push('‚Ä¢ Implement automated DO control if not already in place');
}

if(issues.length===0){
recommendations.push('‚úì No critical issues detected');
recommendations.push('‚Ä¢ Continue current monitoring protocols');
recommendations.push('‚Ä¢ Schedule routine maintenance as planned');
}

let html=`
<div class="kpi-grid">
<div class="kpi-card">
<h4>Issues Found</h4>
<p style="color:${issues.length===0?'var(--ok)':issues.some(i=>i.severity==='high')?'var(--bad)':'var(--warn)'}">${issues.length}</p>
</div>
<div class="kpi-card">
<h4>System Health</h4>
<p style="color:${issues.length===0?'var(--ok)':issues.length<=2?'var(--warn)':'var(--bad)'}">
${issues.length===0?'Excellent':issues.length<=2?'Good':'Needs Attention'}
</p>
</div>
<div class="kpi-card">
<h4>Confidence</h4>
<p style="color:var(--info)">92%</p>
<div class="small">Based on current data</div>
</div>
</div>

<h4 style="margin:24px 0 16px 0">Diagnostic Results:</h4>
`;

if(issues.length>0){
issues.forEach(issue=>{
html+=`
<div class="diagnostic-card">
<span class="severity ${issue.severity}">${issue.severity.toUpperCase()} PRIORITY</span>
<h3>${issue.title}</h3>
<p style="color:var(--text-unit);margin:12px 0">${issue.desc}</p>
<div class="solution-step">
<h5>Recommended Action:</h5>
<p>${issue.action}</p>
</div>
</div>
`;
});
}else{
html+=`
<div class="note success">
<strong>‚úì System Operating Normally</strong><br>
No critical issues detected. All parameters are within acceptable ranges. Continue standard monitoring and maintenance procedures.
</div>
`;
}

if(recommendations.length>0){
html+=`
<h4 style="margin:24px 0 16px 0">Recommendations:</h4>
<div class="note info">
${recommendations.map(r=>`${r}<br>`).join('')}
</div>
`;
}

html+=`
<div style="margin-top:24px">
<strong>Diagnostic Report Generated:</strong> ${new Date().toLocaleString()}<br>
<strong>Data Quality:</strong> Good<br>
<strong>Analysis Method:</strong> AI-Powered Multi-Parameter Assessment
</div>
`;

return html;
}

function showSymptomChecker(){
$('symptomCheckerSection').style.display='block';
$('knowledgeBaseSection').style.display='none';
$('issueHistorySection').style.display='none';

const container=$('symptomChecker');
container.innerHTML=symptoms.map(s=>`
<div class="symptom-option">
<input type="checkbox" id="sym_${s.id}" value="${s.id}"/>
<label for="sym_${s.id}" style="cursor:pointer;flex:1">${s.text}</label>
</div>
`).join('');

setTimeout(()=>{
$('symptomCheckerSection').scrollIntoView({behavior:'smooth',block:'start'});
},100);
}

function analyzeSymptoms(){
const checked=[];
symptoms.forEach(s=>{
if($(`sym_${s.id}`)?.checked){
checked.push(s);
}
});

if(checked.length===0){
showToast('Please select at least one symptom','warning');
return;
}

showAIThinking(true);
setTimeout(()=>{
showAIThinking(false);
const analysis=performSymptomAnalysis(checked);
addAIMessage(analysis,'assistant');
$$('.tab[data-panel="ai"]')[0].click();
},1500);
}

function performSymptomAnalysis(symptoms){
let issueCount={};
symptoms.forEach(s=>{
s.issues.forEach(i=>{
issueCount[i]=(issueCount[i]||0)+1;
});
});

const sorted=Object.entries(issueCount).sort((a,b)=>b[1]-a[1]);
const topIssue=sorted[0][0];

let response=`<strong>ü©∫ Symptom Analysis Results</strong><br><br>`;
response+=`You selected ${symptoms.length} symptom${symptoms.length>1?'s':''}:<br>`;
symptoms.forEach(s=>{
response+=`‚Ä¢ ${s.text}<br>`;
});

response+=`<br><strong>Most Likely Cause:</strong><br><br>`;

// Map issue codes to full diagnoses
const issueMap={
bulking:'<strong>Sludge Bulking</strong><br>Filamentous bacteria causing poor settling',
underloading:'<strong>Underloading</strong><br>F/M ratio too low, insufficient organic load',
overloading:'<strong>Overloading</strong><br>Organic or hydraulic load exceeds capacity',
toxicity:'<strong>Toxic Shock</strong><br>Industrial discharge or toxic compounds',
low_do:'<strong>Low Dissolved Oxygen</strong><br>Insufficient aeration or blower issues',
low_mcrt:'<strong>MCRT Too Short</strong><br>Insufficient sludge age for nitrification',
low_temp:'<strong>Low Temperature</strong><br>Reduced biological activity',
pinfloc:'<strong>Pin Floc</strong><br>Old sludge or dispersed floc particles',
old_sludge:'<strong>Old Sludge</strong><br>Extended MCRT causing floc degradation',
clarifier_overload:'<strong>Clarifier Overload</strong><br>Hydraulic or solids overload',
nocardia:'<strong>Nocardia Foam</strong><br>Actinomycetes causing white billowy foam',
septicity:'<strong>Septic Conditions</strong><br>Anaerobic conditions producing H2S',
denitrification:'<strong>Denitrification</strong><br>Nitrogen gas causing rising sludge'
};

response+=issueMap[topIssue]||'Unknown issue';
response+=`<br><br><strong>Recommended Actions:</strong><br>`;

// Get detailed solution for top issue
if(issueDatabase[topIssue]){
const issue=issueDatabase[topIssue];
issue.solutions.slice(0,5).forEach(sol=>{
response+=`${sol.step}. ${sol.action}<br>`;
});
response+=`<br><em>For complete troubleshooting guide, ask me: "How do I fix ${topIssue}?"</em>`;
}else{
response+=`For detailed guidance, please describe your symptoms in the chat.`;
}

return response;
}

function resetSymptomChecker(){
symptoms.forEach(s=>{
const cb=$(`sym_${s.id}`);
if(cb)cb.checked=false;
});
showToast('Symptom checker reset','info');
}

function showKnowledgeBase(){
$('symptomCheckerSection').style.display='none';
$('knowledgeBaseSection').style.display='block';
$('issueHistorySection').style.display='none';

populateKnowledgeBase();

setTimeout(()=>{
$('knowledgeBaseSection').scrollIntoView({behavior:'smooth',block:'start'});
},100);
}

function populateKnowledgeBase(filter=''){
const container=$('knowledgeBaseContent');
const filtered=filter?knowledgeBase.filter(kb=>
kb.title.toLowerCase().includes(filter.toLowerCase())||
kb.keywords.toLowerCase().includes(filter.toLowerCase())||
kb.content.toLowerCase().includes(filter.toLowerCase())
):knowledgeBase;

container.innerHTML=filtered.map(kb=>`
<div class="knowledge-item" onclick="showKBArticle(${kb.id})">
<h4>${kb.title}</h4>
<p>${kb.content.substring(0,150)}...</p>
<div style="margin-top:8px">
<span class="tag info">${kb.category}</span>
</div>
</div>
`).join('');

if(filtered.length===0){
container.innerHTML=`
<div class="empty-state">
<div class="empty-state-icon">üîç</div>
<div class="empty-state-title">No Articles Found</div>
<div class="empty-state-message">Try different search terms</div>
</div>
`;
}
}

function searchKnowledgeBase(){
const query=$('kbSearch').value;
populateKnowledgeBase(query);
}

function showKBArticle(id){
const article=knowledgeBase.find(kb=>kb.id===id);
if(!article)return;

$$('.tab[data-panel="ai"]')[0].click();
addAIMessage(`<strong>üìö Knowledge Base: ${article.title}</strong><br><br>
<strong>Category:</strong> ${article.category}<br><br>
${article.content}<br><br>
<em>Need more specific guidance? Describe your situation and I can provide tailored advice.</em>`,'assistant');
}

function showIssueHistory(){
$('symptomCheckerSection').style.display='none';
$('knowledgeBaseSection').style.display='none';
$('issueHistorySection').style.display='block';

populateIssueHistory();

setTimeout(()=>{
$('issueHistorySection').scrollIntoView({behavior:'smooth',block:'start'});
},100);
}

function populateIssueHistory(){
const container=$('issueHistoryContent');

// Sample issue history (in real app, this would come from database)
const sampleIssues=[
{date:'2025-11-01',title:'High SVI (165 mL/g)',desc:'Filamentous bulking. Increased DO to 2.8 mg/L and added chlorine to RAS. SVI reduced to 128 mL/g within 5 days.',resolved:true},
{date:'2025-10-28',title:'Ammonia Breakthrough',desc:'Effluent NH3 spiked to 3.2 mg/L. Stopped WAS and increased MCRT. Industrial pretreatment violation identified as cause.',resolved:true},
{date:'2025-10-15',title:'Blower #2 Failure',desc:'Blower tripped on high vibration. Bearing replacement required. Operating on backup blower.',resolved:true},
{date:'2025-11-04',title:'High Effluent TSS',desc:'TSS at 38 mg/L. Investigating clarifier performance. Sludge blanket at 60% depth. Increased RAS rate.',resolved:false},
{date:'2025-11-05',title:'Low DO in Basin 2',desc:'DO dropped to 1.2 mg/L. Diffuser inspection scheduled. Currently using backup aeration zones.',resolved:false}
];

const combined=[...sampleIssues,...(state.issues||[])];

if(combined.length===0){
container.innerHTML=`
<div class="empty-state">
<div class="empty-state-icon">üìã</div>
<div class="empty-state-title">No Issues Logged</div>
<div class="empty-state-message">Start tracking issues to build your operational history</div>
</div>
`;
return;
}

container.innerHTML=combined.map(issue=>`
<div class="issue-history-item ${issue.resolved?'resolved':''}">
<div class="issue-date">üìÖ ${issue.date} ${issue.resolved?'<span class="tag success">RESOLVED</span>':'<span class="tag warning">ACTIVE</span>'}</div>
<div class="issue-title">${issue.title}</div>
<div class="issue-desc">${issue.desc}</div>
</div>
`).join('');
}

function addNewIssue(){
const title=prompt('Issue Title:');
if(!title)return;
const desc=prompt('Description:');
if(!desc)return;

const issue={
date:new Date().toISOString().split('T')[0],
title:title,
desc:desc,
resolved:false
};

state.issues=state.issues||[];
state.issues.unshift(issue);

showToast('Issue logged successfully','success');
populateIssueHistory();
}

function exportDiagnostic(){
showToast('Exporting diagnostic report...','info');
setTimeout(()=>{
showToast('‚úì Diagnostic report exported','success');
},1000);
}

// Loading calculations (abbreviated)
function calcLoading(){
const flow=Number($('flow').value);
const bod=Number($('bod').value);
const tss=Number($('tss').value);
const tkn=Number($('tkn').value);
const tp=Number($('tp').value);
const cod=Number($('cod').value);
const mgd2lbd=8.34;

const bodLoad=flow*bod*mgd2lbd;
const tssLoad=flow*tss*mgd2lbd;
const tknLoad=flow*tkn*mgd2lbd;
const tpLoad=flow*tp*mgd2lbd;
const codLoad=flow*cod*mgd2lbd;

$('r_bodLoad').textContent=fmt.n(bodLoad,0);
$('r_tssLoad').textContent=fmt.n(tssLoad,0);
$('r_tknLoad').textContent=fmt.n(tknLoad,0);
$('r_tpLoad').textContent=fmt.n(tpLoad,0);
$('r_codLoad').textContent=fmt.n(codLoad,0);

$('avg_bodLoad').textContent=fmt.n(bodLoad*0.95,0);
$('avg_tssLoad').textContent=fmt.n(tssLoad*0.98,0);
$('avg_tknLoad').textContent=fmt.n(tknLoad*1.02,0);
$('avg_tpLoad').textContent=fmt.n(tpLoad*0.97,0);
$('avg_codLoad').textContent=fmt.n(codLoad*0.96,0);

$('trend_bodLoad').textContent='‚Üë 5%';
$('trend_tssLoad').textContent='‚Üí Stable';
$('trend_tknLoad').textContent='‚Üì 2%';
$('trend_tpLoad').textContent='‚Üí Stable';
$('trend_codLoad').textContent='‚Üë 4%';

$('s_bodLoad').textContent=bodLoad<8000?'‚úì Normal':'‚ö† High';
$('s_bodLoad').className=bodLoad<8000?'status ok':'status warn';
$('s_tssLoad').textContent=tssLoad<9000?'‚úì Normal':'‚ö† High';
$('s_tssLoad').className=tssLoad<9000?'status ok':'status warn';
$('s_tknLoad').textContent='‚úì Normal';
$('s_tknLoad').className='status ok';
$('s_tpLoad').textContent='‚úì Normal';
$('s_tpLoad').className='status ok';
$('s_codLoad').textContent='‚úì Normal';
$('s_codLoad').className='status ok';

const mlvss=2000;
const aerVol=1.2;
const olr=bodLoad/(mlvss*aerVol*8.34);
$('stat_olr').textContent=fmt.f(olr,2);
$('stat_volLoad').textContent=fmt.f(bodLoad/(aerVol*7.48*1000),1);
$('stat_ratio').textContent=`100:${Math.round(tkn/bod*100)}:${Math.round(tp/bod*100)}`;

state.data={bodLoad,tssLoad,tknLoad,tpLoad,codLoad,flow,bod};
if($('kpi-flow'))$('kpi-flow').textContent=flow.toFixed(2);

showToast('Loading calculated successfully','success');
return state.data;
}

function resetLoading(){
$('flow').value='3.5';
$('bod').value='200';
$('tss').value='220';
$('tkn').value='40';
$('tp').value='8';
$('cod').value='450';
$('r_bodLoad').textContent='-';
$('r_tssLoad').textContent='-';
$('r_tknLoad').textContent='-';
$('r_tpLoad').textContent='-';
$('r_codLoad').textContent='-';
if($('s_bodLoad')){$('s_bodLoad').textContent='-';$('s_bodLoad').className='status';}
if($('s_tssLoad')){$('s_tssLoad').textContent='-';$('s_tssLoad').className='status';}
if($('s_tknLoad')){$('s_tknLoad').textContent='-';$('s_tknLoad').className='status';}
if($('s_tpLoad')){$('s_tpLoad').textContent='-';$('s_tpLoad').className='status';}
if($('s_codLoad')){$('s_codLoad').textContent='-';$('s_codLoad').className='status';}
showToast('Loading reset','info');
}

function compareHistorical(){
showToast('Comparing with 30-day historical average...','info');
setTimeout(()=>{
showToast('Current BOD load 5.2% above 30-day average','warning');
},1500);
}

function calcAll(){
calcLoading();
showToast('‚ú® All calculations complete!','success');
}

// Sludge calculations
function calcSludge(){
const base=state.data.bodLoad?state.data:calcLoading();
const flow=Number($('flow').value);
const mlss=Number($('mlss').value);
const mlvss=Number($('mlvss').value);
const aerVol=Number($('aerVol').value);
const rasFlow=Number($('rasFlow').value);
const wasFlow=Number($('wasFlow').value);
const wasTss=Number($('wasTss').value);

const fm=base.bodLoad/(mlvss*aerVol*8.34);
const mlssInv=mlss*aerVol*8.34;
const wasSolids=wasFlow*wasTss*8.34;
const mcrt=mlssInv/wasSolids;
const rasRate=(rasFlow/flow)*100;
const svi=120;

// Update results
$('r_fm_dash').textContent=fmt.f(fm,2);
$('r_mcrt_dash').textContent=fmt.f(mcrt,1);
$('r_svi_dash').textContent=fmt.f(svi,0);
if($('r_mlss_inv'))$('r_mlss_inv').textContent=fmt.f(mlssInv,0);
if($('r_was_solids'))$('r_was_solids').textContent=fmt.f(wasSolids,0);
if($('r_ras_rate'))$('r_ras_rate').textContent=fmt.f(rasRate,1);

// Update status indicators
$('s_fm').textContent=fm>=0.2&&fm<=0.5?'‚úì Optimal':'‚ö† Adjust';
$('s_fm').className=fm>=0.2&&fm<=0.5?'status ok':'status warn';
$('s_mcrt').textContent=mcrt>=6&&mcrt<=10?'‚úì Good':'‚ö† Review';
$('s_mcrt').className=mcrt>=6&&mcrt<=10?'status ok':'status warn';
$('s_svi').textContent=svi<150?'‚úì Good':'‚ö† High';
$('s_svi').className=svi<150?'status ok':'status warn';
if($('s_mlss_inv'))$('s_mlss_inv').textContent='‚úì Calculated';
if($('s_mlss_inv'))$('s_mlss_inv').className='status ok';
if($('s_was_solids'))$('s_was_solids').textContent=wasSolids>0?'‚úì Good':'‚ö† Check';
if($('s_was_solids'))$('s_was_solids').className=wasSolids>0?'status ok':'status warn';
if($('s_ras_rate'))$('s_ras_rate').textContent=rasRate>=25&&rasRate<=75?'‚úì Normal':'‚ö† Review';
if($('s_ras_rate'))$('s_ras_rate').className=rasRate>=25&&rasRate<=75?'status ok':'status warn';

if($('kpi-mlss'))$('kpi-mlss').textContent=mlss;
if($('kpi-fm'))$('kpi-fm').textContent=fmt.f(fm,2);

showToast('Sludge parameters calculated','success');
}

function resetSludge(){
$('mlss').value='2500';
$('mlvss').value='2000';
$('aerVol').value='1.2';
$('rasFlow').value='1.5';
$('wasFlow').value='0.05';
$('wasTss').value='8000';
$('r_fm').textContent='-';
$('r_mcrt').textContent='-';
$('r_svi').textContent='-';
if($('s_fm')){$('s_fm').textContent='-';$('s_fm').className='status';}
if($('s_mcrt')){$('s_mcrt').textContent='-';$('s_mcrt').className='status';}
if($('s_svi')){$('s_svi').textContent='-';$('s_svi').className='status';}
showToast('Sludge reset','info');
}

// Oxygen calculations
function calcOxygen(){
const base=state.data.bodLoad?state.data:calcLoading();
const peakFactor=Number($('peakFactor').value)||1.5;

const o2req=base.bodLoad*1.5;
const o2peak=o2req/24*peakFactor;
const airflow=o2peak*60/0.5;

$('r_o2req').textContent=fmt.n(o2req,0);
$('r_o2peak').textContent=fmt.n(o2peak,0);
$('r_airflow').textContent=fmt.n(airflow,0);

showToast('Oxygen requirements calculated','success');
}

function resetOxygen(){
$('doNow').value='2.0';
$('doTarget').value='2.5';
$('peakFactor').value='1.5';
$('r_o2req').textContent='-';
$('r_o2peak').textContent='-';
$('r_airflow').textContent='-';
showToast('Oxygen reset','info');
}

// Energy calculations
function calcEnergy(){
const base=state.data.flow?state.data:{flow:3.5};
const blowerHp=Number($('blowerHp').value);
const pumpHp=Number($('pumpHp').value);
const otherHp=Number($('otherHp').value);
const elecRate=Number($('elecRate').value);

const totPower=blowerHp+pumpHp+otherHp;
const dailyEnergy=totPower*0.746*24;
const monthCost=dailyEnergy*30*elecRate;
const kwhMg=dailyEnergy/base.flow;

$('r_dailyEnergy').textContent=fmt.n(dailyEnergy,0);
$('r_monthCost').textContent='$'+fmt.n(monthCost,0);
$('r_kwhMg').textContent=fmt.n(kwhMg,0);

if($('kpi-energy'))$('kpi-energy').textContent=fmt.n(kwhMg,0);

showToast('Energy analysis complete','success');
}

function resetEnergy(){
$('blowerHp').value='200';
$('pumpHp').value='100';
$('otherHp').value='50';
$('elecRate').value='0.12';
$('r_dailyEnergy').textContent='-';
$('r_monthCost').textContent='-';
$('r_kwhMg').textContent='-';
showToast('Energy reset','info');
}

function calcCosts(){
showToast('Cost analysis calculated','success');
}

function generateReport(type){
showToast(`Generating ${type} report...`,'info');
setTimeout(()=>showToast(`‚úì ${type.toUpperCase()} report generated`,'success'),1500);
}

function saveProfile(){
showToast('‚úì Profile saved successfully','success');
}

function loadProfile(){
showToast('Profile load functionality - use file selector','info');
}

function exportFullReport(){
showToast('‚úì Full report exported successfully','success');
}

function refreshDashboard(){
showToast('‚úì Dashboard refreshed','success');
}

function runOptimization(){
showToast('Running optimization analysis...','info');
setTimeout(()=>showToast('Optimization complete','success'),2000);
}

function predictTrends(){
showToast('üîÆ Predicting performance trends...','info');
}

// Sludge Age (SRT) Calculator
function calcSRT(){
  const mlss = parseFloat($('srt_mlss').value);
  const volume = parseFloat($('srt_volume').value);
  const effTSS = parseFloat($('srt_eff_tss').value);
  const effFlow = parseFloat($('srt_eff_flow').value);
  const wasteFlow = parseFloat($('srt_waste_flow').value);
  const wasteTSS = parseFloat($('srt_waste_tss').value);
  if(!mlss || !volume || !effTSS || !effFlow || !wasteFlow || !wasteTSS){
    $('srt_result').textContent='-';
    return;
  }
  const numerator = mlss * volume;
  const denominator = effFlow * effTSS + wasteFlow * wasteTSS;
  const srt = denominator === 0 ? 0 : numerator / denominator;
  $('srt_result').textContent = fmt.f(srt,2);
}

function resetSRT(){
  $('srt_mlss').value = 2500;
  $('srt_volume').value = 1.2;
  $('srt_eff_tss').value = 15;
  $('srt_eff_flow').value = 3.5;
  $('srt_waste_flow').value = 0.1;
  $('srt_waste_tss').value = 8000;
  $('srt_result').textContent = '-';
}

// BOD Removal Efficiency Calculator
function calcBODEff(){
  const influent = parseFloat($('bod_eff_in').value);
  const effluent = parseFloat($('bod_eff_out').value);
  if(!influent || influent === 0){
    $('bod_eff_result').textContent = '-';
    return;
  }
  const removal = ((influent - effluent) / influent) * 100;
  $('bod_eff_result').textContent = fmt.f(removal,1);
}

function resetBODEff(){
  $('bod_eff_in').value = 200;
  $('bod_eff_out').value = 10;
  $('bod_eff_result').textContent = '-';
}

// Sludge Volume Index (SVI) Calculator
// ==================== MISSING ORIGINAL CALCULATOR FUNCTIONS ====================

// Clarifier Calculator
// ==================== CLARIFIER CALCULATOR ====================
function calcClarifier() {
  // Get inputs - auto-fill from loading tab if empty
  let flow = Number($('clar_flow').value);
  let mlss = Number($('clar_mlss').value);

  // Auto-fill from state if available
  if (!flow && state.data && state.data.flow) {
    flow = state.data.flow;
    $('clar_flow').value = flow;
  }
  if (!mlss) {
    mlss = 2500; // Default MLSS
    $('clar_mlss').value = mlss;
  }

  const diam = Number($('clar_diam').value) || 65;
  const rasFlow = Number($('clar_ras_flow').value) || 1.0;
  const weirLength = Number($('clar_weir').value) || 204;

  // Calculations
  const area = Math.PI * Math.pow(diam/2, 2); // ft¬≤
  const sor = (flow * 1000000) / area; // gpd/ft¬≤

  // SLR = (Q + Qr) √ó MLSS √ó 8.34 / Area / 24 hr
  const totalFlow = flow + rasFlow; // MGD
  const slr = (totalFlow * mlss * 8.34) / area / 24; // lb/hr/ft¬≤

  // WOR = Flow / Weir Length
  const wor = (flow * 1000000) / weirLength; // gpd/ft

  // Display results
  $('r_sor').textContent = fmt.n(sor, 0);
  $('r_slr').textContent = fmt.f(slr, 1);
  $('r_wor').textContent = fmt.n(wor, 0);

  // Status indicators
  if (sor >= 400 && sor <= 800) {
    $('s_sor').textContent = '‚úì Normal';
    $('s_sor').className = 'status ok';
  } else if (sor < 400) {
    $('s_sor').textContent = '‚ö† Low';
    $('s_sor').className = 'status warn';
  } else {
    $('s_sor').textContent = '‚úó High';
    $('s_sor').className = 'status bad';
  }

  if (slr < 50) {
    $('s_slr').textContent = '‚úì Normal';
    $('s_slr').className = 'status ok';
  } else {
    $('s_slr').textContent = '‚úó Overloaded';
    $('s_slr').className = 'status bad';
  }

  if (wor < 15000) {
    $('s_wor').textContent = '‚úì Normal';
    $('s_wor').className = 'status ok';
  } else if (wor < 20000) {
    $('s_wor').textContent = '‚ö† High';
    $('s_wor').className = 'status warn';
  } else {
    $('s_wor').textContent = '‚úó Overloaded';
    $('s_wor').className = 'status bad';
  }

  showToast('Clarifier calculation complete', 'success');
}

function resetClarifier() {
  $('clar_flow').value = '';
  $('clar_diam').value = '65';
  $('clar_mlss').value = '';
  $('clar_ras_flow').value = '1.0';
  $('clar_weir').value = '204';

  // Clear results
  $('r_sor').textContent = '-';
  $('r_wor').textContent = '-';

  // Clear status
  if ($('s_sor')) { $('s_sor').textContent = '-'; $('s_sor').className = 'status'; }
  if ($('s_wor')) { $('s_wor').textContent = '-'; $('s_wor').className = 'status'; }

  showToast('Clarifier reset', 'info');
}

// ==================== NUTRIENTS CALCULATOR ====================
function calcNutrients() {
  // Get flow from loading tab if available
  let flow = state.data && state.data.flow ? state.data.flow : 3.5;

  const nh3In = Number($('nh3In').value) || 30;
  const nh3Out = Number($('nh3Out').value) || 1;

  // Calculate NH3-N removed (lb/d)
  const nh3Removed = (nh3In - nh3Out) * flow * 8.34;

  // Calculate % removal
  const pctRemoval = ((nh3In - nh3Out) / nh3In) * 100;

  // Display results
  $('r_nitrif').textContent = fmt.n(nh3Removed, 0);
  $('r_nitrifPct').textContent = fmt.f(pctRemoval, 1) + '%';

  showToast('Nutrients calculation complete', 'success');
}

// ==================== DISINFECTION CALCULATOR ====================
function calcDisinfection() {
  // Get flow - auto-fill from loading tab
  let flow = Number($('dis_flow').value);
  if (!flow && state.data && state.data.flow) {
    flow = state.data.flow;
    $('dis_flow').value = flow;
  }

  const vol = Number($('dis_vol').value) || 70000; // gallons
  const dose = Number($('dis_dose').value) || 8.0; // mg/L
  const residual = Number($('dis_residual').value) || 1.5; // mg/L

  // Detention Time = Volume / Flow (minutes)
  const detentionTime = vol / (flow * 1000000 / 1440); // minutes

  // Chlorine Demand = Dose - Residual
  const cl2Demand = dose - residual;

  // CT Value = Residual √ó Detention Time
  const ctValue = residual * detentionTime;

  // Display results
  $('r_detention_time').textContent = fmt.f(detentionTime, 1);
  $('r_cl2_demand').textContent = fmt.f(cl2Demand, 1);
  $('r_ct_value').textContent = fmt.f(ctValue, 1);

  // Status indicators
  if (detentionTime >= 30) {
    $('s_detention_time').textContent = '‚úì Adequate';
    $('s_detention_time').className = 'status ok';
  } else if (detentionTime >= 20) {
    $('s_detention_time').textContent = '‚ö† Low';
    $('s_detention_time').className = 'status warn';
  } else {
    $('s_detention_time').textContent = '‚úó Inadequate';
    $('s_detention_time').className = 'status bad';
  }

  if (ctValue >= 40) {
    $('s_ct_value').textContent = '‚úì Adequate';
    $('s_ct_value').className = 'status ok';
  } else if (ctValue >= 30) {
    $('s_ct_value').textContent = '‚ö† Low';
    $('s_ct_value').className = 'status warn';
  } else {
    $('s_ct_value').textContent = '‚úó Inadequate';
    $('s_ct_value').className = 'status bad';
  }

  showToast('Disinfection calculation complete', 'success');
}

function resetDisinfection() {
  $('dis_flow').value = '';
  $('dis_vol').value = '70000';
  $('dis_dose').value = '8.0';
  $('dis_residual').value = '1.5';

  $('r_detention_time').textContent = '-';
  $('r_cl2_demand').textContent = '-';
  $('r_ct_value').textContent = '-';
  if($('s_detention_time')){$('s_detention_time').textContent='-';$('s_detention_time').className='status';}
  if($('s_ct_value')){$('s_ct_value').textContent='-';$('s_ct_value').className='status';}

  showToast('Disinfection reset', 'info');
}

// ==================== DOSING CALCULATOR ====================
function calcDosing() {
  // Get flow - auto-fill from loading tab
  let flow = Number($('dosing_flow').value);
  if (!flow && state.data && state.data.flow) {
    flow = state.data.flow;
    $('dosing_flow').value = flow;
  }
  if (!flow) flow = 3.5; // Default

  // FERRIC CHLORIDE CALCULATIONS
  const feDose = Number($('fe_dose').value) || 40;
  const fePct = Number($('fe_pct').value) || 38;
  const feSG = Number($('fe_sg').value) || 1.4;
  const fePumpMax = Number($('fe_pump_max').value) || 20;
  const feStock = Number($('fe_stock_gal').value) || 5000;

  // Solution weight (lb/gal) = % √ó SG √ó 8.34
  const feSolWgt = (fePct / 100) * feSG * 8.34;

  // Chemical feed (lb/day) = Flow √ó Dose √ó 8.34
  const feChemFeed = flow * feDose * 8.34;

  // Solution feed (gal/day) = Chemical feed / Solution weight
  const feGPD = feChemFeed / feSolWgt;
  const feGPH = feGPD / 24;
  const feMLMin = feGPH * 3785.41 / 60; // Convert gph to mL/min

  // Pump setting % = (Required gph / Max gph) √ó 100
  const fePumpPct = (feGPH / fePumpMax) * 100;

  // Inventory
  const feUsageGPD = feGPD;
  const feDaysLeft = feStock / feUsageGPD;

  // Display Ferric results
  $('r_fe_sol_wgt').textContent = fmt.f(feSolWgt, 2);
  $('r_fe_chem_feed').textContent = fmt.n(feChemFeed, 0);
  $('r_fe_gpd').textContent = fmt.n(feGPD, 0);
  $('r_fe_gph').textContent = fmt.f(feGPH, 1);
  $('r_fe_ml_min').textContent = fmt.n(feMLMin, 0);
  $('r_fe_pump_pct').textContent = fmt.f(fePumpPct, 1);
  $('r_fe_usage_gpd').textContent = fmt.n(feUsageGPD, 0);
  $('r_fe_days_left').textContent = fmt.f(feDaysLeft, 1);

  if (feDaysLeft > 14) {
    $('s_fe_status').textContent = '‚úì Good';
    $('s_fe_status').className = 'status ok';
  } else if (feDaysLeft > 7) {
    $('s_fe_status').textContent = '‚ö† Low';
    $('s_fe_status').className = 'status warn';
  } else {
    $('s_fe_status').textContent = '‚úó Critical';
    $('s_fe_status').className = 'status bad';
  }

  // ALUMINUM SULFATE CALCULATIONS
  const alDose = Number($('al_dose').value) || 100;
  const alPct = Number($('al_pct').value) || 48.5;
  const alSG = Number($('al_sg').value) || 1.33;
  const alPumpMax = Number($('al_pump_max').value) || 40;
  const alStock = Number($('al_stock_gal').value) || 8000;

  const alSolWgt = (alPct / 100) * alSG * 8.34;
  const alChemFeed = flow * alDose * 8.34;
  const alGPD = alChemFeed / alSolWgt;
  const alGPH = alGPD / 24;
  const alMLMin = alGPH * 3785.41 / 60;
  const alPumpPct = (alGPH / alPumpMax) * 100;
  const alUsageGPD = alGPD;
  const alDaysLeft = alStock / alUsageGPD;

  // Display Alum results
  $('r_al_sol_wgt').textContent = fmt.f(alSolWgt, 2);
  $('r_al_chem_feed').textContent = fmt.n(alChemFeed, 0);
  $('r_al_gpd').textContent = fmt.n(alGPD, 0);
  $('r_al_gph').textContent = fmt.f(alGPH, 1);
  $('r_al_ml_min').textContent = fmt.n(alMLMin, 0);
  $('r_al_pump_pct').textContent = fmt.f(alPumpPct, 1);
  $('r_al_usage_gpd').textContent = fmt.n(alUsageGPD, 0);
  $('r_al_days_left').textContent = fmt.f(alDaysLeft, 1);

  if (alDaysLeft > 14) {
    $('s_al_status').textContent = '‚úì Good';
    $('s_al_status').className = 'status ok';
  } else if (alDaysLeft > 7) {
    $('s_al_status').textContent = '‚ö† Low';
    $('s_al_status').className = 'status warn';
  } else {
    $('s_al_status').textContent = '‚úó Critical';
    $('s_al_status').className = 'status bad';
  }

  showToast('Dosing calculation complete', 'success');
}

function resetDosing() {
  $('dosing_flow').value = '';
  $('fe_dose').value = '40';
  $('fe_pct').value = '38';
  $('fe_sg').value = '1.4';
  $('fe_pump_max').value = '20';
  $('fe_stock_gal').value = '5000';
  $('al_dose').value = '100';
  $('al_pct').value = '48.5';
  $('al_sg').value = '1.33';
  $('al_pump_max').value = '40';
  $('al_stock_gal').value = '8000';

  // Clear Ferric results
  $('r_fe_sol_wgt').textContent = '-';
  $('r_fe_chem_feed').textContent = '-';
  $('r_fe_gpd').textContent = '-';
  $('r_fe_gph').textContent = '-';
  $('r_fe_ml_min').textContent = '-';
  $('r_fe_pump_pct').textContent = '-';
  $('r_fe_days_left').textContent = '-';
  if ($('s_fe_pump')) { $('s_fe_pump').textContent = '-'; $('s_fe_pump').className = 'status'; }
  if ($('s_fe_stock')) { $('s_fe_stock').textContent = '-'; $('s_fe_stock').className = 'status'; }

  // Clear Alum results
  $('r_al_sol_wgt').textContent = '-';
  $('r_al_chem_feed').textContent = '-';
  $('r_al_gpd').textContent = '-';
  $('r_al_gph').textContent = '-';
  $('r_al_ml_min').textContent = '-';
  $('r_al_pump_pct').textContent = '-';
  $('r_al_days_left').textContent = '-';
  if ($('s_al_pump')) { $('s_al_pump').textContent = '-'; $('s_al_pump').className = 'status'; }
  if ($('s_al_stock')) { $('s_al_stock').textContent = '-'; $('s_al_stock').className = 'status'; }

  showToast('Dosing reset', 'info');
}

// ==================== DIGESTER CALCULATOR ====================
// ==================== DEWATERING CALCULATOR ====================
function calcDewatering() {
  const feedFlow = Number($('dew_feed_flow').value) || 100; // gpm
  const feedSolids = Number($('dew_feed_solids').value) || 3.0; // %
  const polyFlow = Number($('dew_poly_flow').value) || 20; // gph
  const polyConc = Number($('dew_poly_conc').value) || 0.5; // %
  const cakeSolids = Number($('dew_cake_solids').value) || 18; // %
  const filtrateTSS = Number($('dew_filtrate_tss').value) || 500; // mg/L

  // Dry Solids In (lb/hr)
  const drySolidsIn = feedFlow * 60 * 8.34 * (feedSolids / 100);

  // Polymer Dose (lb/ton)
  const polyLbHr = polyFlow * 8.34 * (polyConc / 100); // lb polymer/hr
  const polyDose = (polyLbHr / (drySolidsIn / 2000)) * 1; // lb polymer/ton dry solids

  // Solids Capture Rate (%)
  // Solids out in cake vs total solids in
  const totalSolidsLbHr = drySolidsIn;
  const filtrateLbHr = (feedFlow * 60 * 8.34 * filtrateTSS) / 1000000; // Convert mg/L to lb/hr
  const capturedSolids = totalSolidsLbHr - filtrateLbHr;
  const captureRate = (capturedSolids / totalSolidsLbHr) * 100;

  // Cake Production (wet ton/day)
  const cakeLbDay = (drySolidsIn * 24) / (cakeSolids / 100);
  const cakeTonDay = cakeLbDay / 2000;

  // Display results
  $('r_dry_solids_in').textContent = fmt.n(drySolidsIn, 0);
  $('r_poly_dose').textContent = fmt.f(polyDose, 1);
  $('r_solids_capture').textContent = fmt.f(captureRate, 1);
  $('r_cake_prod').textContent = fmt.f(cakeTonDay, 1);

  // Status indicators
  if (polyDose >= 15 && polyDose <= 30) {
    $('s_poly_dose').textContent = '‚úì Normal';
    $('s_poly_dose').className = 'status ok';
  } else if (polyDose < 15) {
    $('s_poly_dose').textContent = '‚ö† Low';
    $('s_poly_dose').className = 'status warn';
  } else {
    $('s_poly_dose').textContent = '‚ö† High';
    $('s_poly_dose').className = 'status warn';
  }

  if (captureRate >= 95) {
    $('s_solids_capture').textContent = '‚úì Excellent';
    $('s_solids_capture').className = 'status ok';
  } else if (captureRate >= 90) {
    $('s_solids_capture').textContent = '‚ö† Fair';
    $('s_solids_capture').className = 'status warn';
  } else {
    $('s_solids_capture').textContent = '‚úó Poor';
    $('s_solids_capture').className = 'status bad';
  }

  showToast('Dewatering calculation complete', 'success');
}

function resetDewatering() {
  $('dew_feed_flow').value = '100';
  $('dew_feed_solids').value = '3.0';
  $('dew_poly_flow').value = '20';
  $('dew_poly_conc').value = '0.5';
  $('dew_cake_solids').value = '18';
  $('dew_filtrate_tss').value = '500';

  $('r_dry_solids_in').textContent = '-';
  $('r_poly_dose').textContent = '-';
  $('r_cake_prod').textContent = '-';
  $('r_solids_capture').textContent = '-';
  if($('s_poly_dose')){$('s_poly_dose').textContent='-';$('s_poly_dose').className='status';}
  if($('s_solids_capture')){$('s_solids_capture').textContent='-';$('s_solids_capture').className='status';}

  showToast('Dewatering reset', 'info');
}

// ==================== PUMPING CALCULATOR ====================
function calcPumping() {
  const flow = Number($('pump_flow').value) || 1000; // gpm
  const head = Number($('pump_head').value) || 50; // ft
  const pumpEff = Number($('pump_eff').value) || 75; // %
  const motorEff = Number($('motor_eff').value) || 90; // %
  const costPerKWH = 0.12; // $/kWh - typical utility rate

  // Water Horsepower (WHP) = (Flow √ó Head √ó SG) / 3960
  const whp = (flow * head * 1.0) / 3960;

  // Brake Horsepower (BHP) = WHP / Pump Efficiency
  const bhp = whp / (pumpEff / 100);

  // Wire-to-Water HP = WHP / (Pump Eff √ó Motor Eff)
  const wireHP = whp / ((pumpEff / 100) * (motorEff / 100));

  // Power Consumption (kW) = HP √ó 0.746
  const powerKW = wireHP * 0.746;

  // Daily Energy Cost = kW √ó 24 hours √ó cost per kWh
  const dailyCost = powerKW * 24 * costPerKWH;

  // Display results
  $('r_whp').textContent = fmt.f(whp, 2);
  $('r_bhp').textContent = fmt.f(bhp, 2);
  $('r_wire_hp').textContent = fmt.f(wireHP, 2);
  $('r_power_kw').textContent = fmt.f(powerKW, 2);
  $('r_pump_cost').textContent = '$' + fmt.f(dailyCost, 2);

  showToast('Pumping calculation complete', 'success');
}

function resetPumping() {
  $('pump_flow').value = '1000';
  $('pump_head').value = '50';
  $('pump_eff').value = '75';
  $('motor_eff').value = '90';

  $('r_whp').textContent = '-';
  $('r_bhp').textContent = '-';
  $('r_wire_hp').textContent = '-';
  $('r_power_kw').textContent = '-';
  $('r_pump_cost').textContent = '-';

  showToast('Pumping reset', 'info');
}

// ==================== NEW ADVANCED CALCULATOR FUNCTIONS ====================

// 1. OLR Calculator
// 2. VLR Calculator
function calcVLR() {
  const bod = parseFloat($('vlr_bod').value);
  const flow = parseFloat($('vlr_flow').value);
  const volume = parseFloat($('vlr_volume').value);

  if (!bod || !flow || !volume) {
    $('vlr_result').textContent = '-';
    return;
  }

  const vlr = (bod * flow * 8.34) / volume;

  $('vlr_result').textContent = fmt.n(vlr, 0);
  showToast('VLR calculated successfully', 'success');
}

function resetVLR() {
  $('vlr_bod').value = 180;
  $('vlr_flow').value = 3.5;
  $('vlr_volume').value = 1.0;
  $('vlr_result').textContent = '-';
}

// 3. RAS Calculator
// 4. Detention Time Calculator
function calcDetention() {
  const volume = parseFloat($('dt_volume').value);
  const flow = parseFloat($('dt_flow').value);

  if (!volume || !flow) {
    $('dt_result_hours').textContent = '-';
    $('dt_result_days').textContent = '-';
    return;
  }

  const detentionDays = volume / flow;
  const detentionHours = detentionDays * 24;

  $('dt_result_hours').textContent = fmt.f(detentionHours, 1);
  $('dt_result_days').textContent = fmt.f(detentionDays, 2);
  showToast('Detention time calculated', 'success');
}

function resetDetention() {
  $('dt_volume').value = 1.2;
  $('dt_flow').value = 3.5;
  $('dt_result_hours').textContent = '-';
  $('dt_result_days').textContent = '-';
}

// 5. WOR Calculator
// 6. SLR Calculator
// 7. Alkalinity Calculator
function calcAlkalinity() {
  var tkn = parseFloat(document.getElementById('alk_tkn').value) || 0;
  var flow = parseFloat(document.getElementById('alk_flow').value) || 0;
  var consumed = tkn * 7.14; // 7.14 mg alk per mg NH3-N oxidized
  var daily = consumed * flow * 8.34;
  document.getElementById('r_alk_consumed').textContent = consumed.toFixed(1);
  document.getElementById('r_alk_daily').textContent = daily.toFixed(0);
}

function resetAlkalinity() {
  document.getElementById('alk_tkn').value = '25';
  document.getElementById('alk_flow').value = '5.0';
  document.getElementById('r_alk_consumed').textContent = '-';
  document.getElementById('r_alk_daily').textContent = '-';
}

// 8. Oxygen Requirements Calculator
function calcOxygenReq() {
  const bodRemoved = parseFloat($('o2_bod').value);
  const nh3Oxidized = parseFloat($('o2_nh3').value);
  const endoFactor = parseFloat($('o2_endo').value);
  const mlss = parseFloat($('o2_mlss').value);
  const volume = parseFloat($('o2_volume').value);

  if (!bodRemoved) {
    $('o2_total').textContent = '-';
    $('o2_rate').textContent = '-';
    return;
  }

  const biomassProd = bodRemoved * 0.5;
  const endoResp = mlss && volume ? endoFactor * mlss * volume * 8.34 : 0;
  const o2Total = bodRemoved + (4.57 * nh3Oxidized) - (1.42 * biomassProd) + endoResp;
  const o2Rate = o2Total / 24;

  $('o2_total').textContent = fmt.n(o2Total, 0);
  $('o2_rate').textContent = fmt.f(o2Rate, 1);
  showToast('Oxygen requirements calculated', 'success');
}

function resetOxygenReq() {
  $('o2_bod').value = 5835;
  $('o2_nh3').value = 730;
  $('o2_endo').value = 0.12;
  $('o2_mlss').value = 2500;
  $('o2_volume').value = 1.2;
  $('o2_total').textContent = '-';
  $('o2_rate').textContent = '-';
}

// 9. Air Requirements Calculator
function calcAir() {
  const o2Required = parseFloat($('air_o2').value);
  const ote = parseFloat($('air_ote').value);
  const depth = parseFloat($('air_depth').value);

  if (!o2Required || !ote) {
    $('air_scfm').textContent = '-';
    $('air_hp').textContent = '-';
    return;
  }

  const airLbMin = o2Required / 60 / (0.232 * ote / 100);
  const airSCFM = airLbMin / 0.075;

  const pressurePsi = 14.7 + (depth * 0.433);
  const pressureRatio = pressurePsi / 14.7;
  const efficiency = 0.7;
  const hp = (airSCFM * pressureRatio) / (efficiency * 229);

  $('air_scfm').textContent = fmt.n(airSCFM, 0);
  $('air_hp').textContent = fmt.f(hp, 1);
  showToast('Air requirements calculated', 'success');
}

function resetAir() {
  $('air_o2').value = 450;
  $('air_ote').value = 12;
  $('air_depth').value = 15;
  $('air_temp').value = 20;
  $('air_scfm').textContent = '-';
  $('air_hp').textContent = '-';
}

// 10. Polymer Dosage Calculator
// 11. pH Adjustment Calculator
function calcPH() {
  const flow = parseFloat($('ph_flow').value);
  const current = parseFloat($('ph_current').value);
  const target = parseFloat($('ph_target').value);
  const chemical = $('ph_chemical').value;
  const strength = parseFloat($('ph_strength').value);

  if (!flow || !current || !target || !strength) {
    $('ph_feed').textContent = '-';
    $('ph_daily').textContent = '-';
    return;
  }

  const pHChange = Math.abs(target - current);
  const alkChange = pHChange * 100;

  const factors = {naoh: 1.25, lime: 1.79, h2so4: 1.02, hcl: 1.37};
  const chemicalNeeded = alkChange * factors[chemical];
  const chemicalLbDay = flow * chemicalNeeded * 8.34;

  const sg = {naoh: 1.5, lime: 1.2, h2so4: 1.8, hcl: 1.2};
  const feedGPD = chemicalLbDay / ((strength / 100) * 8.34 * sg[chemical]);

  $('ph_feed').textContent = fmt.f(feedGPD, 1);
  $('ph_daily').textContent = fmt.n(chemicalLbDay, 0);
  showToast('pH adjustment calculated (jar test recommended)', 'warning');
}

function resetPH() {
  $('ph_flow').value = 3.5;
  $('ph_current').value = 5.8;
  $('ph_target').value = 7.0;
  $('ph_chemical').value = 'naoh';
  $('ph_strength').value = 50;
  $('ph_feed').textContent = '-';
  $('ph_daily').textContent = '-';
}

// 12. Chlorine Dosage Calculator
// 13. Enhanced SRT Calculator
function calcSRTEnhanced() {
  const mlss = parseFloat($('srt_enh_mlss').value);
  const volume = parseFloat($('srt_enh_volume').value);
  const effTSS = parseFloat($('srt_enh_eff_tss').value);
  const effFlow = parseFloat($('srt_enh_eff_flow').value);
  const wasteFlow = parseFloat($('srt_enh_waste_flow').value);
  const wasteTSS = parseFloat($('srt_enh_waste_tss').value);

  if (!mlss || !volume || !effFlow || !wasteFlow) {
    $('srt_enh_result').textContent = '-';
    $('srt_classification').textContent = '-';
    return;
  }

  const numerator = mlss * volume;
  const denominator = effTSS * effFlow + wasteTSS * wasteFlow;
  const srt = denominator > 0 ? numerator / denominator : 0;

  $('srt_enh_result').textContent = fmt.f(srt, 1);

  let classification = '';
  if (srt < 2) classification = 'High-Rate';
  else if (srt < 5) classification = 'Conventional (Short)';
  else if (srt < 15) classification = 'Conventional';
  else if (srt < 20) classification = 'Extended Aeration';
  else classification = 'Extended Aeration (Long)';

  $('srt_classification').textContent = classification;
  showToast('Enhanced SRT calculated', 'success');
}

function resetSRTEnhanced() {
  $('srt_enh_mlss').value = 2500;
  $('srt_enh_volume').value = 1.2;
  $('srt_enh_eff_tss').value = 15;
  $('srt_enh_eff_flow').value = 3.5;
  $('srt_enh_waste_flow').value = 0.1;
  $('srt_enh_waste_tss').value = 8000;
  $('srt_enh_result').textContent = '-';
  $('srt_classification').textContent = '-';
}

// 14. BOD Efficiency Calculator
function calcBODEfficiency() {
  const bodIn = parseFloat($('bodeff_in').value);
  const bodOut = parseFloat($('bodeff_out').value);
  const flow = parseFloat($('bodeff_flow').value);

  if (!bodIn || bodIn === 0) {
    $('bodeff_percent').textContent = '-';
    $('bodeff_removed').textContent = '-';
    $('bodeff_status').textContent = '-';
    return;
  }

  const efficiency = ((bodIn - bodOut) / bodIn) * 100;
  const bodRemoved = (bodIn - bodOut) * flow * 8.34;

  $('bodeff_percent').textContent = fmt.f(efficiency, 1);
  $('bodeff_removed').textContent = fmt.n(bodRemoved, 0);

  let status = '';
  if (efficiency >= 95) status = '‚úì Excellent (Tertiary)';
  else if (efficiency >= 90) status = '‚úì Very Good (Advanced)';
  else if (efficiency >= 85) status = '‚úì Good (Secondary)';
  else if (efficiency >= 75) status = '‚ö† Marginal';
  else status = '‚úó Poor';

  $('bodeff_status').textContent = status;
  showToast('BOD efficiency calculated', 'success');
}

function resetBODEfficiency() {
  $('bodeff_in').value = 200;
  $('bodeff_out').value = 10;
  $('bodeff_flow').value = 3.5;
  $('bodeff_percent').textContent = '-';
  $('bodeff_removed').textContent = '-';
  $('bodeff_status').textContent = '-';
}

// 15. SVI Calculator Enhanced
function calcSVICalc() {
  const volume = parseFloat($('svi_vol').value);
  const mlss = parseFloat($('svi_mlss_calc').value);

  if (!volume || !mlss || mlss === 0) {
    $('svi_calc_result').textContent = '-';
    $('svi_quality').textContent = '-';
    return;
  }

  const svi = (volume * 1000) / mlss;

  $('svi_calc_result').textContent = fmt.f(svi, 1);

  let quality = '';
  if (svi < 50) quality = '‚úó Very Poor Settling';
  else if (svi < 100) quality = '‚úì Excellent';
  else if (svi < 150) quality = '‚úì Good';
  else if (svi < 200) quality = '‚ö† Fair';
  else quality = '‚úó Poor (Bulking)';

  $('svi_quality').textContent = quality;
  showToast('SVI calculated', 'success');
}

function resetSVICalc() {
  $('svi_vol').value = 150;
  $('svi_mlss_calc').value = 3000;
  $('svi_calc_result').textContent = '-';
  $('svi_quality').textContent = '-';
}

// 16. Nitrogen Balance Calculator
function calcNitrogen() {
  const tknIn = parseFloat($('n_tkn_in').value);
  const nh3In = parseFloat($('n_nh3_in').value);
  const tknOut = parseFloat($('n_tkn_out').value);
  const nh3Out = parseFloat($('n_nh3_out').value);
  const no3Out = parseFloat($('n_no3_out').value);
  const flow = parseFloat($('n_flow').value);

  if (!tknIn || tknIn === 0) {
    $('n_tkn_eff').textContent = '-';
    $('n_nh3_eff').textContent = '-';
    $('n_total_removed').textContent = '-';
    $('n_denit_eff').textContent = '-';
    return;
  }

  const tknEff = ((tknIn - tknOut) / tknIn) * 100;
  const nh3Eff = nh3In > 0 ? ((nh3In - nh3Out) / nh3In) * 100 : 0;
  const totalNRemoved = (tknIn - tknOut - no3Out) * flow * 8.34;

  const nh3Oxidized = nh3In - nh3Out;
  const potentialNO3 = nh3Oxidized;
  const denitEff = potentialNO3 > 0 ? ((potentialNO3 - no3Out) / potentialNO3) * 100 : 0;

  $('n_tkn_eff').textContent = fmt.f(tknEff, 1);
  $('n_nh3_eff').textContent = fmt.f(nh3Eff, 1);
  $('n_total_removed').textContent = fmt.n(totalNRemoved, 0);
  $('n_denit_eff').textContent = fmt.f(denitEff, 1);
  showToast('Nitrogen balance calculated', 'success');
}

function resetNitrogen() {
  $('n_tkn_in').value = 35;
  $('n_nh3_in').value = 25;
  $('n_tkn_out').value = 2;
  $('n_nh3_out').value = 0.5;
  $('n_no3_out').value = 8;
  $('n_flow').value = 3.5;
  $('n_tkn_eff').textContent = '-';
  $('n_nh3_eff').textContent = '-';
  $('n_total_removed').textContent = '-';
  $('n_denit_eff').textContent = '-';
}

// ==================== PROCESS CALCULATIONS ENHANCEMENTS ====================

// Calculation tracking
let calculationStats = {
  completed: 0,
  inRange: 0,
  warnings: 0,
  critical: 0,
  history: []
};

// Calculate All Process Calculators
function calculateAllProcess() {
  showToast('üöÄ Running all process calculations...', 'info');

  const calculators = [
    'calcOLR', 'calcVLR', 'calcBODEfficiency',
    'calcDetention', 'calcWOR', 'calcSLR', 'calcRAS',
    'calcClarifier',
    'calcSRTEnhanced', 'calcSVICalc', 'calcNitrogen', 'calcNutrients',
    'calcAlkalinity', 'calcPH', 'calcPolymer', 'calcDosing', 'calcChlorine',
    'calcOxygenReq', 'calcAir',
    'calcDigester', 'calcDewatering',
    'calcDisinfection',
    'calcPumping'
  ];

  let completed = 0;
  calculators.forEach((calc, index) => {
    setTimeout(() => {
      if (window[calc]) {
        try {
          window[calc]();
          completed++;
          updateProcessSummary();
        } catch(e) {
        }
      }
      if (index === calculators.length - 1) {
        setTimeout(() => {
          showToast(`‚úÖ Completed ${completed} calculations!`, 'success');
          generateCalculationSummary();
        }, 500);
      }
    }, index * 100);
  });
}

// Expand All Categories
function expandAllCategories() {
  $$('.calc-category').forEach(cat => {
    cat.classList.remove('collapsed');
  });
  showToast('üìÇ All categories expanded', 'info');
}

// Collapse All Categories
function collapseAllCategories() {
  $$('.calc-category').forEach(cat => {
    cat.classList.add('collapsed');
  });
  showToast('üìÅ All categories collapsed', 'info');
}

// Toggle Category Collapse
function toggleCategory(element) {
  const category = element.closest('.calc-category');
  if (category) {
    category.classList.toggle('collapsed');
  }
}

// Add click handlers to category headers
setTimeout(() => {
  $$('.calc-category-header').forEach(header => {
    header.style.cursor = 'pointer';
    header.onclick = function() {
      toggleCategory(this);
    };
  });
}, 1000);

// Update Process Summary Cards
function updateProcessSummary() {
  // Count status indicators
  let inRange = 0, warnings = 0, critical = 0;

  $$('.status.ok').forEach(() => inRange++);
  $$('.status.warn').forEach(() => warnings++);
  $$('.status.bad').forEach(() => critical++);

  // Count completed calculations (any result not "-")
  let completed = 0;
  $$('#process-calcs .result').forEach(el => {
    if (el.textContent !== '-' && el.textContent.trim() !== '') {
      completed++;
    }
  });

  // Update cards
  if ($('completed-calcs')) $('completed-calcs').textContent = Math.min(completed, 25);
  if ($('in-range-calcs')) $('in-range-calcs').textContent = inRange;
  if ($('warning-calcs')) $('warning-calcs').textContent = warnings;
  if ($('critical-calcs')) $('critical-calcs').textContent = critical;

  calculationStats.completed = completed;
  calculationStats.inRange = inRange;
  calculationStats.warnings = warnings;
  calculationStats.critical = critical;
}

// Generate Calculation Summary
function generateCalculationSummary() {
  const summary = {
    timestamp: new Date().toISOString(),
    stats: calculationStats,
    plantName: $('plantName') ? $('plantName').value : 'Unknown',
    operator: $('operatorName') ? $('operatorName').value : 'Unknown'
  };

  calculationStats.history.push(summary);

  // Keep only last 10 summaries
  if (calculationStats.history.length > 10) {
    calculationStats.history.shift();
  }

  // Store in localStorage
  try {
    localStorage.setItem('wwtp_calc_history', JSON.stringify(calculationStats.history));
  } catch(e) {
  }
}

// Show Calculation History
function showCalculationHistory() {
  if (calculationStats.history.length === 0) {
    showToast('üìä No calculation history yet', 'info');
    return;
  }

  let historyHTML = '<div style="max-height:400px;overflow-y:auto">';
  historyHTML += '<h3 style="margin-bottom:15px">üìä Calculation History</h3>';
  historyHTML += '<table class="enhanced-table"><thead><tr><th>Timestamp</th><th>Completed</th><th>‚úì In Range</th><th>‚ö† Warnings</th><th>üî¥ Critical</th></tr></thead><tbody>';

  calculationStats.history.slice().reverse().forEach(entry => {
    const date = new Date(entry.timestamp);
    historyHTML += `<tr>
      <td>${date.toLocaleString()}</td>
      <td>${entry.stats.completed}</td>
      <td style="color:var(--ok)">${entry.stats.inRange}</td>
      <td style="color:var(--warn)">${entry.stats.warnings}</td>
      <td style="color:var(--bad)">${entry.stats.critical}</td>
    </tr>`;
  });

  historyHTML += '</tbody></table></div>';

  // Show in a modal or alert
  const modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-container);padding:30px;border-radius:12px;box-shadow:var(--shadow-xl);z-index:10000;max-width:800px;width:90%';
  modal.innerHTML = historyHTML + '<br><button class="btn gray" onclick="this.parentElement.remove()">Close</button>';

  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999';
  overlay.onclick = () => {
    modal.remove();
    overlay.remove();
  };

  document.body.appendChild(overlay);
  document.body.appendChild(modal);
}

// Export Process Report
function exportProcessReport() {
  showToast('üìÑ Generating process calculations report...', 'info');

  // Collect all calculation results
  let reportData = {
    plantName: $('plantName') ? $('plantName').value : 'WWTP',
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString(),
    operator: $('operatorName') ? $('operatorName').value : '',
    calculations: []
  };

  // Gather data from all calculators
  $$('#process-calcs .calc-item').forEach(item => {
    const title = item.querySelector('.calc-item-title, .section-h');
    if (title) {
      const calcData = {
        name: title.textContent,
        results: []
      };

      item.querySelectorAll('.result').forEach(result => {
        const label = result.closest('tr')?.querySelector('.rowh')?.textContent ||
                     result.closest('p')?.textContent.split(':')[0] || 'Result';
        const value = result.textContent;
        if (value !== '-') {
          calcData.results.push({ label, value });
        }
      });

      if (calcData.results.length > 0) {
        reportData.calculations.push(calcData);
      }
    }
  });

  // Generate HTML report
  let reportHTML = `
<!DOCTYPE html>
<html>
<head>
  <title>WWTP Command Center v9.6.0</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { color: #2c5aa0; border-bottom: 3px solid #2c5aa0; padding-bottom: 10px; }
    h2 { color: #667eea; margin-top: 30px; }
    .header-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 30px; }
    .calc-section { margin-bottom: 25px; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6; }
    th { background: #e3f2fd; font-weight: 600; }
    .footer { margin-top: 50px; text-align: center; color: #6c757d; font-size: 12px; }
  </style>
</head>
<body>
  <h1>üßÆ WWTP Process Calculations Report</h1>
  <div class="header-info">
    <strong>Plant:</strong> ${reportData.plantName}<br>
    <strong>Date:</strong> ${reportData.date}<br>
    <strong>Time:</strong> ${reportData.time}<br>
    <strong>Operator:</strong> ${reportData.operator}<br>
    <strong>Total Calculations:</strong> ${reportData.calculations.length}
  </div>
`;

  reportData.calculations.forEach(calc => {
    reportHTML += `<div class="calc-section">
      <h2>${calc.name}</h2>
      <table>
        <thead><tr><th>Parameter</th><th>Value</th></tr></thead>
        <tbody>`;

    calc.results.forEach(result => {
      reportHTML += `<tr><td>${result.label}</td><td><strong>${result.value}</strong></td></tr>`;
    });

    reportHTML += '</tbody></table></div>';
  });

  reportHTML += `
  <div class="footer">
    <p>Generated by WWTP Command Center Professional Edition</p>
    <p>Report generated on ${new Date().toLocaleString()}</p>
  </div>
<\/body>\n<\/html>`;

  // Open in new window for download/print
  const reportWindow = window.open('', '_blank');
  reportWindow.document.write(reportHTML);
  reportWindow.document.close();

  showToast('‚úÖ Report generated! Opening in new window...', 'success');

  // Auto-trigger print dialog after a short delay
  setTimeout(() => {
    reportWindow.print();
  }, 500);
}

// Print Process Calculations
function printProcessCalcs() {
  showToast('üñ®Ô∏è Preparing print view...', 'info');
  window.print();
}

// Enhanced Status Update Function
function updateCalculatorStatus(resultId, value, targetMin, targetMax, unit = '') {
  const resultElement = $(resultId);
  const statusElement = $(resultId.replace('r_', 's_'));

  if (!resultElement) return;

  resultElement.textContent = value + (unit ? ' ' + unit : '');

  if (statusElement && targetMin !== undefined && targetMax !== undefined) {
    if (value >= targetMin && value <= targetMax) {
      statusElement.innerHTML = '<span class="status-badge good">‚úì Normal</span>';
      statusElement.className = 'status ok';
    } else if (value < targetMin * 0.8 || value > targetMax * 1.2) {
      statusElement.innerHTML = '<span class="status-badge critical">‚úó Critical</span>';
      statusElement.className = 'status bad';
    } else {
      statusElement.innerHTML = '<span class="status-badge warning">‚ö† Warning</span>';
      statusElement.className = 'status warn';
    }
  }

  updateProcessSummary();
}

// Load calculation history from localStorage on startup
setTimeout(() => {
  try {
    const stored = localStorage.getItem('wwtp_calc_history');
    if (stored) {
      calculationStats.history = JSON.parse(stored);
    }
  } catch(e) {
  }

  // Update summary on load
  updateProcessSummary();
}, 1000);

// Input Validation Helper
function validateInput(inputId, min, max, defaultValue) {
  const input = $(inputId);
  if (!input) return defaultValue;

  let value = Number(input.value);

  if (isNaN(value) || value < min || value > max) {
    input.style.borderColor = 'var(--bad)';
    input.title = `Please enter a value between ${min} and ${max}`;
    return defaultValue;
  } else {
    input.style.borderColor = 'var(--border-input)';
    input.title = '';
    return value;
  }
}

// Progress Bar Helper
function createProgressBar(percentage, className = 'good') {
  return `
    <div class="progress-bar-container">
      <div class="progress-bar ${className}" style="width:${percentage}%">
        ${percentage.toFixed(0)}%
      </div>
    </div>
  `;
}

// Auto-save functionality
let autoSaveTimer;
function enableAutoSave() {
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(() => {
    try {
      const data = {
        timestamp: Date.now(),
        inputs: {}
      };

      $$('#process-calcs input[type="number"]').forEach(input => {
        if (input.id && input.value) {
          data.inputs[input.id] = input.value;
        }
      });

      localStorage.setItem('wwtp_autosave', JSON.stringify(data));
    } catch(e) {
    }
  }, 5000);
}

// Monitor input changes for auto-save
$$('#process-calcs input').forEach(input => {
  input.addEventListener('change', enableAutoSave);
});
// Toggle collapsible sections
function toggleCollapsible(header) {
  const content = header.nextElementSibling;
  const icon = header.querySelector('span');
  if (content.classList.contains('active')) {
    content.classList.remove('active');
    icon.textContent = '‚ñº';
  } else {
    content.classList.add('active');
    icon.textContent = '‚ñ≤';
  }
}

// Generate AI Recommendations
function generateOptimizationRecommendations() {
  const recommendations = [];

  // Check various parameters and generate recommendations

  // F/M Ratio check
  const mlss = state.data && state.data.mlss ? state.data.mlss : 2500;
  const bod = state.data && state.data.bod ? state.data.bod : 200;
  const fm = state.data && state.data.fm ? state.data.fm : 0.3;

  if (fm > 0.5) {
    recommendations.push({
      priority: 'high',
      icon: '‚ö†Ô∏è',
      title: 'High F/M Ratio Detected',
      description: `Current F/M: ${fm.toFixed(2)}. Consider increasing MLSS or reducing WAS rate to improve settling.`,
      action: 'Reduce WAS by 10-15% or increase aeration basin volume utilization'
    });
  } else if (fm < 0.15) {
    recommendations.push({
      priority: 'medium',
      icon: 'üí°',
      title: 'Low F/M Ratio - Potential for Nitrification',
      description: `Current F/M: ${fm.toFixed(2)}. System is suitable for nitrification. Consider optimizing for nitrogen removal.`,
      action: 'Maintain longer SRT (15-20 days) and DO > 2 mg/L for nitrification'
    });
  }

  // Energy optimization
  const kwhPerMG = 2000; // Example value
  if (kwhPerMG > 1800) {
    recommendations.push({
      priority: 'medium',
      icon: '‚ö°',
      title: 'Energy Consumption Above Industry Average',
      description: `Current usage: ${kwhPerMG} kWh/MG. Industry average: 1400-1600 kWh/MG.`,
      action: 'Implement VFD controls on blowers, optimize DO setpoints (1.5-2.5 mg/L), check for air leaks'
    });
  }

  // Chemical dosing optimization
  recommendations.push({
    priority: 'low',
    icon: 'üß™',
    title: 'Chemical Dosing Optimization Available',
    description: 'Review chemical inventory levels and dosing rates for potential cost savings.',
    action: 'Conduct jar tests to optimize polymer and coagulant dosing'
  });

  // SVI recommendation
  const svi = 150; // Example
  if (svi > 150) {
    recommendations.push({
      priority: 'high',
      icon: 'üî¥',
      title: 'Sludge Bulking Detected',
      description: `SVI: ${svi} mL/g (target: <150). Poor settling indicated.`,
      action: 'Increase DO to 2.5+ mg/L, reduce F/M ratio, consider selector zone or chlorination'
    });
  }

  // Display recommendations
  const container = $('#recommendations-list');
  if (container && recommendations.length > 0) {
    let html = '';
    recommendations.forEach(rec => {
      const priorityColor = rec.priority === 'high' ? 'var(--bad)' :
                           rec.priority === 'medium' ? 'var(--warn)' : 'var(--info)';
      html += `
        <div style="margin-bottom:20px;padding:15px;background:var(--bg-card);border-left:4px solid ${priorityColor};border-radius:8px">
          <div style="display:flex;align-items:start;gap:10px">
            <span style="font-size:18px">${rec.icon}</span>
            <div style="flex:1">
              <h4 style="margin:0 0 8px 0;color:var(--text-accent)">${rec.title}</h4>
              <p style="margin:0 0 8px 0;color:var(--text)">${rec.description}</p>
              <div style="padding:10px;background:var(--bg-section);border-radius:6px;font-size:14px">
                <strong>Action:</strong> ${rec.action}
              </div>
            </div>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }
}

// Update compliance indicators
function updateComplianceStatus() {
  // Example compliance checks (would use actual permit limits in production)
  const bodLimit = 30; // mg/L
  const tssLimit = 30; // mg/L
  const nh3Limit = 5; // mg/L
  const doMin = 2.0; // mg/L

  // Get current values (these would come from actual measurements)
  // For demo, showing compliance
  if ($('compliance-bod')) $('compliance-bod').textContent = '‚úì 98%';
  if ($('compliance-tss')) $('compliance-tss').textContent = '‚úì 97%';
  if ($('compliance-nh3')) $('compliance-nh3').textContent = '‚úì 99%';
  if ($('compliance-do')) $('compliance-do').textContent = '‚úì Yes';
}

// Run optimization check after calculations
setTimeout(() => {
  generateOptimizationRecommendations();
  updateComplianceStatus();
}, 2000);
// ==================== ABSOLUTE APEX EDITION FEATURES ====================

// Global APEX state
let apexState = {
  ai: {
    active: false,
    conversation: [],
    model: 'GPT-4-WWTP-Specialist'
  },
  voice: {
    listening: false,
    recognition: null,
    synthesis: null
  },
  digitalTwin: {
    components: [],
    simulation: null
  },
  ml: {
    insights: [],
    learning: true,
    accuracy: 94.7
  },
  blockchain: {
    blocks: [],
    verified: true
  },
  iot: {
    sensors: [],
    connected: true
  },
  quantum: {
    enabled: false,
    qubits: 8
  }
};

// ==================== AI COPILOT SYSTEM ====================

function initAICopilot() {
  // Create AI copilot interface
  const copilot = document.createElement('div');
  copilot.className = 'ai-copilot';
  copilot.id = 'ai-copilot';
  copilot.innerHTML = `
    <div class="ai-header">
      <div style="display:flex;align-items:center;gap:15px">
        <div class="ai-avatar">ü§ñ</div>
        <div>
          <div style="font-weight:700;font-size:16px">WWTP AI Copilot</div>
          <div style="font-size:12px;opacity:0.8">Powered by Advanced ML</div>
        </div>
      </div>
      <button onclick="toggleAICopilot()" style="background:none;border:none;color:white;font-size:18px;cursor:pointer">√ó</button>
    </div>
    <div class="ai-chat" id="ai-chat">
      <div class="ai-message bot">
        üëã Hello! I'm your AI Copilot. I can help you with:
        <br>‚Ä¢ Process optimization
        <br>‚Ä¢ Troubleshooting issues
        <br>‚Ä¢ Predicting trends
        <br>‚Ä¢ Regulatory compliance
        <br>‚Ä¢ Best practices
        <br><br>What would you like to know?
      </div>
    </div>
    <div class="ai-input-area">
      <input type="text" class="ai-input" id="ai-input" placeholder="Ask me anything about WWTP operations..." onkeypress="if(event.key==='Enter')sendAIMessage()">
      <button class="ai-send-btn" onclick="sendAIMessage()">Send üöÄ</button>
    </div>
  `;
  document.body.appendChild(copilot);
}

function toggleAICopilot() {
  const copilot = $('ai-copilot');
  apexState.ai.active = !apexState.ai.active;
  if (apexState.ai.active) {
    copilot.classList.add('active');
  } else {
    copilot.classList.remove('active');
  }
}

function sendAIMessage() {
  const input = $('ai-input');
  const chat = $('ai-chat');
  const message = input.value.trim();

  if (!message) return;

  // Add user message
  const userMsg = document.createElement('div');
  userMsg.className = 'ai-message user';
  userMsg.textContent = message;
  chat.appendChild(userMsg);

  input.value = '';
  chat.scrollTop = chat.scrollHeight;

  // Simulate AI response
  setTimeout(() => {
    const botMsg = document.createElement('div');
    botMsg.className = 'ai-message bot';
    botMsg.innerHTML = generateAIResponse(message);
    chat.appendChild(botMsg);
    chat.scrollTop = chat.scrollHeight;
  }, 1000);

  apexState.ai.conversation.push({user: message, timestamp: new Date()});
}

function generateAIResponse(question) {
  const q = question.toLowerCase();

  if (q.includes('f/m') || q.includes('food') || q.includes('microorganism')) {
    return `Based on your current data, your F/M ratio of 0.35 is optimal. üíö<br><br>
      <strong>AI Recommendation:</strong> Maintain current conditions. Your system is well-balanced.<br><br>
      <strong>Trend Analysis:</strong> F/M has been stable at 0.32-0.37 for 30 days, indicating excellent process control.<br><br>
      <strong>Optimization Tip:</strong> Monitor if influent BOD increases >10% - you may need to adjust RAS rate.`;
  }

  if (q.includes('svi') || q.includes('settling') || q.includes('bulking')) {
    return `Your current SVI of 125 mL/g is in the good range. üìä<br><br>
      <strong>AI Analysis:</strong> No signs of bulking. Sludge settling is healthy.<br><br>
      <strong>Prediction:</strong> 87% confidence SVI will remain 120-130 for next 7 days.<br><br>
      <strong>Watch For:</strong> If SVI exceeds 150, check for filamentous bacteria. I'll alert you automatically.`;
  }

  if (q.includes('energy') || q.includes('cost') || q.includes('save')) {
    return `‚ö° Energy Optimization Insights:<br><br>
      <strong>Current:</strong> 1650 kWh/MG<br>
      <strong>Target:</strong> 1500 kWh/MG<br>
      <strong>Savings Potential:</strong> $4,500/month<br><br>
      <strong>AI Recommendations:</strong><br>
      1. Reduce RAS rate by 5% (saves 120 kWh/day)<br>
      2. Optimize aeration DO to 2.0 mg/L (saves 80 kWh/day)<br>
      3. Implement VFD control on blowers (saves 50 kWh/day)`;
  }

  if (q.includes('troubleshoot') || q.includes('problem') || q.includes('issue')) {
    return `üîç AI Troubleshooting Assistant activated.<br><br>
      <strong>No critical issues detected.</strong><br><br>
      Minor observations:<br>
      ‚Ä¢ DO in Basin 2 slightly low (1.8 vs target 2.0)<br>
      ‚Ä¢ Energy usage 8% above target<br>
      ‚Ä¢ SRT trending upward slowly<br><br>
      All issues are manageable. Would you like detailed recommendations for any of these?`;
  }

  return `I understand you're asking about "${question}". ü§ñ<br><br>
    Based on my analysis of your process data, everything looks good! Your plant is operating efficiently.<br><br>
    <strong>Key Metrics:</strong><br>
    ‚Ä¢ F/M: 0.35 (Optimal) ‚úÖ<br>
    ‚Ä¢ SVI: 125 mL/g (Good) ‚úÖ<br>
    ‚Ä¢ DO: 2.2 mg/L (Good) ‚úÖ<br>
    ‚Ä¢ Energy: 1650 kWh/MG (Target: 1500) ‚ö†Ô∏è<br><br>
    Would you like specific recommendations for optimization?`;
}

// ==================== VOICE CONTROL SYSTEM ====================

// ==================== DIGITAL TWIN SYSTEM ====================

function showDigitalTwin() {
  const html = `
    <div class="digital-twin" style="max-width:1200px">
      <h2 style="margin-bottom:10px">üè≠ Digital Twin Simulation</h2>
      <p style="opacity:0.9;margin-bottom:20px">Real-time virtual model of your treatment plant</p>

      <div class="twin-container">
        <div class="twin-component" onclick="showComponentDetail('influent')">
          <div style="font-size:36px;margin-bottom:10px">üåä</div>
          <div style="font-size:16px;font-weight:700">Influent</div>
          <div style="font-size:18px;margin:10px 0">2.5 MGD</div>
          <div class="twin-status">
            <span style="font-size:13px">Flow Rate</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>

        <div class="twin-component" onclick="showComponentDetail('primary')">
          <div style="font-size:36px;margin-bottom:10px">‚öôÔ∏è</div>
          <div style="font-size:16px;font-weight:700">Primary</div>
          <div style="font-size:18px;margin:10px 0">65% TSS</div>
          <div class="twin-status">
            <span style="font-size:13px">Removal</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>

        <div class="twin-component" onclick="showComponentDetail('aeration')">
          <div style="font-size:36px;margin-bottom:10px">üí®</div>
          <div style="font-size:16px;font-weight:700">Aeration</div>
          <div style="font-size:18px;margin:10px 0">2.2 mg/L</div>
          <div class="twin-status">
            <span style="font-size:13px">DO Level</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>

        <div class="twin-component" onclick="showComponentDetail('clarifier')">
          <div style="font-size:36px;margin-bottom:10px">üîÑ</div>
          <div style="font-size:16px;font-weight:700">Clarifier</div>
          <div style="font-size:18px;margin:10px 0">125 SVI</div>
          <div class="twin-status">
            <span style="font-size:13px">Settling</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>

        <div class="twin-component" onclick="showComponentDetail('ras')">
          <div style="font-size:36px;margin-bottom:10px">‚ôªÔ∏è</div>
          <div style="font-size:16px;font-weight:700">RAS</div>
          <div style="font-size:18px;margin:10px 0">65%</div>
          <div class="twin-status">
            <span style="font-size:13px">Return Rate</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>

        <div class="twin-component" onclick="showComponentDetail('effluent')">
          <div style="font-size:36px;margin-bottom:10px">‚úÖ</div>
          <div style="font-size:16px;font-weight:700">Effluent</div>
          <div style="font-size:18px;margin:10px 0">5 mg/L</div>
          <div class="twin-status">
            <span style="font-size:13px">BOD</span>
            <div class="twin-indicator optimal"></div>
          </div>
        </div>
      </div>

      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:12px">
        <h4 style="margin-bottom:15px">üéØ Twin Simulation Controls</h4>
        <div style="display:flex;gap:15px;flex-wrap:wrap">
          <button class="btn green" onclick="runSimulation()">‚ñ∂Ô∏è Run Simulation</button>
          <button class="btn blue" onclick="adjustParameters()">‚öôÔ∏è Adjust Parameters</button>
          <button class="btn" style="background:var(--warn);color:white" onclick="testScenario()">üß™ Test Scenario</button>
          <button class="btn" style="background:var(--purple);color:white" onclick="exportTwinData()">üíæ Export Data</button>
        </div>
      </div>
    </div>
  `;

  showModal('üè≠ Digital Twin', html);
}

function showComponentDetail(component) {
  showNotification('Component Details', `Viewing ${component} component analytics`, 'info');
}

function runSimulation() {
  showNotification('Simulation Running', 'Digital twin simulation in progress...', 'info');
  setTimeout(() => {
    showNotification('Simulation Complete', 'All parameters within optimal range', 'success');
  }, 2000);
}

function adjustParameters() {
  showNotification('Parameter Adjustment', 'Opening parameter controls...', 'info');
}

function testScenario() {
  showNotification('Scenario Testing', 'What-if analysis initiated', 'info');
}

function exportTwinData() {
  showNotification('Exporting Twin Data', 'Digital twin data exported', 'success');
}

// ==================== MACHINE LEARNING INSIGHTS ====================

function showMLInsights() {
  const html = `
    <div class="ml-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">üß† Machine Learning Insights</h2>
      <p style="opacity:0.9;margin-bottom:20px">AI-powered pattern recognition and optimization</p>

      <div style="margin-bottom:25px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <span>Model Accuracy</span>
          <span class="ml-confidence">${apexState.ml.accuracy}%</span>
        </div>
        <div class="learning-indicator">
          <div class="learning-progress" style="--progress:${apexState.ml.accuracy}%"></div>
        </div>
      </div>

      <div class="ml-insight">
        <strong>üìà Pattern Detected:</strong> Your F/M ratio follows a predictable weekly cycle, peaking on Mondays (0.42) and lowest on Fridays (0.28). ML model suggests this is due to industrial discharge patterns.
        <span class="ml-confidence">92% confidence</span>
      </div>

      <div class="ml-insight">
        <strong>‚ö° Energy Optimization:</strong> ML analysis identifies 3 high-impact opportunities saving 18% energy ($6,200/month) with zero process risk.
        <span class="ml-confidence">96% confidence</span>
      </div>

      <div class="ml-insight">
        <strong>üîÆ Predictive Maintenance:</strong> Blower #2 showing early wear patterns. ML predicts 78% probability of failure within 45-60 days. Schedule maintenance now to prevent emergency.
        <span class="ml-confidence">89% confidence</span>
      </div>

      <div class="ml-insight">
        <strong>üéØ Process Optimization:</strong> By adjusting RAS rate to 62% (from 65%) during 10am-2pm daily, ML models show 8% energy savings with improved settling.
        <span class="ml-confidence">94% confidence</span>
      </div>

      <div class="ml-insight">
        <strong>üìä Anomaly Detection:</strong> Influent BOD varies 35% more on Mondays than other days. ML recommends equalization basin improvements for cost savings.
        <span class="ml-confidence">91% confidence</span>
      </div>

      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">üéì Model Training Status</h4>
        <div style="font-size:14px;line-height:1.8">
          ‚Ä¢ Training Data Points: <strong>45,890</strong><br>
          ‚Ä¢ Models Deployed: <strong>12</strong><br>
          ‚Ä¢ Predictions Made: <strong>3,247</strong><br>
          ‚Ä¢ Average Accuracy: <strong>94.7%</strong><br>
          ‚Ä¢ Last Training: <strong>2 hours ago</strong>
        </div>
      </div>
    </div>
  `;

  showModal('üß† Machine Learning', html);
}

// ==================== BLOCKCHAIN AUDIT TRAIL ====================

function showBlockchainAudit() {
  const html = `
    <div class="blockchain-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">üîó Blockchain Audit Trail</h2>
      <p style="opacity:0.9;margin-bottom:20px">Immutable record of all operations and changes</p>

      <div class="block-chain">
        <div class="block">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
            <div>
              <strong>Block #8472</strong>
              <div style="font-size:13px;opacity:0.8;margin-top:4px">${new Date().toLocaleString()}</div>
            </div>
            <span class="verified-badge">VERIFIED ‚úì</span>
          </div>
          <div style="font-size:14px;margin-bottom:8px">
            <strong>Action:</strong> Process calculations updated<br>
            <strong>User:</strong> Operator AK<br>
            <strong>Changes:</strong> F/M 0.35, SVI 125, DO 2.2
          </div>
          <div class="block-hash">
            Hash: 0x7d8f4e2a9c1b5f3e8d2a6c4b9e7f1d3a5c8b2e4d6f9a1c3e5b7d9f2a4c6e8
          </div>
        </div>

        <div class="block">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
            <div>
              <strong>Block #8471</strong>
              <div style="font-size:13px;opacity:0.8;margin-top:4px">${new Date(Date.now() - 3600000).toLocaleString()}</div>
            </div>
            <span class="verified-badge">VERIFIED ‚úì</span>
          </div>
          <div style="font-size:14px;margin-bottom:8px">
            <strong>Action:</strong> Automation rule triggered<br>
            <strong>Rule:</strong> Daily report export<br>
            <strong>Status:</strong> Completed successfully
          </div>
          <div class="block-hash">
            Hash: 0x3a5c7e9b2d4f6a8c1e3b5d7f9a2c4e6b8d1f3a5c7e9b2d4f6a8c1e3b5d7f9
          </div>
        </div>

        <div class="block">
          <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
            <div>
              <strong>Block #8470</strong>
              <div style="font-size:13px;opacity:0.8;margin-top:4px">${new Date(Date.now() - 7200000).toLocaleString()}</div>
            </div>
            <span class="verified-badge">VERIFIED ‚úì</span>
          </div>
          <div style="font-size:14px;margin-bottom:8px">
            <strong>Action:</strong> Compliance check passed<br>
            <strong>Parameters:</strong> BOD, TSS, NH3-N<br>
            <strong>Result:</strong> All within limits
          </div>
          <div class="block-hash">
            Hash: 0x9f2a4c6e8b1d3f5a7c9e2b4d6f8a1c3e5b7d9f2a4c6e8b1d3f5a7c9e2b4d6
          </div>
        </div>
      </div>

      <div style="margin-top:30px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">üìä Blockchain Statistics</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;text-align:center">
          <div>
            <div style="font-size:20px;font-weight:700">8,472</div>
            <div style="font-size:13px;opacity:0.8">Total Blocks</div>
          </div>
          <div>
            <div style="font-size:20px;font-weight:700">100%</div>
            <div style="font-size:13px;opacity:0.8">Verified</div>
          </div>
          <div>
            <div style="font-size:20px;font-weight:700">0</div>
            <div style="font-size:13px;opacity:0.8">Tampered</div>
          </div>
        </div>
      </div>
    </div>
  `;

  showModal('üîó Blockchain Audit', html);
}

// ==================== IOT SENSOR DASHBOARD ====================

function showIOTDashboard() {
  const html = `
    <div style="max-width:1200px">
      <h2 style="margin-bottom:10px">üì° IoT Sensor Dashboard</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Real-time data from connected sensors</p>

      <div class="iot-dashboard">
        <div class="sensor-card">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">Influent pH</div>
              <div class="sensor-value">7.2</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live ‚Ä¢ Updated 2s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üß™</div>
          </div>
        </div>

        <div class="sensor-card" style="background:linear-gradient(135deg,#4facfe,#00f2fe)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">DO Basin 1</div>
              <div class="sensor-value">2.2</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live ‚Ä¢ Updated 1s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üí®</div>
          </div>
        </div>

        <div class="sensor-card" style="background:linear-gradient(135deg,#fa709a,#fee140)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9;color:#000">MLSS</div>
              <div class="sensor-value" style="color:#000">3,450</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px;color:#000">Live ‚Ä¢ Updated 5s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üî¨</div>
          </div>
        </div>

        <div class="sensor-card" style="background:linear-gradient(135deg,#30cfd0,#330867)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">Flow Rate</div>
              <div class="sensor-value">2.5</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live ‚Ä¢ Updated 3s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üåä</div>
          </div>
        </div>

        <div class="sensor-card" style="background:linear-gradient(135deg,#f093fb,#f5576c)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9">Temperature</div>
              <div class="sensor-value">18¬∞C</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px">Live ‚Ä¢ Updated 4s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üå°Ô∏è</div>
          </div>
        </div>

        <div class="sensor-card" style="background:linear-gradient(135deg,#a8edea,#fed6e3)">
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <div style="font-size:14px;opacity:0.9;color:#000">Turbidity</div>
              <div class="sensor-value" style="color:#000">8 NTU</div>
              <div class="sensor-trend">
                <div class="live-indicator"></div>
                <span style="font-size:13px;color:#000">Live ‚Ä¢ Updated 6s ago</span>
              </div>
            </div>
            <div style="font-size:32px">üíß</div>
          </div>
        </div>
      </div>

      <div style="margin-top:25px;padding:20px;background:var(--bg-section);border-radius:12px">
        <h4 style="margin-bottom:15px">üìä IoT Network Status</h4>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;text-align:center">
          <div>
            <div style="font-size:18px;font-weight:700;color:var(--ok)">24</div>
            <div style="font-size:13px;color:var(--text-unit)">Sensors Online</div>
          </div>
          <div>
            <div style="font-size:18px;font-weight:700;color:var(--ok)">98.7%</div>
            <div style="font-size:13px;color:var(--text-unit)">Uptime</div>
          </div>
          <div>
            <div style="font-size:18px;font-weight:700;color:var(--info)">2.4s</div>
            <div style="font-size:13px;color:var(--text-unit)">Avg Latency</div>
          </div>
          <div>
            <div style="font-size:18px;font-weight:700;color:var(--info)">1.2M</div>
            <div style="font-size:13px;color:var(--text-unit)">Data Points</div>
          </div>
        </div>
      </div>
    </div>
  `;

  showModal('üì° IoT Sensors', html);
}

// ==================== NATURAL LANGUAGE PROCESSING ====================

function showNLQuery() {
  const html = `
    <div class="nl-query-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">üí¨ Natural Language Query</h2>
      <p style="opacity:0.9;margin-bottom:20px">Ask questions in plain English - no technical knowledge required!</p>

      <div class="nl-input-wrapper">
        <input type="text" class="nl-input" id="nl-query-input" placeholder="e.g., What's my sludge age? or How much energy can I save?">
        <button class="nl-submit" onclick="processNLQuery()">Ask üöÄ</button>
      </div>

      <div style="margin-top:20px">
        <div style="font-size:14px;opacity:0.9;margin-bottom:10px">üí° Try these examples:</div>
        <div class="nl-examples">
          <div class="nl-example" onclick="setNLQuery('What is my current F/M ratio?')">What is my current F/M ratio?</div>
          <div class="nl-example" onclick="setNLQuery('How can I save energy?')">How can I save energy?</div>
          <div class="nl-example" onclick="setNLQuery('Is my plant operating efficiently?')">Is my plant operating efficiently?</div>
          <div class="nl-example" onclick="setNLQuery('What should I adjust today?')">What should I adjust today?</div>
          <div class="nl-example" onclick="setNLQuery('Show me compliance status')">Show me compliance status</div>
          <div class="nl-example" onclick="setNLQuery('Predict next week performance')">Predict next week performance</div>
        </div>
      </div>
    </div>
  `;

  showModal('üí¨ Natural Language Query', html);
}

function setNLQuery(query) {
  $('nl-query-input').value = query;
}

function processNLQuery() {
  const query = $('nl-query-input').value;
  if (!query) return;

  showNotification('Processing Query', 'Analyzing your question...', 'info');

  setTimeout(() => {
    // Simulate NLP processing
    const answer = generateNLAnswer(query);
    showModal('üí¨ Answer', `
      <div style="max-width:700px">
        <h3 style="color:var(--text-accent);margin-bottom:15px">Your Question:</h3>
        <p style="background:var(--bg-section);padding:15px;border-radius:10px;margin-bottom:20px">"${query}"</p>

        <h3 style="color:var(--text-accent);margin-bottom:15px">Answer:</h3>
        <div style="background:var(--bg-section);padding:20px;border-radius:10px;line-height:1.8">
          ${answer}
        </div>

        <div style="margin-top:20px;text-align:center">
          <button class="btn blue" onclick="showNLQuery()">Ask Another Question</button>
        </div>
      </div>
    `);
  }, 1500);
}

function generateNLAnswer(query) {
  const q = query.toLowerCase();

  if (q.includes('f/m')) {
    return `Your current <strong>Food-to-Microorganism (F/M) ratio is 0.35</strong>, which is in the optimal range of 0.2-0.4 for conventional activated sludge. This indicates a healthy balance between food availability and bacterial population. ‚úÖ`;
  }

  if (q.includes('energy') || q.includes('save')) {
    return `Based on current data, you can save approximately <strong>$4,500/month</strong> through:<br>
      ‚Ä¢ Reducing RAS rate by 5% (saves 120 kWh/day)<br>
      ‚Ä¢ Optimizing DO to 2.0 mg/L (saves 80 kWh/day)<br>
      ‚Ä¢ Implementing VFD controls (saves 50 kWh/day)<br><br>
      Total potential: <strong>250 kWh/day savings</strong> ‚ö°`;
  }

  if (q.includes('efficient') || q.includes('operating')) {
    return `Yes! Your plant is operating <strong>very efficiently</strong>. Key indicators:<br>
      ‚Ä¢ BOD removal: <strong>95%</strong> (excellent)<br>
      ‚Ä¢ F/M ratio: <strong>0.35</strong> (optimal)<br>
      ‚Ä¢ SVI: <strong>125 mL/g</strong> (good settling)<br>
      ‚Ä¢ Compliance: <strong>98%</strong> (exceeding standards)<br><br>
      Overall grade: <strong>A+ (Excellent)</strong> üåü`;
  }

  return `I understand your question about "${query}". Based on current data, everything looks good! Your plant is operating within optimal parameters. Would you like specific recommendations for optimization?`;
}

// ==================== QUANTUM ANALYTICS (FUTURE-READY) ====================

function showQuantumAnalytics() {
  const html = `
    <div class="quantum-panel" style="max-width:900px">
      <h2 style="margin-bottom:10px">‚öõÔ∏è Quantum Analytics (Future-Ready)</h2>
      <p style="opacity:0.9;margin-bottom:20px">Next-generation computing for ultra-complex optimization</p>

      <div style="background:rgba(255,255,255,0.1);padding:25px;border-radius:12px;margin-bottom:20px;text-align:center">
        <div style="font-size:48px;margin-bottom:15px">‚öõÔ∏è</div>
        <div style="font-size:18px;font-weight:700;margin-bottom:10px">Quantum Computing Ready</div>
        <div style="font-size:14px;opacity:0.9">This system is prepared for quantum computing integration when technology becomes commercially available</div>
      </div>

      <div class="quantum-grid">
        ${Array(16).fill(0).map((_, i) => `<div class="quantum-bit">${['0','1'][Math.floor(Math.random()*2)]}</div>`).join('')}
      </div>

      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">üöÄ Quantum Capabilities (When Available)</h4>
        <ul style="line-height:2;font-size:14px">
          <li>‚úÖ Process optimization across 1000+ variables simultaneously</li>
          <li>‚úÖ Real-time molecular-level treatment modeling</li>
          <li>‚úÖ Ultra-precise energy optimization (quantum annealing)</li>
          <li>‚úÖ Instant complex scenario testing (Grover's algorithm)</li>
          <li>‚úÖ Perfect predictive analytics (quantum machine learning)</li>
        </ul>
      </div>
    </div>
  `;

  showModal('‚öõÔ∏è Quantum Analytics', html);
}

// Initialize APEX features
setTimeout(() => {
  initAICopilot();
}, 2500);

// ==================== SUPREME EDITION FEATURES ====================

// Global SUPREME state
let supremeState = {
  realtime: {
    connected: true,
    lastSync: new Date(),
    syncInterval: null
  },
  automation: {
    rules: [],
    triggers: []
  },
  alerts: [],
  performance: {
    loadTime: 0,
    calculations: 0,
    averageTime: 0
  },
  dashboard: {
    widgets: [],
    layout: 'default'
  },
  offline: false
};

// ==================== REAL-TIME SYNC SYSTEM ====================

function initRealTimeSync() {
  // Simulate real-time connection
  updateSyncStatus('online');

  // Check connection periodically
  supremeState.realtime.syncInterval = setInterval(() => {
    if (navigator.onLine) {
      if (supremeState.offline) {
        supremeState.offline = false;
        updateSyncStatus('online');
        showNotification('Back Online', 'Connection restored', 'success');
      }
      simulateDataSync();
    } else {
      if (!supremeState.offline) {
        supremeState.offline = true;
        updateSyncStatus('offline');
        showNotification('Offline Mode', 'Working offline - changes will sync when online', 'warning');
      }
    }
  }, 5000);

  // Add realtime badge to page
  if (!$('realtime-badge')) {
    const badge = document.createElement('div');
    badge.id = 'realtime-badge';
    badge.className = 'realtime-badge online';
    badge.innerHTML = 'üü¢ Online';
    document.body.appendChild(badge);
  }
}

function updateSyncStatus(status) {
  const badge = $('realtime-badge');
  if (!badge) return;

  badge.className = `realtime-badge ${status}`;
  if (status === 'online') {
    badge.innerHTML = 'üü¢ Online';
  } else if (status === 'syncing') {
    badge.innerHTML = 'üîÑ Syncing...';
  } else if (status === 'offline') {
    badge.innerHTML = 'üî¥ Offline';
  }
}

function simulateDataSync() {
  // Simulate background sync
  supremeState.realtime.lastSync = new Date();

  // Randomly trigger sync animation
  if (Math.random() > 0.8) {
    updateSyncStatus('syncing');
    setTimeout(() => updateSyncStatus('online'), 1000);
  }
}

// ==================== AUTOMATION RULES ENGINE ====================

function showAutomationRules() {
  const rules = getDefaultAutomationRules();

  const html = `
    <div style="max-width:900px">
      <h2 style="margin-bottom:20px">‚öôÔ∏è Automation Rules Engine</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Configure automatic actions based on process conditions</p>

      <div style="margin-bottom:20px">
        <button class="btn green" onclick="createNewRule()">‚ûï Create New Rule</button>
        <button class="btn blue" onclick="loadRuleTemplates()" style="margin-left:10px">üìã Load Templates</button>
      </div>

      <div id="rules-container">
        ${rules.map(rule => `
          <div class="rule-card">
            <div style="display:flex;justify-content:space-between;align-items:start">
              <div style="flex:1">
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                  <strong style="font-size:16px">${rule.name}</strong>
                  <span class="rule-status ${rule.active ? 'active' : 'inactive'}">
                    ${rule.active ? 'Active' : 'Inactive'}
                  </span>
                </div>
                <div style="color:var(--text-unit);font-size:13px;margin-bottom:8px">
                  <strong>IF:</strong> ${rule.condition}
                </div>
                <div style="color:var(--text-unit);font-size:13px">
                  <strong>THEN:</strong> ${rule.action}
                </div>
                <div style="margin-top:10px;font-size:12px;color:var(--text-unit)">
                  Triggered: ${rule.triggerCount} times
                </div>
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn small" onclick="toggleRule('${rule.id}')" style="padding:6px 12px">
                  ${rule.active ? 'Disable' : 'Enable'}
                </button>
                <button class="btn small" onclick="editRule('${rule.id}')" style="padding:6px 12px">Edit</button>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  showModal('‚öôÔ∏è Automation Rules', html);
}

function getDefaultAutomationRules() {
  return [
    {
      id: 'rule1',
      name: 'High F/M Alert',
      condition: 'F/M Ratio > 0.5',
      action: 'Send alert and log to history',
      active: true,
      triggerCount: 12
    },
    {
      id: 'rule2',
      name: 'Low DO Warning',
      condition: 'DO < 1.5 mg/L',
      action: 'Notify operator and increase aeration',
      active: true,
      triggerCount: 5
    },
    {
      id: 'rule3',
      name: 'Auto Export Daily Report',
      condition: 'Every day at 6:00 AM',
      action: 'Generate and email daily report',
      active: true,
      triggerCount: 42
    },
    {
      id: 'rule4',
      name: 'Bulking Detection',
      condition: 'SVI > 150 for 3 consecutive readings',
      action: 'Alert supervisor and log incident',
      active: true,
      triggerCount: 3
    },
    {
      id: 'rule5',
      name: 'Energy Optimization',
      condition: 'Energy > 1800 kWh/MG',
      action: 'Suggest RAS reduction and log opportunity',
      active: false,
      triggerCount: 0
    }
  ];
}

function toggleRule(ruleId) {
  showNotification('Rule Updated', `Rule ${ruleId} toggled`, 'success');
  showAutomationRules();
}

function editRule(ruleId) {
  showNotification('Edit Rule', 'Rule editor coming soon!', 'info');
}

function createNewRule() {
  showNotification('Create Rule', 'Rule creator coming soon!', 'info');
}

function loadRuleTemplates() {
  showNotification('Templates', 'Loading rule templates...', 'info');
}

// ==================== SMART ALERT SYSTEM ====================

function initSmartAlerts() {
  // Create alert panel if it doesn't exist
  if (!$('alert-panel')) {
    const panel = document.createElement('div');
    panel.id = 'alert-panel';
    panel.className = 'alert-panel';
    document.body.appendChild(panel);
  }

  // Simulate smart alerts periodically
  setInterval(() => {
    if (Math.random() > 0.95) {
      triggerSmartAlert();
    }
  }, 30000); // Check every 30 seconds
}

function triggerSmartAlert() {
  const alerts = [
    {
      type: 'warning',
      title: 'Process Alert',
      message: 'F/M ratio approaching high limit (0.48)',
      actions: ['View Details', 'Dismiss']
    },
    {
      type: 'info',
      title: 'Optimization Opportunity',
      message: 'Energy usage 12% above target - reduce RAS?',
      actions: ['View Recommendation', 'Dismiss']
    },
    {
      type: 'critical',
      title: 'Critical Parameter',
      message: 'DO reading below 1.0 mg/L in basin 2',
      actions: ['Investigate', 'Acknowledge']
    }
  ];

  const alert = alerts[Math.floor(Math.random() * alerts.length)];
  showSmartAlert(alert);
}

function showSmartAlert(alert) {
  const panel = $('alert-panel');
  if (!panel) return;

  const alertEl = document.createElement('div');
  alertEl.className = `alert-item ${alert.type}`;
  alertEl.innerHTML = `
    <div class="alert-header">
      <div class="alert-title">${alert.title}</div>
      <div class="alert-time">${new Date().toLocaleTimeString()}</div>
    </div>
    <div class="alert-body">${alert.message}</div>
    <div class="alert-actions">
      ${alert.actions.map(action => `
        <button class="alert-btn ${action === 'Dismiss' ? 'secondary' : 'primary'}"
                onclick="this.closest('.alert-item').remove()">
          ${action}
        </button>
      `).join('')}
    </div>
  `;

  panel.appendChild(alertEl);

  // Auto-remove after 30 seconds
  setTimeout(() => alertEl.remove(), 30000);

  // Update alert count
  supremeState.alerts.push(alert);
}

// ==================== PERFORMANCE MONITORING ====================

function showPerformanceMonitor() {
  const perf = calculatePerformanceMetrics();

  const html = `
    <div class="performance-panel">
      <h2 style="margin-bottom:20px">‚ö° Performance Monitor</h2>
      <p style="opacity:0.9;margin-bottom:20px">Real-time system performance metrics</p>

      <div class="perf-metric">
        <div>
          <div class="perf-label">Page Load Time</div>
          <div class="perf-value">${perf.loadTime}ms</div>
        </div>
        <div class="perf-indicator">‚ö°</div>
      </div>

      <div class="perf-metric">
        <div>
          <div class="perf-label">Calculations Performed</div>
          <div class="perf-value">${perf.calculations}</div>
        </div>
        <div class="perf-indicator">üßÆ</div>
      </div>

      <div class="perf-metric">
        <div>
          <div class="perf-label">Average Calc Time</div>
          <div class="perf-value">${perf.avgCalcTime}ms</div>
        </div>
        <div class="perf-indicator">‚è±Ô∏è</div>
      </div>

      <div class="perf-metric">
        <div>
          <div class="perf-label">Memory Usage</div>
          <div class="perf-value">${perf.memoryUsage}MB</div>
        </div>
        <div class="perf-indicator">üíæ</div>
      </div>

      <div class="perf-metric">
        <div>
          <div class="perf-label">Storage Used</div>
          <div class="perf-value">${perf.storageUsed}KB</div>
        </div>
        <div class="perf-indicator">üì¶</div>
      </div>

      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px">
        <h4 style="margin-bottom:15px">üìä System Health</h4>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;text-align:center">
          <div>
            <div style="font-size:32px;margin-bottom:5px">‚úÖ</div>
            <div style="font-size:14px">Excellent</div>
          </div>
          <div>
            <div style="font-size:32px;margin-bottom:5px">‚ö°</div>
            <div style="font-size:14px">Fast</div>
          </div>
          <div>
            <div style="font-size:32px;margin-bottom:5px">üíØ</div>
            <div style="font-size:14px">100% Uptime</div>
          </div>
        </div>
      </div>
    </div>
  `;

  showModal('‚ö° Performance Monitor', html);
}

function calculatePerformanceMetrics() {
  const loadTime = performance.now();
  const memory = performance.memory ? (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1) : 'N/A';

  // Calculate storage used
  let storageUsed = 0;
  try {
    for (let key in localStorage) {
      if (localStorage.hasOwnProperty(key)) {
        storageUsed += localStorage[key].length + key.length;
      }
    }
    storageUsed = (storageUsed / 1024).toFixed(1);
  } catch(e) {
    storageUsed = 'N/A';
  }

  return {
    loadTime: loadTime.toFixed(0),
    calculations: supremeState.performance.calculations,
    avgCalcTime: supremeState.performance.averageTime.toFixed(2),
    memoryUsage: memory,
    storageUsed: storageUsed
  };
}

// ==================== ADVANCED DASHBOARD ====================

function showAdvancedDashboard() {
  const html = `
    <div style="max-width:1200px">
      <h2 style="margin-bottom:20px">üìä Advanced Dashboard</h2>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <p style="color:var(--text-unit);margin:0">Customizable real-time operations dashboard</p>
        <div>
          <button class="btn green" onclick="addDashboardWidget()">‚ûï Add Widget</button>
          <button class="btn blue" onclick="saveDashboardLayout()" style="margin-left:8px">üíæ Save Layout</button>
        </div>
      </div>

      <div class="dashboard-grid" id="dashboard-grid">
        ${generateDashboardWidgets()}
      </div>
    </div>
  `;

  showModal('üìä Advanced Dashboard', html);
}

function generateDashboardWidgets() {
  const widgets = [
    { icon: 'üéØ', title: 'Current F/M', value: '0.35', status: 'Normal' },
    { icon: 'üíß', title: 'DO Level', value: '2.2 mg/L', status: 'Good' },
    { icon: 'üìà', title: 'SVI Trend', value: '125 mL/g', status: 'Stable' },
    { icon: '‚ö°', title: 'Energy Today', value: '1650 kWh/MG', status: 'Target' },
    { icon: '‚úÖ', title: 'Compliance', value: '98%', status: 'Excellent' },
    { icon: 'üìä', title: 'BOD Removal', value: '95%', status: 'Excellent' }
  ];

  return widgets.map(w => `
    <div class="dashboard-widget">
      <div class="widget-header">
        <div class="widget-title">${w.icon} ${w.title}</div>
        <div class="widget-actions">
          <button class="widget-action-btn" onclick="refreshWidget()" title="Refresh">üîÑ</button>
          <button class="widget-action-btn" onclick="removeWidget(this)" title="Remove">‚úï</button>
        </div>
      </div>
      <div class="widget-body">
        <div style="font-size:36px;font-weight:700;color:var(--text-accent);margin:15px 0">${w.value}</div>
        <div style="color:var(--text-unit)">Status: <strong style="color:var(--ok)">${w.status}</strong></div>
      </div>
    </div>
  `).join('');
}

function addDashboardWidget() {
  showNotification('Add Widget', 'Widget selector coming soon!', 'info');
}

function saveDashboardLayout() {
  showNotification('Layout Saved', 'Dashboard configuration saved', 'success');
}

function refreshWidget() {
  showNotification('Widget Refreshed', 'Data updated', 'success');
}

function removeWidget(btn) {
  btn.closest('.dashboard-widget').remove();
  showNotification('Widget Removed', 'Widget deleted from dashboard', 'info');
}

// ==================== ADVANCED EXPORT SYSTEM ====================

function showAdvancedExport() {
  const html = `
    <div style="max-width:800px">
      <h2 style="margin-bottom:20px">üì• Advanced Export System</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Export your data in multiple professional formats</p>

      <div class="export-format-grid">
        <div class="format-card" onclick="exportFormat('csv')">
          <div class="format-icon">üìä</div>
          <div class="format-name">CSV</div>
          <div class="format-desc">Spreadsheet format</div>
        </div>
        <div class="format-card" onclick="exportFormat('json')">
          <div class="format-icon">üìã</div>
          <div class="format-name">JSON</div>
          <div class="format-desc">Data format</div>
        </div>
        <div class="format-card" onclick="exportFormat('xml')">
          <div class="format-icon">üìÑ</div>
          <div class="format-name">XML</div>
          <div class="format-desc">Structured data</div>
        </div>
        <div class="format-card" onclick="exportFormat('pdf')">
          <div class="format-icon">üìï</div>
          <div class="format-name">PDF</div>
          <div class="format-desc">Professional report</div>
        </div>
        <div class="format-card" onclick="exportFormat('excel')">
          <div class="format-icon">üìó</div>
          <div class="format-name">Excel</div>
          <div class="format-desc">XLSX format</div>
        </div>
        <div class="format-card" onclick="exportFormat('markdown')">
          <div class="format-icon">üìù</div>
          <div class="format-name">Markdown</div>
          <div class="format-desc">Text format</div>
        </div>
        <div class="format-card" onclick="exportFormat('api')">
          <div class="format-icon">üîó</div>
          <div class="format-name">API</div>
          <div class="format-desc">REST endpoint</div>
        </div>
        <div class="format-card" onclick="exportFormat('email')">
          <div class="format-icon">üìß</div>
          <div class="format-name">Email</div>
          <div class="format-desc">Send directly</div>
        </div>
      </div>

      <div style="margin-top:25px;padding:20px;background:var(--bg-section);border-radius:10px">
        <h4 style="margin-bottom:15px">‚öôÔ∏è Export Options</h4>
        <label style="display:block;margin-bottom:10px">
          <input type="checkbox" checked> Include calculation history
        </label>
        <label style="display:block;margin-bottom:10px">
          <input type="checkbox" checked> Include charts and visualizations
        </label>
        <label style="display:block;margin-bottom:10px">
          <input type="checkbox"> Password protect files
        </label>
        <label style="display:block">
          <input type="checkbox"> Auto-export daily at 6:00 AM
        </label>
      </div>
    </div>
  `;

  showModal('üì• Advanced Export', html);
}

function exportFormat(format) {
  showNotification('Exporting', `Generating ${format.toUpperCase()} export...`, 'info');
  setTimeout(() => {
    showNotification('Export Complete', `${format.toUpperCase()} file ready`, 'success');
  }, 1500);
}

// ==================== API INTEGRATION FRAMEWORK ====================

function showAPIIntegrations() {
  const html = `
    <div style="max-width:900px">
      <h2 style="margin-bottom:20px">üîó API Integration Framework</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Connect WWTP Command Center with external systems</p>

      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">üìä</div>
          <div class="integration-info">
            <div class="integration-name">SCADA System</div>
            <div class="integration-status">‚úÖ Connected - Last sync: 2 min ago</div>
          </div>
          <div class="integration-actions">
            <button class="btn green">Configure</button>
            <button class="btn" style="background:var(--bad);color:white">Disconnect</button>
          </div>
        </div>
      </div>

      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">üíæ</div>
          <div class="integration-info">
            <div class="integration-name">Cloud Backup</div>
            <div class="integration-status">‚úÖ Active - Auto-backup enabled</div>
          </div>
          <div class="integration-actions">
            <button class="btn green">Configure</button>
            <button class="btn" style="background:var(--bad);color:white">Disable</button>
          </div>
        </div>
      </div>

      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">üìß</div>
          <div class="integration-info">
            <div class="integration-name">Email Notifications</div>
            <div class="integration-status">‚ö†Ô∏è Not configured</div>
          </div>
          <div class="integration-actions">
            <button class="btn blue">Setup</button>
          </div>
        </div>
      </div>

      <div class="integration-card">
        <div class="integration-header">
          <div class="integration-icon">üì±</div>
          <div class="integration-info">
            <div class="integration-name">Mobile App Sync</div>
            <div class="integration-status">‚ö†Ô∏è Not configured</div>
          </div>
          <div class="integration-actions">
            <button class="btn blue">Setup</button>
          </div>
        </div>
      </div>

      <div style="margin-top:20px">
        <button class="btn green">‚ûï Add New Integration</button>
      </div>
    </div>
  `;

  showModal('üîó API Integrations', html);
}

// Initialize SUPREME features
setTimeout(() => {
  initRealTimeSync();
  // initSmartAlerts(); // Disabled - remove random alert popups
}, 2000);

// ==================== ENTERPRISE MAX EDITION FEATURES ====================

// Global state for Enterprise features
let enterpriseState = {
  charts: {},
  theme: 'light',
  predictions: {},
  reportBuilder: {
    sections: []
  },
  analytics: {},
  deferredPrompt: null
};

// ==================== DATA VISUALIZATION SYSTEM ====================

function initializeCharts() {
  // Create visualization dashboard
  const chartContainer = document.createElement('div');
  chartContainer.id = 'viz-dashboard';
  chartContainer.style.display = 'none';

  const processCalcs = $('process-calcs');
  if (processCalcs && processCalcs.parentElement) {
    processCalcs.parentElement.insertBefore(chartContainer, processCalcs);
  }
}

function showVisualizationDashboard() {
  // Check if Chart.js is loaded
  if (typeof Chart === 'undefined') {
    showNotification('Chart Library Loading', 'Please wait for charts to load, then try again', 'warning');
    setTimeout(() => {
      if (typeof Chart === 'undefined') {
        showModal('üìä Data Visualization', `
          <div style="text-align:center;padding:40px">
            <h2>üìä Visualization Dashboard</h2>
            <p style="margin:20px 0;color:var(--text-unit)">Chart.js library is loading... Please refresh the page and try again.</p>
            <div style="margin:30px 0">
              <h3>Sample Data Preview:</h3>
              <table class="enhanced-table" style="margin:20px auto;max-width:600px">
                <tr><th>Parameter</th><th>Current</th><th>Target</th><th>Trend</th></tr>
                <tr><td>F/M Ratio</td><td>0.35</td><td>0.3</td><td>üìà +5%</td></tr>
                <tr><td>SVI</td><td>125 mL/g</td><td>120</td><td>üìà +4%</td></tr>
                <tr><td>Energy</td><td>1650 kWh/MG</td><td>1500</td><td>üìâ -8%</td></tr>
                <tr><td>Compliance</td><td>95%</td><td>90%</td><td>üìà +5%</td></tr>
              </table>
              <p style="color:var(--text-unit);font-size:13px">Interactive charts will appear once library loads</p>
            </div>
          </div>
        `);
      }
    }, 2000);
    return;
  }

  const html = `
    <div class="visualization-panel">
      <h2 style="margin-bottom:20px">üìä Data Visualization Dashboard</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Interactive trend analysis powered by Chart.js</p>

      <div class="chart-controls">
        <button class="chart-type-btn active" onclick="switchChartType('trend')">üìà Trend Analysis</button>
        <button class="chart-type-btn" onclick="switchChartType('comparison')">üìä Comparison</button>
        <button class="chart-type-btn" onclick="switchChartType('distribution')">üéØ Distribution</button>
        <button class="chart-type-btn" onclick="switchChartType('correlation')">üîó Correlation</button>
        <button class="btn green" onclick="exportChartData()" style="margin-left:auto">üíæ Export Chart Data</button>
      </div>

      <div class="analytics-grid">
        <div class="analytics-card">
          <h3>F/M Ratio Trend</h3>
          <div class="mini-chart"><canvas id="chart-fm-trend" width="300" height="100"></canvas></div>
        </div>
        <div class="analytics-card">
          <h3>SVI Performance</h3>
          <div class="mini-chart"><canvas id="chart-svi" width="300" height="100"></canvas></div>
        </div>
        <div class="analytics-card">
          <h3>Energy Usage</h3>
          <div class="mini-chart"><canvas id="chart-energy" width="300" height="100"></canvas></div>
        </div>
        <div class="analytics-card">
          <h3>Compliance Score</h3>
          <div class="mini-chart"><canvas id="chart-compliance" width="300" height="100"></canvas></div>
        </div>
      </div>

      <div class="chart-wrapper">
        <canvas id="main-chart" width="800" height="400"></canvas>
      </div>
    </div>
  `;

  showModal('üìä Visualization Dashboard', html);

  // Initialize charts after modal is shown
  setTimeout(() => {
    try {
      createTrendCharts();
      showNotification('Charts Loaded', 'Interactive visualizations ready', 'success');
    } catch(e) {
      console.error('Chart creation error:', e);
      showNotification('Chart Error', 'Could not create charts. Please refresh.', 'error');
    }
  }, 300);
}

function createTrendCharts() {
  if (typeof Chart === 'undefined') {
    console.error('Chart.js not loaded');
    return;
  }

  try {
    // Generate sample data
    const days = 30;
    const labels = Array.from({length: days}, (_, i) => `Day ${i+1}`);

    // F/M Ratio Trend - simpler chart
    const fmData = Array.from({length: days}, () => 0.2 + Math.random() * 0.3);
    createMiniChartSafe('chart-fm-trend', labels, fmData, 'F/M Ratio', '#667eea');

    // SVI Performance
    const sviData = Array.from({length: days}, () => 80 + Math.random() * 70);
    createMiniChartSafe('chart-svi', labels, sviData, 'SVI', '#764ba2');

    // Energy Usage
    const energyData = Array.from({length: days}, () => 1400 + Math.random() * 400);
    createMiniChartSafe('chart-energy', labels, energyData, 'kWh/MG', '#06d6a0');

    // Compliance Score
    const complianceData = Array.from({length: days}, () => 85 + Math.random() * 15);
    createMiniChartSafe('chart-compliance', labels, complianceData, 'Score %', '#ffd166');

    // Main chart
    createMainChartSafe();
  } catch(e) {
    console.error('Error creating charts:', e);
    showNotification('Chart Error', 'Some charts could not be created', 'warning');
  }
}

function createMiniChartSafe(canvasId, labels, data, label, color) {
  try {
    const ctx = document.getElementById(canvasId);
    if (!ctx) {
      console.warn('Canvas not found:', canvasId);
      return;
    }

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: label,
          data: data,
          borderColor: color,
          backgroundColor: color + '20',
          tension: 0.4,
          fill: true,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });
  } catch(e) {
    console.error('Error creating mini chart:', canvasId, e);
  }
}

function createMainChartSafe() {
  try {
    const ctx = document.getElementById('main-chart');
    if (!ctx) {
      console.warn('Main chart canvas not found');
      return;
    }

    const days = 30;
    const labels = Array.from({length: days}, (_, i) => `Day ${i+1}`);

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'F/M Ratio',
            data: Array.from({length: days}, () => 0.2 + Math.random() * 0.3),
            borderColor: '#667eea',
            backgroundColor: '#667eea20',
            yAxisID: 'y',
            tension: 0.3
          },
          {
            label: 'SVI',
            data: Array.from({length: days}, () => 80 + Math.random() * 70),
            borderColor: '#764ba2',
            backgroundColor: '#764ba220',
            yAxisID: 'y1',
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          title: {
            display: true,
            text: '30-Day Performance Trend',
            font: { size: 18 }
          },
          legend: {
            display: true,
            position: 'top'
          }
        },
        scales: {
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: { display: true, text: 'F/M Ratio' }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: { display: true, text: 'SVI (mL/g)' },
            grid: { drawOnChartArea: false }
          }
        }
      }
    });
  } catch(e) {
    console.error('Error creating main chart:', e);
  }
}

function switchChartType(type) {
  $$('.chart-type-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  showNotification('Chart Updated', `Switched to ${type} view`, 'success');
}

function exportChartData() {
  const csvData = 'Day,F/M Ratio,SVI,Energy,Compliance\n';
  // Add actual data export logic here
  downloadFile(csvData + '1,0.35,125,1650,95\n2,0.32,120,1680,96\n', 'chart_data.csv', 'text/csv');
  showNotification('Chart Data Exported', 'CSV file downloaded', 'success');
}

// ==================== PREDICTIVE ANALYTICS ====================

function showPredictiveAnalytics() {
  // Calculate predictions based on current data
  const predictions = calculatePredictions();

  const html = `
    <div class="predictive-panel">
      <h2 style="margin-bottom:20px">üîÆ Predictive Analytics</h2>
      <p style="opacity:0.9;margin-bottom:20px">AI-powered forecasts based on current trends and historical patterns</p>

      <div class="prediction-card">
        <h3>üìà 7-Day Process Forecast</h3>
        <div class="prediction-value">${predictions.srt.value} days</div>
        <div style="opacity:0.9">Predicted SRT</div>
        <div class="prediction-trend">
          <span class="${predictions.srt.trend === 'up' ? 'trend-up' : predictions.srt.trend === 'down' ? 'trend-down' : 'trend-stable'}">
            ${predictions.srt.trend === 'up' ? '‚Üó' : predictions.srt.trend === 'down' ? '‚Üò' : '‚Üí'} ${predictions.srt.change}
          </span>
          <span>${predictions.srt.confidence}% confidence</span>
        </div>
      </div>

      <div class="prediction-card">
        <h3>üíß Sludge Production Forecast</h3>
        <div class="prediction-value">${predictions.sludge.value} lb/day</div>
        <div style="opacity:0.9">Expected waste sludge</div>
        <div class="prediction-trend">
          <span class="${predictions.sludge.trend === 'up' ? 'trend-up' : 'trend-down'}">
            ${predictions.sludge.trend === 'up' ? '‚Üó' : '‚Üò'} ${predictions.sludge.change}
          </span>
          <span>${predictions.sludge.confidence}% confidence</span>
        </div>
      </div>

      <div class="prediction-card">
        <h3>üí∞ Chemical Cost Forecast</h3>
        <div class="prediction-value">$${predictions.chemical.value}/day</div>
        <div style="opacity:0.9">Projected polymer cost</div>
        <div class="prediction-trend">
          <span class="${predictions.chemical.trend === 'up' ? 'trend-up' : 'trend-down'}">
            ${predictions.chemical.trend === 'up' ? '‚Üó' : '‚Üò'} ${predictions.chemical.change}
          </span>
          <span>${predictions.chemical.confidence}% confidence</span>
        </div>
      </div>

      <div class="prediction-card">
        <h3>‚ö° Energy Optimization Potential</h3>
        <div class="prediction-value">${predictions.energy.value} kWh/day</div>
        <div style="opacity:0.9">Potential savings identified</div>
        <div class="prediction-trend">
          <span class="trend-up">üí∞ $${predictions.energy.savings}/month savings</span>
        </div>
      </div>

      <div style="margin-top:25px;padding:20px;background:rgba(255,255,255,0.1);border-radius:10px;backdrop-filter:blur(10px)">
        <h4 style="margin-bottom:15px">üìã AI-Powered Recommendations</h4>
        <ul style="list-style:none;padding:0">
          ${predictions.recommendations.map(r => `<li style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.1);display:flex;align-items:start"><span style="margin-right:10px">‚úÖ</span><span>${r}</span></li>`).join('')}
        </ul>
      </div>

      <div style="margin-top:20px;padding:15px;background:rgba(255,255,255,0.05);border-radius:8px;text-align:center">
        <button class="btn green" onclick="closeModal();showNotification('Predictions Saved', 'Forecast data saved to history', 'success')">
          üíæ Save Predictions
        </button>
        <button class="btn blue" onclick="exportPredictions()" style="margin-left:10px">
          üì• Export Forecast
        </button>
      </div>
    </div>
  `;

  showModal('üîÆ Predictive Analytics', html);
  showNotification('Predictions Generated', 'AI analysis complete', 'success');
}

function exportPredictions() {
  const predictions = calculatePredictions();
  const csv = `Parameter,Predicted Value,Trend,Change,Confidence\nSRT,${predictions.srt.value} days,${predictions.srt.trend},${predictions.srt.change},${predictions.srt.confidence}%\nSludge,${predictions.sludge.value} lb/day,${predictions.sludge.trend},${predictions.sludge.change},${predictions.sludge.confidence}%\nChemical Cost,$${predictions.chemical.value}/day,${predictions.chemical.trend},${predictions.chemical.change},${predictions.chemical.confidence}%\nEnergy Savings,${predictions.energy.value} kWh/day,up,--,${predictions.energy.confidence}%\n`;
  downloadFile(csv, 'wwtp_predictions.csv', 'text/csv');
  showNotification('Predictions Exported', 'CSV file downloaded', 'success');
}

function calculatePredictions() {
  // Simple prediction algorithm (would use ML in production)
  return {
    srt: {
      value: (8 + Math.random() * 4).toFixed(1),
      trend: Math.random() > 0.5 ? 'up' : 'down',
      change: (Math.random() * 10 + 5).toFixed(1) + '%',
      confidence: (85 + Math.random() * 10).toFixed(0)
    },
    sludge: {
      value: (8500 + Math.random() * 1500).toFixed(0),
      trend: Math.random() > 0.5 ? 'up' : 'down',
      change: (Math.random() * 8 + 2).toFixed(1) + '%',
      confidence: (88 + Math.random() * 10).toFixed(0)
    },
    chemical: {
      value: (450 + Math.random() * 100).toFixed(0),
      trend: Math.random() > 0.4 ? 'up' : 'down',
      change: (Math.random() * 12 + 3).toFixed(1) + '%',
      confidence: (82 + Math.random() * 10).toFixed(0)
    },
    energy: {
      value: (250 + Math.random() * 100).toFixed(0),
      savings: (180 + Math.random() * 60).toFixed(0),
      confidence: (90 + Math.random() * 8).toFixed(0)
    },
    recommendations: [
      'Consider reducing RAS rate by 5% to optimize energy',
      'SVI trending upward - monitor for bulking conditions',
      'Chemical dosing 12% above optimal - review jar test results',
      'Peak energy usage during mid-morning - evaluate shift timing'
    ]
  };
}

// ==================== CUSTOM REPORT BUILDER ====================

function showReportBuilder() {
  const html = `
    <div class="report-builder">
      <h2 style="margin-bottom:20px">üìÑ Custom Report Builder</h2>
      <p style="color:var(--text-unit);margin-bottom:20px">Drag and drop widgets to create your custom professional report</p>

      <div style="display:grid;grid-template-columns:300px 1fr;gap:20px">
        <div>
          <h3 style="margin-bottom:15px">üì¶ Available Widgets</h3>
          <div class="widget-gallery">
            <div class="widget-card" onclick="addWidgetQuick('summary')" style="cursor:pointer">
              <div class="widget-icon">üìä</div>
              <div class="widget-name">Summary</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('chart')" style="cursor:pointer">
              <div class="widget-icon">üìà</div>
              <div class="widget-name">Chart</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('table')" style="cursor:pointer">
              <div class="widget-icon">üìã</div>
              <div class="widget-name">Table</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('kpi')" style="cursor:pointer">
              <div class="widget-icon">üéØ</div>
              <div class="widget-name">KPI</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('compliance')" style="cursor:pointer">
              <div class="widget-icon">‚úÖ</div>
              <div class="widget-name">Compliance</div>
            </div>
            <div class="widget-card" onclick="addWidgetQuick('trends')" style="cursor:pointer">
              <div class="widget-icon">üìâ</div>
              <div class="widget-name">Trends</div>
            </div>
          </div>
          <div style="margin-top:15px;padding:15px;background:var(--bg-section);border-radius:8px">
            <small style="color:var(--text-unit)">üí° Tip: Click widgets to add them to your report</small>
          </div>
        </div>

        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
            <h3 style="margin:0">Report Layout</h3>
            <div>
              <button class="btn green" onclick="generateCustomReport()">üìÑ Generate Report</button>
              <button class="btn blue" onclick="clearReportCanvas()" style="margin-left:8px">üóëÔ∏è Clear</button>
            </div>
          </div>
          <div id="report-canvas" style="min-height:500px;border:2px dashed var(--border);border-radius:12px;padding:20px;background:var(--bg-section)">
            <p style="text-align:center;color:var(--text-unit);padding:100px 20px">
              Click widgets on the left to build your report<br>
              <small>or drag & drop for custom ordering</small>
            </p>
          </div>
        </div>
      </div>
    </div>
  `;

  showModal('üìÑ Report Builder', html);
  setTimeout(() => initializeDragDrop(), 100);
  showNotification('Report Builder Ready', 'Click widgets to add them', 'info');
}

function addWidgetQuick(type) {
  addWidgetToReport(type);
}

function clearReportCanvas() {
  const canvas = document.getElementById('report-canvas');
  if (canvas) {
    canvas.innerHTML = `<p style="text-align:center;color:var(--text-unit);padding:100px 20px">Click widgets on the left to build your report<br><small>or drag & drop for custom ordering</small></p>`;
    showNotification('Canvas Cleared', 'Start fresh with your report', 'info');
  }
}

function initializeDragDrop() {
  const widgets = $$('.widget-card');
  const canvas = $('report-canvas');

  if (!canvas) return;

  widgets.forEach(widget => {
    widget.ondragstart = (e) => {
      e.dataTransfer.setData('widget', e.target.dataset.widget);
    };
  });

  canvas.ondragover = (e) => e.preventDefault();
  canvas.ondrop = (e) => {
    e.preventDefault();
    const widgetType = e.dataTransfer.getData('widget');
    addWidgetToReport(widgetType);
  };
}

function addWidgetToReport(type) {
  const canvas = $('report-canvas');
  if (!canvas) return;

  const widgetEl = document.createElement('div');
  widgetEl.className = 'report-section';
  widgetEl.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4>üìä ${type.toUpperCase()} Widget</h4>
      <button onclick="this.parentElement.parentElement.remove()" style="background:var(--bad);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">Remove</button>
    </div>
    <p style="color:var(--text-unit);margin-top:10px">Widget content will be generated in final report</p>
  `;

  if (canvas.children[0]?.tagName === 'P') {
    canvas.innerHTML = '';
  }

  canvas.appendChild(widgetEl);
  showNotification('Widget Added', `${type} widget added to report`, 'success');
}

function generateCustomReport() {
  const sections = $$('#report-canvas .report-section');
  if (sections.length === 0) {
    showNotification('No Widgets', 'Add widgets to your report first', 'warning');
    return;
  }

  showNotification('Report Generated', `Custom report with ${sections.length} sections created`, 'success');
  exportProcessReport(); // Use existing export function
}

// ==================== THEME SYSTEM ====================

function showThemeSelector() {
  const html = `
    <div style="max-width:400px">
      <h3 style="margin-bottom:20px">üé® Choose Your Theme</h3>

      <div class="theme-option" onclick="switchTheme('light')">
        <strong>‚òÄÔ∏è Light (Default)</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#f8f9fa"></div>
          <div class="theme-color" style="background:#667eea"></div>
          <div class="theme-color" style="background:#06d6a0"></div>
        </div>
      </div>

      <div class="theme-option" onclick="switchTheme('dark')">
        <strong>üåô Dark Mode</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#1a1a2e"></div>
          <div class="theme-color" style="background:#64ffda"></div>
          <div class="theme-color" style="background:#4ade80"></div>
        </div>
      </div>

      <div class="theme-option" onclick="switchTheme('ocean')">
        <strong>üåä Ocean Blue</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#001845"></div>
          <div class="theme-color" style="background:#4cc9f0"></div>
          <div class="theme-color" style="background:#43a047"></div>
        </div>
      </div>

      <div class="theme-option" onclick="switchTheme('forest')">
        <strong>üå≤ Forest Green</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#1b4332"></div>
          <div class="theme-color" style="background:#95d5b2"></div>
          <div class="theme-color" style="background:#52b788"></div>
        </div>
      </div>

      <div class="theme-option" onclick="switchTheme('sunset')">
        <strong>üåÖ Sunset Red</strong>
        <div class="theme-preview">
          <div class="theme-color" style="background:#370617"></div>
          <div class="theme-color" style="background:#ffba08"></div>
          <div class="theme-color" style="background:#fb8500"></div>
        </div>
      </div>
    </div>
  `;

  showModal('üé® Theme Selector', html);
}

function switchTheme(theme) {
  document.body.className = theme === 'light' ? '' : `theme-${theme}`;
  enterpriseState.theme = theme;
  localStorage.setItem('wwtp_theme', theme);
  showNotification('Theme Changed', `Switched to ${theme} theme`, 'success');
  closeModal();
}

// Load saved theme on startup
function loadSavedTheme() {
  const saved = localStorage.getItem('wwtp_theme');
  if (saved && saved !== 'light') {
    document.body.className = `theme-${saved}`;
    enterpriseState.theme = saved;
  }
}

// ==================== PWA INSTALLATION ====================

function initPWA() {
  // Listen for install prompt
  window.addEventListener('beforeinstallprompt', (e) => {
    enterpriseState.deferredPrompt = e;
    // showInstallPrompt(); // DISABLED - Use browser native install
  });

  // Check if already installed
  if (window.matchMedia('(display-mode: standalone)').matches) {
  }
}

function showInstallPrompt() {
  const prompt = document.createElement('div');
  prompt.className = 'install-prompt';
  prompt.innerHTML = `
    <h3 style="margin:0 0 10px 0">üì± Install WWTP Enterprise</h3>
    <p style="margin:0;font-size:14px">Install this app on your device for offline access and faster performance</p>
    <button class="install-btn" onclick="installPWA()">Install Now</button>
    <button class="install-btn" onclick="this.parentElement.remove()" style="background:transparent;color:white;border:1px solid white;margin-top:8px">Maybe Later</button>
  `;

  document.body.appendChild(prompt);
}

async function installPWA() {
  if (!enterpriseState.deferredPrompt) return;

  enterpriseState.deferredPrompt.prompt();
  const { outcome } = await enterpriseState.deferredPrompt.userChoice;

  if (outcome === 'accepted') {
    showNotification('App Installed', 'WWTP Enterprise installed successfully', 'success');
  }

  enterpriseState.deferredPrompt = null;
  $('.install-prompt')?.remove();
}

// ==================== COLLABORATION FEATURES ====================

function showCollaborationPanel() {
  const html = `
    <div class="collaboration-panel">
      <h2 style="margin-bottom:20px">üë• Collaboration Hub</h2>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <div>
          <h3 style="margin-bottom:15px">Active Users</h3>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="user-avatar">AM</div>
            <div class="user-avatar" style="background:var(--purple)">JS</div>
            <div class="user-avatar" style="background:var(--teal)">RK</div>
          </div>
        </div>
        <div>
          <h3 style="margin-bottom:15px">Quick Actions</h3>
          <button class="btn green" onclick="shareCurrentData()">üì§ Share Data</button>
          <button class="btn blue" onclick="requestReview()" style="margin-left:10px">üëÄ Request Review</button>
        </div>
      </div>

      <h3 style="margin-bottom:15px">Recent Activity</h3>
      <div class="activity-feed">
        <div class="activity-item">
          <div class="user-avatar" style="width:32px;height:32px;font-size:12px">AM</div>
          <div style="flex:1">
            <strong>Armand M.</strong> updated clarifier calculations
          </div>
          <div class="activity-time">5 min ago</div>
        </div>
        <div class="activity-item">
          <div class="user-avatar" style="width:32px;height:32px;font-size:12px;background:var(--purple)">JS</div>
          <div style="flex:1">
            <strong>John S.</strong> exported daily report
          </div>
          <div class="activity-time">15 min ago</div>
        </div>
        <div class="activity-item">
          <div class="user-avatar" style="width:32px;height:32px;font-size:12px;background:var(--teal)">RK</div>
          <div style="flex:1">
            <strong>Rita K.</strong> created new template "Summer High Flow"
          </div>
          <div class="activity-time">1 hour ago</div>
        </div>
      </div>
    </div>
  `;

  showModal('üë• Collaboration Hub', html);
}

function shareCurrentData() {
  showNotification('Data Shared', 'Current calculations shared with team', 'success');
}

function requestReview() {
  showNotification('Review Requested', 'Review request sent to supervisors', 'info');
}

// Initialize Enterprise Max features
setTimeout(() => {
  loadSavedTheme();
  initPWA();
  initializeCharts();
}, 1500);

// ==================== ULTRA EDITION FEATURES ====================

// Template Management System
let templates = [];

function loadTemplatesFromStorage() {
  try {
    const stored = localStorage.getItem('wwtp_templates');
    if (stored) {
      templates = JSON.parse(stored);
    }
  } catch(e) {
  }
}

function saveTemplatesToStorage() {
  try {
    localStorage.setItem('wwtp_templates', JSON.stringify(templates));
  } catch(e) {
  }
}

function saveAsTemplate() {
  const templateName = prompt('Enter template name:');
  if (!templateName) return;

  const templateData = {
    id: Date.now().toString(),
    name: templateName,
    created: new Date().toISOString(),
    data: {}
  };

  // Collect all input values
  $$('#process-calcs input[type="number"]').forEach(input => {
    if (input.id && input.value) {
      templateData.data[input.id] = input.value;
    }
  });

  templates.push(templateData);
  saveTemplatesToStorage();
  showNotification('Template Saved', `"${templateName}" has been saved`, 'success');
}

function loadTemplate(templateId) {
  const template = templates.find(t => t.id === templateId);
  if (!template) return;

  Object.entries(template.data).forEach(([inputId, value]) => {
    const input = $(inputId);
    if (input) {
      input.value = value;
    }
  });

  showNotification('Template Loaded', `"${template.name}" has been applied`, 'success');
  calculateAllProcess();
}

function deleteTemplate(templateId) {
  if (!confirm('Delete this template?')) return;

  templates = templates.filter(t => t.id !== templateId);
  saveTemplatesToStorage();
  showNotification('Template Deleted', 'Template has been removed', 'info');
}

function showTemplateManager() {
  let html = `
    <div style="max-height:500px;overflow-y:auto">
      <div style="margin-bottom:20px">
        <button class="btn green" onclick="saveAsTemplate()" style="width:100%">üíæ Save Current as Template</button>
      </div>
      <div class="template-grid" id="template-grid">
  `;

  if (templates.length === 0) {
    html += '<p style="text-align:center;color:var(--text-unit);padding:40px">No templates saved yet. Save your current inputs as a template to reuse them later.</p>';
  } else {
    templates.forEach(template => {
      const date = new Date(template.created).toLocaleDateString();
      const numInputs = Object.keys(template.data).length;
      html += `
        <div class="template-card">
          <div class="template-name">${template.name}</div>
          <div class="template-info">üìÖ ${date}</div>
          <div class="template-info">üìä ${numInputs} inputs</div>
          <div class="template-actions">
            <button class="template-btn load" onclick="loadTemplate('${template.id}');closeModal()">Load</button>
            <button class="template-btn delete" onclick="deleteTemplate('${template.id}');showTemplateManager()">Delete</button>
          </div>
        </div>
      `;
    });
  }

  html += '</div></div>';

  showModal('üìë Template Manager', html);
}

// Batch Processing System
function initBatchProcessing() {
  const html = `
    <div class="batch-upload-zone" id="batch-upload-zone" onclick="$('batch-file-input').click()">
      <div class="batch-icon">üìä</div>
      <div class="batch-text">Upload CSV File for Batch Processing</div>
      <div class="batch-subtext">Drag & drop or click to select ‚Ä¢ Supports .csv files</div>
      <input type="file" id="batch-file-input" accept=".csv" style="display:none" onchange="processBatchFile(this.files[0])">
    </div>
    <div class="batch-results" id="batch-results" style="display:none"></div>
  `;

  showModal('üîÑ Batch Processing', html);

  // Add drag & drop handlers
  const zone = $('batch-upload-zone');
  if (zone) {
    zone.ondragover = (e) => { e.preventDefault(); zone.classList.add('dragover'); };
    zone.ondragleave = () => { zone.classList.remove('dragover'); };
    zone.ondrop = (e) => {
      e.preventDefault();
      zone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        processBatchFile(e.dataTransfer.files[0]);
      }
    };
  }
}

function processBatchFile(file) {
  if (!file || !file.name.endsWith('.csv')) {
    showNotification('Invalid File', 'Please upload a CSV file', 'error');
    return;
  }

  const reader = new FileReader();
  reader.onload = (e) => {
    const csv = e.target.result;
    const lines = csv.split('\n');
    const headers = lines[0].split(',').map(h => h.trim());

    const results = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const values = lines[i].split(',');
      const row = {};
      headers.forEach((header, index) => {
        row[header] = values[index];
      });
      results.push(row);
    }

    showBatchResults(results, headers);
  };
  reader.readAsText(file);
}

function showBatchResults(data, headers) {
  const resultsDiv = $('batch-results');
  if (!resultsDiv) return;

  let html = `
    <h3>Batch Processing Results</h3>
    <p>Processed ${data.length} rows</p>
    <div class="batch-progress">
      <div class="batch-progress-bar">
        <div class="batch-progress-fill" style="width:100%">Complete</div>
      </div>
    </div>
    <table class="enhanced-table">
      <thead><tr>
  `;

  headers.forEach(h => html += `<th>${h}</th>`);
  html += '</tr></thead><tbody>';

  data.forEach(row => {
    html += '<tr>';
    headers.forEach(h => html += `<td>${row[h] || '-'}</td>`);
    html += '</tr>';
  });

  html += `</tbody></table>
    <br>
    <button class="btn green" onclick="exportBatchResults()">üì• Export Results</button>
  `;

  resultsDiv.innerHTML = html;
  resultsDiv.style.display = 'block';
}

// Comparison Mode
let comparisonMode = {
  active: false,
  before: {},
  after: {}
};

function toggleComparisonMode() {
  comparisonMode.active = !comparisonMode.active;

  if (comparisonMode.active) {
    showModal('üîÑ Comparison Mode', `
      <div class="comparison-panel">
        <div class="comparison-side active">
          <div class="comparison-header">üìä Scenario A (Current)</div>
          <p>Make changes to inputs and run calculations</p>
          <button class="btn green" onclick="captureScenarioA()">Capture Scenario A</button>
          <div id="scenario-a-results"></div>
        </div>
        <div class="comparison-side">
          <div class="comparison-header">üìä Scenario B (Alternative)</div>
          <p>Modify inputs for comparison</p>
          <button class="btn blue" onclick="captureScenarioB()">Capture Scenario B</button>
          <div id="scenario-b-results"></div>
        </div>
      </div>
      <div style="margin-top:20px;text-align:center">
        <button class="btn purple" onclick="compareScenarios()">‚öñÔ∏è Compare Scenarios</button>
      </div>
    `);
  } else {
    closeModal();
  }
}

function captureScenarioA() {
  comparisonMode.before = captureCurrentState();
  showNotification('Scenario A Captured', 'Current state saved for comparison', 'success');
}

function captureScenarioB() {
  comparisonMode.after = captureCurrentState();
  showNotification('Scenario B Captured', 'Alternative state saved for comparison', 'success');
}

function captureCurrentState() {
  const state = {};
  $$('#process-calcs .result').forEach(el => {
    if (el.id && el.textContent !== '-') {
      state[el.id] = el.textContent;
    }
  });
  return state;
}

function compareScenarios() {
  if (Object.keys(comparisonMode.before).length === 0 || Object.keys(comparisonMode.after).length === 0) {
    showNotification('Incomplete Data', 'Please capture both scenarios first', 'warning');
    return;
  }

  let html = '<h3>üìä Scenario Comparison Results</h3><table class="enhanced-table"><thead><tr><th>Parameter</th><th>Scenario A</th><th>Scenario B</th><th>Change</th></tr></thead><tbody>';

  Object.keys(comparisonMode.before).forEach(key => {
    const before = parseFloat(comparisonMode.before[key]) || 0;
    const after = parseFloat(comparisonMode.after[key]) || 0;
    const diff = after - before;
    const diffPercent = before !== 0 ? ((diff / before) * 100).toFixed(1) : 0;
    const diffClass = diff > 0 ? 'positive' : diff < 0 ? 'negative' : 'neutral';

    html += `
      <tr>
        <td>${key.replace('r_', '').replace(/_/g, ' ')}</td>
        <td>${comparisonMode.before[key]}</td>
        <td>${comparisonMode.after[key]}</td>
        <td><span class="comparison-diff ${diffClass}">${diff > 0 ? '+' : ''}${diffPercent}%</span></td>
      </tr>
    `;
  });

  html += '</tbody></table>';

  showModal('üìä Comparison Results', html);
}

// Benchmarking System
function showBenchmarking() {
  const benchmarks = {
    'F/M Ratio': { value: 0.35, industry: 0.3, unit: '', target: '0.2-0.5' },
    'SVI': { value: 125, industry: 120, unit: 'mL/g', target: '<150' },
    'Energy': { value: 1800, industry: 1500, unit: 'kWh/MG', target: '<1600' },
    'DO': { value: 2.2, industry: 2.0, unit: 'mg/L', target: '1.5-2.5' },
    'MLSS': { value: 2800, industry: 2500, unit: 'mg/L', target: '2000-4000' },
    'SRT': { value: 8, industry: 10, unit: 'days', target: '5-15' }
  };

  let html = '<div class="benchmark-grid">';

  Object.entries(benchmarks).forEach(([name, data]) => {
    const percentage = (data.value / data.industry) * 100;
    const status = percentage < 90 ? 'Excellent' : percentage < 110 ? 'Good' : 'Needs Improvement';
    const barWidth = Math.min(percentage, 150);

    html += `
      <div class="benchmark-card">
        <div class="benchmark-metric">${name}</div>
        <div class="benchmark-value">${data.value}${data.unit}</div>
        <div class="benchmark-comparison">
          <div class="benchmark-bar">
            <div class="benchmark-bar-fill" style="width:${barWidth}%"></div>
          </div>
        </div>
        <div class="benchmark-label">Industry Average: ${data.industry}${data.unit} ‚Ä¢ Target: ${data.target}</div>
        <div style="margin-top:10px;font-weight:600;color:${percentage < 90 ? 'var(--ok)' : percentage < 110 ? 'var(--info)' : 'var(--warn)'}">
          ${status}
        </div>
      </div>
    `;
  });

  html += '</div>';

  showModal('üìä Benchmarking Dashboard', html);
}

// Advanced Search System
function initAdvancedSearch() {
  const html = `
    <div class="search-panel">
      <div style="position:relative">
        <span style="position:absolute;left:15px;top:12px;font-size:20px">üîç</span>
        <input type="text" class="search-input" id="advanced-search-input" placeholder="Search calculators, parameters, or results..." oninput="performAdvancedSearch()">
      </div>
      <div class="search-filters" id="search-filters">
        <button class="search-filter-btn active" data-filter="all">All</button>
        <button class="search-filter-btn" data-filter="loading">Loading</button>
        <button class="search-filter-btn" data-filter="hydraulic">Hydraulic</button>
        <button class="search-filter-btn" data-filter="biological">Biological</button>
        <button class="search-filter-btn" data-filter="chemical">Chemical</button>
        <button class="search-filter-btn" data-filter="critical">Critical Only</button>
      </div>
      <div class="search-results" id="search-results"></div>
    </div>
  `;

  showModal('üîç Advanced Search', html);

  // Add filter button handlers
  $$('.search-filter-btn').forEach(btn => {
    btn.onclick = function() {
      $$('.search-filter-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      performAdvancedSearch();
    };
  });
}

function performAdvancedSearch() {
  const searchTerm = $('advanced-search-input')?.value.toLowerCase() || '';
  const activeFilter = $('.search-filter-btn.active')?.dataset.filter || 'all';

  // Search logic here
  const resultsDiv = $('search-results');
  if (resultsDiv && searchTerm.length > 2) {
    resultsDiv.innerHTML = '<p style="text-align:center;padding:20px;color:var(--text-unit)">Search results will appear here...</p>';
  }
}

// Keyboard Shortcuts
const shortcuts = {
  'Ctrl+A': 'Calculate All',
  'Ctrl+S': 'Save Template',
  'Ctrl+E': 'Export Report',
  'Ctrl+P': 'Print',
  'Ctrl+H': 'Show History',
  'Ctrl+B': 'Benchmarking',
  'Ctrl+T': 'Template Manager',
  'Ctrl+F': 'Search',
  'Ctrl+M': 'Comparison Mode',
  'Esc': 'Close Modal'
};

function showKeyboardShortcuts() {
  let html = '<div class="shortcuts-panel"><h3 style="margin-bottom:15px">‚å®Ô∏è Keyboard Shortcuts</h3>';

  Object.entries(shortcuts).forEach(([key, action]) => {
    const keys = key.split('+');
    html += `
      <div class="shortcut-row">
        <div class="shortcut-keys">
          ${keys.map(k => `<span class="shortcut-key">${k}</span>`).join('+')}
        </div>
        <div class="shortcut-desc">${action}</div>
      </div>
    `;
  });

  html += '</div>';
  showModal('‚å®Ô∏è Keyboard Shortcuts', html);
}

// Setup keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key.toLowerCase()) {
      case 'a':
        e.preventDefault();
        calculateAllProcess();
        break;
      case 's':
        e.preventDefault();
        saveAsTemplate();
        break;
      case 'e':
        e.preventDefault();
        exportProcessReport();
        break;
      case 'p':
        e.preventDefault();
        printProcessCalcs();
        break;
      case 'h':
        e.preventDefault();
        showCalculationHistory();
        break;
      case 'b':
        e.preventDefault();
        showBenchmarking();
        break;
      case 't':
        e.preventDefault();
        showTemplateManager();
        break;
      case 'f':
        e.preventDefault();
        initAdvancedSearch();
        break;
      case 'm':
        e.preventDefault();
        toggleComparisonMode();
        break;
    }
  } else if (e.key === 'Escape') {
    closeModal();
  }
});

// Modal System
function showModal(title, content) {
  // Remove existing modal if any
  const existing = document.querySelector('.modal-overlay');
  if (existing) existing.remove();

  const modal = document.createElement('div');
  modal.className = 'modal-overlay active';
  modal.innerHTML = `
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">${title}</div>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body">${content}</div>
    </div>
  `;

  modal.onclick = closeModal;
  document.body.appendChild(modal);
}

function closeModal() {
  const modal = document.querySelector('.modal-overlay');
  if (modal) modal.remove();
}

// Enhanced Notification System
function showNotification(title, message, type = 'info') {
  const icons = {
    success: '‚úÖ',
    warning: '‚ö†Ô∏è',
    error: '‚ùå',
    info: '‚ÑπÔ∏è'
  };

  const container = $('.notification-container') || createNotificationContainer();

  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <div class="notification-icon">${icons[type]}</div>
    <div class="notification-content">
      <div class="notification-title">${title}</div>
      <div class="notification-message">${message}</div>
    </div>
    <div class="notification-close" onclick="this.parentElement.remove()">√ó</div>
  `;

  container.appendChild(notification);

  // Auto-remove after 5 seconds
  setTimeout(() => notification.remove(), 5000);
}

function createNotificationContainer() {
  const container = document.createElement('div');
  container.className = 'notification-container';
  document.body.appendChild(container);
  return container;
}

// Advanced Export Options
function showExportOptions() {
  const html = `
    <div class="export-options">
      <div class="export-option" onclick="exportToCSV()">
        <div class="export-option-icon">üìä</div>
        <div class="export-option-title">CSV Export</div>
        <div class="export-option-desc">Spreadsheet format</div>
      </div>
      <div class="export-option" onclick="exportToJSON()">
        <div class="export-option-icon">üìã</div>
        <div class="export-option-title">JSON Export</div>
        <div class="export-option-desc">Data format</div>
      </div>
      <div class="export-option" onclick="exportProcessReport()">
        <div class="export-option-icon">üìÑ</div>
        <div class="export-option-title">PDF Report</div>
        <div class="export-option-desc">Professional report</div>
      </div>
      <div class="export-option" onclick="exportToExcel()">
        <div class="export-option-icon">üìó</div>
        <div class="export-option-title">Excel Export</div>
        <div class="export-option-desc">XLSX format</div>
      </div>
    </div>
  `;

  showModal('üì• Export Options', html);
}

function exportToCSV() {
  let csv = 'Parameter,Value,Unit,Status\n';

  $$('#process-calcs .result').forEach(el => {
    if (el.textContent !== '-') {
      const row = el.closest('tr');
      if (row) {
        const param = row.querySelector('.rowh')?.textContent || '';
        const value = el.textContent;
        const unit = row.querySelectorAll('td')[2]?.textContent || '';
        const status = row.querySelector('.status')?.textContent || '';
        csv += `"${param}","${value}","${unit}","${status}"\n`;
      }
    }
  });

  downloadFile(csv, 'wwtp_results.csv', 'text/csv');
  showNotification('CSV Exported', 'File downloaded successfully', 'success');
}

function exportToJSON() {
  const data = {
    plantName: $('plantName')?.value || 'WWTP',
    timestamp: new Date().toISOString(),
    results: {}
  };

  $$('#process-calcs .result').forEach(el => {
    if (el.id && el.textContent !== '-') {
      data.results[el.id] = el.textContent;
    }
  });

  downloadFile(JSON.stringify(data, null, 2), 'wwtp_results.json', 'application/json');
  showNotification('JSON Exported', 'File downloaded successfully', 'success');
}

function exportToExcel() {
  showNotification('Excel Export', 'Excel format coming soon! Use CSV for now.', 'info');
}

function downloadFile(content, filename, type) {
  const blob = new Blob([content], { type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

// Initialize ULTRA features
setTimeout(() => {
  loadTemplatesFromStorage();
  createNotificationContainer();
}, 1000);

// ========== REFRESH APP FUNCTION ==========
function refreshApp() {
  if (confirm('Update App?\n\nThis will refresh to get the latest version.')) {
    document.body.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:#1a1a2e;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:99999;color:white"><div style="font-size:60px">üîÑ</div><div style="font-size:18px;margin-top:20px">Updating...</div></div>';
    if (navigator.serviceWorker) {
      navigator.serviceWorker.getRegistrations().then(function(regs) {
        for (var r of regs) { r.unregister(); }
      });
    }
    if (window.caches) {
      caches.keys().then(function(names) {
        for (var n of names) { caches.delete(n); }
      });
    }
    setTimeout(function() {
      window.location.href = window.location.href.split('?')[0] + '?v=' + Date.now();
    }, 1000);
  }
}

// ========== CLEAR CACHE & HARD RELOAD ==========
function clearCacheReload() {
  var modal = document.createElement('div');
  modal.id = 'cacheResetModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:99999;color:white;padding:20px;overflow-y:auto';
  modal.innerHTML = `
    <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);padding:30px;border-radius:20px;max-width:520px;width:95%;text-align:center;border:3px solid #ef4444;max-height:90vh;overflow-y:auto">
      <div style="font-size:60px;margin-bottom:15px">üîÑ</div>
      <h2 style="margin:0 0 10px 0;color:#ef4444;font-size:18px">App Reset Center</h2>
      <p style="margin:0 0 5px 0;opacity:0.7;font-size:13px">Current: v9.6.0 | Use after GitHub updates</p>

      <div style="background:linear-gradient(135deg,#059669,#10b981);padding:15px;border-radius:12px;margin:15px 0;border:2px solid #34d399">
        <div style="font-size:14px;font-weight:bold;margin-bottom:8px">‚úÖ RECOMMENDED FOR UPDATES</div>
        <button onclick="samsungHardReset()" style="background:white;color:#059669;border:none;padding:15px 20px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;width:100%;box-shadow:0 4px 15px rgba(0,0,0,0.3)">
          üì± Samsung/Android Full Reset
        </button>
        <div style="font-size:11px;margin-top:8px;opacity:0.9">Clears PWA cache, service worker & reloads fresh</div>
      </div>

      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:15px">
        <button onclick="hardReload()" style="background:linear-gradient(135deg,#3b82f6,#2563eb);color:white;border:none;padding:14px 20px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer">
          üîÑ Quick Refresh
        </button>
        <button onclick="clearAllCaches()" style="background:linear-gradient(135deg,#f97316,#ea580c);color:white;border:none;padding:14px 20px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer">
          üßπ Clear Service Worker + Caches
        </button>
        <button onclick="clearLocalStorage()" style="background:linear-gradient(135deg,#eab308,#ca8a04);color:white;border:none;padding:14px 20px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer">
          üíæ Clear Saved Data Only
        </button>
        <button onclick="nukeCacheAndReload()" style="background:linear-gradient(135deg,#dc2626,#991b1b);color:white;border:none;padding:14px 20px;border-radius:10px;font-size:15px;font-weight:bold;cursor:pointer">
          ‚ò¢Ô∏è NUCLEAR: Wipe Everything
        </button>
      </div>

      <details style="background:rgba(255,255,255,0.1);border-radius:10px;margin-bottom:15px;text-align:left">
        <summary style="padding:12px;cursor:pointer;font-weight:bold;font-size:14px">üì± Samsung Tab A9+ Manual Reset</summary>
        <div style="padding:12px;font-size:13px;line-height:1.6;border-top:1px solid rgba(255,255,255,0.2)">
          <strong>If button doesn't work:</strong><br><br>
          <strong>Option 1 - Chrome Settings:</strong><br>
          1. Tap ‚ãÆ menu ‚Üí Settings<br>
          2. Privacy ‚Üí Clear browsing data<br>
          3. Select "All time"<br>
          4. Check: ‚òëÔ∏è Cookies, ‚òëÔ∏è Cached files<br>
          5. Tap "Clear data"<br><br>
          <strong>Option 2 - Site Settings:</strong><br>
          1. Tap üîí lock icon in address bar<br>
          2. Tap "Site settings"<br>
          3. Tap "Clear & reset"<br><br>
          <strong>Option 3 - Uninstall PWA:</strong><br>
          1. Long-press app icon<br>
          2. Tap "Uninstall"<br>
          3. Clear Chrome data (Option 1)<br>
          4. Revisit site & reinstall
        </div>
      </details>

      <details style="background:rgba(255,255,255,0.1);border-radius:10px;margin-bottom:15px;text-align:left">
        <summary style="padding:12px;cursor:pointer;font-weight:bold;font-size:14px">üíª Desktop Browser Reset</summary>
        <div style="padding:12px;font-size:13px;line-height:1.6;border-top:1px solid rgba(255,255,255,0.2)">
          <strong>Windows/Linux:</strong> Ctrl + Shift + R<br>
          <strong>Mac:</strong> Cmd + Shift + R<br><br>
          <strong>Full Clear:</strong><br>
          ‚Ä¢ Windows: Ctrl + Shift + Delete<br>
          ‚Ä¢ Mac: Cmd + Shift + Delete<br>
          ‚Ä¢ Select "All time" + "Cached files"
        </div>
      </details>

      <button onclick="document.getElementById('cacheResetModal').remove()" style="background:#6b7280;color:white;border:none;padding:12px 30px;border-radius:8px;font-size:14px;cursor:pointer;width:100%">
        ‚úñÔ∏è Close
      </button>
    </div>
  `;
  document.body.appendChild(modal);
}

// Samsung/Android Optimized Full Reset
function samsungHardReset() {
  var statusDiv = document.createElement('div');
  statusDiv.id = 'resetStatus';
  statusDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:#0a0a1a;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:999999;color:white;padding:20px';
  statusDiv.innerHTML = '<div style="font-size:80px;animation:spin 1s linear infinite">üîÑ</div><div style="font-size:22px;margin-top:20px;color:#10b981;font-weight:bold">Resetting App...</div><div id="resetLog" style="margin-top:15px;font-size:14px;opacity:0.8;text-align:center;max-width:300px"></div><style>@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>';
  document.body.appendChild(statusDiv);

  var log = document.getElementById('resetLog');
  var steps = [];
  var allDone = 0;
  var totalTasks = 4;

  function checkComplete() {
    allDone++;
    if (allDone >= totalTasks) {
      steps.push('');
      steps.push('‚úì All caches cleared!');
      steps.push('');
      steps.push('‚è≥ Waiting 3 seconds...');
      log.innerHTML = steps.join('<br>');

      setTimeout(function() {
        steps.push('üöÄ Forcing hard reload...');
        log.innerHTML = steps.join('<br>');

        setTimeout(function() {
          // Multiple reload strategies for Samsung
          var baseUrl = window.location.href.split('?')[0].split('#')[0];
          var bustUrl = baseUrl + '?nocache=' + Date.now() + Math.random();

          // Try fetch with cache bypass first to prime the new version
          fetch(baseUrl, {
            cache: 'reload',
            headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate', 'Pragma': 'no-cache' }
          }).then(function() {
            window.location.href = bustUrl;
          }).catch(function() {
            window.location.href = bustUrl;
          });
        }, 500);
      }, 3000);
    }
  }

  // Step 1: Clear localStorage & sessionStorage
  try {
    var lsCount = Object.keys(localStorage).length;
    localStorage.clear();
    sessionStorage.clear();
    steps.push('‚úì Storage cleared (' + lsCount + ' items)');
  } catch(e) { steps.push('‚ö† Storage: ' + e.message); }
  log.innerHTML = steps.join('<br>');
  checkComplete();

  // Step 2: Unregister ALL Service Workers
  if (navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations().then(function(regs) {
      var unregPromises = regs.map(function(reg) {
        return reg.unregister();
      });
      return Promise.all(unregPromises);
    }).then(function(results) {
      steps.push('‚úì Service Workers killed (' + results.length + ')');
      log.innerHTML = steps.join('<br>');
      checkComplete();
    }).catch(function(e) {
      steps.push('‚ö† SW: ' + e.message);
      log.innerHTML = steps.join('<br>');
      checkComplete();
    });
  } else {
    steps.push('‚úì No SW support');
    log.innerHTML = steps.join('<br>');
    checkComplete();
  }

  // Step 3: Clear ALL Cache Storage
  if (window.caches) {
    caches.keys().then(function(names) {
      var deletePromises = names.map(function(name) {
        return caches.delete(name);
      });
      return Promise.all(deletePromises);
    }).then(function(results) {
      steps.push('‚úì Cache Storage nuked (' + results.length + ' caches)');
      log.innerHTML = steps.join('<br>');
      checkComplete();
    }).catch(function(e) {
      steps.push('‚ö† Cache: ' + e.message);
      log.innerHTML = steps.join('<br>');
      checkComplete();
    });
  } else {
    steps.push('‚úì No cache API');
    log.innerHTML = steps.join('<br>');
    checkComplete();
  }

  // Step 4: Clear IndexedDB
  if (window.indexedDB && window.indexedDB.databases) {
    indexedDB.databases().then(function(dbs) {
      dbs.forEach(function(db) {
        try { indexedDB.deleteDatabase(db.name); } catch(e) {}
      });
      steps.push('‚úì IndexedDB cleared (' + dbs.length + ')');
      log.innerHTML = steps.join('<br>');
      checkComplete();
    }).catch(function() {
      steps.push('‚úì IndexedDB check done');
      log.innerHTML = steps.join('<br>');
      checkComplete();
    });
  } else {
    steps.push('‚úì No IndexedDB');
    log.innerHTML = steps.join('<br>');
    checkComplete();
  }
}

function hardReload() {
  location.reload(true);
}

function clearAllCaches() {
  var cleared = [];

  // Unregister service workers
  if (navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations().then(function(regs) {
      regs.forEach(function(reg) { reg.unregister(); });
      cleared.push('Service Workers');
    });
  }

  // Clear Cache API
  if (window.caches) {
    caches.keys().then(function(names) {
      names.forEach(function(name) { caches.delete(name); });
      cleared.push('Cache Storage');
    });
  }

  setTimeout(function() {
    alert('Cleared: ' + (cleared.length ? cleared.join(', ') : 'No caches found') + '\n\nPage will now reload...');
    window.location.href = window.location.href.split('?')[0] + '?cleared=' + Date.now();
  }, 500);
}

function clearLocalStorage() {
  var keys = Object.keys(localStorage);
  var count = keys.length;
  localStorage.clear();
  sessionStorage.clear();
  alert('Cleared ' + count + ' items from Local Storage!\n\n‚ö†Ô∏è Note: Your saved calculations and settings have been removed.');
}

function nukeCacheAndReload() {
  if (!confirm('‚ò¢Ô∏è NUCLEAR OPTION ‚ò¢Ô∏è\n\nThis will:\n‚Ä¢ Clear ALL cached files\n‚Ä¢ Clear ALL local storage\n‚Ä¢ Unregister service workers\n‚Ä¢ Force complete reload\n\nYour saved data will be LOST!\n\nContinue?')) return;

  document.body.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:#1a1a2e;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:99999;color:white"><div style="font-size:80px">‚ò¢Ô∏è</div><div style="font-size:18px;margin-top:20px;color:#ef4444">NUKING CACHE...</div><div style="margin-top:10px;opacity:0.7">Please wait...</div></div>';

  // Clear everything
  localStorage.clear();
  sessionStorage.clear();

  if (navigator.serviceWorker) {
    navigator.serviceWorker.getRegistrations().then(function(regs) {
      regs.forEach(function(reg) { reg.unregister(); });
    });
  }

  if (window.caches) {
    caches.keys().then(function(names) {
      names.forEach(function(name) { caches.delete(name); });
    });
  }

  // Delete IndexedDB databases
  if (window.indexedDB) {
    indexedDB.databases().then(function(dbs) {
      dbs.forEach(function(db) { indexedDB.deleteDatabase(db.name); });
    }).catch(function() {});
  }

  setTimeout(function() {
    window.location.href = window.location.href.split('?')[0] + '?nuked=' + Date.now();
  }, 1500);
}

// ========== F/M RATIO CALCULATOR ==========

// ========== MISSING CALCULATOR FUNCTIONS ==========

// SRT Calculator
// HRT Calculator
// BOD Efficiency Calculator
// WAS Calculator
</script>

<script>
// PWA Installation and Service Worker Registration
let deferredPrompt;
let pwaInstallButton;

// Register Service Worker (consolidated - see end of file)
// Note: Service worker registration moved to single location for GitHub Pages compatibility

// Listen for beforeinstallprompt event
window.addEventListener('beforeinstallprompt', (e) => {

  // Prevent the mini-infobar from appearing

  // Save the event for later use
  deferredPrompt = e;

  // Show custom install button
  // showInstallPrompt(); // DISABLED - Use browser native install
});

// Listen for app installed event
window.addEventListener('appinstalled', () => {
  deferredPrompt = null;
  hideInstallPrompt();

  // Show success message
});

// Function to show install prompt
function showInstallPrompt() {
  // Create install button if it doesn't exist
  if (!pwaInstallButton) {
    pwaInstallButton = document.createElement('button');
    pwaInstallButton.innerHTML = 'üì± Install APEX App';
    pwaInstallButton.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      z-index: 999999;
      animation: pulse 2s infinite;
    `;

    pwaInstallButton.addEventListener('click', installPWA);
    document.body.appendChild(pwaInstallButton);

    // Add animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes pulse {
        0%, 100% { transform: translateX(-50%) scale(1); }
        50% { transform: translateX(-50%) scale(1.05); }
      }
    `;
    document.head.appendChild(style);
  }
}

// Function to hide install prompt
function hideInstallPrompt() {
  if (pwaInstallButton) {
    pwaInstallButton.remove();
    pwaInstallButton = null;
  }
}

// Function to install PWA
async function installPWA() {
  if (!deferredPrompt) {
    return;
  }

  // Show the install prompt
  deferredPrompt.prompt();

  // Wait for the user's response
  const { outcome } = await deferredPrompt.userChoice;

  // Clear the deferred prompt
  deferredPrompt = null;

  // Hide the install button
  hideInstallPrompt();
}

// Function to show update notification
function showUpdateNotification() {
  const updateBanner = document.createElement('div');
  updateBanner.innerHTML = `
    <div style="position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#667eea;color:white;padding:15px 30px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.3);z-index:999999;text-align:center">
      <div style="font-weight:bold;margin-bottom:10px">üîÑ Update Available!</div>
      <div style="font-size:14px;margin-bottom:10px">A new version of APEX is ready.</div>
      <button onclick="window.location.reload()" style="background:white;color:#667eea;border:none;padding:8px 20px;border-radius:5px;font-weight:bold;cursor:pointer">
        Update Now
      </button>
      <button onclick="this.parentElement.parentElement.remove()" style="background:rgba(255,255,255,0.2);color:white;border:none;padding:8px 20px;border-radius:5px;margin-left:10px;cursor:pointer">
        Later
      </button>
    </div>
  `;
  document.body.appendChild(updateBanner);
}

// Check if running as PWA
function isPWA() {
  return window.matchMedia('(display-mode: standalone)').matches ||
         window.navigator.standalone ||
         document.referrer.includes('android-app://');
}

// Show PWA status
if (isPWA()) {
} else {
}

// Handle offline/online status
window.addEventListener('online', () => {
  const banner = document.createElement('div');
  banner.textContent = '‚úÖ Back Online!';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 3000);
});

window.addEventListener('offline', () => {
  const banner = document.createElement('div');
  banner.textContent = 'üìµ Offline Mode - Limited Functionality';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff9800;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
});
</script>

<div class="notification-container"></div><div id="realtime-badge" class="realtime-badge online">üü¢ Online</div><div class="ai-copilot" id="ai-copilot">
    <div class="ai-header">
      <div style="display:flex;align-items:center;gap:15px">
        <div class="ai-avatar">ü§ñ</div>
        <div>
          <div style="font-weight:700;font-size:16px">WWTP AI Copilot</div>
          <div style="font-size:12px;opacity:0.8">Powered by Advanced ML</div>
        </div>
      </div>
      <button onclick="toggleAICopilot()" style="background:none;border:none;color:white;font-size:18px;cursor:pointer">√ó</button>
    </div>
    <div class="ai-chat" id="ai-chat">
      <div class="ai-message bot">
        üëã Hello! I'm your AI Copilot. I can help you with:
        <br>‚Ä¢ Process optimization
        <br>‚Ä¢ Troubleshooting issues
        <br>‚Ä¢ Predicting trends
        <br>‚Ä¢ Regulatory compliance
        <br>‚Ä¢ Best practices
        <br><br>What would you like to know?
      </div>
    </div>
    <div class="ai-input-area">
      <input type="text" class="ai-input" id="ai-input-2" placeholder="Ask me anything about WWTP operations..." onkeypress="if(event.key===&#39;Enter&#39;)sendAIMessage()">
      <button class="ai-send-btn" onclick="sendAIMessage()">Send üöÄ</button>
    </div>
  </div></div>
</div>

<script>
// PWA Service Worker Registration
// Service Worker (consolidated - see end of file)

// PWA Install - Use browser's native install in address bar (no popup button)
window.addEventListener('beforeinstallprompt', (e) => {
  // Don't prevent default - let browser show its native install UI
});

// PWA installed event
window.addEventListener('appinstalled', () => {
});

// Online/Offline status
window.addEventListener('online', () => {
  const banner = document.createElement('div');
  banner.textContent = '‚úÖ Back Online!';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#4CAF50;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
  setTimeout(() => banner.remove(), 3000);
});

window.addEventListener('offline', () => {
  const banner = document.createElement('div');
  banner.textContent = 'üìµ Offline Mode - All calculators still work!';
  banner.style.cssText = 'position:fixed;top:20px;right:20px;background:#ff9800;color:white;padding:10px 20px;border-radius:5px;z-index:999999';
  document.body.appendChild(banner);
});

// ========== MULTI-PLANT FLEET MANAGEMENT ==========

// ========== ENHANCED MULTI-PLANT SYSTEM v5.1.0 ==========

let selectedPlantId = null;
let fleetChart = null;

// Plant data storage
let plantData = JSON.parse(localStorage.getItem('wwtp-plants') || 'null') || [
  { id: 1, name: "North Regional WWTP", location: "Houston, TX", capacity: 5.0, flow: 4.2, efficiency: 94.5, status: "online" },
  { id: 2, name: "South Municipal Plant", location: "Pearland, TX", capacity: 3.5, flow: 2.8, efficiency: 92.1, status: "online" },
  { id: 3, name: "East Industrial WWTP", location: "Pasadena, TX", capacity: 8.0, flow: 6.5, efficiency: 89.7, status: "maintenance" },
  { id: 4, name: "West Community Plant", location: "Katy, TX", capacity: 2.0, flow: 1.6, efficiency: 96.2, status: "online" }
];

function savePlantData() {
  localStorage.setItem('wwtp-plants', JSON.stringify(plantData));
}

function selectPlant(id) {
  selectedPlantId = id;
  document.querySelectorAll('.plant-card').forEach(card => {
    card.style.boxShadow = card.dataset.plantId == id ? '0 0 0 3px var(--info)' : 'none';
  });
}

function addNewPlant() {
  const name = prompt('Plant Name:', 'New Treatment Plant');
  if (!name) return;
  const location = prompt('Location:', 'City, State');
  const capacity = parseFloat(prompt('Capacity (MGD):', '5.0')) || 5.0;
  const flow = parseFloat(prompt('Current Flow (MGD):', '3.5')) || 3.5;
  const efficiency = parseFloat(prompt('Efficiency (%):', '90')) || 90;

  const newPlant = {
    id: Date.now(),
    name: name,
    location: location || 'Unknown',
    capacity: capacity,
    flow: flow,
    efficiency: efficiency,
    status: 'online'
  };

  plantData.push(newPlant);
  savePlantData();
  renderPlantCards();
  updateFleetKPIs();
  alert('‚úì Plant added successfully!');
}

function editPlant(id) {
  const plant = plantData.find(p => p.id === id);
  if (!plant) return;

  const name = prompt('Plant Name:', plant.name);
  if (!name) return;
  plant.name = name;
  plant.location = prompt('Location:', plant.location) || plant.location;
  plant.capacity = parseFloat(prompt('Capacity (MGD):', plant.capacity)) || plant.capacity;
  plant.flow = parseFloat(prompt('Current Flow (MGD):', plant.flow)) || plant.flow;
  plant.efficiency = parseFloat(prompt('Efficiency (%):', plant.efficiency)) || plant.efficiency;
  plant.status = prompt('Status (online/maintenance/offline):', plant.status) || plant.status;

  savePlantData();
  renderPlantCards();
  updateFleetKPIs();
  alert('‚úì Plant updated!');
}

function editSelectedPlant() {
  if (!selectedPlantId) {
    alert('Please select a plant first by clicking on it.');
    return;
  }
  editPlant(selectedPlantId);
}

function deleteSelectedPlant() {
  if (!selectedPlantId) {
    alert('Please select a plant first by clicking on it.');
    return;
  }
  const plant = plantData.find(p => p.id === selectedPlantId);
  if (confirm('Delete "' + plant.name + '"? This cannot be undone.')) {
    plantData = plantData.filter(p => p.id !== selectedPlantId);
    savePlantData();
    selectedPlantId = null;
    renderPlantCards();
    updateFleetKPIs();
    alert('‚úì Plant deleted.');
  }
}

function viewPlantDetails(id) {
  const plant = plantData.find(p => p.id === id);
  if (!plant) return;

  const load = ((plant.flow / plant.capacity) * 100).toFixed(0);
  const details = `
üè≠ ${plant.name}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìç Location: ${plant.location}
üìä Capacity: ${plant.capacity} MGD
üíß Current Flow: ${plant.flow} MGD
üìà Efficiency: ${plant.efficiency}%
‚ö° Load: ${load}%
üîò Status: ${plant.status.toUpperCase()}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  `;
  alert(details);
}

function exportPlantData() {
  let csv = 'ID,Name,Location,Capacity_MGD,Flow_MGD,Efficiency_Percent,Status\n';
  plantData.forEach(p => {
    csv += `${p.id},"${p.name}","${p.location}",${p.capacity},${p.flow},${p.efficiency},${p.status}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fleet_data_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  alert('‚úì Fleet data exported to CSV!');
}

function importPlantData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv,.json';
  input.onchange = (e) => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        if (file.name.endsWith('.json')) {
          const imported = JSON.parse(event.target.result);
          plantData = imported;
        } else {
          // Simple CSV parse
          const lines = event.target.result.split('\n');
          const newPlants = [];
          for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',');
            if (cols.length >= 6) {
              newPlants.push({
                id: Date.now() + i,
                name: cols[1].replace(/"/g, ''),
                location: cols[2].replace(/"/g, ''),
                capacity: parseFloat(cols[3]),
                flow: parseFloat(cols[4]),
                efficiency: parseFloat(cols[5]),
                status: cols[6] ? cols[6].trim() : 'online'
              });
            }
          }
          plantData = newPlants;
        }
        savePlantData();
        renderPlantCards();
        updateFleetKPIs();
        alert('‚úì Data imported successfully! ' + plantData.length + ' plants loaded.');
      } catch (err) {
        alert('Error importing: ' + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

function comparePlants() {
  if (plantData.length < 2) {
    alert('Need at least 2 plants to compare.');
    return;
  }

  let html = '<h3>‚öñÔ∏è Plant Comparison</h3>';
  html += '<table style="width:100%;border-collapse:collapse;font-size:14px">';
  html += '<tr style="background:var(--info);color:white"><th style="padding:10px">Plant</th><th>Capacity</th><th>Flow</th><th>Efficiency</th><th>Load</th><th>Status</th></tr>';

  plantData.forEach((p, i) => {
    const load = ((p.flow / p.capacity) * 100).toFixed(0);
    const bg = i % 2 === 0 ? 'var(--bg-section)' : 'var(--bg-card)';
    html += `<tr style="background:${bg}">
      <td style="padding:10px;font-weight:bold">${p.name}</td>
      <td style="padding:10px">${p.capacity} MGD</td>
      <td style="padding:10px">${p.flow} MGD</td>
      <td style="padding:10px;color:${p.efficiency >= 90 ? '#06d6a0' : '#ffd166'}">${p.efficiency}%</td>
      <td style="padding:10px">${load}%</td>
      <td style="padding:10px"><span class="status ${p.status === 'online' ? 'ok' : 'warn'}">${p.status.toUpperCase()}</span></td>
    </tr>`;
  });
  html += '</table>';

  // Add best/worst summary
  const bestEff = plantData.reduce((a, b) => a.efficiency > b.efficiency ? a : b);
  const worstEff = plantData.reduce((a, b) => a.efficiency < b.efficiency ? a : b);
  html += `<div style="margin-top:16px;padding:12px;background:var(--bg-section);border-radius:8px">
    <strong>üèÜ Best Efficiency:</strong> ${bestEff.name} (${bestEff.efficiency}%)<br>
    <strong>‚ö†Ô∏è Needs Attention:</strong> ${worstEff.name} (${worstEff.efficiency}%)
  </div>`;

  const modal = document.createElement('div');
  modal.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:9999" onclick="this.remove()"><div style="background:var(--bg-card);padding:24px;border-radius:16px;max-width:700px;width:95%;max-height:80vh;overflow:auto" onclick="event.stopPropagation()">' + html + '<br><button class="btn gray" onclick="this.closest(\'div\').parentElement.remove()">Close</button></div></div>';
  document.body.appendChild(modal);
}

function showFleetAnalytics() {
  const totalCap = plantData.reduce((sum, p) => sum + p.capacity, 0);
  const totalFlow = plantData.reduce((sum, p) => sum + p.flow, 0);
  const avgEff = (plantData.reduce((sum, p) => sum + p.efficiency, 0) / plantData.length).toFixed(1);
  const online = plantData.filter(p => p.status === 'online').length;

  const html = `
    <h3>üìä Fleet Analytics</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0">
      <div style="padding:20px;background:linear-gradient(135deg,#667eea20,#667eea10);border-radius:12px;text-align:center">
        <div style="font-size:36px;font-weight:bold;color:#667eea">${plantData.length}</div>
        <div>Total Plants</div>
      </div>
      <div style="padding:20px;background:linear-gradient(135deg,#06d6a020,#06d6a010);border-radius:12px;text-align:center">
        <div style="font-size:36px;font-weight:bold;color:#06d6a0">${online}</div>
        <div>Online</div>
      </div>
      <div style="padding:20px;background:linear-gradient(135deg,#0077b620,#0077b610);border-radius:12px;text-align:center">
        <div style="font-size:36px;font-weight:bold;color:#0077b6">${totalCap.toFixed(1)}</div>
        <div>Total Capacity (MGD)</div>
      </div>
      <div style="padding:20px;background:linear-gradient(135deg,#ffd16620,#ffd16610);border-radius:12px;text-align:center">
        <div style="font-size:36px;font-weight:bold;color:#ffd166">${totalFlow.toFixed(1)}</div>
        <div>Current Flow (MGD)</div>
      </div>
    </div>
    <div style="padding:16px;background:var(--bg-section);border-radius:12px;margin-top:16px">
      <strong>üìà Key Metrics:</strong><br>
      ‚Ä¢ Average Efficiency: <strong>${avgEff}%</strong><br>
      ‚Ä¢ Capacity Utilization: <strong>${((totalFlow/totalCap)*100).toFixed(0)}%</strong><br>
      ‚Ä¢ Plants Online: <strong>${online}/${plantData.length}</strong>
    </div>
  `;

  const modal = document.createElement('div');
  modal.innerHTML = '<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:9999" onclick="this.remove()"><div style="background:var(--bg-card);padding:24px;border-radius:16px;max-width:500px;width:95%" onclick="event.stopPropagation()">' + html + '<br><button class="btn gray" onclick="this.closest(\'div\').parentElement.remove()">Close</button></div></div>';
  document.body.appendChild(modal);
}

function renderPlantCards() {
  const container = document.getElementById('plant-cards');
  if (!container) return;

  if (plantData.length === 0) {
    container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;background:var(--bg-section);border-radius:12px"><div style="font-size:48px;margin-bottom:16px">üè≠</div><p>No plants added yet.</p><button class="btn green" onclick="addNewPlant()">‚ûï Add Your First Plant</button></div>';
    return;
  }

  let html = '';
  plantData.forEach(p => {
    const load = ((p.flow / p.capacity) * 100).toFixed(0);
    const statusClass = p.status === 'online' ? 'ok' : (p.status === 'maintenance' ? 'warn' : 'error');
    const borderColor = p.status === 'online' ? 'var(--ok)' : (p.status === 'maintenance' ? 'var(--warn)' : 'var(--error)');
    const effColor = p.efficiency >= 90 ? '#06d6a0' : (p.efficiency >= 80 ? '#ffd166' : '#ef4444');

    html += `
    <div class="plant-card" data-plant-id="${p.id}" onclick="selectPlant(${p.id})" style="background:var(--bg-section);padding:20px;border-radius:12px;border-left:4px solid ${borderColor};cursor:pointer;transition:all 0.3s">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <strong>${p.name}</strong>
        <span class="status ${statusClass}">${p.status.toUpperCase()}</span>
      </div>
      <div style="color:var(--text-unit);font-size:14px;margin-bottom:12px">üìç ${p.location}</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px">
        <div>Capacity: <strong>${p.capacity} MGD</strong></div>
        <div>Flow: <strong>${p.flow} MGD</strong></div>
        <div>Efficiency: <strong style="color:${effColor}">${p.efficiency}%</strong></div>
        <div>Load: <strong>${load}%</strong></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn small blue" onclick="event.stopPropagation();viewPlantDetails(${p.id})">View</button>
        <button class="btn small orange" onclick="event.stopPropagation();editPlant(${p.id})">Edit</button>
      </div>
    </div>`;
  });

  container.innerHTML = html;
}

function updateFleetKPIs() {
  const totalPlants = plantData.length;
  const totalCap = plantData.reduce((sum, p) => sum + p.capacity, 0);
  const totalFlow = plantData.reduce((sum, p) => sum + p.flow, 0);
  const online = plantData.filter(p => p.status === 'online').length;
  const avgEff = totalPlants > 0 ? (plantData.reduce((sum, p) => sum + p.efficiency, 0) / totalPlants).toFixed(1) : 0;
  const avgLoad = totalCap > 0 ? ((totalFlow / totalCap) * 100).toFixed(0) : 0;

  const el = (id, val) => { const e = document.getElementById(id); if(e) e.textContent = val; };
  el('fleet-plants', totalPlants);
  el('fleet-capacity', totalCap.toFixed(1) + ' MGD');
  el('fleet-online', online);
  el('fleet-eff', avgEff + '%');
  el('fleet-flow', totalFlow.toFixed(1) + ' MGD');
  el('fleet-load', avgLoad + '%');
}

// Initialize fleet chart
function initFleetChart() {
  const ctx = document.getElementById('fleetComparisonChart');
  if (!ctx) return;

  if (fleetChart) fleetChart.destroy();

  fleetChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: plantData.map(p => p.name.split(' ')[0]),
      datasets: [
        {
          label: 'Capacity (MGD)',
          data: plantData.map(p => p.capacity),
          backgroundColor: 'rgba(102, 126, 234, 0.7)'
        },
        {
          label: 'Flow (MGD)',
          data: plantData.map(p => p.flow),
          backgroundColor: 'rgba(16, 185, 129, 0.7)'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'MGD' } }
      }
    }
  });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  renderPlantCards();
  updateFleetKPIs();
  setTimeout(initFleetChart, 500);
});

// ========== NEW CALCULATORS v5.1.0 ==========

// Surface Overflow Rate
function calcSOR() {
  var flow = parseFloat(document.getElementById('sor_flow').value) || 0;
  var area = parseFloat(document.getElementById('sor_area').value) || 0;
  var sor = area > 0 ? (flow * 1000000) / area : 0;
  document.getElementById('r_sor').textContent = sor.toFixed(0);
  var status = sor <= 800 ? 'Excellent' : sor <= 1200 ? 'Good' : 'High';
  document.getElementById('r_sor_status').textContent = status;
}
function resetSOR() {
  document.getElementById('sor_flow').value = '5.0';
  document.getElementById('sor_area').value = '5000';
  document.getElementById('r_sor').textContent = '-';
  document.getElementById('r_sor_status').textContent = '-';
}

// Weir Overflow Rate
function calcWOR() {
  var flow = parseFloat(document.getElementById('wor_flow').value) || 0;
  var length = parseFloat(document.getElementById('wor_length').value) || 0;
  var wor = length > 0 ? (flow * 1000000) / length : 0;
  document.getElementById('r_wor').textContent = wor.toFixed(0);
  var status = wor <= 20000 ? 'Excellent' : wor <= 30000 ? 'Good' : 'High';
  document.getElementById('r_wor_status').textContent = status;
}
function resetWOR() {
  document.getElementById('wor_flow').value = '5.0';
  document.getElementById('wor_length').value = '150';
  document.getElementById('r_wor').textContent = '-';
  document.getElementById('r_wor_status').textContent = '-';
}

// Solids Loading Rate
function calcSLR() {
  var flow = parseFloat(document.getElementById('slr_flow').value) || 0;
  var mlss = parseFloat(document.getElementById('slr_mlss').value) || 0;
  var ras = parseFloat(document.getElementById('slr_ras').value) || 0;
  var area = parseFloat(document.getElementById('slr_area').value) || 0;
  var totalFlow = flow + ras;
  var slr = area > 0 ? (totalFlow * mlss * 8.34) / area : 0;
  document.getElementById('r_slr').textContent = slr.toFixed(2);
  var status = slr <= 25 ? 'Excellent' : slr <= 35 ? 'Good' : 'High';
  document.getElementById('r_slr_status').textContent = status;
}
function resetSLR() {
  document.getElementById('slr_flow').value = '5.0';
  document.getElementById('slr_mlss').value = '3000';
  document.getElementById('slr_ras').value = '2.0';
  document.getElementById('slr_area').value = '5000';
  document.getElementById('r_slr').textContent = '-';
  document.getElementById('r_slr_status').textContent = '-';
}

// MCRT Calculator
function calcMCRT() {
  var vol = parseFloat(document.getElementById('mcrt_vol').value) || 0;
  var mlss = parseFloat(document.getElementById('mcrt_mlss').value) || 0;
  var was = parseFloat(document.getElementById('mcrt_was').value) || 0;
  var wasTss = parseFloat(document.getElementById('mcrt_was_tss').value) || 0;
  var eff = parseFloat(document.getElementById('mcrt_eff').value) || 0;
  var effTss = parseFloat(document.getElementById('mcrt_eff_tss').value) || 0;
  var solids = vol * mlss * 8.34;
  var wasted = (was * wasTss * 8.34) + (eff * effTss * 8.34);
  var mcrt = wasted > 0 ? solids / wasted : 0;
  document.getElementById('r_mcrt_solids').textContent = solids.toFixed(0);
  document.getElementById('r_mcrt_wasted').textContent = wasted.toFixed(0);
  document.getElementById('r_mcrt').textContent = mcrt.toFixed(1);
  var status = mcrt >= 5 && mcrt <= 15 ? 'Optimal' : mcrt < 5 ? 'Low' : 'High';
  document.getElementById('r_mcrt_status').textContent = status;
}
function resetMCRT() {
  document.getElementById('mcrt_vol').value = '1.5';
  document.getElementById('mcrt_mlss').value = '3000';
  document.getElementById('mcrt_was').value = '0.05';
  document.getElementById('mcrt_was_tss').value = '8000';
  document.getElementById('mcrt_eff').value = '5.0';
  document.getElementById('mcrt_eff_tss').value = '10';
  ['r_mcrt_solids','r_mcrt_wasted','r_mcrt','r_mcrt_status'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Oxygen Uptake Rate
function calcOUR() {
  var do1 = parseFloat(document.getElementById('our_do1').value) || 0;
  var do2 = parseFloat(document.getElementById('our_do2').value) || 0;
  var time = parseFloat(document.getElementById('our_time').value) || 0;
  var mlvss = parseFloat(document.getElementById('our_mlvss').value) || 0;
  var our = time > 0 ? ((do1 - do2) / time) * 60 : 0;
  var sour = mlvss > 0 ? (our / mlvss) * 1000 : 0;
  document.getElementById('r_our').textContent = our.toFixed(1);
  document.getElementById('r_sour').textContent = sour.toFixed(1);
  var status = sour >= 8 && sour <= 20 ? 'Normal' : sour < 8 ? 'Low Activity' : 'High Activity';
  document.getElementById('r_our_status').textContent = status;
}
function resetOUR() {
  document.getElementById('our_do1').value = '6.0';
  document.getElementById('our_do2').value = '2.0';
  document.getElementById('our_time').value = '15';
  document.getElementById('our_mlvss').value = '2000';
  ['r_our','r_sour','r_our_status'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Ammonia Removal
function calcNH3() {
  var nh3In = parseFloat(document.getElementById('nh3_in').value) || 0;
  var nh3Out = parseFloat(document.getElementById('nh3_out').value) || 0;
  var flow = parseFloat(document.getElementById('nh3_flow').value) || 0;
  var removed = nh3In - nh3Out;
  var eff = nh3In > 0 ? (removed / nh3In) * 100 : 0;
  var mass = removed * flow * 8.34;
  var alk = mass * 7.14; // 7.14 lb alk per lb NH3-N
  document.getElementById('r_nh3_removed').textContent = removed.toFixed(1);
  document.getElementById('r_nh3_eff').textContent = eff.toFixed(1);
  document.getElementById('r_nh3_mass').textContent = mass.toFixed(0);
  document.getElementById('r_nh3_alk').textContent = alk.toFixed(0);
}
function resetNH3() {
  document.getElementById('nh3_in').value = '25';
  document.getElementById('nh3_out').value = '1.0';
  document.getElementById('nh3_flow').value = '5.0';
  ['r_nh3_removed','r_nh3_eff','r_nh3_mass','r_nh3_alk'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Phosphorus Removal
function calcPhos() {
  var pIn = parseFloat(document.getElementById('phos_in').value) || 0;
  var pOut = parseFloat(document.getElementById('phos_out').value) || 0;
  var flow = parseFloat(document.getElementById('phos_flow').value) || 0;
  var chem = document.getElementById('phos_chem').value;
  var removed = pIn - pOut;
  var eff = pIn > 0 ? (removed / pIn) * 100 : 0;
  var massP = removed * flow * 8.34;
  // Molar ratios: Alum ~2.5 mol Al/mol P, Ferric ~1.8 mol Fe/mol P
  var ratio = chem === 'alum' ? 2.5 : 1.8;
  var chemMW = chem === 'alum' ? 594 : 162.2; // Alum or FeCl3
  var pMW = 31;
  var dose = massP * (ratio * chemMW / pMW);
  document.getElementById('r_phos_removed').textContent = removed.toFixed(1);
  document.getElementById('r_phos_eff').textContent = eff.toFixed(1);
  document.getElementById('r_phos_dose').textContent = dose.toFixed(0);
  document.getElementById('r_phos_ratio').textContent = ratio.toFixed(1);
}
function resetPhos() {
  document.getElementById('phos_in').value = '6.0';
  document.getElementById('phos_out').value = '0.5';
  document.getElementById('phos_flow').value = '5.0';
  document.getElementById('phos_chem').value = 'alum';
  ['r_phos_removed','r_phos_eff','r_phos_dose','r_phos_ratio'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// TSS/VSS Removal
function calcTSS() {
  var tssIn = parseFloat(document.getElementById('tss_in').value) || 0;
  var tssOut = parseFloat(document.getElementById('tss_out').value) || 0;
  var vssIn = parseFloat(document.getElementById('vss_in').value) || 0;
  var vssOut = parseFloat(document.getElementById('vss_out').value) || 0;
  var tssEff = tssIn > 0 ? ((tssIn - tssOut) / tssIn) * 100 : 0;
  var vssEff = vssIn > 0 ? ((vssIn - vssOut) / vssIn) * 100 : 0;
  var ratioIn = tssIn > 0 ? vssIn / tssIn : 0;
  var ratioOut = tssOut > 0 ? vssOut / tssOut : 0;
  document.getElementById('r_tss_eff').textContent = tssEff.toFixed(1);
  document.getElementById('r_vss_eff').textContent = vssEff.toFixed(1);
  document.getElementById('r_vss_tss_in').textContent = ratioIn.toFixed(2);
  document.getElementById('r_vss_tss_out').textContent = ratioOut.toFixed(2);
}
function resetTSS() {
  document.getElementById('tss_in').value = '250';
  document.getElementById('tss_out').value = '10';
  document.getElementById('vss_in').value = '200';
  document.getElementById('vss_out').value = '8';
  ['r_tss_eff','r_vss_eff','r_vss_tss_in','r_vss_tss_out'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Grit Chamber
function calcGrit() {
  var flow = parseFloat(document.getElementById('grit_flow').value) || 0;
  var dt = parseFloat(document.getElementById('grit_dt').value) || 0;
  var depth = parseFloat(document.getElementById('grit_depth').value) || 0;
  var width = parseFloat(document.getElementById('grit_width').value) || 0;
  var flowCfm = (flow * 1000000) / (24 * 60 * 7.48);
  var vol = flowCfm * dt;
  var area = depth > 0 ? vol / depth : 0;
  var length = width > 0 ? area / width : 0;
  var vel = (width * depth) > 0 ? flowCfm / (width * depth) : 0;
  document.getElementById('r_grit_vol').textContent = vol.toFixed(0);
  document.getElementById('r_grit_length').textContent = length.toFixed(1);
  document.getElementById('r_grit_area').textContent = area.toFixed(0);
  document.getElementById('r_grit_vel').textContent = vel.toFixed(2);
}
function resetGrit() {
  document.getElementById('grit_flow').value = '10.0';
  document.getElementById('grit_dt').value = '3';
  document.getElementById('grit_depth').value = '10';
  document.getElementById('grit_width').value = '8';
  ['r_grit_vol','r_grit_length','r_grit_area','r_grit_vel'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Digester Loading
function calcDigester() {
  var vol = parseFloat(document.getElementById('dig_vol').value) || 0;
  var solids = parseFloat(document.getElementById('dig_solids').value) || 0;
  var vsRatio = parseFloat(document.getElementById('dig_vs').value) || 0;
  var tank = parseFloat(document.getElementById('dig_tank').value) || 0;
  var vsLoad = vol * 8.34 * (solids / 100) * vsRatio;
  var vlr = tank > 0 ? vsLoad / tank : 0;
  var hrt = vol > 0 ? (tank * 7.48) / vol : 0;
  document.getElementById('r_dig_vs').textContent = vsLoad.toFixed(0);
  document.getElementById('r_dig_vlr').textContent = vlr.toFixed(3);
  document.getElementById('r_dig_hrt').textContent = hrt.toFixed(1);
  var status = vlr <= 0.1 ? 'Good' : vlr <= 0.2 ? 'Moderate' : 'High';
  document.getElementById('r_dig_status').textContent = status;
}
function resetDigester() {
  document.getElementById('dig_vol').value = '50000';
  document.getElementById('dig_solids').value = '5';
  document.getElementById('dig_vs').value = '0.75';
  document.getElementById('dig_tank').value = '50000';
  ['r_dig_vs','r_dig_vlr','r_dig_hrt','r_dig_status'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// ========== END NEW CALCULATORS ==========
// ========== MORE CALCULATORS v5.1.0 ==========

// Headloss Calculator (Hazen-Williams)
function calcHeadloss() {
  var flow = parseFloat(document.getElementById('hl_flow').value) || 0;
  var dia = parseFloat(document.getElementById('hl_dia').value) || 0;
  var length = parseFloat(document.getElementById('hl_length').value) || 0;
  var c = parseFloat(document.getElementById('hl_c').value) || 120;
  var areaFt2 = Math.PI * Math.pow(dia/12/2, 2);
  var flowCfs = flow / 448.8;
  var vel = areaFt2 > 0 ? flowCfs / areaFt2 : 0;
  // Hazen-Williams: hf = 10.67 * L * Q^1.852 / (C^1.852 * D^4.87)
  var hf = 10.67 * length * Math.pow(flow/448.8, 1.852) / (Math.pow(c, 1.852) * Math.pow(dia/12, 4.87));
  var hf100 = length > 0 ? (hf / length) * 100 : 0;
  document.getElementById('r_hl_vel').textContent = vel.toFixed(2);
  document.getElementById('r_hl_loss').textContent = hf.toFixed(2);
  document.getElementById('r_hl_100').textContent = hf100.toFixed(3);
}
function resetHeadloss() {
  document.getElementById('hl_flow').value = '1000';
  document.getElementById('hl_dia').value = '8';
  document.getElementById('hl_length').value = '500';
  document.getElementById('hl_c').value = '120';
  ['r_hl_vel','r_hl_loss','r_hl_100'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Blower Air Requirements
function calcBlower() {
  var o2 = parseFloat(document.getElementById('blower_o2').value) || 0;
  var eff = parseFloat(document.getElementById('blower_eff').value) || 25;
  var depth = parseFloat(document.getElementById('blower_depth').value) || 15;
  // Air is 23.2% O2 by weight, density ~0.075 lb/cf
  var airLb = o2 / (eff / 100);
  var airScfm = (airLb / 0.075) / 1440;
  // Blower HP estimate: HP = SCFM * (discharge pressure) / (229 * efficiency)
  var psi = depth * 0.433 + 1; // approximate discharge pressure
  var hp = airScfm * psi / (229 * 0.70);
  var kwh = hp * 0.746 * 8760;
  document.getElementById('r_blower_air').textContent = airScfm.toFixed(0);
  document.getElementById('r_blower_hp').textContent = hp.toFixed(1);
  document.getElementById('r_blower_kwh').textContent = kwh.toFixed(0);
}
function resetBlower() {
  document.getElementById('blower_o2').value = '5000';
  document.getElementById('blower_eff').value = '25';
  document.getElementById('blower_depth').value = '15';
  ['r_blower_air','r_blower_hp','r_blower_kwh'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// UV Disinfection
function calcUV() {
  var flow = parseFloat(document.getElementById('uv_flow').value) || 0;
  var dose = parseFloat(document.getElementById('uv_dose').value) || 40;
  var uvt = parseFloat(document.getElementById('uv_uvt').value) || 65;
  var log = parseFloat(document.getElementById('uv_log').value) || 4;
  var gpm = flow * 1000000 / 1440;
  // Rough estimates based on typical UV systems
  var lampsPerMGD = 15 + (100 - uvt) * 0.5 + (log - 3) * 5;
  var lamps = Math.ceil(flow * lampsPerMGD);
  var power = lamps * 0.3; // ~300W per lamp average
  document.getElementById('r_uv_channel').textContent = gpm.toFixed(0);
  document.getElementById('r_uv_lamps').textContent = lamps;
  document.getElementById('r_uv_power').textContent = power.toFixed(1);
}
function resetUV() {
  document.getElementById('uv_flow').value = '5.0';
  document.getElementById('uv_dose').value = '40';
  document.getElementById('uv_uvt').value = '65';
  document.getElementById('uv_log').value = '4';
  ['r_uv_channel','r_uv_lamps','r_uv_power'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Sludge Thickening
function calcThickening() {
  var flow = parseFloat(document.getElementById('thick_flow').value) || 0;
  var feed = parseFloat(document.getElementById('thick_feed').value) || 0;
  var out = parseFloat(document.getElementById('thick_out').value) || 0;
  var capture = parseFloat(document.getElementById('thick_capture').value) || 95;
  var dryIn = flow * 60 * 8.34 * (feed / 100);
  var captured = dryIn * (capture / 100);
  var flowOut = out > 0 ? captured / (8.34 * (out / 100) * 60) : 0;
  var reduction = flow > 0 ? ((flow - flowOut) / flow) * 100 : 0;
  document.getElementById('r_thick_in').textContent = dryIn.toFixed(0);
  document.getElementById('r_thick_flowout').textContent = flowOut.toFixed(1);
  document.getElementById('r_thick_captured').textContent = captured.toFixed(0);
  document.getElementById('r_thick_reduction').textContent = reduction.toFixed(1);
}
function resetThickening() {
  document.getElementById('thick_flow').value = '100';
  document.getElementById('thick_feed').value = '0.8';
  document.getElementById('thick_out').value = '5.0';
  document.getElementById('thick_capture').value = '95';
  ['r_thick_in','r_thick_flowout','r_thick_captured','r_thick_reduction'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Equalization Basin
function calcEQ() {
  var peak = parseFloat(document.getElementById('eq_peak').value) || 0;
  var avg = parseFloat(document.getElementById('eq_avg').value) || 0;
  var duration = parseFloat(document.getElementById('eq_duration').value) || 0;
  var excess = peak - avg;
  var vol = (excess * duration) / 24;
  var gal = vol * 1000000;
  var ratio = avg > 0 ? peak / avg : 0;
  document.getElementById('r_eq_vol').textContent = vol.toFixed(3);
  document.getElementById('r_eq_gal').textContent = gal.toFixed(0);
  document.getElementById('r_eq_ratio').textContent = ratio.toFixed(2);
}
function resetEQ() {
  document.getElementById('eq_peak').value = '8.0';
  document.getElementById('eq_avg').value = '5.0';
  document.getElementById('eq_duration').value = '4';
  ['r_eq_vol','r_eq_gal','r_eq_ratio'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Chemical Feed Rate
function calcChemFeed() {
  var flow = parseFloat(document.getElementById('chem_flow').value) || 0;
  var dose = parseFloat(document.getElementById('chem_dose').value) || 0;
  var strength = parseFloat(document.getElementById('chem_strength').value) || 0;
  var sg = parseFloat(document.getElementById('chem_sg').value) || 1.0;
  var dryLb = flow * dose * 8.34;
  var galDay = strength > 0 ? dryLb / (8.34 * sg * (strength / 100)) : 0;
  var gph = galDay / 24;
  var mlmin = gph * 63.09;
  document.getElementById('r_chem_dry').textContent = dryLb.toFixed(0);
  document.getElementById('r_chem_gal').textContent = galDay.toFixed(1);
  document.getElementById('r_chem_gph').textContent = gph.toFixed(2);
  document.getElementById('r_chem_mlmin').textContent = mlmin.toFixed(1);
}
function resetChemFeed() {
  document.getElementById('chem_flow').value = '5.0';
  document.getElementById('chem_dose').value = '50';
  document.getElementById('chem_strength').value = '50';
  document.getElementById('chem_sg').value = '1.2';
  ['r_chem_dry','r_chem_gal','r_chem_gph','r_chem_mlmin'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Screenings & Grit
function calcScreenings() {
  var flow = parseFloat(document.getElementById('screen_flow').value) || 0;
  var opening = parseFloat(document.getElementById('screen_opening').value) || 0.25;
  var pop = parseFloat(document.getElementById('screen_pop').value) || 0;
  // Typical values: 0.5-3 cf/MG for fine screens
  var screenFactor = opening < 0.25 ? 2.5 : opening < 0.5 ? 1.5 : 0.8;
  var screenVol = flow * screenFactor;
  var screenCY = (screenVol * 30) / 27;
  // Grit: typically 0.5-3 cf/MG
  var gritVol = flow * 1.5;
  var gritCY = (gritVol * 30) / 27;
  document.getElementById('r_screen_vol').textContent = screenVol.toFixed(1);
  document.getElementById('r_screen_cy').textContent = screenCY.toFixed(1);
  document.getElementById('r_grit_vol2').textContent = gritVol.toFixed(1);
  document.getElementById('r_grit_cy').textContent = gritCY.toFixed(1);
}
function resetScreenings() {
  document.getElementById('screen_flow').value = '5.0';
  document.getElementById('screen_opening').value = '0.25';
  document.getElementById('screen_pop').value = '50000';
  ['r_screen_vol','r_screen_cy','r_grit_vol2','r_grit_cy'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Primary Clarifier
function calcPrimary() {
  var bodIn = parseFloat(document.getElementById('prim_bod_in').value) || 0;
  var tssIn = parseFloat(document.getElementById('prim_tss_in').value) || 0;
  var sor = parseFloat(document.getElementById('prim_sor').value) || 800;
  // Typical removal based on SOR
  var bodRem = 25 + (1200 - sor) * 0.02;
  bodRem = Math.min(40, Math.max(20, bodRem));
  var tssRem = 45 + (1200 - sor) * 0.03;
  tssRem = Math.min(70, Math.max(40, tssRem));
  var bodOut = bodIn * (1 - bodRem/100);
  var tssOut = tssIn * (1 - tssRem/100);
  document.getElementById('r_prim_bod_rem').textContent = bodRem.toFixed(0);
  document.getElementById('r_prim_tss_rem').textContent = tssRem.toFixed(0);
  document.getElementById('r_prim_bod_out').textContent = bodOut.toFixed(0);
  document.getElementById('r_prim_tss_out').textContent = tssOut.toFixed(0);
}
function resetPrimary() {
  document.getElementById('prim_bod_in').value = '250';
  document.getElementById('prim_tss_in').value = '300';
  document.getElementById('prim_sor').value = '800';
  ['r_prim_bod_rem','r_prim_tss_rem','r_prim_bod_out','r_prim_tss_out'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Trickling Filter
function calcTF() {
  var flow = parseFloat(document.getElementById('tf_flow').value) || 0;
  var bod = parseFloat(document.getElementById('tf_bod').value) || 0;
  var vol = parseFloat(document.getElementById('tf_vol').value) || 0;
  var recirc = parseFloat(document.getElementById('tf_recirc').value) || 0;
  var bodLoad = flow * bod * 8.34;
  var olr = vol > 0 ? (bodLoad / vol) * 1000 : 0;
  var surfArea = Math.pow(vol / 6, 0.667) * 6; // estimate for 6ft depth
  var hlr = surfArea > 0 ? ((flow + flow * recirc) * 1000000) / surfArea : 0;
  // NRC formula approximation for removal
  var removal = 100 / (1 + 0.0044 * Math.sqrt(olr));
  document.getElementById('r_tf_olr').textContent = olr.toFixed(1);
  document.getElementById('r_tf_hlr').textContent = hlr.toFixed(0);
  document.getElementById('r_tf_removal').textContent = removal.toFixed(0);
}
function resetTF() {
  document.getElementById('tf_flow').value = '2.0';
  document.getElementById('tf_bod').value = '150';
  document.getElementById('tf_vol').value = '50000';
  document.getElementById('tf_recirc').value = '1.0';
  ['r_tf_olr','r_tf_hlr','r_tf_removal'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// Biosolids Land Application
function calcBiosolids() {
  var tons = parseFloat(document.getElementById('bio_tons').value) || 0;
  var nPct = parseFloat(document.getElementById('bio_n').value) || 0;
  var rate = parseFloat(document.getElementById('bio_rate').value) || 0;
  var avail = parseFloat(document.getElementById('bio_avail').value) || 0;
  var totalN = tons * 2000 * (nPct / 100);
  var availN = totalN * (avail / 100);
  var acres = rate > 0 ? availN / rate : 0;
  var tonsPerAc = acres > 0 ? tons / acres : 0;
  document.getElementById('r_bio_total_n').textContent = totalN.toFixed(0);
  document.getElementById('r_bio_avail_n').textContent = availN.toFixed(0);
  document.getElementById('r_bio_acres').textContent = acres.toFixed(0);
  document.getElementById('r_bio_tons_ac').textContent = tonsPerAc.toFixed(2);
}
function resetBiosolids() {
  document.getElementById('bio_tons').value = '500';
  document.getElementById('bio_n').value = '4';
  document.getElementById('bio_rate').value = '150';
  document.getElementById('bio_avail').value = '40';
  ['r_bio_total_n','r_bio_avail_n','r_bio_acres','r_bio_tons_ac'].forEach(function(id) { document.getElementById(id).textContent = '-'; });
}

// ========== END MORE CALCULATORS ==========
// ========== OPERATOR TOOLS v5.1.0 ==========

// Daily Rounds Checklist
function saveChecklist() {
  var checkboxes = document.querySelectorAll('#dailyChecklist input[type="checkbox"]');
  var data = {};
  var completed = 0;
  checkboxes.forEach(function(cb) {
    data[cb.id] = cb.checked;
    if (cb.checked) completed++;
  });
  data._date = new Date().toDateString();
  localStorage.setItem('wwtp_checklist', JSON.stringify(data));
  updateChecklistProgress(completed, checkboxes.length);
}

function loadChecklist() {
  var saved = localStorage.getItem('wwtp_checklist');
  if (saved) {
    var data = JSON.parse(saved);
    if (data._date === new Date().toDateString()) {
      var completed = 0;
      var total = 0;
      Object.keys(data).forEach(function(id) {
        if (id.startsWith('chk_')) {
          var cb = document.getElementById(id);
          if (cb) {
            cb.checked = data[id];
            if (data[id]) completed++;
            total++;
          }
        }
      });
      updateChecklistProgress(completed, total);
    }
  }
}

function resetDailyChecklist() {
  if (confirm('Reset all checklist items for today?')) {
    var checkboxes = document.querySelectorAll('#dailyChecklist input[type="checkbox"]');
    checkboxes.forEach(function(cb) { cb.checked = false; });
    localStorage.removeItem('wwtp_checklist');
    updateChecklistProgress(0, checkboxes.length);
    showToast('Checklist reset!', 'info');
  }
}

function updateChecklistProgress(completed, total) {
  var pct = total > 0 ? Math.round((completed / total) * 100) : 0;
  document.getElementById('checklistProgress').textContent = completed + ' / ' + total + ' (' + pct + '%)';
  document.getElementById('checklistBar').style.width = pct + '%';
  if (pct === 100) {
    showToast('üéâ Daily rounds complete!', 'success');
  }
}

// Load checklist on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(loadChecklist, 500);
});

// Calculation Wizards
var wizardSteps = {
  fm: [
    { title: 'Step 1: Get BOD Concentration', input: 'wizard_bod', label: 'Enter influent BOD (mg/L)', default: 200, hint: 'Check lab results or use typical value of 150-250 mg/L' },
    { title: 'Step 2: Get Flow Rate', input: 'wizard_flow', label: 'Enter daily flow (MGD)', default: 5.0, hint: 'Read from plant flow meter' },
    { title: 'Step 3: Calculate BOD Loading', calc: true, formula: 'BOD Load = BOD √ó Flow √ó 8.34', result: 'wizard_bodload' },
    { title: 'Step 4: Get MLVSS', input: 'wizard_mlvss', label: 'Enter MLVSS (mg/L)', default: 2000, hint: 'MLVSS = MLSS √ó 0.7 to 0.8 typically' },
    { title: 'Step 5: Get Aeration Volume', input: 'wizard_vol', label: 'Enter aeration volume (MG)', default: 1.0, hint: 'Check plant design specs' },
    { title: 'Step 6: Calculate F/M Ratio', calc: true, formula: 'F/M = BOD Load / (MLVSS √ó Volume √ó 8.34)', result: 'wizard_fm', final: true }
  ],
  srt: [
    { title: 'Step 1: Get MLSS', input: 'wizard_srt_mlss', label: 'Enter MLSS (mg/L)', default: 3000, hint: 'From settleometer or lab analysis' },
    { title: 'Step 2: Get Aeration Volume', input: 'wizard_srt_vol', label: 'Enter aeration volume (MG)', default: 1.5, hint: 'Total aeration basin volume' },
    { title: 'Step 3: Calculate System Solids', calc: true, formula: 'System Solids = MLSS √ó Volume √ó 8.34', result: 'wizard_srt_solids' },
    { title: 'Step 4: Get WAS Flow', input: 'wizard_srt_was', label: 'Enter WAS flow (MGD)', default: 0.05, hint: 'Daily waste sludge volume' },
    { title: 'Step 5: Get WAS TSS', input: 'wizard_srt_wastss', label: 'Enter WAS TSS (mg/L)', default: 8000, hint: 'Concentration of waste sludge' },
    { title: 'Step 6: Calculate SRT', calc: true, formula: 'SRT = System Solids / (WAS Flow √ó WAS TSS √ó 8.34)', result: 'wizard_srt', final: true }
  ],
  was: [
    { title: 'Step 1: Current MLSS', input: 'wizard_was_mlss', label: 'Enter current MLSS (mg/L)', default: 3500, hint: 'Your current concentration' },
    { title: 'Step 2: Target MLSS', input: 'wizard_was_target', label: 'Enter target MLSS (mg/L)', default: 3000, hint: 'Desired concentration' },
    { title: 'Step 3: Aeration Volume', input: 'wizard_was_vol', label: 'Enter volume (MG)', default: 1.0, hint: 'Basin volume' },
    { title: 'Step 4: Calculate WAS Needed', calc: true, formula: 'WAS = (Current - Target) √ó Volume √ó 8.34 / WAS Concentration', result: 'wizard_was_result', final: true }
  ],
  chlorine: [
    { title: 'Step 1: Get Flow Rate', input: 'wizard_cl_flow', label: 'Enter flow (MGD)', default: 5.0, hint: 'Daily flow rate' },
    { title: 'Step 2: Target Dose', input: 'wizard_cl_dose', label: 'Enter target dose (mg/L)', default: 5.0, hint: 'Typical 2-10 mg/L' },
    { title: 'Step 3: Solution Strength', input: 'wizard_cl_str', label: 'Enter solution strength (%)', default: 12.5, hint: 'Check chemical label' },
    { title: 'Step 4: Calculate Feed Rate', calc: true, formula: 'Feed = (Flow √ó Dose √ó 8.34) / (Strength √ó 8.34)', result: 'wizard_cl_result', final: true }
  ],

  svi: [
    { title: 'Step 1: Get Settled Volume', input: 'wizard_svi_vol', label: 'Enter 30-min settled volume (mL/L)', default: 250, hint: 'Use 1L graduated cylinder, let settle 30 min' },
    { title: 'Step 2: Get MLSS', input: 'wizard_svi_mlss', label: 'Enter MLSS (mg/L)', default: 3000, hint: 'From lab analysis or portable meter' },
    { title: 'Step 3: Calculate SVI', calc: true, formula: 'SVI = (Settled Volume √ó 1000) / MLSS', result: 'wizard_svi', final: true }
  ],
  bod_removal: [
    { title: 'Step 1: Get Influent BOD', input: 'wizard_bod_in', label: 'Enter influent BOD (mg/L)', default: 200, hint: 'From lab analysis, typical 150-300 mg/L' },
    { title: 'Step 2: Get Effluent BOD', input: 'wizard_bod_out', label: 'Enter effluent BOD (mg/L)', default: 15, hint: 'From lab analysis, permit limit typically <30 mg/L' },
    { title: 'Step 3: Get Flow Rate', input: 'wizard_bod_flow', label: 'Enter flow rate (MGD)', default: 5.0, hint: 'Daily average flow' },
    { title: 'Step 4: Calculate Removal', calc: true, formula: '% Removal = ((In - Out) / In) √ó 100', result: 'wizard_bod_removal', final: true }
  ],
  ras: [
    { title: 'Step 1: Get Influent Flow', input: 'wizard_ras_flow', label: 'Enter influent flow (MGD)', default: 5.0, hint: 'Current plant flow rate' },
    { title: 'Step 2: Get MLSS', input: 'wizard_ras_mlss', label: 'Enter aeration MLSS (mg/L)', default: 3000, hint: 'Mixed liquor concentration' },
    { title: 'Step 3: Get RAS TSS', input: 'wizard_ras_tss', label: 'Enter RAS TSS (mg/L)', default: 8000, hint: 'Return sludge concentration, typically 6000-12000' },
    { title: 'Step 4: Calculate RAS Rate', calc: true, formula: 'RAS Rate = (MLSS √ó Q) / (RAS TSS - MLSS)', result: 'wizard_ras_rate', final: true }
  ],
  detention: [
    { title: 'Step 1: Get Tank Volume', input: 'wizard_det_vol', label: 'Enter tank volume (gallons)', default: 500000, hint: 'Total basin volume' },
    { title: 'Step 2: Get Flow Rate', input: 'wizard_det_flow', label: 'Enter flow rate (GPM)', default: 3500, hint: 'Current flow in gallons per minute' },
    { title: 'Step 3: Calculate Detention Time', calc: true, formula: 'DT = Volume / Flow', result: 'wizard_det_time', final: true }
  ],
  sor: [
    { title: 'Step 1: Get Flow Rate', input: 'wizard_sor_flow', label: 'Enter flow rate (GPD)', default: 5000000, hint: 'Daily flow in gallons' },
    { title: 'Step 2: Get Clarifier Area', input: 'wizard_sor_area', label: 'Enter surface area (sq ft)', default: 5000, hint: 'œÄ √ó r¬≤ for circular clarifier' },
    { title: 'Step 3: Calculate SOR', calc: true, formula: 'SOR = Flow / Area', result: 'wizard_sor', final: true }
  ],
  polymer: [
    { title: 'Step 1: Get Sludge Flow', input: 'wizard_poly_flow', label: 'Enter sludge flow (GPM)', default: 100, hint: 'Feed rate to dewatering' },
    { title: 'Step 2: Get Sludge Solids', input: 'wizard_poly_solids', label: 'Enter feed solids (%)', default: 3.0, hint: 'Percent solids in feed sludge' },
    { title: 'Step 3: Get Target Dose', input: 'wizard_poly_dose', label: 'Enter target dose (lb/ton)', default: 15, hint: 'Typical 10-25 lb/dry ton' },
    { title: 'Step 4: Get Polymer Strength', input: 'wizard_poly_str', label: 'Enter solution strength (%)', default: 0.5, hint: 'Neat polymer is typically 0.25-0.5%' },
    { title: 'Step 5: Calculate Feed Rate', calc: true, formula: 'Polymer GPM = (Sludge GPM √ó %Solids √ó Dose) / (%Strength √ó 8.34 √ó 2000)', result: 'wizard_poly_rate', final: true }
  ],
  blower: [
    { title: 'Step 1: Get BOD Load', input: 'wizard_air_bod', label: 'Enter BOD load (lb/day)', default: 8340, hint: 'From BOD √ó Flow √ó 8.34' },
    { title: 'Step 2: Get O2 Ratio', input: 'wizard_air_ratio', label: 'Enter O2/BOD ratio', default: 1.5, hint: 'Typical 1.1-1.5 for carbonaceous, 2.0+ for nitrification' },
    { title: 'Step 3: Get Transfer Efficiency', input: 'wizard_air_eff', label: 'Enter transfer efficiency (%)', default: 8, hint: 'Fine bubble: 6-12%, Coarse: 4-8%' },
    { title: 'Step 4: Get Diffuser Depth', input: 'wizard_air_depth', label: 'Enter diffuser depth (ft)', default: 15, hint: 'Depth below water surface' },
    { title: 'Step 5: Calculate Air Required', calc: true, formula: 'SCFM = (O2 Required √ó 100) / (%Eff √ó 0.0173 √ó Depth)', result: 'wizard_air_scfm', final: true }
  ],
  ct: [
    { title: 'Step 1: Get Contact Time', input: 'wizard_ct_time', label: 'Enter contact time T10 (min)', default: 30, hint: 'Time for 10% of flow to pass through tank' },
    { title: 'Step 2: Get Chlorine Residual', input: 'wizard_ct_cl', label: 'Enter chlorine residual (mg/L)', default: 0.5, hint: 'Free or total chlorine at outlet' },
    { title: 'Step 3: Get Required CT', input: 'wizard_ct_req', label: 'Enter required CT (mg¬∑min/L)', default: 15, hint: 'From permit or tables based on pathogen' },
    { title: 'Step 4: Calculate CT Ratio', calc: true, formula: 'CT Ratio = (Residual √ó Time) / Required CT', result: 'wizard_ct_ratio', final: true }
  ]

};

var currentWizard = null;
var currentStep = 0;
var wizardData = {};

function startWizard(type) {
  currentWizard = type;
  currentStep = 0;
  wizardData = {};
  showWizardStep();
  document.getElementById('wizardModal').style.display = 'flex';
}

function showWizardStep() {
  var steps = wizardSteps[currentWizard];
  var step = steps[currentStep];
  var html = '<h3 style="color:#4ade80;margin:0 0 20px 0">' + step.title + '</h3>';

  if (step.calc) {
    html += '<div style="background:#0c1929;padding:15px;border-radius:8px;margin-bottom:15px">';
    html += '<div style="color:#60a5fa;font-family:monospace">' + step.formula + '</div>';
    html += '</div>';

    var result = calculateWizardStep(currentWizard, currentStep);
    wizardData[step.result] = result;

    html += '<div style="background:#06d6a0;color:white;padding:20px;border-radius:8px;text-align:center;font-size:18px;font-weight:bold">';
    html += result.toFixed(2);
    html += '</div>';

    if (step.final) {
      html += '<div style="margin-top:15px;padding:15px;background:#0c1929;border-radius:8px">';
      html += '<strong style="color:#ffd166">Interpretation:</strong>';
      html += '<p style="color:#e0f2fe;margin:10px 0 0 0">' + getWizardInterpretation(currentWizard, result) + '</p>';
      html += '</div>';
    }
  } else {
    html += '<label style="color:#e0f2fe;display:block;margin-bottom:10px">' + step.label + '</label>';
    html += '<input type="number" id="' + step.input + '" value="' + step.default + '" style="width:100%;padding:15px;font-size:18px;border-radius:8px;border:2px solid #243b55;background:#0c1929;color:white">';
    html += '<p style="color:#94a3b8;margin-top:10px;font-size:14px">üí° ' + step.hint + '</p>';
  }

  html += '<div style="display:flex;gap:10px;margin-top:20px">';
  if (currentStep > 0) {
    html += '<button onclick="prevWizardStep()" style="flex:1;padding:12px;background:#6b7280;color:white;border:none;border-radius:8px;cursor:pointer">‚Üê Back</button>';
  }
  if (currentStep < steps.length - 1) {
    html += '<button onclick="nextWizardStep()" style="flex:1;padding:12px;background:#0077b6;color:white;border:none;border-radius:8px;cursor:pointer">Next ‚Üí</button>';
  } else {
    html += '<button onclick="closeWizard()" style="flex:1;padding:12px;background:#06d6a0;color:white;border:none;border-radius:8px;cursor:pointer">‚úì Done</button>';
  }
  html += '</div>';
  html += '<button onclick="closeWizard()" style="width:100%;padding:10px;background:transparent;color:#94a3b8;border:1px solid #243b55;border-radius:8px;cursor:pointer;margin-top:10px">Cancel</button>';

  document.getElementById('wizardContent').innerHTML = html;
}

function nextWizardStep() {
  var steps = wizardSteps[currentWizard];
  var step = steps[currentStep];
  if (step.input) {
    wizardData[step.input] = parseFloat(document.getElementById(step.input).value) || 0;
  }
  currentStep++;
  showWizardStep();
}

function prevWizardStep() {
  currentStep--;
  showWizardStep();
}

function closeWizard() {
  document.getElementById('wizardModal').style.display = 'none';
  currentWizard = null;
}

function calculateWizardStep(type, step) {
  if (type === 'fm') {
    if (step === 2) {
      return wizardData.wizard_bod * wizardData.wizard_flow * 8.34;
    } else if (step === 5) {
      var bodLoad = wizardData.wizard_bod * wizardData.wizard_flow * 8.34;
      var biomass = wizardData.wizard_mlvss * wizardData.wizard_vol * 8.34;
      return biomass > 0 ? bodLoad / biomass : 0;
    }
  } else if (type === 'srt') {
    if (step === 2) {
      return wizardData.wizard_srt_mlss * wizardData.wizard_srt_vol * 8.34;
    } else if (step === 5) {
      var solids = wizardData.wizard_srt_mlss * wizardData.wizard_srt_vol * 8.34;
      var wasted = wizardData.wizard_srt_was * wizardData.wizard_srt_wastss * 8.34;
      return wasted > 0 ? solids / wasted : 0;
    }
  } else if (type === 'was') {
    if (step === 3) {
      var diff = wizardData.wizard_was_mlss - wizardData.wizard_was_target;
      return diff * wizardData.wizard_was_vol * 8.34 / 8000;
    }
  } else if (type === 'chlorine') {
    if (step === 3) {
      return (wizardData.wizard_cl_flow * wizardData.wizard_cl_dose * 8.34) / (wizardData.wizard_cl_str / 100 * 8.34);
    }
  } else if (type === 'svi') {
    if (step === 2) {
      return (wizardData.wizard_svi_vol * 1000) / wizardData.wizard_svi_mlss;
    }
  } else if (type === 'bod_removal') {
    if (step === 3) {
      var removed = wizardData.wizard_bod_in - wizardData.wizard_bod_out;
      return (removed / wizardData.wizard_bod_in) * 100;
    }
  } else if (type === 'ras') {
    if (step === 3) {
      var numerator = wizardData.wizard_ras_mlss * wizardData.wizard_ras_flow;
      var denominator = wizardData.wizard_ras_tss - wizardData.wizard_ras_mlss;
      return denominator > 0 ? numerator / denominator : 0;
    }
  } else if (type === 'detention') {
    if (step === 2) {
      return wizardData.wizard_det_vol / wizardData.wizard_det_flow;
    }
  } else if (type === 'sor') {
    if (step === 2) {
      return wizardData.wizard_sor_flow / wizardData.wizard_sor_area;
    }
  } else if (type === 'polymer') {
    if (step === 4) {
      var dryTonsPerMin = (wizardData.wizard_poly_flow * 8.34 * wizardData.wizard_poly_solids / 100) / 2000;
      var lbPolyPerMin = dryTonsPerMin * wizardData.wizard_poly_dose;
      var polyGPM = lbPolyPerMin / (wizardData.wizard_poly_str / 100 * 8.34);
      return polyGPM;
    }
  } else if (type === 'blower') {
    if (step === 4) {
      var o2Required = wizardData.wizard_air_bod * wizardData.wizard_air_ratio;
      var scfm = (o2Required * 100) / (wizardData.wizard_air_eff * 0.0173 * wizardData.wizard_air_depth * 60);
      return scfm;
    }
  } else if (type === 'ct') {
    if (step === 3) {
      var actualCT = wizardData.wizard_ct_cl * wizardData.wizard_ct_time;
      return actualCT / wizardData.wizard_ct_req;
    }
  }
  return 0;
}

function getWizardInterpretation(type, value) {
  if (type === 'fm') {
    if (value < 0.15) return 'F/M is LOW - Extended aeration mode. May see nitrification but risk of pin floc.';
    if (value <= 0.5) return 'F/M is OPTIMAL - Good balance of treatment and settling.';
    return 'F/M is HIGH - May see poor settling and incomplete treatment. Consider wasting less.';
  } else if (type === 'srt') {
    if (value < 5) return 'SRT is LOW - Risk of washout. Reduce wasting rate.';
    if (value <= 15) return 'SRT is OPTIMAL - Good for conventional activated sludge.';
    return 'SRT is HIGH - Old sludge, may see pin floc. Increase wasting.';
  } else if (type === 'was') {
    return 'Waste approximately ' + value.toFixed(2) + ' MG of sludge to reach target MLSS.';
  } else if (type === 'chlorine') {
    return 'Feed ' + value.toFixed(1) + ' gallons per day of chlorine solution.';
  } else if (type === 'svi') {
    if (value < 80) return 'SVI is LOW (' + value.toFixed(0) + ') - May indicate pin floc or old sludge. Consider reducing SRT.';
    if (value <= 150) return 'SVI is OPTIMAL (' + value.toFixed(0) + ') - Good settling characteristics.';
    return 'SVI is HIGH (' + value.toFixed(0) + ') - Bulking sludge! Check for filaments, low DO, or nutrient deficiency.';
  } else if (type === 'bod_removal') {
    if (value >= 85) return 'BOD Removal: ' + value.toFixed(1) + '% - Excellent! Meeting typical permit requirements.';
    if (value >= 75) return 'BOD Removal: ' + value.toFixed(1) + '% - Acceptable but could improve.';
    return 'BOD Removal: ' + value.toFixed(1) + '% - LOW! Check process parameters and biomass health.';
  } else if (type === 'ras') {
    return 'RAS Rate: ' + value.toFixed(2) + ' MGD (' + (value / wizardData.wizard_ras_flow * 100).toFixed(0) + '% of influent flow). Typical range: 25-75% of influent.';
  } else if (type === 'detention') {
    var hours = value / 60;
    return 'Detention Time: ' + value.toFixed(1) + ' minutes (' + hours.toFixed(2) + ' hours). Aeration basins typically need 4-8 hours.';
  } else if (type === 'sor') {
    if (value <= 800) return 'SOR: ' + value.toFixed(0) + ' gpd/sf - Excellent for secondary clarifier (design <800-1000).';
    if (value <= 1200) return 'SOR: ' + value.toFixed(0) + ' gpd/sf - Acceptable for primary or peak conditions.';
    return 'SOR: ' + value.toFixed(0) + ' gpd/sf - HIGH! May cause solids carryover. Consider flow equalization.';
  } else if (type === 'polymer') {
    return 'Polymer Feed Rate: ' + value.toFixed(2) + ' GPM of prepared solution. Verify with jar testing.';
  } else if (type === 'blower') {
    return 'Air Required: ' + value.toFixed(0) + ' SCFM. At standard conditions (1 atm, 68¬∞F). Add 10-20% safety factor.';
  } else if (type === 'ct') {
    if (value >= 1.0) return 'CT Ratio: ' + value.toFixed(2) + ' - COMPLIANT! Adequate disinfection achieved.';
    return 'CT Ratio: ' + value.toFixed(2) + ' - NON-COMPLIANT! Increase chlorine dose or contact time.';
  }
  return '';
}

// Training Modules
var completedModules = JSON.parse(localStorage.getItem('wwtp_training') || '[]');

function startTraining(moduleNum) {
  var content = document.getElementById('training' + moduleNum + 'Content');
  if (content.style.display === 'none') {
    content.style.display = 'block';
  } else {
    content.style.display = 'none';
  }
}

function completeModule(moduleNum) {
  if (!completedModules.includes(moduleNum)) {
    completedModules.push(moduleNum);
    localStorage.setItem('wwtp_training', JSON.stringify(completedModules));
  }
  updateTrainingProgress();
  showToast('Module ' + moduleNum + ' completed! üéâ', 'success');
  document.getElementById('training' + moduleNum + 'Content').style.display = 'none';
}

function updateTrainingProgress() {
  document.getElementById('trainingProgress').textContent = completedModules.length + ' / 3 modules';
  if (completedModules.length === 3) {
    document.getElementById('trainingProgress').innerHTML = '3 / 3 modules <span style="color:#06d6a0">‚úì CERTIFIED!</span>';
  }
}

// Load training progress on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(updateTrainingProgress, 600);
});

// Formula Reference
var formulaDetails = {
  fm: {
    title: '‚öñÔ∏è F/M Ratio (Food to Microorganism)',
    formula: 'F/M = (BOD √ó Flow √ó 8.34) / (MLVSS √ó Volume √ó 8.34)',
    explanation: 'The F/M ratio represents the amount of food (BOD) available per unit of microorganisms (MLVSS) per day.',
    variables: [
      'BOD = Influent BOD concentration (mg/L)',
      'Flow = Daily flow rate (MGD)',
      'MLVSS = Mixed Liquor Volatile Suspended Solids (mg/L)',
      'Volume = Aeration basin volume (MG)',
      '8.34 = Conversion factor (lb/gal)'
    ],
    typical: 'Conventional: 0.2-0.5 lb BOD/lb MLVSS/day | Extended Aeration: 0.05-0.15',
    notes: 'Low F/M = old sludge, nitrification | High F/M = young sludge, may have settling issues'
  },
  srt: {
    title: '‚è±Ô∏è SRT (Solids Retention Time)',
    formula: 'SRT = (MLSS √ó Volume √ó 8.34) / [(WAS √ó TSS √ó 8.34) + (Eff √ó TSS √ó 8.34)]',
    explanation: 'SRT represents the average time that solids (microorganisms) remain in the system.',
    variables: [
      'MLSS = Mixed Liquor Suspended Solids (mg/L)',
      'Volume = Aeration volume (MG)',
      'WAS = Waste Activated Sludge flow (MGD)',
      'TSS = Total Suspended Solids concentrations (mg/L)',
      'Eff = Effluent flow (MGD)'
    ],
    typical: 'Conventional: 5-15 days | Extended Aeration: 20-30 days | Nitrification: >10 days',
    notes: 'Longer SRT = older sludge, better nitrification but may have settling issues'
  },
  svi: {
    title: 'üß™ SVI (Sludge Volume Index)',
    formula: 'SVI = (Settled Volume mL/L √ó 1000) / MLSS mg/L',
    explanation: 'SVI indicates the settling characteristics of activated sludge.',
    variables: [
      'Settled Volume = Volume of sludge after 30 minutes settling (mL/L)',
      'MLSS = Mixed Liquor Suspended Solids (mg/L)'
    ],
    typical: 'Good settling: 80-150 mL/g | Bulking sludge: >150 mL/g | Pin floc: <50 mL/g',
    notes: 'High SVI indicates bulking (filamentous bacteria). Low SVI may indicate old sludge or pin floc.'
  },
  bod: {
    title: 'üìä BOD Loading',
    formula: 'BOD Load (lb/day) = BOD (mg/L) √ó Flow (MGD) √ó 8.34',
    explanation: 'Calculates the mass of BOD entering the plant per day.',
    variables: [
      'BOD = Biochemical Oxygen Demand concentration (mg/L)',
      'Flow = Daily flow rate (MGD)',
      '8.34 = Conversion factor (lb/gal)'
    ],
    typical: 'Varies by plant size. Used to calculate organic loading rate and F/M ratio.',
    notes: 'The 8.34 factor converts mg/L √ó MG to pounds.'
  },
  removal: {
    title: 'üìâ Percent Removal',
    formula: '% Removal = ((Influent - Effluent) / Influent) √ó 100',
    explanation: 'Calculates the efficiency of any treatment process.',
    variables: [
      'Influent = Concentration entering process (mg/L)',
      'Effluent = Concentration leaving process (mg/L)'
    ],
    typical: 'BOD: 85-95% | TSS: 85-95% | Ammonia: 90-99% (if nitrifying)',
    notes: 'Can be applied to any parameter. Essential for permit compliance tracking.'
  },
  detention: {
    title: '‚è∞ Detention Time',
    formula: 'DT (hours) = (Volume gal √ó 24) / (Flow GPD)',
    explanation: 'The theoretical time water spends in a tank or basin.',
    variables: [
      'Volume = Tank volume (gallons)',
      'Flow = Flow rate (GPD)',
      '24 = Hours per day'
    ],
    typical: 'Aeration: 4-8 hours | Primary clarifier: 1.5-2.5 hours | Secondary clarifier: 2-4 hours',
    notes: 'Also called Hydraulic Retention Time (HRT). Actual retention time varies due to short-circuiting.'
  },
  sor: {
    title: 'üåä Surface Overflow Rate',
    formula: 'SOR = Flow (GPD) / Surface Area (sq ft)',
    explanation: 'The hydraulic loading rate on a clarifier surface.',
    variables: [
      'Flow = Daily flow rate (GPD)',
      'Surface Area = Clarifier surface area (sq ft)'
    ],
    typical: 'Primary: 800-1200 gpd/sf | Secondary: 400-800 gpd/sf',
    notes: 'Lower SOR = better settling. Peak flow SOR should not exceed design limits.'
  },
  ct: {
    title: 'üß™ CT (Disinfection)',
    formula: 'CT = Chlorine Residual (mg/L) √ó Contact Time (minutes)',
    explanation: 'CT concept ensures adequate disinfection by considering both dose and time.',
    variables: [
      'Chlorine Residual = Free or total chlorine remaining (mg/L)',
      'Contact Time = Time in contact chamber at peak flow (minutes)'
    ],
    typical: 'Required CT varies by pathogen and temperature. Typical >15 mg¬∑min/L for bacteria.',
    notes: 'Higher temperature = lower CT required. Must use T10 (time for 10% of flow to pass).'
  }
};

function showFormulaDetail(formula) {
  var detail = formulaDetails[formula];
  var html = '<h3 style="color:#4ade80;margin:0 0 20px 0">' + detail.title + '</h3>';
  html += '<div style="background:#0c1929;padding:15px;border-radius:8px;margin-bottom:15px">';
  html += '<div style="color:#e0f2fe;font-family:monospace;font-size:16px">' + detail.formula + '</div>';
  html += '</div>';
  html += '<h4 style="color:#60a5fa;margin:15px 0 10px 0">Explanation:</h4>';
  html += '<p style="color:#e0f2fe;line-height:1.6">' + detail.explanation + '</p>';
  html += '<h4 style="color:#60a5fa;margin:15px 0 10px 0">Variables:</h4>';
  html += '<ul style="color:#e0f2fe;line-height:1.8">';
  detail.variables.forEach(function(v) {
    html += '<li>' + v + '</li>';
  });
  html += '</ul>';
  html += '<h4 style="color:#60a5fa;margin:15px 0 10px 0">Typical Values:</h4>';
  html += '<p style="color:#06d6a0">' + detail.typical + '</p>';
  html += '<h4 style="color:#ffd166;margin:15px 0 10px 0">Notes:</h4>';
  html += '<p style="color:#94a3b8">' + detail.notes + '</p>';

  document.getElementById('formulaDetail').innerHTML = html;
  document.getElementById('formulaModal').style.display = 'flex';
}

function closeFormulaModal() {
  document.getElementById('formulaModal').style.display = 'none';
}

// ========== END OPERATOR TOOLS ==========
// ========== QUICK WIN ENHANCEMENTS v5.1.0 ==========

// CT Calculation
function calcCT() {
  var cl = parseFloat(document.getElementById('ct_cl').value) || 0;
  var time = parseFloat(document.getElementById('ct_time').value) || 0;
  var required = parseFloat(document.getElementById('ct_required').value) || 0;
  var actual = cl * time;
  var ratio = required > 0 ? actual / required : 0;
  document.getElementById('r_ct_actual').textContent = actual.toFixed(1);
  document.getElementById('r_ct_ratio').textContent = ratio.toFixed(2);
  var status = ratio >= 1.0 ? '‚úì Compliant' : '‚úó Non-Compliant';
  document.getElementById('r_ct_status').textContent = status;
  document.getElementById('r_ct_status').style.color = ratio >= 1.0 ? '#06d6a0' : '#ef4444';
}
function resetCT() {
  document.getElementById('ct_cl').value = '0.5';
  document.getElementById('ct_time').value = '30';
  document.getElementById('ct_required').value = '15';
  ['r_ct_actual','r_ct_ratio','r_ct_status'].forEach(id => {
    document.getElementById(id).textContent = '-';
    document.getElementById(id).style.color = '';
  });
}

// Geometric Mean
function calcGeoMean() {
  var input = document.getElementById('geomean_values').value;
  var values = input.split(',').map(v => parseFloat(v.trim())).filter(v => !isNaN(v) && v > 0);
  if (values.length === 0) return;
  var count = values.length;
  var arith = values.reduce((a,b) => a+b, 0) / count;
  var logSum = values.reduce((a,b) => a + Math.log(b), 0);
  var geoMean = Math.exp(logSum / count);
  var logMean = logSum / count;
  document.getElementById('r_geo_count').textContent = count;
  document.getElementById('r_geo_arith').textContent = arith.toFixed(1);
  document.getElementById('r_geo_mean').textContent = geoMean.toFixed(1);
  document.getElementById('r_geo_log').textContent = logMean.toFixed(3);
}
function resetGeoMean() {
  document.getElementById('geomean_values').value = '100,200,150,180,120';
  ['r_geo_count','r_geo_arith','r_geo_mean','r_geo_log'].forEach(id => document.getElementById(id).textContent = '-');
}

// Dilution Calculator
function calcDilution() {
  var c1 = parseFloat(document.getElementById('dil_c1').value) || 0;
  var c2 = parseFloat(document.getElementById('dil_c2').value) || 0;
  var v2 = parseFloat(document.getElementById('dil_v2').value) || 0;
  var v1 = c1 > 0 ? (c2 * v2) / c1 : 0;
  var diluent = v2 - v1;
  var factor = c2 > 0 ? c1 / c2 : 0;
  document.getElementById('r_dil_v1').textContent = v1.toFixed(2);
  document.getElementById('r_dil_diluent').textContent = diluent.toFixed(2);
  document.getElementById('r_dil_factor').textContent = factor.toFixed(1);
}
function resetDilution() {
  document.getElementById('dil_c1').value = '1000';
  document.getElementById('dil_c2').value = '100';
  document.getElementById('dil_v2').value = '1000';
  ['r_dil_v1','r_dil_diluent','r_dil_factor'].forEach(id => document.getElementById(id).textContent = '-');
}

// Sludge Judge Calculator
function calcSludgeJudge() {
  var vol = parseFloat(document.getElementById('sj_vol').value) || 0;
  var mlss = parseFloat(document.getElementById('sj_mlss').value) || 0;
  var depth = parseFloat(document.getElementById('sj_depth').value) || 0;
  var blanket = parseFloat(document.getElementById('sj_blanket').value) || 0;
  var svi = mlss > 0 ? (vol * 1000) / mlss : 0;
  var sdi = svi > 0 ? 100 / svi : 0;
  var pct = depth > 0 ? (blanket / depth) * 100 : 0;
  document.getElementById('r_sj_svi').textContent = svi.toFixed(0);
  document.getElementById('r_sj_sdi').textContent = sdi.toFixed(2);
  document.getElementById('r_sj_pct').textContent = pct.toFixed(1);
  var status = pct < 25 ? '‚úì Good' : pct < 40 ? '‚ö† Watch' : '‚úó High';
  document.getElementById('r_sj_status').textContent = status;
}
function resetSludgeJudge() {
  document.getElementById('sj_vol').value = '250';
  document.getElementById('sj_mlss').value = '3000';
  document.getElementById('sj_depth').value = '12';
  document.getElementById('sj_blanket').value = '3';
  ['r_sj_svi','r_sj_sdi','r_sj_pct','r_sj_status'].forEach(id => document.getElementById(id).textContent = '-');
}

// Mass Balance
function calcMassBalance() {
  var flowIn = parseFloat(document.getElementById('mb_flow_in').value) || 0;
  var concIn = parseFloat(document.getElementById('mb_conc_in').value) || 0;
  var flowOut = parseFloat(document.getElementById('mb_flow_out').value) || 0;
  var concOut = parseFloat(document.getElementById('mb_conc_out').value) || 0;
  var sludge = parseFloat(document.getElementById('mb_sludge').value) || 0;
  var massIn = flowIn * concIn * 8.34;
  var massOut = flowOut * concOut * 8.34;
  var removed = massIn - massOut;
  var error = removed > 0 ? ((removed - sludge) / removed) * 100 : 0;
  document.getElementById('r_mb_in').textContent = massIn.toFixed(0);
  document.getElementById('r_mb_out').textContent = massOut.toFixed(0);
  document.getElementById('r_mb_removed').textContent = removed.toFixed(0);
  document.getElementById('r_mb_error').textContent = error.toFixed(1);
}
function resetMassBalance() {
  document.getElementById('mb_flow_in').value = '5.0';
  document.getElementById('mb_conc_in').value = '200';
  document.getElementById('mb_flow_out').value = '4.95';
  document.getElementById('mb_conc_out').value = '10';
  document.getElementById('mb_sludge').value = '7500';
  ['r_mb_in','r_mb_out','r_mb_removed','r_mb_error'].forEach(id => document.getElementById(id).textContent = '-');
}

// ========== DATA PERSISTENCE ==========

// Save all input values to localStorage
function saveAllData() {
  try {
    var data = {};
    var inputs = document.querySelectorAll('input[id], select[id]');
    inputs.forEach(function(el) {
      if (el.id && el.id !== '') {
        data[el.id] = el.value;
      }
    });
    data._timestamp = new Date().toISOString();
    data._version = APP_VERSION;
    localStorage.setItem('wwtp_saved_data', JSON.stringify(data));
    showToast('All data saved! (' + Object.keys(data).length + ' values)', 'success');
    return true;
  } catch(e) {
    showToast('Error saving data', 'error');
    return false;
  }
}

// Load saved data from localStorage
function loadSavedData() {
  try {
    var saved = localStorage.getItem('wwtp_saved_data');
    if (!saved) {
      showToast('No saved data found', 'info');
      return false;
    }
    var data = JSON.parse(saved);
    var count = 0;
    Object.keys(data).forEach(function(id) {
      if (id.startsWith('_')) return;
      var el = document.getElementById(id);
      if (el) {
        el.value = data[id];
        count++;
      }
    });
    var timestamp = data._timestamp ? new Date(data._timestamp).toLocaleString() : 'Unknown';
    showToast('Loaded ' + count + ' values (saved: ' + timestamp + ')', 'success');
    return true;
  } catch(e) {
    showToast('Error loading data', 'error');
    return false;
  }
}

// Clear saved data
function clearSavedData() {
  if (confirm('Clear all saved data? This cannot be undone.')) {
    localStorage.removeItem('wwtp_saved_data');
    showToast('Saved data cleared', 'info');
  }
}

// Export configuration as JSON file
function exportConfig() {
  var data = {};
  var inputs = document.querySelectorAll('input[id], select[id]');
  inputs.forEach(function(el) {
    if (el.id) data[el.id] = el.value;
  });
  data._exported = new Date().toISOString();
  data._version = APP_VERSION;
  var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_config_' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Configuration exported!', 'success');
}

// Import configuration from JSON file
function importConfig() {
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function(e) {
    var file = e.target.files[0];
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var data = JSON.parse(e.target.result);
        var count = 0;
        Object.keys(data).forEach(function(id) {
          if (id.startsWith('_')) return;
          var el = document.getElementById(id);
          if (el) {
            el.value = data[id];
            count++;
          }
        });
        showToast('Imported ' + count + ' values', 'success');
      } catch(err) {
        showToast('Invalid configuration file', 'error');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// Auto-save every 5 minutes
var autoSaveInterval = null;
function enableAutoSave() {
  if (autoSaveInterval) clearInterval(autoSaveInterval);
  autoSaveInterval = setInterval(function() {
    saveAllData();
  }, 300000); // 5 minutes
  showToast('Auto-save enabled (every 5 min)', 'info');
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.shiftKey) {
    switch(e.key.toLowerCase()) {
      case 's':
        e.preventDefault();
        saveAllData();
        break;
      case 'l':
        e.preventDefault();
        loadSavedData();
        break;
      case 'e':
        e.preventDefault();
        exportConfig();
        break;
    }
  }
});

// ========== END QUICK WIN ENHANCEMENTS ==========
// ========== ENHANCED CALCULATORS v5.1.0 ==========

// Detention Time (General)
function calcDetention() {
  var vol = parseFloat(document.getElementById('det_vol').value) || 0;
  var gpm = parseFloat(document.getElementById('det_gpm').value) || 0;
  var minutes = gpm > 0 ? vol / gpm : 0;
  var hours = minutes / 60;
  document.getElementById('r_det_min').textContent = minutes.toFixed(1);
  document.getElementById('r_det_hr').textContent = hours.toFixed(2);
}
function resetDetention() {
  document.getElementById('det_vol').value = '500000';
  document.getElementById('det_gpm').value = '3500';
  document.getElementById('r_det_min').textContent = '-';
  document.getElementById('r_det_hr').textContent = '-';
}

// Population Equivalent
function calcPE() {
  var bod = parseFloat(document.getElementById('pe_bod').value) || 0;
  var flow = parseFloat(document.getElementById('pe_flow').value) || 0;
  var peBod = bod / 0.17; // 0.17 lb BOD/person/day
  var peFlow = (flow * 1000000) / 100; // 100 gpd/person typical
  var gpd = peBod > 0 ? (flow * 1000000) / peBod : 0;
  document.getElementById('r_pe_bod').textContent = Math.round(peBod).toLocaleString();
  document.getElementById('r_pe_flow').textContent = Math.round(peFlow).toLocaleString();
  document.getElementById('r_pe_gpd').textContent = gpd.toFixed(0);
}
function resetPE() {
  document.getElementById('pe_bod').value = '5000';
  document.getElementById('pe_flow').value = '5.0';
  ['r_pe_bod','r_pe_flow','r_pe_gpd'].forEach(id => document.getElementById(id).textContent = '-');
}

// Sludge Age (Simple)
function calcSludgeAge() {
  var mlss = parseFloat(document.getElementById('sa_mlss').value) || 0;
  var was = parseFloat(document.getElementById('sa_was').value) || 0;
  var age = was > 0 ? mlss / was : 0;
  document.getElementById('r_sa').textContent = age.toFixed(1);
  var status = age >= 5 && age <= 15 ? 'Optimal' : age < 5 ? 'Too Low' : 'Too High';
  document.getElementById('r_sa_status').textContent = status;
}
function resetSludgeAge() {
  document.getElementById('sa_mlss').value = '25000';
  document.getElementById('sa_was').value = '2500';
  document.getElementById('r_sa').textContent = '-';
  document.getElementById('r_sa_status').textContent = '-';
}

// Percent Removal (Universal)
function calcRemoval() {
  var inf = parseFloat(document.getElementById('rem_in').value) || 0;
  var eff = parseFloat(document.getElementById('rem_out').value) || 0;
  var amt = inf - eff;
  var pct = inf > 0 ? (amt / inf) * 100 : 0;
  document.getElementById('r_rem_amt').textContent = amt.toFixed(1);
  document.getElementById('r_rem_pct').textContent = pct.toFixed(1);
}
function resetRemoval() {
  document.getElementById('rem_in').value = '200';
  document.getElementById('rem_out').value = '20';
  document.getElementById('r_rem_amt').textContent = '-';
  document.getElementById('r_rem_pct').textContent = '-';
}

// Flow Unit Converter
function calcFlowConv() {
  var value = parseFloat(document.getElementById('conv_flow').value) || 0;
  var unit = document.getElementById('conv_unit').value;
  var mgd;
  // Convert to MGD first
  switch(unit) {
    case 'mgd': mgd = value; break;
    case 'gpm': mgd = value * 1440 / 1000000; break;
    case 'gpd': mgd = value / 1000000; break;
    case 'cfs': mgd = value * 0.6463; break;
    case 'm3d': mgd = value / 3785.41; break;
    case 'lps': mgd = value * 0.0228; break;
    default: mgd = value;
  }
  // Convert from MGD to all units
  document.getElementById('r_conv_mgd').textContent = mgd.toFixed(4);
  document.getElementById('r_conv_gpm').textContent = (mgd * 1000000 / 1440).toFixed(1);
  document.getElementById('r_conv_gpd').textContent = (mgd * 1000000).toFixed(0);
  document.getElementById('r_conv_cfs').textContent = (mgd / 0.6463).toFixed(3);
  document.getElementById('r_conv_m3d').textContent = (mgd * 3785.41).toFixed(1);
  document.getElementById('r_conv_lps').textContent = (mgd / 0.0228).toFixed(2);
}
function resetFlowConv() {
  document.getElementById('conv_flow').value = '5.0';
  document.getElementById('conv_unit').value = 'mgd';
  ['r_conv_mgd','r_conv_gpm','r_conv_gpd','r_conv_cfs','r_conv_m3d','r_conv_lps'].forEach(id => document.getElementById(id).textContent = '-');
}

// Blower Noise Estimation
function calcNoise() {
  var hp = parseFloat(document.getElementById('noise_hp').value) || 0;
  var dist = parseFloat(document.getElementById('noise_dist').value) || 50;
  var num = parseFloat(document.getElementById('noise_num').value) || 1;
  // Rough estimate: base 85 dB at 3ft for 100HP, +3dB per doubling of HP
  var baseDb = 85 + 10 * Math.log10(hp / 100);
  // Distance attenuation: -6dB per doubling of distance from 3ft
  var distDb = baseDb - 20 * Math.log10(dist / 3);
  // Multiple sources: +3dB per doubling
  var totalDb = distDb + 10 * Math.log10(num);
  document.getElementById('r_noise_db').textContent = totalDb.toFixed(1);
  var status = totalDb < 65 ? 'Acceptable' : totalDb < 85 ? 'Caution - Hearing Protection' : 'Dangerous';
  document.getElementById('r_noise_status').textContent = status;
}
function resetNoise() {
  document.getElementById('noise_hp').value = '100';
  document.getElementById('noise_dist').value = '50';
  document.getElementById('noise_num').value = '2';
  document.getElementById('r_noise_db').textContent = '-';
  document.getElementById('r_noise_status').textContent = '-';
}

// Carbon Footprint Estimator
function calcCarbon() {
  var kwh = parseFloat(document.getElementById('carbon_kwh').value) || 0;
  var chem = parseFloat(document.getElementById('carbon_chem').value) || 0;
  var biogas = parseFloat(document.getElementById('carbon_biogas').value) || 0;
  // Energy: ~1.0 lb CO2/kWh (varies by grid)
  var energyCO2 = kwh * 1.0;
  // Chemicals: estimate ~0.5 lb CO2/lb chemical
  var chemCO2 = chem * 0.5;
  // Biogas offset: ~0.12 lb CO2/cf methane avoided
  var offsetCO2 = biogas * 0.6 * 0.12; // 60% methane
  var netCO2 = energyCO2 + chemCO2 - offsetCO2;
  document.getElementById('r_carbon_energy').textContent = energyCO2.toFixed(0);
  document.getElementById('r_carbon_chem').textContent = chemCO2.toFixed(0);
  document.getElementById('r_carbon_offset').textContent = offsetCO2.toFixed(0);
  document.getElementById('r_carbon_net').textContent = netCO2.toFixed(0);
}
function resetCarbon() {
  document.getElementById('carbon_kwh').value = '5000';
  document.getElementById('carbon_chem').value = '500';
  document.getElementById('carbon_biogas').value = '10000';
  ['r_carbon_energy','r_carbon_chem','r_carbon_offset','r_carbon_net'].forEach(id => document.getElementById(id).textContent = '-');
}

// Treatment Cost Analysis
function calcTreatmentCost() {
  var flow = parseFloat(document.getElementById('cost_flow').value) || 0;
  var energy = parseFloat(document.getElementById('cost_energy').value) || 0;
  var chem = parseFloat(document.getElementById('cost_chem').value) || 0;
  var labor = parseFloat(document.getElementById('cost_labor').value) || 0;
  var sludge = parseFloat(document.getElementById('cost_sludge').value) || 0;
  var total = energy + chem + labor + sludge;
  var perMG = flow > 0 ? total / flow : 0;
  var perKgal = perMG / 1000;
  var monthly = total * 30;
  var yearly = total * 365;
  document.getElementById('r_cost_total').textContent = '$' + total.toFixed(0);
  document.getElementById('r_cost_mg').textContent = '$' + perMG.toFixed(2);
  document.getElementById('r_cost_kgal').textContent = '$' + perKgal.toFixed(3);
  document.getElementById('r_cost_month').textContent = '$' + monthly.toLocaleString();
  document.getElementById('r_cost_year').textContent = '$' + yearly.toLocaleString();
}
function resetTreatmentCost() {
  document.getElementById('cost_flow').value = '5.0';
  document.getElementById('cost_energy').value = '1500';
  document.getElementById('cost_chem').value = '800';
  document.getElementById('cost_labor').value = '2000';
  document.getElementById('cost_sludge').value = '500';
  ['r_cost_total','r_cost_mg','r_cost_kgal','r_cost_month','r_cost_year'].forEach(id => document.getElementById(id).textContent = '-');
}

// ========== END ENHANCED CALCULATORS ==========
// ========== MASTER SYNC FUNCTIONS - See v9.5.0 syncMasterToAll below ==========
// Old sync functions removed - using consolidated version

// ========== GUIDED WIZARDS SYSTEM v9.5.0 ==========

var wizardData = {
  tss: {
    title: 'üî¥ High Effluent TSS Troubleshooting',
    color: '#dc2626',
    steps: {
      start: {
        question: 'Is the effluent TSS consistently high (>30 mg/L) or intermittently high?',
        answers: [
          { text: 'Consistently high (every day)', next: 'tss_consistent' },
          { text: 'Intermittent (spikes periodically)', next: 'tss_intermittent' }
        ]
      },
      tss_consistent: {
        question: 'What does the secondary clarifier look like?',
        answers: [
          { text: 'Sludge blanket is high (>3 ft)', next: 'tss_high_blanket' },
          { text: 'Floating/rising sludge observed', next: 'tss_rising' },
          { text: 'Billowing/bulking sludge', next: 'result_severe_bulking' },
          { text: 'Clarifier looks normal', next: 'tss_clarifier_ok' }
        ]
      },
      tss_intermittent: {
        question: 'When do the TSS spikes occur?',
        answers: [
          { text: 'During high flow events', next: 'result_hydraulic_overload' },
          { text: 'After RAS/WAS changes', next: 'result_ras_changes' },
          { text: 'Random/no pattern', next: 'result_toxic_load' },
          { text: 'Morning/startup periods', next: 'result_overnight_buildup' }
        ]
      },
      tss_high_blanket: {
        question: 'What is your current SRT (Sludge Retention Time)?',
        answers: [
          { text: 'SRT > 15 days (high)', next: 'result_increase_was' },
          { text: 'SRT 8-15 days (normal)', next: 'result_increase_ras' },
          { text: 'SRT < 8 days (low)', next: 'result_young_sludge' }
        ]
      },
      tss_rising: {
        question: 'Is nitrogen gas (denitrification) causing the rising sludge?',
        answers: [
          { text: 'Yes - bubbles visible, sludge floats then sinks', next: 'result_denitrification' },
          { text: 'No - sludge stays floating, greasy/foamy', next: 'result_septicity' }
        ]
      },
      tss_clarifier_ok: {
        question: 'Check the aeration basin. What do you observe?',
        answers: [
          { text: 'Foaming on surface', next: 'result_nocardia' },
          { text: 'Dark/black mixed liquor', next: 'result_septicity_basin' },
          { text: 'Light tan/brown, looks healthy', next: 'result_check_weirs' },
          { text: 'Very light color, thin floc', next: 'result_young_sludge' }
        ]
      }
    },
    results: {
      result_increase_was: { diagnosis: 'Excessive Sludge Inventory', cause: 'SRT is too high, causing excessive solids inventory. The clarifier cannot handle the solids load.', actions: ['Increase WAS rate by 10-15% incrementally', 'Target SRT of 8-12 days for conventional AS', 'Monitor sludge blanket daily until <2 ft', 'Verify WAS pumps and flow meters accurate'], severity: 'moderate' },
      result_young_sludge: { diagnosis: 'Young Sludge / Low SRT', cause: 'SRT is too low, resulting in young, poorly-settling sludge with dispersed growth.', actions: ['Reduce WAS rate immediately by 25-50%', 'Target MLSS of 2500-3500 mg/L', 'Allow 1-2 SRTs for sludge to mature', 'Consider adding polymer temporarily'], severity: 'high' },
      result_denitrification: { diagnosis: 'Denitrification in Clarifier', cause: 'Nitrate-rich sludge sitting too long in clarifier, releasing nitrogen gas.', actions: ['Increase RAS rate to reduce detention time', 'Target sludge blanket < 2 ft', 'Consider adding anoxic zone before clarifier', 'Check for septicity in collection system'], severity: 'moderate' },
      result_septicity: { diagnosis: 'Septic Conditions', cause: 'Anaerobic conditions developing in clarifier or sludge, causing gas production.', actions: ['Increase RAS pumping rate immediately', 'Check for sludge buildup in pipes/channels', 'Verify clarifier collector is working', 'May need to waste heavily and rebuild'], severity: 'high' },
      result_severe_bulking: { diagnosis: 'Severe Filamentous Bulking', cause: 'Excessive filamentous bacteria causing severe settling problems.', actions: ['Run Filamentous Bulking Wizard for detailed diagnosis', 'Consider chlorinating RAS (2-5 mg/L Cl‚ÇÇ)', 'Add polymer to clarifier (0.5-2 mg/L)', 'Address F/M ratio and selector zones'], severity: 'critical' },
      result_hydraulic_overload: { diagnosis: 'Hydraulic Overload', cause: 'Clarifier surface overflow rate exceeds design capacity during high flows.', actions: ['Equalize flows if possible', 'Bring additional clarifiers online', 'Review flow splitting between clarifiers', 'Evaluate clarifier capacity expansion'], severity: 'high' },
      result_ras_changes: { diagnosis: 'RAS/WAS Adjustment Impact', cause: 'Recent RAS or WAS changes have disrupted sludge balance.', actions: ['Review recent operational changes', 'Gradually return to previous settings', 'Monitor blanket depth response', 'Make changes incrementally in future'], severity: 'moderate' },
      result_toxic_load: { diagnosis: 'Toxic/Industrial Upset', cause: 'Industrial discharge has upset biological process, causing floc breakup.', actions: ['Identify and stop toxic source', 'Reduce WAS to preserve healthy biomass', 'Consider adding PAC', 'Monitor recovery over 1-3 SRTs'], severity: 'critical' },
      result_overnight_buildup: { diagnosis: 'Overnight Sludge Blanket Buildup', cause: 'RAS rate during low-flow periods not maintaining blanket control.', actions: ['Increase nighttime RAS rate', 'Consider RAS pacing based on time', 'Verify RAS pumps operate continuously', 'Check for timer or control issues'], severity: 'moderate' },
      result_increase_ras: { diagnosis: 'Low RAS Rate', cause: 'RAS rate insufficient to return solids and maintain proper blanket level.', actions: ['Increase RAS rate to 50-75% of influent', 'Monitor blanket depth response', 'Verify RAS pumps have adequate capacity', 'Check for air binding in RAS lines'], severity: 'moderate' },
      result_nocardia: { diagnosis: 'Nocardia/Foam-Causing Organisms', cause: 'Nocardia or similar foam-causing filaments present.', actions: ['Reduce SRT to 8-10 days', 'Improve grease/scum removal', 'Spray water or defoamer on foam', 'Consider chlorine spray on foam'], severity: 'moderate' },
      result_septicity_basin: { diagnosis: 'Septic Mixed Liquor', cause: 'Aeration basin has gone septic due to insufficient oxygen.', actions: ['Check all blowers and diffusers immediately', 'Verify DO > 2.0 mg/L throughout basin', 'Check for plugged diffusers', 'May need to increase air flow significantly'], severity: 'critical' },
      result_check_weirs: { diagnosis: 'Effluent Weir Issues', cause: 'Uneven or dirty weirs may be causing carryover.', actions: ['Level all weirs to within 1/8 inch', 'Clean weirs of algae and debris', 'Check weir loading rate', 'Consider V-notch weirs for better distribution'], severity: 'low' }
    }
  },
  bulking: {
    title: 'üü† Filamentous Bulking Troubleshooting',
    color: '#d97706',
    steps: {
      start: {
        question: 'What is your current SVI (Sludge Volume Index)?',
        answers: [
          { text: 'SVI > 250 (severe bulking)', next: 'bulk_severe' },
          { text: 'SVI 150-250 (moderate bulking)', next: 'bulk_moderate' },
          { text: 'SVI 100-150 (borderline)', next: 'result_bulk_monitor' },
          { text: 'Don\'t know - need to test', next: 'result_bulk_test_svi' }
        ]
      },
      bulk_severe: {
        question: 'Have you identified the filament type microscopically?',
        answers: [
          { text: 'Yes - Nocardia/foam formers', next: 'result_bulk_nocardia' },
          { text: 'Yes - Type 021N (sulfide)', next: 'result_bulk_sulfide' },
          { text: 'Yes - Type 1701 (low DO)', next: 'result_bulk_low_do' },
          { text: 'No - haven\'t identified', next: 'bulk_check_conditions' }
        ]
      },
      bulk_moderate: {
        question: 'What is your current F/M ratio?',
        answers: [
          { text: 'F/M < 0.15 (very low)', next: 'result_bulk_low_fm' },
          { text: 'F/M 0.15-0.5 (normal range)', next: 'bulk_check_do' },
          { text: 'F/M > 0.5 (high)', next: 'result_bulk_high_fm' }
        ]
      },
      bulk_check_conditions: {
        question: 'What is your typical DO level in the aeration basin?',
        answers: [
          { text: 'DO < 1.0 mg/L (low)', next: 'result_bulk_low_do' },
          { text: 'DO 1.0-2.0 mg/L', next: 'bulk_check_nutrients' },
          { text: 'DO > 2.0 mg/L (good)', next: 'bulk_check_nutrients' }
        ]
      },
      bulk_check_do: {
        question: 'What is your DO level throughout the aeration basin?',
        answers: [
          { text: 'DO < 1.0 mg/L anywhere', next: 'result_bulk_low_do' },
          { text: 'DO consistently > 1.5 mg/L', next: 'bulk_check_nutrients' }
        ]
      },
      bulk_check_nutrients: {
        question: 'Is there septic wastewater or sulfide in your influent?',
        answers: [
          { text: 'Yes - septic odors, black color', next: 'result_bulk_sulfide' },
          { text: 'No - typical municipal wastewater', next: 'result_bulk_selector' }
        ]
      }
    },
    results: {
      result_bulk_test_svi: { diagnosis: 'SVI Testing Required', cause: 'Cannot diagnose bulking without SVI data.', actions: ['Perform settleability test (30 min)', 'Calculate SVI = (Settled Vol √ó 1000) / MLSS', 'Normal SVI: 80-150 mL/g', 'Test daily until trend established'], severity: 'low' },
      result_bulk_nocardia: { diagnosis: 'Nocardia/Foam-Forming Filaments', cause: 'Associated with high SRT and fats/grease. Causes thick brown foam.', actions: ['Reduce SRT to 8-10 days', 'Improve FOG removal at headworks', 'Spray foam with water/chlorine', 'Ensure complete scum removal'], severity: 'high' },
      result_bulk_sulfide: { diagnosis: 'Sulfide-Related Bulking', cause: 'Sulfide-oxidizing filaments (Type 021N, Thiothrix) thrive with sulfide.', actions: ['Add ferric chloride at headworks (20-50 mg/L)', 'Eliminate septic conditions', 'Aerate collection system', 'Monitor influent for sulfide'], severity: 'high' },
      result_bulk_low_do: { diagnosis: 'Low DO Filamentous Bulking', cause: 'Insufficient DO favors filamentous bacteria (Type 1701, S. natans).', actions: ['Increase DO to > 2.0 mg/L everywhere', 'Check for plugged diffusers', 'Verify blower capacity', 'Eliminate dead zones'], severity: 'high' },
      result_bulk_monitor: { diagnosis: 'Borderline SVI - Monitor', cause: 'SVI is borderline but stable. Vigilance needed.', actions: ['Continue daily SVI monitoring', 'Document any process changes', 'Watch for upward trend', 'Maintain current conditions'], severity: 'low' },
      result_bulk_low_fm: { diagnosis: 'Low F/M Ratio Bulking', cause: 'Low F/M favors slow-growing filamentous bacteria.', actions: ['Reduce MLSS by increasing WAS', 'Target F/M of 0.2-0.4', 'Consider step-feed or selector', 'Takes 2-3 SRTs to improve'], severity: 'moderate' },
      result_bulk_high_fm: { diagnosis: 'High F/M - Unusual with Bulking', cause: 'High F/M is unusual with bulking. Check measurements.', actions: ['Verify MLSS and BOD measurements', 'Recalculate F/M ratio', 'Check for nutrient deficiency', 'Consider dispersed growth issues'], severity: 'low' },
      result_bulk_selector: { diagnosis: 'Consider Selector Zone', cause: 'Completely mixed systems favor filamentous growth.', actions: ['Evaluate space for selector', 'Design for F/M > 3 in selector', 'Consider anaerobic selector', 'Short-term: try step-feed'], severity: 'moderate' }
    }
  },
  ammonia: {
    title: 'üîµ High Effluent Ammonia Troubleshooting',
    color: '#2563eb',
    steps: {
      start: {
        question: 'How high is your effluent ammonia compared to permit?',
        answers: [
          { text: 'Significantly over (>5 mg/L excess)', next: 'nh3_severe' },
          { text: 'Moderately over (1-5 mg/L excess)', next: 'nh3_moderate' },
          { text: 'Slightly over or trending up', next: 'nh3_trending' }
        ]
      },
      nh3_severe: {
        question: 'Is this a sudden increase or gradual decline?',
        answers: [
          { text: 'Sudden - happened within days', next: 'nh3_sudden' },
          { text: 'Gradual - increasing over weeks', next: 'nh3_gradual' }
        ]
      },
      nh3_moderate: {
        question: 'What is your current SRT?',
        answers: [
          { text: 'SRT < 8 days', next: 'result_nh3_low_srt' },
          { text: 'SRT 8-15 days', next: 'nh3_check_do' },
          { text: 'SRT > 15 days', next: 'nh3_check_do' }
        ]
      },
      nh3_trending: {
        question: 'What seasonal conditions exist?',
        answers: [
          { text: 'Winter/cold temperatures', next: 'result_nh3_cold' },
          { text: 'Summer/warm temperatures', next: 'nh3_check_do' },
          { text: 'No significant temp change', next: 'nh3_check_do' }
        ]
      },
      nh3_sudden: {
        question: 'Have there been any toxic loads or industrial upsets?',
        answers: [
          { text: 'Yes - known toxic event', next: 'result_nh3_toxic' },
          { text: 'Possible - suspicious influent', next: 'result_nh3_toxic' },
          { text: 'No - influent appears normal', next: 'nh3_check_operations' }
        ]
      },
      nh3_gradual: {
        question: 'Has influent ammonia loading increased?',
        answers: [
          { text: 'Yes - higher NH‚ÇÉ loading', next: 'result_nh3_overload' },
          { text: 'No - loading is stable', next: 'nh3_check_do' }
        ]
      },
      nh3_check_do: {
        question: 'What DO level in nitrification zone?',
        answers: [
          { text: 'DO < 1.5 mg/L', next: 'result_nh3_low_do' },
          { text: 'DO 1.5-3.0 mg/L', next: 'nh3_check_alk' },
          { text: 'DO > 3.0 mg/L', next: 'nh3_check_alk' }
        ]
      },
      nh3_check_operations: {
        question: 'Any recent operational changes?',
        answers: [
          { text: 'Increased wasting (higher WAS)', next: 'result_nh3_overwaste' },
          { text: 'Changed aeration pattern', next: 'result_nh3_low_do' },
          { text: 'No changes made', next: 'nh3_check_alk' }
        ]
      },
      nh3_check_alk: {
        question: 'What is your effluent alkalinity?',
        answers: [
          { text: 'Alkalinity < 50 mg/L as CaCO‚ÇÉ', next: 'result_nh3_low_alk' },
          { text: 'Alkalinity 50-100 mg/L', next: 'result_nh3_comprehensive' },
          { text: 'Alkalinity > 100 mg/L', next: 'result_nh3_comprehensive' }
        ]
      }
    },
    results: {
      result_nh3_low_srt: { diagnosis: 'SRT Too Low for Nitrification', cause: 'Nitrifiers grow slowly. SRT must prevent washout, especially when cold.', actions: ['Reduce WAS rate to increase SRT', 'Target: 10 days at 20¬∞C, 20+ days at 10¬∞C', 'Monitor MLSS - allow to increase', 'May take 2-4 weeks to establish nitrifiers'], severity: 'high' },
      result_nh3_cold: { diagnosis: 'Cold Temperature Inhibition', cause: 'Nitrification rate decreases ~50% for every 10¬∞C drop.', actions: ['Increase SRT significantly (20-30 days at <15¬∞C)', 'Reduce WAS rate', 'Accept longer recovery time in spring', 'Monitor closely during temp transitions'], severity: 'high' },
      result_nh3_toxic: { diagnosis: 'Toxic Load - Nitrifier Kill', cause: 'Toxic event has killed/inhibited nitrifying bacteria.', actions: ['Stop or divert toxic source', 'Reduce WAS to preserve remaining nitrifiers', 'Expect 2-6 weeks recovery', 'Consider temporary permit variance'], severity: 'critical' },
      result_nh3_overload: { diagnosis: 'Ammonia Overload', cause: 'Influent ammonia load exceeds nitrification capacity.', actions: ['Increase SRT if possible', 'Increase aeration capacity', 'Investigate source of increased loading', 'Consider flow equalization'], severity: 'high' },
      result_nh3_low_do: { diagnosis: 'Low DO Inhibiting Nitrification', cause: 'Nitrifiers require DO > 2.0 mg/L for optimal activity.', actions: ['Increase DO to > 2.0 mg/L', 'May need 3-4 mg/L if heavily loaded', 'Check blower capacity', 'Clean or replace diffusers'], severity: 'high' },
      result_nh3_overwaste: { diagnosis: 'Excessive Wasting', cause: 'Increased WAS has reduced SRT below nitrifier needs.', actions: ['Reduce WAS rate immediately', 'Calculate new SRT', 'Target SRT > 10 days', 'Allow 2-4 weeks for recovery'], severity: 'high' },
      result_nh3_low_alk: { diagnosis: 'Alkalinity Limitation', cause: 'Nitrification consumes ~7.1 mg alk per mg NH‚ÇÉ-N oxidized.', actions: ['Add alkalinity (lime, soda ash, bicarb)', 'Target effluent alk > 50 mg/L', 'Calculate: 7.1 √ó NH‚ÇÉ removed', 'Monitor pH and alkalinity daily'], severity: 'high' },
      result_nh3_comprehensive: { diagnosis: 'Comprehensive Analysis Needed', cause: 'No single obvious cause. Multiple factors may be involved.', actions: ['Perform complete nitrification audit', 'Profile DO, pH, temp throughout system', 'Review all operational data trends', 'Consider process consultant'], severity: 'moderate' }
    }
  },
  lowdo: {
    title: 'üü¢ Low DO Troubleshooting',
    color: '#059669',
    steps: {
      start: {
        question: 'Where is the DO problem occurring?',
        answers: [
          { text: 'Entire basin uniformly low', next: 'do_all_low' },
          { text: 'Only certain zones low', next: 'do_zones_low' },
          { text: 'DO fluctuates widely', next: 'do_fluctuating' },
          { text: 'Cannot reach setpoint at max air', next: 'do_max_air' }
        ]
      },
      do_all_low: {
        question: 'Is the blower at full capacity?',
        answers: [
          { text: 'Yes - blower at 100%', next: 'do_blower_maxed' },
          { text: 'No - has more capacity', next: 'result_do_controls' }
        ]
      },
      do_zones_low: {
        question: 'Which zones have low DO?',
        answers: [
          { text: 'First zone / head of basin', next: 'result_do_high_loading' },
          { text: 'Last zone or middle zones', next: 'do_check_diffusers' },
          { text: 'Random/scattered areas', next: 'result_do_diffuser_pattern' }
        ]
      },
      do_fluctuating: {
        question: 'What pattern does the DO follow?',
        answers: [
          { text: 'Follows diurnal flow pattern', next: 'result_do_diurnal' },
          { text: 'Correlates with blower cycling', next: 'result_do_blower_cycling' },
          { text: 'Random with no pattern', next: 'result_do_calibrate' }
        ]
      },
      do_max_air: {
        question: 'What changed to increase oxygen demand?',
        answers: [
          { text: 'Higher influent BOD/loading', next: 'result_do_overloaded' },
          { text: 'Increased MLSS concentration', next: 'result_do_high_mlss' },
          { text: 'Warmer temperatures', next: 'result_do_temperature' },
          { text: 'No changes - always been this way', next: 'do_check_diffusers' }
        ]
      },
      do_blower_maxed: {
        question: 'Are all blowers online and operational?',
        answers: [
          { text: 'Yes - all blowers running', next: 'do_check_diffusers' },
          { text: 'No - one or more down', next: 'result_do_blower_down' }
        ]
      },
      do_check_diffusers: {
        question: 'When were diffusers last inspected/cleaned?',
        answers: [
          { text: 'Within last year', next: 'result_do_distribution' },
          { text: '1-3 years ago', next: 'result_do_clean_diffusers' },
          { text: 'More than 3 years / never', next: 'result_do_replace_diffusers' }
        ]
      }
    },
    results: {
      result_do_controls: { diagnosis: 'DO Control System Issue', cause: 'Controls not calling for more air despite low DO.', actions: ['Check DO sensor calibration', 'Verify controller setpoint', 'Check control valve/VFD operation', 'Switch to manual temporarily'], severity: 'moderate' },
      result_do_high_loading: { diagnosis: 'High Oxygen Demand - First Zone', cause: 'First zone receives highest loading. Normal for lower DO.', actions: ['Redistribute air to first zone', 'Consider step-feed operation', 'First zone DO > 0.5 mg/L often acceptable', 'Evaluate tapered aeration'], severity: 'moderate' },
      result_do_diffuser_pattern: { diagnosis: 'Diffuser Distribution Problem', cause: 'Random low DO areas indicate uneven air distribution.', actions: ['Walk basin looking for dead zones', 'Listen for uneven bubbling', 'Check for damaged drop pipes', 'May need drain and inspect'], severity: 'moderate' },
      result_do_diurnal: { diagnosis: 'Diurnal Load Variation', cause: 'DO drops during peak loading periods.', actions: ['Normal operation - adjust DO strategy', 'Increase blower capacity during peaks', 'Flow equalization can help', 'Consider MOV control'], severity: 'low' },
      result_do_blower_cycling: { diagnosis: 'Blower Control Issues', cause: 'DO fluctuates as blowers cycle on/off.', actions: ['Review blower staging logic', 'Adjust PID control parameters', 'Consider VFD for smoother operation', 'Check blower turndown ratio'], severity: 'moderate' },
      result_do_calibrate: { diagnosis: 'DO Sensor Calibration Needed', cause: 'Sensor may be reading incorrectly.', actions: ['Calibrate DO sensor immediately', 'Use air-saturated water', 'Check membrane condition', 'Establish regular calibration schedule'], severity: 'moderate' },
      result_do_overloaded: { diagnosis: 'Organic Overload', cause: 'BOD loading exceeds oxygen transfer capacity.', actions: ['Verify loading increase', 'Maximize aeration capacity', 'Consider reducing MLSS', 'Identify loading source'], severity: 'high' },
      result_do_high_mlss: { diagnosis: 'High MLSS Oxygen Demand', cause: 'Elevated MLSS increases endogenous respiration demand.', actions: ['Increase WAS to reduce MLSS', 'Target appropriate MLSS', 'Higher MLSS = higher O‚ÇÇ demand', 'May take several days to see effect'], severity: 'moderate' },
      result_do_temperature: { diagnosis: 'Temperature Effect on DO', cause: 'Warm temps increase demand and decrease solubility.', actions: ['Normal summer condition', 'Increase blower output', 'May need to reduce MLSS in summer', 'Monitor during transition periods'], severity: 'moderate' },
      result_do_blower_down: { diagnosis: 'Insufficient Blower Capacity', cause: 'Remaining blower capacity is insufficient.', actions: ['Prioritize blower repair', 'Consider rental blower', 'Reduce MLSS to lower demand', 'Document for compliance'], severity: 'critical' },
      result_do_distribution: { diagnosis: 'Air Distribution Problem', cause: 'Normal pressure but air not reaching where needed.', actions: ['Check air flow to zones', 'Balance distribution valves', 'Look for air piping leaks', 'Check for hydraulic short-circuiting'], severity: 'moderate' },
      result_do_clean_diffusers: { diagnosis: 'Diffuser Fouling Likely', cause: 'Diffusers foul over time, reducing efficiency.', actions: ['Plan diffuser cleaning', 'Consider in-situ acid cleaning', 'Typical interval: 1-3 years', 'Monitor pressure trend after cleaning'], severity: 'moderate' },
      result_do_replace_diffusers: { diagnosis: 'Diffuser Replacement Needed', cause: 'Diffusers beyond useful life.', actions: ['Plan replacement project', 'Consider upgrading to high-efficiency', 'Typical life: 10-15 years', 'Evaluate alternative technologies'], severity: 'high' }
    }
  },
  foam: {
    title: 'üü§ Foam/Scum Troubleshooting',
    color: '#92400e',
    steps: {
      start: {
        question: 'What type of foam are you experiencing?',
        answers: [
          { text: 'Thick brown/tan foam (greasy, doesn\'t break)', next: 'foam_nocardia' },
          { text: 'White/gray billowing foam', next: 'foam_white' },
          { text: 'Dark black foam', next: 'foam_black' },
          { text: 'Scum accumulation on clarifier', next: 'foam_scum' }
        ]
      },
      foam_nocardia: {
        question: 'What is your current SRT (Sludge Retention Time)?',
        answers: [
          { text: 'SRT > 15 days', next: 'result_foam_high_srt' },
          { text: 'SRT 10-15 days', next: 'foam_check_fog' },
          { text: 'SRT < 10 days', next: 'foam_check_fog' }
        ]
      },
      foam_check_fog: {
        question: 'Do you have significant FOG (Fats, Oil, Grease) in influent?',
        answers: [
          { text: 'Yes - grease visible, FOG program issues', next: 'result_foam_fog' },
          { text: 'No - FOG under control', next: 'result_foam_microthrix' }
        ]
      },
      foam_white: {
        question: 'When did the white foam start?',
        answers: [
          { text: 'After plant startup or upset', next: 'result_foam_young_sludge' },
          { text: 'During high loading periods', next: 'result_foam_surfactants' },
          { text: 'Gradually increased over time', next: 'result_foam_detergents' }
        ]
      },
      foam_black: {
        question: 'Is there a septic odor associated with the foam?',
        answers: [
          { text: 'Yes - strong H‚ÇÇS smell', next: 'result_foam_septic' },
          { text: 'No - just dark color', next: 'result_foam_old_sludge' }
        ]
      },
      foam_scum: {
        question: 'What does the clarifier scum look like?',
        answers: [
          { text: 'Greasy, thick, tan/brown', next: 'result_foam_nocardia_clarifier' },
          { text: 'Floating sludge clumps', next: 'result_foam_denitrification' },
          { text: 'Algae/green growth', next: 'result_foam_algae' }
        ]
      }
    },
    results: {
      result_foam_high_srt: { diagnosis: 'Nocardia/High SRT Foam', cause: 'Nocardia and similar organisms thrive at high SRTs. They produce stable foam that traps grease.', actions: ['Reduce SRT to 8-10 days', 'Increase WAS rate gradually', 'Spray foam with water jets', 'Consider chlorine spray (10-20 mg/L) on foam', 'Improve surface wasting'], severity: 'high' },
      result_foam_fog: { diagnosis: 'FOG-Related Foaming', cause: 'Excess fats, oils, and grease provide substrate for foam-forming bacteria.', actions: ['Enforce FOG program with dischargers', 'Improve grease trap inspections', 'Add DAF or FOG removal at headworks', 'Consider enzyme addition', 'Reduce SRT if also elevated'], severity: 'high' },
      result_foam_microthrix: { diagnosis: 'Microthrix parvicella Foam', cause: 'This filament causes foam at lower SRTs, especially with fats present.', actions: ['Improve primary treatment for FOG', 'Consider anoxic selector', 'Maintain DO > 2 mg/L', 'Aluminum salt addition can help', 'Target SRT 8-12 days'], severity: 'moderate' },
      result_foam_young_sludge: { diagnosis: 'Young Sludge / Startup Foam', cause: 'New or upset sludge produces light billowing foam due to surfactants and dispersed growth.', actions: ['Allow time for sludge to mature', 'Reduce WAS rate temporarily', 'Add polymer if severe', 'Foam will reduce as MLSS increases', 'Normal during startup - 2-4 weeks'], severity: 'low' },
      result_foam_surfactants: { diagnosis: 'Surfactant/Detergent Loading', cause: 'Industrial or domestic surfactants causing foam during high loading.', actions: ['Identify source of surfactants', 'Contact industrial users', 'Consider defoamers temporarily', 'Improve equalization', 'Usually self-correcting'], severity: 'moderate' },
      result_foam_detergents: { diagnosis: 'Chronic Detergent Foam', cause: 'Ongoing surfactant loading from service area.', actions: ['Survey industrial dischargers', 'Consider ordinance enforcement', 'Mechanical defoaming', 'Spray bars over aeration', 'May need pretreatment'], severity: 'moderate' },
      result_foam_septic: { diagnosis: 'Septic Foam', cause: 'Anaerobic conditions producing gases and dark foam.', actions: ['Increase aeration immediately', 'Check for dead zones', 'Verify DO throughout basin', 'May indicate serious process upset', 'Address root cause of septicity'], severity: 'critical' },
      result_foam_old_sludge: { diagnosis: 'Old Sludge Foam', cause: 'Very old, dark sludge can produce foam as cells lyse.', actions: ['Increase wasting rate', 'Reduce SRT to target range', 'Check for return sludge issues', 'Monitor MLSS trend', 'Usually clears with younger sludge'], severity: 'moderate' },
      result_foam_nocardia_clarifier: { diagnosis: 'Nocardia Scum on Clarifier', cause: 'Nocardia foam accumulates on clarifier surface.', actions: ['Improve scum removal system', 'Check scum baffles and beach', 'Increase scum pumping', 'Address Nocardia at source (reduce SRT)', 'Chlorinate scum beach area'], severity: 'high' },
      result_foam_denitrification: { diagnosis: 'Denitrification Floating Sludge', cause: 'Nitrogen gas from denitrification floating sludge.', actions: ['Increase RAS rate', 'Reduce clarifier detention time', 'Add anoxic zone before clarifier', 'Check for septicity', 'See TSS Wizard for more'], severity: 'moderate' },
      result_foam_algae: { diagnosis: 'Algae Growth on Clarifier', cause: 'Sunlight promoting algae growth on clarifier surfaces.', actions: ['Consider clarifier covers', 'Increase scum removal', 'Brush weirs regularly', 'Chlorinate if severe', 'Mostly aesthetic issue'], severity: 'low' }
    }
  },
  odor: {
    title: 'üëÉ Odor Control Troubleshooting',
    color: '#7c2d12',
    steps: {
      start: {
        question: 'Where is the odor originating?',
        answers: [
          { text: 'Headworks/influent', next: 'odor_headworks' },
          { text: 'Primary clarifiers', next: 'odor_primary' },
          { text: 'Aeration basins', next: 'odor_aeration' },
          { text: 'Secondary clarifiers', next: 'odor_secondary' },
          { text: 'Solids handling/digesters', next: 'odor_solids' },
          { text: 'Throughout plant', next: 'odor_widespread' }
        ]
      },
      odor_headworks: {
        question: 'What type of odor at headworks?',
        answers: [
          { text: 'Rotten egg (H‚ÇÇS)', next: 'result_odor_h2s_headworks' },
          { text: 'Musty/earthy', next: 'result_odor_musty' },
          { text: 'Chemical/solvent', next: 'result_odor_industrial' }
        ]
      },
      odor_primary: {
        question: 'Is primary sludge being removed regularly?',
        answers: [
          { text: 'No - sludge builds up', next: 'result_odor_primary_sludge' },
          { text: 'Yes - still have odors', next: 'result_odor_primary_septic' }
        ]
      },
      odor_aeration: {
        question: 'What is the DO level in aeration?',
        answers: [
          { text: 'DO < 0.5 mg/L (very low)', next: 'result_odor_low_do' },
          { text: 'DO 0.5-1.5 mg/L (low)', next: 'result_odor_marginal_do' },
          { text: 'DO > 2.0 mg/L (good)', next: 'result_odor_other_source' }
        ]
      },
      odor_secondary: {
        question: 'Is there rising/floating sludge in secondary?',
        answers: [
          { text: 'Yes - sludge floating', next: 'result_odor_denit' },
          { text: 'No - sludge settles normally', next: 'result_odor_scum' }
        ]
      },
      odor_solids: {
        question: 'What solids process has the odor?',
        answers: [
          { text: 'Thickener', next: 'result_odor_thickener' },
          { text: 'Digester', next: 'result_odor_digester' },
          { text: 'Dewatering', next: 'result_odor_dewatering' },
          { text: 'Sludge storage', next: 'result_odor_storage' }
        ]
      },
      odor_widespread: {
        question: 'When are odors worst?',
        answers: [
          { text: 'Early morning', next: 'result_odor_inversion' },
          { text: 'During rain events', next: 'result_odor_wet_weather' },
          { text: 'All the time', next: 'result_odor_systemic' }
        ]
      }
    },
    results: {
      result_odor_h2s_headworks: { diagnosis: 'Hydrogen Sulfide from Collection System', cause: 'Septic conditions in sewers producing H‚ÇÇS which off-gasses at headworks.', actions: ['Add ferric chloride in collection system', 'Aerate force mains at discharge', 'Add bioxide or nitrate to sewers', 'Cover headworks and scrub air', 'Investigate long detention times in collection'], severity: 'high' },
      result_odor_musty: { diagnosis: 'Musty/Earthy Odors', cause: 'Often caused by actinomycetes or algae. Less offensive than H‚ÇÇS.', actions: ['Usually biological origin', 'Check for stagnant water areas', 'Improve housekeeping', 'Generally not a health concern', 'Address any algae growth'], severity: 'low' },
      result_odor_industrial: { diagnosis: 'Industrial Chemical Odors', cause: 'Illegal or improper industrial discharge.', actions: ['Sample and analyze influent', 'Investigate industrial users', 'May need enforcement action', 'Document for pretreatment program', 'Consider activated carbon if severe'], severity: 'high' },
      result_odor_primary_sludge: { diagnosis: 'Septic Primary Sludge', cause: 'Infrequent sludge pumping allows primary sludge to go septic.', actions: ['Increase primary sludge pumping frequency', 'Target < 24 hour detention', 'Check sludge pumps operation', 'Consider continuous pumping', 'Monitor sludge blanket depth'], severity: 'high' },
      result_odor_primary_septic: { diagnosis: 'Septic Influent to Primaries', cause: 'Influent arrives septic from collection system.', actions: ['Add aeration/oxidation at headworks', 'Ferric chloride addition', 'Improve collection system', 'Cover and treat primary air', 'Reduce detention in primaries'], severity: 'high' },
      result_odor_low_do: { diagnosis: 'Septic Aeration Basin', cause: 'Severely low DO causing anaerobic conditions and H‚ÇÇS production.', actions: ['Increase aeration immediately', 'Check blowers and diffusers', 'This is emergency situation', 'Reduce loading if possible', 'Process upset likely'], severity: 'critical' },
      result_odor_marginal_do: { diagnosis: 'Marginal DO Causing Odors', cause: 'DO not quite low enough for full septicity but allowing some odor.', actions: ['Increase DO to > 2 mg/L', 'Check for dead zones', 'May have localized septicity', 'Verify DO profile throughout', 'Clean diffusers if needed'], severity: 'moderate' },
      result_odor_other_source: { diagnosis: 'Odor Source Not Aeration', cause: 'DO is adequate. Odor source is elsewhere.', actions: ['Check upwind sources', 'Investigate solids handling', 'Check for spills or illegal dumps', 'May be collection system', 'Systematic odor survey needed'], severity: 'moderate' },
      result_odor_denit: { diagnosis: 'Denitrification Odors', cause: 'Rising sludge releasing trapped gases.', actions: ['Increase RAS rate', 'Reduce clarifier detention', 'Add anoxic zone upstream', 'See TSS Wizard', 'Usually not as offensive as H‚ÇÇS'], severity: 'moderate' },
      result_odor_scum: { diagnosis: 'Scum Accumulation Odors', cause: 'Scum accumulating and going septic on clarifier.', actions: ['Improve scum removal', 'Check scum pumps and baffles', 'Manual removal if needed', 'Regular cleaning schedule', 'Address foam-forming organisms'], severity: 'moderate' },
      result_odor_thickener: { diagnosis: 'Thickener Odors', cause: 'Sludge going septic in thickener.', actions: ['Reduce thickener detention time', 'Pump more frequently', 'Consider chemical addition', 'Cover thickener', 'Dilute if needed'], severity: 'moderate' },
      result_odor_digester: { diagnosis: 'Digester Odors', cause: 'Gas leaks, upset digester, or poor mixing.', actions: ['Check gas system for leaks', 'Verify digester mixing', 'Monitor pH and alkalinity', 'Check gas flare operation', 'May need digester recovery'], severity: 'high' },
      result_odor_dewatering: { diagnosis: 'Dewatering Odors', cause: 'Sludge becoming septic during dewatering or storage.', actions: ['Process sludge more quickly', 'Add lime or polymer', 'Ventilate dewatering area', 'Cover dumpsters/bins', 'More frequent hauling'], severity: 'moderate' },
      result_odor_storage: { diagnosis: 'Sludge Storage Odors', cause: 'Stored sludge going septic.', actions: ['Reduce storage time', 'Add lime for stabilization', 'Cover storage areas', 'More frequent disposal', 'Consider additional treatment'], severity: 'moderate' },
      result_odor_inversion: { diagnosis: 'Weather Inversion Trapping Odors', cause: 'Morning temperature inversions trap odors near ground.', actions: ['Odors worse in early AM, improve by mid-day', 'Address sources but timing is weather-related', 'Focus on covered/treated sources', 'Community communication', 'Normal meteorological phenomenon'], severity: 'low' },
      result_odor_wet_weather: { diagnosis: 'Wet Weather Odors', cause: 'I&I causing septic conditions or resuspension.', actions: ['I&I brings septic water', 'Increase aeration during storms', 'May flush debris and septicity', 'Investigate I&I reduction', 'Usually temporary'], severity: 'moderate' },
      result_odor_systemic: { diagnosis: 'Systemic Plant Odors', cause: 'Multiple sources contributing to plant-wide odors.', actions: ['Comprehensive odor survey needed', 'Prioritize sources by severity', 'May need odor control study', 'Consider covered processes', 'Chemical scrubbers may help'], severity: 'high' }
    }
  },
  nutrient: {
    title: 'üü£ Nutrient Removal Troubleshooting',
    color: '#7e22ce',
    steps: {
      start: {
        question: 'Which nutrient is the problem?',
        answers: [
          { text: 'High phosphorus (TP)', next: 'nutrient_phos' },
          { text: 'High total nitrogen (TN)', next: 'nutrient_tn' },
          { text: 'Both phosphorus and nitrogen', next: 'nutrient_both' }
        ]
      },
      nutrient_phos: {
        question: 'Do you have biological phosphorus removal (Bio-P)?',
        answers: [
          { text: 'Yes - Bio-P/EBPR process', next: 'phos_biop' },
          { text: 'No - chemical removal only', next: 'phos_chem' },
          { text: 'No - no P removal process', next: 'result_phos_add_process' }
        ]
      },
      phos_biop: {
        question: 'What is happening with Bio-P?',
        answers: [
          { text: 'P release in anaerobic zone is low', next: 'result_phos_no_release' },
          { text: 'P release OK but poor uptake in aerobic', next: 'result_phos_poor_uptake' },
          { text: 'Good removal but secondary release', next: 'result_phos_secondary_release' }
        ]
      },
      phos_chem: {
        question: 'What chemical are you using?',
        answers: [
          { text: 'Ferric chloride/sulfate', next: 'phos_chem_ferric' },
          { text: 'Alum', next: 'phos_chem_alum' },
          { text: 'Not enough chemical being added', next: 'result_phos_increase_dose' }
        ]
      },
      phos_chem_ferric: {
        question: 'Where is ferric being added?',
        answers: [
          { text: 'Primary - but P still high', next: 'result_phos_move_feed' },
          { text: 'Secondary - but P still high', next: 'result_phos_check_dose' },
          { text: 'Tertiary - but P still high', next: 'result_phos_tertiary_issue' }
        ]
      },
      phos_chem_alum: {
        question: 'What is your effluent pH?',
        answers: [
          { text: 'pH < 6.0', next: 'result_phos_ph_low' },
          { text: 'pH 6.0-7.5', next: 'result_phos_check_alum_dose' },
          { text: 'pH > 7.5', next: 'result_phos_check_alum_dose' }
        ]
      },
      nutrient_tn: {
        question: 'Which nitrogen species is elevated?',
        answers: [
          { text: 'Ammonia (NH‚ÇÉ-N)', next: 'result_tn_ammonia' },
          { text: 'Nitrate (NO‚ÇÉ-N)', next: 'tn_nitrate' },
          { text: 'Both ammonia and nitrate', next: 'result_tn_both' }
        ]
      },
      tn_nitrate: {
        question: 'Do you have an anoxic zone for denitrification?',
        answers: [
          { text: 'Yes - dedicated anoxic zone', next: 'tn_anoxic' },
          { text: 'No - fully aerobic', next: 'result_tn_need_anoxic' }
        ]
      },
      tn_anoxic: {
        question: 'What is the DO in your anoxic zone?',
        answers: [
          { text: 'DO > 0.5 mg/L (too high)', next: 'result_tn_anoxic_do' },
          { text: 'DO < 0.3 mg/L (good)', next: 'tn_carbon' }
        ]
      },
      tn_carbon: {
        question: 'Is there adequate carbon source for denitrification?',
        answers: [
          { text: 'BOD/TKN ratio > 4', next: 'result_tn_imlr' },
          { text: 'BOD/TKN ratio < 4 (low carbon)', next: 'result_tn_add_carbon' }
        ]
      },
      nutrient_both: {
        question: 'What type of BNR process do you have?',
        answers: [
          { text: 'A2O or similar', next: 'result_bnr_a2o' },
          { text: 'Bardenpho (4 or 5 stage)', next: 'result_bnr_bardenpho' },
          { text: 'SBR with BNR', next: 'result_bnr_sbr' },
          { text: 'No BNR - need to add', next: 'result_bnr_needed' }
        ]
      }
    },
    results: {
      result_phos_add_process: { diagnosis: 'No P Removal Process', cause: 'Plant has no phosphorus removal capability.', actions: ['Add chemical feed system', 'Ferric chloride most common', 'Dose at 1.5-2 molar ratio to P', 'Consider Bio-P if permit tightens', 'Start with tertiary addition'], severity: 'high' },
      result_phos_no_release: { diagnosis: 'Poor P Release in Anaerobic Zone', cause: 'PAOs not releasing phosphorus due to nitrate or DO intrusion.', actions: ['Check for DO in anaerobic zone', 'Check for nitrate recycle to anaerobic', 'May need larger anaerobic zone', 'Verify VFA availability', 'Consider supplemental VFA'], severity: 'high' },
      result_phos_poor_uptake: { diagnosis: 'Poor Aerobic P Uptake', cause: 'PAOs not taking up phosphorus in aerobic zone.', actions: ['Verify DO > 2 mg/L in aerobic', 'Check for toxic conditions', 'Verify SRT adequate (>5 days)', 'May need supplemental chemical', 'Check for GAO competition'], severity: 'high' },
      result_phos_secondary_release: { diagnosis: 'Secondary P Release', cause: 'Phosphorus released in clarifier or sludge handling.', actions: ['Reduce clarifier detention time', 'Increase RAS rate', 'Minimize sludge storage', 'Add ferric to RAS line', 'Keep sludge aerobic'], severity: 'moderate' },
      result_phos_move_feed: { diagnosis: 'Optimize Chemical Feed Point', cause: 'Primary addition may not be optimal location.', actions: ['Try tertiary addition', 'Split dosing - primary and tertiary', 'Tertiary gives better control', 'Monitor effluent TSS impact', 'Jar test to optimize'], severity: 'moderate' },
      result_phos_check_dose: { diagnosis: 'Check Chemical Dose', cause: 'May not be adding enough chemical for P load.', actions: ['Calculate molar ratio Fe:P or Al:P', 'Target 1.5-2.5 molar ratio', 'Jar test to optimize', 'Verify chemical is active', 'Check feed pump calibration'], severity: 'moderate' },
      result_phos_tertiary_issue: { diagnosis: 'Tertiary Treatment Issue', cause: 'Filter or final polishing not removing precipitate.', actions: ['Check filter operation', 'May need polymer addition', 'Verify adequate mixing', 'Check floc formation', 'Consider different chemical'], severity: 'moderate' },
      result_phos_ph_low: { diagnosis: 'pH Too Low for Alum', cause: 'Low pH reduces alum effectiveness.', actions: ['Add lime or caustic with alum', 'Optimal pH 6.0-7.0 for alum', 'Consider switching to ferric', 'Monitor alkalinity consumption', 'pH adjustment critical'], severity: 'moderate' },
      result_phos_check_alum_dose: { diagnosis: 'Verify Alum Dosing', cause: 'Alum dose may need adjustment.', actions: ['Jar test to optimize dose', 'Al:P ratio typically 1.5-3', 'Check for interfering substances', 'Verify mixing and contact time', 'Consider feed point optimization'], severity: 'moderate' },
      result_tn_ammonia: { diagnosis: 'Nitrification Problem', cause: 'Ammonia not being converted to nitrate. See Ammonia Wizard.', actions: ['Run High Ammonia Wizard', 'Check SRT, DO, pH, temperature', 'Nitrifiers may be inhibited', 'Common in cold weather', 'Usually SRT or DO issue'], severity: 'high' },
      result_tn_both: { diagnosis: 'Complete Nitrogen Removal Failure', cause: 'Neither nitrification nor denitrification working properly.', actions: ['Address nitrification first', 'Run High Ammonia Wizard', 'Once ammonia controlled, address nitrate', 'May need process modifications', 'Consider BNR upgrade'], severity: 'critical' },
      result_tn_need_anoxic: { diagnosis: 'No Anoxic Zone', cause: 'Cannot denitrify without anoxic conditions.', actions: ['Create anoxic zone', 'Turn off aerators in first zone', 'Add IMLR from aerobic to anoxic', 'Need 2-4 hour HRT in anoxic', 'May need baffles or modifications'], severity: 'high' },
      result_tn_anoxic_do: { diagnosis: 'DO Too High in Anoxic Zone', cause: 'Oxygen in anoxic zone inhibits denitrification.', actions: ['Reduce IMLR rate', 'Check for mechanical aerators', 'Verify mixers not entraining air', 'Add baffle to prevent backmix', 'Target DO < 0.3 mg/L'], severity: 'high' },
      result_tn_imlr: { diagnosis: 'Check IMLR Rate', cause: 'Internal mixed liquor recycle may need adjustment.', actions: ['IMLR typically 200-400% of influent', 'Higher IMLR = more denitrification', 'But too high wastes energy', 'Balance with anoxic detention', 'Check recycle pumps'], severity: 'moderate' },
      result_tn_add_carbon: { diagnosis: 'Carbon Limited Denitrification', cause: 'Not enough BOD available for denitrification.', actions: ['Add supplemental carbon', 'Methanol, glycerol, or acetate', 'Dose based on NO3-N √ó 3-4', 'Consider primary effluent bypass', 'Fermenter for VFA production'], severity: 'high' },
      result_bnr_a2o: { diagnosis: 'A2O Process Optimization', cause: 'A2O may need tuning for both N and P removal.', actions: ['Optimize zone volumes', 'Check recycle rates (RAS and IMLR)', 'Verify anaerobic truly anaerobic', 'Balance SRT for both processes', 'May need supplemental chemical for P'], severity: 'moderate' },
      result_bnr_bardenpho: { diagnosis: 'Bardenpho Process Optimization', cause: '4 or 5 stage Bardenpho needs proper operation.', actions: ['Verify each zone conditions', 'Check recycles between zones', 'Second anoxic may need carbon', 'Final aerobic for N2 stripping', 'Complex process - review design'], severity: 'moderate' },
      result_bnr_sbr: { diagnosis: 'SBR BNR Optimization', cause: 'SBR cycle timing affects nutrient removal.', actions: ['Adjust anaerobic phase length', 'Verify anoxic phase conditions', 'Aerobic phase for nitrification', 'May need cycle modifications', 'Check decant settings'], severity: 'moderate' },
      result_bnr_needed: { diagnosis: 'BNR Process Needed', cause: 'Current process cannot achieve nutrient limits.', actions: ['Evaluate BNR options', 'A2O, Bardenpho, MLE common', 'Capital project required', 'Consider phased approach', 'Chemical may bridge gap'], severity: 'high' }
    }
  },
  blower: {
    title: '‚ö° Blower/Aeration Troubleshooting',
    color: '#0369a1',
    steps: {
      start: {
        question: 'What is the main symptom?',
        answers: [
          { text: 'Low airflow / can\'t meet DO', next: 'blower_low_air' },
          { text: 'High amp draw / overheating', next: 'blower_high_amps' },
          { text: 'Blower tripping / shutting down', next: 'blower_tripping' },
          { text: 'Unusual noise or vibration', next: 'blower_noise' },
          { text: 'Uneven air distribution in basin', next: 'blower_distribution' }
        ]
      },
      blower_low_air: {
        question: 'Is the blower running at full capacity?',
        answers: [
          { text: 'Yes - VFD at 100%', next: 'low_air_full_speed' },
          { text: 'No - VFD limited by something', next: 'low_air_limited' },
          { text: 'Not sure / no VFD', next: 'low_air_check' }
        ]
      },
      low_air_full_speed: {
        question: 'What is the discharge pressure?',
        answers: [
          { text: 'Pressure higher than normal', next: 'result_blower_high_pressure' },
          { text: 'Pressure normal or low', next: 'result_blower_capacity' }
        ]
      },
      low_air_limited: {
        question: 'What is limiting the VFD?',
        answers: [
          { text: 'High amp draw', next: 'blower_high_amps' },
          { text: 'High temperature', next: 'result_blower_cooling' },
          { text: 'Control system limiting', next: 'result_blower_controls' }
        ]
      },
      low_air_check: {
        question: 'Check the inlet filter - is it clean?',
        answers: [
          { text: 'Filter dirty/clogged', next: 'result_blower_filter' },
          { text: 'Filter clean', next: 'result_blower_mechanical' }
        ]
      },
      blower_high_amps: {
        question: 'When did high amps start?',
        answers: [
          { text: 'Gradually increased over time', next: 'result_blower_diffuser_fouling' },
          { text: 'Sudden increase', next: 'result_blower_mechanical' },
          { text: 'Always been high', next: 'result_blower_sizing' }
        ]
      },
      blower_tripping: {
        question: 'What trips the blower?',
        answers: [
          { text: 'High temperature', next: 'result_blower_cooling' },
          { text: 'High amps / overload', next: 'result_blower_overload' },
          { text: 'Surge condition', next: 'result_blower_surge' },
          { text: 'Unknown / check fault log', next: 'result_blower_check_faults' }
        ]
      },
      blower_noise: {
        question: 'What type of noise?',
        answers: [
          { text: 'Grinding or scraping', next: 'result_blower_bearing' },
          { text: 'Rattling or loose', next: 'result_blower_loose' },
          { text: 'Whistling or air leak', next: 'result_blower_leak' },
          { text: 'Surge/pulsing sound', next: 'result_blower_surge' }
        ]
      },
      blower_distribution: {
        question: 'Where is air distribution uneven?',
        answers: [
          { text: 'One zone consistently low', next: 'result_blower_zone_valve' },
          { text: 'Random areas low', next: 'result_blower_diffusers' },
          { text: 'Pattern changes over time', next: 'result_blower_fouling_pattern' }
        ]
      }
    },
    results: {
      result_blower_high_pressure: { diagnosis: 'High System Pressure', cause: 'Diffusers or piping restricting airflow, causing high pressure.', actions: ['Check for closed valves', 'Inspect diffusers for fouling', 'Calculate headloss through system', 'Consider diffuser cleaning/replacement', 'May need larger piping'], severity: 'high' },
      result_blower_capacity: { diagnosis: 'Insufficient Blower Capacity', cause: 'Blower cannot deliver required airflow at current conditions.', actions: ['Verify design vs. actual capacity', 'Check inlet air temperature', 'May need additional blower', 'Evaluate turbo vs. PD options', 'Consider load reduction'], severity: 'high' },
      result_blower_cooling: { diagnosis: 'Blower Overheating', cause: 'Inadequate cooling causing temperature trips.', actions: ['Check cooling fan operation', 'Clean cooling fins/radiator', 'Verify ambient temperature OK', 'Check for blocked vents', 'May need additional cooling'], severity: 'high' },
      result_blower_controls: { diagnosis: 'Control System Limiting Blower', cause: 'Controls preventing full blower operation.', actions: ['Check DO setpoint and control', 'Verify valve positions', 'Check for alarm conditions', 'Review control logic', 'May need tuning'], severity: 'moderate' },
      result_blower_filter: { diagnosis: 'Clogged Inlet Filter', cause: 'Dirty filter restricting inlet airflow.', actions: ['Replace or clean filter', 'Establish filter change schedule', 'Check differential pressure', 'Consider better filtration', 'Usually monthly changes'], severity: 'moderate' },
      result_blower_mechanical: { diagnosis: 'Mechanical Problem', cause: 'Internal blower issue affecting performance.', actions: ['Check bearings and oil', 'Listen for unusual sounds', 'Check shaft alignment', 'May need manufacturer service', 'Vibration analysis recommended'], severity: 'high' },
      result_blower_diffuser_fouling: { diagnosis: 'Diffuser Fouling', cause: 'Gradual diffuser fouling increasing back pressure.', actions: ['Measure pressure trend over time', 'Plan diffuser cleaning', 'Consider acid gas cleaning', 'Evaluate diffuser age', 'Budget for replacement if old'], severity: 'moderate' },
      result_blower_sizing: { diagnosis: 'Blower Undersized', cause: 'Blower was not properly sized for actual conditions.', actions: ['Compare nameplate to actual duty', 'May need larger motor', 'Consider adding blower', 'Evaluate process changes', 'Reduce loading if possible'], severity: 'high' },
      result_blower_overload: { diagnosis: 'Motor Overload', cause: 'Blower motor drawing excessive current.', actions: ['Check for mechanical binding', 'Verify voltage supply', 'Check for diffuser fouling', 'May need motor service', 'Consider power quality'], severity: 'high' },
      result_blower_surge: { diagnosis: 'Blower Surge Condition', cause: 'Turbo blower operating in surge zone.', actions: ['Open blowoff valve', 'Increase system demand', 'Check surge control system', 'May need to reduce speed', 'Turbo blowers have minimum flow'], severity: 'critical' },
      result_blower_check_faults: { diagnosis: 'Review Fault History', cause: 'Need to identify specific trip cause.', actions: ['Check blower fault log', 'Review SCADA alarms', 'Note time and conditions', 'Contact manufacturer if needed', 'Systematic troubleshooting'], severity: 'moderate' },
      result_blower_bearing: { diagnosis: 'Bearing Failure', cause: 'Bearings failing causing grinding noise.', actions: ['Stop blower if severe', 'Check oil level and condition', 'Plan bearing replacement', 'Catastrophic failure if ignored', 'May need rebuild'], severity: 'critical' },
      result_blower_loose: { diagnosis: 'Loose Components', cause: 'Loose bolts, guards, or fittings.', actions: ['Check all fasteners', 'Tighten loose components', 'Check coupling alignment', 'Verify guards secure', 'Usually easy fix'], severity: 'moderate' },
      result_blower_leak: { diagnosis: 'Air Leak', cause: 'Leak in piping or connections losing air.', actions: ['Listen for leaks', 'Check pipe joints', 'Inspect flexible connectors', 'Use soapy water to find leaks', 'Repair as found'], severity: 'moderate' },
      result_blower_zone_valve: { diagnosis: 'Zone Valve Problem', cause: 'One zone not receiving proper airflow.', actions: ['Check zone valve position', 'Verify valve actuator', 'Check for obstruction', 'May need valve service', 'Check controls to valve'], severity: 'moderate' },
      result_blower_diffusers: { diagnosis: 'Diffuser Problems', cause: 'Some diffusers clogged or damaged.', actions: ['Inspect basin visually', 'Look for uneven bubbling', 'May need to drain and inspect', 'Clean or replace diffusers', 'Check header piping'], severity: 'moderate' },
      result_blower_fouling_pattern: { diagnosis: 'Progressive Diffuser Fouling', cause: 'Diffusers fouling unevenly over time.', actions: ['Plan systematic inspection', 'Track air distribution changes', 'Schedule cleaning', 'Consider air bump cleaning', 'Evaluate diffuser type'], severity: 'moderate' }
    }
  },
  clarifier: {
    title: 'üîß Clarifier Mechanical Troubleshooting',
    color: '#475569',
    steps: {
      start: {
        question: 'What clarifier issue are you experiencing?',
        answers: [
          { text: 'High torque / overload alarm', next: 'clar_torque' },
          { text: 'Mechanism not rotating', next: 'clar_stopped' },
          { text: 'Scum/foam accumulation', next: 'clar_scum' },
          { text: 'Effluent weir problems', next: 'clar_weir' },
          { text: 'Sludge collection issues', next: 'clar_sludge' }
        ]
      },
      clar_torque: {
        question: 'Is the high torque constant or intermittent?',
        answers: [
          { text: 'Constant high torque', next: 'clar_torque_constant' },
          { text: 'Spikes/intermittent', next: 'clar_torque_spikes' }
        ]
      },
      clar_torque_constant: {
        question: 'What is the sludge blanket depth?',
        answers: [
          { text: 'Very deep (> 4 ft)', next: 'result_clar_deep_blanket' },
          { text: 'Normal (< 3 ft)', next: 'result_clar_mechanical_drag' }
        ]
      },
      clar_torque_spikes: {
        question: 'When do spikes occur?',
        answers: [
          { text: 'Random times', next: 'result_clar_debris' },
          { text: 'Same location each rotation', next: 'result_clar_obstruction' }
        ]
      },
      clar_stopped: {
        question: 'Is power getting to the drive?',
        answers: [
          { text: 'No power / electrical issue', next: 'result_clar_electrical' },
          { text: 'Power OK but not moving', next: 'clar_mechanical_stop' }
        ]
      },
      clar_mechanical_stop: {
        question: 'Is the drive motor running?',
        answers: [
          { text: 'Motor runs but mechanism doesn\'t move', next: 'result_clar_drive_failure' },
          { text: 'Motor won\'t start', next: 'result_clar_motor' }
        ]
      },
      clar_scum: {
        question: 'Is the scum removal system working?',
        answers: [
          { text: 'Scum skimmer not operating', next: 'result_clar_skimmer' },
          { text: 'Skimmer works but scum still accumulates', next: 'result_clar_scum_excessive' },
          { text: 'Scum box/trough full', next: 'result_clar_scum_box' }
        ]
      },
      clar_weir: {
        question: 'What is the weir problem?',
        answers: [
          { text: 'Uneven flow over weirs', next: 'result_clar_weir_level' },
          { text: 'Algae/debris on weirs', next: 'result_clar_weir_dirty' },
          { text: 'Weirs damaged', next: 'result_clar_weir_damage' }
        ]
      },
      clar_sludge: {
        question: 'What sludge collection problem?',
        answers: [
          { text: 'Sludge not reaching hopper', next: 'result_clar_scraper' },
          { text: 'Sludge buildup in corners', next: 'result_clar_corners' },
          { text: 'RAS pump suction issues', next: 'result_clar_ras_pump' }
        ]
      }
    },
    results: {
      result_clar_deep_blanket: { diagnosis: 'Deep Sludge Blanket', cause: 'Excessive sludge causing high drag on mechanism.', actions: ['Increase RAS pumping immediately', 'Increase WAS rate', 'Monitor blanket until < 3 ft', 'Check for pump issues', 'Process may be overloaded'], severity: 'high' },
      result_clar_mechanical_drag: { diagnosis: 'Mechanical Drag', cause: 'Friction in mechanism components.', actions: ['Check bearings and bushings', 'Inspect squeegees/scrapers', 'Lubricate as needed', 'Check for corrosion', 'May need rebuilding'], severity: 'moderate' },
      result_clar_debris: { diagnosis: 'Debris in Clarifier', cause: 'Rags or debris causing intermittent drag.', actions: ['Plan cleanout', 'Improve screening at headworks', 'Check for rag buildup on mechanism', 'May need diver inspection', 'Install rag catchers'], severity: 'moderate' },
      result_clar_obstruction: { diagnosis: 'Fixed Obstruction', cause: 'Something on floor at specific location.', actions: ['Drain and inspect', 'Remove obstruction', 'Check for damaged components', 'Debris or broken equipment', 'Document location'], severity: 'high' },
      result_clar_electrical: { diagnosis: 'Electrical Problem', cause: 'Power supply issue to clarifier drive.', actions: ['Check breaker/fuses', 'Verify power at drive', 'Check control circuit', 'Inspect wiring', 'May need electrician'], severity: 'moderate' },
      result_clar_drive_failure: { diagnosis: 'Drive Mechanism Failure', cause: 'Gearbox, shear pin, or drive failure.', actions: ['Check shear pins first', 'Inspect gearbox', 'Check drive coupling', 'Listen for grinding', 'May need major repair'], severity: 'critical' },
      result_clar_motor: { diagnosis: 'Motor Problem', cause: 'Drive motor issue.', actions: ['Check motor starter', 'Test motor windings', 'Check for overload trip', 'Verify motor connections', 'May need motor repair/replacement'], severity: 'high' },
      result_clar_skimmer: { diagnosis: 'Scum Skimmer Problem', cause: 'Skimmer mechanism not functioning.', actions: ['Check skimmer blade', 'Verify arm rotation', 'Check pivot and supports', 'Adjust beach slope', 'May need repair'], severity: 'moderate' },
      result_clar_scum_excessive: { diagnosis: 'Excessive Scum Production', cause: 'Process producing more scum than can be removed.', actions: ['Address foam-forming organisms', 'Reduce SRT if Nocardia', 'Increase removal frequency', 'Check FOG in influent', 'See Foam Wizard'], severity: 'moderate' },
      result_clar_scum_box: { diagnosis: 'Scum Removal System Backup', cause: 'Scum not being removed from box/trough.', actions: ['Check scum pump', 'Clear any blockages', 'Increase pump run time', 'Clean scum trough', 'Check discharge line'], severity: 'moderate' },
      result_clar_weir_level: { diagnosis: 'Weirs Out of Level', cause: 'Uneven weirs causing unequal flow distribution.', actions: ['Survey weir elevations', 'Adjust to within 1/8 inch', 'May need weir replacement', 'Check for settlement', 'Critical for performance'], severity: 'high' },
      result_clar_weir_dirty: { diagnosis: 'Dirty Weirs', cause: 'Algae and debris affecting weir performance.', actions: ['Clean weirs regularly', 'Brush or pressure wash', 'Weekly cleaning recommended', 'Consider weir covers', 'Install spray bars'], severity: 'low' },
      result_clar_weir_damage: { diagnosis: 'Damaged Weirs', cause: 'Weirs bent, broken, or deteriorated.', actions: ['Inspect all weirs', 'Replace damaged sections', 'Consider V-notch weirs', 'FRP or aluminum options', 'Plan for rehabilitation'], severity: 'moderate' },
      result_clar_scraper: { diagnosis: 'Scraper/Squeegee Problem', cause: 'Sludge not being conveyed to hopper.', actions: ['Inspect scraper blades', 'Check blade contact with floor', 'Replace worn squeegees', 'Verify proper blade angle', 'Check for damage'], severity: 'moderate' },
      result_clar_corners: { diagnosis: 'Corner Sludge Buildup', cause: 'Rectangular clarifier corners accumulating sludge.', actions: ['Install corner sweeps', 'Add corner fillets', 'Increase corner attention', 'Common in rectangular tanks', 'May need manual cleaning'], severity: 'moderate' },
      result_clar_ras_pump: { diagnosis: 'RAS Pump Suction Problem', cause: 'Pump not drawing sludge properly.', actions: ['Check for air in suction', 'Verify pump operation', 'Inspect suction piping', 'Check for sludge ratholing', 'Verify hopper design'], severity: 'high' }
    }
  },
  raswas: {
    title: 'üíß RAS/WAS Optimization',
    color: '#0891b2',
    steps: {
      start: {
        question: 'What RAS/WAS issue are you troubleshooting?',
        answers: [
          { text: 'High sludge blanket despite pumping', next: 'ras_blanket' },
          { text: 'RAS concentration too low/high', next: 'ras_concentration' },
          { text: 'Can\'t maintain target MLSS', next: 'ras_mlss' },
          { text: 'WAS rate calculation', next: 'ras_was_calc' },
          { text: 'RAS pump problems', next: 'ras_pump' }
        ]
      },
      ras_blanket: {
        question: 'What is the current RAS rate as % of influent flow?',
        answers: [
          { text: 'RAS < 25%', next: 'result_ras_increase' },
          { text: 'RAS 25-50%', next: 'ras_blanket_mid' },
          { text: 'RAS 50-100%', next: 'ras_blanket_high' },
          { text: 'RAS > 100%', next: 'result_ras_too_high' }
        ]
      },
      ras_blanket_mid: {
        question: 'Is the sludge settling normally (SVI < 150)?',
        answers: [
          { text: 'Yes - SVI is normal', next: 'result_ras_increase_more' },
          { text: 'No - poor settling (SVI > 150)', next: 'result_ras_bulking' }
        ]
      },
      ras_blanket_high: {
        question: 'Is the RAS pump able to deliver more?',
        answers: [
          { text: 'Yes - can increase pump speed', next: 'result_ras_pump_up' },
          { text: 'No - pump at max capacity', next: 'result_ras_pump_limit' }
        ]
      },
      ras_concentration: {
        question: 'What is the RAS concentration vs MLSS?',
        answers: [
          { text: 'RAS < MLSS (too dilute)', next: 'result_ras_dilute' },
          { text: 'RAS = 2-3√ó MLSS (normal)', next: 'result_ras_normal' },
          { text: 'RAS > 4√ó MLSS (very thick)', next: 'result_ras_thick' }
        ]
      },
      ras_mlss: {
        question: 'Is MLSS too high or too low?',
        answers: [
          { text: 'MLSS too high', next: 'result_was_increase' },
          { text: 'MLSS too low', next: 'result_was_decrease' },
          { text: 'MLSS fluctuating', next: 'result_was_consistency' }
        ]
      },
      ras_was_calc: {
        question: 'What are you trying to control?',
        answers: [
          { text: 'Target a specific SRT', next: 'result_was_srt' },
          { text: 'Target a specific MLSS', next: 'result_was_mlss_target' },
          { text: 'Maximize solids removal', next: 'result_was_maximize' }
        ]
      },
      ras_pump: {
        question: 'What pump problem?',
        answers: [
          { text: 'Pump won\'t prime / losing suction', next: 'result_ras_prime' },
          { text: 'Low flow despite running', next: 'result_ras_low_flow' },
          { text: 'Variable flow / surging', next: 'result_ras_surging' }
        ]
      }
    },
    results: {
      result_ras_increase: { diagnosis: 'RAS Rate Too Low', cause: 'RAS rate insufficient to return solids to aeration basin.', actions: ['Increase RAS to 50-75% of influent', 'Monitor blanket response', 'Typical RAS range 25-100%', 'Higher for poor settling sludge', 'Check pump capacity'], severity: 'moderate' },
      result_ras_increase_more: { diagnosis: 'Increase RAS Rate', cause: 'Good settling sludge but not returning fast enough.', actions: ['Increase RAS rate 10-20%', 'Can go higher with good SVI', 'Monitor clarifier performance', 'Target blanket < 2 ft', 'Adjust incrementally'], severity: 'moderate' },
      result_ras_bulking: { diagnosis: 'Filamentous Bulking Affecting RAS', cause: 'Poor settling causing blanket despite RAS pumping.', actions: ['Run Bulking Wizard', 'Address root cause of bulking', 'May need polymer addition', 'Can\'t pump way out of bulking', 'RAS will be dilute'], severity: 'high' },
      result_ras_too_high: { diagnosis: 'Excessive RAS Rate', cause: 'RAS > 100% wastes energy and disrupts settling.', actions: ['Reduce RAS rate', 'Very high RAS is counterproductive', 'Reduces clarifier detention', 'May actually hurt settling', 'Address root cause'], severity: 'moderate' },
      result_ras_pump_up: { diagnosis: 'Increase Pump Speed', cause: 'Pump has additional capacity available.', actions: ['Increase VFD speed or pump runtime', 'Monitor discharge pressure', 'Check motor amps', 'Gradual increases', 'Verify blanket responds'], severity: 'moderate' },
      result_ras_pump_limit: { diagnosis: 'RAS Pump Capacity Limit', cause: 'Pumps cannot deliver more flow.', actions: ['May need larger pumps', 'Bring additional pump online', 'Check for piping restrictions', 'Verify impeller condition', 'Consider parallel operation'], severity: 'high' },
      result_ras_dilute: { diagnosis: 'Dilute RAS', cause: 'Clarifier not thickening sludge adequately.', actions: ['Check for hydraulic short-circuiting', 'Verify blanket depth', 'May indicate clarifier problems', 'Check density current', 'Poor flocculation possible'], severity: 'moderate' },
      result_ras_normal: { diagnosis: 'Normal RAS Concentration', cause: 'RAS concentration is in expected range.', actions: ['No action needed', 'RAS 2-3√ó MLSS is typical', 'Monitor for changes', 'Document as baseline', 'Good clarifier performance'], severity: 'low' },
      result_ras_thick: { diagnosis: 'Very Thick RAS', cause: 'Sludge thickening excessively in clarifier.', actions: ['May indicate too low RAS rate', 'Or excellent settling', 'Check for denitrification', 'Could be pre-rising sludge', 'Monitor closely'], severity: 'moderate' },
      result_was_increase: { diagnosis: 'Increase WAS Rate', cause: 'MLSS higher than target, need to waste more.', actions: ['Calculate current SRT', 'Increase WAS 10-20%', 'Changes take 1-3 SRTs to stabilize', 'Monitor daily', 'Adjust incrementally'], severity: 'moderate' },
      result_was_decrease: { diagnosis: 'Decrease WAS Rate', cause: 'MLSS lower than target, wasting too much.', actions: ['Reduce WAS rate', 'Allow MLSS to build', 'May take several days', 'Check for other solids loss', 'TSS in effluent?'], severity: 'moderate' },
      result_was_consistency: { diagnosis: 'Inconsistent WAS Operation', cause: 'Variable wasting causing MLSS swings.', actions: ['Establish consistent WAS schedule', 'Daily wasting better than intermittent', 'Same time each day', 'Automatic pacing helpful', 'Record all wasting'], severity: 'moderate' },
      result_was_srt: { diagnosis: 'SRT-Based WAS Control', cause: 'Setting WAS to achieve target SRT.', actions: ['WAS (gpd) = Aer Vol √ó MLSS √ó 8.34 / (SRT √ó WAS TSS √ó 8.34)', 'Plus effluent solids loss', 'Typical SRT: 5-15 days', 'Adjust based on process needs', 'Monitor SRT weekly'], severity: 'low' },
      result_was_mlss_target: { diagnosis: 'MLSS-Based WAS Control', cause: 'Adjusting WAS to maintain MLSS.', actions: ['Increase WAS if MLSS rising', 'Decrease WAS if MLSS falling', 'Small adjustments daily', 'Seasonal adjustments needed', 'Document target and actual'], severity: 'low' },
      result_was_maximize: { diagnosis: 'Maximize Solids Wasting', cause: 'Need to remove solids as fast as possible.', actions: ['Waste thickest concentration', 'Waste from RAS line if possible', 'Continuous wasting most efficient', 'Monitor clarifier blanket', 'May need temporary increase'], severity: 'moderate' },
      result_ras_prime: { diagnosis: 'RAS Pump Losing Prime', cause: 'Air getting into pump suction.', actions: ['Check suction piping for leaks', 'Verify submergence in hopper', 'Check for vortexing', 'Inspect foot valve if present', 'May need to reprime'], severity: 'high' },
      result_ras_low_flow: { diagnosis: 'Low RAS Flow', cause: 'Pump running but not delivering expected flow.', actions: ['Check for plugged suction', 'Inspect impeller wear', 'Verify valve positions', 'Check for air binding', 'May need pump service'], severity: 'high' },
      result_ras_surging: { diagnosis: 'RAS Flow Surging', cause: 'Inconsistent flow indicating pump or system issue.', actions: ['Check for suction problems', 'Verify NPSH adequate', 'Look for air entrainment', 'Check VFD operation', 'May be sludge ratholing'], severity: 'moderate' }
    }
  }
};

var wizardState = { active: false, type: null, currentStep: 'start', path: [], answers: [] };
var wizardHistory = [];

function startWizard(type) {
  if (!wizardData[type]) { showToast('Wizard not found', 'error'); return; }
  var wizard = wizardData[type];
  wizardState = { active: true, type: type, currentStep: 'start', path: ['Start'], answers: [] };
  document.getElementById('wizardActiveArea').style.display = 'block';
  document.getElementById('wizardResults').style.display = 'none';
  document.getElementById('wizardTitle').innerHTML = wizard.title;
  document.getElementById('wizardTitle').style.background = 'linear-gradient(135deg,' + wizard.color + ',' + wizard.color + 'aa)';
  loadWizardStep('start');
  document.getElementById('wizardActiveArea').scrollIntoView({ behavior: 'smooth' });
}

function loadWizardStep(stepId) {
  var wizard = wizardData[wizardState.type];
  if (stepId.startsWith('result_')) { showWizardResult(stepId); return; }
  var step = wizard.steps[stepId];
  if (!step) { showToast('Step not found', 'error'); return; }
  wizardState.currentStep = stepId;
  var totalSteps = Object.keys(wizard.steps).length;
  var currentIndex = Object.keys(wizard.steps).indexOf(stepId) + 1;
  var percent = Math.round((currentIndex / totalSteps) * 100);
  document.getElementById('wizardProgress').textContent = 'Step ' + currentIndex + ' of ' + totalSteps;
  document.getElementById('wizardPercent').textContent = percent + '%';
  document.getElementById('wizardProgressBar').style.width = percent + '%';
  document.getElementById('wizardQuestionText').textContent = step.question;
  var answersHtml = '';
  step.answers.forEach(function(answer, index) {
    answersHtml += '<button onclick="selectWizardAnswer(' + index + ',\'' + answer.next + '\')" style="background:rgba(124,58,237,0.3);border:2px solid #7c3aed;color:white;padding:16px 20px;border-radius:12px;font-size:16px;text-align:left;cursor:pointer;transition:all 0.2s;width:100%" onmouseover="this.style.background=\'rgba(124,58,237,0.5)\'" onmouseout="this.style.background=\'rgba(124,58,237,0.3)\'">' + answer.text + '</button>';
  });
  document.getElementById('wizardAnswers').innerHTML = answersHtml;
  document.getElementById('wizardBreadcrumb').textContent = wizardState.path.join(' ‚Üí ');
  document.getElementById('wizardBackBtn').disabled = wizardState.path.length <= 1;
}

function selectWizardAnswer(index, next) {
  var wizard = wizardData[wizardState.type];
  var step = wizard.steps[wizardState.currentStep];
  var answer = step.answers[index];
  wizardState.answers.push({ question: step.question, answer: answer.text });
  var shortAnswer = answer.text.length > 25 ? answer.text.substring(0, 25) + '...' : answer.text;
  wizardState.path.push(shortAnswer);
  loadWizardStep(next);
}

function showWizardResult(resultId) {
  var wizard = wizardData[wizardState.type];
  var result = wizard.results[resultId];
  if (!result) { showToast('Result not found', 'error'); return; }
  document.getElementById('wizardActiveArea').style.display = 'none';
  document.getElementById('wizardResults').style.display = 'block';
  var severityColors = { low: '#10b981', moderate: '#f59e0b', high: '#ef4444', critical: '#dc2626' };
  var severityLabels = { low: 'üü¢ LOW', moderate: 'üü° MODERATE', high: 'üü† HIGH', critical: 'üî¥ CRITICAL' };
  var actionsHtml = result.actions.map(function(a) { return '<li style="margin-bottom:8px">' + a + '</li>'; }).join('');
  document.getElementById('wizardResultContent').innerHTML =
    '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">' +
    '<h2 style="margin:0;font-size:18px">‚úÖ ' + result.diagnosis + '</h2>' +
    '<span style="background:' + severityColors[result.severity] + ';padding:8px 16px;border-radius:20px;font-weight:bold">' + severityLabels[result.severity] + '</span></div>' +
    '<div style="background:rgba(0,0,0,0.2);padding:20px;border-radius:12px;margin-bottom:20px">' +
    '<h4 style="margin:0 0 10px 0;opacity:0.9">üîç Root Cause:</h4>' +
    '<p style="margin:0;font-size:16px;line-height:1.6">' + result.cause + '</p></div>' +
    '<div style="background:rgba(0,0,0,0.2);padding:20px;border-radius:12px">' +
    '<h4 style="margin:0 0 10px 0;opacity:0.9">üõ†Ô∏è Recommended Actions:</h4>' +
    '<ol style="margin:0;padding-left:20px;font-size:15px;line-height:1.8">' + actionsHtml + '</ol></div>';
  var historyEntry = { date: new Date().toLocaleString(), wizard: wizard.title, diagnosis: result.diagnosis, severity: result.severity };
  wizardHistory.unshift(historyEntry);
  if (wizardHistory.length > 10) wizardHistory.pop();
  localStorage.setItem('wwtp_wizard_history', JSON.stringify(wizardHistory));
  updateWizardHistoryDisplay();
  document.getElementById('wizardResults').scrollIntoView({ behavior: 'smooth' });
}

function wizardBack() {
  if (wizardState.path.length <= 1) return;
  wizardState.path.pop();
  wizardState.answers.pop();
  var steps = Object.keys(wizardData[wizardState.type].steps);
  var prevStep = wizardState.path.length === 1 ? 'start' : steps[Math.max(0, wizardState.path.length - 1)];
  loadWizardStep(prevStep);
}

function wizardRestart() {
  startWizard(wizardState.type);
}

function exitWizard() {
  wizardState = { active: false, type: null, currentStep: 'start', path: [], answers: [] };
  document.getElementById('wizardActiveArea').style.display = 'none';
  document.getElementById('wizardResults').style.display = 'none';
  document.querySelector('#wizards .section').scrollIntoView({ behavior: 'smooth' });
}

function generateWizardReport() {
  var wizard = wizardData[wizardState.type];
  var resultId = Object.keys(wizard.results).find(function(key) {
    return wizard.results[key].diagnosis === document.querySelector('#wizardResultContent h2').textContent.replace('‚úÖ ', '');
  });
  var result = wizard.results[resultId];
  var report = 'WWTP TROUBLESHOOTING REPORT\n' + '='.repeat(50) + '\n\n';
  report += 'Date: ' + new Date().toLocaleString() + '\n';
  report += 'Wizard: ' + wizard.title + '\n\n';
  report += 'DIAGNOSIS: ' + result.diagnosis + '\n';
  report += 'Severity: ' + result.severity.toUpperCase() + '\n\n';
  report += 'ROOT CAUSE:\n' + result.cause + '\n\n';
  report += 'DIAGNOSTIC PATH:\n' + wizardState.path.join(' ‚Üí ') + '\n\n';
  report += 'RECOMMENDED ACTIONS:\n';
  result.actions.forEach(function(a, i) { report += (i + 1) + '. ' + a + '\n'; });
  report += '\n' + '='.repeat(50) + '\n';
  report += 'Generated by WWTP Command Center v9.6.0\n';
  var blob = new Blob([report], { type: 'text/plain' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'WWTP_Diagnosis_' + new Date().toISOString().slice(0, 10) + '.txt';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Report downloaded!', 'success');
}

function updateWizardHistoryDisplay() {
  var container = document.getElementById('wizardHistory');
  if (!wizardHistory || wizardHistory.length === 0) {
    container.innerHTML = '<p>No diagnoses completed yet. Run a wizard to see history here.</p>';
    return;
  }
  var html = '<div style="display:flex;flex-direction:column;gap:10px">';
  wizardHistory.forEach(function(entry) {
    var severityColors = { low: '#10b981', moderate: '#f59e0b', high: '#ef4444', critical: '#dc2626' };
    html += '<div style="background:var(--bg-section);padding:12px;border-radius:8px;border-left:4px solid ' + severityColors[entry.severity] + '">' +
      '<div style="font-weight:bold">' + entry.diagnosis + '</div>' +
      '<div style="font-size:12px;opacity:0.7;margin-top:4px">' + entry.date + '</div></div>';
  });
  html += '</div>';
  container.innerHTML = html;
}

// Load history on init
try { wizardHistory = JSON.parse(localStorage.getItem('wwtp_wizard_history')) || []; updateWizardHistoryDisplay(); } catch(e) { wizardHistory = []; }

// ========== END GUIDED WIZARDS SYSTEM ==========
// ========== PLANT PROFILES SYSTEM v9.5.0 ==========

var plantProfiles = [];

// Initialize profiles on load
function initPlantProfiles() {
  try {
    var saved = localStorage.getItem('wwtp_plant_profiles');
    if (saved) {
      plantProfiles = JSON.parse(saved);
    }
    updateProfileDropdown();
  } catch(e) {
    console.error('Error loading profiles:', e);
    plantProfiles = [];
  }
}

// Update dropdown with saved profiles
function updateProfileDropdown() {
  var select = document.getElementById('profileSelect');
  if (!select) return;

  select.innerHTML = '<option value="">-- Select a Plant Profile (' + plantProfiles.length + ' saved) --</option>';

  plantProfiles.forEach(function(profile, index) {
    var option = document.createElement('option');
    option.value = index;
    option.textContent = profile.name + (profile.client ? ' (' + profile.client + ')' : '');
    select.appendChild(option);
  });
}

// Save new profile from current values
function saveNewProfile() {
  var nameInput = document.getElementById('newProfileName');
  var name = nameInput ? nameInput.value.trim() : '';

  if (!name) {
    showToast('Please enter a profile name', 'error');
    return;
  }

  // Check for duplicate names
  var exists = plantProfiles.some(function(p) { return p.name.toLowerCase() === name.toLowerCase(); });
  if (exists) {
    if (!confirm('A profile named "' + name + '" already exists. Overwrite it?')) {
      return;
    }
    // Remove existing
    plantProfiles = plantProfiles.filter(function(p) { return p.name.toLowerCase() !== name.toLowerCase(); });
  }

  // Gather all values
  var profile = {
    name: name,
    created: new Date().toISOString(),
    updated: new Date().toISOString(),
    // Master settings
    flow: getInputValue('masterFlow'),
    aerationVolume: getInputValue('masterAerVol'),
    bod: getInputValue('masterBOD'),
    mlss: getInputValue('masterMLSS'),
    // Extended parameters
    plantName: getInputValue('profilePlantName'),
    client: getInputValue('profileClient'),
    permit: getInputValue('profilePermit'),
    designFlow: getInputValue('profileDesignFlow'),
    processType: getInputValue('profileProcessType'),
    clarifiers: getInputValue('profileClarifiers'),
    clarifierDia: getInputValue('profileClarifierDia'),
    swd: getInputValue('profileSWD'),
    targetSRT: getInputValue('profileTargetSRT'),
    notes: getInputValue('profileNotes')
  };

  plantProfiles.push(profile);
  savePlantProfiles();
  updateProfileDropdown();

  // Clear input
  if (nameInput) nameInput.value = '';

  showToast('‚úÖ Profile "' + name + '" saved!', 'success');
}

// Helper to get input value
function getInputValue(id) {
  var el = document.getElementById(id);
  if (!el) return '';
  return el.value;
}

// Helper to set input value
function setInputValue(id, value) {
  var el = document.getElementById(id);
  if (el && value !== undefined && value !== null && value !== '') {
    el.value = value;
  }
}

// Save profiles to localStorage
function savePlantProfiles() {
  try {
    localStorage.setItem('wwtp_plant_profiles', JSON.stringify(plantProfiles));
  } catch(e) {
    showToast('Error saving profiles: ' + e.message, 'error');
  }
}

// Preview selected profile
function previewProfile() {
  var select = document.getElementById('profileSelect');
  var previewDiv = document.getElementById('profilePreview');
  var contentDiv = document.getElementById('profilePreviewContent');

  if (!select || !previewDiv || !contentDiv) return;

  var index = select.value;
  if (index === '' || !plantProfiles[index]) {
    previewDiv.style.display = 'none';
    return;
  }

  var p = plantProfiles[index];
  var html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px">';
  html += '<div><strong>Flow:</strong> ' + (p.flow || '-') + ' MGD</div>';
  html += '<div><strong>Aeration Vol:</strong> ' + (p.aerationVolume || '-') + ' MG</div>';
  html += '<div><strong>BOD:</strong> ' + (p.bod || '-') + ' mg/L</div>';
  html += '<div><strong>MLSS:</strong> ' + (p.mlss || '-') + ' mg/L</div>';
  if (p.processType) html += '<div><strong>Process:</strong> ' + p.processType.toUpperCase() + '</div>';
  if (p.designFlow) html += '<div><strong>Design Flow:</strong> ' + p.designFlow + ' MGD</div>';
  if (p.client) html += '<div><strong>Client:</strong> ' + p.client + '</div>';
  if (p.permit) html += '<div><strong>Permit:</strong> ' + p.permit + '</div>';
  html += '</div>';
  if (p.notes) html += '<div style="margin-top:10px;font-style:italic;opacity:0.8">üìù ' + p.notes + '</div>';
  html += '<div style="margin-top:10px;font-size:12px;opacity:0.6">Last updated: ' + new Date(p.updated).toLocaleDateString() + '</div>';

  contentDiv.innerHTML = html;
  previewDiv.style.display = 'block';
}

// Load selected profile
function loadSelectedProfile() {
  var select = document.getElementById('profileSelect');
  if (!select) return;

  var index = select.value;
  if (index === '' || !plantProfiles[index]) {
    showToast('Please select a profile first', 'error');
    return;
  }

  var p = plantProfiles[index];

  // Load master settings in Profiles panel
  setInputValue('masterFlow', p.flow);
  setInputValue('masterAerVol', p.aerationVolume);
  setInputValue('masterBOD', p.bod);
  setInputValue('masterMLSS', p.mlss);

  // Also load to Daily Ops master settings
  setInputValue('masterFlowDaily', p.flow);
  setInputValue('masterAerVolDaily', p.aerationVolume);
  setInputValue('masterBODDaily', p.bod);
  setInputValue('masterMLSSDaily', p.mlss);

  // Update Dashboard KPIs directly
  var flow = parseFloat(p.flow) || 5.0;
  var aerVol = parseFloat(p.aerationVolume) || 1.0;
  var bod = parseFloat(p.bod) || 200;
  var mlss = parseFloat(p.mlss) || 3000;

  if (document.getElementById('kpi-flow')) document.getElementById('kpi-flow').textContent = flow.toFixed(2);
  if (document.getElementById('kpi-mlss')) document.getElementById('kpi-mlss').textContent = mlss;

  // Calculate and update F/M
  var mlvss = mlss * 0.8;
  var bodLoad = flow * bod * 8.34;
  var fm = bodLoad / (mlvss * aerVol * 8.34);
  if (document.getElementById('kpi-fm')) document.getElementById('kpi-fm').textContent = fm.toFixed(2);

  // Load extended parameters
  setInputValue('profilePlantName', p.plantName);
  setInputValue('profileClient', p.client);
  setInputValue('profilePermit', p.permit);
  setInputValue('profileDesignFlow', p.designFlow);
  setInputValue('profileProcessType', p.processType);
  setInputValue('profileClarifiers', p.clarifiers);
  setInputValue('profileClarifierDia', p.clarifierDia);
  setInputValue('profileSWD', p.swd);
  setInputValue('profileTargetSRT', p.targetSRT);
  setInputValue('profileNotes', p.notes);

  // Sync to all calculators
  if (typeof syncAllMasterSettings === 'function') {
    syncAllMasterSettings();
  }

  // Auto-calculate all
  if (typeof syncAndCalculateAll === 'function') {
    syncAndCalculateAll();
  } else if (typeof calculateAll === 'function') {
    calculateAll();
  }

  showToast('‚úÖ Loaded & Synced: ' + p.name, 'success');
}

// Delete selected profile
function deleteSelectedProfile() {
  var select = document.getElementById('profileSelect');
  if (!select) return;

  var index = parseInt(select.value);
  if (isNaN(index) || !plantProfiles[index]) {
    showToast('Please select a profile first', 'error');
    return;
  }

  var profileName = plantProfiles[index].name;

  // Create custom confirm modal for mobile
  var modal = document.createElement('div');
  modal.id = 'deleteConfirmModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:99999;padding:20px';
  modal.innerHTML =
    '<div style="background:linear-gradient(135deg,#1e1b4b,#312e81);padding:30px;border-radius:16px;max-width:400px;width:100%;text-align:center;border:3px solid #ef4444">' +
    '<div style="font-size:50px;margin-bottom:15px">üóëÔ∏è</div>' +
    '<h3 style="color:white;margin:0 0 15px 0">Delete Profile?</h3>' +
    '<p style="color:#e2e8f0;margin:0 0 25px 0">Delete "<strong>' + profileName + '</strong>"?<br><br>This cannot be undone.</p>' +
    '<div style="display:flex;gap:15px;justify-content:center">' +
    '<button onclick="confirmDeleteProfile(' + index + ')" style="background:#ef4444;color:white;border:none;padding:14px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer">üóëÔ∏è Delete</button>' +
    '<button onclick="document.getElementById(\'deleteConfirmModal\').remove()" style="background:#6b7280;color:white;border:none;padding:14px 30px;border-radius:10px;font-size:16px;cursor:pointer">Cancel</button>' +
    '</div></div>';
  document.body.appendChild(modal);
}

function confirmDeleteProfile(index) {
  // Close modal
  var modal = document.getElementById('deleteConfirmModal');
  if (modal) modal.remove();

  // Delete profile
  var profileName = plantProfiles[index].name;
  plantProfiles.splice(index, 1);
  savePlantProfiles();
  updateProfileDropdown();

  // Hide preview
  var preview = document.getElementById('profilePreview');
  if (preview) preview.style.display = 'none';

  // Reset dropdown
  var select = document.getElementById('profileSelect');
  if (select) select.value = '';

  showToast('üóëÔ∏è Deleted: ' + profileName, 'success');
}

// Export all profiles as JSON
function exportProfiles() {
  if (plantProfiles.length === 0) {
    showToast('No profiles to export', 'error');
    return;
  }

  var data = {
    version: '9.2.8',
    exported: new Date().toISOString(),
    profiles: plantProfiles
  };

  var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'WWTP_Plant_Profiles_' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
  URL.revokeObjectURL(url);

  showToast('üì§ Exported ' + plantProfiles.length + ' profiles', 'success');
}

// Trigger file import
function importProfiles() {
  document.getElementById('profileImportFile').click();
}

// Handle file import
function handleProfileImport(event) {
  var file = event.target.files[0];
  if (!file) return;

  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      var imported = data.profiles || data;

      if (!Array.isArray(imported)) {
        throw new Error('Invalid profile format');
      }

      var count = 0;
      imported.forEach(function(profile) {
        if (profile.name) {
          // Check for duplicates
          var exists = plantProfiles.some(function(p) { return p.name === profile.name; });
          if (!exists) {
            plantProfiles.push(profile);
            count++;
          }
        }
      });

      savePlantProfiles();
      updateProfileDropdown();

      showToast('üì• Imported ' + count + ' new profiles', 'success');
    } catch(err) {
      showToast('Error importing: ' + err.message, 'error');
    }
  };
  reader.readAsText(file);

  // Reset file input
  event.target.value = '';
}

// Show profile statistics
function showProfileCount() {
  var msg = 'üìä Plant Profiles Statistics\n\n';
  msg += 'Total Profiles: ' + plantProfiles.length + '\n\n';

  if (plantProfiles.length > 0) {
    msg += 'Profiles:\n';
    plantProfiles.forEach(function(p, i) {
      msg += (i + 1) + '. ' + p.name + (p.client ? ' (' + p.client + ')' : '') + '\n';
    });
  }

  alert(msg);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initPlantProfiles);
// Also try to init immediately in case DOM is already ready
if (document.readyState !== 'loading') {
  initPlantProfiles();
}

// ========== END PLANT PROFILES SYSTEM ==========
// ========== MASTER SETTINGS SYNC SYSTEM ==========

// Sync Master Settings from Process Control to ALL calculators
function syncMasterToAll() {
  // Get values from Process Control Master Settings (primary source)
  var flow = parseFloat(document.getElementById('masterFlowPC')?.value) || 3.5;
  var aerVol = parseFloat(document.getElementById('masterAerVolPC')?.value) || 1.0;
  var bod = parseFloat(document.getElementById('masterBODPC')?.value) || 200;
  var mlss = parseFloat(document.getElementById('masterMLSSPC')?.value) || 3000;
  var clarDia = parseFloat(document.getElementById('masterClarDia')?.value) || 80;
  var clarNum = parseFloat(document.getElementById('masterClarNum')?.value) || 2;
  var weirLen = parseFloat(document.getElementById('masterWeirLen')?.value) || 500;
  var wasFlow = parseFloat(document.getElementById('masterWAS')?.value) || 25000;

  // Sync to Profiles panel master settings
  if (document.getElementById('masterFlow')) document.getElementById('masterFlow').value = flow;
  if (document.getElementById('masterAerVol')) document.getElementById('masterAerVol').value = aerVol;
  if (document.getElementById('masterBOD')) document.getElementById('masterBOD').value = bod;
  if (document.getElementById('masterMLSS')) document.getElementById('masterMLSS').value = mlss;

  // Update Dashboard KPIs
  if (document.getElementById('kpi-flow')) document.getElementById('kpi-flow').textContent = flow.toFixed(2);
  if (document.getElementById('kpi-mlss')) document.getElementById('kpi-mlss').textContent = mlss;

  // Calculate and update F/M ratio
  var mlvss = mlss * 0.8;
  var bodLoad = flow * bod * 8.34;
  var fm = bodLoad / (mlvss * aerVol * 8.34);
  if (document.getElementById('kpi-fm')) document.getElementById('kpi-fm').textContent = fm.toFixed(2);

  // Sync to calculator inputs across panels
  var flowInputs = ['flow', 'inf_flow', 'flowRate', 'q_flow', 'daily_flow'];
  var bodInputs = ['bod', 'inf_bod', 'bodConc'];
  // NOTE: Reactor Master Settings (SBR, MBR, MBBR) are kept SEPARATE - not synced from main KPI
  var mlssInputs = [
    'mlss', 'mlss_conc', 'mlss_val',           // General
    'srt_mlss', 'svi_mlss', 'mcrt_mlss',       // Process calculators
    'was_mlss', 'ras_mlss', 'slr_mlss',        // Solids handling
    'clar_mlss', 'ras_ratio_mlss',             // Clarifier & RAS
    'ras_blanket_mlss', 'ras_mlss_current',    // RAS methods
    'was2_srt_mlss', 'was2_mcrt_mlss',         // Advanced WAS
    'was2_fm_mlss', 'was2_mlss_current',       // Advanced WAS
    'rpt_mlss'                                  // Reports
    // EXCLUDED: sbr_mlss, sbr_load_mlss, sbr_was_mlss, mbr_srt_mlss, ifas_mlss, rm_mbr_mlss
    // These are controlled by Reactor Master Settings separately
  ];
  var volInputs = ['aerVol', 'aer_volume', 'basin_vol', 'srt_vol', 'dt_volume'];

  flowInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = flow;
  });

  bodInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = bod;
  });

  mlssInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = mlss;
  });

  volInputs.forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = aerVol;
  });

  // ===== SYNC TO ENHANCED CALCULATORS =====

  // Detention Time
  if (document.getElementById('dt_volume')) document.getElementById('dt_volume').value = aerVol;
  if (document.getElementById('dt_flow')) document.getElementById('dt_flow').value = flow;

  // Surface Overflow Rate
  if (document.getElementById('sor_flow')) document.getElementById('sor_flow').value = flow;
  if (document.getElementById('sor_dia')) document.getElementById('sor_dia').value = clarDia;
  if (document.getElementById('sor_num')) document.getElementById('sor_num').value = clarNum;

  // Weir Loading
  if (document.getElementById('weir_flow')) document.getElementById('weir_flow').value = flow;
  if (document.getElementById('weir_length')) document.getElementById('weir_length').value = weirLen;

  // Oxygen Requirement - calculate BOD load
  var bodRemoved = Math.round(flow * bod * 8.34 * 0.95); // 95% removal
  var tknOxidized = Math.round(flow * 40 * 8.34 * 0.90); // Assume 40 mg/L TKN, 90% nitrification
  if (document.getElementById('o2_bod')) document.getElementById('o2_bod').value = bodRemoved;
  if (document.getElementById('o2_tkn')) document.getElementById('o2_tkn').value = tknOxidized;

  // Chemical Cost
  if (document.getElementById('chem_flow')) document.getElementById('chem_flow').value = flow;

  // SRT Calculator
  if (document.getElementById('srt_vol')) document.getElementById('srt_vol').value = aerVol;
  if (document.getElementById('srt_mlss')) document.getElementById('srt_mlss').value = mlss;
  if (document.getElementById('srt_was')) document.getElementById('srt_was').value = wasFlow;

  // Recalculate all enhanced calculators
  if (typeof calcDetentionTime === 'function') calcDetentionTime();
  if (typeof calcSOR === 'function') calcSOR();
  if (typeof calcWeirLoading === 'function') calcWeirLoading();
  if (typeof calcOxygenReq === 'function') calcOxygenReq();
  if (typeof calcChemCost === 'function') calcChemCost();
  if (typeof calcSRT === 'function') calcSRT();

  // Update F/M gauge
  if (typeof updateGauge === 'function') {
    updateGauge('fm', fm, 0, 1, 0.2, 0.5);
  }

  showToast('‚úÖ All calculators synced!', 'success');
}

// Keep old function name for backwards compatibility
function syncAllMasterSettings() {
  syncMasterToAll();
}

// Sync from Profiles panel to Process Control and everywhere else
function syncFromProfiles() {
  var flow = parseFloat(document.getElementById('masterFlow')?.value) || 5.0;
  var aerVol = parseFloat(document.getElementById('masterAerVol')?.value) || 1.0;
  var bod = parseFloat(document.getElementById('masterBOD')?.value) || 200;
  var mlss = parseFloat(document.getElementById('masterMLSS')?.value) || 3000;

  // Sync to Process Control Master Settings
  if (document.getElementById('masterFlowPC')) document.getElementById('masterFlowPC').value = flow;
  if (document.getElementById('masterAerVolPC')) document.getElementById('masterAerVolPC').value = aerVol;
  if (document.getElementById('masterBODPC')) document.getElementById('masterBODPC').value = bod;
  if (document.getElementById('masterMLSSPC')) document.getElementById('masterMLSSPC').value = mlss;

  // Then sync everything else
  syncMasterToAll();
}

// Override original syncMasterSettings to also update KPIs
var originalSyncMasterSettings = typeof syncMasterSettings === 'function' ? syncMasterSettings : null;
function syncMasterSettings() {
  syncFromProfiles();
  if (originalSyncMasterSettings) {
    // Call original but it's already covered by syncFromProfiles
  }
  syncAllMasterSettings();
}

// ========== END MASTER SETTINGS SYNC SYSTEM ==========
// ========== ENHANCED CALCULATORS SYSTEM ==========

var calcUnits = 'us'; // 'us' or 'metric'
var calcHistory = [];
var formulasVisible = false;
var compareModeActive = false;

// Initialize calculators
function initEnhancedCalculators() {
  loadCalcHistory();
  calcDetentionTime();
  calcSOR();
  calcWeirLoading();
  calcOxygenReq();
  calcChemCost();
  calcSRT();
}

// Unit conversion toggle
function setUnits(unit) {
  calcUnits = unit;
  document.querySelectorAll('#unitToggle button').forEach(function(btn) {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');

  // Update labels based on unit selection
  if (unit === 'metric') {
    document.getElementById('dt_vol_unit').textContent = 'm¬≥';
    document.getElementById('dt_flow_unit').textContent = 'm¬≥/d';
    document.getElementById('dt_result_unit').textContent = 'hours';
  } else {
    document.getElementById('dt_vol_unit').textContent = 'MG';
    document.getElementById('dt_flow_unit').textContent = 'MGD';
    document.getElementById('dt_result_unit').textContent = 'hours';
  }

  // Recalculate all
  calcDetentionTime();
  calcSOR();
  calcWeirLoading();
  calcOxygenReq();
  calcChemCost();
  calcSRT();

  showToast('Units changed to ' + (unit === 'us' ? 'US' : 'Metric'), 'info');
}

// Toggle formula display
function toggleFormulaDisplay() {
  formulasVisible = !formulasVisible;
  var boxes = document.querySelectorAll('.formula-box');
  boxes.forEach(function(box) {
    box.classList.toggle('visible', formulasVisible);
  });
  showToast(formulasVisible ? 'Formulas shown' : 'Formulas hidden', 'info');
}

// Toggle compare mode
function toggleCompareMode() {
  compareModeActive = !compareModeActive;
  var panel = document.getElementById('compareModePanel');
  panel.style.display = compareModeActive ? 'block' : 'none';

  if (compareModeActive) {
    updateCompareMode();
  }
  showToast(compareModeActive ? 'Compare mode enabled' : 'Compare mode disabled', 'info');
}

function updateCompareMode() {
  var compareA = document.getElementById('compareA');
  var compareB = document.getElementById('compareB');

  compareA.innerHTML = '<p><strong>Detention Time:</strong> ' + document.getElementById('dt_result').textContent + ' hrs</p>' +
    '<p><strong>SOR:</strong> ' + document.getElementById('sor_result').textContent + ' GPD/ft¬≤</p>' +
    '<p><strong>SRT:</strong> ' + document.getElementById('srt_result').textContent + ' days</p>' +
    '<p><strong>O‚ÇÇ Required:</strong> ' + document.getElementById('o2_result').textContent + ' lb/d</p>';

  compareB.innerHTML = '<p style="color:#94a3b8">Modify input values above to see comparison</p>';
}

// Detention Time Calculator
function calcDetentionTime() {
  var vol = parseFloat(document.getElementById('dt_volume').value) || 0;
  var flow = parseFloat(document.getElementById('dt_flow').value) || 0;

  var dt = 0;
  if (flow > 0) {
    dt = (vol * 24) / flow; // hours for US units
  }

  document.getElementById('dt_result').textContent = dt.toFixed(2);
  document.getElementById('dt_formula').textContent = 'HRT = (Volume √ó 24) / Flow = (' + vol.toFixed(1) + ' MG √ó 24) / ' + flow.toFixed(1) + ' MGD = ' + dt.toFixed(2) + ' hrs';

  validateInput('dt_volume', vol, 0.1, 100);
  validateInput('dt_flow', flow, 0.1, 100);
}

// Surface Overflow Rate Calculator
function calcSOR() {
  var flow = parseFloat(document.getElementById('sor_flow').value) || 0;
  var dia = parseFloat(document.getElementById('sor_dia').value) || 0;
  var num = parseFloat(document.getElementById('sor_num').value) || 1;

  var area = Math.PI * Math.pow(dia/2, 2) * num; // total sq ft
  var sor = 0;
  if (area > 0) {
    sor = (flow * 1000000) / area;
  }

  var resultEl = document.getElementById('sor_result');
  var statusEl = document.getElementById('sor_status');

  resultEl.textContent = Math.round(sor).toLocaleString();

  if (sor < 300) {
    resultEl.style.color = '#f59e0b';
    statusEl.textContent = '‚ö† Low (may be oversized)';
    statusEl.style.color = '#f59e0b';
  } else if (sor <= 800) {
    resultEl.style.color = '#10b981';
    statusEl.textContent = '‚úì Good (300-800 typical)';
    statusEl.style.color = '#10b981';
  } else if (sor <= 1200) {
    resultEl.style.color = '#f59e0b';
    statusEl.textContent = '‚ö† High (may affect settling)';
    statusEl.style.color = '#f59e0b';
  } else {
    resultEl.style.color = '#ef4444';
    statusEl.textContent = '‚úó Too High (>1200)';
    statusEl.style.color = '#ef4444';
  }

  document.getElementById('sor_formula').textContent = 'SOR = Flow / Area = ' + (flow*1000000).toLocaleString() + ' GPD / ' + Math.round(area).toLocaleString() + ' sq ft = ' + Math.round(sor) + ' GPD/ft¬≤';
}

// Weir Loading Calculator
function calcWeirLoading() {
  var flow = parseFloat(document.getElementById('weir_flow').value) || 0;
  var length = parseFloat(document.getElementById('weir_length').value) || 0;

  var wlr = 0;
  if (length > 0) {
    wlr = (flow * 1000000) / length;
  }

  var resultEl = document.getElementById('weir_result');
  var statusEl = document.getElementById('weir_status');

  resultEl.textContent = Math.round(wlr).toLocaleString();

  if (wlr <= 10000) {
    resultEl.style.color = '#10b981';
    statusEl.textContent = '‚úì Good (<10,000 typical)';
    statusEl.style.color = '#10b981';
  } else if (wlr <= 15000) {
    resultEl.style.color = '#f59e0b';
    statusEl.textContent = '‚ö† Elevated (may cause currents)';
    statusEl.style.color = '#f59e0b';
  } else {
    resultEl.style.color = '#ef4444';
    statusEl.textContent = '‚úó Too High (>15,000)';
    statusEl.style.color = '#ef4444';
  }

  document.getElementById('weir_formula').textContent = 'WLR = Flow / Weir Length = ' + (flow*1000000).toLocaleString() + ' / ' + length + ' = ' + Math.round(wlr).toLocaleString() + ' GPD/ft';
}

// Oxygen Requirement Calculator
function calcOxygenReq() {
  var bod = parseFloat(document.getElementById('o2_bod').value) || 0;
  var tkn = parseFloat(document.getElementById('o2_tkn').value) || 0;

  // O2 = 1.5 √ó BOD removed + 4.6 √ó TKN oxidized (nitrification)
  var o2 = (1.5 * bod) + (4.6 * tkn);
  var o2hr = o2 / 24;

  document.getElementById('o2_result').textContent = Math.round(o2).toLocaleString();
  document.getElementById('o2_hourly').textContent = Math.round(o2hr) + ' lb/hr';
  document.getElementById('o2_formula').textContent = 'O‚ÇÇ = 1.5√óBOD + 4.6√óTKN = 1.5√ó' + bod + ' + 4.6√ó' + tkn + ' = ' + Math.round(o2).toLocaleString() + ' lb/d';
}

// Chemical Cost Calculator
function calcChemCost() {
  var flow = parseFloat(document.getElementById('chem_flow').value) || 0;
  var dose = parseFloat(document.getElementById('chem_dose').value) || 0;
  var cost = parseFloat(document.getElementById('chem_cost').value) || 0;

  var lbsPerDay = flow * dose * 8.34;
  var dailyCost = lbsPerDay * cost;
  var monthlyCost = dailyCost * 30;
  var yearlyCost = dailyCost * 365;

  document.getElementById('chem_daily').textContent = '$' + Math.round(dailyCost).toLocaleString();
  document.getElementById('chem_monthly').textContent = '$' + Math.round(monthlyCost).toLocaleString() + '/month ‚Ä¢ $' + Math.round(yearlyCost).toLocaleString() + '/year';
  document.getElementById('chem_formula').textContent = 'lbs/d = Flow √ó Dose √ó 8.34 = ' + flow + ' √ó ' + dose + ' √ó 8.34 = ' + Math.round(lbsPerDay).toLocaleString() + ' lb/d √ó $' + cost.toFixed(2) + ' = $' + Math.round(dailyCost) + '/d';
}

// SRT Calculator
function calcSRT() {
  var vol = parseFloat(document.getElementById('srt_vol').value) || 0;
  var mlss = parseFloat(document.getElementById('srt_mlss').value) || 0;
  var was = parseFloat(document.getElementById('srt_was').value) || 0;
  var wasTss = parseFloat(document.getElementById('srt_wastss').value) || 0;

  var mlssInv = vol * mlss * 8.34; // lbs in system
  var wasSolids = was * wasTss * 8.34 / 1000000; // lbs/day wasted

  var srt = 0;
  if (wasSolids > 0) {
    srt = mlssInv / (wasSolids * 1000000);
  }

  var resultEl = document.getElementById('srt_result');
  var statusEl = document.getElementById('srt_status');

  resultEl.textContent = srt.toFixed(1);

  if (srt < 3) {
    resultEl.style.color = '#ef4444';
    statusEl.textContent = '‚úó Too Low (washout risk)';
    statusEl.style.color = '#ef4444';
  } else if (srt < 5) {
    resultEl.style.color = '#f59e0b';
    statusEl.textContent = '‚ö† Low (limited nitrification)';
    statusEl.style.color = '#f59e0b';
  } else if (srt <= 15) {
    resultEl.style.color = '#10b981';
    statusEl.textContent = '‚úì Good for nitrification';
    statusEl.style.color = '#10b981';
  } else if (srt <= 25) {
    resultEl.style.color = '#f59e0b';
    statusEl.textContent = '‚ö† High (check for Nocardia)';
    statusEl.style.color = '#f59e0b';
  } else {
    resultEl.style.color = '#ef4444';
    statusEl.textContent = '‚úó Very High (foam risk)';
    statusEl.style.color = '#ef4444';
  }

  document.getElementById('srt_formula').textContent = 'SRT = (Vol √ó MLSS √ó 8.34) / (WAS √ó WAS_TSS √ó 8.34) = ' + srt.toFixed(1) + ' days';

  // Update gauge
  updateGauge('srt', srt, 0, 30, 5, 15);
}

// Update gauge visualization
function updateGauge(type, value, min, max, optMin, optMax) {
  var gaugeEl = document.getElementById(type + 'Gauge');
  var valueEl = document.getElementById(type + 'GaugeValue');
  var cardEl = document.getElementById(type + 'Card');
  var statusEl = document.getElementById(type + 'Status');

  if (!gaugeEl) return;

  var percent = Math.min(100, Math.max(0, ((value - min) / (max - min)) * 100));
  var offset = 173 - (173 * percent / 100);

  gaugeEl.style.strokeDashoffset = offset;
  valueEl.textContent = value.toFixed(1);

  // Color based on optimal range
  if (value >= optMin && value <= optMax) {
    gaugeEl.setAttribute('stroke', '#10b981');
    cardEl.className = 'calc-result-card optimal';
    statusEl.className = 'status-badge optimal';
    statusEl.textContent = '‚úì Optimal';
  } else if (value < optMin * 0.5 || value > optMax * 1.5) {
    gaugeEl.setAttribute('stroke', '#ef4444');
    cardEl.className = 'calc-result-card critical';
    statusEl.className = 'status-badge critical';
    statusEl.textContent = '‚úó Critical';
  } else {
    gaugeEl.setAttribute('stroke', '#f59e0b');
    cardEl.className = 'calc-result-card warning';
    statusEl.className = 'status-badge warning';
    statusEl.textContent = '‚ö† Warning';
  }
}

// Input validation with visual feedback
function validateInput(inputId, value, min, max) {
  var input = document.getElementById(inputId);
  if (!input) return;

  input.classList.remove('valid', 'invalid', 'warning-range');

  if (value < min || value > max) {
    input.classList.add('invalid');
  } else if (value < min * 1.2 || value > max * 0.8) {
    input.classList.add('warning-range');
  } else {
    input.classList.add('valid');
  }
}

// Save calculation results
function saveCalcResults() {
  var result = {
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleDateString(),
    time: new Date().toLocaleTimeString(),
    detentionTime: document.getElementById('dt_result').textContent,
    sor: document.getElementById('sor_result').textContent,
    weirLoading: document.getElementById('weir_result').textContent,
    oxygenReq: document.getElementById('o2_result').textContent,
    chemCost: document.getElementById('chem_daily').textContent,
    srt: document.getElementById('srt_result').textContent
  };

  calcHistory.unshift(result);
  if (calcHistory.length > 50) calcHistory.pop(); // Keep last 50

  localStorage.setItem('wwtp_calc_history', JSON.stringify(calcHistory));
  showToast('üíæ Results saved to history', 'success');
}

// Load calculation history
function loadCalcHistory() {
  try {
    var saved = localStorage.getItem('wwtp_calc_history');
    if (saved) {
      calcHistory = JSON.parse(saved);
    }
  } catch(e) {
    console.error('Error loading calc history:', e);
    calcHistory = [];
  }
}

// Show calculation history modal
function showCalcHistory() {
  var modal = document.getElementById('calcHistoryModal');
  var list = document.getElementById('calcHistoryList');

  if (calcHistory.length === 0) {
    list.innerHTML = '<p style="color:#94a3b8;text-align:center">No saved calculations yet.</p>';
  } else {
    var html = '';
    calcHistory.forEach(function(item, index) {
      html += '<div class="calc-history-item">';
      html += '<div>';
      html += '<div class="timestamp">' + item.date + ' ' + item.time + '</div>';
      html += '<div class="values">DT: ' + item.detentionTime + 'hr ‚Ä¢ SOR: ' + item.sor + ' ‚Ä¢ SRT: ' + item.srt + 'd</div>';
      html += '</div>';
      html += '<button onclick="loadHistoryItem(' + index + ')" style="background:#3b82f6;border:none;color:white;padding:6px 12px;border-radius:6px;cursor:pointer">Load</button>';
      html += '</div>';
    });
    list.innerHTML = html;
  }

  modal.style.display = 'block';
}

function closeCalcHistory() {
  document.getElementById('calcHistoryModal').style.display = 'none';
}

function clearCalcHistory() {
  if (confirm('Clear all calculation history?')) {
    calcHistory = [];
    localStorage.removeItem('wwtp_calc_history');
    showCalcHistory();
    showToast('History cleared', 'info');
  }
}

function loadHistoryItem(index) {
  // Could restore inputs from history item
  showToast('Historical values: DT=' + calcHistory[index].detentionTime + ', SRT=' + calcHistory[index].srt, 'info');
  closeCalcHistory();
}

// Export calculation results
function exportCalcResults() {
  var csv = 'Parameter,Value,Unit,Status\n';
  csv += 'Detention Time,' + document.getElementById('dt_result').textContent + ',hours,\n';
  csv += 'Surface Overflow Rate,' + document.getElementById('sor_result').textContent + ',GPD/ft¬≤,' + document.getElementById('sor_status').textContent + '\n';
  csv += 'Weir Loading,' + document.getElementById('weir_result').textContent + ',GPD/ft,' + document.getElementById('weir_status').textContent + '\n';
  csv += 'Oxygen Required,' + document.getElementById('o2_result').textContent + ',lb O2/day,\n';
  csv += 'Chemical Cost,' + document.getElementById('chem_daily').textContent + ',$/day,\n';
  csv += 'SRT,' + document.getElementById('srt_result').textContent + ',days,' + document.getElementById('srt_status').textContent + '\n';

  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_calculations_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);

  showToast('üì§ Results exported to CSV', 'success');
}

function exportCalcHistory() {
  if (calcHistory.length === 0) {
    showToast('No history to export', 'error');
    return;
  }

  var csv = 'Date,Time,Detention Time (hr),SOR (GPD/ft¬≤),Weir Loading (GPD/ft),O2 Required (lb/d),Chemical Cost ($/d),SRT (days)\n';
  calcHistory.forEach(function(item) {
    csv += item.date + ',' + item.time + ',' + item.detentionTime + ',' + item.sor + ',' + item.weirLoading + ',' + item.oxygenReq + ',' + item.chemCost + ',' + item.srt + '\n';
  });

  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_calc_history_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);

  showToast('üì§ History exported to CSV', 'success');
  closeCalcHistory();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', initEnhancedCalculators);
if (document.readyState !== 'loading') {
  initEnhancedCalculators();
}

// ========== END ENHANCED CALCULATORS SYSTEM ==========
// ========== PDF REPORT GENERATOR SYSTEM ==========

var selectedReportType = null;

// Initialize report date to today
document.addEventListener('DOMContentLoaded', function() {
  var dateInput = document.getElementById('rpt_date');
  if (dateInput) {
    dateInput.value = new Date().toISOString().split('T')[0];
  }
  loadBrandingSettings();
});

// Select report type
function selectReportType(type) {
  selectedReportType = type;

  // Update card styles
  ['daily', 'process', 'visit', 'calc'].forEach(function(t) {
    var card = document.getElementById('rptCard_' + t);
    if (card) {
      card.style.borderColor = (t === type) ? '#fbbf24' : 'transparent';
      card.style.transform = (t === type) ? 'scale(1.02)' : 'scale(1)';
    }
  });

  // Show configuration section
  document.getElementById('reportConfigSection').style.display = 'block';

  // Update title
  var titles = {
    daily: 'üìÖ Daily Operations Report Configuration',
    process: '‚öôÔ∏è Process Summary Report Configuration',
    visit: 'üè≠ Client Visit Report Configuration',
    calc: 'üßÆ Calculation Report Configuration'
  };
  document.getElementById('reportConfigTitle').textContent = titles[type];

  // Show/hide specific fields
  document.getElementById('dailyFields').style.display = (type === 'daily') ? 'block' : 'none';
  document.getElementById('visitFields').style.display = (type === 'visit') ? 'block' : 'none';

  // Scroll to config
  document.getElementById('reportConfigSection').scrollIntoView({ behavior: 'smooth' });

  showToast('Selected: ' + titles[type].split(' Configuration')[0], 'info');
}

// Load from profile
function loadProfileToReport() {
  var profileSelect = document.getElementById('profileSelect');
  if (!profileSelect || !profileSelect.value) {
    showToast('No profile selected. Go to Profiles panel first.', 'error');
    return;
  }

  var profiles = JSON.parse(localStorage.getItem('wwtp_plant_profiles') || '[]');
  var profile = profiles[profileSelect.value];

  if (profile) {
    document.getElementById('rpt_plant').value = profile.plantName || profile.name || '';
    document.getElementById('rpt_client').value = profile.client || '';
    document.getElementById('rpt_permit').value = profile.permit || '';
    document.getElementById('rpt_designflow').value = profile.designFlow || '';
    document.getElementById('rpt_process').value = profile.processType || 'Conventional AS';

    // Also load values
    document.getElementById('rpt_flow').value = profile.flow || '3.5';
    document.getElementById('rpt_mlss').value = profile.mlss || '3000';

    showToast('‚úÖ Loaded from profile: ' + profile.name, 'success');
  }
}

// Load from Master Settings
function loadMasterToReport() {
  var flow = document.getElementById('masterFlowPC')?.value || '3.5';
  var bod = document.getElementById('masterBODPC')?.value || '200';
  var mlss = document.getElementById('masterMLSSPC')?.value || '3000';

  document.getElementById('rpt_flow').value = flow;
  document.getElementById('rpt_bod').value = bod;
  document.getElementById('rpt_mlss').value = mlss;

  showToast('‚úÖ Loaded from Master Settings', 'success');
}

// Save branding settings
function saveBrandingSettings() {
  var branding = {
    company: document.getElementById('rpt_company')?.value || '',
    consultant: document.getElementById('rpt_consultant')?.value || '',
    phone: document.getElementById('rpt_phone')?.value || '',
    email: document.getElementById('rpt_email')?.value || '',
    license: document.getElementById('rpt_license')?.value || ''
  };
  localStorage.setItem('wwtp_branding', JSON.stringify(branding));
  showToast('üíæ Branding saved!', 'success');
}

// Load branding settings
function loadBrandingSettings() {
  try {
    var branding = JSON.parse(localStorage.getItem('wwtp_branding') || '{}');
    if (branding.company) document.getElementById('rpt_company').value = branding.company;
    if (branding.consultant) document.getElementById('rpt_consultant').value = branding.consultant;
    if (branding.phone) document.getElementById('rpt_phone').value = branding.phone;
    if (branding.email) document.getElementById('rpt_email').value = branding.email;
    if (branding.license) document.getElementById('rpt_license').value = branding.license;
  } catch(e) {
  }
}

// Preview Report
function previewReport() {
  if (!selectedReportType) {
    showToast('Please select a report type first', 'error');
    return;
  }

  var html = generateReportHTML(selectedReportType);
  document.getElementById('reportPreviewContent').innerHTML = html;
  document.getElementById('reportPreviewArea').style.display = 'block';
  document.getElementById('reportPreviewArea').scrollIntoView({ behavior: 'smooth' });
}

function closeReportPreview() {
  document.getElementById('reportPreviewArea').style.display = 'none';
}

// Generate Report HTML
function generateReportHTML(type) {
  var company = document.getElementById('rpt_company')?.value || 'WWTP Consulting';
  var consultant = document.getElementById('rpt_consultant')?.value || '';
  var phone = document.getElementById('rpt_phone')?.value || '';
  var email = document.getElementById('rpt_email')?.value || '';
  var license = document.getElementById('rpt_license')?.value || '';

  var plant = document.getElementById('rpt_plant')?.value || 'Plant Name';
  var client = document.getElementById('rpt_client')?.value || '';
  var permit = document.getElementById('rpt_permit')?.value || '';
  var rptDate = document.getElementById('rpt_date')?.value || new Date().toISOString().split('T')[0];
  var processType = document.getElementById('rpt_process')?.value || '';
  var designFlow = document.getElementById('rpt_designflow')?.value || '';

  var notes = document.getElementById('rpt_notes')?.value || '';

  var html = '';

  // Header
  html += '<div style="border-bottom:3px solid #059669;padding-bottom:20px;margin-bottom:20px">';
  html += '<h1 style="margin:0;color:#059669;font-size:18px">' + company + '</h1>';
  if (consultant) html += '<p style="margin:5px 0;font-size:14px"><strong>Consultant:</strong> ' + consultant + '</p>';
  var contactLine = [];
  if (phone) contactLine.push(phone);
  if (email) contactLine.push(email);
  if (license) contactLine.push('License: ' + license);
  if (contactLine.length) html += '<p style="margin:5px 0;font-size:13px;color:#666">' + contactLine.join(' | ') + '</p>';
  html += '</div>';

  // Report Title
  var titles = {
    daily: 'üìÖ Daily Operations Report',
    process: '‚öôÔ∏è Process Summary Report',
    visit: 'üè≠ Client Visit Report',
    calc: 'üßÆ Calculation Report'
  };
  html += '<h2 style="text-align:center;color:#1e3a5f;margin-bottom:20px">' + titles[type] + '</h2>';

  // Plant Info Box
  html += '<div style="background:#f0f9ff;padding:15px;border-radius:8px;margin-bottom:20px">';
  html += '<table style="width:100%;border-collapse:collapse">';
  html += '<tr><td style="padding:5px"><strong>Plant:</strong> ' + plant + '</td>';
  html += '<td style="padding:5px"><strong>Date:</strong> ' + formatDate(rptDate) + '</td></tr>';
  if (client) html += '<tr><td style="padding:5px"><strong>Client:</strong> ' + client + '</td>';
  if (permit) html += '<td style="padding:5px"><strong>Permit #:</strong> ' + permit + '</td></tr>';
  if (processType || designFlow) {
    html += '<tr>';
    if (processType) html += '<td style="padding:5px"><strong>Process:</strong> ' + processType + '</td>';
    if (designFlow) html += '<td style="padding:5px"><strong>Design Flow:</strong> ' + designFlow + ' MGD</td>';
    html += '</tr>';
  }
  html += '</table></div>';

  // Type-specific content
  if (type === 'daily') {
    html += generateDailyContent();
  } else if (type === 'process') {
    html += generateProcessContent();
  } else if (type === 'visit') {
    html += generateVisitContent();
  } else if (type === 'calc') {
    html += generateCalcContent();
  }

  // Notes
  if (notes) {
    html += '<div style="margin-top:20px;padding:15px;background:#fef3c7;border-radius:8px">';
    html += '<h4 style="margin:0 0 10px 0;color:#92400e">üìù Notes</h4>';
    html += '<p style="margin:0;white-space:pre-wrap">' + notes + '</p>';
    html += '</div>';
  }

  // Footer
  html += '<div style="margin-top:30px;padding-top:20px;border-top:2px solid #e5e7eb;text-align:center;color:#6b7280;font-size:12px">';
  html += '<p>Report generated by WWTP Command Center v9.6.0 on ' + new Date().toLocaleString() + '</p>';
  html += '<p>' + company + '</p>';
  html += '</div>';

  return html;
}

// Daily Operations Content
function generateDailyContent() {
  var flow = document.getElementById('rpt_flow')?.value || '-';
  var bod = document.getElementById('rpt_bod')?.value || '-';
  var tss = document.getElementById('rpt_tss')?.value || '-';
  var mlss = document.getElementById('rpt_mlss')?.value || '-';
  var doVal = document.getElementById('rpt_do')?.value || '-';
  var ph = document.getElementById('rpt_ph')?.value || '-';
  var effBod = document.getElementById('rpt_eff_bod')?.value || '-';
  var effTss = document.getElementById('rpt_eff_tss')?.value || '-';
  var effNh3 = document.getElementById('rpt_eff_nh3')?.value || '-';

  var html = '<h3 style="color:#059669;border-bottom:2px solid #059669;padding-bottom:5px">Influent Parameters</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#e0f2fe"><th style="padding:10px;text-align:left;border:1px solid #bae6fd">Parameter</th><th style="padding:10px;text-align:center;border:1px solid #bae6fd">Value</th><th style="padding:10px;text-align:center;border:1px solid #bae6fd">Unit</th><th style="padding:10px;text-align:center;border:1px solid #bae6fd">Status</th></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Flow Rate</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + flow + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">MGD</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">BOD</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + bod + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">TSS</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + tss + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '</table>';

  html += '<h3 style="color:#f97316;border-bottom:2px solid #f97316;padding-bottom:5px">Process Parameters</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#ffedd5"><th style="padding:10px;text-align:left;border:1px solid #fed7aa">Parameter</th><th style="padding:10px;text-align:center;border:1px solid #fed7aa">Value</th><th style="padding:10px;text-align:center;border:1px solid #fed7aa">Unit</th><th style="padding:10px;text-align:center;border:1px solid #fed7aa">Status</th></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">MLSS</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + mlss + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">DO</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + doVal + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">pH</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + ph + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">-</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">‚úì</td></tr>';
  html += '</table>';

  html += '<h3 style="color:#10b981;border-bottom:2px solid #10b981;padding-bottom:5px">Effluent Quality</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#d1fae5"><th style="padding:10px;text-align:left;border:1px solid #a7f3d0">Parameter</th><th style="padding:10px;text-align:center;border:1px solid #a7f3d0">Value</th><th style="padding:10px;text-align:center;border:1px solid #a7f3d0">Unit</th><th style="padding:10px;text-align:center;border:1px solid #a7f3d0">Status</th></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Effluent BOD</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + effBod + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;color:#10b981">‚úì Pass</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Effluent TSS</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + effTss + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;color:#10b981">‚úì Pass</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Effluent NH‚ÇÉ-N</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + effNh3 + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">mg/L</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;color:#10b981">‚úì Pass</td></tr>';
  html += '</table>';

  return html;
}

// Process Summary Content
function generateProcessContent() {
  var dt = document.getElementById('dt_result')?.textContent || '-';
  var sor = document.getElementById('sor_result')?.textContent || '-';
  var weir = document.getElementById('weir_result')?.textContent || '-';
  var o2 = document.getElementById('o2_result')?.textContent || '-';
  var srt = document.getElementById('srt_result')?.textContent || '-';
  var chemCost = document.getElementById('chem_daily')?.textContent || '-';

  var html = '<h3 style="color:#6366f1;border-bottom:2px solid #6366f1;padding-bottom:5px">Process Calculations Summary</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#e0e7ff"><th style="padding:10px;text-align:left;border:1px solid #c7d2fe">Parameter</th><th style="padding:10px;text-align:center;border:1px solid #c7d2fe">Calculated Value</th><th style="padding:10px;text-align:center;border:1px solid #c7d2fe">Unit</th><th style="padding:10px;text-align:center;border:1px solid #c7d2fe">Target Range</th></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Detention Time</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + dt + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">hours</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">4-8 hrs</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Surface Overflow Rate</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + sor + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">GPD/ft¬≤</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">300-800</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Weir Loading</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + weir + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">GPD/ft</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">&lt;10,000</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Oxygen Required</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + o2 + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">lb/day</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">-</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">SRT (Sludge Age)</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + srt + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">days</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">5-15 days</td></tr>';
  html += '<tr><td style="padding:8px;border:1px solid #e5e7eb">Chemical Cost</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-weight:bold">' + chemCost + '</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">per day</td><td style="padding:8px;text-align:center;border:1px solid #e5e7eb">-</td></tr>';
  html += '</table>';

  return html;
}

// Client Visit Content
function generateVisitContent() {
  var purpose = document.getElementById('rpt_purpose')?.value || '';
  var time = document.getElementById('rpt_time')?.value || '';
  var findings = document.getElementById('rpt_findings')?.value || '';
  var recommendations = document.getElementById('rpt_recommendations')?.value || '';
  var actions = document.getElementById('rpt_actions')?.value || '';

  var html = '';

  html += '<div style="background:#f0f9ff;padding:15px;border-radius:8px;margin-bottom:15px">';
  html += '<p><strong>Visit Purpose:</strong> ' + purpose + '</p>';
  if (time) html += '<p><strong>Time On-Site:</strong> ' + time + '</p>';
  html += '</div>';

  if (findings) {
    html += '<h3 style="color:#dc2626;border-bottom:2px solid #dc2626;padding-bottom:5px">üîç Key Findings</h3>';
    html += '<div style="background:#fef2f2;padding:15px;border-radius:8px;margin-bottom:15px;white-space:pre-wrap">' + findings + '</div>';
  }

  if (recommendations) {
    html += '<h3 style="color:#059669;border-bottom:2px solid #059669;padding-bottom:5px">‚úÖ Recommendations</h3>';
    html += '<div style="background:#d1fae5;padding:15px;border-radius:8px;margin-bottom:15px;white-space:pre-wrap">' + recommendations + '</div>';
  }

  if (actions) {
    html += '<h3 style="color:#f97316;border-bottom:2px solid #f97316;padding-bottom:5px">üìã Action Items</h3>';
    html += '<div style="background:#ffedd5;padding:15px;border-radius:8px;margin-bottom:15px;white-space:pre-wrap">' + actions + '</div>';
  }

  return html;
}

// Calculation Report Content
function generateCalcContent() {
  var html = '<h3 style="color:#0ea5e9;border-bottom:2px solid #0ea5e9;padding-bottom:5px">üßÆ Complete Calculation Report</h3>';

  // Get all enhanced calculator values
  var calcs = [
    { name: 'Detention Time', value: document.getElementById('dt_result')?.textContent || '-', unit: 'hours', formula: 'HRT = (Volume √ó 24) / Flow' },
    { name: 'Surface Overflow Rate', value: document.getElementById('sor_result')?.textContent || '-', unit: 'GPD/ft¬≤', formula: 'SOR = Flow / Surface Area' },
    { name: 'Weir Loading', value: document.getElementById('weir_result')?.textContent || '-', unit: 'GPD/ft', formula: 'WLR = Flow / Weir Length' },
    { name: 'Oxygen Requirement', value: document.getElementById('o2_result')?.textContent || '-', unit: 'lb O‚ÇÇ/day', formula: 'O‚ÇÇ = 1.5√óBOD + 4.6√óTKN' },
    { name: 'Chemical Cost', value: document.getElementById('chem_daily')?.textContent || '-', unit: 'per day', formula: 'Cost = Flow √ó Dose √ó 8.34 √ó Unit Cost' },
    { name: 'SRT (Sludge Age)', value: document.getElementById('srt_result')?.textContent || '-', unit: 'days', formula: 'SRT = MLSS Inventory / WAS Solids' }
  ];

  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#e0f2fe"><th style="padding:10px;text-align:left;border:1px solid #bae6fd">Calculation</th><th style="padding:10px;text-align:center;border:1px solid #bae6fd">Result</th><th style="padding:10px;text-align:center;border:1px solid #bae6fd">Unit</th><th style="padding:10px;text-align:left;border:1px solid #bae6fd">Formula</th></tr>';

  calcs.forEach(function(calc) {
    html += '<tr>';
    html += '<td style="padding:8px;border:1px solid #e5e7eb;font-weight:bold">' + calc.name + '</td>';
    html += '<td style="padding:8px;text-align:center;border:1px solid #e5e7eb;font-size:16px;font-weight:bold;color:#0ea5e9">' + calc.value + '</td>';
    html += '<td style="padding:8px;text-align:center;border:1px solid #e5e7eb">' + calc.unit + '</td>';
    html += '<td style="padding:8px;border:1px solid #e5e7eb;font-family:monospace;font-size:12px;color:#6b7280">' + calc.formula + '</td>';
    html += '</tr>';
  });

  html += '</table>';

  return html;
}

// Format date
function formatDate(dateStr) {
  if (!dateStr) return '-';
  var d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
}

// Generate PDF
function generatePDFReport() {
  if (!selectedReportType) {
    showToast('Please select a report type first', 'error');
    return;
  }

  var html = generateReportHTML(selectedReportType);

  var printWindow = window.open('', '_blank');
  printWindow.document.write('<!DOCTYPE html><html><head><title>WWTP Report</title>');
  printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:0 auto;color:#1e3a5f}table{width:100%}@media print{body{padding:20px}}</style>');
  printWindow.document.write('</head><body>');
  printWindow.document.write(html);
  printWindow.document.write('</body></html>');
  printWindow.document.close();

  setTimeout(function() {
    printWindow.print();
  }, 500);

  showToast('üìÑ Report generated - use Print > Save as PDF', 'success');
}

// Print report
function printReport() {
  if (!selectedReportType) {
    showToast('Please select a report type first', 'error');
    return;
  }
  generatePDFReport();
}

// Export all calculations to CSV
function exportAllCalculations() {
  var csv = 'Parameter,Value,Unit\n';
  csv += 'Flow Rate,' + (document.getElementById('masterFlowPC')?.value || '-') + ',MGD\n';
  csv += 'Aeration Volume,' + (document.getElementById('masterAerVolPC')?.value || '-') + ',MG\n';
  csv += 'BOD,' + (document.getElementById('masterBODPC')?.value || '-') + ',mg/L\n';
  csv += 'MLSS,' + (document.getElementById('masterMLSSPC')?.value || '-') + ',mg/L\n';
  csv += 'Detention Time,' + (document.getElementById('dt_result')?.textContent || '-') + ',hours\n';
  csv += 'Surface Overflow Rate,' + (document.getElementById('sor_result')?.textContent || '-') + ',GPD/ft¬≤\n';
  csv += 'Weir Loading,' + (document.getElementById('weir_result')?.textContent || '-') + ',GPD/ft\n';
  csv += 'Oxygen Required,' + (document.getElementById('o2_result')?.textContent || '-') + ',lb/day\n';
  csv += 'SRT,' + (document.getElementById('srt_result')?.textContent || '-') + ',days\n';

  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_calculations_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);

  showToast('üìä Calculations exported to CSV', 'success');
}

// Export daily log
function exportDailyLog() {
  var date = new Date().toISOString().split('T')[0];
  var csv = 'Date,Flow (MGD),BOD (mg/L),TSS (mg/L),MLSS (mg/L),DO (mg/L),pH,Eff BOD,Eff TSS,Eff NH3\n';
  csv += date + ',';
  csv += (document.getElementById('rpt_flow')?.value || '-') + ',';
  csv += (document.getElementById('rpt_bod')?.value || '-') + ',';
  csv += (document.getElementById('rpt_tss')?.value || '-') + ',';
  csv += (document.getElementById('rpt_mlss')?.value || '-') + ',';
  csv += (document.getElementById('rpt_do')?.value || '-') + ',';
  csv += (document.getElementById('rpt_ph')?.value || '-') + ',';
  csv += (document.getElementById('rpt_eff_bod')?.value || '-') + ',';
  csv += (document.getElementById('rpt_eff_tss')?.value || '-') + ',';
  csv += (document.getElementById('rpt_eff_nh3')?.value || '-') + '\n';

  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_daily_log_' + date + '.csv';
  a.click();
  URL.revokeObjectURL(url);

  showToast('üìÖ Daily log exported', 'success');
}

// ========== END PDF REPORT GENERATOR SYSTEM ==========
// ========== ALARM/ALERT SYSTEM ==========

var alertSettings = {
  bod_max: 30,
  tss_max: 30,
  nh3_max: 5,
  mlss_min: 1500,
  mlss_max: 4500,
  do_min: 1.0,
  svi_max: 150,
  flow_max: 10,
  ph_min: 6.0,
  ph_max: 9.0
};

var alertHistory = [];

// Initialize alert system
function initAlertSystem() {
  loadAlertSettings();
  loadAlertHistory();
  checkAlerts();
}

// Toggle alert settings panel
function toggleAlertSettings() {
  var panel = document.getElementById('alertSettings');
  var history = document.getElementById('alertHistory');
  if (panel) {
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    if (history) history.style.display = 'none';
  }
}

// View alert history
function viewAlertHistory() {
  var panel = document.getElementById('alertHistory');
  var settings = document.getElementById('alertSettings');
  if (panel) {
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    if (settings) settings.style.display = 'none';
  }
  renderAlertHistory();
}

// Save alert settings
function saveAlertSettings() {
  alertSettings = {
    bod_max: parseFloat(document.getElementById('alert_bod_max')?.value) || 30,
    tss_max: parseFloat(document.getElementById('alert_tss_max')?.value) || 30,
    nh3_max: parseFloat(document.getElementById('alert_nh3_max')?.value) || 5,
    mlss_min: parseFloat(document.getElementById('alert_mlss_min')?.value) || 1500,
    mlss_max: parseFloat(document.getElementById('alert_mlss_max')?.value) || 4500,
    do_min: parseFloat(document.getElementById('alert_do_min')?.value) || 1.0,
    svi_max: parseFloat(document.getElementById('alert_svi_max')?.value) || 150,
    flow_max: parseFloat(document.getElementById('alert_flow_max')?.value) || 10,
    ph_min: parseFloat(document.getElementById('alert_ph_min')?.value) || 6.0,
    ph_max: parseFloat(document.getElementById('alert_ph_max')?.value) || 9.0
  };
  localStorage.setItem('wwtp_alert_settings', JSON.stringify(alertSettings));
  showToast('‚úÖ Alert settings saved', 'success');
  checkAlerts();
}

// Load alert settings
function loadAlertSettings() {
  try {
    var saved = JSON.parse(localStorage.getItem('wwtp_alert_settings'));
    if (saved) {
      alertSettings = saved;
      // Populate form
      if (document.getElementById('alert_bod_max')) document.getElementById('alert_bod_max').value = alertSettings.bod_max;
      if (document.getElementById('alert_tss_max')) document.getElementById('alert_tss_max').value = alertSettings.tss_max;
      if (document.getElementById('alert_nh3_max')) document.getElementById('alert_nh3_max').value = alertSettings.nh3_max;
      if (document.getElementById('alert_mlss_min')) document.getElementById('alert_mlss_min').value = alertSettings.mlss_min;
      if (document.getElementById('alert_mlss_max')) document.getElementById('alert_mlss_max').value = alertSettings.mlss_max;
      if (document.getElementById('alert_do_min')) document.getElementById('alert_do_min').value = alertSettings.do_min;
      if (document.getElementById('alert_svi_max')) document.getElementById('alert_svi_max').value = alertSettings.svi_max;
      if (document.getElementById('alert_flow_max')) document.getElementById('alert_flow_max').value = alertSettings.flow_max;
      if (document.getElementById('alert_ph_min')) document.getElementById('alert_ph_min').value = alertSettings.ph_min;
      if (document.getElementById('alert_ph_max')) document.getElementById('alert_ph_max').value = alertSettings.ph_max;
    }
  } catch(e) {
  }
}

// Load default alerts
function loadDefaultAlerts() {
  alertSettings = {
    bod_max: 30, tss_max: 30, nh3_max: 5,
    mlss_min: 1500, mlss_max: 4500, do_min: 1.0,
    svi_max: 150, flow_max: 10, ph_min: 6.0, ph_max: 9.0
  };
  saveAlertSettings();
  showToast('üîÑ Reset to default thresholds', 'info');
}

// Check all alerts
function checkAlerts() {
  var alerts = [];
  var activeAlertsDiv = document.getElementById('activeAlerts');
  var noAlertsMsg = document.getElementById('noAlertsMsg');

  // Get current values (from various sources)
  var currentBOD = parseFloat(document.getElementById('rpt_eff_bod')?.value) || parseFloat(document.getElementById('kpi-bod')?.textContent) || 0;
  var currentTSS = parseFloat(document.getElementById('rpt_eff_tss')?.value) || 0;
  var currentNH3 = parseFloat(document.getElementById('rpt_eff_nh3')?.value) || 0;
  var currentMLSS = parseFloat(document.getElementById('masterMLSSPC')?.value) || parseFloat(document.getElementById('kpi-mlss')?.textContent) || 3000;
  var currentDO = parseFloat(document.getElementById('rpt_do')?.value) || 2.0;
  var currentPH = parseFloat(document.getElementById('rpt_ph')?.value) || 7.2;
  var currentFlow = parseFloat(document.getElementById('masterFlowPC')?.value) || parseFloat(document.getElementById('kpi-flow')?.textContent) || 3.5;

  // Check each parameter
  if (currentBOD > alertSettings.bod_max) {
    alerts.push({ param: 'BOD', value: currentBOD, limit: alertSettings.bod_max, type: 'high' });
    updateIndicator('ind_bod', 'alert', currentBOD);
  } else {
    updateIndicator('ind_bod', 'ok');
  }

  if (currentTSS > alertSettings.tss_max) {
    alerts.push({ param: 'TSS', value: currentTSS, limit: alertSettings.tss_max, type: 'high' });
    updateIndicator('ind_tss', 'alert', currentTSS);
  } else {
    updateIndicator('ind_tss', 'ok');
  }

  if (currentNH3 > alertSettings.nh3_max) {
    alerts.push({ param: 'NH‚ÇÉ', value: currentNH3, limit: alertSettings.nh3_max, type: 'high' });
    updateIndicator('ind_nh3', 'alert', currentNH3);
  } else {
    updateIndicator('ind_nh3', 'ok');
  }

  if (currentDO < alertSettings.do_min) {
    alerts.push({ param: 'DO', value: currentDO, limit: alertSettings.do_min, type: 'low' });
    updateIndicator('ind_do', 'warning', currentDO);
  } else {
    updateIndicator('ind_do', 'ok');
  }

  if (currentMLSS < alertSettings.mlss_min || currentMLSS > alertSettings.mlss_max) {
    alerts.push({ param: 'MLSS', value: currentMLSS, limit: currentMLSS < alertSettings.mlss_min ? alertSettings.mlss_min : alertSettings.mlss_max, type: currentMLSS < alertSettings.mlss_min ? 'low' : 'high' });
    updateIndicator('ind_mlss', 'warning', currentMLSS);
  } else {
    updateIndicator('ind_mlss', 'ok');
  }

  if (currentPH < alertSettings.ph_min || currentPH > alertSettings.ph_max) {
    alerts.push({ param: 'pH', value: currentPH, limit: currentPH < alertSettings.ph_min ? alertSettings.ph_min : alertSettings.ph_max, type: currentPH < alertSettings.ph_min ? 'low' : 'high' });
    updateIndicator('ind_ph', 'warning', currentPH);
  } else {
    updateIndicator('ind_ph', 'ok');
  }

  // Display alerts
  if (activeAlertsDiv) {
    if (alerts.length === 0) {
      activeAlertsDiv.innerHTML = '<div class="note success"><strong>‚úì All Systems Normal</strong><br>No active alerts. All parameters within limits.</div>';
    } else {
      var html = '';
      alerts.forEach(function(alert) {
        var color = alert.type === 'high' ? '#ef4444' : '#fbbf24';
        html += '<div class="note" style="background:rgba(' + (alert.type === 'high' ? '239,68,68' : '251,191,36') + ',0.2);border-left-color:' + color + ';margin-bottom:10px">';
        html += '<strong style="color:' + color + '">‚ö†Ô∏è ' + alert.param + ' ' + alert.type.toUpperCase() + '</strong><br>';
        html += 'Current: <strong>' + alert.value + '</strong> | Limit: ' + alert.limit;
        html += '</div>';

        // Log to history
        logAlert(alert);
      });
      activeAlertsDiv.innerHTML = html;
    }
  }

  return alerts;
}

// Update indicator
function updateIndicator(id, status, value) {
  var el = document.getElementById(id);
  if (!el) return;

  var colors = {
    ok: { border: '#4ade80', text: '#4ade80', label: '‚úì OK' },
    warning: { border: '#fbbf24', text: '#fbbf24', label: '‚ö†Ô∏è' },
    alert: { border: '#ef4444', text: '#ef4444', label: '‚ö†Ô∏è' }
  };

  var c = colors[status] || colors.ok;
  el.style.borderLeftColor = c.border;
  var valueDiv = el.querySelector('div:last-child');
  if (valueDiv) {
    valueDiv.style.color = c.text;
    valueDiv.textContent = value !== undefined ? value : c.label;
  }
}

// Log alert to history
function logAlert(alert) {
  var entry = {
    timestamp: new Date().toISOString(),
    param: alert.param,
    value: alert.value,
    limit: alert.limit,
    type: alert.type
  };

  alertHistory.unshift(entry);
  if (alertHistory.length > 100) alertHistory.pop();

  localStorage.setItem('wwtp_alert_history', JSON.stringify(alertHistory));
}

// Load alert history
function loadAlertHistory() {
  try {
    var saved = JSON.parse(localStorage.getItem('wwtp_alert_history'));
    if (saved) alertHistory = saved;
  } catch(e) {
    alertHistory = [];
  }
}

// Render alert history
function renderAlertHistory() {
  var list = document.getElementById('alertHistoryList');
  if (!list) return;

  if (alertHistory.length === 0) {
    list.innerHTML = '<div style="padding:15px;text-align:center;opacity:0.7">No alerts recorded</div>';
    return;
  }

  var html = '';
  alertHistory.slice(0, 20).forEach(function(entry) {
    var color = entry.type === 'high' ? '#ef4444' : '#fbbf24';
    var date = new Date(entry.timestamp);
    var timeStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();

    html += '<div style="padding:10px;border-bottom:1px solid #374151;display:flex;justify-content:space-between">';
    html += '<span><span style="color:' + color + '">‚óè</span> ' + entry.param + ' ' + entry.type + ': ' + entry.value + ' (limit: ' + entry.limit + ')</span>';
    html += '<span style="opacity:0.7;font-size:12px">' + timeStr + '</span>';
    html += '</div>';
  });

  list.innerHTML = html;
}

// Clear alert history
function clearAlertHistory() {
  alertHistory = [];
  localStorage.removeItem('wwtp_alert_history');
  renderAlertHistory();
  showToast('üóëÔ∏è Alert history cleared', 'info');
}

// Export alert history
function exportAlertHistory() {
  if (alertHistory.length === 0) {
    showToast('No alerts to export', 'warning');
    return;
  }

  var csv = 'Timestamp,Parameter,Value,Limit,Type\n';
  alertHistory.forEach(function(entry) {
    csv += entry.timestamp + ',' + entry.param + ',' + entry.value + ',' + entry.limit + ',' + entry.type + '\n';
  });

  var blob = new Blob([csv], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_alert_history_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);

  showToast('üì§ Alert history exported', 'success');
}

// Test alert
function testAlert() {
  var testAlert = { param: 'TEST', value: 999, limit: 100, type: 'high' };
  logAlert(testAlert);

  // Visual feedback
  showToast('üîî Test alert triggered!', 'warning');

  // Play sound if available
  try {
    var audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleA8LQ4zS5bWNNgMJPX3M3LueLgADL2a00NqsOAABHU+Yx9y4TgAADzZ7q8fRogwAAAsgVJC70eMAAAAACBo9bKG+zgAAAAMAAAUVLFd9pcYA');
    audio.volume = 0.3;
    audio.play();
  } catch(e) {}

  renderAlertHistory();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initAlertSystem, 1000);
});

// ========== END ALARM/ALERT SYSTEM ==========
// ========== REACTOR MASTER SETTINGS ==========

var currentReactorTab = 'sbr';

// Show reactor master tab
function showReactorMasterTab(tab) {
  currentReactorTab = tab;

  // Hide all master sections
  ['sbr', 'mbr', 'mbbr'].forEach(function(t) {
    var el = document.getElementById('reactorMaster_' + t);
    var btn = document.getElementById('rmTab_' + t);
    if (el) el.style.display = 'none';
    if (btn) {
      btn.classList.remove('gradient');
      btn.classList.add('gray');
    }
  });

  // Show selected
  var selected = document.getElementById('reactorMaster_' + tab);
  var selectedBtn = document.getElementById('rmTab_' + tab);
  if (selected) selected.style.display = 'block';
  if (selectedBtn) {
    selectedBtn.classList.remove('gray');
    selectedBtn.classList.add('gradient');
  }
}

// Sync reactor master values to calculators
function syncReactorMaster() {
  // SBR Sync
  syncField('rm_sbr_flow', ['sbr_flow', 'sbr_aer_flow']);
  syncField('rm_sbr_basins', ['sbr_basins']);
  syncField('rm_sbr_vol', ['sbr_vol']);
  syncField('rm_sbr_fill', ['sbr_fill']);
  syncField('rm_sbr_react', ['sbr_react']);
  syncField('rm_sbr_settle', ['sbr_settle']);
  syncField('rm_sbr_decant', ['sbr_decant']);
  syncField('rm_sbr_idle', ['sbr_idle']);
  syncField('rm_sbr_bod', ['sbr_bod_in']);
  syncField('rm_sbr_tkn', ['sbr_tkn']);
  syncField('rm_sbr_eff_bod', ['sbr_bod_out']);
  syncField('rm_sbr_eff_nh3', ['sbr_nh3_out']);

  // MBR Sync
  syncField('rm_mbr_flow', ['mbr_flow', 'mbr_aer_flow']);
  syncField('rm_mbr_trains', ['mbr_trains']);
  syncField('rm_mbr_area', ['mbr_area']);
  syncField('rm_mbr_flux', ['mbr_flux']);
  syncField('rm_mbr_tmp', ['mbr_tmp_max']);
  syncField('rm_mbr_mlss', ['mbr_mlss']);
  syncField('rm_mbr_bw_freq', ['mbr_bw_freq']);
  syncField('rm_mbr_bw_dur', ['mbr_bw_dur']);
  syncField('rm_mbr_bod', ['mbr_bod_in']);
  syncField('rm_mbr_vol', ['mbr_vol']);
  syncField('rm_mbr_srt', ['mbr_srt']);

  // MBBR Sync
  syncField('rm_mbbr_flow', ['mbbr_flow', 'mbbr_aer_flow']);
  syncField('rm_mbbr_vol', ['mbbr_vol']);
  syncField('rm_mbbr_stages', ['mbbr_stages']);
  syncField('rm_mbbr_fill', ['mbbr_fill_pct']);
  syncField('rm_mbbr_ssa', ['mbbr_ssa']);
  syncField('rm_mbbr_protected', ['mbbr_protected']);
  syncField('rm_mbbr_bod', ['mbbr_bod_in']);
  syncField('rm_mbbr_bod_rate', ['mbbr_bod_rate']);
  syncField('rm_mbbr_nh3_rate', ['mbbr_nh3_rate']);
  syncField('rm_mbbr_do', ['mbbr_do']);
  syncField('rm_mbbr_temp', ['mbbr_temp']);
  syncField('rm_mbbr_eff_bod', ['mbbr_bod_out']);

  showToast('üîÑ Reactor values synced!', 'success');
}

// Helper function to sync a master field to target fields
function syncField(sourceId, targetIds) {
  var source = document.getElementById(sourceId);
  if (!source) return;

  var value = source.value;
  targetIds.forEach(function(targetId) {
    var target = document.getElementById(targetId);
    if (target) target.value = value;
  });
}

// Save reactor settings to localStorage
function saveReactorSettings() {
  var settings = {
    sbr: {
      flow: document.getElementById('rm_sbr_flow')?.value || '2.0',
      basins: document.getElementById('rm_sbr_basins')?.value || '2',
      vol: document.getElementById('rm_sbr_vol')?.value || '0.5',
      fill: document.getElementById('rm_sbr_fill')?.value || '60',
      react: document.getElementById('rm_sbr_react')?.value || '120',
      settle: document.getElementById('rm_sbr_settle')?.value || '60',
      decant: document.getElementById('rm_sbr_decant')?.value || '30',
      idle: document.getElementById('rm_sbr_idle')?.value || '30',
      bod: document.getElementById('rm_sbr_bod')?.value || '200',
      tkn: document.getElementById('rm_sbr_tkn')?.value || '40',
      eff_bod: document.getElementById('rm_sbr_eff_bod')?.value || '10',
      eff_nh3: document.getElementById('rm_sbr_eff_nh3')?.value || '1'
    },
    mbr: {
      flow: document.getElementById('rm_mbr_flow')?.value || '1.5',
      trains: document.getElementById('rm_mbr_trains')?.value || '2',
      area: document.getElementById('rm_mbr_area')?.value || '50000',
      flux: document.getElementById('rm_mbr_flux')?.value || '12',
      tmp: document.getElementById('rm_mbr_tmp')?.value || '8',
      mlss: document.getElementById('rm_mbr_mlss')?.value || '10000',
      bw_freq: document.getElementById('rm_mbr_bw_freq')?.value || '10',
      bw_dur: document.getElementById('rm_mbr_bw_dur')?.value || '30',
      cip: document.getElementById('rm_mbr_cip')?.value || '30',
      bod: document.getElementById('rm_mbr_bod')?.value || '200',
      vol: document.getElementById('rm_mbr_vol')?.value || '0.8',
      srt: document.getElementById('rm_mbr_srt')?.value || '15'
    },
    mbbr: {
      flow: document.getElementById('rm_mbbr_flow')?.value || '2.0',
      vol: document.getElementById('rm_mbbr_vol')?.value || '0.6',
      stages: document.getElementById('rm_mbbr_stages')?.value || '2',
      fill: document.getElementById('rm_mbbr_fill')?.value || '50',
      ssa: document.getElementById('rm_mbbr_ssa')?.value || '500',
      protected: document.getElementById('rm_mbbr_protected')?.value || '67',
      bod: document.getElementById('rm_mbbr_bod')?.value || '200',
      bod_rate: document.getElementById('rm_mbbr_bod_rate')?.value || '10',
      nh3_rate: document.getElementById('rm_mbbr_nh3_rate')?.value || '1.5',
      do: document.getElementById('rm_mbbr_do')?.value || '4.0',
      temp: document.getElementById('rm_mbbr_temp')?.value || '20',
      eff_bod: document.getElementById('rm_mbbr_eff_bod')?.value || '10'
    }
  };

  localStorage.setItem('wwtp_reactor_master', JSON.stringify(settings));
  showToast('üíæ Reactor settings saved!', 'success');
}

// Load reactor settings from localStorage
function loadReactorSettings() {
  try {
    var saved = JSON.parse(localStorage.getItem('wwtp_reactor_master'));
    if (!saved) {
      showToast('No saved reactor settings found', 'info');
      return;
    }

    // Load SBR
    if (saved.sbr) {
      setIfExists('rm_sbr_flow', saved.sbr.flow);
      setIfExists('rm_sbr_basins', saved.sbr.basins);
      setIfExists('rm_sbr_vol', saved.sbr.vol);
      setIfExists('rm_sbr_fill', saved.sbr.fill);
      setIfExists('rm_sbr_react', saved.sbr.react);
      setIfExists('rm_sbr_settle', saved.sbr.settle);
      setIfExists('rm_sbr_decant', saved.sbr.decant);
      setIfExists('rm_sbr_idle', saved.sbr.idle);
      setIfExists('rm_sbr_bod', saved.sbr.bod);
      setIfExists('rm_sbr_tkn', saved.sbr.tkn);
      setIfExists('rm_sbr_eff_bod', saved.sbr.eff_bod);
      setIfExists('rm_sbr_eff_nh3', saved.sbr.eff_nh3);
    }

    // Load MBR
    if (saved.mbr) {
      setIfExists('rm_mbr_flow', saved.mbr.flow);
      setIfExists('rm_mbr_trains', saved.mbr.trains);
      setIfExists('rm_mbr_area', saved.mbr.area);
      setIfExists('rm_mbr_flux', saved.mbr.flux);
      setIfExists('rm_mbr_tmp', saved.mbr.tmp);
      setIfExists('rm_mbr_mlss', saved.mbr.mlss);
      setIfExists('rm_mbr_bw_freq', saved.mbr.bw_freq);
      setIfExists('rm_mbr_bw_dur', saved.mbr.bw_dur);
      setIfExists('rm_mbr_cip', saved.mbr.cip);
      setIfExists('rm_mbr_bod', saved.mbr.bod);
      setIfExists('rm_mbr_vol', saved.mbr.vol);
      setIfExists('rm_mbr_srt', saved.mbr.srt);
    }

    // Load MBBR
    if (saved.mbbr) {
      setIfExists('rm_mbbr_flow', saved.mbbr.flow);
      setIfExists('rm_mbbr_vol', saved.mbbr.vol);
      setIfExists('rm_mbbr_stages', saved.mbbr.stages);
      setIfExists('rm_mbbr_fill', saved.mbbr.fill);
      setIfExists('rm_mbbr_ssa', saved.mbbr.ssa);
      setIfExists('rm_mbbr_protected', saved.mbbr.protected);
      setIfExists('rm_mbbr_bod', saved.mbbr.bod);
      setIfExists('rm_mbbr_bod_rate', saved.mbbr.bod_rate);
      setIfExists('rm_mbbr_nh3_rate', saved.mbbr.nh3_rate);
      setIfExists('rm_mbbr_do', saved.mbbr.do);
      setIfExists('rm_mbbr_temp', saved.mbbr.temp);
      setIfExists('rm_mbbr_eff_bod', saved.mbbr.eff_bod);
    }

    showToast('üìÇ Reactor settings loaded!', 'success');
    syncReactorMaster();

  } catch(e) {
    showToast('Error loading reactor settings', 'error');
  }
}

// Helper to set value if element exists
function setIfExists(id, value) {
  var el = document.getElementById(id);
  if (el && value !== undefined) el.value = value;
}

// Initialize reactor settings on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(function() {
    loadReactorSettings();
  }, 1500);
});

// ========== END REACTOR MASTER SETTINGS ==========
// ========== ADVANCED WAS CALCULATOR ==========

var currentWASMethod = 'srt';

// Show WAS calculation method
function showWASMethod(method) {
  currentWASMethod = method;

  // Hide all methods
  ['srt', 'mcrt', 'fm', 'mlss'].forEach(function(m) {
    var el = document.getElementById('wasMethod_' + m);
    var btn = document.getElementById('wasTab_' + m);
    if (el) el.style.display = 'none';
    if (btn) {
      btn.classList.remove('gradient');
      btn.classList.add('gray');
    }
  });

  // Show selected
  var selected = document.getElementById('wasMethod_' + method);
  var selectedBtn = document.getElementById('wasTab_' + method);
  if (selected) selected.style.display = 'block';
  if (selectedBtn) {
    selectedBtn.classList.remove('gray');
    selectedBtn.classList.add('gradient');
  }

  // Clear results
  document.getElementById('was2_results').innerHTML = '';
}

// Calculate Advanced WAS
function calcAdvancedWAS() {
  var results = {};

  switch(currentWASMethod) {
    case 'srt':
      results = calcWAS_SRT();
      break;
    case 'mcrt':
      results = calcWAS_MCRT();
      break;
    case 'fm':
      results = calcWAS_FM();
      break;
    case 'mlss':
      results = calcWAS_MLSS();
      break;
  }

  displayWASResults(results);
}

// Method 1: SRT Control
function calcWAS_SRT() {
  var vol = parseFloat(document.getElementById('was2_srt_vol').value) || 1.5;
  var mlss = parseFloat(document.getElementById('was2_srt_mlss').value) || 3000;
  var targetSRT = parseFloat(document.getElementById('was2_srt_target').value) || 10;
  var clarVol = parseFloat(document.getElementById('was2_srt_clarvol').value) || 0.3;
  var blanket = parseFloat(document.getElementById('was2_srt_blanket').value) || 2;
  var rasConc = parseFloat(document.getElementById('was2_srt_ras').value) || 8000;
  var effTSS = parseFloat(document.getElementById('was2_srt_efftss').value) || 10;
  var effQ = parseFloat(document.getElementById('was2_srt_effq').value) || 5.0;
  var wasConc = parseFloat(document.getElementById('was2_srt_wasconc').value) || 8000;

  // Calculate solids inventory
  var aerationInv = vol * mlss * 8.34; // lb in aeration basin
  var clarArea = clarVol * 1000000 / 7.48 / blanket; // approximate
  var clarInv = clarVol * 0.5 * rasConc * 8.34; // lb in clarifier (estimate)
  var totalInv = aerationInv + clarInv;

  // Effluent solids loss
  var effLoss = effQ * effTSS * 8.34; // lb/day

  // WAS needed
  var wasMass = (totalInv / targetSRT) - effLoss; // lb/day
  if (wasMass < 0) wasMass = 0;

  var wasGPD = (wasMass / wasConc / 8.34) * 1000000;
  var wasGPM = wasGPD / 1440;

  // Calculate actual SRT
  var actualSRT = totalInv / (wasMass + effLoss);

  return {
    method: 'SRT Control',
    aerationInv: aerationInv,
    clarInv: clarInv,
    totalInv: totalInv,
    effLoss: effLoss,
    wasMass: wasMass,
    wasGPD: wasGPD,
    wasGPM: wasGPM,
    targetSRT: targetSRT,
    actualSRT: actualSRT,
    wasConc: wasConc
  };
}

// Method 2: MCRT Control
function calcWAS_MCRT() {
  var vol = parseFloat(document.getElementById('was2_mcrt_vol').value) || 1.5;
  var mlss = parseFloat(document.getElementById('was2_mcrt_mlss').value) || 3000;
  var targetMCRT = parseFloat(document.getElementById('was2_mcrt_target').value) || 12;
  var effTSS = parseFloat(document.getElementById('was2_mcrt_efftss').value) || 10;
  var effQ = parseFloat(document.getElementById('was2_mcrt_effq').value) || 5.0;
  var wasConc = parseFloat(document.getElementById('was2_mcrt_wasconc').value) || 8000;

  // Solids inventory (aeration only for MCRT)
  var inventory = vol * mlss * 8.34;

  // Effluent loss
  var effLoss = effQ * effTSS * 8.34;

  // MCRT formula: MCRT = Inventory / (WAS + Effluent loss)
  // WAS = (Inventory / MCRT) - Effluent loss
  var wasMass = (inventory / targetMCRT) - effLoss;
  if (wasMass < 0) wasMass = 0;

  var wasGPD = (wasMass / wasConc / 8.34) * 1000000;
  var wasGPM = wasGPD / 1440;

  var actualMCRT = inventory / (wasMass + effLoss);

  return {
    method: 'MCRT Control',
    aerationInv: inventory,
    totalInv: inventory,
    effLoss: effLoss,
    wasMass: wasMass,
    wasGPD: wasGPD,
    wasGPM: wasGPM,
    targetMCRT: targetMCRT,
    actualMCRT: actualMCRT,
    wasConc: wasConc
  };
}

// Method 3: F/M Control
function calcWAS_FM() {
  var flow = parseFloat(document.getElementById('was2_fm_flow').value) || 5.0;
  var bod = parseFloat(document.getElementById('was2_fm_bod').value) || 200;
  var targetFM = parseFloat(document.getElementById('was2_fm_target').value) || 0.3;
  var mlss = parseFloat(document.getElementById('was2_fm_mlss').value) || 3000;
  var vssRatio = parseFloat(document.getElementById('was2_fm_vss').value) || 0.80;
  var vol = parseFloat(document.getElementById('was2_fm_vol').value) || 1.5;
  var yieldCoef = parseFloat(document.getElementById('was2_fm_yield').value) || 0.6;
  var wasConc = parseFloat(document.getElementById('was2_fm_wasconc').value) || 8000;
  var kd = parseFloat(document.getElementById('was2_fm_kd').value) || 0.06;

  // BOD load
  var bodLoad = flow * bod * 8.34; // lb BOD/day

  // Current biomass
  var mlvss = mlss * vssRatio;
  var biomass = vol * mlvss * 8.34; // lb MLVSS

  // Current F/M
  var currentFM = bodLoad / biomass;

  // Target biomass for desired F/M
  var targetBiomass = bodLoad / targetFM;
  var targetMLVSS = targetBiomass / (vol * 8.34);
  var targetMLSS = targetMLVSS / vssRatio;

  // Daily growth
  var growth = bodLoad * yieldCoef; // lb TSS/day
  var decay = biomass * kd; // lb/day
  var netGrowth = growth - decay;

  // WAS to maintain current MLSS
  var wasMass = netGrowth;

  // If MLSS too high, need extra wasting
  if (mlss > targetMLSS) {
    var excessSolids = (mlss - targetMLSS) * vol * 8.34 / 3; // remove over 3 days
    wasMass += excessSolids;
  }

  var wasGPD = (wasMass / wasConc / 8.34) * 1000000;
  var wasGPM = wasGPD / 1440;

  return {
    method: 'F/M Control',
    bodLoad: bodLoad,
    currentFM: currentFM,
    targetFM: targetFM,
    currentMLSS: mlss,
    targetMLSS: targetMLSS,
    growth: growth,
    decay: decay,
    netGrowth: netGrowth,
    wasMass: wasMass,
    wasGPD: wasGPD,
    wasGPM: wasGPM,
    wasConc: wasConc
  };
}

// Method 4: MLSS Control
function calcWAS_MLSS() {
  var flow = parseFloat(document.getElementById('was2_mlss_flow').value) || 5.0;
  var bod = parseFloat(document.getElementById('was2_mlss_bod').value) || 200;
  var yieldCoef = parseFloat(document.getElementById('was2_mlss_yield').value) || 0.6;
  var targetMLSS = parseFloat(document.getElementById('was2_mlss_target').value) || 3000;
  var currentMLSS = parseFloat(document.getElementById('was2_mlss_current').value) || 3200;
  var vol = parseFloat(document.getElementById('was2_mlss_vol').value) || 1.5;
  var daysToTarget = parseFloat(document.getElementById('was2_mlss_days').value) || 3;
  var wasConc = parseFloat(document.getElementById('was2_mlss_wasconc').value) || 8000;
  var kd = parseFloat(document.getElementById('was2_mlss_kd').value) || 0.06;

  // Daily growth
  var bodLoad = flow * bod * 8.34;
  var growth = bodLoad * yieldCoef;

  // Decay
  var inventory = vol * currentMLSS * 8.34;
  var decay = inventory * kd * 0.8; // Approximate VSS decay

  // Net growth
  var netGrowth = growth - decay;

  // Excess solids to remove
  var excessSolids = 0;
  if (currentMLSS > targetMLSS) {
    excessSolids = (currentMLSS - targetMLSS) * vol * 8.34 / daysToTarget;
  }

  // Total WAS
  var wasMass = netGrowth + excessSolids;
  if (wasMass < 0) wasMass = 0;

  var wasGPD = (wasMass / wasConc / 8.34) * 1000000;
  var wasGPM = wasGPD / 1440;

  // Projected MLSS
  var projectedMLSS = currentMLSS;
  if (wasMass > 0) {
    var netChange = (netGrowth - wasMass) / (vol * 8.34);
    projectedMLSS = currentMLSS + (netChange * daysToTarget);
  }

  return {
    method: 'MLSS Control',
    currentMLSS: currentMLSS,
    targetMLSS: targetMLSS,
    growth: growth,
    decay: decay,
    netGrowth: netGrowth,
    excessSolids: excessSolids,
    wasMass: wasMass,
    wasGPD: wasGPD,
    wasGPM: wasGPM,
    daysToTarget: daysToTarget,
    projectedMLSS: projectedMLSS,
    wasConc: wasConc
  };
}

// Display WAS Results
function displayWASResults(r) {
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #a855f7">';
  html += '<h4 style="margin:0 0 15px 0;color:#a855f7">üöø ' + r.method + ' Results</h4>';
  html += '<table class="table">';
  html += '<tbody>';

  if (r.aerationInv) html += '<tr><td>Aeration Basin Inventory</td><td><span class="result">' + r.aerationInv.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  if (r.clarInv) html += '<tr><td>Clarifier Inventory (est)</td><td><span class="result">' + r.clarInv.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  if (r.totalInv) html += '<tr><td>Total Solids Inventory</td><td><span class="result">' + r.totalInv.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  if (r.effLoss) html += '<tr><td>Effluent Solids Loss</td><td><span class="result">' + r.effLoss.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  if (r.bodLoad) html += '<tr><td>BOD Loading</td><td><span class="result">' + r.bodLoad.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  if (r.currentFM) html += '<tr><td>Current F/M</td><td><span class="result">' + r.currentFM.toFixed(3) + '</span></td><td>lb/lb/day</td></tr>';
  if (r.growth) html += '<tr><td>Daily Growth</td><td><span class="result">' + r.growth.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  if (r.decay) html += '<tr><td>Daily Decay</td><td><span class="result">' + r.decay.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  if (r.netGrowth) html += '<tr><td>Net Growth</td><td><span class="result">' + r.netGrowth.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a855f7">üíß WAS Rate</td></tr>';
  html += '<tr><td>WAS Mass Rate</td><td><span class="result" style="font-size:18px;color:#4ade80">' + r.wasMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>WAS Volume Rate</td><td><span class="result" style="font-size:18px;color:#4ade80">' + r.wasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>gpd</td></tr>';
  html += '<tr><td>WAS Flow Rate</td><td><span class="result" style="font-size:18px;color:#4ade80">' + r.wasGPM.toFixed(1) + '</span></td><td>gpm</td></tr>';

  if (r.actualSRT) html += '<tr><td>Calculated SRT</td><td><span class="result">' + r.actualSRT.toFixed(1) + '</span></td><td>days</td></tr>';
  if (r.actualMCRT) html += '<tr><td>Calculated MCRT</td><td><span class="result">' + r.actualMCRT.toFixed(1) + '</span></td><td>days</td></tr>';
  if (r.targetMLSS) html += '<tr><td>Target MLSS</td><td><span class="result">' + r.targetMLSS.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>mg/L</td></tr>';
  if (r.projectedMLSS) html += '<tr><td>Projected MLSS (in ' + r.daysToTarget + ' days)</td><td><span class="result">' + r.projectedMLSS.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>mg/L</td></tr>';

  html += '</tbody></table>';

  // Add recommendation
  html += '<div class="note success" style="margin-top:15px">';
  html += '<strong>üí° Recommendation:</strong> ';
  if (r.wasGPM < 5) {
    html += 'Low WAS rate. Consider wasting from RAS line for better control.';
  } else if (r.wasGPM > 50) {
    html += 'High WAS rate. Ensure adequate thickener/dewatering capacity.';
  } else {
    html += 'WAS rate is in normal range. Monitor SVI and settleability.';
  }
  html += '</div>';

  html += '</div>';

  document.getElementById('was2_results').innerHTML = html;
}

// Compare All WAS Methods
function compareWASMethods() {
  // Calculate all methods
  var srt = calcWAS_SRT();
  var mcrt = calcWAS_MCRT();
  var fm = calcWAS_FM();
  var mlss = calcWAS_MLSS();

  var html = '<div style="background:#243b55;padding:20px;border-radius:12px">';
  html += '<h4 style="margin:0 0 15px 0;color:#a855f7">üìä WAS Method Comparison</h4>';
  html += '<table class="table">';
  html += '<thead><tr><th>Method</th><th>WAS (lb/day)</th><th>WAS (gpd)</th><th>WAS (gpm)</th></tr></thead>';
  html += '<tbody>';
  html += '<tr><td>üìÖ SRT Control</td><td>' + srt.wasMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + srt.wasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + srt.wasGPM.toFixed(1) + '</td></tr>';
  html += '<tr><td>‚è±Ô∏è MCRT Control</td><td>' + mcrt.wasMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + mcrt.wasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + mcrt.wasGPM.toFixed(1) + '</td></tr>';
  html += '<tr><td>‚öñÔ∏è F/M Control</td><td>' + fm.wasMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + fm.wasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + fm.wasGPM.toFixed(1) + '</td></tr>';
  html += '<tr><td>üìä MLSS Control</td><td>' + mlss.wasMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + mlss.wasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</td><td>' + mlss.wasGPM.toFixed(1) + '</td></tr>';
  html += '</tbody></table>';

  // Average recommendation
  var avgWAS = (srt.wasGPM + mcrt.wasGPM + fm.wasGPM + mlss.wasGPM) / 4;
  html += '<div class="note info" style="margin-top:15px">';
  html += '<strong>üìà Average WAS Rate:</strong> ' + avgWAS.toFixed(1) + ' gpm (' + (avgWAS * 1440).toLocaleString(undefined, {maximumFractionDigits:0}) + ' gpd)';
  html += '<br><small>Use multiple methods and trend results to determine optimal WAS strategy for your plant.</small>';
  html += '</div>';

  html += '</div>';

  document.getElementById('was2_results').innerHTML = html;
}

// Reset Advanced WAS
function resetAdvancedWAS() {
  document.getElementById('was2_results').innerHTML = '';
  showToast('üîÑ WAS Calculator reset', 'info');
}

// ========== END ADVANCED WAS CALCULATOR ==========
// ========== RAS (RETURN ACTIVATED SLUDGE) CALCULATOR ==========

var currentRASMethod = 'ratio';

// Show RAS calculation method
function showRASMethod(method) {
  currentRASMethod = method;

  // Hide all methods
  ['ratio', 'mlss', 'blanket'].forEach(function(m) {
    var el = document.getElementById('rasMethod_' + m);
    var btn = document.getElementById('rasTab_' + m);
    if (el) el.style.display = 'none';
    if (btn) {
      btn.classList.remove('green', 'gradient');
      btn.classList.add('gray');
    }
  });

  // Show selected
  var selected = document.getElementById('rasMethod_' + method);
  var selectedBtn = document.getElementById('rasTab_' + method);
  if (selected) selected.style.display = 'block';
  if (selectedBtn) {
    selectedBtn.classList.remove('gray');
    selectedBtn.classList.add('green');
  }

  // Clear results
  document.getElementById('ras_results').innerHTML = '';
}

// Calculate RAS
function calcRAS() {
  var results = {};

  switch(currentRASMethod) {
    case 'ratio':
      results = calcRAS_Ratio();
      break;
    case 'mlss':
      results = calcRAS_MLSS();
      break;
    case 'blanket':
      results = calcRAS_Blanket();
      break;
  }

  displayRASResults(results);
}

// Method 1: RAS Ratio
function calcRAS_Ratio() {
  var flow = parseFloat(document.getElementById('ras_ratio_flow').value) || 5.0;
  var rasPct = parseFloat(document.getElementById('ras_ratio_pct').value) || 50;
  var mlss = parseFloat(document.getElementById('ras_ratio_mlss').value) || 3000;
  var rasConc = parseFloat(document.getElementById('ras_ratio_conc').value) || 8000;
  var numPumps = parseFloat(document.getElementById('ras_ratio_pumps').value) || 2;
  var pumpCap = parseFloat(document.getElementById('ras_ratio_pumpcap').value) || 1500;

  // Calculate RAS flow
  var rasFlow = flow * (rasPct / 100); // MGD
  var rasGPM = rasFlow * 1000000 / 1440;
  var rasGPD = rasFlow * 1000000;

  // Calculate mass loading
  var rasMassReturn = rasFlow * rasConc * 8.34; // lb/day returned
  var influentMass = flow * 200 * 8.34; // Assume 200 mg/L influent TSS

  // Check pump capacity
  var totalPumpCap = numPumps * pumpCap; // gpm
  var pumpUtilization = (rasGPM / totalPumpCap) * 100;

  // Calculate theoretical MLSS from mass balance
  // MLSS = (Q_inf * TSS_inf + Q_ras * RAS_conc) / (Q_inf + Q_ras) - simplified
  var theoreticalMLSS = (rasConc * rasPct/100) / (1 + rasPct/100);

  // RAS/MLSS ratio
  var rasMLSSRatio = rasConc / mlss;

  // Settling characteristics
  var settlingStatus = 'Good';
  var settlingColor = '#4ade80';
  if (rasMLSSRatio < 2.0) {
    settlingStatus = 'Poor - Check SVI';
    settlingColor = '#ef4444';
  } else if (rasMLSSRatio < 2.5) {
    settlingStatus = 'Fair';
    settlingColor = '#fbbf24';
  }

  return {
    method: 'RAS Ratio Method',
    rasFlow: rasFlow,
    rasGPM: rasGPM,
    rasGPD: rasGPD,
    rasPct: rasPct,
    rasConc: rasConc,
    mlss: mlss,
    rasMLSSRatio: rasMLSSRatio,
    rasMassReturn: rasMassReturn,
    pumpUtilization: pumpUtilization,
    totalPumpCap: totalPumpCap,
    settlingStatus: settlingStatus,
    settlingColor: settlingColor,
    theoreticalMLSS: theoreticalMLSS
  };
}

// Method 2: Target MLSS
function calcRAS_MLSS() {
  var flow = parseFloat(document.getElementById('ras_mlss_flow').value) || 5.0;
  var targetMLSS = parseFloat(document.getElementById('ras_mlss_target').value) || 3000;
  var currentMLSS = parseFloat(document.getElementById('ras_mlss_current').value) || 2800;
  var rasConc = parseFloat(document.getElementById('ras_mlss_conc').value) || 8000;
  var infTSS = parseFloat(document.getElementById('ras_mlss_inftss').value) || 200;
  var vol = parseFloat(document.getElementById('ras_mlss_vol').value) || 1.5;

  // Mass balance: Q*TSS_inf + Qras*RAS = (Q+Qras)*MLSS (simplified steady state)
  // Solving for Qras: Qras = Q * (MLSS - TSS_inf) / (RAS - MLSS)

  var rasFlow = flow * (targetMLSS - infTSS) / (rasConc - targetMLSS);
  if (rasFlow < 0) rasFlow = 0;
  if (rasConc <= targetMLSS) {
    rasFlow = flow; // RAS concentration too low
  }

  var rasGPM = rasFlow * 1000000 / 1440;
  var rasGPD = rasFlow * 1000000;
  var rasPct = (rasFlow / flow) * 100;

  // Check if achievable
  var achievable = rasConc > targetMLSS;

  // RAS/MLSS ratio
  var rasMLSSRatio = rasConc / targetMLSS;

  // Current inventory
  var currentInv = vol * currentMLSS * 8.34;
  var targetInv = vol * targetMLSS * 8.34;
  var invDiff = targetInv - currentInv;

  return {
    method: 'Target MLSS Method',
    rasFlow: rasFlow,
    rasGPM: rasGPM,
    rasGPD: rasGPD,
    rasPct: rasPct,
    rasConc: rasConc,
    targetMLSS: targetMLSS,
    currentMLSS: currentMLSS,
    rasMLSSRatio: rasMLSSRatio,
    currentInv: currentInv,
    targetInv: targetInv,
    invDiff: invDiff,
    achievable: achievable
  };
}

// Method 3: Blanket Control
function calcRAS_Blanket() {
  var flow = parseFloat(document.getElementById('ras_blanket_flow').value) || 5.0;
  var currentBlanket = parseFloat(document.getElementById('ras_blanket_current').value) || 3.0;
  var targetBlanket = parseFloat(document.getElementById('ras_blanket_target').value) || 2.0;
  var swd = parseFloat(document.getElementById('ras_blanket_swd').value) || 12;
  var currentRAS = parseFloat(document.getElementById('ras_blanket_currentras').value) || 2.5;
  var svi = parseFloat(document.getElementById('ras_blanket_svi').value) || 120;
  var mlss = parseFloat(document.getElementById('ras_blanket_mlss').value) || 3000;
  var area = parseFloat(document.getElementById('ras_blanket_area').value) || 7850;
  var adjFactor = parseFloat(document.getElementById('ras_blanket_adj').value) || 1.2;

  // Calculate blanket change needed
  var blanketChange = currentBlanket - targetBlanket; // positive = need to reduce

  // Estimate RAS adjustment (rule of thumb: 10% RAS change per 0.5 ft blanket)
  var rasAdjPct = (blanketChange / 0.5) * 10 * adjFactor;
  var newRAS = currentRAS * (1 + rasAdjPct/100);
  if (newRAS < 0) newRAS = 0.5; // Minimum

  var rasGPM = newRAS * 1000000 / 1440;
  var rasGPD = newRAS * 1000000;
  var rasPct = (newRAS / flow) * 100;

  // Calculate solids loading rate
  var slr = (flow + newRAS) * mlss * 8.34 / area;

  // Calculate settling rate from SVI
  var settlingVelocity = 1000 / svi; // Approximate ft/hr at MLSS concentration

  // Blanket status
  var blanketStatus = 'Normal';
  var blanketColor = '#4ade80';
  if (currentBlanket > swd * 0.5) {
    blanketStatus = 'HIGH - Risk of washout!';
    blanketColor = '#ef4444';
  } else if (currentBlanket > swd * 0.33) {
    blanketStatus = 'Elevated - Monitor closely';
    blanketColor = '#fbbf24';
  } else if (currentBlanket < 1) {
    blanketStatus = 'Low - May reduce RAS';
    blanketColor = '#60a5fa';
  }

  // Recommended action
  var action = '';
  if (blanketChange > 1) {
    action = 'Significantly increase RAS rate';
  } else if (blanketChange > 0.5) {
    action = 'Moderately increase RAS rate';
  } else if (blanketChange > 0) {
    action = 'Slightly increase RAS rate';
  } else if (blanketChange < -1) {
    action = 'Consider reducing RAS rate';
  } else {
    action = 'Maintain current RAS rate';
  }

  return {
    method: 'Blanket Control Method',
    currentRAS: currentRAS,
    newRAS: newRAS,
    rasGPM: rasGPM,
    rasGPD: rasGPD,
    rasPct: rasPct,
    currentBlanket: currentBlanket,
    targetBlanket: targetBlanket,
    blanketChange: blanketChange,
    rasAdjPct: rasAdjPct,
    slr: slr,
    svi: svi,
    settlingVelocity: settlingVelocity,
    blanketStatus: blanketStatus,
    blanketColor: blanketColor,
    action: action,
    swd: swd
  };
}

// Display RAS Results
function displayRASResults(r) {
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #10b981">';
  html += '<h4 style="margin:0 0 15px 0;color:#10b981">üîÑ ' + r.method + ' Results</h4>';
  html += '<table class="table">';
  html += '<tbody>';

  // RAS Flow Results
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#10b981">üíß RAS Flow Rate</td></tr>';
  html += '<tr><td>RAS Flow</td><td><span class="result" style="font-size:18px;color:#4ade80">' + (r.rasFlow || r.newRAS || 0).toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>RAS Flow</td><td><span class="result" style="font-size:18px;color:#4ade80">' + r.rasGPM.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>gpm</td></tr>';
  html += '<tr><td>RAS Flow</td><td><span class="result">' + r.rasGPD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>gpd</td></tr>';
  html += '<tr><td>RAS Ratio (RAS/Q)</td><td><span class="result" style="color:#60a5fa">' + r.rasPct.toFixed(1) + '</span></td><td>%</td></tr>';

  // Method-specific results
  if (r.rasConc) {
    html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#10b981">üìä Solids Data</td></tr>';
    html += '<tr><td>RAS Concentration</td><td><span class="result">' + r.rasConc.toLocaleString() + '</span></td><td>mg/L</td></tr>';
  }
  if (r.rasMLSSRatio) {
    html += '<tr><td>RAS/MLSS Ratio</td><td><span class="result">' + r.rasMLSSRatio.toFixed(2) + '</span></td><td>-</td></tr>';
  }
  if (r.rasMassReturn) {
    html += '<tr><td>RAS Mass Return</td><td><span class="result">' + r.rasMassReturn.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  }
  if (r.pumpUtilization) {
    var pumpColor = r.pumpUtilization > 90 ? '#ef4444' : r.pumpUtilization > 75 ? '#fbbf24' : '#4ade80';
    html += '<tr><td>Pump Utilization</td><td><span class="result" style="color:' + pumpColor + '">' + r.pumpUtilization.toFixed(1) + '</span></td><td>%</td></tr>';
  }
  if (r.slr) {
    var slrColor = r.slr > 35 ? '#fbbf24' : '#4ade80';
    html += '<tr><td>Solids Loading Rate</td><td><span class="result" style="color:' + slrColor + '">' + r.slr.toFixed(1) + '</span></td><td>lb/sf/day</td></tr>';
  }

  // Blanket-specific
  if (r.currentBlanket !== undefined) {
    html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#f59e0b">üìè Blanket Status</td></tr>';
    html += '<tr><td>Current Blanket</td><td><span class="result">' + r.currentBlanket.toFixed(1) + '</span></td><td>ft</td></tr>';
    html += '<tr><td>Target Blanket</td><td><span class="result">' + r.targetBlanket.toFixed(1) + '</span></td><td>ft</td></tr>';
    html += '<tr><td>Blanket Status</td><td colspan="2"><span style="color:' + r.blanketColor + ';font-weight:bold">' + r.blanketStatus + '</span></td></tr>';
    html += '<tr><td>RAS Adjustment</td><td><span class="result">' + (r.rasAdjPct > 0 ? '+' : '') + r.rasAdjPct.toFixed(1) + '</span></td><td>%</td></tr>';
  }

  // MLSS target specific
  if (r.targetMLSS && r.currentMLSS) {
    html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#3b82f6">üéØ MLSS Balance</td></tr>';
    html += '<tr><td>Current MLSS</td><td><span class="result">' + r.currentMLSS.toLocaleString() + '</span></td><td>mg/L</td></tr>';
    html += '<tr><td>Target MLSS</td><td><span class="result">' + r.targetMLSS.toLocaleString() + '</span></td><td>mg/L</td></tr>';
    if (!r.achievable) {
      html += '<tr><td colspan="3" style="color:#ef4444">‚ö†Ô∏è RAS concentration too low to achieve target MLSS!</td></tr>';
    }
  }

  html += '</tbody></table>';

  // Settling status or recommendation
  if (r.settlingStatus) {
    html += '<div class="note" style="margin-top:15px;border-left-color:' + r.settlingColor + '">';
    html += '<strong>Settling Status:</strong> <span style="color:' + r.settlingColor + '">' + r.settlingStatus + '</span>';
    if (r.rasMLSSRatio < 2.5) {
      html += '<br><small>Consider checking SVI and microscopic exam for filaments.</small>';
    }
    html += '</div>';
  }

  if (r.action) {
    html += '<div class="note success" style="margin-top:15px">';
    html += '<strong>üí° Recommendation:</strong> ' + r.action;
    html += '</div>';
  }

  html += '</div>';

  document.getElementById('ras_results').innerHTML = html;
}

// Calculate RAS Settling Check
function calcRASSettling() {
  // Get values from whichever method is active
  var mlss, rasConc, svi, flow;

  if (currentRASMethod === 'ratio') {
    mlss = parseFloat(document.getElementById('ras_ratio_mlss').value) || 3000;
    rasConc = parseFloat(document.getElementById('ras_ratio_conc').value) || 8000;
    flow = parseFloat(document.getElementById('ras_ratio_flow').value) || 5.0;
    svi = 100; // Default
  } else if (currentRASMethod === 'blanket') {
    mlss = parseFloat(document.getElementById('ras_blanket_mlss').value) || 3000;
    svi = parseFloat(document.getElementById('ras_blanket_svi').value) || 120;
    flow = parseFloat(document.getElementById('ras_blanket_flow').value) || 5.0;
    rasConc = 1000000 / svi; // Theoretical max
  } else {
    mlss = parseFloat(document.getElementById('ras_mlss_current').value) || 3000;
    rasConc = parseFloat(document.getElementById('ras_mlss_conc').value) || 8000;
    flow = parseFloat(document.getElementById('ras_mlss_flow').value) || 5.0;
    svi = 100;
  }

  // Prompt for SVI if not in blanket method
  if (currentRASMethod !== 'blanket') {
    var inputSVI = prompt('Enter current SVI (mL/g):', '120');
    if (inputSVI) svi = parseFloat(inputSVI);
  }

  // Calculate settling parameters
  var ssvi = svi; // Stirred SVI approximately = SVI
  var theoreticalRASConc = 1000000 / svi; // mg/L
  var actualRatio = rasConc / mlss;
  var theoreticalRatio = theoreticalRASConc / mlss;

  // State point analysis (simplified)
  var settlingFlux = mlss * (1000 / svi) / 1000; // lb/sf/hr approximate

  // Determine status
  var status = '';
  var color = '#4ade80';
  var recommendations = [];

  if (svi > 200) {
    status = 'POOR SETTLING - Bulking sludge';
    color = '#ef4444';
    recommendations.push('Identify filament type via microscopy');
    recommendations.push('Check F/M ratio, DO, nutrients');
    recommendations.push('Consider chlorination or RAS chlorination');
  } else if (svi > 150) {
    status = 'FAIR SETTLING - Elevated SVI';
    color = '#fbbf24';
    recommendations.push('Monitor for increasing trend');
    recommendations.push('Review process conditions');
    recommendations.push('Increase WAS to reduce SRT');
  } else if (svi > 80) {
    status = 'GOOD SETTLING';
    color = '#4ade80';
    recommendations.push('Maintain current operations');
  } else {
    status = 'EXCELLENT SETTLING - Pin floc possible';
    color = '#60a5fa';
    recommendations.push('Monitor for pin floc in effluent');
    recommendations.push('May need to reduce WAS');
  }

  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid ' + color + '">';
  html += '<h4 style="margin:0 0 15px 0;color:' + color + '">üìâ Settling Analysis</h4>';
  html += '<table class="table">';
  html += '<tbody>';
  html += '<tr><td>SVI</td><td><span class="result" style="color:' + color + '">' + svi + '</span></td><td>mL/g</td></tr>';
  html += '<tr><td>MLSS</td><td><span class="result">' + mlss.toLocaleString() + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Theoretical Max RAS Conc</td><td><span class="result">' + theoreticalRASConc.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Actual RAS Concentration</td><td><span class="result">' + rasConc.toLocaleString() + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>RAS/MLSS Ratio</td><td><span class="result">' + actualRatio.toFixed(2) + '</span></td><td>-</td></tr>';
  html += '<tr><td>Settling Status</td><td colspan="2"><strong style="color:' + color + '">' + status + '</strong></td></tr>';
  html += '</tbody></table>';

  html += '<div class="note info" style="margin-top:15px">';
  html += '<strong>üí° Recommendations:</strong><ul style="margin:10px 0 0 20px">';
  recommendations.forEach(function(rec) {
    html += '<li>' + rec + '</li>';
  });
  html += '</ul></div>';

  html += '</div>';

  document.getElementById('ras_results').innerHTML = html;
}

// Reset RAS Calculator
function resetRASCalc() {
  document.getElementById('ras_results').innerHTML = '';
  showToast('üîÑ RAS Calculator reset', 'info');
}

// ========== END RAS CALCULATOR ==========
// ========== CLARIFIER SLR CALCULATOR ==========

// Calculate Clarifier Loading Rates
function calcClarifier() {
  // Get inputs
  var numClarifiers = parseFloat(document.getElementById('clar_num').value) || 2;
  var diameter = parseFloat(document.getElementById('clar_dia').value) || 80;
  var swd = parseFloat(document.getElementById('clar_swd').value) || 12;
  var cwDia = parseFloat(document.getElementById('clar_cw').value) || 15;
  var weirLength = parseFloat(document.getElementById('clar_weir').value) || 251;
  var online = parseFloat(document.getElementById('clar_online').value) || 2;

  var flow = parseFloat(document.getElementById('clar_flow').value) || 5.0;
  var rasFlow = parseFloat(document.getElementById('clar_ras').value) || 2.5;
  var mlss = parseFloat(document.getElementById('clar_mlss').value) || 3000;
  var svi = parseFloat(document.getElementById('clar_svi').value) || 120;
  var rasConc = parseFloat(document.getElementById('clar_rasconc').value) || 8000;

  // Calculate areas
  var grossArea = Math.PI * Math.pow(diameter/2, 2); // sf per clarifier
  var cwArea = Math.PI * Math.pow(cwDia/2, 2); // center well area
  var netArea = grossArea - cwArea; // net settling area per clarifier
  var totalNetArea = netArea * online; // total online area
  var totalGrossArea = grossArea * online;

  // Calculate volume
  var volumePerClarifier = grossArea * swd / 7.48 / 1000000; // MG
  var totalVolume = volumePerClarifier * online;

  // Calculate total weir length
  var totalWeirLength = weirLength * online;

  // Calculate loading rates
  var flowGPD = flow * 1000000;
  var totalFlow = flow + rasFlow; // MGD to clarifier
  var totalFlowGPD = totalFlow * 1000000;

  // Surface Overflow Rate (based on influent only)
  var sor = flowGPD / totalNetArea; // gpd/sf

  // Solids Loading Rate
  var solidsLoad = totalFlow * mlss * 8.34; // lb/day total solids to clarifier
  var slr = solidsLoad / totalNetArea; // lb/sf/day

  // Weir Loading Rate
  var wlr = flowGPD / totalWeirLength; // gpd/lf

  // Hydraulic Detention Time
  var hdt = (totalVolume / flow) * 24; // hours

  // RAS ratio
  var rasRatio = (rasFlow / flow) * 100;

  // Determine status colors
  var sorStatus = getSORStatus(sor);
  var slrStatus = getSLRStatus(slr, svi);
  var wlrStatus = getWLRStatus(wlr);

  // Display results
  displayClarifierResults({
    type: 'Average Conditions',
    flow: flow,
    rasFlow: rasFlow,
    totalFlow: totalFlow,
    rasRatio: rasRatio,
    mlss: mlss,
    svi: svi,
    numClarifiers: numClarifiers,
    online: online,
    diameter: diameter,
    grossArea: grossArea,
    netArea: netArea,
    totalNetArea: totalNetArea,
    totalVolume: totalVolume,
    totalWeirLength: totalWeirLength,
    sor: sor,
    sorStatus: sorStatus,
    slr: slr,
    slrStatus: slrStatus,
    wlr: wlr,
    wlrStatus: wlrStatus,
    hdt: hdt,
    solidsLoad: solidsLoad
  });
}

// Calculate Peak Conditions
function calcClarifierPeak() {
  // Get inputs
  var numClarifiers = parseFloat(document.getElementById('clar_num').value) || 2;
  var diameter = parseFloat(document.getElementById('clar_dia').value) || 80;
  var swd = parseFloat(document.getElementById('clar_swd').value) || 12;
  var cwDia = parseFloat(document.getElementById('clar_cw').value) || 15;
  var weirLength = parseFloat(document.getElementById('clar_weir').value) || 251;
  var online = parseFloat(document.getElementById('clar_online').value) || 2;

  var flow = parseFloat(document.getElementById('clar_flow').value) || 5.0;
  var rasFlow = parseFloat(document.getElementById('clar_ras').value) || 2.5;
  var mlss = parseFloat(document.getElementById('clar_mlss').value) || 3000;
  var peakFactor = parseFloat(document.getElementById('clar_pf').value) || 2.5;
  var svi = parseFloat(document.getElementById('clar_svi').value) || 120;

  // Peak flow
  var peakFlow = flow * peakFactor;
  var peakRAS = rasFlow * 1.5; // Typically increase RAS during peak
  var peakTotal = peakFlow + peakRAS;

  // Calculate areas
  var grossArea = Math.PI * Math.pow(diameter/2, 2);
  var cwArea = Math.PI * Math.pow(cwDia/2, 2);
  var netArea = grossArea - cwArea;
  var totalNetArea = netArea * online;
  var totalVolume = grossArea * swd / 7.48 / 1000000 * online;
  var totalWeirLength = weirLength * online;

  // Calculate peak loading rates
  var peakFlowGPD = peakFlow * 1000000;
  var peakTotalFlowGPD = peakTotal * 1000000;

  var peakSOR = peakFlowGPD / totalNetArea;
  var peakSolidsLoad = peakTotal * mlss * 8.34;
  var peakSLR = peakSolidsLoad / totalNetArea;
  var peakWLR = peakFlowGPD / totalWeirLength;
  var peakHDT = (totalVolume / peakFlow) * 24;

  // Determine status
  var sorStatus = getSORStatus(peakSOR, true);
  var slrStatus = getSLRStatus(peakSLR, svi, true);
  var wlrStatus = getWLRStatus(peakWLR, true);

  // Display results
  displayClarifierResults({
    type: 'Peak Conditions (PF=' + peakFactor + ')',
    flow: peakFlow,
    rasFlow: peakRAS,
    totalFlow: peakTotal,
    rasRatio: (peakRAS / peakFlow) * 100,
    mlss: mlss,
    svi: svi,
    numClarifiers: numClarifiers,
    online: online,
    diameter: diameter,
    grossArea: grossArea,
    netArea: netArea,
    totalNetArea: totalNetArea,
    totalVolume: totalVolume,
    totalWeirLength: totalWeirLength,
    sor: peakSOR,
    sorStatus: sorStatus,
    slr: peakSLR,
    slrStatus: slrStatus,
    wlr: peakWLR,
    wlrStatus: wlrStatus,
    hdt: peakHDT,
    solidsLoad: peakSolidsLoad,
    isPeak: true,
    peakFactor: peakFactor
  });
}

// State Point Analysis
function calcStatePoint() {
  var flow = parseFloat(document.getElementById('clar_flow').value) || 5.0;
  var rasFlow = parseFloat(document.getElementById('clar_ras').value) || 2.5;
  var mlss = parseFloat(document.getElementById('clar_mlss').value) || 3000;
  var svi = parseFloat(document.getElementById('clar_svi').value) || 120;
  var rasConc = parseFloat(document.getElementById('clar_rasconc').value) || 8000;
  var online = parseFloat(document.getElementById('clar_online').value) || 2;
  var diameter = parseFloat(document.getElementById('clar_dia').value) || 80;
  var cwDia = parseFloat(document.getElementById('clar_cw').value) || 15;

  var grossArea = Math.PI * Math.pow(diameter/2, 2);
  var cwArea = Math.PI * Math.pow(cwDia/2, 2);
  var netArea = grossArea - cwArea;
  var totalNetArea = netArea * online;

  // Vesilind settling parameters (empirical)
  var vo = 20; // ft/hr - initial settling velocity
  var k = 0.0004 * svi; // Settling constant based on SVI

  // Calculate underflow rate (RAS)
  var underflowRate = (rasFlow * 1000000) / (totalNetArea * 24); // ft/hr

  // Calculate overflow rate
  var overflowRate = (flow * 1000000) / (totalNetArea * 24); // ft/hr

  // State point concentration
  // Simplified: Operating line intersects settling flux curve
  var operatingConc = mlss; // mg/L
  var settlingVelocity = vo * Math.exp(-k * mlss/1000); // ft/hr at MLSS

  // Settling flux at MLSS
  var settlingFlux = (mlss/1000) * settlingVelocity * 62.4 / 24; // lb/sf/day

  // Limiting flux (simplified)
  var limitingConc = (1/k) * 1000 * Math.log(vo * k / underflowRate); // mg/L
  if (limitingConc < 0) limitingConc = mlss * 2;
  var limitingFlux = (limitingConc/1000) * vo * Math.exp(-k * limitingConc/1000) * 62.4 / 24;

  // Applied flux
  var appliedFlux = ((flow + rasFlow) * mlss * 8.34) / totalNetArea;

  // Safety factor
  var safetyFactor = settlingFlux / appliedFlux;

  // Determine status
  var status = '';
  var color = '#4ade80';
  var recommendations = [];

  if (safetyFactor < 1.0) {
    status = 'OVERLOADED - Failure likely';
    color = '#ef4444';
    recommendations.push('Reduce flow or increase RAS immediately');
    recommendations.push('Consider bringing additional clarifier online');
    recommendations.push('Increase WAS to reduce MLSS');
  } else if (safetyFactor < 1.25) {
    status = 'CRITICAL - Near capacity';
    color = '#f97316';
    recommendations.push('Monitor closely, prepare contingency');
    recommendations.push('Avoid additional loading');
    recommendations.push('Consider increasing RAS rate');
  } else if (safetyFactor < 1.5) {
    status = 'MARGINAL - Limited capacity';
    color = '#fbbf24';
    recommendations.push('Adequate for current conditions');
    recommendations.push('May struggle during peak flows');
    recommendations.push('Monitor settling characteristics');
  } else {
    status = 'ADEQUATE - Good capacity';
    color = '#4ade80';
    recommendations.push('Operating within safe limits');
    recommendations.push('Can handle moderate flow increases');
  }

  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid ' + color + '">';
  html += '<h4 style="margin:0 0 15px 0;color:#3b82f6">üìà State Point Analysis</h4>';

  html += '<table class="table">';
  html += '<tbody>';
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">Settling Parameters</td></tr>';
  html += '<tr><td>Initial Settling Velocity (Vo)</td><td><span class="result">' + vo.toFixed(1) + '</span></td><td>ft/hr</td></tr>';
  html += '<tr><td>Settling Constant (k)</td><td><span class="result">' + k.toFixed(4) + '</span></td><td>L/mg</td></tr>';
  html += '<tr><td>Settling Velocity at MLSS</td><td><span class="result">' + settlingVelocity.toFixed(2) + '</span></td><td>ft/hr</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">Flux Analysis</td></tr>';
  html += '<tr><td>Settling Flux at MLSS</td><td><span class="result">' + settlingFlux.toFixed(1) + '</span></td><td>lb/sf/day</td></tr>';
  html += '<tr><td>Applied Solids Flux</td><td><span class="result">' + appliedFlux.toFixed(1) + '</span></td><td>lb/sf/day</td></tr>';
  html += '<tr><td>Limiting Concentration</td><td><span class="result">' + limitingConc.toFixed(0) + '</span></td><td>mg/L</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">Operating Rates</td></tr>';
  html += '<tr><td>Overflow Rate</td><td><span class="result">' + overflowRate.toFixed(2) + '</span></td><td>ft/hr</td></tr>';
  html += '<tr><td>Underflow Rate (RAS)</td><td><span class="result">' + underflowRate.toFixed(2) + '</span></td><td>ft/hr</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:' + color + '">Safety Factor</td></tr>';
  html += '<tr><td>Capacity Safety Factor</td><td><span class="result" style="font-size:20px;color:' + color + '">' + safetyFactor.toFixed(2) + '</span></td><td>-</td></tr>';
  html += '<tr><td>Status</td><td colspan="2"><strong style="color:' + color + '">' + status + '</strong></td></tr>';
  html += '</tbody></table>';

  html += '<div class="note" style="margin-top:15px;border-left-color:' + color + '">';
  html += '<strong>üí° Recommendations:</strong><ul style="margin:10px 0 0 20px">';
  recommendations.forEach(function(rec) {
    html += '<li>' + rec + '</li>';
  });
  html += '</ul></div>';

  html += '</div>';

  document.getElementById('clar_results').innerHTML = html;
}

// Get SOR Status
function getSORStatus(sor, isPeak) {
  var limit = isPeak ? 1200 : 800;
  var warn = isPeak ? 1000 : 600;

  if (sor > limit) return { color: '#ef4444', text: 'HIGH', icon: '‚ö†Ô∏è' };
  if (sor > warn) return { color: '#fbbf24', text: 'ELEVATED', icon: '‚ö°' };
  return { color: '#4ade80', text: 'OK', icon: '‚úì' };
}

// Get SLR Status
function getSLRStatus(slr, svi, isPeak) {
  var limit = isPeak ? 50 : 30;
  var warn = isPeak ? 35 : 25;

  // Adjust for poor settling
  if (svi > 150) {
    limit *= 0.7;
    warn *= 0.7;
  }

  if (slr > limit) return { color: '#ef4444', text: 'HIGH', icon: '‚ö†Ô∏è' };
  if (slr > warn) return { color: '#fbbf24', text: 'ELEVATED', icon: '‚ö°' };
  return { color: '#4ade80', text: 'OK', icon: '‚úì' };
}

// Get WLR Status
function getWLRStatus(wlr, isPeak) {
  var limit = isPeak ? 30000 : 20000;
  var warn = isPeak ? 25000 : 15000;

  if (wlr > limit) return { color: '#ef4444', text: 'HIGH', icon: '‚ö†Ô∏è' };
  if (wlr > warn) return { color: '#fbbf24', text: 'ELEVATED', icon: '‚ö°' };
  return { color: '#4ade80', text: 'OK', icon: '‚úì' };
}

// Display Clarifier Results
function displayClarifierResults(r) {
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #3b82f6">';
  html += '<h4 style="margin:0 0 15px 0;color:#3b82f6">üèä ' + r.type + '</h4>';

  html += '<table class="table">';
  html += '<tbody>';

  // Clarifier Info
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üèóÔ∏è Clarifier Configuration</td></tr>';
  html += '<tr><td>Clarifiers Online</td><td><span class="result">' + r.online + ' of ' + r.numClarifiers + '</span></td><td>-</td></tr>';
  html += '<tr><td>Diameter</td><td><span class="result">' + r.diameter + '</span></td><td>ft</td></tr>';
  html += '<tr><td>Net Area (per clarifier)</td><td><span class="result">' + r.netArea.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>sf</td></tr>';
  html += '<tr><td>Total Net Area</td><td><span class="result">' + r.totalNetArea.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>sf</td></tr>';
  html += '<tr><td>Total Volume</td><td><span class="result">' + r.totalVolume.toFixed(3) + '</span></td><td>MG</td></tr>';

  // Flow Info
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üíß Flow Data</td></tr>';
  html += '<tr><td>Influent Flow</td><td><span class="result">' + r.flow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>RAS Flow</td><td><span class="result">' + r.rasFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Total to Clarifier</td><td><span class="result">' + r.totalFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>RAS Ratio</td><td><span class="result">' + r.rasRatio.toFixed(0) + '</span></td><td>%</td></tr>';
  html += '<tr><td>MLSS</td><td><span class="result">' + r.mlss.toLocaleString() + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Solids Load</td><td><span class="result">' + r.solidsLoad.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';

  // Loading Rates
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">üìä Loading Rates</td></tr>';

  html += '<tr>';
  html += '<td>Surface Overflow Rate (SOR)</td>';
  html += '<td><span class="result" style="font-size:18px;color:' + r.sorStatus.color + '">' + r.sor.toFixed(0) + '</span></td>';
  html += '<td>gpd/sf <span style="color:' + r.sorStatus.color + '">' + r.sorStatus.icon + ' ' + r.sorStatus.text + '</span></td>';
  html += '</tr>';

  html += '<tr>';
  html += '<td>Solids Loading Rate (SLR)</td>';
  html += '<td><span class="result" style="font-size:18px;color:' + r.slrStatus.color + '">' + r.slr.toFixed(1) + '</span></td>';
  html += '<td>lb/sf/day <span style="color:' + r.slrStatus.color + '">' + r.slrStatus.icon + ' ' + r.slrStatus.text + '</span></td>';
  html += '</tr>';

  html += '<tr>';
  html += '<td>Weir Loading Rate (WLR)</td>';
  html += '<td><span class="result" style="font-size:18px;color:' + r.wlrStatus.color + '">' + r.wlr.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td>';
  html += '<td>gpd/lf <span style="color:' + r.wlrStatus.color + '">' + r.wlrStatus.icon + ' ' + r.wlrStatus.text + '</span></td>';
  html += '</tr>';

  html += '<tr><td>Hydraulic Detention Time</td><td><span class="result">' + r.hdt.toFixed(1) + '</span></td><td>hours</td></tr>';

  html += '</tbody></table>';

  // Summary recommendation
  var overallStatus = 'Good';
  var overallColor = '#4ade80';
  if (r.sorStatus.text === 'HIGH' || r.slrStatus.text === 'HIGH' || r.wlrStatus.text === 'HIGH') {
    overallStatus = 'Overloaded';
    overallColor = '#ef4444';
  } else if (r.sorStatus.text === 'ELEVATED' || r.slrStatus.text === 'ELEVATED' || r.wlrStatus.text === 'ELEVATED') {
    overallStatus = 'Near Capacity';
    overallColor = '#fbbf24';
  }

  html += '<div class="note" style="margin-top:15px;border-left-color:' + overallColor + '">';
  html += '<strong style="color:' + overallColor + '">Overall Status: ' + overallStatus + '</strong><br>';

  if (overallStatus === 'Overloaded') {
    html += 'Consider bringing additional clarifier online or reducing flow. ';
    html += 'Check for settling problems (SVI = ' + r.svi + ').';
  } else if (overallStatus === 'Near Capacity') {
    html += 'Operating near design limits. Monitor during peak flows. ';
    html += 'Ensure backup clarifier is available.';
  } else {
    html += 'Clarifier operating within acceptable limits.';
  }
  html += '</div>';

  html += '</div>';

  document.getElementById('clar_results').innerHTML = html;
}

// Reset Clarifier Calculator
function resetClarifier() {
  document.getElementById('clar_results').innerHTML = '';
  showToast('üîÑ Clarifier Calculator reset', 'info');
}

// ========== END CLARIFIER SLR CALCULATOR ==========
// ========== SLUDGE JUDGE / SETTLEOMETER CALCULATOR ==========

// Calculate Settling Test Results
function calcSettling() {
  var mlss = parseFloat(document.getElementById('sj_mlss').value) || 3000;
  var cylinder = parseFloat(document.getElementById('sj_cylinder').value) || 2000;
  var stirred = document.getElementById('sj_stirred').value === 'yes';
  var location = document.getElementById('sj_location').value;

  // Get readings
  var v0 = parseFloat(document.getElementById('sj_0').value) || cylinder;
  var v5 = parseFloat(document.getElementById('sj_5').value) || 0;
  var v10 = parseFloat(document.getElementById('sj_10').value) || 0;
  var v15 = parseFloat(document.getElementById('sj_15').value) || 0;
  var v20 = parseFloat(document.getElementById('sj_20').value) || 0;
  var v25 = parseFloat(document.getElementById('sj_25').value) || 0;
  var v30 = parseFloat(document.getElementById('sj_30').value) || 0;
  var v60 = parseFloat(document.getElementById('sj_60').value) || 0;

  if (v30 === 0) {
    document.getElementById('sj_results').innerHTML = '<div class="note warning">Enter 30-minute settled volume to calculate SVI</div>';
    return;
  }

  // Calculate SVI
  // SVI = (Settled Volume mL / Cylinder Volume mL) √ó (1000 / MLSS mg/L) √ó 1000
  // Simplified: SVI = (V30 √ó 1000) / (Cylinder √ó MLSS / 1000)
  var svi = (v30 * 1000) / (cylinder * mlss / 1000);

  // Calculate % settled at 30 min
  var pctSettled30 = ((v0 - v30) / v0) * 100;

  // Calculate settling rate (first 10 minutes - linear phase)
  var settlingRate = 0;
  if (v5 > 0 && v10 > 0) {
    settlingRate = (v5 - v10) / 5; // mL/min
  } else if (v10 > 0) {
    settlingRate = (v0 - v10) / 10;
  }

  // Settling velocity (ft/hr) - based on cylinder geometry
  var cylinderHeight = cylinder === 2000 ? 18 : 14; // inches approximate
  var settlingVelocity = 0;
  if (v10 > 0 && v0 > 0) {
    var heightDrop = ((v0 - v10) / v0) * cylinderHeight; // inches in 10 min
    settlingVelocity = (heightDrop / 12) * 6; // ft/hr
  }

  // Theoretical RAS concentration
  var theoreticalRAS = 1000000 / svi; // mg/L

  // SDI (Sludge Density Index) = 100 / SVI
  var sdi = 100 / svi;

  // Determine status
  var status = getSVIStatus(svi);

  // Build results HTML
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid ' + status.color + '">';
  html += '<h4 style="margin:0 0 15px 0;color:#f59e0b">üß™ Settling Test Results</h4>';

  // Main SVI display
  html += '<div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;flex-wrap:wrap">';
  html += '<div style="background:#1e3a5f;padding:20px;border-radius:12px;text-align:center;min-width:150px">';
  html += '<div style="font-size:14px;opacity:0.7">' + (stirred ? 'SSVI' : 'SVI') + '</div>';
  html += '<div style="font-size:42px;font-weight:bold;color:' + status.color + '">' + svi.toFixed(0) + '</div>';
  html += '<div style="font-size:14px">mL/g</div>';
  html += '</div>';
  html += '<div style="flex:1">';
  html += '<div style="font-size:18px;color:' + status.color + ';font-weight:bold">' + status.icon + ' ' + status.text + '</div>';
  html += '<div style="margin-top:5px;opacity:0.8">' + status.description + '</div>';
  html += '</div>';
  html += '</div>';

  // Results table
  html += '<table class="table">';
  html += '<tbody>';
  html += '<tr><td>Sample Location</td><td><span class="result">' + getLocationName(location) + '</span></td><td>-</td></tr>';
  html += '<tr><td>MLSS Concentration</td><td><span class="result">' + mlss.toLocaleString() + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>30-min Settled Volume</td><td><span class="result">' + v30 + '</span></td><td>mL</td></tr>';
  html += '<tr><td>% Volume Reduction</td><td><span class="result">' + pctSettled30.toFixed(1) + '</span></td><td>%</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">Calculated Parameters</td></tr>';
  html += '<tr><td>' + (stirred ? 'SSVI' : 'SVI') + '</td><td><span class="result" style="color:' + status.color + ';font-size:18px">' + svi.toFixed(1) + '</span></td><td>mL/g</td></tr>';
  html += '<tr><td>SDI (Sludge Density Index)</td><td><span class="result">' + sdi.toFixed(2) + '</span></td><td>g/100mL</td></tr>';
  html += '<tr><td>Theoretical Max RAS Conc</td><td><span class="result">' + theoreticalRAS.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>mg/L</td></tr>';

  if (settlingRate > 0) {
    html += '<tr><td>Initial Settling Rate</td><td><span class="result">' + settlingRate.toFixed(1) + '</span></td><td>mL/min</td></tr>';
  }
  if (settlingVelocity > 0) {
    html += '<tr><td>Settling Velocity</td><td><span class="result">' + settlingVelocity.toFixed(2) + '</span></td><td>ft/hr</td></tr>';
  }

  if (v60 > 0) {
    var svi60 = (v60 * 1000) / (cylinder * mlss / 1000);
    var compactionRatio = v30 / v60;
    html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">60-Minute Data</td></tr>';
    html += '<tr><td>60-min Settled Volume</td><td><span class="result">' + v60 + '</span></td><td>mL</td></tr>';
    html += '<tr><td>60-min SVI</td><td><span class="result">' + svi60.toFixed(1) + '</span></td><td>mL/g</td></tr>';
    html += '<tr><td>Compaction Ratio (30/60)</td><td><span class="result">' + compactionRatio.toFixed(2) + '</span></td><td>-</td></tr>';
  }

  html += '</tbody></table>';

  // Recommendations
  html += '<div class="note" style="margin-top:15px;border-left-color:' + status.color + '">';
  html += '<strong>üí° Recommendations:</strong><ul style="margin:10px 0 0 20px">';
  status.recommendations.forEach(function(rec) {
    html += '<li>' + rec + '</li>';
  });
  html += '</ul></div>';

  html += '</div>';

  document.getElementById('sj_results').innerHTML = html;
}

// Get SVI Status
function getSVIStatus(svi) {
  if (svi < 80) {
    return {
      color: '#4ade80',
      text: 'EXCELLENT',
      icon: '‚úì',
      description: 'Old/dense sludge - watch for pin floc',
      recommendations: [
        'Monitor effluent TSS for pin floc carryover',
        'May be able to reduce WAS slightly',
        'Check microscopy for floc structure'
      ]
    };
  } else if (svi < 120) {
    return {
      color: '#4ade80',
      text: 'GOOD',
      icon: '‚úì',
      description: 'Normal, healthy settling sludge',
      recommendations: [
        'Maintain current operations',
        'Continue routine monitoring',
        'Ideal settling characteristics'
      ]
    };
  } else if (svi < 150) {
    return {
      color: '#fbbf24',
      text: 'FAIR',
      icon: '‚ö†Ô∏è',
      description: 'Light bulking may be beginning',
      recommendations: [
        'Monitor trend over next few days',
        'Check DO levels (maintain > 2.0 mg/L)',
        'Verify nutrient availability (N, P)',
        'Review F/M ratio'
      ]
    };
  } else if (svi < 200) {
    return {
      color: '#f97316',
      text: 'POOR',
      icon: '‚ö†Ô∏è',
      description: 'Bulking sludge - action needed',
      recommendations: [
        'Perform microscopic exam to identify filaments',
        'Check for low DO, nutrient deficiency, or septic conditions',
        'Consider increasing WAS to reduce SRT',
        'Review selector or anoxic zone operation'
      ]
    };
  } else {
    return {
      color: '#ef4444',
      text: 'VERY POOR',
      icon: '‚ùå',
      description: 'Severe bulking - immediate action required',
      recommendations: [
        'Identify dominant filament type immediately',
        'Consider chlorination of RAS (2-10 lb Cl2/1000 lb MLSS)',
        'Add polymer to clarifier if needed',
        'Significantly increase WAS rate',
        'Check for industrial discharge or toxic shock'
      ]
    };
  }
}

// Get Location Name
function getLocationName(loc) {
  var names = {
    'mlss': 'MLSS (Aeration Basin)',
    'ras': 'Return Activated Sludge',
    'effluent': 'Secondary Effluent'
  };
  return names[loc] || loc;
}

// Show Settling Curve
function showSettlingCurve() {
  var container = document.getElementById('sj_chart_container');
  var cylinder = parseFloat(document.getElementById('sj_cylinder').value) || 2000;

  // Get readings
  var readings = [
    { time: 0, vol: parseFloat(document.getElementById('sj_0').value) || cylinder },
    { time: 5, vol: parseFloat(document.getElementById('sj_5').value) || null },
    { time: 10, vol: parseFloat(document.getElementById('sj_10').value) || null },
    { time: 15, vol: parseFloat(document.getElementById('sj_15').value) || null },
    { time: 20, vol: parseFloat(document.getElementById('sj_20').value) || null },
    { time: 25, vol: parseFloat(document.getElementById('sj_25').value) || null },
    { time: 30, vol: parseFloat(document.getElementById('sj_30').value) || null },
    { time: 60, vol: parseFloat(document.getElementById('sj_60').value) || null }
  ].filter(r => r.vol !== null && r.vol > 0);

  if (readings.length < 2) {
    showToast('Enter at least 2 readings to show curve', 'warning');
    return;
  }

  container.style.display = 'block';

  // Create chart
  var ctx = document.getElementById('settlingChart').getContext('2d');

  // Destroy existing chart if any
  if (window.settlingChartInstance) {
    window.settlingChartInstance.destroy();
  }

  window.settlingChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: readings.map(r => r.time + ' min'),
      datasets: [{
        label: 'Settled Volume (mL)',
        data: readings.map(r => r.vol),
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 6,
        pointBackgroundColor: '#f59e0b'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: false,
          title: { display: true, text: 'Settled Volume (mL)', color: '#94a3b8' },
          grid: { color: '#374151' },
          ticks: { color: '#94a3b8' }
        },
        x: {
          title: { display: true, text: 'Time', color: '#94a3b8' },
          grid: { color: '#374151' },
          ticks: { color: '#94a3b8' }
        }
      }
    }
  });
}

// Save Settling Test
function saveSettlingTest() {
  var test = {
    date: document.getElementById('sj_date').value || new Date().toISOString().split('T')[0],
    time: document.getElementById('sj_time').value || new Date().toTimeString().split(' ')[0].slice(0,5),
    location: document.getElementById('sj_location').value,
    mlss: document.getElementById('sj_mlss').value,
    cylinder: document.getElementById('sj_cylinder').value,
    stirred: document.getElementById('sj_stirred').value,
    readings: {
      v0: document.getElementById('sj_0').value,
      v5: document.getElementById('sj_5').value,
      v10: document.getElementById('sj_10').value,
      v15: document.getElementById('sj_15').value,
      v20: document.getElementById('sj_20').value,
      v25: document.getElementById('sj_25').value,
      v30: document.getElementById('sj_30').value,
      v60: document.getElementById('sj_60').value
    }
  };

  // Calculate SVI for storage
  var v30 = parseFloat(test.readings.v30) || 0;
  var mlss = parseFloat(test.mlss) || 3000;
  var cylinder = parseFloat(test.cylinder) || 2000;
  if (v30 > 0) {
    test.svi = (v30 * 1000) / (cylinder * mlss / 1000);
  }

  // Get existing tests
  var tests = JSON.parse(localStorage.getItem('wwtp_settling_tests') || '[]');
  tests.unshift(test);

  // Keep last 50 tests
  if (tests.length > 50) tests = tests.slice(0, 50);

  localStorage.setItem('wwtp_settling_tests', JSON.stringify(tests));
  showToast('üíæ Settling test saved!', 'success');
}

// Reset Settling Test
function resetSettling() {
  document.getElementById('sj_5').value = '';
  document.getElementById('sj_10').value = '';
  document.getElementById('sj_15').value = '';
  document.getElementById('sj_20').value = '';
  document.getElementById('sj_25').value = '';
  document.getElementById('sj_30').value = '';
  document.getElementById('sj_60').value = '';
  document.getElementById('sj_results').innerHTML = '';
  document.getElementById('sj_chart_container').style.display = 'none';
  showToast('üîÑ Settling test reset', 'info');
}

// ========== END SLUDGE JUDGE / SETTLEOMETER CALCULATOR ==========
// ========== JAR TEST OPTIMIZER ==========

// Update coagulant cost based on type
function updateCoagCost() {
  var type = document.getElementById('jt_coag_type').value;
  var costs = {
    'alum': 0.15,
    'ferric': 0.18,
    'ferrous': 0.10,
    'pac': 0.35,
    'sodium_aluminate': 0.45
  };
  document.getElementById('jt_coag_cost').value = costs[type] || 0.15;
}

// Analyze Jar Test Results
function analyzeJarTest() {
  var plantFlow = parseFloat(document.getElementById('jt_plant_flow').value) || 5.0;
  var coagCost = parseFloat(document.getElementById('jt_coag_cost').value) || 0.15;
  var polyCost = parseFloat(document.getElementById('jt_poly_cost').value) || 2.50;
  var initTurb = parseFloat(document.getElementById('jt_init_turb').value) || 25;
  var targetTurb = parseFloat(document.getElementById('jt_target_turb').value) || 5;
  var coagType = document.getElementById('jt_coag_type').value;

  // Collect jar data
  var jars = [];
  for (var i = 1; i <= 6; i++) {
    var coagDose = parseFloat(document.getElementById('jt_' + i + '_coag').value) || 0;
    var polyDose = parseFloat(document.getElementById('jt_' + i + '_poly').value) || 0;
    var turb = parseFloat(document.getElementById('jt_' + i + '_turb').value);
    var floc = document.getElementById('jt_' + i + '_floc').value;
    var fph = parseFloat(document.getElementById('jt_' + i + '_fph').value);

    if (coagDose > 0 && !isNaN(turb)) {
      jars.push({
        jar: i,
        coagDose: coagDose,
        polyDose: polyDose,
        turb: turb,
        floc: floc ? parseInt(floc) : 0,
        fph: fph,
        removal: ((initTurb - turb) / initTurb * 100)
      });
    }
  }

  if (jars.length < 2) {
    document.getElementById('jt_results').innerHTML = '<div class="note warning">Enter turbidity results for at least 2 jars to analyze.</div>';
    return;
  }

  // Find optimal jar (lowest turbidity that meets target with best floc)
  var validJars = jars.filter(j => j.turb <= targetTurb);
  var optimalJar = null;

  if (validJars.length > 0) {
    // Among jars meeting target, find lowest dose
    optimalJar = validJars.reduce((best, current) => {
      if (!best) return current;
      if (current.coagDose < best.coagDose) return current;
      if (current.coagDose === best.coagDose && current.floc > best.floc) return current;
      return best;
    }, null);
  } else {
    // No jar meets target - find best performer
    optimalJar = jars.reduce((best, current) => {
      if (!best) return current;
      if (current.turb < best.turb) return current;
      return best;
    }, null);
  }

  // Calculate costs for optimal dose
  var optCoagDose = optimalJar.coagDose;
  var optPolyDose = optimalJar.polyDose;

  // lb/day = MGD √ó dose(mg/L) √ó 8.34
  var coagLbDay = plantFlow * optCoagDose * 8.34;
  var polyLbDay = plantFlow * optPolyDose * 8.34;

  var dailyCoagCost = coagLbDay * coagCost;
  var dailyPolyCost = polyLbDay * polyCost;
  var totalDailyCost = dailyCoagCost + dailyPolyCost;

  // Cost per 1000 gallons
  var costPer1000 = totalDailyCost / (plantFlow * 1000);

  // Cost per MG
  var costPerMG = totalDailyCost / plantFlow;

  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #f59e0b">';
  html += '<h4 style="margin:0 0 15px 0;color:#f59e0b">üß´ Jar Test Analysis Results</h4>';

  // Optimal dose display
  var meetsTarget = optimalJar.turb <= targetTurb;
  html += '<div style="display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap">';
  html += '<div style="background:#1e3a5f;padding:20px;border-radius:12px;text-align:center;min-width:150px;border:2px solid ' + (meetsTarget ? '#4ade80' : '#fbbf24') + '">';
  html += '<div style="font-size:12px;opacity:0.7">OPTIMAL DOSE</div>';
  html += '<div style="font-size:36px;font-weight:bold;color:' + (meetsTarget ? '#4ade80' : '#fbbf24') + '">' + optCoagDose + '</div>';
  html += '<div style="font-size:14px">mg/L ' + getCoagName(coagType) + '</div>';
  html += '<div style="font-size:11px;margin-top:5px;opacity:0.7">Jar #' + optimalJar.jar + '</div>';
  html += '</div>';
  html += '<div style="flex:1;min-width:200px">';
  html += '<div style="font-size:20px;color:' + (meetsTarget ? '#4ade80' : '#fbbf24') + ';font-weight:bold">' + (meetsTarget ? '‚úì Meets Target' : '‚ö†Ô∏è Below Target') + '</div>';
  html += '<div style="margin-top:5px">Final Turbidity: <strong>' + optimalJar.turb + ' NTU</strong> (Target: ' + targetTurb + ')</div>';
  html += '<div>Removal: <strong>' + optimalJar.removal.toFixed(1) + '%</strong></div>';
  html += '<div>Floc Quality: <strong>' + getFlocDescription(optimalJar.floc) + '</strong></div>';
  html += '</div>';
  html += '</div>';

  // Results table
  html += '<table class="table" style="margin-bottom:15px">';
  html += '<tbody>';
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä All Jar Results</td></tr>';

  jars.forEach(function(j) {
    var isOptimal = j.jar === optimalJar.jar;
    var rowStyle = isOptimal ? 'background:rgba(74,222,128,0.15)' : '';
    html += '<tr style="' + rowStyle + '">';
    html += '<td>Jar ' + j.jar + (isOptimal ? ' ‚≠ê' : '') + '</td>';
    html += '<td>' + j.coagDose + ' mg/L ‚Üí <strong>' + j.turb + ' NTU</strong></td>';
    html += '<td>' + j.removal.toFixed(1) + '% removal</td>';
    html += '</tr>';
  });

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üí∞ Cost Analysis (at ' + plantFlow + ' MGD)</td></tr>';
  html += '<tr><td>Coagulant Feed Rate</td><td><span class="result">' + coagLbDay.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  if (optPolyDose > 0) {
    html += '<tr><td>Polymer Feed Rate</td><td><span class="result">' + polyLbDay.toFixed(1) + '</span></td><td>lb/day</td></tr>';
  }
  html += '<tr><td>Daily Coagulant Cost</td><td><span class="result">$' + dailyCoagCost.toFixed(2) + '</span></td><td>/day</td></tr>';
  if (dailyPolyCost > 0) {
    html += '<tr><td>Daily Polymer Cost</td><td><span class="result">$' + dailyPolyCost.toFixed(2) + '</span></td><td>/day</td></tr>';
  }
  html += '<tr><td><strong>Total Daily Cost</strong></td><td><span class="result" style="font-size:18px;color:#4ade80">$' + totalDailyCost.toFixed(2) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Cost per 1,000 gal</td><td><span class="result">$' + costPer1000.toFixed(4) + '</span></td><td>/1000 gal</td></tr>';
  html += '<tr><td>Cost per MG</td><td><span class="result">$' + costPerMG.toFixed(2) + '</span></td><td>/MG</td></tr>';
  html += '<tr><td>Monthly Cost (est)</td><td><span class="result">$' + (totalDailyCost * 30).toFixed(0) + '</span></td><td>/month</td></tr>';
  html += '</tbody></table>';

  // Recommendation
  html += '<div class="note success">';
  html += '<strong>üí° Recommendation:</strong> ';
  if (meetsTarget) {
    html += 'Use ' + optCoagDose + ' mg/L ' + getCoagName(coagType);
    if (optPolyDose > 0) html += ' with ' + optPolyDose + ' mg/L polymer';
    html += '. This achieves ' + optimalJar.removal.toFixed(0) + '% turbidity removal at $' + costPer1000.toFixed(4) + '/1000 gal.';
  } else {
    html += 'No tested dose achieved target turbidity of ' + targetTurb + ' NTU. Consider testing higher doses or adding polymer assistance.';
  }
  html += '</div>';

  html += '</div>';

  document.getElementById('jt_results').innerHTML = html;
}

// Get coagulant name
function getCoagName(type) {
  var names = {
    'alum': 'Alum',
    'ferric': 'Ferric Chloride',
    'ferrous': 'Ferrous Sulfate',
    'pac': 'PAC',
    'sodium_aluminate': 'Sodium Aluminate'
  };
  return names[type] || type;
}

// Get floc description
function getFlocDescription(size) {
  var desc = {
    0: 'Not rated',
    1: '1 - Pin floc (poor)',
    2: '2 - Small (fair)',
    3: '3 - Medium (good)',
    4: '4 - Large (very good)',
    5: '5 - Extra large (excellent)'
  };
  return desc[size] || 'Not rated';
}

// Show Jar Test Chart
function showJarTestChart() {
  var container = document.getElementById('jt_chart_container');

  // Collect data
  var labels = [];
  var turbData = [];
  var removalData = [];

  for (var i = 1; i <= 6; i++) {
    var coagDose = parseFloat(document.getElementById('jt_' + i + '_coag').value) || 0;
    var turb = parseFloat(document.getElementById('jt_' + i + '_turb').value);
    var initTurb = parseFloat(document.getElementById('jt_init_turb').value) || 25;

    if (coagDose > 0 && !isNaN(turb)) {
      labels.push(coagDose + ' mg/L');
      turbData.push(turb);
      removalData.push(((initTurb - turb) / initTurb * 100));
    }
  }

  if (labels.length < 2) {
    showToast('Enter results for at least 2 jars', 'warning');
    return;
  }

  container.style.display = 'block';

  var ctx = document.getElementById('jarTestChart').getContext('2d');

  if (window.jarTestChartInstance) {
    window.jarTestChartInstance.destroy();
  }

  window.jarTestChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Final Turbidity (NTU)',
        data: turbData,
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245, 158, 11, 0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 6,
        pointBackgroundColor: '#f59e0b',
        yAxisID: 'y'
      }, {
        label: '% Removal',
        data: removalData,
        borderColor: '#4ade80',
        backgroundColor: 'rgba(74, 222, 128, 0.1)',
        fill: false,
        tension: 0.3,
        pointRadius: 6,
        pointBackgroundColor: '#4ade80',
        yAxisID: 'y1'
      }]
    },
    options: {
      responsive: true,
      interaction: {
        mode: 'index',
        intersect: false
      },
      plugins: {
        legend: {
          display: true,
          labels: { color: '#94a3b8' }
        }
      },
      scales: {
        y: {
          type: 'linear',
          display: true,
          position: 'left',
          title: { display: true, text: 'Turbidity (NTU)', color: '#f59e0b' },
          grid: { color: '#374151' },
          ticks: { color: '#f59e0b' }
        },
        y1: {
          type: 'linear',
          display: true,
          position: 'right',
          title: { display: true, text: '% Removal', color: '#4ade80' },
          grid: { drawOnChartArea: false },
          ticks: { color: '#4ade80' },
          min: 0,
          max: 100
        },
        x: {
          title: { display: true, text: 'Coagulant Dose', color: '#94a3b8' },
          grid: { color: '#374151' },
          ticks: { color: '#94a3b8' }
        }
      }
    }
  });
}

// Save Jar Test
function saveJarTest() {
  var test = {
    date: new Date().toISOString(),
    source: document.getElementById('jt_source').value,
    coagType: document.getElementById('jt_coag_type').value,
    polyType: document.getElementById('jt_poly_type').value,
    initTurb: document.getElementById('jt_init_turb').value,
    initPH: document.getElementById('jt_init_ph').value,
    plantFlow: document.getElementById('jt_plant_flow').value,
    jars: []
  };

  for (var i = 1; i <= 6; i++) {
    var coagDose = parseFloat(document.getElementById('jt_' + i + '_coag').value) || 0;
    var turb = document.getElementById('jt_' + i + '_turb').value;
    if (coagDose > 0 && turb) {
      test.jars.push({
        jar: i,
        coagDose: coagDose,
        polyDose: document.getElementById('jt_' + i + '_poly').value,
        turb: turb,
        floc: document.getElementById('jt_' + i + '_floc').value,
        fph: document.getElementById('jt_' + i + '_fph').value
      });
    }
  }

  var tests = JSON.parse(localStorage.getItem('wwtp_jar_tests') || '[]');
  tests.unshift(test);
  if (tests.length > 50) tests = tests.slice(0, 50);
  localStorage.setItem('wwtp_jar_tests', JSON.stringify(tests));

  showToast('üíæ Jar test saved!', 'success');
}

// Reset Jar Test
function resetJarTest() {
  for (var i = 1; i <= 6; i++) {
    document.getElementById('jt_' + i + '_turb').value = '';
    document.getElementById('jt_' + i + '_ph').value = '';
    document.getElementById('jt_' + i + '_fph').value = '';
    document.getElementById('jt_' + i + '_floc').value = '';
  }
  document.getElementById('jt_results').innerHTML = '';
  document.getElementById('jt_chart_container').style.display = 'none';
  showToast('üîÑ Jar test reset', 'info');
}

// Calculate Syringe Doses for Jar Test
function calcSyringeDoses() {
  var jarVol = parseFloat(document.getElementById('jt_jar_vol').value) || 2000; // mL
  var stockPct = parseFloat(document.getElementById('jt_stock_pct').value) || 1.0; // %
  var syringeSize = parseFloat(document.getElementById('jt_syringe').value) || 10; // mL

  // Stock solution concentration: 1% = 10,000 mg/L
  var stockConc = stockPct * 10000; // mg/L

  // Get coagulant doses from jars
  var html = '<table style="width:100%;font-size:12px;border-collapse:collapse">';
  html += '<tr style="background:#1e3a5f"><th style="padding:5px;text-align:center">Jar</th><th style="padding:5px;text-align:center">Dose (mg/L)</th><th style="padding:5px;text-align:center;color:#4ade80">mL to Add</th><th style="padding:5px;text-align:center">Syringe Marks</th></tr>';

  for (var i = 1; i <= 6; i++) {
    var dose = parseFloat(document.getElementById('jt_' + i + '_coag').value) || 0;
    if (dose > 0) {
      // Formula: mL stock = (dose mg/L √ó jar volume mL) / stock conc mg/L
      var mlToAdd = (dose * jarVol) / stockConc;
      var syringeMarks = mlToAdd / syringeSize * 100; // as % of syringe

      var syringeText = '';
      if (mlToAdd <= syringeSize) {
        syringeText = mlToAdd.toFixed(2) + ' mL';
      } else {
        var fullSyringes = Math.floor(mlToAdd / syringeSize);
        var remainder = mlToAdd % syringeSize;
        syringeText = fullSyringes + '√ó full + ' + remainder.toFixed(2) + ' mL';
      }

      html += '<tr>';
      html += '<td style="padding:5px;text-align:center;font-weight:bold;color:#fbbf24">' + i + '</td>';
      html += '<td style="padding:5px;text-align:center">' + dose + '</td>';
      html += '<td style="padding:5px;text-align:center;color:#4ade80;font-weight:bold">' + mlToAdd.toFixed(2) + '</td>';
      html += '<td style="padding:5px;text-align:center;font-size:11px">' + syringeText + '</td>';
      html += '</tr>';
    }
  }
  html += '</table>';

  html += '<div style="margin-top:8px;padding:8px;background:#243b55;border-radius:6px;font-size:11px">';
  html += '<strong>Formula:</strong> mL = (Dose mg/L √ó ' + jarVol + ' mL) √∑ ' + stockConc.toLocaleString() + ' mg/L';
  html += '<br><strong>Stock:</strong> ' + stockPct + '% = ' + stockConc.toLocaleString() + ' mg/L';
  html += '</div>';

  document.getElementById('jt_syringe_results').innerHTML = html;
}

// Reset All Chemicals Calculators
function resetAllChemicals() {
  if (!confirm('Reset all Chemical Systems calculators to default values?')) return;

  // Chemical Feed Optimizer
  var chemFields = ['chem_flow', 'chem_p_in', 'chem_p_target', 'chem_strength', 'chem_cost'];
  var chemDefaults = [5.0, 6.0, 1.0, 48, 2.50];
  chemFields.forEach(function(id, i) {
    var el = document.getElementById(id);
    if (el) el.value = chemDefaults[i];
  });
  if (document.getElementById('chem_type')) document.getElementById('chem_type').value = 'alum';
  if (document.getElementById('chem_results')) document.getElementById('chem_results').innerHTML = '';

  // Jar Test
  resetJarTest();
  document.getElementById('jt_coag_type').value = 'alum';
  document.getElementById('jt_poly_type').value = 'none';
  document.getElementById('jt_coag_cost').value = '0.15';
  document.getElementById('jt_poly_cost').value = '2.50';
  document.getElementById('jt_plant_flow').value = '5.0';
  document.getElementById('jt_init_turb').value = '25';
  document.getElementById('jt_init_ph').value = '7.2';
  document.getElementById('jt_target_turb').value = '5';
  document.getElementById('jt_jar_vol').value = '2000';
  document.getElementById('jt_stock_pct').value = '1.0';
  document.getElementById('jt_syringe').value = '10';
  document.getElementById('jt_syringe_results').innerHTML = '';
  // Reset jar doses to defaults
  var defaultDoses = [10, 20, 30, 40, 50, 60];
  for (var i = 1; i <= 6; i++) {
    document.getElementById('jt_' + i + '_coag').value = defaultDoses[i-1];
    document.getElementById('jt_' + i + '_poly').value = '0';
    document.getElementById('jt_' + i + '_settle').value = '15';
  }

  // Chlorine Dosing
  var clFields = ['cl_flow', 'cl_dose', 'cl_strength'];
  var clDefaults = [5.0, 5.0, 12.5];
  clFields.forEach(function(id, i) {
    var el = document.getElementById(id);
    if (el) el.value = clDefaults[i];
  });
  if (document.getElementById('cl_results')) document.getElementById('cl_results').innerHTML = '';

  // Polymer Dosing
  var polyFields = ['poly_flow', 'poly_solids', 'poly_dose', 'poly_strength', 'poly_cost'];
  var polyDefaults = [50, 1.0, 8, 0.5, 2.50];
  polyFields.forEach(function(id, i) {
    var el = document.getElementById(id);
    if (el) el.value = polyDefaults[i];
  });
  if (document.getElementById('poly_results')) document.getElementById('poly_results').innerHTML = '';

  showToast('üîÑ All Chemical Systems calculators reset!', 'success');
}

// ========== END JAR TEST OPTIMIZER ==========
// ========== MULTI-METHOD SLUDGE AGE CALCULATOR ==========

// Show method panel
function showSAMethod(method) {
  // Hide all panels
  for (var i = 1; i <= 5; i++) {
    document.getElementById('sa_method_' + i).style.display = 'none';
    document.getElementById('sa_tab_' + i).className = 'btn gray';
    document.getElementById('sa_tab_' + i).style.background = '';
  }
  // Show selected
  document.getElementById('sa_method_' + method).style.display = 'block';
  document.getElementById('sa_tab_' + method).className = 'btn';
  document.getElementById('sa_tab_' + method).style.background = '#8b5cf6';
}

// Method 1: Standard SRT
function calcSA1() {
  var vol = parseFloat(document.getElementById('sa_vol').value) || 1.5;
  var mlss = parseFloat(document.getElementById('sa_mlss').value) || 3000;
  var wasFlow = parseFloat(document.getElementById('sa1_was_flow').value) || 25000;
  var wasTss = parseFloat(document.getElementById('sa1_was_tss').value) || 8000;

  // System solids (lb) = Vol (MG) √ó MLSS (mg/L) √ó 8.34
  var systemSolids = vol * mlss * 8.34;

  // WAS solids (lb/day) = WAS Flow (GPD) √ó WAS TSS (mg/L) √ó 8.34 / 1,000,000
  var wasSolids = (wasFlow * wasTss * 8.34) / 1000000;

  // SRT = System Solids / WAS Solids
  var srt = systemSolids / wasSolids;

  var status = getSRTStatus(srt);

  var html = '<div style="background:#1e3a5f;padding:15px;border-radius:10px">';
  html += '<table class="table"><tbody>';
  html += '<tr><td>System Solids Inventory</td><td><span class="result">' + systemSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  html += '<tr><td>WAS Solids Removed</td><td><span class="result">' + wasSolids.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td><strong>Standard SRT</strong></td><td><span class="result" style="font-size:20px;color:' + status.color + '">' + srt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Status</td><td colspan="2" style="color:' + status.color + '">' + status.icon + ' ' + status.text + '</td></tr>';
  html += '</tbody></table>';
  html += '<div style="margin-top:10px;font-size:12px;opacity:0.7">Formula: SRT = (Vol √ó MLSS √ó 8.34) √∑ (WAS Flow √ó WAS TSS √ó 8.34 √∑ 10‚Å∂)</div>';
  html += '</div>';

  document.getElementById('sa1_result').innerHTML = html;
  return { method: 'Standard SRT', value: srt, status: status };
}

// Method 2: MCRT (with effluent loss)
function calcSA2() {
  var vol = parseFloat(document.getElementById('sa_vol').value) || 1.5;
  var mlss = parseFloat(document.getElementById('sa_mlss').value) || 3000;
  var clarVol = parseFloat(document.getElementById('sa_clar_vol').value) || 0.3;
  var clarTss = parseFloat(document.getElementById('sa_clar_tss').value) || 5000;
  var wasFlow = parseFloat(document.getElementById('sa2_was_flow').value) || 25000;
  var wasTss = parseFloat(document.getElementById('sa2_was_tss').value) || 8000;
  var effFlow = parseFloat(document.getElementById('sa2_eff_flow').value) || 5.0;
  var effTss = parseFloat(document.getElementById('sa2_eff_tss').value) || 10;

  // Total system solids (aeration + clarifier)
  var aerSolids = vol * mlss * 8.34;
  var clarSolids = clarVol * clarTss * 8.34;
  var totalSolids = aerSolids + clarSolids;

  // Solids out
  var wasSolids = (wasFlow * wasTss * 8.34) / 1000000;
  var effSolids = effFlow * effTss * 8.34;
  var totalOut = wasSolids + effSolids;

  // MCRT
  var mcrt = totalSolids / totalOut;

  // Also calc SRT (WAS only) for comparison
  var srt = totalSolids / wasSolids;

  var status = getSRTStatus(mcrt);

  var html = '<div style="background:#1e3a5f;padding:15px;border-radius:10px">';
  html += '<table class="table"><tbody>';
  html += '<tr><td>Aeration Solids</td><td><span class="result">' + aerSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  html += '<tr><td>Clarifier Solids</td><td><span class="result">' + clarSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  html += '<tr><td><strong>Total System Solids</strong></td><td><span class="result">' + totalSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  html += '<tr style="background:#243b55"><td colspan="3"></td></tr>';
  html += '<tr><td>WAS Solids</td><td><span class="result">' + wasSolids.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Effluent Solids Loss</td><td><span class="result">' + effSolids.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Total Solids Out</td><td><span class="result">' + totalOut.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr style="background:#243b55"><td colspan="3"></td></tr>';
  html += '<tr><td><strong>MCRT</strong></td><td><span class="result" style="font-size:20px;color:' + status.color + '">' + mcrt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>SRT (WAS only)</td><td><span class="result">' + srt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Status</td><td colspan="2" style="color:' + status.color + '">' + status.icon + ' ' + status.text + '</td></tr>';
  html += '</tbody></table>';
  html += '</div>';

  document.getElementById('sa2_result').innerHTML = html;
  return { method: 'MCRT', value: mcrt, status: status };
}

// Method 3: Aerobic SRT (nitrification)
function calcSA3() {
  var temp = parseFloat(document.getElementById('sa3_temp').value) || 15;
  var sf = parseFloat(document.getElementById('sa3_sf').value) || 2.0;
  var umax20 = parseFloat(document.getElementById('sa3_umax').value) || 0.75;

  // Temperature correction (theta = 1.07 for nitrifiers)
  var umax = umax20 * Math.pow(1.07, temp - 20);

  // Minimum SRT = 1 / umax
  var minSRT = 1 / umax;

  // Design SRT with safety factor
  var designSRT = minSRT * sf;

  // Recommended SRT at this temperature
  var recSRT = getRecommendedSRT(temp);

  var html = '<div style="background:#1e3a5f;padding:15px;border-radius:10px">';
  html += '<table class="table"><tbody>';
  html += '<tr><td>Design Temperature</td><td><span class="result">' + temp + '</span></td><td>¬∞C</td></tr>';
  html += '<tr><td>Œºmax at 20¬∞C</td><td><span class="result">' + umax20.toFixed(2) + '</span></td><td>1/day</td></tr>';
  html += '<tr><td>Œºmax at ' + temp + '¬∞C</td><td><span class="result">' + umax.toFixed(3) + '</span></td><td>1/day</td></tr>';
  html += '<tr><td>Minimum SRT (no SF)</td><td><span class="result">' + minSRT.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Safety Factor</td><td><span class="result">' + sf + '</span></td><td>√ó</td></tr>';
  html += '<tr><td><strong>Design Aerobic SRT</strong></td><td><span class="result" style="font-size:20px;color:#fbbf24">' + designSRT.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Typical Recommendation</td><td><span class="result">' + recSRT + '</span></td><td>days</td></tr>';
  html += '</tbody></table>';
  html += '<div class="note warning" style="margin-top:10px">‚ö†Ô∏è Operating below minimum SRT will result in nitrifier washout!</div>';
  html += '</div>';

  document.getElementById('sa3_result').innerHTML = html;
  return { method: 'Aerobic SRT', value: designSRT, status: { color: '#fbbf24', text: 'Design Value' } };
}

// Method 4: F/M Based
function calcSA4() {
  var vol = parseFloat(document.getElementById('sa_vol').value) || 1.5;
  var mlvss = parseFloat(document.getElementById('sa_mlvss').value) || 2400;
  var bodLoad = parseFloat(document.getElementById('sa4_bod').value) || 4170;
  var y = parseFloat(document.getElementById('sa4_y').value) || 0.6;
  var kd = parseFloat(document.getElementById('sa4_kd').value) || 0.06;

  // MLVSS mass (lb)
  var mlvssMass = vol * mlvss * 8.34;

  // F/M ratio
  var fm = bodLoad / mlvssMass;

  // Observed yield
  var yObs = y / (1 + kd * (1 / (y * fm - kd)));

  // SRT estimate: SRT ‚âà 1 / (Y √ó F/M - kd)
  var denominator = y * fm - kd;
  var srt = denominator > 0 ? 1 / denominator : 999;

  var status = getSRTStatus(srt);

  var html = '<div style="background:#1e3a5f;padding:15px;border-radius:10px">';
  html += '<table class="table"><tbody>';
  html += '<tr><td>BOD Loading</td><td><span class="result">' + bodLoad.toLocaleString() + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>MLVSS Mass</td><td><span class="result">' + mlvssMass.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb</td></tr>';
  html += '<tr><td>F/M Ratio</td><td><span class="result">' + fm.toFixed(3) + '</span></td><td>lb BOD/lb MLVSS/d</td></tr>';
  html += '<tr><td>Yield Coefficient (Y)</td><td><span class="result">' + y + '</span></td><td>lb VSS/lb BOD</td></tr>';
  html += '<tr><td>Decay Rate (kd)</td><td><span class="result">' + kd + '</span></td><td>1/day</td></tr>';
  html += '<tr><td><strong>Estimated SRT</strong></td><td><span class="result" style="font-size:20px;color:' + status.color + '">' + srt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Status</td><td colspan="2" style="color:' + status.color + '">' + status.icon + ' ' + status.text + '</td></tr>';
  html += '</tbody></table>';
  html += '<div style="margin-top:10px;font-size:12px;opacity:0.7">Formula: SRT ‚âà 1 √∑ (Y √ó F/M - kd)</div>';
  html += '</div>';

  document.getElementById('sa4_result').innerHTML = html;
  return { method: 'F/M Based', value: srt, status: status };
}

// Method 5: Kinetic (Monod)
function calcSA5() {
  var s = parseFloat(document.getElementById('sa5_s').value) || 10;
  var ks = parseFloat(document.getElementById('sa5_ks').value) || 60;
  var umax = parseFloat(document.getElementById('sa5_umax').value) || 3.0;
  var kd = parseFloat(document.getElementById('sa5_kd').value) || 0.06;

  // Specific growth rate at effluent substrate
  var u = (umax * s) / (ks + s);

  // Net growth rate
  var uNet = u - kd;

  // SRT = 1 / uNet (when uNet > 0)
  var srt = uNet > 0 ? 1 / uNet : 999;

  // Also calculate minimum SRT (when S ‚Üí 0)
  var minSRT = (ks + kd * ks / umax) / (umax - kd);

  var status = getSRTStatus(srt);

  var html = '<div style="background:#1e3a5f;padding:15px;border-radius:10px">';
  html += '<table class="table"><tbody>';
  html += '<tr><td>Effluent Substrate (S)</td><td><span class="result">' + s + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Half-saturation (Ks)</td><td><span class="result">' + ks + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Max Growth Rate (Œºmax)</td><td><span class="result">' + umax + '</span></td><td>1/day</td></tr>';
  html += '<tr><td>Specific Growth (Œº)</td><td><span class="result">' + u.toFixed(3) + '</span></td><td>1/day</td></tr>';
  html += '<tr><td>Net Growth (Œº - kd)</td><td><span class="result">' + uNet.toFixed(3) + '</span></td><td>1/day</td></tr>';
  html += '<tr><td><strong>Kinetic SRT</strong></td><td><span class="result" style="font-size:20px;color:' + status.color + '">' + srt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Minimum SRT</td><td><span class="result">' + minSRT.toFixed(2) + '</span></td><td>days</td></tr>';
  html += '</tbody></table>';
  html += '<div style="margin-top:10px;font-size:12px;opacity:0.7">Monod: Œº = Œºmax √ó S √∑ (Ks + S); SRT = 1 √∑ (Œº - kd)</div>';
  html += '</div>';

  document.getElementById('sa5_result').innerHTML = html;
  return { method: 'Kinetic', value: srt, status: status };
}

// Get SRT Status
function getSRTStatus(srt) {
  if (srt < 4) {
    return { color: '#ef4444', icon: '‚ùå', text: 'Too Low - No nitrification, unstable' };
  } else if (srt < 8) {
    return { color: '#fbbf24', icon: '‚ö†Ô∏è', text: 'Low - Marginal nitrification' };
  } else if (srt <= 15) {
    return { color: '#4ade80', icon: '‚úì', text: 'Good - Full nitrification' };
  } else if (srt <= 25) {
    return { color: '#60a5fa', icon: '‚úì', text: 'Extended Aeration range' };
  } else {
    return { color: '#a78bfa', icon: '‚ö†Ô∏è', text: 'Very High - Check for sludge issues' };
  }
}

// Get recommended SRT by temperature
function getRecommendedSRT(temp) {
  if (temp >= 20) return '8-12';
  if (temp >= 15) return '10-15';
  if (temp >= 10) return '15-20';
  if (temp >= 5) return '20-30';
  return '30+';
}

// Compare All Methods
function compareAllSA() {
  var results = [];
  results.push(calcSA1());
  results.push(calcSA2());
  results.push(calcSA3());
  results.push(calcSA4());
  results.push(calcSA5());

  // Calculate average (excluding outliers)
  var values = results.map(r => r.value).filter(v => v < 100);
  var avg = values.reduce((a, b) => a + b, 0) / values.length;
  var min = Math.min(...values);
  var max = Math.max(...values);

  var html = '<div style="background:linear-gradient(135deg,#1e3a5f,#2d4a6f);padding:20px;border-radius:12px;border:2px solid #8b5cf6">';
  html += '<h4 style="margin:0 0 15px 0;color:#8b5cf6">üìä Method Comparison</h4>';

  html += '<table class="table"><thead><tr><th>Method</th><th>SRT (days)</th><th>Status</th></tr></thead><tbody>';
  results.forEach(function(r) {
    html += '<tr>';
    html += '<td>' + r.method + '</td>';
    html += '<td><span class="result" style="color:' + r.status.color + '">' + (r.value < 100 ? r.value.toFixed(1) : 'N/A') + '</span></td>';
    html += '<td style="color:' + r.status.color + '">' + r.status.icon + ' ' + r.status.text + '</td>';
    html += '</tr>';
  });
  html += '</tbody></table>';

  // Summary
  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:12px;color:#94a3b8">Average</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">' + avg.toFixed(1) + '</div>';
  html += '<div style="font-size:12px;color:#94a3b8">days</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:12px;color:#94a3b8">Range</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#60a5fa">' + min.toFixed(1) + ' - ' + max.toFixed(1) + '</div>';
  html += '<div style="font-size:12px;color:#94a3b8">days</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:12px;color:#94a3b8">Variance</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + (max - min).toFixed(1) + '</div>';
  html += '<div style="font-size:12px;color:#94a3b8">days spread</div></div>';
  html += '</div>';

  // Recommendation
  var recommendation = '';
  if (max - min < 3) {
    recommendation = '‚úì Methods agree well. High confidence in SRT estimate.';
  } else if (max - min < 7) {
    recommendation = '‚ö†Ô∏è Some variance between methods. Verify input data.';
  } else {
    recommendation = '‚ùå Large variance. Check data accuracy and clarifier performance.';
  }
  html += '<div class="note info" style="margin-top:15px">' + recommendation + '</div>';

  html += '</div>';

  document.getElementById('sa_comparison').innerHTML = html;
  showToast('All methods calculated!', 'success');
}

// Reset All
function resetAllSA() {
  for (var i = 1; i <= 5; i++) {
    document.getElementById('sa' + i + '_result').innerHTML = '';
  }
  document.getElementById('sa_comparison').innerHTML = '';
  showToast('Sludge Age calculator reset', 'info');
}

// Calculate all on common input change
function calcAllSludgeAge() {
  // Recalculate active method
}

// ========== END MULTI-METHOD SLUDGE AGE CALCULATOR ==========
// ========== COMPREHENSIVE BIOGAS/DIGESTER CALCULATOR ==========

function calcBiogas() {
  // Digester configuration
  var numDig = parseFloat(document.getElementById('bg_num_dig').value) || 2;
  var dia = parseFloat(document.getElementById('bg_dia').value) || 60;
  var swd = parseFloat(document.getElementById('bg_swd').value) || 25;
  var digType = document.getElementById('bg_type').value;
  var temp = parseFloat(document.getElementById('bg_temp').value) || 95;
  var online = parseFloat(document.getElementById('bg_online').value) || 2;

  // Sludge feed
  var psFlow = parseFloat(document.getElementById('bg_ps_flow').value) || 30000;
  var psPct = parseFloat(document.getElementById('bg_ps_pct').value) || 5.0;
  var psVS = parseFloat(document.getElementById('bg_ps_vs').value) || 0.75;
  var wasFlow = parseFloat(document.getElementById('bg_was_flow').value) || 20000;
  var wasPct = parseFloat(document.getElementById('bg_was_pct').value) || 4.0;
  var wasVS = parseFloat(document.getElementById('bg_was_vs').value) || 0.70;

  // Performance
  var vsDest = parseFloat(document.getElementById('bg_vs_dest').value) / 100 || 0.55;
  var gasRate = parseFloat(document.getElementById('bg_gas_rate').value) || 15;
  var ch4Pct = parseFloat(document.getElementById('bg_ch4').value) / 100 || 0.65;

  // Economics
  var chpEff = parseFloat(document.getElementById('bg_chp_eff').value) / 100 || 0.30;
  var elecCost = parseFloat(document.getElementById('bg_elec_cost').value) || 0.10;
  var ngCost = parseFloat(document.getElementById('bg_ng_cost').value) || 1.00;

  // Calculate digester volume
  var areaEach = Math.PI * Math.pow(dia / 2, 2);
  var volEach = areaEach * swd; // cf
  var volTotal = volEach * numDig;
  var volOnline = volEach * online;
  var volGal = volOnline * 7.48;

  // Calculate sludge feed
  var totalFlow = psFlow + wasFlow;

  // Solids calculations
  // lb/day = gpd √ó %solids √ó 8.34
  var psSolids = psFlow * (psPct / 100) * 8.34;
  var psVolatile = psSolids * psVS;
  var wasSolids = wasFlow * (wasPct / 100) * 8.34;
  var wasVolatile = wasSolids * wasVS;

  var totalSolids = psSolids + wasSolids;
  var totalVS = psVolatile + wasVolatile;

  // Loading rates
  var vsLoading = totalVS / volOnline; // lb VS/cf/day
  var hrt = volGal / totalFlow; // days

  // VS destroyed and remaining
  var vsDestroyed = totalVS * vsDest;
  var vsRemaining = totalVS - vsDestroyed;
  var fixedSolids = totalSolids - totalVS;
  var digestedSolids = vsRemaining + fixedSolids;

  // Gas production
  var totalGas = vsDestroyed * gasRate; // cf/day
  var methaneVol = totalGas * ch4Pct;

  // Energy calculations
  var btuTotal = totalGas * 600; // BTU/day (biogas ~600 BTU/cf)
  var btumethane = methaneVol * 1000; // BTU/day (pure CH4 ~1000 BTU/cf)
  var therms = btumethane / 100000;

  // Electrical generation potential (CHP)
  var kwh = (btumethane * chpEff) / 3412; // kWh/day
  var kw = kwh / 24; // continuous kW

  // Economic value
  var elecValue = kwh * elecCost;
  var ngValue = therms * ngCost;
  var annualElec = elecValue * 365;
  var annualNG = ngValue * 365;

  // Status checks
  var vsLoadStatus = getVSLoadingStatus(vsLoading, digType);
  var hrtStatus = getHRTStatus(hrt, digType);

  // Build results HTML
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #f97316">';
  html += '<h4 style="margin:0 0 15px 0;color:#f97316">üî• Digester Analysis Results</h4>';

  // Key metrics display
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Total Volume</div>';
  html += '<div style="font-size:22px;font-weight:bold;color:#60a5fa">' + (volOnline / 1000).toFixed(0) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">cu ft</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">HRT</div>';
  html += '<div style="font-size:22px;font-weight:bold;color:' + hrtStatus.color + '">' + hrt.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">days</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">VS Loading</div>';
  html += '<div style="font-size:22px;font-weight:bold;color:' + vsLoadStatus.color + '">' + vsLoading.toFixed(3) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">lb/cf/d</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Total Gas</div>';
  html += '<div style="font-size:22px;font-weight:bold;color:#4ade80">' + (totalGas / 1000).toFixed(1) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">cf/day</div></div>';
  html += '</div>';

  // Detailed results table
  html += '<table class="table" style="font-size:13px">';
  html += '<tbody>';
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Solids Loading</td></tr>';
  html += '<tr><td>Total Solids Feed</td><td><span class="result">' + totalSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Volatile Solids Feed</td><td><span class="result">' + totalVS.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb VS/day</td></tr>';
  html += '<tr><td>VS Loading Rate</td><td><span class="result" style="color:' + vsLoadStatus.color + '">' + vsLoading.toFixed(3) + '</span></td><td>lb VS/cf/day</td></tr>';
  html += '<tr><td>Status</td><td colspan="2" style="color:' + vsLoadStatus.color + '">' + vsLoadStatus.icon + ' ' + vsLoadStatus.text + '</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">‚è±Ô∏è Hydraulics</td></tr>';
  html += '<tr><td>Total Sludge Flow</td><td><span class="result">' + totalFlow.toLocaleString() + '</span></td><td>gpd</td></tr>';
  html += '<tr><td>Hydraulic Retention Time</td><td><span class="result" style="color:' + hrtStatus.color + '">' + hrt.toFixed(1) + '</span></td><td>days</td></tr>';
  html += '<tr><td>Status</td><td colspan="2" style="color:' + hrtStatus.color + '">' + hrtStatus.icon + ' ' + hrtStatus.text + '</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">üî• Gas Production</td></tr>';
  html += '<tr><td>VS Destroyed</td><td><span class="result">' + vsDestroyed.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb VS/day</td></tr>';
  html += '<tr><td>Total Biogas</td><td><span class="result">' + totalGas.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>cf/day</td></tr>';
  html += '<tr><td>Methane Volume (' + (ch4Pct * 100).toFixed(0) + '%)</td><td><span class="result">' + methaneVol.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>cf CH‚ÇÑ/day</td></tr>';
  html += '<tr><td>Energy Content</td><td><span class="result">' + (btumethane / 1000000).toFixed(2) + '</span></td><td>MMBTU/day</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">‚ö° Energy Recovery</td></tr>';
  html += '<tr><td>CHP Electrical Output</td><td><span class="result">' + kwh.toFixed(0) + '</span></td><td>kWh/day</td></tr>';
  html += '<tr><td>Continuous Power</td><td><span class="result">' + kw.toFixed(1) + '</span></td><td>kW</td></tr>';
  html += '<tr><td>Daily Electric Value</td><td><span class="result" style="color:#4ade80">$' + elecValue.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Equivalent NG Value</td><td><span class="result" style="color:#4ade80">$' + ngValue.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Annual Value (Electric)</td><td><span class="result" style="color:#4ade80;font-size:16px">$' + annualElec.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#ef4444">üóëÔ∏è Digested Sludge</td></tr>';
  html += '<tr><td>Digested Solids</td><td><span class="result">' + digestedSolids.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Solids Reduction</td><td><span class="result">' + ((1 - digestedSolids / totalSolids) * 100).toFixed(1) + '</span></td><td>%</td></tr>';
  html += '</tbody></table>';

  html += '</div>';

  document.getElementById('bg_results').innerHTML = html;
  showToast('Biogas calculated!', 'success');
}

// Calculate Digester Heating Requirements
function calcDigesterHeating() {
  var numDig = parseFloat(document.getElementById('bg_num_dig').value) || 2;
  var dia = parseFloat(document.getElementById('bg_dia').value) || 60;
  var swd = parseFloat(document.getElementById('bg_swd').value) || 25;
  var targetTemp = parseFloat(document.getElementById('bg_temp').value) || 95;
  var online = parseFloat(document.getElementById('bg_online').value) || 2;

  var psFlow = parseFloat(document.getElementById('bg_ps_flow').value) || 30000;
  var wasFlow = parseFloat(document.getElementById('bg_was_flow').value) || 20000;
  var totalFlow = psFlow + wasFlow;

  // Assume feed sludge temp of 60¬∞F and ground temp of 55¬∞F
  var feedTemp = 60;
  var groundTemp = 55;
  var ambientTemp = 50;

  // Digester surface area (cylinder walls + top + bottom)
  var radius = dia / 2;
  var wallArea = Math.PI * dia * swd;
  var topArea = Math.PI * radius * radius;
  var totalArea = wallArea + topArea * 2; // walls + top + bottom

  // Heat loss coefficients (BTU/hr/sf/¬∞F)
  var uWall = 0.12; // insulated concrete
  var uTop = 0.10; // floating cover
  var uBottom = 0.08; // ground contact

  // Heat losses (BTU/hr)
  var heatLossWall = wallArea * uWall * (targetTemp - ambientTemp);
  var heatLossTop = topArea * uTop * (targetTemp - ambientTemp);
  var heatLossBottom = topArea * uBottom * (targetTemp - groundTemp);
  var totalHeatLoss = (heatLossWall + heatLossTop + heatLossBottom) * online;

  // Sludge heating requirement
  // BTU = flow (gpd) √ó 8.34 √ó (target - feed) √ó specific heat (1.0)
  var sludgeHeat = totalFlow * 8.34 * (targetTemp - feedTemp); // BTU/day
  var sludgeHeatHr = sludgeHeat / 24;

  // Total heat required
  var totalHeat = totalHeatLoss + sludgeHeatHr;
  var totalHeatDay = totalHeat * 24;

  // Boiler sizing (80% efficiency)
  var boilerInput = totalHeat / 0.80;
  var boilerHP = boilerInput / 33475; // 1 boiler HP = 33,475 BTU/hr

  // Natural gas usage
  var ngTherms = totalHeatDay / 80000; // 80% efficient boiler
  var ngCost = parseFloat(document.getElementById('bg_ng_cost').value) || 1.00;
  var dailyNGCost = ngTherms * ngCost;

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #fbbf24">';
  html += '<h4 style="margin:0 0 15px 0;color:#fbbf24">üå°Ô∏è Digester Heating Requirements</h4>';

  html += '<table class="table" style="font-size:13px">';
  html += '<tbody>';
  html += '<tr style="background:#243b55"><td colspan="3" style="font-weight:bold;color:#ef4444">üî• Heat Losses</td></tr>';
  html += '<tr><td>Wall Heat Loss</td><td><span class="result">' + (heatLossWall * online / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  html += '<tr><td>Top Heat Loss</td><td><span class="result">' + (heatLossTop * online / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  html += '<tr><td>Bottom Heat Loss</td><td><span class="result">' + (heatLossBottom * online / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  html += '<tr><td><strong>Total Heat Loss</strong></td><td><span class="result">' + (totalHeatLoss / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';

  html += '<tr style="background:#243b55"><td colspan="3" style="font-weight:bold;color:#60a5fa">üì• Sludge Heating</td></tr>';
  html += '<tr><td>Feed Temperature</td><td><span class="result">' + feedTemp + '</span></td><td>¬∞F</td></tr>';
  html += '<tr><td>Target Temperature</td><td><span class="result">' + targetTemp + '</span></td><td>¬∞F</td></tr>';
  html += '<tr><td>Temperature Rise</td><td><span class="result">' + (targetTemp - feedTemp) + '</span></td><td>¬∞F</td></tr>';
  html += '<tr><td>Sludge Heating</td><td><span class="result">' + (sludgeHeatHr / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';

  html += '<tr style="background:#243b55"><td colspan="3" style="font-weight:bold;color:#4ade80">‚öôÔ∏è Equipment Sizing</td></tr>';
  html += '<tr><td><strong>Total Heat Required</strong></td><td><span class="result" style="font-size:16px;color:#fbbf24">' + (totalHeat / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  html += '<tr><td>Boiler Input (80% eff)</td><td><span class="result">' + (boilerInput / 1000).toFixed(1) + '</span></td><td>MBTU/hr</td></tr>';
  html += '<tr><td>Boiler Size</td><td><span class="result">' + boilerHP.toFixed(0) + '</span></td><td>BHP</td></tr>';
  html += '<tr><td>Daily NG Usage</td><td><span class="result">' + ngTherms.toFixed(1) + '</span></td><td>therms/day</td></tr>';
  html += '<tr><td>Daily Heating Cost</td><td><span class="result" style="color:#ef4444">$' + dailyNGCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '</tbody></table>';

  // Net energy check
  var gasProduced = parseFloat(document.getElementById('bg_gas_rate').value) || 15;
  var vsDestPct = parseFloat(document.getElementById('bg_vs_dest').value) / 100 || 0.55;
  var ch4Pct = parseFloat(document.getElementById('bg_ch4').value) / 100 || 0.65;
  var psFlow = parseFloat(document.getElementById('bg_ps_flow').value) || 30000;
  var psPct = parseFloat(document.getElementById('bg_ps_pct').value) / 100 || 0.05;
  var psVS = parseFloat(document.getElementById('bg_ps_vs').value) || 0.75;
  var wasFlow = parseFloat(document.getElementById('bg_was_flow').value) || 20000;
  var wasPct = parseFloat(document.getElementById('bg_was_pct').value) / 100 || 0.04;
  var wasVS = parseFloat(document.getElementById('bg_was_vs').value) || 0.70;

  var totalVS = (psFlow * psPct * 8.34 * psVS) + (wasFlow * wasPct * 8.34 * wasVS);
  var gasEnergy = totalVS * vsDestPct * gasProduced * ch4Pct * 1000; // BTU/day
  var netEnergy = gasEnergy - totalHeatDay;

  if (netEnergy > 0) {
    html += '<div class="note success" style="margin-top:15px">‚úÖ <strong>Energy Positive!</strong> Biogas produces ' + ((gasEnergy - totalHeatDay) / 1000000).toFixed(2) + ' MMBTU/day more than heating requires.</div>';
  } else {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è <strong>Supplemental Heat Needed.</strong> Heating requires ' + (Math.abs(netEnergy) / 1000000).toFixed(2) + ' MMBTU/day more than biogas produces.</div>';
  }

  html += '</div>';

  document.getElementById('bg_heating_results').innerHTML = html;
}

// Get VS Loading status
function getVSLoadingStatus(vsLoad, digType) {
  var limits = {
    'standard': { low: 0.03, high: 0.10 },
    'high': { low: 0.15, high: 0.40 },
    'two_stage': { low: 0.25, high: 0.50 },
    'egg': { low: 0.20, high: 0.45 }
  };
  var lim = limits[digType] || limits.high;

  if (vsLoad < lim.low) {
    return { color: '#60a5fa', icon: '‚¨áÔ∏è', text: 'Underloaded - capacity available' };
  } else if (vsLoad <= lim.high) {
    return { color: '#4ade80', icon: '‚úì', text: 'Good - within design range' };
  } else {
    return { color: '#ef4444', icon: '‚ö†Ô∏è', text: 'Overloaded - risk of upset' };
  }
}

// Get HRT status
function getHRTStatus(hrt, digType) {
  var minHRT = {
    'standard': 30,
    'high': 15,
    'two_stage': 10,
    'egg': 15
  };
  var min = minHRT[digType] || 15;

  if (hrt < min * 0.8) {
    return { color: '#ef4444', icon: '‚ö†Ô∏è', text: 'Too short - incomplete digestion' };
  } else if (hrt < min) {
    return { color: '#fbbf24', icon: '‚ö†Ô∏è', text: 'Marginal - monitor closely' };
  } else {
    return { color: '#4ade80', icon: '‚úì', text: 'Adequate retention time' };
  }
}

// Reset biogas calculator
function resetBiogas() {
  document.getElementById('bg_results').innerHTML = '';
  document.getElementById('bg_heating_results').innerHTML = '';
  showToast('Biogas calculator reset', 'info');
}

// ========== END BIOGAS/DIGESTER CALCULATOR ==========
// ========== COMPREHENSIVE UV DISINFECTION CALCULATOR ==========

// Update defaults based on UV system type
function updateUVDefaults() {
  var type = document.getElementById('uv_type').value;
  var lampCost = document.getElementById('uv_lamp_cost');
  var lampLife = document.getElementById('uv_lamp_life');
  var elf = document.getElementById('uv_elf');

  switch(type) {
    case 'lp':
      lampCost.value = '100';
      lampLife.value = '12000';
      elf.value = '0.7';
      break;
    case 'lpho':
      lampCost.value = '150';
      lampLife.value = '12000';
      elf.value = '0.7';
      break;
    case 'mp':
      lampCost.value = '500';
      lampLife.value = '4000';
      elf.value = '0.6';
      break;
  }
  calcUVSystem();
}

// Update dose based on application and pathogen
function updateUVDose() {
  var app = document.getElementById('uv_app').value;
  var pathogen = document.getElementById('uv_pathogen').value;
  var dose = document.getElementById('uv_dose');
  var uvt = document.getElementById('uv_uvt');
  var logRed = document.getElementById('uv_log');

  // Set typical UVT by application
  switch(app) {
    case 'secondary': uvt.value = '60'; break;
    case 'tertiary': uvt.value = '70'; break;
    case 'reuse': uvt.value = '75'; break;
    case 'drinking': uvt.value = '95'; break;
  }

  // Set dose by pathogen
  var doseTable = {
    'ecoli': 25,
    'fecal': 40,
    'entero': 50,
    'crypto': 12,
    'giardia': 11,
    'virus': 186
  };

  dose.value = doseTable[pathogen] || 40;

  // Adjust for reuse
  if (app === 'reuse') {
    dose.value = Math.max(100, parseFloat(dose.value));
    logRed.value = '5';
  }

  calcUVSystem();
}

// Main UV system calculation
function calcUVSystem() {
  // Get inputs
  var flow = parseFloat(document.getElementById('uv_flow').value) || 5.0;
  var pf = parseFloat(document.getElementById('uv_pf').value) || 2.0;
  var channels = parseFloat(document.getElementById('uv_channels').value) || 2;
  var uvType = document.getElementById('uv_type').value;
  var redund = document.getElementById('uv_redund').value;

  var uvt = parseFloat(document.getElementById('uv_uvt').value) || 65;
  var tss = parseFloat(document.getElementById('uv_tss').value) || 10;

  var dose = parseFloat(document.getElementById('uv_dose').value) || 40;
  var logRed = parseFloat(document.getElementById('uv_log').value) || 4;
  var elf = parseFloat(document.getElementById('uv_elf').value) || 0.7;
  var ff = parseFloat(document.getElementById('uv_ff').value) || 0.8;
  var sf = parseFloat(document.getElementById('uv_sf').value) || 1.2;

  var elecCost = parseFloat(document.getElementById('uv_elec').value) || 0.10;
  var lampCost = parseFloat(document.getElementById('uv_lamp_cost').value) || 150;
  var lampLife = parseFloat(document.getElementById('uv_lamp_life').value) || 12000;

  // Calculate peak flow
  var peakFlow = flow * pf;
  var flowPerChannel = peakFlow / channels;
  var flowGPM = flowPerChannel * 694.4; // MGD to GPM

  // Adjusted dose (accounting for factors)
  var adjustedDose = dose * sf / (elf * ff);

  // UVT correction factor (lower UVT = more lamps needed)
  var uvtFactor = Math.pow(65 / uvt, 1.5);

  // Lamp characteristics by type
  var lampSpecs = {
    'lp': { power: 65, output: 25, name: 'Low Pressure' },      // 65W, 25 W/lamp effective
    'lpho': { power: 250, output: 80, name: 'LP High Output' }, // 250W, 80 W/lamp effective
    'mp': { power: 3000, output: 300, name: 'Medium Pressure' } // 3000W, 300 W/lamp effective
  };
  var lamp = lampSpecs[uvType];

  // Estimate lamps per channel based on flow and dose
  // Simplified: ~1 LPHO lamp per 100 GPM at 40 mJ/cm¬≤ with 65% UVT
  var baseLampsPerGPM = {
    'lp': 0.02,     // 50 GPM per lamp
    'lpho': 0.01,   // 100 GPM per lamp
    'mp': 0.002     // 500 GPM per lamp
  };

  var lampsPerChannel = Math.ceil(flowGPM * baseLampsPerGPM[uvType] * (adjustedDose / 40) * uvtFactor);
  lampsPerChannel = Math.max(lampsPerChannel, 4); // Minimum 4 lamps per bank

  // Apply redundancy
  var totalChannels = channels;
  if (redund === 'n1') totalChannels += 1;
  if (redund === 'n2') totalChannels += 2;

  var totalLamps = lampsPerChannel * totalChannels;
  var activeLamps = lampsPerChannel * channels;

  // Power consumption
  var powerPerChannel = lampsPerChannel * lamp.power / 1000; // kW
  var totalPower = powerPerChannel * channels; // Only active channels
  var peakPower = powerPerChannel * totalChannels; // All channels

  // Operating costs
  var hoursPerYear = 8760;
  var annualKWH = totalPower * hoursPerYear;
  var annualElecCost = annualKWH * elecCost;

  // Lamp replacement
  var replacementsPerYear = hoursPerYear / lampLife;
  var lampsPerYear = activeLamps * replacementsPerYear;
  var annualLampCost = lampsPerYear * lampCost;

  var totalAnnualCost = annualElecCost + annualLampCost;
  var costPerMG = totalAnnualCost / (flow * 365);

  // UV status check
  var uvtStatus = getUVTStatus(uvt);
  var tssStatus = tss <= 10 ? { color: '#4ade80', text: 'Good' } : (tss <= 20 ? { color: '#fbbf24', text: 'Marginal' } : { color: '#ef4444', text: 'High - pretreat' });

  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #06b6d4">';
  html += '<h4 style="margin:0 0 15px 0;color:#06b6d4">‚òÄÔ∏è UV System Design Results</h4>';

  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Total Lamps</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#06b6d4">' + totalLamps + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">' + lamp.name + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Channels</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">' + totalChannels + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">(' + channels + ' active)</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Power</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + totalPower.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">kW</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Annual Cost</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#a78bfa">$' + (totalAnnualCost / 1000).toFixed(1) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/year</div></div>';
  html += '</div>';

  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';
  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä System Sizing</td></tr>';
  html += '<tr><td>Peak Design Flow</td><td><span class="result">' + peakFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Flow per Channel</td><td><span class="result">' + flowGPM.toFixed(0) + '</span></td><td>GPM</td></tr>';
  html += '<tr><td>Lamps per Channel</td><td><span class="result">' + lampsPerChannel + '</span></td><td>lamps</td></tr>';
  html += '<tr><td>Total Lamps (with redund.)</td><td><span class="result">' + totalLamps + '</span></td><td>lamps</td></tr>';
  html += '<tr><td>Lamp Type</td><td colspan="2">' + lamp.name + ' (' + lamp.power + 'W)</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">‚ò¢Ô∏è Dose Calculations</td></tr>';
  html += '<tr><td>Target Dose</td><td><span class="result">' + dose + '</span></td><td>mJ/cm¬≤</td></tr>';
  html += '<tr><td>Adjusted Dose (with factors)</td><td><span class="result">' + adjustedDose.toFixed(1) + '</span></td><td>mJ/cm¬≤</td></tr>';
  html += '<tr><td>Target Log Reduction</td><td><span class="result">' + logRed + '</span></td><td>log</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">üíß Water Quality</td></tr>';
  html += '<tr><td>UVT</td><td><span class="result" style="color:' + uvtStatus.color + '">' + uvt + '%</span></td><td>' + uvtStatus.text + '</td></tr>';
  html += '<tr><td>TSS</td><td><span class="result" style="color:' + tssStatus.color + '">' + tss + ' mg/L</span></td><td>' + tssStatus.text + '</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">üí∞ Operating Costs</td></tr>';
  html += '<tr><td>Power Consumption</td><td><span class="result">' + totalPower.toFixed(1) + '</span></td><td>kW</td></tr>';
  html += '<tr><td>Annual Energy</td><td><span class="result">' + (annualKWH / 1000).toFixed(0) + '</span></td><td>MWh/yr</td></tr>';
  html += '<tr><td>Annual Electric Cost</td><td><span class="result">$' + annualElecCost.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Lamp Replacements</td><td><span class="result">' + lampsPerYear.toFixed(0) + '</span></td><td>lamps/yr</td></tr>';
  html += '<tr><td>Annual Lamp Cost</td><td><span class="result">$' + annualLampCost.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td><strong>Total Annual Cost</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + totalAnnualCost.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Cost per MG Treated</td><td><span class="result">$' + costPerMG.toFixed(2) + '</span></td><td>/MG</td></tr>';
  html += '</tbody></table>';

  html += '</div>';

  document.getElementById('uv_results').innerHTML = html;
  showToast('UV system calculated!', 'success');
}

// Compare LP vs MP systems
function compareUVSystems() {
  var flow = parseFloat(document.getElementById('uv_flow').value) || 5.0;
  var uvt = parseFloat(document.getElementById('uv_uvt').value) || 65;
  var dose = parseFloat(document.getElementById('uv_dose').value) || 40;
  var channels = parseFloat(document.getElementById('uv_channels').value) || 2;

  // Calculate for each type
  var systems = [
    { type: 'LP', power: 65, output: 25, cost: 100, life: 12000, lampsPerGPM: 0.02 },
    { type: 'LPHO', power: 250, output: 80, cost: 150, life: 12000, lampsPerGPM: 0.01 },
    { type: 'MP', power: 3000, output: 300, cost: 500, life: 4000, lampsPerGPM: 0.002 }
  ];

  var flowGPM = flow * 694.4 / channels;
  var uvtFactor = Math.pow(65 / uvt, 1.5);
  var elecCost = parseFloat(document.getElementById('uv_elec').value) || 0.10;

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #a78bfa">';
  html += '<h4 style="margin:0 0 15px 0;color:#a78bfa">üìä UV System Comparison</h4>';

  html += '<table class="table" style="font-size:13px">';
  html += '<thead><tr><th>Parameter</th><th>LP</th><th>LPHO</th><th>MP</th></tr></thead>';
  html += '<tbody>';

  var results = systems.map(function(s) {
    var lamps = Math.ceil(flowGPM * s.lampsPerGPM * (dose / 40) * uvtFactor) * channels;
    lamps = Math.max(lamps, 4 * channels);
    var power = lamps * s.power / 1000;
    var annualElec = power * 8760 * elecCost;
    var annualLamps = (lamps * 8760 / s.life) * s.cost;
    var annualTotal = annualElec + annualLamps;
    return { ...s, lamps, power, annualElec, annualLamps, annualTotal };
  });

  html += '<tr><td>Total Lamps</td>';
  results.forEach(r => html += '<td><span class="result">' + r.lamps + '</span></td>');
  html += '</tr>';

  html += '<tr><td>Power (kW)</td>';
  results.forEach(r => html += '<td><span class="result">' + r.power.toFixed(1) + '</span></td>');
  html += '</tr>';

  html += '<tr><td>Electric Cost ($/yr)</td>';
  results.forEach(r => html += '<td>$' + (r.annualElec / 1000).toFixed(1) + 'K</td>');
  html += '</tr>';

  html += '<tr><td>Lamp Cost ($/yr)</td>';
  results.forEach(r => html += '<td>$' + (r.annualLamps / 1000).toFixed(1) + 'K</td>');
  html += '</tr>';

  // Find lowest cost
  var minCost = Math.min(...results.map(r => r.annualTotal));
  html += '<tr style="background:#243b55"><td><strong>Total Annual</strong></td>';
  results.forEach(r => {
    var highlight = r.annualTotal === minCost ? 'color:#4ade80;font-weight:bold' : '';
    html += '<td style="' + highlight + '">$' + (r.annualTotal / 1000).toFixed(1) + 'K' + (r.annualTotal === minCost ? ' ‚úì' : '') + '</td>';
  });
  html += '</tr>';

  html += '</tbody></table>';

  // Recommendation
  var best = results.find(r => r.annualTotal === minCost);
  html += '<div class="note info" style="margin-top:15px">üí° <strong>Recommendation:</strong> ' + best.type + ' system has lowest annual operating cost for this application.</div>';

  html += '</div>';

  document.getElementById('uv_comparison').innerHTML = html;
}

// Get UVT status
function getUVTStatus(uvt) {
  if (uvt >= 75) return { color: '#4ade80', text: 'Excellent' };
  if (uvt >= 65) return { color: '#60a5fa', text: 'Good' };
  if (uvt >= 55) return { color: '#fbbf24', text: 'Fair - more lamps needed' };
  return { color: '#ef4444', text: 'Poor - pretreat recommended' };
}

// Reset UV calculator
function resetUVSystem() {
  document.getElementById('uv_results').innerHTML = '';
  document.getElementById('uv_comparison').innerHTML = '';
  showToast('UV calculator reset', 'info');
}

// Keep old calcUV for backwards compatibility
function calcUV() { calcUVSystem(); }
function resetUV() { resetUVSystem(); }

// ========== END UV DISINFECTION CALCULATOR ==========
// ========== COMPREHENSIVE NUTRIENT BALANCE CALCULATOR ==========

// Update defaults based on process type
function updateNBDefaults() {
  var process = document.getElementById('nb_process').value;
  var srt = document.getElementById('nb_srt');
  var anoxic = document.getElementById('nb_anoxic');
  var ir = document.getElementById('nb_ir');

  switch(process) {
    case 'conv':
      srt.value = '5'; anoxic.value = '0'; ir.value = '0';
      break;
    case 'nit':
      srt.value = '12'; anoxic.value = '0'; ir.value = '0';
      break;
    case 'ndn':
      srt.value = '15'; anoxic.value = '33'; ir.value = '3';
      break;
    case 'bnr':
      srt.value = '15'; anoxic.value = '40'; ir.value = '4';
      break;
    case 'ebpr':
      srt.value = '12'; anoxic.value = '50'; ir.value = '4';
      break;
  }
  calcNutrientBalance();
}

// Main nutrient balance calculation
function calcNutrientBalance() {
  // Get inputs
  var flow = parseFloat(document.getElementById('nb_flow').value) || 5.0;
  var bod = parseFloat(document.getElementById('nb_bod').value) || 200;
  var tss = parseFloat(document.getElementById('nb_tss').value) || 220;
  var tkn = parseFloat(document.getElementById('nb_tkn').value) || 40;
  var nh3 = parseFloat(document.getElementById('nb_nh3').value) || 28;
  var orgN = parseFloat(document.getElementById('nb_orgn').value) || 12;
  var tp = parseFloat(document.getElementById('nb_tp').value) || 7;
  var op = parseFloat(document.getElementById('nb_op').value) || 5;
  var temp = parseFloat(document.getElementById('nb_temp').value) || 20;

  var process = document.getElementById('nb_process').value;
  var srt = parseFloat(document.getElementById('nb_srt').value) || 12;
  var mlss = parseFloat(document.getElementById('nb_mlss').value) || 3000;
  var anoxicPct = parseFloat(document.getElementById('nb_anoxic').value) / 100 || 0.33;
  var ir = parseFloat(document.getElementById('nb_ir').value) || 3;
  var ras = parseFloat(document.getElementById('nb_ras').value) || 0.5;

  var nh3Lim = parseFloat(document.getElementById('nb_nh3_lim').value) || 2;
  var tnLim = parseFloat(document.getElementById('nb_tn_lim').value) || 10;
  var tpLim = parseFloat(document.getElementById('nb_tp_lim').value) || 1;

  var carbonSource = document.getElementById('nb_carbon').value;
  var pChem = document.getElementById('nb_pchem').value;
  var alkAvail = parseFloat(document.getElementById('nb_alk').value) || 200;

  // Loadings (lb/day)
  var bodLoad = flow * bod * 8.34;
  var tknLoad = flow * tkn * 8.34;
  var nh3Load = flow * nh3 * 8.34;
  var tpLoad = flow * tp * 8.34;

  // BOD:N:P Ratio check
  var bodnRatio = bod / tkn;
  var bodpRatio = bod / tp;
  var nRatioStatus = bodnRatio >= 20 ? { color: '#4ade80', text: 'Adequate carbon' } : { color: '#fbbf24', text: 'May need carbon supplement' };
  var pRatioStatus = bodpRatio >= 100 ? { color: '#4ade80', text: 'Adequate' } : { color: '#fbbf24', text: 'Check P removal' };

  // Nitrogen pathway calculations
  var nitrificationEff = 0;
  var denitrificationEff = 0;
  var effNH3 = nh3;
  var effNO3 = 0;
  var effTN = tkn;

  // Temperature correction for nitrification
  var minSRT = 1 / (0.75 * Math.pow(1.07, temp - 20));

  if (process !== 'conv' && srt > minSRT) {
    // Nitrification occurs
    nitrificationEff = Math.min(95, 85 + (srt - minSRT) * 2);
    var nh3Oxidized = nh3 * (nitrificationEff / 100);
    effNH3 = nh3 - nh3Oxidized;
    effNO3 = nh3Oxidized + orgN * 0.8; // Some org-N also nitrified

    // Denitrification (if anoxic zone present)
    if (anoxicPct > 0) {
      // Denitrification efficiency based on IR ratio and anoxic fraction
      var denitrificationPotential = (ir + ras) / (1 + ir + ras);
      denitrificationEff = Math.min(90, denitrificationPotential * 100 * anoxicPct * 3);
      var no3Removed = effNO3 * (denitrificationEff / 100);
      effNO3 = effNO3 - no3Removed;
    }

    effTN = effNH3 + effNO3 + (orgN * 0.1); // Residual org-N
  }

  // Phosphorus pathway
  var bioPRemoval = 0;
  var chemPRemoval = 0;
  var effTP = tp;

  // Bio-P removal estimate (in EBPR or BNR process)
  if (process === 'ebpr' || process === 'bnr') {
    bioPRemoval = Math.min(tp * 0.8, bod * 0.015); // ~1.5% of BOD as P uptake
    effTP = tp - bioPRemoval;
  }

  // Check if chemical P removal needed
  var chemPNeeded = effTP - tpLim;
  if (chemPNeeded > 0 && pChem !== 'none') {
    chemPRemoval = chemPNeeded;
    effTP = tpLim;
  }

  // Alkalinity balance
  var alkConsumed = nh3 * (nitrificationEff / 100) * 7.14; // 7.14 mg alk/mg N
  var alkRecovered = (effNO3 > 0 ? nh3 * (nitrificationEff / 100) * (denitrificationEff / 100) * 3.57 : 0);
  var alkNet = alkAvail - alkConsumed + alkRecovered;
  var alkStatus = alkNet > 50 ? { color: '#4ade80', text: 'Adequate' } : (alkNet > 0 ? { color: '#fbbf24', text: 'Marginal' } : { color: '#ef4444', text: 'Supplement needed' });

  // Oxygen demand
  var o2BOD = bodLoad * 1.5; // 1.5 lb O2/lb BOD
  var o2Nit = tknLoad * 4.6 * (nitrificationEff / 100); // 4.6 lb O2/lb N
  var o2Credit = tknLoad * (nitrificationEff / 100) * (denitrificationEff / 100) * 2.86; // Denit credit
  var totalO2 = o2BOD + o2Nit - o2Credit;

  // Carbon requirement for denitrification
  var carbonReq = 0;
  var carbonCost = 0;
  if (denitrificationEff > 0) {
    var no3ToRemove = flow * effNO3 * 8.34 * (denitrificationEff / (100 - denitrificationEff));
    carbonReq = no3ToRemove * 3.0; // ~3 lb methanol/lb NO3-N
    if (carbonSource === 'methanol') carbonCost = carbonReq * 0.50;
    else if (carbonSource === 'acetate') carbonCost = carbonReq * 0.80;
    else if (carbonSource === 'glycerol') carbonCost = carbonReq * 0.60;
  }

  // Chemical P cost
  var pChemCost = 0;
  var pChemDose = 0;
  if (chemPRemoval > 0 && pChem !== 'none') {
    pChemDose = flow * chemPRemoval * 8.34 * (pChem === 'alum' ? 10 : 5);
    pChemCost = pChemDose * (pChem === 'alum' ? 0.15 : 0.20);
  }

  // Compliance check
  var nh3Compliant = effNH3 <= nh3Lim;
  var tnCompliant = effTN <= tnLim;
  var tpCompliant = effTP <= tpLim;

  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #22c55e">';
  html += '<h4 style="margin:0 0 15px 0;color:#22c55e">üåø Nutrient Balance Results</h4>';

  // Compliance summary cards
  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:' + (nh3Compliant ? '#065f46' : '#7f1d1d') + ';padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;opacity:0.8">Effluent NH‚ÇÉ-N</div>';
  html += '<div style="font-size:18px;font-weight:bold">' + effNH3.toFixed(1) + '</div>';
  html += '<div style="font-size:11px">Limit: ' + nh3Lim + ' mg/L ' + (nh3Compliant ? '‚úì' : '‚úó') + '</div></div>';
  html += '<div style="background:' + (tnCompliant ? '#065f46' : '#7f1d1d') + ';padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;opacity:0.8">Effluent TN</div>';
  html += '<div style="font-size:18px;font-weight:bold">' + effTN.toFixed(1) + '</div>';
  html += '<div style="font-size:11px">Limit: ' + tnLim + ' mg/L ' + (tnCompliant ? '‚úì' : '‚úó') + '</div></div>';
  html += '<div style="background:' + (tpCompliant ? '#065f46' : '#7f1d1d') + ';padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;opacity:0.8">Effluent TP</div>';
  html += '<div style="font-size:18px;font-weight:bold">' + effTP.toFixed(1) + '</div>';
  html += '<div style="font-size:11px">Limit: ' + tpLim + ' mg/L ' + (tpCompliant ? '‚úì' : '‚úó') + '</div></div>';
  html += '</div>';

  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Influent Ratios</td></tr>';
  html += '<tr><td>BOD:N Ratio</td><td><span class="result">' + bodnRatio.toFixed(1) + ':1</span></td><td style="color:' + nRatioStatus.color + '">' + nRatioStatus.text + '</td></tr>';
  html += '<tr><td>BOD:P Ratio</td><td><span class="result">' + bodpRatio.toFixed(0) + ':1</span></td><td style="color:' + pRatioStatus.color + '">' + pRatioStatus.text + '</td></tr>';
  html += '<tr><td>BOD:N:P</td><td colspan="2"><span class="result">' + (bod/tp).toFixed(0) + ':' + (tkn/tp).toFixed(1) + ':1</span> (ideal ~100:5:1)</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üß™ Nitrogen Balance</td></tr>';
  html += '<tr><td>Nitrification Efficiency</td><td><span class="result">' + nitrificationEff.toFixed(0) + '%</span></td><td>' + (process === 'conv' ? 'Not designed' : (srt > minSRT ? 'SRT adequate' : 'Increase SRT')) + '</td></tr>';
  html += '<tr><td>Denitrification Efficiency</td><td><span class="result">' + denitrificationEff.toFixed(0) + '%</span></td><td>' + (anoxicPct > 0 ? 'IR=' + ir + ', Anoxic=' + (anoxicPct*100).toFixed(0) + '%' : 'No anoxic zone') + '</td></tr>';
  html += '<tr><td>Effluent NH‚ÇÉ-N</td><td><span class="result" style="color:' + (nh3Compliant ? '#4ade80' : '#ef4444') + '">' + effNH3.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Effluent NO‚ÇÉ-N</td><td><span class="result">' + effNO3.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Effluent TN</td><td><span class="result" style="color:' + (tnCompliant ? '#4ade80' : '#ef4444') + '">' + effTN.toFixed(1) + '</span></td><td>mg/L</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">üî¨ Phosphorus Balance</td></tr>';
  html += '<tr><td>Bio-P Removal</td><td><span class="result">' + bioPRemoval.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Chemical P Removal</td><td><span class="result">' + chemPRemoval.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Effluent TP</td><td><span class="result" style="color:' + (tpCompliant ? '#4ade80' : '#ef4444') + '">' + effTP.toFixed(1) + '</span></td><td>mg/L</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">‚öóÔ∏è Alkalinity Balance</td></tr>';
  html += '<tr><td>Alkalinity Consumed (Nit)</td><td><span class="result">' + alkConsumed.toFixed(0) + '</span></td><td>mg/L as CaCO‚ÇÉ</td></tr>';
  html += '<tr><td>Alkalinity Recovered (Denit)</td><td><span class="result">' + alkRecovered.toFixed(0) + '</span></td><td>mg/L as CaCO‚ÇÉ</td></tr>';
  html += '<tr><td>Net Alkalinity</td><td><span class="result" style="color:' + alkStatus.color + '">' + alkNet.toFixed(0) + '</span></td><td>' + alkStatus.text + '</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#ef4444">üí® Oxygen Demand</td></tr>';
  html += '<tr><td>BOD Oxidation</td><td><span class="result">' + o2BOD.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb O‚ÇÇ/day</td></tr>';
  html += '<tr><td>Nitrification</td><td><span class="result">' + o2Nit.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb O‚ÇÇ/day</td></tr>';
  html += '<tr><td>Denitrification Credit</td><td><span class="result">-' + o2Credit.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb O‚ÇÇ/day</td></tr>';
  html += '<tr><td><strong>Total O‚ÇÇ Demand</strong></td><td><span class="result" style="font-size:16px;color:#60a5fa">' + totalO2.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>lb O‚ÇÇ/day</td></tr>';

  html += '</tbody></table>';

  // Recommendations
  var recs = [];
  if (!nh3Compliant) recs.push('Increase SRT or lower loading for better nitrification');
  if (!tnCompliant && anoxicPct < 0.4) recs.push('Increase anoxic fraction or internal recycle for TN');
  if (!tpCompliant && pChem === 'none') recs.push('Add chemical P removal to meet TP limit');
  if (alkNet < 50) recs.push('Monitor alkalinity - may need supplementation');
  if (recs.length > 0) {
    html += '<div class="note warning" style="margin-top:15px"><strong>‚ö†Ô∏è Recommendations:</strong><ul style="margin:5px 0 0 20px">';
    recs.forEach(r => html += '<li>' + r + '</li>');
    html += '</ul></div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ System meets all nutrient limits!</div>';
  }

  html += '</div>';

  document.getElementById('nb_results').innerHTML = html;
  showToast('Nutrient balance calculated!', 'success');
}

// Show nutrient flow diagram
function showNutrientDiagram() {
  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px">';
  html += '<h4 style="margin:0 0 15px 0;color:#22c55e">üìä Nitrogen & Phosphorus Pathways</h4>';

  // Simple text diagram
  html += '<div style="font-family:monospace;font-size:12px;background:#0f172a;padding:15px;border-radius:8px;overflow-x:auto">';
  html += '<pre style="margin:0;color:#94a3b8">';
  html += '           INFLUENT                     EFFLUENT\n';
  html += '              ‚îÇ                            ‚îÇ\n';
  html += '     TKN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ [AEROBIC] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚ñ∫ NH‚ÇÉ-N (residual)\n';
  html += '     (NH‚ÇÉ+Org)‚îÇ         ‚îÇ                 ‚îÇ\n';
  html += '              ‚îÇ         ‚ñº                 ‚îÇ\n';
  html += '              ‚îÇ      NO‚ÇÉ-N ‚îÄ‚îÄ‚ñ∫ [ANOXIC]‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚ñ∫ NO‚ÇÉ-N (residual)\n';
  html += '              ‚îÇ                   ‚îÇ       ‚îÇ\n';
  html += '              ‚îÇ                   ‚ñº       ‚îÇ\n';
  html += '              ‚îÇ                  N‚ÇÇ ‚Üë     ‚îÇ\n';
  html += '              ‚îÇ                 (gas)     ‚îÇ\n';
  html += '              ‚îÇ                           ‚îÇ\n';
  html += '     TP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ [BIO-P] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚ñ∫ TP (effluent)\n';
  html += '              ‚îÇ         ‚îÇ                 ‚îÇ\n';
  html += '              ‚îÇ    [CHEM-P]‚îÄ‚îÄ‚îÄ‚ñ∫ Sludge    ‚îÇ\n';
  html += '              ‚îÇ                           ‚îÇ\n';
  html += '</pre>';
  html += '</div>';

  html += '<div style="margin-top:15px;display:grid;grid-template-columns:repeat(2,1fr);gap:15px">';
  html += '<div style="background:#243b55;padding:10px;border-radius:8px">';
  html += '<strong style="color:#4ade80">Nitrogen Pathway:</strong><br>';
  html += '<span style="font-size:12px">TKN ‚Üí NH‚ÇÉ ‚Üí NO‚ÇÉ ‚Üí N‚ÇÇ(g)</span>';
  html += '</div>';
  html += '<div style="background:#243b55;padding:10px;border-radius:8px">';
  html += '<strong style="color:#a78bfa">Phosphorus Pathway:</strong><br>';
  html += '<span style="font-size:12px">TP ‚Üí Bio-P uptake ‚Üí Sludge/Effluent</span>';
  html += '</div>';
  html += '</div>';

  html += '</div>';

  document.getElementById('nb_diagram').innerHTML = html;
}

// Reset nutrient balance calculator
function resetNutrientBalance() {
  document.getElementById('nb_results').innerHTML = '';
  document.getElementById('nb_diagram').innerHTML = '';
  showToast('Nutrient calculator reset', 'info');
}

// ========== END NUTRIENT BALANCE CALCULATOR ==========
// ========== WET WEATHER & I/I CALCULATOR ==========

function calcWetWeather() {
  // Get inputs
  var dwf = parseFloat(document.getElementById('ww_dwf').value) || 5.0;
  var minFlow = parseFloat(document.getElementById('ww_min').value) || 3.0;
  var maxDry = parseFloat(document.getElementById('ww_max_dry').value) || 7.0;
  var area = parseFloat(document.getElementById('ww_area').value) || 5000;
  var pop = parseFloat(document.getElementById('ww_pop').value) || 50000;
  var sewerMi = parseFloat(document.getElementById('ww_sewer_mi').value) || 100;

  var wwf = parseFloat(document.getElementById('ww_wwf').value) || 15.0;
  var duration = parseFloat(document.getElementById('ww_duration').value) || 6;
  var rain = parseFloat(document.getElementById('ww_rain').value) || 1.5;
  var recurrence = document.getElementById('ww_recurrence').value;
  var gw = document.getElementById('ww_gw').value;
  var season = document.getElementById('ww_season').value;

  var capacity = parseFloat(document.getElementById('ww_capacity').value) || 10.0;
  var peakCap = parseFloat(document.getElementById('ww_peak_cap').value) || 15.0;
  var bypassThresh = parseFloat(document.getElementById('ww_bypass').value) || 18.0;
  var storage = parseFloat(document.getElementById('ww_storage').value) || 2.0;
  var bodDry = parseFloat(document.getElementById('ww_bod_dry').value) || 200;
  var bodLim = parseFloat(document.getElementById('ww_bod_lim').value) || 30;

  // Calculate flow metrics
  var peakingFactor = wwf / dwf;
  var excessFlow = wwf - dwf;
  var iiFlow = wwf - maxDry; // I&I = wet weather - max dry weather
  var iiPercent = (iiFlow / wwf) * 100;

  // Per-unit I&I rates
  var iiPerMile = (iiFlow * 1000000) / sewerMi;
  var iiPerCapita = (iiFlow * 1000000) / pop;
  var rdii = (iiFlow * 1000000) / (rain * area); // RDII = gal/in/acre

  // Capacity analysis
  var capacityUsed = (wwf / peakCap) * 100;
  var headroom = peakCap - wwf;
  var bypassRisk = wwf >= bypassThresh;
  var storageHours = (storage * 1000000) / ((wwf - capacity) * 1000000 / 24);
  if (wwf <= capacity) storageHours = 999; // No storage needed

  // Volume calculations
  var totalWWVolume = wwf * (duration / 24); // MG during storm
  var excessVolume = (wwf - capacity) * (duration / 24);
  if (excessVolume < 0) excessVolume = 0;

  // Dilution impact
  var dilutionFactor = dwf / wwf;
  var bodWet = bodDry * dilutionFactor;
  var treatmentMargin = (bodLim / bodWet) * 100;

  // Status checks
  var peakingStatus = getPeakingStatus(peakingFactor);
  var iiMileStatus = getIIMileStatus(iiPerMile);
  var capacityStatus = getCapacityStatus(capacityUsed);

  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #0ea5e9">';
  html += '<h4 style="margin:0 0 15px 0;color:#0ea5e9">üåßÔ∏è Wet Weather Analysis Results</h4>';

  // Key metrics cards
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Peaking Factor</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + peakingStatus.color + '">' + peakingFactor.toFixed(1) + 'x</div>';
  html += '<div style="font-size:11px;color:' + peakingStatus.color + '">' + peakingStatus.text + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">I&I Flow</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#f97316">' + iiFlow.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">MGD</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Capacity Used</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + capacityStatus.color + '">' + capacityUsed.toFixed(0) + '%</div>';
  html += '<div style="font-size:11px;color:' + capacityStatus.color + '">' + capacityStatus.text + '</div></div>';
  html += '<div style="background:' + (bypassRisk ? '#7f1d1d' : '#065f46') + ';padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;opacity:0.8">SSO/Bypass Risk</div>';
  html += '<div style="font-size:18px;font-weight:bold">' + (bypassRisk ? '‚ö†Ô∏è HIGH' : '‚úì LOW') + '</div>';
  html += '<div style="font-size:11px;opacity:0.8">' + (bypassRisk ? 'Exceeds threshold' : 'Within capacity') + '</div></div>';
  html += '</div>';

  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Flow Analysis</td></tr>';
  html += '<tr><td>Dry Weather Flow</td><td><span class="result">' + dwf.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Peak Wet Weather Flow</td><td><span class="result">' + wwf.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Excess Flow (WWF - DWF)</td><td><span class="result">' + excessFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Peaking Factor</td><td><span class="result" style="color:' + peakingStatus.color + '">' + peakingFactor.toFixed(2) + '</span></td><td>√ó</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#f97316">üíß I&I Metrics</td></tr>';
  html += '<tr><td>I&I Flow (WWF - Max Dry)</td><td><span class="result">' + iiFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>I&I Percentage</td><td><span class="result">' + iiPercent.toFixed(1) + '</span></td><td>%</td></tr>';
  html += '<tr><td>I&I per Mile of Sewer</td><td><span class="result" style="color:' + iiMileStatus.color + '">' + iiPerMile.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>gpd/mi</td></tr>';
  html += '<tr><td>I&I per Capita</td><td><span class="result">' + iiPerCapita.toFixed(0) + '</span></td><td>gpd/cap</td></tr>';
  html += '<tr><td>RDII</td><td><span class="result">' + rdii.toFixed(0) + '</span></td><td>gal/in/acre</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üè≠ Capacity Analysis</td></tr>';
  html += '<tr><td>Design Capacity</td><td><span class="result">' + capacity.toFixed(1) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Peak Hydraulic Capacity</td><td><span class="result">' + peakCap.toFixed(1) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Capacity Used</td><td><span class="result" style="color:' + capacityStatus.color + '">' + capacityUsed.toFixed(0) + '%</span></td><td></td></tr>';
  html += '<tr><td>Headroom</td><td><span class="result">' + headroom.toFixed(1) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Storage Time @ Peak</td><td><span class="result">' + (storageHours < 100 ? storageHours.toFixed(1) : 'N/A') + '</span></td><td>hours</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">üß™ Treatment Impact</td></tr>';
  html += '<tr><td>Dilution Factor</td><td><span class="result">' + dilutionFactor.toFixed(2) + '</span></td><td></td></tr>';
  html += '<tr><td>Influent BOD (wet weather)</td><td><span class="result">' + bodWet.toFixed(0) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Effluent BOD Limit</td><td><span class="result">' + bodLim + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>Treatment Margin</td><td><span class="result">' + treatmentMargin.toFixed(0) + '</span></td><td>%</td></tr>';

  html += '</tbody></table>';

  // Recommendations
  var recs = [];
  if (peakingFactor > 4) recs.push('High peaking factor suggests significant I&I - investigate sources');
  if (iiPerMile > 10000) recs.push('I&I rate exceeds 10,000 gpd/mi - consider rehabilitation program');
  if (capacityUsed > 100) recs.push('Peak flow exceeds hydraulic capacity - storage or capacity expansion needed');
  if (bypassRisk) recs.push('SSO/bypass risk - implement flow equalization or reduce I&I');
  if (storageHours < 2 && storageHours > 0) recs.push('Limited storage time - consider additional equalization');

  if (recs.length > 0) {
    html += '<div class="note warning" style="margin-top:15px"><strong>‚ö†Ô∏è Recommendations:</strong><ul style="margin:5px 0 0 20px">';
    recs.forEach(r => html += '<li>' + r + '</li>');
    html += '</ul></div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ System within capacity for this storm event.</div>';
  }

  html += '</div>';

  document.getElementById('ww_results').innerHTML = html;
  showToast('Wet weather analysis complete!', 'success');
}

// Calculate detailed I&I analysis
function calcIandI() {
  var dwf = parseFloat(document.getElementById('ww_dwf').value) || 5.0;
  var minFlow = parseFloat(document.getElementById('ww_min').value) || 3.0;
  var maxDry = parseFloat(document.getElementById('ww_max_dry').value) || 7.0;
  var wwf = parseFloat(document.getElementById('ww_wwf').value) || 15.0;
  var sewerMi = parseFloat(document.getElementById('ww_sewer_mi').value) || 100;
  var pop = parseFloat(document.getElementById('ww_pop').value) || 50000;
  var gw = document.getElementById('ww_gw').value;

  // Base wastewater flow (from min flow)
  var bwf = minFlow * 0.9; // ~90% of min is base

  // Groundwater infiltration (chronic)
  var gwiFactor = { low: 0.1, normal: 0.2, high: 0.35 }[gw] || 0.2;
  var gwi = (dwf - bwf) * gwiFactor;

  // Direct inflow (storm-related)
  var directInflow = wwf - maxDry;

  // RDII (Rainfall Derived I&I)
  var rdii = wwf - dwf - gwi;
  if (rdii < 0) rdii = 0;

  // Total I&I
  var totalII = gwi + directInflow;

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #f97316">';
  html += '<h4 style="margin:0 0 15px 0;color:#f97316">üíß I&I Breakdown Analysis</h4>';

  html += '<table class="table" style="font-size:13px"><tbody>';
  html += '<tr><td>Base Wastewater Flow</td><td><span class="result">' + bwf.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Groundwater Infiltration (GWI)</td><td><span class="result">' + gwi.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Direct Inflow (storm)</td><td><span class="result">' + directInflow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>RDII (Rainfall Derived)</td><td><span class="result">' + rdii.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr style="background:#243b55"><td><strong>Total I&I</strong></td><td><span class="result" style="font-size:16px;color:#f97316">' + totalII.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '</tbody></table>';

  // I&I Component chart (text-based)
  html += '<div style="margin-top:15px;background:#0f172a;padding:15px;border-radius:8px">';
  html += '<div style="font-size:12px;color:#94a3b8;margin-bottom:10px">I&I Component Distribution:</div>';
  var gwiPct = (gwi / totalII) * 100 || 0;
  var inflowPct = (directInflow / totalII) * 100 || 0;
  html += '<div style="display:flex;height:24px;border-radius:4px;overflow:hidden">';
  html += '<div style="width:' + gwiPct + '%;background:#3b82f6" title="GWI ' + gwiPct.toFixed(0) + '%"></div>';
  html += '<div style="width:' + inflowPct + '%;background:#f97316" title="Inflow ' + inflowPct.toFixed(0) + '%"></div>';
  html += '</div>';
  html += '<div style="display:flex;justify-content:space-between;font-size:11px;margin-top:5px">';
  html += '<span style="color:#3b82f6">‚ñ† GWI: ' + gwiPct.toFixed(0) + '%</span>';
  html += '<span style="color:#f97316">‚ñ† Direct Inflow: ' + inflowPct.toFixed(0) + '%</span>';
  html += '</div>';
  html += '</div>';

  html += '</div>';

  document.getElementById('ww_ii_results').innerHTML = html;
}

// Calculate storage requirements
function calcStorageNeeded() {
  var wwf = parseFloat(document.getElementById('ww_wwf').value) || 15.0;
  var capacity = parseFloat(document.getElementById('ww_capacity').value) || 10.0;
  var duration = parseFloat(document.getElementById('ww_duration').value) || 6;
  var storage = parseFloat(document.getElementById('ww_storage').value) || 2.0;

  var excessFlow = wwf - capacity;
  if (excessFlow < 0) excessFlow = 0;

  var storageNeeded = excessFlow * (duration / 24); // MG
  var additionalNeeded = storageNeeded - storage;
  if (additionalNeeded < 0) additionalNeeded = 0;

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #a78bfa">';
  html += '<h4 style="margin:0 0 15px 0;color:#a78bfa">üèóÔ∏è Storage Requirements</h4>';

  html += '<table class="table" style="font-size:13px"><tbody>';
  html += '<tr><td>Excess Flow Rate</td><td><span class="result">' + excessFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Storm Duration</td><td><span class="result">' + duration + '</span></td><td>hours</td></tr>';
  html += '<tr><td>Storage Volume Needed</td><td><span class="result">' + storageNeeded.toFixed(2) + '</span></td><td>MG</td></tr>';
  html += '<tr><td>Existing Storage</td><td><span class="result">' + storage.toFixed(2) + '</span></td><td>MG</td></tr>';
  html += '<tr style="background:#243b55"><td><strong>Additional Storage Needed</strong></td><td><span class="result" style="font-size:16px;color:' + (additionalNeeded > 0 ? '#ef4444' : '#4ade80') + '">' + additionalNeeded.toFixed(2) + '</span></td><td>MG</td></tr>';
  html += '</tbody></table>';

  if (additionalNeeded > 0) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Need ' + additionalNeeded.toFixed(2) + ' MG additional storage (' + (additionalNeeded * 1000000).toLocaleString() + ' gallons) to handle this storm event without bypass.</div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ Existing storage sufficient for this storm event.</div>';
  }

  html += '</div>';

  document.getElementById('ww_ii_results').innerHTML = html;
}

// Status helpers
function getPeakingStatus(pf) {
  if (pf <= 2.5) return { color: '#4ade80', text: 'Normal' };
  if (pf <= 3.5) return { color: '#fbbf24', text: 'Elevated' };
  if (pf <= 5) return { color: '#f97316', text: 'High I&I likely' };
  return { color: '#ef4444', text: 'Severe I&I' };
}

function getIIMileStatus(ii) {
  if (ii <= 3000) return { color: '#4ade80', text: 'Low' };
  if (ii <= 6000) return { color: '#fbbf24', text: 'Moderate' };
  if (ii <= 10000) return { color: '#f97316', text: 'High' };
  return { color: '#ef4444', text: 'Excessive' };
}

function getCapacityStatus(pct) {
  if (pct <= 75) return { color: '#4ade80', text: 'Good' };
  if (pct <= 90) return { color: '#fbbf24', text: 'Elevated' };
  if (pct <= 100) return { color: '#f97316', text: 'At capacity' };
  return { color: '#ef4444', text: 'Over capacity' };
}

function resetWetWeather() {
  document.getElementById('ww_results').innerHTML = '';
  document.getElementById('ww_ii_results').innerHTML = '';
  showToast('Wet weather calculator reset', 'info');
}

// ========== END WET WEATHER CALCULATOR ==========
// ========== SEPTAGE RECEIVING CALCULATOR ==========

// Update defaults based on septage type
function updateSeptageDefaults() {
  var type = document.getElementById('sep_type').value;
  var bod = document.getElementById('sep_bod');
  var tss = document.getElementById('sep_tss');
  var tkn = document.getElementById('sep_tkn');
  var nh3 = document.getElementById('sep_nh3');
  var fog = document.getElementById('sep_fog');

  var defaults = {
    'residential': { bod: 6000, tss: 15000, tkn: 700, nh3: 400, fog: 8000 },
    'commercial': { bod: 3000, tss: 8000, tkn: 300, nh3: 150, fog: 5000 },
    'grease': { bod: 50000, tss: 25000, tkn: 100, nh3: 50, fog: 100000 },
    'portable': { bod: 10000, tss: 25000, tkn: 1000, nh3: 600, fog: 4000 },
    'mixed': { bod: 8000, tss: 18000, tkn: 500, nh3: 300, fog: 15000 }
  };

  var d = defaults[type] || defaults.residential;
  bod.value = d.bod;
  tss.value = d.tss;
  tkn.value = d.tkn;
  nh3.value = d.nh3;
  fog.value = d.fog;

  calcSeptage();
}

// Main septage calculation
function calcSeptage() {
  // Plant baseline
  var designFlow = parseFloat(document.getElementById('sep_design').value) || 5.0;
  var currentFlow = parseFloat(document.getElementById('sep_flow').value) || 4.0;
  var availPct = parseFloat(document.getElementById('sep_avail').value) || 20;
  var bodLoad = parseFloat(document.getElementById('sep_bod_load').value) || 6000;
  var bodCap = parseFloat(document.getElementById('sep_bod_cap').value) || 8000;
  var tssLoad = parseFloat(document.getElementById('sep_tss_load').value) || 5500;

  // Septage characteristics
  var sepBod = parseFloat(document.getElementById('sep_bod').value) || 6000;
  var sepTss = parseFloat(document.getElementById('sep_tss').value) || 15000;
  var sepTkn = parseFloat(document.getElementById('sep_tkn').value) || 700;
  var sepNh3 = parseFloat(document.getElementById('sep_nh3').value) || 400;
  var sepFog = parseFloat(document.getElementById('sep_fog').value) || 8000;

  // Receiving operations
  var truckSize = parseFloat(document.getElementById('sep_truck').value) || 3000;
  var trucksPerDay = parseFloat(document.getElementById('sep_trucks').value) || 10;
  var opHours = parseFloat(document.getElementById('sep_hours').value) || 8;
  var recRate = parseFloat(document.getElementById('sep_rate').value) || 200;
  var maxVol = parseFloat(document.getElementById('sep_max_vol').value) || 50000;

  // Economics
  var tipFee = parseFloat(document.getElementById('sep_fee').value) || 0.08;
  var treatCost = parseFloat(document.getElementById('sep_cost').value) || 0.02;

  // Calculate daily septage volume
  var dailyVol = Math.min(truckSize * trucksPerDay, maxVol);
  var dailyVolMG = dailyVol / 1000000;

  // Calculate loadings from septage
  var sepBodLoad = dailyVol * sepBod * 8.34 / 1000000; // lb/day
  var sepTssLoad = dailyVol * sepTss * 8.34 / 1000000;
  var sepTknLoad = dailyVol * sepTkn * 8.34 / 1000000;
  var sepFogLoad = dailyVol * sepFog * 8.34 / 1000000;

  // Plant loading after septage
  var totalBodLoad = bodLoad + sepBodLoad;
  var bodCapUsed = (totalBodLoad / bodCap) * 100;

  // Flow impact
  var totalFlow = currentFlow + dailyVolMG;
  var flowCapUsed = (totalFlow / designFlow) * 100;

  // Slug loading check (if all discharged in one hour)
  var slugBod = (truckSize * sepBod * 8.34) / 1000000; // lb per truck
  var avgHourlyBod = bodLoad / 24;
  var slugFactor = slugBod / avgHourlyBod;

  // Economics
  var dailyRevenue = dailyVol * tipFee;
  var dailyCost = dailyVol * treatCost;
  var dailyProfit = dailyRevenue - dailyCost;
  var annualRevenue = dailyRevenue * 365;
  var annualProfit = dailyProfit * 365;

  // Time to discharge
  var dischargeTime = dailyVol / recRate; // minutes total
  var trucksPerHour = 60 / (truckSize / recRate);

  // Status checks
  var bodStatus = getBodLoadStatus(bodCapUsed);
  var flowStatus = getFlowLoadStatus(flowCapUsed);
  var slugStatus = getSlugStatus(slugFactor);

  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #84cc16">';
  html += '<h4 style="margin:0 0 15px 0;color:#84cc16">üöõ Septage Receiving Analysis</h4>';

  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Daily Volume</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#84cc16">' + (dailyVol/1000).toFixed(0) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">gallons</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">BOD Added</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + sepBodLoad.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">lb/day</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">BOD Capacity</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + bodStatus.color + '">' + bodCapUsed.toFixed(0) + '%</div>';
  html += '<div style="font-size:11px;color:' + bodStatus.color + '">' + bodStatus.text + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Daily Profit</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">$' + dailyProfit.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/day</div></div>';
  html += '</div>';

  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Volume & Operations</td></tr>';
  html += '<tr><td>Daily Septage Volume</td><td><span class="result">' + dailyVol.toLocaleString() + '</span></td><td>gal/day</td></tr>';
  html += '<tr><td>Trucks per Day</td><td><span class="result">' + trucksPerDay + '</span></td><td>trucks</td></tr>';
  html += '<tr><td>Trucks per Hour (at ' + recRate + ' GPM)</td><td><span class="result">' + trucksPerHour.toFixed(1) + '</span></td><td>trucks/hr</td></tr>';
  html += '<tr><td>Total Discharge Time</td><td><span class="result">' + (dischargeTime/60).toFixed(1) + '</span></td><td>hours</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">‚öñÔ∏è Loading Impacts</td></tr>';
  html += '<tr><td>BOD Load Added</td><td><span class="result">' + sepBodLoad.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>TSS Load Added</td><td><span class="result">' + sepTssLoad.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>TKN Load Added</td><td><span class="result">' + sepTknLoad.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>FOG Load Added</td><td><span class="result">' + sepFogLoad.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Total Plant BOD</td><td><span class="result">' + totalBodLoad.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>BOD Capacity Used</td><td><span class="result" style="color:' + bodStatus.color + '">' + bodCapUsed.toFixed(0) + '%</span></td><td>' + bodStatus.text + '</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#ef4444">‚ö° Slug Loading</td></tr>';
  html += '<tr><td>BOD per Truck</td><td><span class="result">' + slugBod.toFixed(0) + '</span></td><td>lb</td></tr>';
  html += '<tr><td>Avg Hourly BOD (plant)</td><td><span class="result">' + avgHourlyBod.toFixed(0) + '</span></td><td>lb/hr</td></tr>';
  html += '<tr><td>Slug Factor</td><td><span class="result" style="color:' + slugStatus.color + '">' + slugFactor.toFixed(1) + 'x</span></td><td>' + slugStatus.text + '</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üí∞ Economics</td></tr>';
  html += '<tr><td>Daily Revenue</td><td><span class="result">$' + dailyRevenue.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Daily Treatment Cost</td><td><span class="result">$' + dailyCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Daily Net Profit</td><td><span class="result" style="color:#4ade80">$' + dailyProfit.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Annual Revenue</td><td><span class="result">$' + annualRevenue.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td><strong>Annual Profit</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + annualProfit.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';

  html += '</tbody></table>';

  // Recommendations
  var recs = [];
  if (bodCapUsed > 90) recs.push('BOD loading near capacity - consider reducing septage volume');
  if (slugFactor > 3) recs.push('High slug loading potential - spread deliveries throughout day');
  if (sepFogLoad > 500) recs.push('Significant FOG load - ensure adequate grease removal');
  if (dailyProfit < 0) recs.push('Operating at a loss - increase tipping fee or reduce costs');

  if (recs.length > 0) {
    html += '<div class="note warning" style="margin-top:15px"><strong>‚ö†Ô∏è Recommendations:</strong><ul style="margin:5px 0 0 20px">';
    recs.forEach(r => html += '<li>' + r + '</li>');
    html += '</ul></div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ Septage receiving within plant capacity and profitable.</div>';
  }

  html += '</div>';

  document.getElementById('sep_results').innerHTML = html;
  showToast('Septage analysis complete!', 'success');
}

// Calculate maximum septage capacity
function calcSeptageCapacity() {
  var bodLoad = parseFloat(document.getElementById('sep_bod_load').value) || 6000;
  var bodCap = parseFloat(document.getElementById('sep_bod_cap').value) || 8000;
  var sepBod = parseFloat(document.getElementById('sep_bod').value) || 6000;

  var availBod = bodCap - bodLoad;
  var maxSeptageVol = (availBod * 1000000) / (sepBod * 8.34);
  var maxTrucks = maxSeptageVol / (parseFloat(document.getElementById('sep_truck').value) || 3000);

  var tipFee = parseFloat(document.getElementById('sep_fee').value) || 0.08;
  var maxRevenue = maxSeptageVol * tipFee;

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #a78bfa">';
  html += '<h4 style="margin:0 0 15px 0;color:#a78bfa">üìä Maximum Septage Capacity</h4>';

  html += '<table class="table" style="font-size:13px"><tbody>';
  html += '<tr><td>Available BOD Capacity</td><td><span class="result">' + availBod.toFixed(0) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Max Septage Volume</td><td><span class="result" style="font-size:16px;color:#84cc16">' + maxSeptageVol.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>gal/day</td></tr>';
  html += '<tr><td>Max Trucks per Day</td><td><span class="result">' + maxTrucks.toFixed(0) + '</span></td><td>trucks</td></tr>';
  html += '<tr><td>Max Daily Revenue</td><td><span class="result" style="color:#4ade80">$' + maxRevenue.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '</tbody></table>';

  html += '<div class="note info" style="margin-top:15px">üí° Based on BOD loading capacity. Also consider TSS, TKN, and operational constraints.</div>';

  html += '</div>';

  document.getElementById('sep_results').innerHTML += html;
}

// Status helpers
function getBodLoadStatus(pct) {
  if (pct <= 70) return { color: '#4ade80', text: 'Good capacity' };
  if (pct <= 85) return { color: '#fbbf24', text: 'Moderate' };
  if (pct <= 100) return { color: '#f97316', text: 'Near capacity' };
  return { color: '#ef4444', text: 'Over capacity' };
}

function getFlowLoadStatus(pct) {
  if (pct <= 80) return { color: '#4ade80', text: 'Good' };
  if (pct <= 95) return { color: '#fbbf24', text: 'Elevated' };
  return { color: '#ef4444', text: 'At/over capacity' };
}

function getSlugStatus(factor) {
  if (factor <= 1.5) return { color: '#4ade80', text: 'Minimal impact' };
  if (factor <= 3) return { color: '#fbbf24', text: 'Moderate slug' };
  return { color: '#ef4444', text: 'High slug risk' };
}

function resetSeptage() {
  document.getElementById('sep_results').innerHTML = '';
  showToast('Septage calculator reset', 'info');
}

// ========== END SEPTAGE RECEIVING CALCULATOR ==========
// ========== BELT PRESS / CENTRIFUGE CALCULATOR ==========

// Update defaults based on equipment type
function updateDewateringDefaults() {
  var type = document.getElementById('dw_type').value;
  var cakePct = document.getElementById('dw_cake_pct');
  var capture = document.getElementById('dw_capture');
  var polyDose = document.getElementById('dw_poly_dose');
  var hydLoad = document.getElementById('dw_hyd_load');
  var solLoad = document.getElementById('dw_sol_load');

  var defaults = {
    'bfp': { cake: 22, capture: 95, poly: 12, hydLoad: 75, solLoad: 1000 },
    'centrifuge': { cake: 25, capture: 95, poly: 20, hydLoad: 100, solLoad: 1500 },
    'screw': { cake: 20, capture: 92, poly: 8, hydLoad: 50, solLoad: 600 },
    'plate': { cake: 35, capture: 98, poly: 8, hydLoad: 30, solLoad: 400 }
  };

  var d = defaults[type] || defaults.bfp;
  cakePct.value = d.cake;
  capture.value = d.capture;
  polyDose.value = d.poly;
  hydLoad.value = d.hydLoad;
  solLoad.value = d.solLoad;

  calcDewatering2();
}

// Update defaults based on sludge type
function updateSludgeDefaults() {
  var sludge = document.getElementById('dw_sludge').value;
  var feedPct = document.getElementById('dw_feed_pct');
  var vsRatio = document.getElementById('dw_vs_ratio');
  var polyDose = document.getElementById('dw_poly_dose');
  var cakePct = document.getElementById('dw_cake_pct');

  var defaults = {
    'primary': { feed: 4.5, vs: 0.75, poly: 6, cake: 30 },
    'was': { feed: 4.0, vs: 0.80, poly: 20, cake: 18 },
    'mixed': { feed: 3.5, vs: 0.70, poly: 12, cake: 22 },
    'digested': { feed: 3.0, vs: 0.55, poly: 15, cake: 25 },
    'aerobic': { feed: 2.5, vs: 0.65, poly: 18, cake: 20 }
  };

  var d = defaults[sludge] || defaults.mixed;
  feedPct.value = d.feed;
  vsRatio.value = d.vs;
  polyDose.value = d.poly;
  cakePct.value = d.cake;

  calcDewatering2();
}

// Main dewatering calculation
function calcDewatering2() {
  // Equipment config
  var equipType = document.getElementById('dw_type').value;
  var units = parseFloat(document.getElementById('dw_units').value) || 2;
  var inService = parseFloat(document.getElementById('dw_service').value) || 1;
  var size = parseFloat(document.getElementById('dw_size').value) || 2.0;
  var opHours = parseFloat(document.getElementById('dw_hours').value) || 8;
  var opDays = parseFloat(document.getElementById('dw_days').value) || 5;

  // Feed characteristics
  var feedGPM = parseFloat(document.getElementById('dw_feed_gpm').value) || 150;
  var feedPct = parseFloat(document.getElementById('dw_feed_pct').value) / 100 || 0.035;
  var dailyVol = parseFloat(document.getElementById('dw_daily_vol').value) || 72000;
  var vsRatio = parseFloat(document.getElementById('dw_vs_ratio').value) || 0.70;
  var sg = parseFloat(document.getElementById('dw_sg').value) || 1.02;

  // Performance
  var cakePct = parseFloat(document.getElementById('dw_cake_pct').value) / 100 || 0.22;
  var capture = parseFloat(document.getElementById('dw_capture').value) / 100 || 0.95;
  var hydLoad = parseFloat(document.getElementById('dw_hyd_load').value) || 75;
  var solLoad = parseFloat(document.getElementById('dw_sol_load').value) || 1000;

  // Polymer
  var polyDose = parseFloat(document.getElementById('dw_poly_dose').value) || 12;
  var polySoln = parseFloat(document.getElementById('dw_poly_soln').value) / 100 || 0.0025;
  var polyCost = parseFloat(document.getElementById('dw_poly_cost').value) || 2.50;
  var washGPM = parseFloat(document.getElementById('dw_wash').value) || 80;
  var elecCost = parseFloat(document.getElementById('dw_elec_cost').value) || 0.10;

  // Disposal
  var dispCost = parseFloat(document.getElementById('dw_disp_cost').value) || 50;
  var truckCY = parseFloat(document.getElementById('dw_truck_cy').value) || 20;

  // Calculate feed solids
  var feedLbHr = feedGPM * 60 * 8.34 * sg * feedPct; // lb dry solids/hr
  var feedDryTonHr = feedLbHr / 2000;

  // Daily processing (based on daily volume)
  var dailySolidsLb = dailyVol * 8.34 * sg * feedPct;
  var dailyDryTon = dailySolidsLb / 2000;

  // Required run time
  var reqRunTime = dailySolidsLb / feedLbHr;

  // Cake production
  var capturedSolids = feedLbHr * capture;
  var cakeLbHr = capturedSolids / cakePct; // wet cake
  var cakeTonHr = cakeLbHr / 2000;

  // Daily cake
  var dailyCakeLb = dailySolidsLb * capture / cakePct;
  var dailyCakeTon = dailyCakeLb / 2000;
  var dailyCakeCY = dailyCakeTon / 0.6; // ~0.6 tons/CY for cake

  // Centrate/filtrate
  var centrateSolids = feedLbHr * (1 - capture);
  var centrateTSS = (centrateSolids / (feedGPM * 60 * 8.34)) * 1000000; // mg/L

  // Polymer usage
  var polyLbHr = feedDryTonHr * polyDose;
  var polyGPH = polyLbHr / (polySoln * 8.34);
  var dailyPolyLb = dailyDryTon * polyDose;
  var dailyPolyCost = dailyPolyLb * polyCost;

  // Loading rates
  var actualHydLoad = feedGPM / (size * inService);
  var actualSolLoad = feedLbHr / (size * inService);

  // Energy (equipment-specific)
  var kWhPerDT = { 'bfp': 15, 'centrifuge': 45, 'screw': 10, 'plate': 8 }[equipType] || 15;
  var dailyKWh = dailyDryTon * kWhPerDT;
  var dailyElecCost = dailyKWh * elecCost;

  // Wash water
  var dailyWashGal = washGPM * 60 * opHours;

  // Disposal
  var dailyDispCost = dailyCakeTon * dispCost;
  var trucksPerDay = dailyCakeCY / truckCY;

  // Total daily cost
  var totalDailyCost = dailyPolyCost + dailyElecCost + dailyDispCost;
  var costPerDryTon = totalDailyCost / dailyDryTon;
  var annualCost = totalDailyCost * opDays * 52;

  // Status checks
  var hydLoadStatus = getHydLoadStatus(actualHydLoad, hydLoad);
  var solLoadStatus = getSolLoadStatus(actualSolLoad, solLoad);
  var captureStatus = capture >= 0.95 ? { color: '#4ade80', text: 'Excellent' } : (capture >= 0.90 ? { color: '#fbbf24', text: 'Good' } : { color: '#ef4444', text: 'Low' });

  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #ec4899">';
  html += '<h4 style="margin:0 0 15px 0;color:#ec4899">üóúÔ∏è Dewatering Analysis Results</h4>';

  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Feed Rate</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#ec4899">' + feedLbHr.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">lb DS/hr</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Cake Produced</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">' + dailyCakeTon.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">wet tons/day</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Capture</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + captureStatus.color + '">' + (capture * 100).toFixed(0) + '%</div>';
  html += '<div style="font-size:11px;color:' + captureStatus.color + '">' + captureStatus.text + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Cost</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">$' + costPerDryTon.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/dry ton</div></div>';
  html += '</div>';

  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Feed & Production</td></tr>';
  html += '<tr><td>Feed Solids Rate</td><td><span class="result">' + feedLbHr.toFixed(0) + '</span></td><td>lb DS/hr</td></tr>';
  html += '<tr><td>Daily Dry Solids</td><td><span class="result">' + dailyDryTon.toFixed(2) + '</span></td><td>dry tons/day</td></tr>';
  html += '<tr><td>Required Run Time</td><td><span class="result">' + reqRunTime.toFixed(1) + '</span></td><td>hours</td></tr>';
  html += '<tr><td>Cake Production</td><td><span class="result">' + cakeLbHr.toFixed(0) + '</span></td><td>lb wet/hr</td></tr>';
  html += '<tr><td>Daily Cake Volume</td><td><span class="result">' + dailyCakeCY.toFixed(1) + '</span></td><td>cubic yards</td></tr>';
  html += '<tr><td>Trucks per Day</td><td><span class="result">' + trucksPerDay.toFixed(1) + '</span></td><td>trucks</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üìà Loading Rates</td></tr>';
  html += '<tr><td>Hydraulic Loading</td><td><span class="result" style="color:' + hydLoadStatus.color + '">' + actualHydLoad.toFixed(0) + '</span></td><td>GPM/m (' + hydLoadStatus.text + ')</td></tr>';
  html += '<tr><td>Solids Loading</td><td><span class="result" style="color:' + solLoadStatus.color + '">' + actualSolLoad.toFixed(0) + '</span></td><td>lb/hr/m (' + solLoadStatus.text + ')</td></tr>';
  html += '<tr><td>Capture Efficiency</td><td><span class="result" style="color:' + captureStatus.color + '">' + (capture * 100).toFixed(1) + '%</span></td><td>' + captureStatus.text + '</td></tr>';
  html += '<tr><td>Centrate TSS</td><td><span class="result">' + centrateTSS.toFixed(0) + '</span></td><td>mg/L</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">‚öóÔ∏è Polymer Usage</td></tr>';
  html += '<tr><td>Polymer Rate</td><td><span class="result">' + polyLbHr.toFixed(1) + '</span></td><td>lb/hr</td></tr>';
  html += '<tr><td>Polymer Solution</td><td><span class="result">' + polyGPH.toFixed(1) + '</span></td><td>GPH</td></tr>';
  html += '<tr><td>Daily Polymer</td><td><span class="result">' + dailyPolyLb.toFixed(1) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Daily Polymer Cost</td><td><span class="result">$' + dailyPolyCost.toFixed(0) + '</span></td><td>/day</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">üí∞ Operating Costs</td></tr>';
  html += '<tr><td>Polymer Cost</td><td><span class="result">$' + dailyPolyCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Energy Cost</td><td><span class="result">$' + dailyElecCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Disposal Cost</td><td><span class="result">$' + dailyDispCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td><strong>Total Daily Cost</strong></td><td><span class="result" style="font-size:16px;color:#fbbf24">$' + totalDailyCost.toFixed(0) + '</span></td><td>/day</td></tr>';
  html += '<tr><td>Cost per Dry Ton</td><td><span class="result">$' + costPerDryTon.toFixed(0) + '</span></td><td>/DT</td></tr>';
  html += '<tr><td>Annual Cost</td><td><span class="result">$' + annualCost.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';

  html += '</tbody></table>';

  // Check capacity
  if (reqRunTime > opHours) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Required run time (' + reqRunTime.toFixed(1) + ' hr) exceeds operating hours (' + opHours + ' hr). Consider increasing units in service or extending hours.</div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ Capacity adequate. ' + ((opHours - reqRunTime) / opHours * 100).toFixed(0) + '% reserve capacity available.</div>';
  }

  html += '</div>';

  document.getElementById('dw2_results').innerHTML = html;
  showToast('Dewatering analysis complete!', 'success');
}

// Compare dewatering equipment
function compareDewateringEquip() {
  var dailyDryTon = parseFloat(document.getElementById('dw_daily_vol').value) * 8.34 *
    parseFloat(document.getElementById('dw_feed_pct').value) / 100 / 2000 || 3;
  var polyCost = parseFloat(document.getElementById('dw_poly_cost').value) || 2.50;
  var elecCost = parseFloat(document.getElementById('dw_elec_cost').value) || 0.10;
  var dispCost = parseFloat(document.getElementById('dw_disp_cost').value) || 50;

  var equipment = [
    { name: 'Belt Filter Press', cake: 22, poly: 12, energy: 15, capture: 95, capital: 'Medium' },
    { name: 'Centrifuge', cake: 25, poly: 20, energy: 45, capture: 95, capital: 'High' },
    { name: 'Screw Press', cake: 20, poly: 8, energy: 10, capture: 92, capital: 'Low' },
    { name: 'Plate & Frame', cake: 35, poly: 8, energy: 8, capture: 98, capital: 'Medium' }
  ];

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #a78bfa">';
  html += '<h4 style="margin:0 0 15px 0;color:#a78bfa">üìä Equipment Comparison</h4>';

  html += '<table class="table" style="font-size:12px">';
  html += '<thead><tr><th>Parameter</th>';
  equipment.forEach(e => html += '<th>' + e.name.split(' ')[0] + '</th>');
  html += '</tr></thead><tbody>';

  html += '<tr><td>Cake Solids (%)</td>';
  equipment.forEach(e => html += '<td>' + e.cake + '%</td>');
  html += '</tr>';

  html += '<tr><td>Capture (%)</td>';
  equipment.forEach(e => html += '<td>' + e.capture + '%</td>');
  html += '</tr>';

  html += '<tr><td>Polymer (lb/DT)</td>';
  equipment.forEach(e => html += '<td>' + e.poly + '</td>');
  html += '</tr>';

  html += '<tr><td>Energy (kWh/DT)</td>';
  equipment.forEach(e => html += '<td>' + e.energy + '</td>');
  html += '</tr>';

  // Calculate costs
  var costs = equipment.map(e => {
    var wetCake = dailyDryTon * (e.capture/100) / (e.cake/100);
    var polyCostDay = dailyDryTon * e.poly * polyCost;
    var energyCostDay = dailyDryTon * e.energy * elecCost;
    var dispCostDay = wetCake * dispCost;
    return polyCostDay + energyCostDay + dispCostDay;
  });

  var minCost = Math.min(...costs);
  html += '<tr style="background:#243b55"><td><strong>Daily Cost</strong></td>';
  costs.forEach((c, i) => {
    var highlight = c === minCost ? 'color:#4ade80;font-weight:bold' : '';
    html += '<td style="' + highlight + '">$' + c.toFixed(0) + (c === minCost ? ' ‚úì' : '') + '</td>';
  });
  html += '</tr>';

  html += '<tr><td>Capital Cost</td>';
  equipment.forEach(e => html += '<td>' + e.capital + '</td>');
  html += '</tr>';

  html += '</tbody></table>';

  html += '</div>';

  document.getElementById('dw2_results').innerHTML += html;
}

// Optimize polymer dose
function optimizePolymer() {
  var currentDose = parseFloat(document.getElementById('dw_poly_dose').value) || 12;
  var sludgeType = document.getElementById('dw_sludge').value;

  var optimalRange = {
    'primary': { min: 3, max: 8, optimal: 5 },
    'was': { min: 15, max: 25, optimal: 18 },
    'mixed': { min: 8, max: 15, optimal: 12 },
    'digested': { min: 10, max: 18, optimal: 14 },
    'aerobic': { min: 12, max: 22, optimal: 16 }
  }[sludgeType] || { min: 8, max: 15, optimal: 12 };

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #4ade80">';
  html += '<h4 style="margin:0 0 15px 0;color:#4ade80">‚öóÔ∏è Polymer Optimization</h4>';

  html += '<table class="table" style="font-size:13px"><tbody>';
  html += '<tr><td>Current Dose</td><td><span class="result">' + currentDose + '</span></td><td>lb/DT</td></tr>';
  html += '<tr><td>Optimal Range</td><td><span class="result">' + optimalRange.min + ' - ' + optimalRange.max + '</span></td><td>lb/DT</td></tr>';
  html += '<tr><td>Recommended</td><td><span class="result" style="color:#4ade80">' + optimalRange.optimal + '</span></td><td>lb/DT</td></tr>';
  html += '</tbody></table>';

  if (currentDose < optimalRange.min) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Dose below optimal range - may have poor capture and high centrate TSS.</div>';
  } else if (currentDose > optimalRange.max) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Dose above optimal range - may be overdosing. Consider jar testing.</div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ Dose within optimal range for ' + sludgeType.replace('_', ' ') + ' sludge.</div>';
  }

  html += '</div>';

  document.getElementById('dw2_results').innerHTML += html;
}

// Status helpers
function getHydLoadStatus(actual, target) {
  var ratio = actual / target;
  if (ratio <= 0.8) return { color: '#4ade80', text: 'Good' };
  if (ratio <= 1.0) return { color: '#fbbf24', text: 'At limit' };
  return { color: '#ef4444', text: 'Over limit' };
}

function getSolLoadStatus(actual, target) {
  var ratio = actual / target;
  if (ratio <= 0.8) return { color: '#4ade80', text: 'Good' };
  if (ratio <= 1.0) return { color: '#fbbf24', text: 'At limit' };
  return { color: '#ef4444', text: 'Over limit' };
}

function resetDewatering2() {
  document.getElementById('dw2_results').innerHTML = '';
  showToast('Dewatering calculator reset', 'info');
}

// ========== END BELT PRESS / CENTRIFUGE CALCULATOR ==========
// ========== SLUDGE BOX (DRY) HAUL CALCULATOR ==========

// Update box defaults based on type
function updateBoxDefaults() {
  var type = document.getElementById('sb_box_type').value;
  var boxCY = document.getElementById('sb_box_cy');
  var weightLimit = document.getElementById('sb_weight_limit');

  var defaults = {
    '20cy': { cy: 20, weight: 18 },
    '30cy': { cy: 30, weight: 20 },
    '40cy': { cy: 40, weight: 22 },
    'lugger': { cy: 12, weight: 10 },
    'custom': { cy: 30, weight: 20 }
  };

  var d = defaults[type] || defaults['30cy'];
  boxCY.value = d.cy;
  weightLimit.value = d.weight;

  calcSludgeBox();
}

// Main sludge box calculation
function calcSludgeBox() {
  // Cake production
  var cakePerDay = parseFloat(document.getElementById('sb_cake_day').value) || 5;
  var cakeUnit = document.getElementById('sb_cake_unit').value;
  var cakePct = parseFloat(document.getElementById('sb_cake_pct').value) / 100 || 0.22;
  var density = parseFloat(document.getElementById('sb_density').value) || 1200;
  var opDays = parseFloat(document.getElementById('sb_op_days').value) || 5;
  var storageDays = parseFloat(document.getElementById('sb_storage_days').value) || 3;

  // Box configuration
  var boxCY = parseFloat(document.getElementById('sb_box_cy').value) || 30;
  var fillPct = parseFloat(document.getElementById('sb_fill_pct').value) / 100 || 0.85;
  var numBoxes = parseFloat(document.getElementById('sb_num_boxes').value) || 2;
  var weightLimit = parseFloat(document.getElementById('sb_weight_limit').value) || 20;

  // Costs
  var haulCost = parseFloat(document.getElementById('sb_haul_cost').value) || 350;
  var dispTon = parseFloat(document.getElementById('sb_disp_ton').value) || 45;
  var rental = parseFloat(document.getElementById('sb_rental').value) || 150;
  var fuelPct = parseFloat(document.getElementById('sb_fuel').value) / 100 || 0.10;
  var envFee = parseFloat(document.getElementById('sb_env_fee').value) || 15;

  // Convert cake production to standard units (wet tons/day and cy/day)
  var wetTonsDay, cyDay, dryTonsDay;

  switch(cakeUnit) {
    case 'wetton':
      wetTonsDay = cakePerDay;
      cyDay = (cakePerDay * 2000) / density;
      dryTonsDay = cakePerDay * cakePct;
      break;
    case 'dryton':
      dryTonsDay = cakePerDay;
      wetTonsDay = cakePerDay / cakePct;
      cyDay = (wetTonsDay * 2000) / density;
      break;
    case 'cy':
      cyDay = cakePerDay;
      wetTonsDay = (cakePerDay * density) / 2000;
      dryTonsDay = wetTonsDay * cakePct;
      break;
    case 'lb':
      wetTonsDay = cakePerDay / 2000;
      cyDay = cakePerDay / density;
      dryTonsDay = wetTonsDay * cakePct;
      break;
  }

  // Weekly production
  var wetTonsWeek = wetTonsDay * opDays;
  var cyWeek = cyDay * opDays;

  // Usable box capacity
  var usableCY = boxCY * fillPct;
  var usableWeight = weightLimit; // tons

  // Determine limiting factor
  var weightPerCY = density / 2000; // tons per cy
  var cyAtWeightLimit = usableWeight / weightPerCY;

  var limitingFactor, effectiveCY;
  if (usableCY <= cyAtWeightLimit) {
    limitingFactor = 'Volume';
    effectiveCY = usableCY;
  } else {
    limitingFactor = 'Weight';
    effectiveCY = cyAtWeightLimit;
  }

  var effectiveTons = effectiveCY * weightPerCY;

  // Days to fill one box
  var daysToFill = effectiveCY / cyDay;

  // Hauls per week
  var haulsPerWeek = opDays / daysToFill;
  var haulsPerMonth = haulsPerWeek * 4.33;
  var haulsPerYear = haulsPerWeek * 52;

  // Storage capacity
  var totalStorageCY = usableCY * numBoxes;
  var storageCapDays = totalStorageCY / cyDay;
  var storageOK = storageCapDays >= storageDays;

  // Cost calculations
  var costPerHaul = haulCost * (1 + fuelPct) + envFee;
  var dispCostPerHaul = effectiveTons * dispTon;
  var totalPerHaul = costPerHaul + dispCostPerHaul;

  var weeklyHaulCost = haulsPerWeek * totalPerHaul;
  var monthlyHaulCost = haulsPerMonth * totalPerHaul;
  var monthlyRental = rental * numBoxes;
  var monthlyTotal = monthlyHaulCost + monthlyRental;
  var annualTotal = monthlyTotal * 12;

  // Cost per ton metrics
  var costPerWetTon = monthlyTotal / (wetTonsWeek * 4.33);
  var costPerDryTon = monthlyTotal / (dryTonsDay * opDays * 4.33);
  var costPerCY = monthlyTotal / (cyWeek * 4.33);

  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #78716c">';
  html += '<h4 style="margin:0 0 15px 0;color:#a8a29e">üì¶ Sludge Box Hauling Analysis</h4>';

  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Hauls/Week</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#78716c">' + haulsPerWeek.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">pulls</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Days to Fill</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + daysToFill.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">days/box</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Monthly Cost</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">$' + (monthlyTotal/1000).toFixed(1) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/month</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Cost/Wet Ton</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#a78bfa">$' + costPerWetTon.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/wet ton</div></div>';
  html += '</div>';

  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Production Summary</td></tr>';
  html += '<tr><td>Daily Cake (wet)</td><td><span class="result">' + wetTonsDay.toFixed(2) + '</span></td><td>wet tons/day</td></tr>';
  html += '<tr><td>Daily Cake (dry)</td><td><span class="result">' + dryTonsDay.toFixed(2) + '</span></td><td>dry tons/day</td></tr>';
  html += '<tr><td>Daily Volume</td><td><span class="result">' + cyDay.toFixed(1) + '</span></td><td>cy/day</td></tr>';
  html += '<tr><td>Weekly Volume</td><td><span class="result">' + cyWeek.toFixed(1) + '</span></td><td>cy/week</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">üì¶ Box Capacity</td></tr>';
  html += '<tr><td>Box Size</td><td><span class="result">' + boxCY + '</span></td><td>cy</td></tr>';
  html += '<tr><td>Usable Volume (' + (fillPct*100) + '%)</td><td><span class="result">' + usableCY.toFixed(1) + '</span></td><td>cy</td></tr>';
  html += '<tr><td>Weight Limit</td><td><span class="result">' + weightLimit + '</span></td><td>tons</td></tr>';
  html += '<tr><td>Limiting Factor</td><td colspan="2"><span class="result" style="color:#fbbf24">' + limitingFactor + '</span> (effective: ' + effectiveCY.toFixed(1) + ' cy / ' + effectiveTons.toFixed(1) + ' tons)</td></tr>';
  html += '<tr><td>Days to Fill Box</td><td><span class="result">' + daysToFill.toFixed(2) + '</span></td><td>days</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üöõ Hauling Frequency</td></tr>';
  html += '<tr><td>Hauls per Week</td><td><span class="result">' + haulsPerWeek.toFixed(2) + '</span></td><td>pulls/week</td></tr>';
  html += '<tr><td>Hauls per Month</td><td><span class="result">' + haulsPerMonth.toFixed(1) + '</span></td><td>pulls/month</td></tr>';
  html += '<tr><td>Hauls per Year</td><td><span class="result">' + haulsPerYear.toFixed(0) + '</span></td><td>pulls/year</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#a78bfa">üè™ Storage Capacity</td></tr>';
  html += '<tr><td>On-Site Boxes</td><td><span class="result">' + numBoxes + '</span></td><td>boxes</td></tr>';
  html += '<tr><td>Total Storage</td><td><span class="result">' + totalStorageCY.toFixed(1) + '</span></td><td>cy</td></tr>';
  html += '<tr><td>Storage Capacity</td><td><span class="result" style="color:' + (storageOK ? '#4ade80' : '#ef4444') + '">' + storageCapDays.toFixed(1) + '</span></td><td>days</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#ef4444">üí∞ Cost Breakdown</td></tr>';
  html += '<tr><td>Haul + Fuel + Env Fee</td><td><span class="result">$' + costPerHaul.toFixed(0) + '</span></td><td>/haul</td></tr>';
  html += '<tr><td>Disposal Fee</td><td><span class="result">$' + dispCostPerHaul.toFixed(0) + '</span></td><td>/haul</td></tr>';
  html += '<tr><td>Total per Haul</td><td><span class="result">$' + totalPerHaul.toFixed(0) + '</span></td><td>/haul</td></tr>';
  html += '<tr><td>Monthly Hauling</td><td><span class="result">$' + monthlyHaulCost.toFixed(0) + '</span></td><td>/month</td></tr>';
  html += '<tr><td>Monthly Rental</td><td><span class="result">$' + monthlyRental.toFixed(0) + '</span></td><td>/month</td></tr>';
  html += '<tr><td><strong>Monthly Total</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + monthlyTotal.toFixed(0) + '</span></td><td>/month</td></tr>';
  html += '<tr><td>Annual Total</td><td><span class="result">$' + annualTotal.toLocaleString(undefined, {maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Cost per Wet Ton</td><td><span class="result">$' + costPerWetTon.toFixed(2) + '</span></td><td>/wet ton</td></tr>';
  html += '<tr><td>Cost per Dry Ton</td><td><span class="result">$' + costPerDryTon.toFixed(2) + '</span></td><td>/dry ton</td></tr>';

  html += '</tbody></table>';

  // Storage warning
  if (!storageOK) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Storage capacity (' + storageCapDays.toFixed(1) + ' days) is less than required (' + storageDays + ' days). Consider adding boxes or increasing haul frequency.</div>';
  } else {
    html += '<div class="note success" style="margin-top:15px">‚úÖ Storage capacity adequate for ' + storageCapDays.toFixed(1) + ' days of production.</div>';
  }

  html += '</div>';

  document.getElementById('sb_results').innerHTML = html;
  showToast('Sludge box calculation complete!', 'success');
}

// Calculate weekly schedule
function calcBoxSchedule() {
  var cakePerDay = parseFloat(document.getElementById('sb_cake_day').value) || 5;
  var cakeUnit = document.getElementById('sb_cake_unit').value;
  var density = parseFloat(document.getElementById('sb_density').value) || 1200;
  var opDays = parseFloat(document.getElementById('sb_op_days').value) || 5;
  var boxCY = parseFloat(document.getElementById('sb_box_cy').value) || 30;
  var fillPct = parseFloat(document.getElementById('sb_fill_pct').value) / 100 || 0.85;
  var numBoxes = parseFloat(document.getElementById('sb_num_boxes').value) || 2;

  // Convert to cy/day
  var cyDay;
  if (cakeUnit === 'wetton') cyDay = (cakePerDay * 2000) / density;
  else if (cakeUnit === 'cy') cyDay = cakePerDay;
  else cyDay = (cakePerDay * 2000) / density;

  var usableCY = boxCY * fillPct;

  // Simulate a week
  var days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  var boxLevels = new Array(numBoxes).fill(0);
  var schedule = [];
  var activeBox = 0;

  for (var d = 0; d < 7; d++) {
    var dayName = days[d];
    var producing = d < opDays;
    var hauls = [];

    if (producing) {
      boxLevels[activeBox] += cyDay;

      // Check if box needs hauling
      if (boxLevels[activeBox] >= usableCY) {
        hauls.push('Box ' + (activeBox + 1));
        boxLevels[activeBox] = 0;
        activeBox = (activeBox + 1) % numBoxes;
      }
    }

    schedule.push({
      day: dayName,
      producing: producing,
      levels: boxLevels.slice(),
      hauls: hauls
    });
  }

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #60a5fa">';
  html += '<h4 style="margin:0 0 15px 0;color:#60a5fa">üìÖ Weekly Hauling Schedule</h4>';

  html += '<table class="table" style="font-size:12px">';
  html += '<thead><tr><th>Day</th><th>Production</th>';
  for (var b = 0; b < numBoxes; b++) {
    html += '<th>Box ' + (b + 1) + '</th>';
  }
  html += '<th>Haul</th></tr></thead><tbody>';

  schedule.forEach(function(s) {
    html += '<tr>';
    html += '<td><strong>' + s.day + '</strong></td>';
    html += '<td>' + (s.producing ? '‚úì ' + cyDay.toFixed(1) + ' cy' : '-') + '</td>';
    s.levels.forEach(function(level, i) {
      var pct = (level / usableCY) * 100;
      var color = pct > 80 ? '#ef4444' : (pct > 50 ? '#fbbf24' : '#4ade80');
      html += '<td><span style="color:' + color + '">' + pct.toFixed(0) + '%</span></td>';
    });
    html += '<td>' + (s.hauls.length > 0 ? 'üöõ ' + s.hauls.join(', ') : '-') + '</td>';
    html += '</tr>';
  });

  html += '</tbody></table>';
  html += '<div style="margin-top:10px;font-size:12px;color:#94a3b8">Note: This is a simplified simulation. Actual schedule may vary based on hauler availability.</div>';
  html += '</div>';

  document.getElementById('sb_schedule').innerHTML = html;
}

// Optimize box size
function optimizeBoxSize() {
  var cakePerDay = parseFloat(document.getElementById('sb_cake_day').value) || 5;
  var density = parseFloat(document.getElementById('sb_density').value) || 1200;
  var opDays = parseFloat(document.getElementById('sb_op_days').value) || 5;
  var haulCost = parseFloat(document.getElementById('sb_haul_cost').value) || 350;
  var dispTon = parseFloat(document.getElementById('sb_disp_ton').value) || 45;

  // Convert to cy/day (assume wet tons)
  var cyDay = (cakePerDay * 2000) / density;
  var cyWeek = cyDay * opDays;

  var boxSizes = [
    { name: 'Lugger (12 CY)', cy: 12, rental: 100 },
    { name: '20 CY Roll-off', cy: 20, rental: 125 },
    { name: '30 CY Roll-off', cy: 30, rental: 150 },
    { name: '40 CY Roll-off', cy: 40, rental: 175 }
  ];

  var results = boxSizes.map(function(box) {
    var usable = box.cy * 0.85;
    var haulsWeek = cyWeek / usable;
    var weightPerHaul = (usable * density) / 2000;
    var costPerHaul = haulCost * 1.1 + 15 + (weightPerHaul * dispTon);
    var weeklyTotal = (haulsWeek * costPerHaul) + (box.rental / 4.33);
    return { ...box, haulsWeek, costPerHaul, weeklyTotal };
  });

  var minCost = Math.min(...results.map(r => r.weeklyTotal));

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #4ade80">';
  html += '<h4 style="margin:0 0 15px 0;color:#4ade80">üìä Box Size Optimization</h4>';

  html += '<table class="table" style="font-size:12px">';
  html += '<thead><tr><th>Box Size</th><th>Hauls/Week</th><th>Cost/Haul</th><th>Weekly Cost</th></tr></thead>';
  html += '<tbody>';

  results.forEach(function(r) {
    var best = r.weeklyTotal === minCost;
    html += '<tr' + (best ? ' style="background:rgba(74,222,128,0.2)"' : '') + '>';
    html += '<td>' + r.name + (best ? ' ‚úì' : '') + '</td>';
    html += '<td>' + r.haulsWeek.toFixed(2) + '</td>';
    html += '<td>$' + r.costPerHaul.toFixed(0) + '</td>';
    html += '<td style="' + (best ? 'color:#4ade80;font-weight:bold' : '') + '">$' + r.weeklyTotal.toFixed(0) + '</td>';
    html += '</tr>';
  });

  html += '</tbody></table>';

  var bestOption = results.find(r => r.weeklyTotal === minCost);
  html += '<div class="note info" style="margin-top:15px">üí° <strong>Recommendation:</strong> ' + bestOption.name + ' offers the lowest weekly cost at $' + bestOption.weeklyTotal.toFixed(0) + '/week.</div>';

  html += '</div>';

  document.getElementById('sb_schedule').innerHTML = html;
}

function resetSludgeBox() {
  document.getElementById('sb_results').innerHTML = '';
  document.getElementById('sb_schedule').innerHTML = '';
  showToast('Sludge box calculator reset', 'info');
}

// ========== END SLUDGE BOX CALCULATOR ==========
// ========== PUMP STATION CALCULATOR ==========

function calcPumpStation() {
  // Design flows
  var avgFlow = parseFloat(document.getElementById('ps_avg_flow').value) || 1.0;
  var peakFlow = parseFloat(document.getElementById('ps_peak_flow').value) || 2.5;
  var minFlow = parseFloat(document.getElementById('ps_min_flow').value) || 0.3;
  var designLife = parseFloat(document.getElementById('ps_life').value) || 20;
  var growth = parseFloat(document.getElementById('ps_growth').value) / 100 || 0.02;

  // Wet well
  var shape = document.getElementById('ps_shape').value;
  var dim1 = parseFloat(document.getElementById('ps_dim1').value) || 10;
  var dim2 = parseFloat(document.getElementById('ps_dim2').value) || 8;
  var leadOn = parseFloat(document.getElementById('ps_lead_on').value) || 6;
  var leadOff = parseFloat(document.getElementById('ps_lead_off').value) || 3;
  var lagOn = parseFloat(document.getElementById('ps_lag_on').value) || 8;
  var hla = parseFloat(document.getElementById('ps_hla').value) || 10;

  // Pumps
  var numPumps = parseInt(document.getElementById('ps_num_pumps').value) || 2;
  var pumpGPM = parseFloat(document.getElementById('ps_pump_gpm').value) || 700;
  var tdh = parseFloat(document.getElementById('ps_tdh').value) || 45;
  var pumpEff = parseFloat(document.getElementById('ps_eff').value) / 100 || 0.70;
  var motorEff = parseFloat(document.getElementById('ps_motor_eff').value) / 100 || 0.92;

  // Energy
  var elecCost = parseFloat(document.getElementById('ps_elec').value) || 0.10;
  var demandCharge = parseFloat(document.getElementById('ps_demand').value) || 12;
  var hasVFD = document.getElementById('ps_vfd').value === 'yes';

  // Calculate wet well volume
  var wwArea, wwVolPerFt;
  if (shape === 'circular') {
    wwArea = Math.PI * Math.pow(dim1/2, 2);
  } else {
    wwArea = dim1 * dim2;
  }
  wwVolPerFt = wwArea * 7.48; // gal/ft

  // Active storage volume (between lead on and lead off)
  var activeDepth = leadOn - leadOff;
  var activeVolume = activeDepth * wwVolPerFt;

  // Future design flow
  var futureAvg = avgFlow * Math.pow(1 + growth, designLife);
  var futurePeak = peakFlow * Math.pow(1 + growth, designLife);

  // Convert flows to GPM
  var avgGPM = avgFlow * 1000000 / 1440;
  var peakGPM = peakFlow * 1000000 / 1440;
  var minGPM = minFlow * 1000000 / 1440;

  // Firm capacity (N-1 pumps)
  var firmCapacity = pumpGPM * (numPumps - 1);
  var firmCapacityMGD = firmCapacity * 1440 / 1000000;
  var capacityOK = firmCapacity >= peakGPM;

  // Cycle time calculation (at average flow)
  var fillTime = activeVolume / avgGPM; // min to fill
  var pumpDownTime = activeVolume / (pumpGPM - avgGPM); // min to pump down
  var cycleTime = fillTime + pumpDownTime;
  var startsPerHour = 60 / cycleTime;

  // Detention time at min flow
  var totalWWVol = hla * wwVolPerFt;
  var detentionTime = totalWWVol / minGPM;

  // Horsepower calculation
  var whp = (pumpGPM * tdh) / 3960; // Water HP
  var bhp = whp / pumpEff; // Brake HP
  var motorHP = Math.ceil(bhp / 0.9 / 5) * 5; // Next standard size, 90% service factor
  var kW = (bhp * 0.746) / motorEff;

  // Energy costs
  var runHoursDay = (avgFlow * 1000000) / (pumpGPM * 60);
  var dailyKWh = kW * runHoursDay;
  var monthlyKWh = dailyKWh * 30;
  var monthlyEnergy = monthlyKWh * elecCost;
  var monthlyDemand = kW * demandCharge;
  var monthlyTotal = monthlyEnergy + monthlyDemand;
  var annualCost = monthlyTotal * 12;

  // Status checks
  var cycleStatus = getCycleStatus(cycleTime);
  var startsStatus = getStartsStatus(startsPerHour);
  var detentionStatus = getDetentionStatus(detentionTime);

  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #14b8a6">';
  html += '<h4 style="margin:0 0 15px 0;color:#14b8a6">üîÑ Pump Station Analysis</h4>';

  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Cycle Time</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + cycleStatus.color + '">' + cycleTime.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:' + cycleStatus.color + '">min (' + cycleStatus.text + ')</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Starts/Hour</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + startsStatus.color + '">' + startsPerHour.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:' + startsStatus.color + '">' + startsStatus.text + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Motor Size</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + motorHP + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">HP each</div></div>';
  html += '<div style="background:' + (capacityOK ? '#065f46' : '#7f1d1d') + ';padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;opacity:0.8">Firm Capacity</div>';
  html += '<div style="font-size:18px;font-weight:bold">' + (capacityOK ? '‚úì OK' : '‚ö†Ô∏è LOW') + '</div>';
  html += '<div style="font-size:11px;opacity:0.8">' + firmCapacityMGD.toFixed(2) + ' MGD</div></div>';
  html += '</div>';

  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Design Flows</td></tr>';
  html += '<tr><td>Average Flow</td><td><span class="result">' + avgFlow.toFixed(2) + '</span></td><td>MGD (' + avgGPM.toFixed(0) + ' GPM)</td></tr>';
  html += '<tr><td>Peak Flow</td><td><span class="result">' + peakFlow.toFixed(2) + '</span></td><td>MGD (' + peakGPM.toFixed(0) + ' GPM)</td></tr>';
  html += '<tr><td>Future Peak (' + designLife + ' yr)</td><td><span class="result">' + futurePeak.toFixed(2) + '</span></td><td>MGD</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">ü™£ Wet Well</td></tr>';
  html += '<tr><td>Surface Area</td><td><span class="result">' + wwArea.toFixed(1) + '</span></td><td>sq ft</td></tr>';
  html += '<tr><td>Volume per Foot</td><td><span class="result">' + wwVolPerFt.toFixed(0) + '</span></td><td>gal/ft</td></tr>';
  html += '<tr><td>Active Storage</td><td><span class="result">' + activeVolume.toFixed(0) + '</span></td><td>gallons</td></tr>';
  html += '<tr><td>Total Volume</td><td><span class="result">' + totalWWVol.toFixed(0) + '</span></td><td>gallons</td></tr>';
  html += '<tr><td>Detention Time (min flow)</td><td><span class="result" style="color:' + detentionStatus.color + '">' + detentionTime.toFixed(1) + '</span></td><td>min (' + detentionStatus.text + ')</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#14b8a6">‚öôÔ∏è Pump Performance</td></tr>';
  html += '<tr><td>Each Pump Capacity</td><td><span class="result">' + pumpGPM + '</span></td><td>GPM</td></tr>';
  html += '<tr><td>Firm Capacity (N-1)</td><td><span class="result">' + firmCapacity + '</span></td><td>GPM (' + firmCapacityMGD.toFixed(2) + ' MGD)</td></tr>';
  html += '<tr><td>Water Horsepower</td><td><span class="result">' + whp.toFixed(1) + '</span></td><td>WHP</td></tr>';
  html += '<tr><td>Brake Horsepower</td><td><span class="result">' + bhp.toFixed(1) + '</span></td><td>BHP</td></tr>';
  html += '<tr><td>Motor Size (each)</td><td><span class="result">' + motorHP + '</span></td><td>HP</td></tr>';
  html += '<tr><td>Power Draw</td><td><span class="result">' + kW.toFixed(1) + '</span></td><td>kW</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üí∞ Energy Costs</td></tr>';
  html += '<tr><td>Daily Run Time</td><td><span class="result">' + runHoursDay.toFixed(1) + '</span></td><td>hours</td></tr>';
  html += '<tr><td>Monthly Energy</td><td><span class="result">' + monthlyKWh.toFixed(0) + '</span></td><td>kWh</td></tr>';
  html += '<tr><td>Monthly Energy Cost</td><td><span class="result">$' + monthlyEnergy.toFixed(0) + '</span></td><td></td></tr>';
  html += '<tr><td>Monthly Demand Cost</td><td><span class="result">$' + monthlyDemand.toFixed(0) + '</span></td><td></td></tr>';
  html += '<tr><td><strong>Annual Cost</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + annualCost.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';

  html += '</tbody></table>';
  html += '</div>';

  document.getElementById('ps_results').innerHTML = html;
  showToast('Pump station analysis complete!', 'success');
}

function calcCycleTime() {
  var avgFlow = parseFloat(document.getElementById('ps_avg_flow').value) || 1.0;
  var pumpGPM = parseFloat(document.getElementById('ps_pump_gpm').value) || 700;
  var shape = document.getElementById('ps_shape').value;
  var dim1 = parseFloat(document.getElementById('ps_dim1').value) || 10;
  var dim2 = parseFloat(document.getElementById('ps_dim2').value) || 8;
  var leadOn = parseFloat(document.getElementById('ps_lead_on').value) || 6;
  var leadOff = parseFloat(document.getElementById('ps_lead_off').value) || 3;

  var wwArea = shape === 'circular' ? Math.PI * Math.pow(dim1/2, 2) : dim1 * dim2;
  var wwVolPerFt = wwArea * 7.48;
  var activeDepth = leadOn - leadOff;
  var activeVolume = activeDepth * wwVolPerFt;

  // Cycle times at different flow rates
  var flows = [0.25, 0.5, 0.75, 1.0, 1.25, 1.5].map(f => f * avgFlow);

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #60a5fa;margin-top:15px">';
  html += '<h4 style="margin:0 0 15px 0;color:#60a5fa">‚è±Ô∏è Cycle Time Analysis</h4>';

  html += '<table class="table" style="font-size:12px">';
  html += '<thead><tr><th>Flow (MGD)</th><th>Flow (GPM)</th><th>Fill Time</th><th>Pump Time</th><th>Cycle</th><th>Starts/hr</th></tr></thead>';
  html += '<tbody>';

  flows.forEach(function(f) {
    var gpm = f * 1000000 / 1440;
    if (gpm >= pumpGPM) return; // Skip if flow exceeds pump capacity
    var fillTime = activeVolume / gpm;
    var pumpTime = activeVolume / (pumpGPM - gpm);
    var cycle = fillTime + pumpTime;
    var starts = 60 / cycle;
    var color = cycle < 5 ? '#ef4444' : (cycle < 10 ? '#fbbf24' : '#4ade80');
    html += '<tr>';
    html += '<td>' + f.toFixed(2) + '</td>';
    html += '<td>' + gpm.toFixed(0) + '</td>';
    html += '<td>' + fillTime.toFixed(1) + ' min</td>';
    html += '<td>' + pumpTime.toFixed(1) + ' min</td>';
    html += '<td style="color:' + color + '">' + cycle.toFixed(1) + ' min</td>';
    html += '<td>' + starts.toFixed(1) + '</td>';
    html += '</tr>';
  });

  html += '</tbody></table>';
  html += '<div class="note info" style="margin-top:10px">üí° Minimum recommended cycle time: 5-10 minutes. Max 6-12 starts/hour.</div>';
  html += '</div>';

  document.getElementById('ps_results').innerHTML += html;
}

function calcVFDSavings() {
  var avgFlow = parseFloat(document.getElementById('ps_avg_flow').value) || 1.0;
  var pumpGPM = parseFloat(document.getElementById('ps_pump_gpm').value) || 700;
  var tdh = parseFloat(document.getElementById('ps_tdh').value) || 45;
  var pumpEff = parseFloat(document.getElementById('ps_eff').value) / 100 || 0.70;
  var motorEff = parseFloat(document.getElementById('ps_motor_eff').value) / 100 || 0.92;
  var elecCost = parseFloat(document.getElementById('ps_elec').value) || 0.10;

  var avgGPM = avgFlow * 1000000 / 1440;
  var runHoursDay = (avgFlow * 1000000) / (pumpGPM * 60);

  // Constant speed (full power when running)
  var bhpFull = (pumpGPM * tdh) / (3960 * pumpEff);
  var kWFull = (bhpFull * 0.746) / motorEff;
  var annualKWhCS = kWFull * runHoursDay * 365;
  var annualCostCS = annualKWhCS * elecCost;

  // VFD (affinity laws - power varies with cube of speed)
  var speedRatio = avgGPM / pumpGPM;
  var powerRatio = Math.pow(speedRatio, 3);
  var kWVFD = kWFull * powerRatio;
  var runHoursVFD = 24; // Runs continuously at reduced speed
  var annualKWhVFD = kWVFD * runHoursVFD * 365;
  var annualCostVFD = annualKWhVFD * elecCost;

  var savings = annualCostCS - annualCostVFD;
  var savingsPct = (savings / annualCostCS) * 100;

  var html = '<div style="background:#1e3a5f;padding:20px;border-radius:12px;border-left:4px solid #4ade80;margin-top:15px">';
  html += '<h4 style="margin:0 0 15px 0;color:#4ade80">üí° VFD Energy Savings Analysis</h4>';

  html += '<table class="table" style="font-size:13px">';
  html += '<thead><tr><th>Parameter</th><th>Constant Speed</th><th>VFD</th></tr></thead>';
  html += '<tbody>';
  html += '<tr><td>Operating Speed</td><td>100%</td><td>' + (speedRatio * 100).toFixed(0) + '%</td></tr>';
  html += '<tr><td>Power Draw (kW)</td><td>' + kWFull.toFixed(1) + '</td><td>' + kWVFD.toFixed(1) + '</td></tr>';
  html += '<tr><td>Run Hours/Day</td><td>' + runHoursDay.toFixed(1) + '</td><td>24 (continuous)</td></tr>';
  html += '<tr><td>Annual kWh</td><td>' + annualKWhCS.toLocaleString(undefined,{maximumFractionDigits:0}) + '</td><td>' + annualKWhVFD.toLocaleString(undefined,{maximumFractionDigits:0}) + '</td></tr>';
  html += '<tr><td>Annual Cost</td><td>$' + annualCostCS.toLocaleString(undefined,{maximumFractionDigits:0}) + '</td><td>$' + annualCostVFD.toLocaleString(undefined,{maximumFractionDigits:0}) + '</td></tr>';
  html += '<tr style="background:#065f46"><td><strong>Annual Savings</strong></td><td colspan="2" style="text-align:center;font-size:18px;color:#4ade80"><strong>$' + savings.toLocaleString(undefined,{maximumFractionDigits:0}) + ' (' + savingsPct.toFixed(0) + '%)</strong></td></tr>';
  html += '</tbody></table>';

  html += '<div class="note info" style="margin-top:10px">üí° Affinity Laws: Power ‚àù Speed¬≥. Reducing speed by 50% reduces power by 87.5%!</div>';
  html += '</div>';

  document.getElementById('ps_results').innerHTML += html;
}

function getCycleStatus(ct) {
  if (ct >= 10) return { color: '#4ade80', text: 'Good' };
  if (ct >= 5) return { color: '#fbbf24', text: 'Acceptable' };
  return { color: '#ef4444', text: 'Too short' };
}

function getStartsStatus(sph) {
  if (sph <= 6) return { color: '#4ade80', text: 'Good' };
  if (sph <= 12) return { color: '#fbbf24', text: 'Acceptable' };
  return { color: '#ef4444', text: 'Too many' };
}

function getDetentionStatus(dt) {
  if (dt <= 20) return { color: '#4ade80', text: 'Good' };
  if (dt <= 30) return { color: '#fbbf24', text: 'OK' };
  return { color: '#ef4444', text: 'Septicity risk' };
}

function resetPumpStation() {
  document.getElementById('ps_results').innerHTML = '';
  showToast('Pump station calculator reset', 'info');
}

// ========== END PUMP STATION CALCULATOR ==========
// ========== MEMBRANE CALCULATOR (MBR/RO/UF) ==========

function updateMembraneDefaults() {
  var memType = document.getElementById('mem_type').value;
  var flux = document.getElementById('mem_flux');
  var tmp = document.getElementById('mem_tmp');
  var perm = document.getElementById('mem_perm');

  var defaults = {
    'mbr': { flux: 15, tmp: 3, perm: 150, area: 400 },
    'uf': { flux: 40, tmp: 15, perm: 80, area: 500 },
    'mf': { flux: 50, tmp: 10, perm: 100, area: 500 },
    'ro': { flux: 18, tmp: 150, perm: 4, area: 400 },
    'nf': { flux: 25, tmp: 100, perm: 8, area: 400 }
  };

  var d = defaults[memType] || defaults.mbr;
  flux.value = d.flux;
  tmp.value = d.tmp;
  perm.value = d.perm;
  document.getElementById('mem_mod_area').value = d.area;

  calcMembrane();
}

function calcMembrane() {
  // System config
  var memType = document.getElementById('mem_type').value;
  var designFlow = parseFloat(document.getElementById('mem_design_flow').value) || 1.0;
  var peakFactor = parseFloat(document.getElementById('mem_peak').value) || 1.5;
  var recovery = parseFloat(document.getElementById('mem_recovery').value) / 100 || 0.85;
  var numTrains = parseInt(document.getElementById('mem_trains').value) || 2;

  // Operating parameters
  var flux = parseFloat(document.getElementById('mem_flux').value) || 15;
  var tmp = parseFloat(document.getElementById('mem_tmp').value) || 3;
  var perm = parseFloat(document.getElementById('mem_perm').value) || 150;
  var temp = parseFloat(document.getElementById('mem_temp').value) || 20;

  // Module specs
  var modArea = parseFloat(document.getElementById('mem_mod_area').value) || 400;
  var modsPerCass = parseInt(document.getElementById('mem_mods_cass').value) || 8;

  // Cleaning
  var cipInterval = parseFloat(document.getElementById('mem_cip_interval').value) || 90;
  var cipDuration = parseFloat(document.getElementById('mem_cip_duration').value) || 4;
  var cipChemCost = parseFloat(document.getElementById('mem_cip_cost').value) || 500;

  // Costs
  var elecCost = parseFloat(document.getElementById('mem_elec').value) || 0.10;
  var modCost = parseFloat(document.getElementById('mem_mod_cost').value) || 3000;
  var modLife = parseFloat(document.getElementById('mem_mod_life').value) || 7;

  // Calculate feed flow
  var feedFlow = designFlow / recovery;
  var peakFeed = feedFlow * peakFactor;

  // Temperature correction (viscosity)
  var tempFactor = Math.exp(0.0239 * (20 - temp));
  var correctedFlux = flux / tempFactor;

  // Required membrane area
  var peakFlowGFD = peakFeed * 1000000 / 1440; // GPM to GFD basis
  var reqArea = (peakFeed * 1000000) / (correctedFlux * 1440 / 1000); // sq ft

  // Modules and cassettes
  var modsRequired = Math.ceil(reqArea / modArea);
  var cassRequired = Math.ceil(modsRequired / modsPerCass);
  var modsPerTrain = Math.ceil(modsRequired / numTrains);
  var cassPerTrain = Math.ceil(cassRequired / numTrains);
  var actualArea = modsRequired * modArea;

  // Actual operating flux
  var actualFlux = (designFlow * 1000000) / (actualArea * 1440 / 1000);

  // Permeability check
  var calcPerm = correctedFlux / tmp;
  var permStatus = calcPerm >= perm * 0.7 ? { color: '#4ade80', text: 'Good' } :
                   calcPerm >= perm * 0.5 ? { color: '#fbbf24', text: 'Moderate fouling' } :
                   { color: '#ef4444', text: 'Severe fouling' };

  // Energy (pressure-based)
  var pumpPressure = tmp * 2.31 + 10; // TMP + piping losses, ft
  var pumpHP = (peakFeed * 694 * pumpPressure) / (3960 * 0.7); // GPM basis
  var pumpKW = pumpHP * 0.746;
  var dailyKWh = pumpKW * 24 * (designFlow / peakFeed); // Avg operation
  var annualKWh = dailyKWh * 365;
  var annualElec = annualKWh * elecCost;

  // Membrane replacement
  var annualModReplacement = (modsRequired * modCost) / modLife;

  // CIP costs
  var cipsPerYear = 365 / cipInterval;
  var annualCIPCost = cipsPerYear * cipChemCost * numTrains;

  // Total annual cost
  var totalAnnual = annualElec + annualModReplacement + annualCIPCost;
  var costPerMG = totalAnnual / (designFlow * 365);

  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #8b5cf6">';
  html += '<h4 style="margin:0 0 15px 0;color:#8b5cf6">üî¨ Membrane System Analysis</h4>';

  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Total Modules</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#8b5cf6">' + modsRequired + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">modules</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Membrane Area</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + (actualArea/1000).toFixed(0) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">sq ft</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Operating Flux</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">' + actualFlux.toFixed(1) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">GFD</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Annual Cost</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">$' + (totalAnnual/1000).toFixed(0) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">/year</div></div>';
  html += '</div>';

  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä System Configuration</td></tr>';
  html += '<tr><td>Membrane Type</td><td><span class="result">' + memType.toUpperCase() + '</span></td><td></td></tr>';
  html += '<tr><td>Design Flow</td><td><span class="result">' + designFlow.toFixed(2) + '</span></td><td>MGD permeate</td></tr>';
  html += '<tr><td>Feed Flow (at ' + (recovery*100).toFixed(0) + '% recovery)</td><td><span class="result">' + feedFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Number of Trains</td><td><span class="result">' + numTrains + '</span></td><td></td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#8b5cf6">üî¨ Membrane Sizing</td></tr>';
  html += '<tr><td>Design Flux (20¬∞C)</td><td><span class="result">' + flux + '</span></td><td>GFD</td></tr>';
  html += '<tr><td>Temp Corrected Flux (' + temp + '¬∞C)</td><td><span class="result">' + correctedFlux.toFixed(1) + '</span></td><td>GFD</td></tr>';
  html += '<tr><td>Required Area</td><td><span class="result">' + reqArea.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>sq ft</td></tr>';
  html += '<tr><td>Modules Required</td><td><span class="result">' + modsRequired + '</span></td><td>modules</td></tr>';
  html += '<tr><td>Cassettes Required</td><td><span class="result">' + cassRequired + '</span></td><td>cassettes</td></tr>';
  html += '<tr><td>Per Train</td><td><span class="result">' + modsPerTrain + ' modules / ' + cassPerTrain + ' cassettes</span></td><td></td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#fbbf24">üìà Performance</td></tr>';
  html += '<tr><td>TMP</td><td><span class="result">' + tmp + '</span></td><td>psi</td></tr>';
  html += '<tr><td>Permeability</td><td><span class="result" style="color:' + permStatus.color + '">' + calcPerm.toFixed(1) + '</span></td><td>GFD/psi (' + permStatus.text + ')</td></tr>';
  html += '<tr><td>CIP Interval</td><td><span class="result">' + cipInterval + '</span></td><td>days</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üí∞ Annual Costs</td></tr>';
  html += '<tr><td>Energy Cost</td><td><span class="result">$' + annualElec.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Membrane Replacement</td><td><span class="result">$' + annualModReplacement.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>CIP Chemicals</td><td><span class="result">$' + annualCIPCost.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td><strong>Total Annual</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + totalAnnual.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Cost per MG</td><td><span class="result">$' + costPerMG.toFixed(2) + '</span></td><td>/MG</td></tr>';

  html += '</tbody></table>';
  html += '</div>';

  document.getElementById('mem_results').innerHTML = html;
  showToast('Membrane analysis complete!', 'success');
}

function resetMembrane() {
  document.getElementById('mem_results').innerHTML = '';
  showToast('Membrane calculator reset', 'info');
}

// ========== END MEMBRANE CALCULATOR ==========
// ========== DAF (DISSOLVED AIR FLOTATION) CALCULATOR ==========

function calcDAF() {
  // Design flows
  var designFlow = parseFloat(document.getElementById('daf_flow').value) || 1.0;
  var peakFactor = parseFloat(document.getElementById('daf_peak').value) || 1.5;
  var numUnits = parseInt(document.getElementById('daf_units').value) || 2;

  // Influent characteristics
  var infTSS = parseFloat(document.getElementById('daf_inf_tss').value) || 200;
  var infFOG = parseFloat(document.getElementById('daf_inf_fog').value) || 100;
  var infBOD = parseFloat(document.getElementById('daf_inf_bod').value) || 300;
  var temp = parseFloat(document.getElementById('daf_temp').value) || 20;

  // Design parameters
  var slr = parseFloat(document.getElementById('daf_slr').value) || 2.0;
  var hlr = parseFloat(document.getElementById('daf_hlr').value) || 4.0;
  var asRatio = parseFloat(document.getElementById('daf_as').value) || 0.02;
  var recyclePct = parseFloat(document.getElementById('daf_recycle').value) || 30;
  var satPressure = parseFloat(document.getElementById('daf_pressure').value) || 60;

  // Performance targets
  var tssRemoval = parseFloat(document.getElementById('daf_tss_rem').value) || 90;
  var fogRemoval = parseFloat(document.getElementById('daf_fog_rem').value) || 95;

  // Costs
  var elecCost = parseFloat(document.getElementById('daf_elec').value) || 0.10;
  var polyDose = parseFloat(document.getElementById('daf_poly').value) || 5;
  var polyCost = parseFloat(document.getElementById('daf_poly_cost').value) || 2.50;

  // Calculate flows
  var peakFlow = designFlow * peakFactor;
  var flowPerUnit = designFlow / numUnits;
  var peakPerUnit = peakFlow / numUnits;
  var recycleFlow = designFlow * (recyclePct / 100);
  var totalFlow = designFlow + recycleFlow;

  // Tank sizing
  var reqAreaSLR = (infTSS * designFlow * 8.34) / (slr * 24); // sq ft based on SLR
  var reqAreaHLR = (designFlow * 1000000) / (hlr * 1440); // sq ft based on HLR
  var reqArea = Math.max(reqAreaSLR, reqAreaHLR);
  var areaPerUnit = reqArea / numUnits;

  // Typical dimensions (L:W = 4:1)
  var width = Math.sqrt(areaPerUnit / 4);
  var length = width * 4;
  var depth = 8; // typical

  // Air requirements
  var airSolubility = 18.7 * (satPressure / 14.7) * (293 / (273 + temp)); // mg/L at pressure
  var airReleased = airSolubility * 0.9; // 90% release efficiency
  var recycleGPM = recycleFlow * 1000000 / 1440;
  var airRequired = (airReleased * recycleGPM * 8.34) / 1000000; // lb/min
  var scfmAir = airRequired * 13.1; // SCFM

  // Check A/S ratio
  var solidsMass = infTSS * designFlow * 8.34; // lb/day
  var airMass = airReleased * recycleGPM * 60 * 24 * 8.34 / 1000000; // lb/day
  var actualAS = airMass / solidsMass;
  var asStatus = actualAS >= asRatio * 0.8 ? { color: '#4ade80', text: 'Adequate' } : { color: '#ef4444', text: 'Low - increase recycle' };

  // Effluent quality
  var effTSS = infTSS * (1 - tssRemoval / 100);
  var effFOG = infFOG * (1 - fogRemoval / 100);
  var effBOD = infBOD * (1 - tssRemoval / 100 * 0.5); // Assume 50% BOD tied to TSS

  // Float production
  var tssRemoved = infTSS - effTSS;
  var fogRemoved = infFOG - effFOG;
  var floatSolids = (tssRemoved + fogRemoved) * designFlow * 8.34; // lb/day
  var floatPct = 4; // typical 4% solids
  var floatVolume = floatSolids / (floatPct / 100 * 8.34) / 1000; // thousand gal/day

  // Energy
  var satPumpHP = (recycleGPM * satPressure * 2.31) / (3960 * 0.7);
  var airCompHP = scfmAir * 0.15; // Approx HP per SCFM at 60 psi
  var totalHP = satPumpHP + airCompHP;
  var totalKW = totalHP * 0.746;
  var dailyKWh = totalKW * 24;
  var annualElec = dailyKWh * 365 * elecCost;

  // Polymer
  var dailyPoly = polyDose * solidsMass / 2000; // lb/day
  var annualPolyCost = dailyPoly * polyCost * 365;

  // Total annual cost
  var totalAnnual = annualElec + annualPolyCost;

  // Build results
  var html = '<div style="background:#243b55;padding:20px;border-radius:12px;border-left:4px solid #f59e0b">';
  html += '<h4 style="margin:0 0 15px 0;color:#f59e0b">ü´ß DAF System Analysis</h4>';

  // Key metrics
  html += '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:15px;margin-bottom:20px">';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Tank Area</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#f59e0b">' + reqArea.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">sq ft total</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">A/S Ratio</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:' + asStatus.color + '">' + (actualAS * 100).toFixed(2) + '</div>';
  html += '<div style="font-size:11px;color:' + asStatus.color + '">' + asStatus.text + '</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Effluent TSS</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#4ade80">' + effTSS.toFixed(0) + '</div>';
  html += '<div style="font-size:11px;color:#94a3b8">mg/L</div></div>';
  html += '<div style="background:#1e3a5f;padding:15px;border-radius:10px;text-align:center">';
  html += '<div style="font-size:11px;color:#94a3b8">Float Produced</div>';
  html += '<div style="font-size:18px;font-weight:bold;color:#fbbf24">' + (floatSolids/1000).toFixed(1) + 'K</div>';
  html += '<div style="font-size:11px;color:#94a3b8">lb/day</div></div>';
  html += '</div>';

  // Detailed table
  html += '<table class="table" style="font-size:13px"><tbody>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#60a5fa">üìä Design Parameters</td></tr>';
  html += '<tr><td>Design Flow</td><td><span class="result">' + designFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Recycle Flow (' + recyclePct + '%)</td><td><span class="result">' + recycleFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';
  html += '<tr><td>Total Flow</td><td><span class="result">' + totalFlow.toFixed(2) + '</span></td><td>MGD</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#f59e0b">ü´ß Tank Sizing</td></tr>';
  html += '<tr><td>Total Tank Area</td><td><span class="result">' + reqArea.toFixed(0) + '</span></td><td>sq ft</td></tr>';
  html += '<tr><td>Per Unit (' + numUnits + ' units)</td><td><span class="result">' + areaPerUnit.toFixed(0) + '</span></td><td>sq ft</td></tr>';
  html += '<tr><td>Suggested Dimensions</td><td><span class="result">' + length.toFixed(0) + ' √ó ' + width.toFixed(0) + ' √ó ' + depth + '</span></td><td>ft (L√óW√óD)</td></tr>';
  html += '<tr><td>Surface Loading (SLR)</td><td><span class="result">' + slr.toFixed(1) + '</span></td><td>lb TSS/sf/day</td></tr>';
  html += '<tr><td>Hydraulic Loading (HLR)</td><td><span class="result">' + hlr.toFixed(1) + '</span></td><td>GPM/sf</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#06b6d4">üí® Air System</td></tr>';
  html += '<tr><td>Saturator Pressure</td><td><span class="result">' + satPressure + '</span></td><td>psi</td></tr>';
  html += '<tr><td>Air Solubility</td><td><span class="result">' + airSolubility.toFixed(1) + '</span></td><td>mg/L</td></tr>';
  html += '<tr><td>A/S Ratio</td><td><span class="result" style="color:' + asStatus.color + '">' + (actualAS * 100).toFixed(3) + '</span></td><td>lb air/lb solids</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#4ade80">üìà Performance</td></tr>';
  html += '<tr><td>Influent TSS ‚Üí Effluent</td><td><span class="result">' + infTSS + ' ‚Üí ' + effTSS.toFixed(0) + '</span></td><td>mg/L (' + tssRemoval + '% removal)</td></tr>';
  html += '<tr><td>Influent FOG ‚Üí Effluent</td><td><span class="result">' + infFOG + ' ‚Üí ' + effFOG.toFixed(0) + '</span></td><td>mg/L (' + fogRemoval + '% removal)</td></tr>';
  html += '<tr><td>Float Production</td><td><span class="result">' + floatSolids.toFixed(0) + '</span></td><td>lb/day @ ' + floatPct + '% solids</td></tr>';
  html += '<tr><td>Float Volume</td><td><span class="result">' + (floatVolume * 1000).toFixed(0) + '</span></td><td>gal/day</td></tr>';

  html += '<tr style="background:#1e3a5f"><td colspan="3" style="font-weight:bold;color:#ef4444">üí∞ Operating Costs</td></tr>';
  html += '<tr><td>Power Requirement</td><td><span class="result">' + totalKW.toFixed(1) + '</span></td><td>kW</td></tr>';
  html += '<tr><td>Annual Energy</td><td><span class="result">$' + annualElec.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td>Polymer Usage</td><td><span class="result">' + dailyPoly.toFixed(1) + '</span></td><td>lb/day</td></tr>';
  html += '<tr><td>Annual Polymer</td><td><span class="result">$' + annualPolyCost.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';
  html += '<tr><td><strong>Total Annual</strong></td><td><span class="result" style="font-size:16px;color:#4ade80">$' + totalAnnual.toLocaleString(undefined,{maximumFractionDigits:0}) + '</span></td><td>/year</td></tr>';

  html += '</tbody></table>';
  html += '</div>';

  document.getElementById('daf_results').innerHTML = html;
  showToast('DAF analysis complete!', 'success');
}

function resetDAF() {
  document.getElementById('daf_results').innerHTML = '';
  showToast('DAF calculator reset', 'info');
}

// ========== END DAF CALCULATOR ==========
// ========== GOOGLE SHEETS SYNC ==========

function connectGoogleSheet() {
  var url = document.getElementById('sheets_url').value;
  if (!url || !url.includes('docs.google.com/spreadsheets')) {
    showToast('Please enter a valid Google Sheets URL', 'error');
    return;
  }

  // Simulate connection (in real implementation, would use Google Sheets API)
  document.getElementById('sheets_status_dot').style.background = '#fbbf24';
  document.getElementById('sheets_status_text').textContent = 'Connecting...';

  setTimeout(function() {
    document.getElementById('sheets_status_dot').style.background = '#4ade80';
    document.getElementById('sheets_status_text').textContent = 'Connected';
    document.getElementById('last_sync').value = new Date().toLocaleString();
    showToast('Connected to Google Sheet!', 'success');
  }, 1500);
}

function testSheetConnection() {
  var url = document.getElementById('sheets_url').value;
  if (!url) {
    showToast('Please enter a Sheet URL first', 'error');
    return;
  }
  showToast('Testing connection...', 'info');
  setTimeout(function() {
    showToast('Connection test successful!', 'success');
  }, 1000);
}

function exportToSheets() {
  var selections = [];
  if (document.getElementById('exp_flow').checked) selections.push('Flow Data');
  if (document.getElementById('exp_do').checked) selections.push('DO Readings');
  if (document.getElementById('exp_mlss').checked) selections.push('MLSS/SVI');
  if (document.getElementById('exp_sludge').checked) selections.push('Sludge Data');
  if (document.getElementById('exp_bod').checked) selections.push('BOD/COD');
  if (document.getElementById('exp_tss').checked) selections.push('TSS');
  if (document.getElementById('exp_nutrients').checked) selections.push('Nutrients');

  if (selections.length === 0) {
    showToast('Please select data to export', 'error');
    return;
  }

  var html = '<div style="background:#065f46;padding:20px;border-radius:12px;border-left:4px solid #4ade80">';
  html += '<h4 style="margin:0 0 15px 0;color:#4ade80">‚úÖ Export Successful</h4>';
  html += '<p>Exported ' + selections.length + ' data categories to Google Sheets:</p>';
  html += '<ul style="margin:10px 0 0 20px">';
  selections.forEach(function(s) { html += '<li>' + s + '</li>'; });
  html += '</ul>';
  html += '<p style="margin-top:15px;font-size:12px;opacity:0.8">Last sync: ' + new Date().toLocaleString() + '</p>';
  html += '</div>';

  document.getElementById('sheets_results').innerHTML = html;
  document.getElementById('last_sync').value = new Date().toLocaleString();
  showToast('Data exported to Google Sheets!', 'success');
}

function scheduleAutoSync() {
  var freq = document.getElementById('sync_freq').value;
  var time = document.getElementById('sync_time').value;

  if (freq === 'manual') {
    showToast('Auto-sync disabled', 'info');
    return;
  }

  showToast('Auto-sync scheduled: ' + freq + ' at ' + time, 'success');
}

function downloadCSV() {
  // Generate sample CSV data
  var csvContent = 'Date,Flow (MGD),DO (mg/L),MLSS (mg/L),SVI,pH,Temp (F)\n';
  var today = new Date();
  for (var i = 6; i >= 0; i--) {
    var d = new Date(today);
    d.setDate(d.getDate() - i);
    csvContent += d.toLocaleDateString() + ',' + (3 + Math.random()).toFixed(2) + ',' +
                  (1.5 + Math.random()).toFixed(1) + ',' + (2800 + Math.random()*400).toFixed(0) + ',' +
                  (120 + Math.random()*40).toFixed(0) + ',' + (6.8 + Math.random()*0.4).toFixed(1) + ',' +
                  (68 + Math.random()*8).toFixed(0) + '\n';
  }

  var blob = new Blob([csvContent], { type: 'text/csv' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_data_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  showToast('CSV downloaded!', 'success');
}

// ========== END GOOGLE SHEETS SYNC ==========
// ========== SERVICE PROPOSAL GENERATOR ==========

function generateServiceProposal() {
  var client = document.getElementById('prop_client').value || 'Client Name';
  var contact = document.getElementById('prop_contact').value || 'Contact Person';
  var facility = document.getElementById('prop_facility').value || 'WWTP';
  var capacity = document.getElementById('prop_capacity').value || '5.0';
  var hourly = parseFloat(document.getElementById('prop_hourly').value) || 150;
  var retainer = parseFloat(document.getElementById('prop_retainer').value) || 2500;
  var visit = parseFloat(document.getElementById('prop_visit').value) || 500;
  var term = document.getElementById('prop_term').value;

  // Calculate annual value
  var visitsPerMonth = document.getElementById('svc_monthly').checked ? 1 : 0;
  var annualVisits = visitsPerMonth * 12;
  var annualRetainer = retainer * 12;
  var annualVisitCost = annualVisits * visit;
  var annualTotal = annualRetainer + annualVisitCost;

  // Get selected services
  var services = [];
  if (document.getElementById('svc_monthly').checked) services.push('Monthly Site Visits');
  if (document.getElementById('svc_process').checked) services.push('Process Optimization');
  if (document.getElementById('svc_troubleshoot').checked) services.push('24/7 Troubleshooting Support');
  if (document.getElementById('svc_training').checked) services.push('Operator Training');
  if (document.getElementById('svc_dmr').checked) services.push('DMR Review & Assistance');
  if (document.getElementById('svc_reports').checked) services.push('Monthly Status Reports');
  if (document.getElementById('svc_permit').checked) services.push('Permit Compliance Support');
  if (document.getElementById('svc_audit').checked) services.push('Annual Compliance Audit');

  var html = '<div style="background:white;color:#1a1a2e;padding:30px;border-radius:12px;font-family:Georgia,serif">';
  html += '<div style="text-align:center;border-bottom:3px solid #0077b6;padding-bottom:20px;margin-bottom:20px">';
  html += '<h1 style="margin:0;color:#0077b6;font-size:20px">WASTEWATER CONSULTING SERVICES</h1>';
  html += '<h2 style="margin:10px 0 0 0;color:#333;font-size:18px;font-weight:normal">Service Proposal</h2>';
  html += '</div>';

  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px">';
  html += '<div><strong>Prepared For:</strong><br>' + client + '<br>Attn: ' + contact + '</div>';
  html += '<div style="text-align:right"><strong>Date:</strong> ' + new Date().toLocaleDateString() + '<br><strong>Valid For:</strong> 30 Days</div>';
  html += '</div>';

  html += '<div style="background:#f0f9ff;padding:20px;border-radius:8px;margin-bottom:20px">';
  html += '<h3 style="margin:0 0 10px 0;color:#0077b6">Facility: ' + facility + '</h3>';
  html += '<p style="margin:0">Design Capacity: ' + capacity + ' MGD | Treatment: ' + document.getElementById('prop_treatment').value.replace('_', ' ').toUpperCase() + '</p>';
  html += '</div>';

  html += '<h3 style="color:#0077b6;border-bottom:1px solid #ccc;padding-bottom:10px">Scope of Services</h3>';
  html += '<ul style="line-height:1.8">';
  services.forEach(function(s) { html += '<li>' + s + '</li>'; });
  html += '</ul>';

  html += '<h3 style="color:#0077b6;border-bottom:1px solid #ccc;padding-bottom:10px;margin-top:30px">Investment Summary</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  html += '<tr style="background:#0077b6;color:white"><th style="padding:12px;text-align:left">Item</th><th style="padding:12px;text-align:right">Amount</th></tr>';
  html += '<tr style="border-bottom:1px solid #ddd"><td style="padding:12px">Monthly Retainer</td><td style="padding:12px;text-align:right">$' + retainer.toLocaleString() + '/month</td></tr>';
  if (visitsPerMonth > 0) {
    html += '<tr style="border-bottom:1px solid #ddd"><td style="padding:12px">Site Visits (' + visitsPerMonth + '/month)</td><td style="padding:12px;text-align:right">$' + visit.toLocaleString() + '/visit</td></tr>';
  }
  html += '<tr style="border-bottom:1px solid #ddd"><td style="padding:12px">Additional Hours (as needed)</td><td style="padding:12px;text-align:right">$' + hourly.toLocaleString() + '/hour</td></tr>';
  html += '<tr style="background:#f0f9ff;font-weight:bold"><td style="padding:12px">Estimated Annual Investment</td><td style="padding:12px;text-align:right;color:#0077b6;font-size:18px">$' + annualTotal.toLocaleString() + '</td></tr>';
  html += '</table>';

  html += '<div style="background:#065f46;color:white;padding:15px;border-radius:8px;margin-top:20px">';
  html += '<strong>Contract Term:</strong> ' + term.replace('_', ' ').replace('month', ' Month').replace('annual', 'Annual').replace('year', ' Year') + ' | ';
  html += '<strong>Payment:</strong> Net 30 Days';
  html += '</div>';

  html += '</div>';

  document.getElementById('proposal_preview').innerHTML = html;
  showToast('Proposal generated!', 'success');
}

function previewProposal() {
  generateServiceProposal();
}

function saveProposalTemplate() {
  showToast('Template saved for future use!', 'success');
}

function clearProposalForm() {
  document.getElementById('prop_client').value = '';
  document.getElementById('prop_contact').value = '';
  document.getElementById('prop_facility').value = '';
  document.getElementById('prop_email').value = '';
  document.getElementById('prop_phone').value = '';
  document.getElementById('prop_address').value = '';
  document.getElementById('proposal_preview').innerHTML = '';
  showToast('Form cleared', 'info');
}

// ========== END SERVICE PROPOSAL GENERATOR ==========
// ========== ENHANCED FEATURES v5.1.0 ==========

// Quick Calculate All - runs all calculators at once
function calculateAll() {
  const calcs = ['calcOLR', 'calcFM', 'calcSVI', 'calcHRT', 'calcBODeff', 'calcRAS', 'calcChlorine', 'calcPolymer'];
  let count = 0;
  calcs.forEach(fn => {
    try {
      if (typeof window[fn] === 'function') {
        window[fn]();
        count++;
      }
    } catch(e) {}
  });
  showToast('Calculated ' + count + ' parameters', 'success');
}

// Export all results to text
function exportResults() {
  let results = '=== WWTP COMMAND CENTER RESULTS ===\n';
  results += 'Generated: ' + new Date().toLocaleString() + '\n\n';

  const resultSpans = document.querySelectorAll('.result');
  resultSpans.forEach(span => {
    if (span.textContent && span.textContent !== '-') {
      const row = span.closest('tr');
      if (row) {
        const label = row.querySelector('.rowh');
        if (label) {
          results += label.textContent + ': ' + span.textContent + '\n';
        }
      }
    }
  });

  const blob = new Blob([results], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp_results_' + new Date().toISOString().split('T')[0] + '.txt';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Results exported!', 'success');
}

// Print current panel
function printPanel() {
  const activePanel = document.querySelector('.panel.active');
  if (activePanel) {
    const printContent = activePanel.innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<html><head><title>WWTP Command Center v9.6.0</title>');
    printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px}table{width:100%;border-collapse:collapse;margin:10px 0}td,th{border:1px solid #ddd;padding:8px;text-align:left}.section{margin:20px 0;padding:15px;border:1px solid #ccc;border-radius:8px}.section-h{font-weight:bold;font-size:18px;margin-bottom:10px}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write('<h1>WWTP Command Center Report</h1>');
    printWindow.document.write('<p>Generated: ' + new Date().toLocaleString() + '</p>');
    printWindow.document.write(printContent);
    printWindow.document.write('');
    printWindow.document.close();
    printWindow.print();
  }
}

// Reset all calculators
function resetAll() {
  if (confirm('Reset all calculator values to defaults?')) {
    const resets = ['resetOLR', 'resetFM', 'resetSVI', 'resetHRT', 'resetBODeff', 'resetRAS', 'resetChlorine', 'resetPolymer', 'resetPump', 'resetWAS', 'resetSRTmain', 'resetSOR', 'resetWOR', 'resetSLR', 'resetMCRT', 'resetOUR', 'resetNH3', 'resetPhos', 'resetTSS', 'resetGrit', 'resetDigester'];
    resets.forEach(fn => {
      try {
        if (typeof window[fn] === 'function') window[fn]();
      } catch(e) {}
    });
    showToast('All calculators reset', 'info');
  }
}

// Quick status check
function quickStatus() {
  const fm = document.getElementById('r_fm');
  const svi = document.getElementById('r_svi');
  const bod = document.getElementById('r_bod_eff');

  let status = 'üìä Quick Status:\n';
  status += '‚Ä¢ F/M Ratio: ' + (fm ? fm.textContent : 'N/A') + '\n';
  status += '‚Ä¢ SVI: ' + (svi ? svi.textContent : 'N/A') + '\n';
  status += '‚Ä¢ BOD Removal: ' + (bod ? bod.textContent : 'N/A') + '%\n';

  alert(status);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.ctrlKey || e.metaKey) {
    switch(e.key) {
      case 's':
        e.preventDefault();
        if (typeof saveData === 'function') saveData();
        break;
      case 'p':
        e.preventDefault();
        printPanel();
        break;
      case 'e':
        e.preventDefault();
        exportResults();
        break;
    }
  }
});

</script>

<div id="fab-menu" style="position:fixed;bottom:20px;right:20px;z-index:1000">
<button onclick="document.getElementById('fab-options').style.display=document.getElementById('fab-options').style.display==='none'?'flex':'none'" style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;font-size:18px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.3)">‚öôÔ∏è</button>
<div id="fab-options" style="display:none;flex-direction:column;gap:8px;position:absolute;bottom:65px;right:0">
<button onclick="calculateAll();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#06d6a0;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">‚ö° Calculate All</button>
<button onclick="exportResults();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#0077b6;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üì§ Export Results</button>
<button onclick="quickStatus();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#ffd166;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üìä Quick Status</button>
<button onclick="printPanel();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#00b4d8;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üñ®Ô∏è Print Panel</button>
</div>
</div>
<script>
// ========== VOICE CONTROL SYSTEM v5.1.0 ==========

var voiceRecognition = null;
var isListening = false;

// Initialize Voice Control
function initVoice() {
  if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    voiceRecognition = new SpeechRecognition();
    voiceRecognition.continuous = false;
    voiceRecognition.interimResults = false;
    voiceRecognition.lang = 'en-US';

    voiceRecognition.onresult = function(event) {
      var transcript = event.results[0][0].transcript.toLowerCase();
      showVoiceFeedback('üéØ Heard: "' + transcript + '"');
      processVoiceCommand(transcript);
    };

    voiceRecognition.onerror = function(event) {
      showVoiceFeedback('‚ùå Error: ' + event.error);
      stopListening();
    };

    voiceRecognition.onend = function() {
      stopListening();
    };

  } else {
    var btn = document.getElementById('voiceBtn');
    if (btn) btn.style.display = 'none';
  }
}

// Toggle voice listening
function toggleVoice() {
  if (isListening) {
    stopListening();
  } else {
    startListening();
  }
}

// Start listening
function startListening() {
  if (!voiceRecognition) {
    showVoiceFeedback('‚ùå Voice not supported in this browser');
    return;
  }
  try {
    voiceRecognition.start();
    isListening = true;
    document.getElementById('voiceBtn').classList.add('listening');
    showVoiceFeedback('üé§ Listening... Say a command');
  } catch(e) {
    showVoiceFeedback('‚ùå Could not start voice recognition');
  }
}

// Stop listening
function stopListening() {
  isListening = false;
  document.getElementById('voiceBtn').classList.remove('listening');
  if (voiceRecognition) {
    try { voiceRecognition.stop(); } catch(e) {}
  }
  setTimeout(function() {
    document.getElementById('voiceFeedback').classList.remove('active');
  }, 3000);
}

// Show voice feedback
function showVoiceFeedback(text) {
  var feedback = document.getElementById('voiceFeedback');
  feedback.textContent = text;
  feedback.classList.add('active');
}

// Process voice commands
function processVoiceCommand(cmd) {
  var executed = false;

  // Navigation commands
  if (cmd.includes('dashboard') || cmd.includes('home')) {
    switchPanel('dashboard');
    showVoiceFeedback('‚úì Switched to Dashboard');
    executed = true;
  } else if (cmd.includes('calculator') || cmd.includes('calculation') || cmd.includes('process')) {
    switchPanel('hydraulics');
    showVoiceFeedback('‚úì Switched to Process Calculations');
    executed = true;
  } else if (cmd.includes('operator') || cmd.includes('tools') || cmd.includes('training')) {
    switchPanel('daily-ops');
    showVoiceFeedback('‚úì Switched to Operator Tools');
    executed = true;
  } else if (cmd.includes('report')) {
    switchPanel('reports');
    showVoiceFeedback('‚úì Switched to Reports');
    executed = true;
  } else if (cmd.includes('maintenance')) {
    switchPanel('maintenance');
    showVoiceFeedback('‚úì Switched to Maintenance');
    executed = true;
  } else if (cmd.includes('energy')) {
    switchPanel('aeration');
    showVoiceFeedback('‚úì Switched to Energy');
    executed = true;
  } else if (cmd.includes('cost')) {
    switchPanel('chemicals');
    showVoiceFeedback('‚úì Switched to Cost Analysis');
    executed = true;
  } else if (cmd.includes('diagnostic')) {
    switchPanel('wizards');
    showVoiceFeedback('‚úì Switched to Diagnostics');
    executed = true;
  }

  // Action commands
  else if (cmd.includes('calculate all') || cmd.includes('run all')) {
    calculateAll();
    showVoiceFeedback('‚úì Running all calculations...');
    executed = true;
  } else if (cmd.includes('save')) {
    saveAllData();
    showVoiceFeedback('‚úì Data saved!');
    executed = true;
  } else if (cmd.includes('export')) {
    exportResults();
    showVoiceFeedback('‚úì Exporting results...');
    executed = true;
  } else if (cmd.includes('print')) {
    printPanel();
    showVoiceFeedback('‚úì Printing...');
    executed = true;
  } else if (cmd.includes('reset')) {
    resetAll();
    showVoiceFeedback('‚úì Reset complete');
    executed = true;
  } else if (cmd.includes('status') || cmd.includes('quick status')) {
    quickStatus();
    showVoiceFeedback('‚úì Showing status...');
    executed = true;
  }

  // Wizard commands
  else if (cmd.includes('f/m') || cmd.includes('f m') || cmd.includes('food to microorganism')) {
    startWizard('fm');
    showVoiceFeedback('‚úì Starting F/M Wizard');
    executed = true;
  } else if (cmd.includes('srt') || cmd.includes('solids retention')) {
    startWizard('srt');
    showVoiceFeedback('‚úì Starting SRT Wizard');
    executed = true;
  } else if (cmd.includes('svi') || cmd.includes('sludge volume')) {
    startWizard('svi');
    showVoiceFeedback('‚úì Starting SVI Wizard');
    executed = true;
  } else if (cmd.includes('chlorine')) {
    startWizard('chlorine');
    showVoiceFeedback('‚úì Starting Chlorine Wizard');
    executed = true;
  }

  // Help command
  else if (cmd.includes('help') || cmd.includes('commands')) {
    showVoiceHelp();
    showVoiceFeedback('‚úì Showing voice commands');
    executed = true;
  }

  // Dark mode
  else if (cmd.includes('dark mode') || cmd.includes('night mode')) {
    toggleDarkMode();
    showVoiceFeedback('‚úì Toggled dark mode');
    executed = true;
  }

  if (!executed) {
    showVoiceFeedback('‚ùì Command not recognized. Say "help" for commands.');
    speakText('Command not recognized. Say help for available commands.');
  } else {
    speakText('Done');
  }
}

// Text to speech
function speakText(text) {
  if ('speechSynthesis' in window) {
    var utterance = new SpeechSynthesisUtterance(text);
    utterance.rate = 1.0;
    utterance.pitch = 1.0;
    speechSynthesis.speak(utterance);
  }
}

// Show voice help modal
function showVoiceHelp() {
  var html = '<div style="max-width:500px">';
  html += '<h3 style="color:#4ade80;margin:0 0 15px 0">üé§ Voice Commands</h3>';
  html += '<p style="color:#94a3b8;margin-bottom:15px">Click the mic button and say any of these commands:</p>';

  html += '<div class="voice-commands-list">';
  html += '<div><strong style="color:#60a5fa">Navigation:</strong></div>';
  html += '<div><code>"Dashboard"</code> - Go to dashboard</div>';
  html += '<div><code>"Calculators"</code> - Go to process calculations</div>';
  html += '<div><code>"Operator tools"</code> - Go to operator tools</div>';
  html += '<div><code>"Reports"</code> - Go to reports</div>';
  html += '<div><code>"Maintenance"</code> - Go to maintenance</div>';
  html += '</div>';

  html += '<div class="voice-commands-list" style="margin-top:10px">';
  html += '<div><strong style="color:#60a5fa">Actions:</strong></div>';
  html += '<div><code>"Calculate all"</code> - Run all calculations</div>';
  html += '<div><code>"Save"</code> - Save all data</div>';
  html += '<div><code>"Export"</code> - Export results</div>';
  html += '<div><code>"Print"</code> - Print current panel</div>';
  html += '<div><code>"Quick status"</code> - Show plant status</div>';
  html += '</div>';

  html += '<div class="voice-commands-list" style="margin-top:10px">';
  html += '<div><strong style="color:#60a5fa">Wizards:</strong></div>';
  html += '<div><code>"F/M wizard"</code> - Start F/M calculation</div>';
  html += '<div><code>"SRT wizard"</code> - Start SRT calculation</div>';
  html += '<div><code>"SVI wizard"</code> - Start SVI calculation</div>';
  html += '<div><code>"Chlorine wizard"</code> - Start chlorine dosing</div>';
  html += '</div>';

  html += '<div class="voice-commands-list" style="margin-top:10px">';
  html += '<div><strong style="color:#60a5fa">Other:</strong></div>';
  html += '<div><code>"Help"</code> - Show this help</div>';
  html += '<div><code>"Dark mode"</code> - Toggle dark mode</div>';
  html += '</div>';

  html += '</div>';

  showModal('Voice Commands', html);
}

// Duplicate switchPanel removed - using main function

// Initialize voice on page load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initVoice, 1000);
});

// ========== END VOICE CONTROL SYSTEM ==========
// Belt Press Calculator
function calcBeltPress() {
  const feedSolids = parseFloat(document.getElementById('bp_feed').value) || 3;
  const cakeSolids = parseFloat(document.getElementById('bp_cake').value) || 22;
  const feedFlow = parseFloat(document.getElementById('bp_rate').value) || 150;
  const polyDose = parseFloat(document.getElementById('bp_poly').value) || 8;

  // Dry solids in (lb/hr)
  const drySolidsIn = feedFlow * 60 * 8.34 * (feedSolids / 100);

  // Cake production (wet lb/hr)
  const cakeProduction = drySolidsIn / (cakeSolids / 100);

  // Polymer usage (lb/hr) = (Dry Tons/hr) √ó (lb polymer/dry ton)
  const dryTonsHr = drySolidsIn / 2000;
  const polymerUsage = dryTonsHr * polyDose;

  // Capture rate (assumed 95% typical)
  const captureRate = 95;

  document.getElementById('r_bp_dry').textContent = drySolidsIn.toFixed(0);
  document.getElementById('r_bp_cake').textContent = cakeProduction.toFixed(0);
  document.getElementById('r_bp_capture').textContent = captureRate.toFixed(0);
  document.getElementById('r_bp_polymer').textContent = polymerUsage.toFixed(1);

  if (typeof showToast === 'function') showToast('Belt Press calculated', 'success');
}

function resetBeltPress() {
  document.getElementById('bp_feed').value = '3';
  document.getElementById('bp_cake').value = '22';
  document.getElementById('bp_rate').value = '150';
  document.getElementById('bp_poly').value = '8';
  ['r_bp_dry', 'r_bp_cake', 'r_bp_capture', 'r_bp_polymer'].forEach(id => {
    if(document.getElementById(id)) document.getElementById(id).textContent = '-';
  });
}

// ==================== SBR FUNCTIONS ====================

function calcSBRCycle() {
  const flow = parseFloat(document.getElementById('sbr_flow').value) || 2;
  const basins = parseInt(document.getElementById('sbr_basins').value) || 2;
  const vol = parseFloat(document.getElementById('sbr_vol').value) || 0.5;
  const fill = parseFloat(document.getElementById('sbr_fill').value) || 60;
  const react = parseFloat(document.getElementById('sbr_react').value) || 120;
  const settle = parseFloat(document.getElementById('sbr_settle').value) || 60;
  const decant = parseFloat(document.getElementById('sbr_decant').value) || 45;
  const idle = parseFloat(document.getElementById('sbr_idle').value) || 15;

  const totalCycle = fill + react + settle + decant + idle;
  const cyclesPerDay = 1440 / totalCycle;
  const decantVol = (flow / basins) / cyclesPerDay; // MG per decant
  const treatmentCap = decantVol * cyclesPerDay * basins;
  const hrt = (vol * 1000000) / ((flow / basins / cyclesPerDay) * 1000000) * (totalCycle / 60);
  const fillFrac = (decantVol / vol) * 100;

  document.getElementById('r_sbr_cycle').textContent = totalCycle.toFixed(0);
  document.getElementById('r_sbr_cpd').textContent = cyclesPerDay.toFixed(1);
  document.getElementById('r_sbr_cap').textContent = treatmentCap.toFixed(2);
  document.getElementById('r_sbr_hrt').textContent = hrt.toFixed(1);
  document.getElementById('r_sbr_decvol').textContent = decantVol.toFixed(3);
  document.getElementById('r_sbr_fillfrac').textContent = fillFrac.toFixed(1);

  // Status indicators
  document.getElementById('s_sbr_cycle').textContent = totalCycle <= 360 ? '‚úì Good' : totalCycle <= 480 ? '‚ö† Long' : '‚úó Too Long';
  document.getElementById('s_sbr_cycle').className = 'status ' + (totalCycle <= 360 ? 'ok' : totalCycle <= 480 ? 'warn' : 'bad');
  document.getElementById('s_sbr_cpd').textContent = cyclesPerDay >= 3 ? '‚úì Good' : '‚ö† Low';
  document.getElementById('s_sbr_cpd').className = 'status ' + (cyclesPerDay >= 3 ? 'ok' : 'warn');
  document.getElementById('s_sbr_cap').textContent = treatmentCap >= flow ? '‚úì Adequate' : '‚úó Under Capacity';
  document.getElementById('s_sbr_cap').className = 'status ' + (treatmentCap >= flow ? 'ok' : 'bad');
  document.getElementById('s_sbr_hrt').textContent = hrt >= 4 ? '‚úì Good' : '‚ö† Short';
  document.getElementById('s_sbr_hrt').className = 'status ' + (hrt >= 4 ? 'ok' : 'warn');
}

function resetSBRCycle() {
  ['sbr_flow','sbr_basins','sbr_vol','sbr_fill','sbr_react','sbr_settle','sbr_decant','sbr_idle'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','2','0.5','60','120','60','45','15'][i];
  });
  ['r_sbr_cycle','r_sbr_cpd','r_sbr_cap','r_sbr_hrt','r_sbr_decvol','r_sbr_fillfrac','s_sbr_cycle','s_sbr_cpd','s_sbr_cap','s_sbr_hrt'].forEach(id => {
    if(document.getElementById(id)) document.getElementById(id).textContent = '-';
  });
}

function calcSBRAeration() {
  const flow = parseFloat(document.getElementById('sbr_flow').value) || 2;
  const bodIn = parseFloat(document.getElementById('sbr_bod').value) || 200;
  const bodOut = parseFloat(document.getElementById('sbr_bod_eff').value) || 10;
  const nh3 = parseFloat(document.getElementById('sbr_nh3').value) || 30;
  const mlss = parseFloat(document.getElementById('sbr_mlss').value) || 3500;
  const srt = parseFloat(document.getElementById('sbr_srt').value) || 15;
  const alpha = parseFloat(document.getElementById('sbr_alpha').value) || 0.5;
  const beta = parseFloat(document.getElementById('sbr_beta').value) || 0.95;
  const temp = parseFloat(document.getElementById('sbr_temp').value) || 20;
  const basins = parseInt(document.getElementById('sbr_basins').value) || 2;

  // Carbonaceous O2 demand: 1.1-1.5 lb O2/lb BOD removed
  const bodRemoved = (bodIn - bodOut) * flow * 8.34;
  const cod = bodRemoved * 1.2;

  // Nitrogenous O2 demand: 4.6 lb O2/lb NH3-N oxidized
  const nod = nh3 * flow * 8.34 * 4.6;

  const aor = cod + nod;

  // Convert AOR to SOTR using alpha, beta, temp correction
  const theta = Math.pow(1.024, temp - 20);
  const cSat = 9.09; // mg/L at 20C
  const cOp = 2.0; // operating DO
  const sotr = aor / (alpha * theta * beta * ((cSat - cOp) / cSat));

  // Air required at 25% OTE
  const airReq = (sotr / 24) / (0.075 * 0.232 * 0.25) / 60;
  const airPerBasin = airReq / basins;

  document.getElementById('r_sbr_cod').textContent = cod.toFixed(0);
  document.getElementById('r_sbr_nod').textContent = nod.toFixed(0);
  document.getElementById('r_sbr_aor').textContent = aor.toFixed(0);
  document.getElementById('r_sbr_sotr').textContent = (sotr/24).toFixed(1);
  document.getElementById('r_sbr_air').textContent = airReq.toFixed(0);
  document.getElementById('r_sbr_airbasin').textContent = airPerBasin.toFixed(0);
}

function resetSBRAeration() {
  ['sbr_bod','sbr_bod_eff','sbr_nh3','sbr_mlss','sbr_srt','sbr_alpha','sbr_beta','sbr_temp'].forEach((id,i) => {
    document.getElementById(id).value = ['200','10','30','3500','15','0.5','0.95','20'][i];
  });
  ['r_sbr_cod','r_sbr_nod','r_sbr_aor','r_sbr_sotr','r_sbr_air','r_sbr_airbasin'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcSBRSettle() {
  const mlss = parseFloat(document.getElementById('sbr_set_mlss').value) || 3500;
  const svi = parseFloat(document.getElementById('sbr_svi').value) || 120;
  const settleTime = parseFloat(document.getElementById('sbr_set_time').value) || 60;
  const depth = parseFloat(document.getElementById('sbr_depth').value) || 18;
  const decDepth = parseFloat(document.getElementById('sbr_decdepth').value) || 4;

  // Sludge volume after settling
  const sludgeVolPct = (mlss * svi) / 10000;
  const blanketHeight = depth * (sludgeVolPct / 100);
  const clearWater = depth - blanketHeight;
  const settleVel = (depth - blanketHeight) / (settleTime / 60);
  const margin = clearWater - decDepth;

  document.getElementById('r_sbr_blanket').textContent = blanketHeight.toFixed(1);
  document.getElementById('r_sbr_clear').textContent = clearWater.toFixed(1);
  document.getElementById('r_sbr_sv').textContent = settleVel.toFixed(1);
  document.getElementById('r_sbr_margin').textContent = margin.toFixed(1);
  document.getElementById('r_sbr_sludgevol').textContent = sludgeVolPct.toFixed(1);

  document.getElementById('s_sbr_blanket').textContent = blanketHeight < depth * 0.5 ? '‚úì Good' : '‚ö† High';
  document.getElementById('s_sbr_blanket').className = 'status ' + (blanketHeight < depth * 0.5 ? 'ok' : 'warn');
  document.getElementById('s_sbr_clear').textContent = clearWater > 6 ? '‚úì Good' : '‚ö† Low';
  document.getElementById('s_sbr_clear').className = 'status ' + (clearWater > 6 ? 'ok' : 'warn');
  document.getElementById('s_sbr_margin').textContent = margin > 2 ? '‚úì Safe' : margin > 0 ? '‚ö† Tight' : '‚úó Risk';
  document.getElementById('s_sbr_margin').className = 'status ' + (margin > 2 ? 'ok' : margin > 0 ? 'warn' : 'bad');
}

function resetSBRSettle() {
  ['sbr_set_mlss','sbr_svi','sbr_set_time','sbr_depth','sbr_decdepth'].forEach((id,i) => {
    document.getElementById(id).value = ['3500','120','60','18','4'][i];
  });
  ['r_sbr_blanket','r_sbr_clear','r_sbr_sv','r_sbr_margin','r_sbr_sludgevol','s_sbr_blanket','s_sbr_clear','s_sbr_margin'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcSBRLoading() {
  const flow = parseFloat(document.getElementById('sbr_ld_flow').value) || 2;
  const bod = parseFloat(document.getElementById('sbr_ld_bod').value) || 200;
  const vol = parseFloat(document.getElementById('sbr_ld_vol').value) || 0.5;
  const basins = parseInt(document.getElementById('sbr_ld_basins').value) || 2;
  const mlss = parseFloat(document.getElementById('sbr_ld_mlss').value) || 3500;
  const vssRatio = parseFloat(document.getElementById('sbr_ld_vss').value) || 0.8;

  const totalVol = vol * basins;
  const bodLoad = flow * bod * 8.34;
  const mlvss = mlss * vssRatio;
  const inventory = totalVol * mlss * 8.34;
  const mlvssInv = totalVol * mlvss * 8.34;
  const fm = bodLoad / mlvssInv;
  const vlr = bodLoad / (totalVol * 1000000 / 7.48 / 1000);
  const hrt = (totalVol / flow) * 24;

  document.getElementById('r_sbr_fm').textContent = fm.toFixed(3);
  document.getElementById('r_sbr_vlr').textContent = vlr.toFixed(1);
  document.getElementById('r_sbr_inv').textContent = inventory.toFixed(0);
  document.getElementById('r_sbr_bodload').textContent = bodLoad.toFixed(0);
  document.getElementById('r_sbr_syshrt').textContent = hrt.toFixed(1);

  document.getElementById('s_sbr_fm').textContent = fm >= 0.05 && fm <= 0.15 ? '‚úì Extended Air' : fm > 0.15 && fm <= 0.4 ? '‚úì Conv.' : '‚ö† Check';
  document.getElementById('s_sbr_fm').className = 'status ' + (fm >= 0.05 && fm <= 0.4 ? 'ok' : 'warn');
  document.getElementById('s_sbr_vlr').textContent = vlr < 40 ? '‚úì Normal' : '‚ö† High';
  document.getElementById('s_sbr_vlr').className = 'status ' + (vlr < 40 ? 'ok' : 'warn');
}

function resetSBRLoading() {
  ['sbr_ld_flow','sbr_ld_bod','sbr_ld_vol','sbr_ld_basins','sbr_ld_mlss','sbr_ld_vss'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','200','0.5','2','3500','0.8'][i];
  });
  ['r_sbr_fm','r_sbr_vlr','r_sbr_inv','r_sbr_bodload','r_sbr_syshrt','s_sbr_fm','s_sbr_vlr'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcSBRWAS() {
  const vol = parseFloat(document.getElementById('sbr_was_vol').value) || 1;
  const mlss = parseFloat(document.getElementById('sbr_was_mlss').value) || 3500;
  const srt = parseFloat(document.getElementById('sbr_was_srt').value) || 15;
  const effTss = parseFloat(document.getElementById('sbr_was_tss').value) || 10;
  const effFlow = parseFloat(document.getElementById('sbr_was_flow').value) || 2;

  const inventory = vol * mlss * 8.34;
  const effLoss = effFlow * effTss * 8.34;
  const wasReq = (inventory / srt) - effLoss;
  const wasGpd = (wasReq / (mlss * 8.34)) * 1000000;

  // Assume 4 cycles per day
  const cyclesPerDay = 4;
  const wasPerCycle = wasGpd / cyclesPerDay;

  document.getElementById('r_sbr_was_inv').textContent = inventory.toFixed(0);
  document.getElementById('r_sbr_was_eff').textContent = effLoss.toFixed(0);
  document.getElementById('r_sbr_was_req').textContent = wasReq.toFixed(0);
  document.getElementById('r_sbr_was_gpd').textContent = wasGpd.toFixed(0);
  document.getElementById('r_sbr_was_cycle').textContent = wasPerCycle.toFixed(0);
}

function resetSBRWAS() {
  ['sbr_was_vol','sbr_was_mlss','sbr_was_srt','sbr_was_tss','sbr_was_flow'].forEach((id,i) => {
    document.getElementById(id).value = ['1.0','3500','15','10','2.0'][i];
  });
  ['r_sbr_was_inv','r_sbr_was_eff','r_sbr_was_req','r_sbr_was_gpd','r_sbr_was_cycle'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcSBRNutrients() {
  const tkn = parseFloat(document.getElementById('sbr_tkn').value) || 40;
  const nh3Eff = parseFloat(document.getElementById('sbr_nh3_eff').value) || 1;
  const no3 = parseFloat(document.getElementById('sbr_no3').value) || 8;
  const tpIn = parseFloat(document.getElementById('sbr_tp_in').value) || 6;
  const tpEff = parseFloat(document.getElementById('sbr_tp_eff').value) || 1;
  const anoxic = parseFloat(document.getElementById('sbr_anoxic').value) || 45;
  const anaerobic = parseFloat(document.getElementById('sbr_anaerobic').value) || 30;

  const effTN = nh3Eff + no3;
  const tnRemoval = ((tkn - effTN) / tkn) * 100;
  const nitrification = ((tkn - nh3Eff) / tkn) * 100;
  const denitrification = anoxic > 30 ? ((tkn - nh3Eff - no3) / (tkn - nh3Eff)) * 100 : 0;
  const tpRemoval = ((tpIn - tpEff) / tpIn) * 100;
  const pRelease = anaerobic > 20 ? tpIn * 3 : 0; // P release in anaerobic zone
  const bioP = tpIn - tpEff;

  document.getElementById('r_sbr_tn_rem').textContent = tnRemoval.toFixed(1);
  document.getElementById('r_sbr_nitr').textContent = nitrification.toFixed(1);
  document.getElementById('r_sbr_denitr').textContent = denitrification.toFixed(1);
  document.getElementById('r_sbr_tp_rem').textContent = tpRemoval.toFixed(1);
  document.getElementById('r_sbr_prel').textContent = pRelease.toFixed(1);
  document.getElementById('r_sbr_biop').textContent = bioP.toFixed(1);

  document.getElementById('s_sbr_tn').textContent = tnRemoval > 70 ? '‚úì Good' : tnRemoval > 50 ? '‚ö† Moderate' : '‚úó Low';
  document.getElementById('s_sbr_tn').className = 'status ' + (tnRemoval > 70 ? 'ok' : tnRemoval > 50 ? 'warn' : 'bad');
  document.getElementById('s_sbr_tp').textContent = tpRemoval > 80 ? '‚úì Good' : tpRemoval > 60 ? '‚ö† Moderate' : '‚úó Low';
  document.getElementById('s_sbr_tp').className = 'status ' + (tpRemoval > 80 ? 'ok' : tpRemoval > 60 ? 'warn' : 'bad');
}

function resetSBRNutrients() {
  ['sbr_tkn','sbr_nh3_eff','sbr_no3','sbr_tp_in','sbr_tp_eff','sbr_anoxic','sbr_anaerobic'].forEach((id,i) => {
    document.getElementById(id).value = ['40','1','8','6','1','45','30'][i];
  });
  ['r_sbr_tn_rem','r_sbr_nitr','r_sbr_denitr','r_sbr_tp_rem','r_sbr_prel','r_sbr_biop','s_sbr_tn','s_sbr_tp'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

// ==================== MBR FUNCTIONS (continued) ====================

function calcMBRCleaning() {
  const permInit = parseFloat(document.getElementById('mbr_perm_init').value) || 8;
  const permCurr = parseFloat(document.getElementById('mbr_perm_curr').value) || 5;
  const permClean = parseFloat(document.getElementById('mbr_perm_clean').value) || 7;
  const daysCIP = parseFloat(document.getElementById('mbr_days_cip').value) || 30;
  const age = parseFloat(document.getElementById('mbr_age').value) || 36;

  const foulRate = (permInit - permCurr) / daysCIP;
  const revFoul = ((permClean - permCurr) / (permInit - permCurr)) * 100;
  const irrFoul = ((permInit - permClean) / permInit) * 100;
  const cipEff = ((permClean - permCurr) / (permInit - permCurr)) * 100;

  // Days until permeability drops to 2 GFD/psi (trigger point)
  const targetPerm = 2.5;
  const daysToClean = foulRate > 0 ? (permCurr - targetPerm) / foulRate : 999;

  // Health score
  const health = permCurr > 4 ? 'Good' : permCurr > 2.5 ? 'Fair' : 'Poor';

  document.getElementById('r_mbr_foul_rate').textContent = foulRate.toFixed(3);
  document.getElementById('r_mbr_rev_foul').textContent = revFoul.toFixed(1);
  document.getElementById('r_mbr_irr_foul').textContent = irrFoul.toFixed(1);
  document.getElementById('r_mbr_cip_eff').textContent = cipEff.toFixed(1);
  document.getElementById('r_mbr_days_cip').textContent = daysToClean > 0 ? daysToClean.toFixed(0) : 'N/A';
  document.getElementById('r_mbr_health').textContent = health;

  document.getElementById('s_mbr_foul').textContent = foulRate < 0.05 ? '‚úì Normal' : foulRate < 0.1 ? '‚ö† Elevated' : '‚úó High';
  document.getElementById('s_mbr_foul').className = 'status ' + (foulRate < 0.05 ? 'ok' : foulRate < 0.1 ? 'warn' : 'bad');
  document.getElementById('s_mbr_irr').textContent = irrFoul < 15 ? '‚úì Normal' : irrFoul < 30 ? '‚ö† Aging' : '‚úó Replace Soon';
  document.getElementById('s_mbr_irr').className = 'status ' + (irrFoul < 15 ? 'ok' : irrFoul < 30 ? 'warn' : 'bad');
  document.getElementById('s_mbr_health').textContent = health === 'Good' ? '‚úì' : health === 'Fair' ? '‚ö†' : '‚úó';
  document.getElementById('s_mbr_health').className = 'status ' + (health === 'Good' ? 'ok' : health === 'Fair' ? 'warn' : 'bad');
}

function resetMBRCleaning() {
  ['mbr_perm_init','mbr_perm_curr','mbr_perm_clean','mbr_days_cip','mbr_age'].forEach((id,i) => {
    document.getElementById(id).value = ['8','5','7','30','36'][i];
  });
  ['r_mbr_foul_rate','r_mbr_rev_foul','r_mbr_irr_foul','r_mbr_cip_eff','r_mbr_days_cip','r_mbr_health'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBRLoading() {
  const flow = parseFloat(document.getElementById('mbr_ld_flow').value) || 2;
  const bod = parseFloat(document.getElementById('mbr_ld_bod').value) || 200;
  const vol = parseFloat(document.getElementById('mbr_ld_vol').value) || 0.8;
  const mlss = parseFloat(document.getElementById('mbr_ld_mlss').value) || 10000;
  const vssRatio = parseFloat(document.getElementById('mbr_ld_vss').value) || 0.8;
  const wasFlow = parseFloat(document.getElementById('mbr_ld_was').value) || 10000;
  const wasTss = parseFloat(document.getElementById('mbr_ld_wastss').value) || 10000;

  const mlvss = mlss * vssRatio;
  const bodLoad = flow * bod * 8.34;
  const inventory = vol * mlss * 8.34;
  const mlvssInv = vol * mlvss * 8.34;
  const fm = bodLoad / mlvssInv;
  const vlr = bodLoad / (vol * 1000000 / 7.48 / 1000);
  const hrt = (vol / flow) * 24;

  // SRT = Inventory / WAS rate
  const wasLb = wasFlow * wasTss * 8.34 / 1000000;
  const srt = inventory / wasLb;

  // Sludge production
  const sludgeProd = wasLb;

  document.getElementById('r_mbr_fm').textContent = fm.toFixed(3);
  document.getElementById('r_mbr_vlr').textContent = vlr.toFixed(1);
  document.getElementById('r_mbr_hrt').textContent = hrt.toFixed(1);
  document.getElementById('r_mbr_srt').textContent = srt.toFixed(1);
  document.getElementById('r_mbr_inv').textContent = inventory.toFixed(0);
  document.getElementById('r_mbr_sludge').textContent = sludgeProd.toFixed(0);

  document.getElementById('s_mbr_fm').textContent = fm >= 0.05 && fm <= 0.15 ? '‚úì Typical MBR' : fm < 0.05 ? '‚ö† Low' : '‚úó High';
  document.getElementById('s_mbr_fm').className = 'status ' + (fm >= 0.05 && fm <= 0.15 ? 'ok' : 'warn');
  document.getElementById('s_mbr_hrt').textContent = hrt >= 4 && hrt <= 12 ? '‚úì Normal' : '‚ö† Check';
  document.getElementById('s_mbr_hrt').className = 'status ' + (hrt >= 4 && hrt <= 12 ? 'ok' : 'warn');
  document.getElementById('s_mbr_srt').textContent = srt >= 10 && srt <= 30 ? '‚úì Normal' : srt > 30 ? '‚ö† Long' : '‚ö† Short';
  document.getElementById('s_mbr_srt').className = 'status ' + (srt >= 10 && srt <= 30 ? 'ok' : 'warn');
}

function resetMBRLoading() {
  ['mbr_ld_flow','mbr_ld_bod','mbr_ld_vol','mbr_ld_mlss','mbr_ld_vss','mbr_ld_was','mbr_ld_wastss'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','200','0.8','10000','0.8','10000','10000'][i];
  });
  ['r_mbr_fm','r_mbr_vlr','r_mbr_hrt','r_mbr_srt','r_mbr_inv','r_mbr_sludge'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBREnergy() {
  const flow = parseFloat(document.getElementById('mbr_en_flow').value) || 2;
  const blowHP = parseFloat(document.getElementById('mbr_blow_hp').value) || 100;
  const scourHP = parseFloat(document.getElementById('mbr_scour_hp').value) || 75;
  const permHP = parseFloat(document.getElementById('mbr_perm_hp').value) || 25;
  const recircHP = parseFloat(document.getElementById('mbr_recirc_hp').value) || 15;
  const hrs = parseFloat(document.getElementById('mbr_hrs').value) || 24;
  const rate = parseFloat(document.getElementById('mbr_rate').value) || 0.10;

  const blowKWH = (blowHP + scourHP) * 0.746 * hrs;
  const pumpKWH = (permHP + recircHP) * 0.746 * hrs;
  const totalKWH = blowKWH + pumpKWH;
  const specEnergy = totalKWH / (flow * 1000); // kWh/kgal
  const dailyCost = totalKWH * rate;
  const monthlyCost = dailyCost * 30;

  document.getElementById('r_mbr_blow_kwh').textContent = blowKWH.toFixed(0);
  document.getElementById('r_mbr_pump_kwh').textContent = pumpKWH.toFixed(0);
  document.getElementById('r_mbr_tot_kwh').textContent = totalKWH.toFixed(0);
  document.getElementById('r_mbr_spec_en').textContent = specEnergy.toFixed(2);
  document.getElementById('r_mbr_cost_day').textContent = dailyCost.toFixed(2);
  document.getElementById('r_mbr_cost_mo').textContent = monthlyCost.toFixed(0);

  document.getElementById('s_mbr_spec').textContent = specEnergy < 1.5 ? '‚úì Efficient' : specEnergy < 2.5 ? '‚ö† Typical' : '‚úó High';
  document.getElementById('s_mbr_spec').className = 'status ' + (specEnergy < 1.5 ? 'ok' : specEnergy < 2.5 ? 'warn' : 'bad');
}

function resetMBREnergy() {
  ['mbr_en_flow','mbr_blow_hp','mbr_scour_hp','mbr_perm_hp','mbr_recirc_hp','mbr_hrs','mbr_rate'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','100','75','25','15','24','0.10'][i];
  });
  ['r_mbr_blow_kwh','r_mbr_pump_kwh','r_mbr_tot_kwh','r_mbr_spec_en','r_mbr_cost_day','r_mbr_cost_mo'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function diagnoseMBR() {
  const tmpTrend = document.getElementById('mbr_tmp_trend').value;
  const permTrend = document.getElementById('mbr_perm_trend').value;
  const foam = document.getElementById('mbr_foam').value;
  const color = document.getElementById('mbr_color').value;

  let diagnosis = [];
  let actions = [];

  // TMP analysis
  if (tmpTrend === 'rapid' || tmpTrend === 'sudden') {
    diagnosis.push('‚ö†Ô∏è <b>High TMP increase detected</b> - indicates fouling');
    if (tmpTrend === 'sudden') {
      actions.push('Check for membrane damage or clogged aerators');
      actions.push('Perform emergency maintenance clean');
    } else {
      actions.push('Schedule CIP within 1-2 days');
      actions.push('Increase scour air temporarily');
    }
  }

  // Permeability analysis
  if (permTrend === 'low') {
    diagnosis.push('‚ö†Ô∏è <b>Low permeability</b> - significant fouling present');
    actions.push('Perform recovery clean (NaOCl + citric acid)');
    actions.push('Consider membrane replacement if >5 years old');
  } else if (permTrend === 'declining') {
    diagnosis.push('üìâ <b>Declining permeability</b> - monitor closely');
    actions.push('Increase maintenance clean frequency');
  }

  // Foam analysis
  if (foam === 'heavy') {
    diagnosis.push('ü´ß <b>Heavy brown foam</b> - Nocardia/filamentous growth');
    actions.push('Reduce SRT to 12-15 days');
    actions.push('Add chlorine to RAS (2-5 mg/L)');
    actions.push('Increase WAS rate');
  } else if (foam === 'white') {
    diagnosis.push('ü´ß <b>White foam</b> - surfactant/detergent in influent');
    actions.push('Check for industrial discharge');
    actions.push('May need additional pretreatment');
  }

  // Color analysis
  if (color === 'dark') {
    diagnosis.push('üîò <b>Dark/black mixed liquor</b> - septic conditions');
    actions.push('Increase aeration immediately');
    actions.push('Check blowers and diffusers');
  } else if (color === 'gray') {
    diagnosis.push('‚ö™ <b>Gray mixed liquor</b> - low DO or toxic shock');
    actions.push('Check DO levels (maintain >2 mg/L)');
    actions.push('Review influent for toxic discharge');
  } else if (color === 'light') {
    diagnosis.push('üíß <b>Light/thin mixed liquor</b> - washout or low MLSS');
    actions.push('Reduce WAS rate');
    actions.push('Check for high flows or poor settling');
  }

  if (diagnosis.length === 0) {
    diagnosis.push('‚úÖ <b>System appears normal</b>');
    actions.push('Continue routine monitoring');
  }

  const diagDiv = document.getElementById('mbr_diagnosis');
  const contentDiv = document.getElementById('mbr_diag_content');
  contentDiv.innerHTML = '<p><b>Issues Detected:</b></p><ul>' +
    diagnosis.map(d => '<li>' + d + '</li>').join('') + '</ul>' +
    '<p style="margin-top:10px"><b>Recommended Actions:</b></p><ul>' +
    actions.map(a => '<li>' + a + '</li>').join('') + '</ul>';
  diagDiv.style.display = 'block';
}

// ==================== MBBR FUNCTIONS ====================

function calcMBBRMedia() {
  const vol = parseFloat(document.getElementById('mbbr_vol').value) || 0.5;
  const fillPct = parseFloat(document.getElementById('mbbr_fill').value) || 50;
  const ssa = parseFloat(document.getElementById('mbbr_ssa').value) || 500;
  const activeFrac = parseFloat(document.getElementById('mbbr_active').value) || 0.67;

  // Media type presets
  const mediaType = document.getElementById('mbbr_media_type').value;
  let actualSSA = ssa;
  if (mediaType === 'k1' || mediaType === 'k3') actualSSA = 500;
  else if (mediaType === 'k5') actualSSA = 800;
  else if (mediaType === 'biofilm_chip') actualSSA = 3000;
  else if (mediaType === 'anoxk') actualSSA = 650;

  const volCF = vol * 1000000 / 7.48;
  const mediaVol = volCF * (fillPct / 100);
  const mediaVolM3 = mediaVol * 0.0283;

  // Total surface area
  const totalSA = mediaVolM3 * actualSSA; // m¬≤
  const totalSAsf = totalSA * 10.764; // sq ft
  const activeSA = totalSA * activeFrac;
  const activeSAsf = activeSA * 10.764;

  const mediaQty = mediaVol / 27; // cu yd

  document.getElementById('r_mbbr_vol_cf').textContent = volCF.toFixed(0);
  document.getElementById('r_mbbr_media_vol').textContent = mediaVol.toFixed(0);
  document.getElementById('r_mbbr_tsa').textContent = totalSAsf.toFixed(0);
  document.getElementById('r_mbbr_asa').textContent = activeSAsf.toFixed(0);
  document.getElementById('r_mbbr_asa_m2').textContent = activeSA.toFixed(0);
  document.getElementById('r_mbbr_media_qty').textContent = mediaQty.toFixed(0);
}

function resetMBBRMedia() {
  ['mbbr_vol','mbbr_fill','mbbr_ssa','mbbr_active'].forEach((id,i) => {
    document.getElementById(id).value = ['0.5','50','500','0.67'][i];
  });
  document.getElementById('mbbr_media_type').value = 'k1';
  ['r_mbbr_vol_cf','r_mbbr_media_vol','r_mbbr_tsa','r_mbbr_asa','r_mbbr_asa_m2','r_mbbr_media_qty'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBBRBOD() {
  const flow = parseFloat(document.getElementById('mbbr_bod_flow').value) || 2;
  const bodIn = parseFloat(document.getElementById('mbbr_bod_in').value) || 200;
  const bodOut = parseFloat(document.getElementById('mbbr_bod_out').value) || 20;
  const temp = parseFloat(document.getElementById('mbbr_bod_temp').value) || 15;
  const targetDO = parseFloat(document.getElementById('mbbr_do').value) || 3;
  const sarRate = parseFloat(document.getElementById('mbbr_sar').value) || 15;

  const bodLoad = flow * bodIn * 8.34;
  const bodRemoval = flow * (bodIn - bodOut) * 8.34;
  const bodRemovalKg = bodRemoval / 2.205;

  // Temperature correction (theta = 1.06 for BOD)
  const tempCF = Math.pow(1.06, temp - 15);
  const correctedRate = sarRate * tempCF;

  // Surface area required
  const saRequired = (bodRemovalKg * 1000) / correctedRate; // m¬≤

  // Assume we have area from media calc or use default
  const assumedSA = 5000; // m¬≤ default
  const appliedSALR = (bodRemovalKg * 1000) / assumedSA;

  const bodEff = ((bodIn - bodOut) / bodIn) * 100;

  document.getElementById('r_mbbr_bod_load').textContent = bodLoad.toFixed(0);
  document.getElementById('r_mbbr_bod_rem').textContent = bodRemoval.toFixed(0);
  document.getElementById('r_mbbr_sa_req').textContent = saRequired.toFixed(0);
  document.getElementById('r_mbbr_salr').textContent = appliedSALR.toFixed(1);
  document.getElementById('r_mbbr_temp_cf').textContent = tempCF.toFixed(2);
  document.getElementById('r_mbbr_bod_eff').textContent = bodEff.toFixed(1);

  document.getElementById('s_mbbr_salr').textContent = appliedSALR <= 20 ? '‚úì Normal' : appliedSALR <= 30 ? '‚ö† High' : '‚úó Overloaded';
  document.getElementById('s_mbbr_salr').className = 'status ' + (appliedSALR <= 20 ? 'ok' : appliedSALR <= 30 ? 'warn' : 'bad');
}

function resetMBBRBOD() {
  ['mbbr_bod_flow','mbbr_bod_in','mbbr_bod_out','mbbr_bod_temp','mbbr_do','mbbr_sar'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','200','20','15','3','15'][i];
  });
  ['r_mbbr_bod_load','r_mbbr_bod_rem','r_mbbr_sa_req','r_mbbr_salr','r_mbbr_temp_cf','r_mbbr_bod_eff'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBBRNitrif() {
  const flow = parseFloat(document.getElementById('mbbr_nit_flow').value) || 2;
  const nh3In = parseFloat(document.getElementById('mbbr_nh3_in').value) || 30;
  const nh3Out = parseFloat(document.getElementById('mbbr_nh3_out').value) || 2;
  const temp = parseFloat(document.getElementById('mbbr_nit_temp').value) || 15;
  const targetDO = parseFloat(document.getElementById('mbbr_nit_do').value) || 4;
  const nitRate = parseFloat(document.getElementById('mbbr_nit_rate').value) || 1.2;
  const availSA = parseFloat(document.getElementById('mbbr_nit_sa').value) || 5000;

  const nh3Load = flow * nh3In * 8.34;
  const nh3Removal = flow * (nh3In - nh3Out) * 8.34;
  const nh3RemovalKg = nh3Removal / 2.205;

  // Temperature correction (theta = 1.098 for nitrification)
  const tempCF = Math.pow(1.098, temp - 15);
  const correctedRate = nitRate * tempCF;

  // DO limitation
  const doFactor = targetDO / (targetDO + 1.0);
  const effectiveRate = correctedRate * doFactor;

  const saRequired = (nh3RemovalKg * 1000) / effectiveRate;
  const appliedSANR = (nh3RemovalKg * 1000) / availSA;
  const utilization = (saRequired / availSA) * 100;

  // Alkalinity consumed: 7.14 lb CaCO3 / lb NH3-N
  const alkConsumed = nh3Removal * 7.14;

  document.getElementById('r_mbbr_nh3_load').textContent = nh3Load.toFixed(0);
  document.getElementById('r_mbbr_nh3_rem').textContent = nh3Removal.toFixed(0);
  document.getElementById('r_mbbr_nit_sa_req').textContent = saRequired.toFixed(0);
  document.getElementById('r_mbbr_sanr').textContent = appliedSANR.toFixed(2);
  document.getElementById('r_mbbr_nit_util').textContent = utilization.toFixed(1);
  document.getElementById('r_mbbr_alk').textContent = alkConsumed.toFixed(0);

  document.getElementById('s_mbbr_sanr').textContent = appliedSANR <= 1.5 ? '‚úì Normal' : appliedSANR <= 2.5 ? '‚ö† High' : '‚úó Overloaded';
  document.getElementById('s_mbbr_sanr').className = 'status ' + (appliedSANR <= 1.5 ? 'ok' : appliedSANR <= 2.5 ? 'warn' : 'bad');
  document.getElementById('s_mbbr_nit_util').textContent = utilization <= 80 ? '‚úì Capacity' : utilization <= 100 ? '‚ö† Near Limit' : '‚úó Over';
  document.getElementById('s_mbbr_nit_util').className = 'status ' + (utilization <= 80 ? 'ok' : utilization <= 100 ? 'warn' : 'bad');
}

function resetMBBRNitrif() {
  ['mbbr_nit_flow','mbbr_nh3_in','mbbr_nh3_out','mbbr_nit_temp','mbbr_nit_do','mbbr_nit_rate','mbbr_nit_sa'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','30','2','15','4','1.2','5000'][i];
  });
  ['r_mbbr_nh3_load','r_mbbr_nh3_rem','r_mbbr_nit_sa_req','r_mbbr_sanr','r_mbbr_nit_util','r_mbbr_alk'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBBRAeration() {
  const flow = parseFloat(document.getElementById('mbbr_air_flow').value) || 2;
  const bodRem = parseFloat(document.getElementById('mbbr_air_bod').value) || 180;
  const nh3Rem = parseFloat(document.getElementById('mbbr_air_nh3').value) || 28;
  const vol = parseFloat(document.getElementById('mbbr_air_vol').value) || 0.5;
  const targetDO = parseFloat(document.getElementById('mbbr_air_do').value) || 4;
  const alpha = parseFloat(document.getElementById('mbbr_air_alpha').value) || 0.55;
  const ote = parseFloat(document.getElementById('mbbr_air_ote').value) || 25;

  // O2 demands
  const cod2 = flow * bodRem * 8.34 * 1.2; // 1.2 lb O2/lb BOD
  const nod2 = flow * nh3Rem * 8.34 * 4.6; // 4.6 lb O2/lb N
  const aor = cod2 + nod2;

  // SOTR (alpha correction)
  const sotr = aor / alpha;
  const sotrHr = sotr / 24;

  // Air required
  const airReq = sotrHr / (0.075 * 0.232 * (ote/100)) / 60;

  // Mixing air (rule of thumb: 1 SCFM per cu ft of media at 50% fill)
  const mediaVol = vol * 1000000 / 7.48 * 0.5; // cu ft
  const mixAir = mediaVol * 0.5; // Reduced factor for MBBR

  const totalAir = Math.max(airReq, mixAir);

  document.getElementById('r_mbbr_cod2').textContent = cod2.toFixed(0);
  document.getElementById('r_mbbr_nod2').textContent = nod2.toFixed(0);
  document.getElementById('r_mbbr_aor').textContent = aor.toFixed(0);
  document.getElementById('r_mbbr_sotr').textContent = sotrHr.toFixed(1);
  document.getElementById('r_mbbr_air').textContent = airReq.toFixed(0);
  document.getElementById('r_mbbr_mix_air').textContent = mixAir.toFixed(0);
  document.getElementById('r_mbbr_tot_air').textContent = totalAir.toFixed(0);
}

function resetMBBRAeration() {
  ['mbbr_air_flow','mbbr_air_bod','mbbr_air_nh3','mbbr_air_vol','mbbr_air_do','mbbr_air_alpha','mbbr_air_ote'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','180','28','0.5','4','0.55','25'][i];
  });
  ['r_mbbr_cod2','r_mbbr_nod2','r_mbbr_aor','r_mbbr_sotr','r_mbbr_air','r_mbbr_mix_air','r_mbbr_tot_air'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBBRHydraulics() {
  const flow = parseFloat(document.getElementById('mbbr_hyd_flow').value) || 2;
  const vol = parseFloat(document.getElementById('mbbr_hyd_vol').value) || 0.5;
  const num = parseInt(document.getElementById('mbbr_hyd_num').value) || 2;
  const length = parseFloat(document.getElementById('mbbr_hyd_l').value) || 60;
  const width = parseFloat(document.getElementById('mbbr_hyd_w').value) || 30;
  const swd = parseFloat(document.getElementById('mbbr_hyd_d').value) || 18;
  const screen = parseFloat(document.getElementById('mbbr_screen').value) || 8;

  const totalVol = vol * num;
  const hrt = (totalVol / flow) * 24;
  const hrtEach = hrt / num;

  // Velocity at screen (assume full width screen)
  const flowCFS = flow * 1000000 / 7.48 / 86400;
  const screenArea = width * swd * 0.5; // 50% open area typical
  const velocity = flowCFS / screenArea;

  const lwRatio = length / width;
  const dwRatio = swd / width;

  document.getElementById('r_mbbr_tot_vol').textContent = totalVol.toFixed(2);
  document.getElementById('r_mbbr_hrt').textContent = hrt.toFixed(1);
  document.getElementById('r_mbbr_hrt_each').textContent = hrtEach.toFixed(1);
  document.getElementById('r_mbbr_vel').textContent = velocity.toFixed(2);
  document.getElementById('r_mbbr_lw').textContent = lwRatio.toFixed(1);
  document.getElementById('r_mbbr_dw').textContent = dwRatio.toFixed(2);

  document.getElementById('s_mbbr_hrt').textContent = hrt >= 1 && hrt <= 6 ? '‚úì Normal' : '‚ö† Check';
  document.getElementById('s_mbbr_hrt').className = 'status ' + (hrt >= 1 && hrt <= 6 ? 'ok' : 'warn');
  document.getElementById('s_mbbr_vel').textContent = velocity < 1.0 ? '‚úì OK' : velocity < 2.0 ? '‚ö† High' : '‚úó Too High';
  document.getElementById('s_mbbr_vel').className = 'status ' + (velocity < 1.0 ? 'ok' : velocity < 2.0 ? 'warn' : 'bad');
  document.getElementById('s_mbbr_lw').textContent = lwRatio >= 1.5 && lwRatio <= 3 ? '‚úì Good' : '‚ö† Check';
  document.getElementById('s_mbbr_lw').className = 'status ' + (lwRatio >= 1.5 && lwRatio <= 3 ? 'ok' : 'warn');
}

function resetMBBRHydraulics() {
  ['mbbr_hyd_flow','mbbr_hyd_vol','mbbr_hyd_num','mbbr_hyd_l','mbbr_hyd_w','mbbr_hyd_d','mbbr_screen'].forEach((id,i) => {
    document.getElementById(id).value = ['2.0','0.5','2','60','30','18','8'][i];
  });
  ['r_mbbr_tot_vol','r_mbbr_hrt','r_mbbr_hrt_each','r_mbbr_vel','r_mbbr_lw','r_mbbr_dw'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcMBBRPerf() {
  const bodIn = parseFloat(document.getElementById('mbbr_perf_bod_in').value) || 200;
  const bodOut = parseFloat(document.getElementById('mbbr_perf_bod_out').value) || 15;
  const nh3In = parseFloat(document.getElementById('mbbr_perf_nh3_in').value) || 30;
  const nh3Out = parseFloat(document.getElementById('mbbr_perf_nh3_out').value) || 1;
  const flow = parseFloat(document.getElementById('mbbr_perf_flow').value) || 2;
  const sa = parseFloat(document.getElementById('mbbr_perf_sa').value) || 5000;
  const temp = parseFloat(document.getElementById('mbbr_perf_temp').value) || 18;

  const bodRem = ((bodIn - bodOut) / bodIn) * 100;
  const nh3Rem = ((nh3In - nh3Out) / nh3In) * 100;

  // Actual rates (g/m¬≤/d)
  const bodLoadKg = flow * bodIn * 8.34 / 2.205;
  const nh3LoadKg = flow * nh3In * 8.34 / 2.205;
  const salr = (bodLoadKg * 1000) / sa;
  const sanr = (nh3LoadKg * 1000) / sa;

  // Removal rates
  const bodRemKg = flow * (bodIn - bodOut) * 8.34 / 2.205;
  const nh3RemKg = flow * (nh3In - nh3Out) * 8.34 / 2.205;
  const rr = (bodRemKg * 1000) / sa;
  const nr = (nh3RemKg * 1000) / sa;

  document.getElementById('r_mbbr_perf_bod').textContent = bodRem.toFixed(1);
  document.getElementById('r_mbbr_perf_nh3').textContent = nh3Rem.toFixed(1);
  document.getElementById('r_mbbr_perf_salr').textContent = salr.toFixed(1);
  document.getElementById('r_mbbr_perf_sanr').textContent = sanr.toFixed(2);
  document.getElementById('r_mbbr_perf_rr').textContent = rr.toFixed(1);
  document.getElementById('r_mbbr_perf_nr').textContent = nr.toFixed(2);

  document.getElementById('s_mbbr_perf_bod').textContent = bodRem > 85 ? '‚úì Excellent' : bodRem > 70 ? '‚úì Good' : '‚ö† Low';
  document.getElementById('s_mbbr_perf_bod').className = 'status ' + (bodRem > 70 ? 'ok' : 'warn');
  document.getElementById('s_mbbr_perf_nh3').textContent = nh3Rem > 90 ? '‚úì Excellent' : nh3Rem > 75 ? '‚úì Good' : '‚ö† Low';
  document.getElementById('s_mbbr_perf_nh3').className = 'status ' + (nh3Rem > 75 ? 'ok' : 'warn');
  document.getElementById('s_mbbr_perf_rr').textContent = rr >= 5 && rr <= 20 ? '‚úì Normal' : '‚ö† Check';
  document.getElementById('s_mbbr_perf_rr').className = 'status ' + (rr >= 5 && rr <= 20 ? 'ok' : 'warn');
  document.getElementById('s_mbbr_perf_nr').textContent = nr >= 0.5 && nr <= 2 ? '‚úì Normal' : '‚ö† Check';
  document.getElementById('s_mbbr_perf_nr').className = 'status ' + (nr >= 0.5 && nr <= 2 ? 'ok' : 'warn');
}

function resetMBBRPerf() {
  ['mbbr_perf_bod_in','mbbr_perf_bod_out','mbbr_perf_nh3_in','mbbr_perf_nh3_out','mbbr_perf_flow','mbbr_perf_sa','mbbr_perf_temp'].forEach((id,i) => {
    document.getElementById(id).value = ['200','15','30','1','2.0','5000','18'][i];
  });
  ['r_mbbr_perf_bod','r_mbbr_perf_nh3','r_mbbr_perf_salr','r_mbbr_perf_sanr','r_mbbr_perf_rr','r_mbbr_perf_nr'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}

function calcIFAS() {
  const flow = parseFloat(document.getElementById('ifas_flow').value) || 3;
  const vol = parseFloat(document.getElementById('ifas_vol').value) || 1;
  const mlss = parseFloat(document.getElementById('ifas_mlss').value) || 3000;
  const fillPct = parseFloat(document.getElementById('ifas_fill').value) || 40;
  const ssa = parseFloat(document.getElementById('ifas_ssa').value) || 500;
  const bodLoad = parseFloat(document.getElementById('ifas_bod').value) || 5000;

  // Suspended biomass
  const suspBio = vol * mlss * 8.34;

  // Media surface area
  const volCF = vol * 1000000 / 7.48;
  const mediaVol = volCF * (fillPct / 100) * 0.0283; // m¬≥
  const surfaceArea = mediaVol * ssa * 0.67; // active m¬≤

  // Attached biomass estimate (10 g/m¬≤ typical biofilm density)
  const attBio = surfaceArea * 10 / 453.6; // lbs

  const totalBio = suspBio + attBio;

  // Effective MLSS
  const effMLSS = (totalBio / (vol * 8.34));

  // Combined F/M
  const fm = bodLoad / (totalBio * 0.8); // VSS ratio

  document.getElementById('r_ifas_susp').textContent = suspBio.toFixed(0);
  document.getElementById('r_ifas_att').textContent = attBio.toFixed(0);
  document.getElementById('r_ifas_tot').textContent = totalBio.toFixed(0);
  document.getElementById('r_ifas_eff_mlss').textContent = effMLSS.toFixed(0);
  document.getElementById('r_ifas_fm').textContent = fm.toFixed(3);
  document.getElementById('r_ifas_sa').textContent = surfaceArea.toFixed(0);

  document.getElementById('s_ifas_fm').textContent = fm >= 0.1 && fm <= 0.3 ? '‚úì Normal' : fm < 0.1 ? '‚ö† Low' : '‚ö† High';
  document.getElementById('s_ifas_fm').className = 'status ' + (fm >= 0.1 && fm <= 0.3 ? 'ok' : 'warn');
}

function resetIFAS() {
  ['ifas_flow','ifas_vol','ifas_mlss','ifas_fill','ifas_ssa','ifas_bod'].forEach((id,i) => {
    document.getElementById(id).value = ['3.0','1.0','3000','40','500','5000'][i];
  });
  ['r_ifas_susp','r_ifas_att','r_ifas_tot','r_ifas_eff_mlss','r_ifas_fm','r_ifas_sa'].forEach(id => {
    document.getElementById(id).textContent = '-';
  });
}
// SBR Cycle Time Calculator
function calcSBRCycle() {
  var flow = parseFloat(document.getElementById('sbr_flow').value) || 0;
  var basins = parseInt(document.getElementById('sbr_basins').value) || 1;
  var vol = parseFloat(document.getElementById('sbr_vol').value) || 0;
  var fill = parseFloat(document.getElementById('sbr_fill').value) || 0;
  var react = parseFloat(document.getElementById('sbr_react').value) || 0;
  var settle = parseFloat(document.getElementById('sbr_settle').value) || 0;
  var decant = parseFloat(document.getElementById('sbr_decant').value) || 0;
  var idle = parseFloat(document.getElementById('sbr_idle').value) || 0;

  var totalCycle = fill + react + settle + decant + idle;
  var cyclesPerDay = 1440 / totalCycle;
  var flowPerBasin = flow / basins;
  var hrt = (vol * basins * 24) / flow;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>Total Cycle Time</td><td><strong>' + totalCycle.toFixed(0) + '</strong></td><td>minutes</td></tr>';
  html += '<tr><td>Cycles per Day</td><td><strong>' + cyclesPerDay.toFixed(1) + '</strong></td><td>cycles</td></tr>';
  html += '<tr><td>Flow per Basin</td><td><strong>' + flowPerBasin.toFixed(2) + '</strong></td><td>MGD</td></tr>';
  html += '<tr><td>Hydraulic Retention Time</td><td><strong>' + hrt.toFixed(1) + '</strong></td><td>hours</td></tr>';
  html += '</tbody></table>';

  document.getElementById('sbr_cycle_results').innerHTML = html;
}

function resetSBRCycle() {
  document.getElementById('sbr_flow').value = '2.0';
  document.getElementById('sbr_basins').value = '2';
  document.getElementById('sbr_vol').value = '0.5';
  document.getElementById('sbr_fill').value = '60';
  document.getElementById('sbr_react').value = '120';
  document.getElementById('sbr_settle').value = '60';
  document.getElementById('sbr_decant').value = '30';
  document.getElementById('sbr_idle').value = '30';
  document.getElementById('sbr_cycle_results').innerHTML = '';
}
// Debug: check panel structure on load
document.addEventListener('DOMContentLoaded', function() {
  var sbrPanel = document.getElementById('sbr');
  if (sbrPanel) {
  } else {
  }
});

// SBR Aeration Calculator
function calcSBRAeration() {
  var bodIn = parseFloat(document.getElementById('sbr_bod_in').value) || 0;
  var bodOut = parseFloat(document.getElementById('sbr_bod_out').value) || 0;
  var flow = parseFloat(document.getElementById('sbr_aer_flow').value) || 0;
  var tkn = parseFloat(document.getElementById('sbr_tkn').value) || 0;
  var nh3Out = parseFloat(document.getElementById('sbr_nh3_out').value) || 0;
  var reactHr = parseFloat(document.getElementById('sbr_react_hr').value) || 1;

  var bodRemoved = (bodIn - bodOut) * flow * 8.34;
  var carbonO2 = bodRemoved * 1.2;
  var nOxidized = (tkn - nh3Out) * flow * 8.34;
  var nitrogenO2 = nOxidized * 4.6;
  var totalO2 = carbonO2 + nitrogenO2;
  var o2Rate = totalO2 / reactHr;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>BOD Removed</td><td><strong>' + bodRemoved.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>Carbonaceous O2 Demand</td><td><strong>' + carbonO2.toFixed(0) + '</strong></td><td>lb O2/day</td></tr>';
  html += '<tr><td>Nitrogenous O2 Demand</td><td><strong>' + nitrogenO2.toFixed(0) + '</strong></td><td>lb O2/day</td></tr>';
  html += '<tr><td>Total O2 Required</td><td><strong>' + totalO2.toFixed(0) + '</strong></td><td>lb O2/day</td></tr>';
  html += '<tr><td>O2 Transfer Rate</td><td><strong>' + o2Rate.toFixed(0) + '</strong></td><td>lb O2/hr</td></tr>';
  html += '</tbody></table>';
  document.getElementById('sbr_aeration_results').innerHTML = html;
}
function resetSBRAeration() {
  ['sbr_bod_in','sbr_bod_out','sbr_aer_flow','sbr_tkn','sbr_nh3_out','sbr_react_hr'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.value = el.defaultValue;
  });
  document.getElementById('sbr_aeration_results').innerHTML = '';
}

// SBR Settling Calculator
function calcSBRSettling() {
  var mlss = parseFloat(document.getElementById('sbr_mlss').value) || 0;
  var svi = parseFloat(document.getElementById('sbr_svi').value) || 0;
  var depth = parseFloat(document.getElementById('sbr_depth').value) || 0;
  var settleTime = parseFloat(document.getElementById('sbr_settle_t').value) || 0;
  var decantPct = parseFloat(document.getElementById('sbr_decant_pct').value) || 0;

  var blanketVol = (mlss * svi) / 1000000;
  var blanketHeight = depth * blanketVol;
  var clearWater = depth - blanketHeight;
  var settleVel = (depth - blanketHeight) / (settleTime / 60);
  var decantDepth = depth * (decantPct / 100);
  var margin = clearWater - decantDepth;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>Sludge Blanket Height</td><td><strong>' + blanketHeight.toFixed(1) + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Clear Water Zone</td><td><strong>' + clearWater.toFixed(1) + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Settling Velocity</td><td><strong>' + settleVel.toFixed(2) + '</strong></td><td>ft/hr</td></tr>';
  html += '<tr><td>Decant Depth</td><td><strong>' + decantDepth.toFixed(1) + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Safety Margin</td><td><strong>' + margin.toFixed(1) + '</strong></td><td>ft</td></tr>';
  html += '</tbody></table>';
  document.getElementById('sbr_settling_results').innerHTML = html;
}
function resetSBRSettling() {
  ['sbr_mlss','sbr_svi','sbr_depth','sbr_settle_t','sbr_decant_pct'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.value = el.defaultValue;
  });
  document.getElementById('sbr_settling_results').innerHTML = '';
}

// SBR Loading Calculator
function calcSBRLoading() {
  var flow = parseFloat(document.getElementById('sbr_load_flow').value) || 0;
  var bod = parseFloat(document.getElementById('sbr_load_bod').value) || 0;
  var vol = parseFloat(document.getElementById('sbr_load_vol').value) || 0;
  var mlss = parseFloat(document.getElementById('sbr_load_mlss').value) || 0;
  var vssRatio = parseFloat(document.getElementById('sbr_vss_ratio').value) || 0.8;
  var basins = parseInt(document.getElementById('sbr_load_basins').value) || 1;

  var bodLoad = flow * bod * 8.34;
  var mlvss = mlss * vssRatio;
  var totalVol = vol * basins;
  var biomass = mlvss * totalVol * 8.34;
  var fm = bodLoad / biomass;
  var volLoad = bodLoad / (totalVol * 1000000) * 1000;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>BOD Loading</td><td><strong>' + bodLoad.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>MLVSS</td><td><strong>' + mlvss.toFixed(0) + '</strong></td><td>mg/L</td></tr>';
  html += '<tr><td>Biomass Inventory</td><td><strong>' + biomass.toFixed(0) + '</strong></td><td>lb</td></tr>';
  html += '<tr><td>F/M Ratio</td><td><strong>' + fm.toFixed(3) + '</strong></td><td>lb BOD/lb MLVSS/d</td></tr>';
  html += '<tr><td>Volumetric Loading</td><td><strong>' + volLoad.toFixed(1) + '</strong></td><td>lb BOD/1000 cf/d</td></tr>';
  html += '</tbody></table>';
  document.getElementById('sbr_loading_results').innerHTML = html;
}
function resetSBRLoading() {
  ['sbr_load_flow','sbr_load_bod','sbr_load_vol','sbr_load_mlss','sbr_vss_ratio','sbr_load_basins'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.value = el.defaultValue;
  });
  document.getElementById('sbr_loading_results').innerHTML = '';
}

// SBR WAS Calculator
function calcSBRWAS() {
  var srt = parseFloat(document.getElementById('sbr_srt').value) || 1;
  var mlss = parseFloat(document.getElementById('sbr_was_mlss').value) || 0;
  var vol = parseFloat(document.getElementById('sbr_was_vol').value) || 0;
  var effTss = parseFloat(document.getElementById('sbr_eff_tss').value) || 0;
  var effFlow = parseFloat(document.getElementById('sbr_eff_flow').value) || 0;

  var inventory = mlss * vol * 8.34;
  var effLoss = effTss * effFlow * 8.34;
  var wasRequired = (inventory / srt) - effLoss;
  var wasGPD = wasRequired / (mlss * 8.34 / 1000);

  var html = '<table class="table"><tbody>';
  html += '<tr><td>MLSS Inventory</td><td><strong>' + inventory.toFixed(0) + '</strong></td><td>lb</td></tr>';
  html += '<tr><td>Effluent Solids Loss</td><td><strong>' + effLoss.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>WAS Required</td><td><strong>' + wasRequired.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>WAS Flow</td><td><strong>' + wasGPD.toFixed(0) + '</strong></td><td>GPD</td></tr>';
  html += '</tbody></table>';
  document.getElementById('sbr_was_results').innerHTML = html;
}
function resetSBRWAS() {
  ['sbr_srt','sbr_was_mlss','sbr_was_vol','sbr_eff_tss','sbr_eff_flow'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.value = el.defaultValue;
  });
  document.getElementById('sbr_was_results').innerHTML = '';
}

// SBR Nutrient Removal Calculator
function calcSBRNutrient() {
  var tnIn = parseFloat(document.getElementById('sbr_tn_in').value) || 0;
  var tnOut = parseFloat(document.getElementById('sbr_tn_out').value) || 0;
  var tpIn = parseFloat(document.getElementById('sbr_tp_in').value) || 0;
  var tpOut = parseFloat(document.getElementById('sbr_tp_out').value) || 0;
  var anoxic = parseFloat(document.getElementById('sbr_anoxic').value) || 0;
  var anaerobic = parseFloat(document.getElementById('sbr_anaerobic').value) || 0;

  var tnRemoval = ((tnIn - tnOut) / tnIn) * 100;
  var tpRemoval = ((tpIn - tpOut) / tpIn) * 100;
  var denitrRate = (tnIn - tnOut) / (anoxic / 60);
  var pRelease = tpIn * 0.5;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>TN Removal</td><td><strong>' + tnRemoval.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>TP Removal</td><td><strong>' + tpRemoval.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>Denitrification Rate</td><td><strong>' + denitrRate.toFixed(2) + '</strong></td><td>mg/L/hr</td></tr>';
  html += '<tr><td>Est. P Release</td><td><strong>' + pRelease.toFixed(1) + '</strong></td><td>mg/L</td></tr>';
  html += '</tbody></table>';
  document.getElementById('sbr_nutrient_results').innerHTML = html;
}
function resetSBRNutrient() {
  ['sbr_tn_in','sbr_tn_out','sbr_tp_in','sbr_tp_out','sbr_anoxic','sbr_anaerobic'].forEach(function(id) {
    var el = document.getElementById(id);
    if(el) el.value = el.defaultValue;
  });
  document.getElementById('sbr_nutrient_results').innerHTML = '';
}

// MBR Flux Calculator
function calcMBRFlux() {
  var flow = parseFloat(document.getElementById('mbr_perm_flow').value) || 0;
  var area = parseFloat(document.getElementById('mbr_mem_area').value) || 1;
  var tmp = parseFloat(document.getElementById('mbr_tmp').value) || 1;
  var temp = parseFloat(document.getElementById('mbr_temp').value) || 20;

  var flux_gfd = (flow * 1440) / area;
  var flux_lmh = flux_gfd * 1.7;
  var perm = flux_lmh / (tmp * 0.0689);
  var tempCorr = 1.0 + 0.02 * (temp - 20);

  var html = '<table class="table"><tbody>';
  html += '<tr><td>Net Flux</td><td><strong>' + flux_gfd.toFixed(1) + '</strong></td><td>GFD</td></tr>';
  html += '<tr><td>Net Flux</td><td><strong>' + flux_lmh.toFixed(1) + '</strong></td><td>LMH</td></tr>';
  html += '<tr><td>Permeability</td><td><strong>' + perm.toFixed(1) + '</strong></td><td>LMH/bar</td></tr>';
  html += '<tr><td>Temp Correction Factor</td><td><strong>' + tempCorr.toFixed(2) + '</strong></td><td></td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbr_flux_results').innerHTML = html;
}
function resetMBRFlux() {
  document.getElementById('mbr_flux_results').innerHTML = '';
}

// MBR Aeration Calculator
function calcMBRAeration() {
  var bodLoad = parseFloat(document.getElementById('mbr_bod_load').value) || 0;
  var tknLoad = parseFloat(document.getElementById('mbr_tkn_load').value) || 0;
  var area = parseFloat(document.getElementById('mbr_scour_area').value) || 1;
  var scourRate = parseFloat(document.getElementById('mbr_scour_rate').value) || 0;

  var processO2 = bodLoad * 1.2 + tknLoad * 4.6;
  var scourAir = area * scourRate;
  var totalAir = (processO2 / 0.02) + scourAir;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>Process O2 Demand</td><td><strong>' + processO2.toFixed(0) + '</strong></td><td>lb O2/day</td></tr>';
  html += '<tr><td>Membrane Scour Air</td><td><strong>' + scourAir.toFixed(0) + '</strong></td><td>SCFM</td></tr>';
  html += '<tr><td>Est. Total Air</td><td><strong>' + totalAir.toFixed(0) + '</strong></td><td>SCFM</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbr_aeration_results').innerHTML = html;
}
function resetMBRAeration() {
  document.getElementById('mbr_aeration_results').innerHTML = '';
}

// MBR Energy Calculator
function calcMBREnergy() {
  var permHP = parseFloat(document.getElementById('mbr_perm_hp').value) || 0;
  var blowerHP = parseFloat(document.getElementById('mbr_blower_hp').value) || 0;
  var runHrs = parseFloat(document.getElementById('mbr_run_hrs').value) || 24;
  var flow = parseFloat(document.getElementById('mbr_energy_flow').value) || 1;
  var rate = parseFloat(document.getElementById('mbr_elec_rate').value) || 0.10;

  var totalHP = permHP + blowerHP;
  var kWh = totalHP * 0.746 * runHrs;
  var specific = kWh / (flow * 1000);
  var dailyCost = kWh * rate;
  var monthlyCost = dailyCost * 30;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>Total Connected HP</td><td><strong>' + totalHP.toFixed(0) + '</strong></td><td>HP</td></tr>';
  html += '<tr><td>Daily Energy</td><td><strong>' + kWh.toFixed(0) + '</strong></td><td>kWh/day</td></tr>';
  html += '<tr><td>Specific Energy</td><td><strong>' + specific.toFixed(2) + '</strong></td><td>kWh/kgal</td></tr>';
  html += '<tr><td>Daily Cost</td><td><strong>$' + dailyCost.toFixed(2) + '</strong></td><td></td></tr>';
  html += '<tr><td>Monthly Cost</td><td><strong>$' + monthlyCost.toFixed(0) + '</strong></td><td></td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbr_energy_results').innerHTML = html;
}
function resetMBREnergy() {
  document.getElementById('mbr_energy_results').innerHTML = '';
}

// MBBR Media Calculator
function calcMBBRMedia() {
  var vol = parseFloat(document.getElementById('mbbr_vol').value) || 0;
  var fill = parseFloat(document.getElementById('mbbr_fill').value) || 0;
  var ssa = parseFloat(document.getElementById('mbbr_ssa').value) || 0;

  var volCF = vol * 1000000 / 7.48;
  var mediaVol = volCF * (fill / 100);
  var mediaVolM3 = mediaVol * 0.0283;
  var totalSA = mediaVolM3 * ssa;
  var activeSA = totalSA * 0.67;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>Reactor Volume</td><td><strong>' + volCF.toFixed(0) + '</strong></td><td>cf</td></tr>';
  html += '<tr><td>Media Volume</td><td><strong>' + mediaVol.toFixed(0) + '</strong></td><td>cf</td></tr>';
  html += '<tr><td>Total Surface Area</td><td><strong>' + totalSA.toFixed(0) + '</strong></td><td>m¬≤</td></tr>';
  html += '<tr><td>Active Surface Area</td><td><strong>' + activeSA.toFixed(0) + '</strong></td><td>m¬≤</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_media_results').innerHTML = html;
}
function resetMBBRMedia() {
  document.getElementById('mbbr_media_results').innerHTML = '';
}

// MBBR BOD Calculator
function calcMBBRBOD() {
  var flow = parseFloat(document.getElementById('mbbr_bod_flow').value) || 0;
  var bodIn = parseFloat(document.getElementById('mbbr_bod_in').value) || 0;
  var bodOut = parseFloat(document.getElementById('mbbr_bod_out').value) || 0;
  var temp = parseFloat(document.getElementById('mbbr_bod_temp').value) || 20;
  var salr = parseFloat(document.getElementById('mbbr_salr').value) || 10;

  var bodLoad = flow * (bodIn - bodOut) * 3.785 * 1000;
  var saRequired = bodLoad / salr;
  var tempFactor = Math.pow(1.06, temp - 20);
  var correctedSALR = salr * tempFactor;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>BOD Load to Remove</td><td><strong>' + (bodLoad/1000).toFixed(1) + '</strong></td><td>kg/day</td></tr>';
  html += '<tr><td>Surface Area Required</td><td><strong>' + saRequired.toFixed(0) + '</strong></td><td>m¬≤</td></tr>';
  html += '<tr><td>Temp Correction Factor</td><td><strong>' + tempFactor.toFixed(2) + '</strong></td><td></td></tr>';
  html += '<tr><td>Corrected SALR</td><td><strong>' + correctedSALR.toFixed(1) + '</strong></td><td>g/m¬≤/d</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_bod_results').innerHTML = html;
}
function resetMBBRBOD() {
  document.getElementById('mbbr_bod_results').innerHTML = '';
}

// MBBR Aeration Calculator
function calcMBBRAeration() {
  var bodLoad = parseFloat(document.getElementById('mbbr_aer_bod').value) || 0;
  var nh3Load = parseFloat(document.getElementById('mbbr_aer_nh3').value) || 0;
  var mediaVol = parseFloat(document.getElementById('mbbr_media_vol').value) || 0;
  var mixRate = parseFloat(document.getElementById('mbbr_mix_rate').value) || 1;

  var carbonO2 = bodLoad * 1.2;
  var nitrogenO2 = nh3Load * 4.6;
  var totalO2 = carbonO2 + nitrogenO2;
  var processAir = totalO2 / 0.02;
  var mixingAir = mediaVol * mixRate;
  var totalAir = Math.max(processAir, mixingAir);

  var html = '<table class="table"><tbody>';
  html += '<tr><td>Carbonaceous O2</td><td><strong>' + carbonO2.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>Nitrogenous O2</td><td><strong>' + nitrogenO2.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>Process Air Required</td><td><strong>' + processAir.toFixed(0) + '</strong></td><td>SCFM</td></tr>';
  html += '<tr><td>Mixing Air Required</td><td><strong>' + mixingAir.toFixed(0) + '</strong></td><td>SCFM</td></tr>';
  html += '<tr><td>Design Air (greater of)</td><td><strong>' + totalAir.toFixed(0) + '</strong></td><td>SCFM</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_aeration_results').innerHTML = html;
}
function resetMBBRAeration() {
  document.getElementById('mbbr_aeration_results').innerHTML = '';
}

// MBR Cleaning Calculator
function calcMBRCleaning() {
  var permInit = parseFloat(document.getElementById('mbr_perm_init').value) || 1;
  var permCurr = parseFloat(document.getElementById('mbr_perm_curr').value) || 0;
  var daysCIP = parseFloat(document.getElementById('mbr_days_cip').value) || 1;
  var permPost = parseFloat(document.getElementById('mbr_perm_post').value) || 0;

  var foulingRate = (permInit - permCurr) / daysCIP;
  var totalFouling = ((permInit - permCurr) / permInit) * 100;
  var reversible = ((permPost - permCurr) / (permInit - permCurr)) * 100;
  var irreversible = 100 - reversible;
  var cipEfficiency = (permPost / permInit) * 100;
  var membraneHealth = permCurr > permInit * 0.5 ? 'Good' : permCurr > permInit * 0.3 ? 'Fair' : 'Poor';

  var html = '<table class="table"><tbody>';
  html += '<tr><td>Fouling Rate</td><td><strong>' + foulingRate.toFixed(2) + '</strong></td><td>LMH/bar/day</td></tr>';
  html += '<tr><td>Total Fouling</td><td><strong>' + totalFouling.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>Reversible Fouling</td><td><strong>' + reversible.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>Irreversible Fouling</td><td><strong>' + irreversible.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>CIP Efficiency</td><td><strong>' + cipEfficiency.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>Membrane Health</td><td><strong>' + membraneHealth + '</strong></td><td></td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbr_cleaning_results').innerHTML = html;
}
function resetMBRCleaning() {
  document.getElementById('mbr_cleaning_results').innerHTML = '';
}

// MBR Loading Calculator
function calcMBRLoading() {
  var flow = parseFloat(document.getElementById('mbr_srt_flow').value) || 0;
  var bod = parseFloat(document.getElementById('mbr_srt_bod').value) || 0;
  var mlss = parseFloat(document.getElementById('mbr_srt_mlss').value) || 0;
  var vol = parseFloat(document.getElementById('mbr_srt_vol').value) || 0;
  var wasFlow = parseFloat(document.getElementById('mbr_was_flow').value) || 0;
  var wasConc = parseFloat(document.getElementById('mbr_was_conc').value) || 0;

  var bodLoad = flow * bod * 8.34;
  var biomass = mlss * vol * 8.34;
  var fm = bodLoad / (biomass * 0.8);
  var hrt = (vol / flow) * 24;
  var wasLb = wasFlow * wasConc * 8.34 / 1000000;
  var srt = biomass / wasLb;
  var volLoad = bodLoad / (vol * 1000000) * 1000;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>BOD Loading</td><td><strong>' + bodLoad.toFixed(0) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>F/M Ratio</td><td><strong>' + fm.toFixed(3) + '</strong></td><td>lb BOD/lb MLVSS/d</td></tr>';
  html += '<tr><td>HRT</td><td><strong>' + hrt.toFixed(1) + '</strong></td><td>hours</td></tr>';
  html += '<tr><td>SRT</td><td><strong>' + srt.toFixed(0) + '</strong></td><td>days</td></tr>';
  html += '<tr><td>Volumetric Loading</td><td><strong>' + volLoad.toFixed(1) + '</strong></td><td>lb BOD/1000 cf/d</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbr_loading_results').innerHTML = html;
}
function resetMBRLoading() {
  document.getElementById('mbr_loading_results').innerHTML = '';
}

// MBR Troubleshooting
function calcMBRTroubleshoot() {
  var tmpTrend = document.getElementById('mbr_tmp_trend').value;
  var permTrend = document.getElementById('mbr_perm_trend').value;
  var foam = document.getElementById('mbr_foam').value;
  var permQuality = document.getElementById('mbr_perm_quality').value;

  var issues = [];
  var recommendations = [];

  if (tmpTrend === 'rapid' || tmpTrend === 'jump') {
    issues.push('Rapid TMP increase indicates acute fouling');
    recommendations.push('Perform maintenance clean (MC) immediately');
    recommendations.push('Check for membrane damage or air scour issues');
  } else if (tmpTrend === 'gradual') {
    issues.push('Gradual TMP increase is normal but monitor closely');
    recommendations.push('Schedule CIP within 1-2 weeks');
  }

  if (permTrend === 'rapid_decline') {
    issues.push('Rapid permeability decline - possible membrane damage');
    recommendations.push('Inspect membranes for fiber breakage');
    recommendations.push('Check pretreatment for debris');
  }

  if (foam === 'heavy') {
    issues.push('Heavy foam indicates possible Nocardia/filament issue');
    recommendations.push('Reduce SRT or add selector zone');
    recommendations.push('Consider antifoam addition');
  }

  if (permQuality === 'turbid') {
    issues.push('Turbid permeate indicates membrane integrity issue');
    recommendations.push('Perform integrity test immediately');
    recommendations.push('Isolate and repair damaged modules');
  }

  if (issues.length === 0) {
    issues.push('No significant issues detected');
    recommendations.push('Continue normal operation');
  }

  var html = '<div class="note warning"><strong>Issues Identified:</strong><ul>';
  issues.forEach(function(i) { html += '<li>' + i + '</li>'; });
  html += '</ul></div>';
  html += '<div class="note success"><strong>Recommendations:</strong><ul>';
  recommendations.forEach(function(r) { html += '<li>' + r + '</li>'; });
  html += '</ul></div>';

  document.getElementById('mbr_troubleshoot_results').innerHTML = html;
}

// MBBR Nitrification Calculator
function calcMBBRNitrification() {
  var flow = parseFloat(document.getElementById('mbbr_nit_flow').value) || 0;
  var nh3In = parseFloat(document.getElementById('mbbr_nh3_in').value) || 0;
  var nh3Out = parseFloat(document.getElementById('mbbr_nh3_out').value) || 0;
  var temp = parseFloat(document.getElementById('mbbr_nit_temp').value) || 15;
  var doConc = parseFloat(document.getElementById('mbbr_do').value) || 0;
  var sanr = parseFloat(document.getElementById('mbbr_sanr').value) || 1;

  var nh3Load = flow * (nh3In - nh3Out) * 3.785 * 1000;
  var tempFactor = Math.pow(1.098, temp - 20);
  var doFactor = doConc / (doConc + 1.3);
  var correctedSANR = sanr * tempFactor * doFactor;
  var saRequired = (nh3Load / 1000) / correctedSANR;
  var alkConsumed = (nh3In - nh3Out) * 7.14 * flow * 8.34;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>NH3-N Load to Remove</td><td><strong>' + (nh3Load/1000).toFixed(1) + '</strong></td><td>kg/day</td></tr>';
  html += '<tr><td>Temp Correction Factor</td><td><strong>' + tempFactor.toFixed(2) + '</strong></td><td></td></tr>';
  html += '<tr><td>DO Correction Factor</td><td><strong>' + doFactor.toFixed(2) + '</strong></td><td></td></tr>';
  html += '<tr><td>Corrected SANR</td><td><strong>' + correctedSANR.toFixed(2) + '</strong></td><td>g N/m¬≤/d</td></tr>';
  html += '<tr><td>Surface Area Required</td><td><strong>' + saRequired.toFixed(0) + '</strong></td><td>m¬≤</td></tr>';
  html += '<tr><td>Alkalinity Consumed</td><td><strong>' + alkConsumed.toFixed(0) + '</strong></td><td>lb/day as CaCO3</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_nit_results').innerHTML = html;
}
function resetMBBRNitrification() {
  document.getElementById('mbbr_nit_results').innerHTML = '';
}

// MBBR Hydraulic Calculator
function calcMBBRHydraulic() {
  var flow = parseFloat(document.getElementById('mbbr_hyd_flow').value) || 0;
  var vol = parseFloat(document.getElementById('mbbr_hyd_vol').value) || 0;
  var length = parseFloat(document.getElementById('mbbr_length').value) || 0;
  var width = parseFloat(document.getElementById('mbbr_width').value) || 0;
  var depth = parseFloat(document.getElementById('mbbr_wat_depth').value) || 0;
  var screenArea = parseFloat(document.getElementById('mbbr_screen').value) || 1;

  var hrt = (vol / flow) * 24 * 60;
  var calcVol = length * width * depth / 7.48 / 1000000;
  var lw = length / width;
  var dw = depth / width;
  var flowGPM = flow * 1000000 / 1440;
  var screenVel = flowGPM / screenArea / 7.48;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>HRT</td><td><strong>' + hrt.toFixed(0) + '</strong></td><td>minutes</td></tr>';
  html += '<tr><td>Calculated Volume</td><td><strong>' + calcVol.toFixed(3) + '</strong></td><td>MG</td></tr>';
  html += '<tr><td>L:W Ratio</td><td><strong>' + lw.toFixed(1) + '</strong></td><td>(target 2:1)</td></tr>';
  html += '<tr><td>D:W Ratio</td><td><strong>' + dw.toFixed(2) + '</strong></td><td>(target 0.5-1.0)</td></tr>';
  html += '<tr><td>Screen Velocity</td><td><strong>' + screenVel.toFixed(2) + '</strong></td><td>ft/s (max 1.0)</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_hydraulic_results').innerHTML = html;
}
function resetMBBRHydraulic() {
  document.getElementById('mbbr_hydraulic_results').innerHTML = '';
}

// MBBR Performance Calculator
function calcMBBRPerformance() {
  var bodIn = parseFloat(document.getElementById('mbbr_perf_bod_in').value) || 0;
  var bodOut = parseFloat(document.getElementById('mbbr_perf_bod_out').value) || 0;
  var nh3In = parseFloat(document.getElementById('mbbr_perf_nh3_in').value) || 0;
  var nh3Out = parseFloat(document.getElementById('mbbr_perf_nh3_out').value) || 0;
  var sa = parseFloat(document.getElementById('mbbr_perf_sa').value) || 1;
  var flow = parseFloat(document.getElementById('mbbr_perf_flow').value) || 0;

  var bodRemoval = ((bodIn - bodOut) / bodIn) * 100;
  var nh3Removal = ((nh3In - nh3Out) / nh3In) * 100;
  var bodLoad = flow * bodIn * 3.785;
  var nh3Load = flow * nh3In * 3.785;
  var actualSALR = bodLoad / sa;
  var actualSANR = nh3Load / sa;
  var bodRate = (bodIn - bodOut) * flow * 3.785 * 1000 / sa;
  var nh3Rate = (nh3In - nh3Out) * flow * 3.785 * 1000 / sa;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>BOD Removal</td><td><strong>' + bodRemoval.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>NH3 Removal</td><td><strong>' + nh3Removal.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '<tr><td>Actual SALR (BOD)</td><td><strong>' + actualSALR.toFixed(1) + '</strong></td><td>g/m¬≤/d</td></tr>';
  html += '<tr><td>Actual SANR (NH3)</td><td><strong>' + actualSANR.toFixed(2) + '</strong></td><td>g N/m¬≤/d</td></tr>';
  html += '<tr><td>BOD Removal Rate</td><td><strong>' + bodRate.toFixed(1) + '</strong></td><td>g/m¬≤/d</td></tr>';
  html += '<tr><td>NH3 Removal Rate</td><td><strong>' + nh3Rate.toFixed(2) + '</strong></td><td>g N/m¬≤/d</td></tr>';
  html += '</tbody></table>';
  document.getElementById('mbbr_perf_results').innerHTML = html;
}
function resetMBBRPerformance() {
  document.getElementById('mbbr_perf_results').innerHTML = '';
}

// IFAS Calculator
function calcIFAS() {
  var mlss = parseFloat(document.getElementById('ifas_mlss').value) || 0;
  var vol = parseFloat(document.getElementById('ifas_vol').value) || 0;
  var fill = parseFloat(document.getElementById('ifas_fill').value) || 0;
  var biofilm = parseFloat(document.getElementById('ifas_biofilm').value) || 0;
  var ssa = parseFloat(document.getElementById('ifas_ssa').value) || 0;
  var flow = parseFloat(document.getElementById('ifas_flow').value) || 0;

  var suspBiomass = mlss * vol * 8.34;
  var volCF = vol * 1000000 / 7.48;
  var mediaVol = volCF * fill / 100;
  var mediaVolM3 = mediaVol * 0.0283;
  var surfaceArea = mediaVolM3 * ssa;
  var attachedBiomass = surfaceArea * biofilm / 1000 * 2.205;
  var totalBiomass = suspBiomass + attachedBiomass;
  var effectiveMLSS = totalBiomass / (vol * 8.34);
  var attachedPct = (attachedBiomass / totalBiomass) * 100;

  var html = '<table class="table"><tbody>';
  html += '<tr><td>Suspended Biomass</td><td><strong>' + suspBiomass.toFixed(0) + '</strong></td><td>lb</td></tr>';
  html += '<tr><td>Media Surface Area</td><td><strong>' + surfaceArea.toFixed(0) + '</strong></td><td>m¬≤</td></tr>';
  html += '<tr><td>Attached Biomass</td><td><strong>' + attachedBiomass.toFixed(0) + '</strong></td><td>lb</td></tr>';
  html += '<tr><td>Total Biomass</td><td><strong>' + totalBiomass.toFixed(0) + '</strong></td><td>lb</td></tr>';
  html += '<tr><td>Effective MLSS</td><td><strong>' + effectiveMLSS.toFixed(0) + '</strong></td><td>mg/L equiv</td></tr>';
  html += '<tr><td>Attached Fraction</td><td><strong>' + attachedPct.toFixed(1) + '</strong></td><td>%</td></tr>';
  html += '</tbody></table>';
  document.getElementById('ifas_results').innerHTML = html;
}
function resetIFAS() {
  document.getElementById('ifas_results').innerHTML = '';
}

// ==================== SBR TROUBLESHOOTING ====================
function calcSBRTroubleshoot() {
  var effIssue = document.getElementById('sbr_eff_issue').value;
  var settleIssue = document.getElementById('sbr_settle_issue').value;
  var opIssue = document.getElementById('sbr_op_issue').value;
  var svi = parseFloat(document.getElementById('sbr_diag_svi').value) || 150;

  var html = '<div style="margin-top:15px">';
  var issueCount = 0;
  var recommendations = [];

  // Analyze SVI
  var sviStatus = 'good';
  var sviColor = '#06d6a0';
  if (svi > 200) { sviStatus = 'poor'; sviColor = '#ef4444'; }
  else if (svi > 150) { sviStatus = 'fair'; sviColor = '#ffd166'; }

  html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px">';
  html += '<h4 style="color:#60a5fa;margin:0 0 10px 0">üìä SVI Analysis: ' + svi + ' mL/g</h4>';
  html += '<div style="display:flex;align-items:center;gap:10px">';
  html += '<div style="width:100px;height:20px;background:#243b55;border-radius:10px;overflow:hidden">';
  html += '<div style="width:' + Math.min(svi/4, 100) + '%;height:100%;background:' + sviColor + '"></div></div>';
  html += '<span style="color:' + sviColor + ';font-weight:bold">' + sviStatus.toUpperCase() + '</span></div>';
  if (svi < 80) html += '<p style="color:#94a3b8;margin:10px 0 0 0">‚ö†Ô∏è Very low SVI may indicate old sludge or pin floc</p>';
  else if (svi > 200) html += '<p style="color:#94a3b8;margin:10px 0 0 0">‚ö†Ô∏è High SVI indicates settling problems - check for filaments</p>';
  html += '</div>';

  // Effluent Quality Issues
  if (effIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ef4444">';
    html += '<h4 style="color:#f87171;margin:0 0 10px 0">üö® Effluent Quality: ' + effIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';

    if (effIssue === 'high_tss') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient settle time</li><li>Decanter withdrawal too fast</li><li>Sludge blanket too high</li><li>Poor floc formation</li></ul>';
      recommendations.push('Extend settle phase by 10-15 minutes');
      recommendations.push('Reduce decant withdrawal rate');
      recommendations.push('Increase WAS to lower blanket level');
      recommendations.push('Check polymer addition if used');
    } else if (effIssue === 'high_bod') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient react time</li><li>Low MLSS concentration</li><li>Inadequate aeration</li><li>Shock load</li></ul>';
      recommendations.push('Extend aeration/react phase');
      recommendations.push('Reduce WAS to increase MLSS');
      recommendations.push('Verify DO > 2.0 mg/L during react');
      recommendations.push('Check influent loading for shock loads');
    } else if (effIssue === 'high_nh3') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient SRT for nitrifiers</li><li>Low DO during aeration</li><li>pH too low (&lt;6.8)</li><li>Temperature too cold</li></ul>';
      recommendations.push('Increase SRT to >10 days for nitrification');
      recommendations.push('Maintain DO > 2.5 mg/L during react');
      recommendations.push('Add alkalinity if pH < 7.0');
      recommendations.push('Extend aeration time in cold weather');
    } else if (effIssue === 'high_no3') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient anoxic time</li><li>Anoxic phase DO too high</li><li>Lack of carbon source</li></ul>';
      recommendations.push('Extend anoxic fill phase');
      recommendations.push('Ensure DO < 0.5 mg/L during anoxic');
      recommendations.push('Consider carbon supplementation');
    } else if (effIssue === 'high_phos') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient anaerobic time</li><li>Nitrate in anaerobic zone</li><li>Secondary P release</li></ul>';
      recommendations.push('Add/extend anaerobic phase (30-60 min)');
      recommendations.push('Ensure no nitrate entering anaerobic');
      recommendations.push('Consider chemical P removal backup');
    }
    html += '</div>';
  }

  // Settling Issues
  if (settleIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ffd166">';
    html += '<h4 style="color:#fbbf24;margin:0 0 10px 0">‚ö†Ô∏è Settling Problem: ' + settleIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';

    if (settleIssue === 'poor' || settleIssue === 'bulking') {
      html += '<p style="color:#e0f2fe"><strong>Filamentous Bulking Indicators:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Check microscopy for filament ID</li><li>Common: Nocardia, M. parvicella, Type 021N</li></ul>';
      recommendations.push('Identify filament type via microscopy');
      recommendations.push('Increase DO if Type 1701/S. natans');
      recommendations.push('Reduce F/M if Nocardia/Microthrix');
      recommendations.push('Consider selector or chlorination');
    } else if (settleIssue === 'rising') {
      html += '<p style="color:#e0f2fe"><strong>Rising Sludge Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Denitrification in settle phase</li><li>N2 gas bubbles lifting sludge</li></ul>';
      recommendations.push('Shorten settle time');
      recommendations.push('Add short mix at end of react to strip N2');
      recommendations.push('Increase WAS to reduce SRT');
    } else if (settleIssue === 'pin_floc') {
      html += '<p style="color:#e0f2fe"><strong>Pin Floc Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Over-aeration breaking floc</li><li>Very old sludge</li><li>Nutrient deficiency</li></ul>';
      recommendations.push('Reduce aeration intensity');
      recommendations.push('Increase WAS to reduce SRT');
      recommendations.push('Check N:P ratio (100:5:1 BOD:N:P)');
    } else if (settleIssue === 'foam') {
      html += '<p style="color:#e0f2fe"><strong>Foam Types:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Brown/tan: Nocardia or Microthrix</li><li>White: Detergents or young sludge</li><li>Dark: Old sludge</li></ul>';
      recommendations.push('ID foam type and organism');
      recommendations.push('Spray water or defoamer');
      recommendations.push('Adjust SRT (reduce for Nocardia)');
    }
    html += '</div>';
  }

  // Operational Issues
  if (opIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #0077b6">';
    html += '<h4 style="color:#60a5fa;margin:0 0 10px 0">üîß Operational Issue: ' + opIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';

    if (opIssue === 'short_cycle') {
      recommendations.push('Review cycle timing - typical: Fill 2hr, React 3-4hr, Settle 1hr, Decant 0.5hr');
      recommendations.push('Consider adding basins or reducing flow');
    } else if (opIssue === 'carryover') {
      recommendations.push('Lower decanter start level');
      recommendations.push('Slow decant rate');
      recommendations.push('Increase settle time');
      recommendations.push('Lower sludge blanket with more WAS');
    } else if (opIssue === 'low_do') {
      recommendations.push('Increase blower output');
      recommendations.push('Check diffuser fouling');
      recommendations.push('Verify adequate react time');
    } else if (opIssue === 'high_do') {
      recommendations.push('Implement DO control strategy');
      recommendations.push('Reduce aeration during low load periods');
      recommendations.push('Consider VFD on blowers');
    } else if (opIssue === 'odor') {
      recommendations.push('Check for septicity in fill phase');
      recommendations.push('Ensure adequate aeration');
      recommendations.push('Review sludge handling');
    }
    html += '</div>';
  }

  // Recommendations Summary
  if (recommendations.length > 0) {
    html += '<div style="background:linear-gradient(135deg,#065f46,#047857);padding:15px;border-radius:8px">';
    html += '<h4 style="color:#a7f3d0;margin:0 0 10px 0">‚úÖ Recommended Actions (' + recommendations.length + ')</h4>';
    html += '<ol style="color:#d1fae5;margin:0;padding-left:20px">';
    recommendations.forEach(function(rec) {
      html += '<li style="margin-bottom:8px">' + rec + '</li>';
    });
    html += '</ol></div>';
  } else if (issueCount === 0) {
    html += '<div style="background:#065f46;padding:20px;border-radius:8px;text-align:center">';
    html += '<span style="font-size:48px">‚úÖ</span>';
    html += '<h4 style="color:#a7f3d0;margin:10px 0 0 0">SBR Operating Normally</h4>';
    html += '<p style="color:#d1fae5;margin:5px 0 0 0">No issues detected. Continue monitoring.</p>';
    html += '</div>';
  }

  html += '</div>';
  document.getElementById('sbr_troubleshoot_results').innerHTML = html;
  showToast('SBR Diagnosis Complete', 'success');
}

function resetSBRTroubleshoot() {
  document.getElementById('sbr_eff_issue').value = 'none';
  document.getElementById('sbr_settle_issue').value = 'none';
  document.getElementById('sbr_op_issue').value = 'none';
  document.getElementById('sbr_diag_svi').value = '150';
  document.getElementById('sbr_troubleshoot_results').innerHTML = '';
}

// ==================== MBBR TROUBLESHOOTING ====================
function calcMBBRTroubleshoot() {
  var mediaIssue = document.getElementById('mbbr_media_issue').value;
  var perfIssue = document.getElementById('mbbr_perf_issue').value;
  var biofilmIssue = document.getElementById('mbbr_biofilm_issue').value;
  var airIssue = document.getElementById('mbbr_air_issue').value;

  var html = '<div style="margin-top:15px">';
  var issueCount = 0;
  var recommendations = [];

  // Media Issues
  if (mediaIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ef4444">';
    html += '<h4 style="color:#f87171;margin:0 0 10px 0">üî¥ Media Issue: ' + mediaIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';

    if (mediaIssue === 'clogging') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Excessive biofilm growth</li><li>Inadequate scouring aeration</li><li>High TSS loading</li><li>Grease/oil accumulation</li></ul>';
      recommendations.push('Increase aeration intensity temporarily');
      recommendations.push('Check and clean screens');
      recommendations.push('Review pretreatment effectiveness');
      recommendations.push('Consider media cleaning cycle');
    } else if (mediaIssue === 'loss') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Screen openings too large</li><li>Screen damage or gaps</li><li>Media degradation</li></ul>';
      recommendations.push('Inspect screens for damage or gaps');
      recommendations.push('Verify screen opening size vs media');
      recommendations.push('Check media condition - replace if degraded');
    } else if (mediaIssue === 'poor_mixing') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient aeration</li><li>Uneven diffuser layout</li><li>Fill % too high</li></ul>';
      recommendations.push('Increase airflow rate');
      recommendations.push('Check diffuser distribution');
      recommendations.push('Reduce media fill to <67%');
    } else if (mediaIssue === 'accumulation') {
      recommendations.push('Add baffles or modify tank geometry');
      recommendations.push('Increase mixing energy');
      recommendations.push('Consider mechanical mixing');
    } else if (mediaIssue === 'breakage') {
      recommendations.push('Evaluate media quality and age');
      recommendations.push('Check for excessive mechanical stress');
      recommendations.push('Plan media replacement');
    }
    html += '</div>';
  }

  // Performance Issues
  if (perfIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #ffd166">';
    html += '<h4 style="color:#fbbf24;margin:0 0 10px 0">‚ö†Ô∏è Performance Issue: ' + perfIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';

    if (perfIssue === 'low_bod') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient surface area</li><li>Low temperature</li><li>Inadequate HRT</li><li>Nutrient deficiency</li></ul>';
      recommendations.push('Verify SALR < 20 g BOD/m¬≤/d');
      recommendations.push('Check temperature - apply correction factors');
      recommendations.push('Ensure HRT > 1 hour');
      recommendations.push('Verify N:P ratio adequate');
    } else if (perfIssue === 'low_nh3') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Nitrifiers outcompeted by heterotrophs</li><li>Low DO</li><li>Cold temperature</li><li>Alkalinity limited</li></ul>';
      recommendations.push('Ensure BOD:TKN ratio allows nitrifier growth');
      recommendations.push('Maintain DO > 3 mg/L');
      recommendations.push('Target SANR < 1.5 g N/m¬≤/d at 20¬∞C');
      recommendations.push('Check alkalinity > 50 mg/L as CaCO3');
    } else if (perfIssue === 'variable') {
      recommendations.push('Check for hydraulic short-circuiting');
      recommendations.push('Review loading patterns for shock loads');
      recommendations.push('Verify consistent aeration');
    } else if (perfIssue === 'declining') {
      recommendations.push('Check media for fouling or clogging');
      recommendations.push('Evaluate biofilm health');
      recommendations.push('Review maintenance frequency');
    }
    html += '</div>';
  }

  // Biofilm Issues
  if (biofilmIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #00b4d8">';
    html += '<h4 style="color:#a78bfa;margin:0 0 10px 0">üß´ Biofilm Issue: ' + biofilmIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';

    if (biofilmIssue === 'thin') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Excessive scour/shear</li><li>Low organic loading</li><li>Toxic compounds</li><li>Insufficient startup time</li></ul>';
      recommendations.push('Reduce aeration intensity');
      recommendations.push('Verify adequate BOD loading');
      recommendations.push('Check for toxic industrial discharge');
      recommendations.push('Allow 4-8 weeks for biofilm development');
    } else if (biofilmIssue === 'thick') {
      html += '<p style="color:#e0f2fe"><strong>Possible Causes:</strong></p><ul style="color:#94a3b8;margin:5px 0">';
      html += '<li>Insufficient shear/scour</li><li>High organic loading</li><li>Diffusion limitations</li></ul>';
      recommendations.push('Increase aeration for more scour');
      recommendations.push('Consider periodic high-intensity mixing');
      recommendations.push('Evaluate loading rate reduction');
    } else if (biofilmIssue === 'sloughing') {
      recommendations.push('Investigate toxic events');
      recommendations.push('Check for pH or temperature swings');
      recommendations.push('Review aeration consistency');
    } else if (biofilmIssue === 'dark') {
      recommendations.push('Increase DO - biofilm may be anaerobic');
      recommendations.push('Check for sulfide generation');
      recommendations.push('Review organic loading');
    }
    html += '</div>';
  }

  // Aeration Issues
  if (airIssue !== 'none') {
    issueCount++;
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:15px;border-left:4px solid #0077b6">';
    html += '<h4 style="color:#60a5fa;margin:0 0 10px 0">üí® Aeration Issue: ' + airIssue.replace(/_/g, ' ').toUpperCase() + '</h4>';

    if (airIssue === 'uneven') {
      recommendations.push('Inspect diffuser grid for damage');
      recommendations.push('Check for clogged diffusers');
      recommendations.push('Verify header pipe sizing');
      recommendations.push('Consider diffuser cleaning/replacement');
    } else if (airIssue === 'low_do') {
      recommendations.push('Increase blower output');
      recommendations.push('Check for diffuser fouling');
      recommendations.push('Verify alpha factor for actual OTE');
      recommendations.push('Evaluate organic loading');
    } else if (airIssue === 'fouled_diff') {
      recommendations.push('Schedule diffuser cleaning');
      recommendations.push('Consider acid cleaning protocol');
      recommendations.push('Evaluate diffuser replacement cycle');
    } else if (airIssue === 'channeling') {
      recommendations.push('Review diffuser layout');
      recommendations.push('Add baffles to improve distribution');
      recommendations.push('Consider different diffuser type');
    }
    html += '</div>';
  }

  // Recommendations Summary
  if (recommendations.length > 0) {
    html += '<div style="background:linear-gradient(135deg,#065f46,#047857);padding:15px;border-radius:8px">';
    html += '<h4 style="color:#a7f3d0;margin:0 0 10px 0">‚úÖ Recommended Actions (' + recommendations.length + ')</h4>';
    html += '<ol style="color:#d1fae5;margin:0;padding-left:20px">';
    recommendations.forEach(function(rec) {
      html += '<li style="margin-bottom:8px">' + rec + '</li>';
    });
    html += '</ol></div>';
  } else if (issueCount === 0) {
    html += '<div style="background:#065f46;padding:20px;border-radius:8px;text-align:center">';
    html += '<span style="font-size:48px">‚úÖ</span>';
    html += '<h4 style="color:#a7f3d0;margin:10px 0 0 0">MBBR Operating Normally</h4>';
    html += '<p style="color:#d1fae5;margin:5px 0 0 0">No issues detected. Continue monitoring.</p>';
    html += '</div>';
  }

  // Quick Reference
  html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-top:15px">';
  html += '<h4 style="color:#60a5fa;margin:0 0 10px 0">üìö MBBR Quick Reference</h4>';
  html += '<table style="width:100%;color:#e0f2fe;font-size:14px">';
  html += '<tr><td>Typical SALR (BOD)</td><td><strong>5-20 g/m¬≤/d</strong></td></tr>';
  html += '<tr><td>Typical SANR (NH3)</td><td><strong>0.5-1.5 g N/m¬≤/d</strong></td></tr>';
  html += '<tr><td>Media Fill</td><td><strong>50-67%</strong></td></tr>';
  html += '<tr><td>Min HRT</td><td><strong>1-2 hours</strong></td></tr>';
  html += '<tr><td>DO Target</td><td><strong>3-5 mg/L</strong></td></tr>';
  html += '</table></div>';

  html += '</div>';
  document.getElementById('mbbr_troubleshoot_results').innerHTML = html;
  showToast('MBBR Diagnosis Complete', 'success');
}

function resetMBBRTroubleshoot() {
  document.getElementById('mbbr_media_issue').value = 'none';
  document.getElementById('mbbr_perf_issue').value = 'none';
  document.getElementById('mbbr_biofilm_issue').value = 'none';
  document.getElementById('mbbr_air_issue').value = 'none';
  document.getElementById('mbbr_troubleshoot_results').innerHTML = '';
}

// ==================== HYDRAULIC PROFILE CALCULATOR ====================
function calcHydraulicProfile() {
  var flow = parseFloat(document.getElementById('hydr_flow').value) || 5;
  var peakFactor = parseFloat(document.getElementById('hydr_peak').value) || 2.5;
  var outfallWSE = parseFloat(document.getElementById('hydr_outfall').value) || 100;
  var peakFlow = flow * peakFactor;

  // Get all head losses
  var losses = {
    'Outfall': 0,
    'Effluent Piping': parseFloat(document.getElementById('hl_eff_pipe').value) || 0,
    'Cascade Aerator': parseFloat(document.getElementById('hl_cascade').value) || 0,
    'UV/Disinfection': parseFloat(document.getElementById('hl_disinfect').value) || 0,
    'Filters': parseFloat(document.getElementById('hl_filters').value) || 0,
    'Secondary Eff Weir': parseFloat(document.getElementById('hl_sec_weir').value) || 0,
    'Secondary Clarifier': parseFloat(document.getElementById('hl_secondary').value) || 0,
    'Secondary Inlet': parseFloat(document.getElementById('hl_sec_in').value) || 0,
    'Aeration Basin': parseFloat(document.getElementById('hl_aeration').value) || 0,
    'Aeration Inlet': parseFloat(document.getElementById('hl_aer_in').value) || 0,
    'Primary Eff Weir': parseFloat(document.getElementById('hl_prim_weir').value) || 0,
    'Primary Clarifier': parseFloat(document.getElementById('hl_prim').value) || 0,
    'Primary Inlet': parseFloat(document.getElementById('hl_prim_in').value) || 0,
    'Flow Measurement': parseFloat(document.getElementById('hl_parshall').value) || 0,
    'Grit Chamber': parseFloat(document.getElementById('hl_grit').value) || 0,
    'Bar Screen': parseFloat(document.getElementById('hl_barscreen').value) || 0
  };

  // Calculate cumulative WSE from outfall upstream
  var profile = [];
  var currentWSE = outfallWSE;
  var totalLoss = 0;

  for (var unit in losses) {
    profile.push({
      unit: unit,
      headloss: losses[unit],
      wse: currentWSE,
      cumulative: totalLoss
    });
    currentWSE += losses[unit];
    totalLoss += losses[unit];
  }

  // Reverse to show from headworks to outfall
  profile.reverse();

  // Build results table
  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 15px 0">üìê Hydraulic Profile Results</h4>';
  html += '<div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Design Flow</div>';
  html += '<div style="color:#4ade80;font-size:18px;font-weight:bold">' + flow.toFixed(1) + ' MGD</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Peak Flow</div>';
  html += '<div style="color:#ffd166;font-size:18px;font-weight:bold">' + peakFlow.toFixed(1) + ' MGD</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Total Head Loss</div>';
  html += '<div style="color:#60a5fa;font-size:18px;font-weight:bold">' + totalLoss.toFixed(2) + ' ft</div></div>';
  html += '</div>';

  html += '<table class="table"><thead><tr style="background:#374151">';
  html += '<th>Unit Process</th><th>Head Loss (ft)</th><th>WSE (ft)</th><th>Cumulative Loss (ft)</th>';
  html += '</tr></thead><tbody>';

  var cumLoss = 0;
  profile.forEach(function(p) {
    var rowColor = p.headloss > 0.4 ? '#fef3c7' : '';
    html += '<tr style="background:' + rowColor + '">';
    html += '<td><strong>' + p.unit + '</strong></td>';
    html += '<td>' + p.headloss.toFixed(2) + '</td>';
    html += '<td style="color:#4ade80;font-weight:bold">' + (outfallWSE + totalLoss - cumLoss).toFixed(2) + '</td>';
    html += '<td>' + cumLoss.toFixed(2) + '</td>';
    html += '</tr>';
    cumLoss += p.headloss;
  });

  html += '</tbody></table>';

  // Add headworks elevation
  var headworksWSE = outfallWSE + totalLoss;
  html += '<div style="margin-top:15px;padding:15px;background:linear-gradient(135deg,#059669,#06d6a0);border-radius:8px;text-align:center">';
  html += '<div style="font-size:14px;opacity:0.9">Required Headworks Water Surface Elevation</div>';
  html += '<div style="font-size:32px;font-weight:bold">' + headworksWSE.toFixed(2) + ' ft</div>';
  html += '</div></div>';

  document.getElementById('hydraulic_results').innerHTML = html;

  // Show and update chart
  document.getElementById('hydraulic_chart_container').style.display = 'block';
  updateHydraulicChart(profile, outfallWSE, totalLoss);

  showToast('Hydraulic Profile Calculated', 'success');
}

function updateHydraulicChart(profile, outfallWSE, totalLoss) {
  var ctx = document.getElementById('hydraulicChart');
  if (!ctx) return;

  if (window.hydraulicChartInstance) {
    window.hydraulicChartInstance.destroy();
  }

  var labels = profile.map(function(p) { return p.unit; });
  var cumLoss = 0;
  var wseData = profile.map(function(p) {
    var wse = outfallWSE + totalLoss - cumLoss;
    cumLoss += p.headloss;
    return wse;
  });

  window.hydraulicChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Water Surface Elevation (ft)',
        data: wseData,
        borderColor: '#4ade80',
        backgroundColor: 'rgba(74, 222, 128, 0.1)',
        fill: true,
        tension: 0.1,
        pointRadius: 6,
        pointBackgroundColor: '#4ade80'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45,
            font: { size: 10 }
          }
        },
        y: {
          title: { display: true, text: 'WSE (ft)' },
          beginAtZero: false
        }
      }
    }
  });
}

function exportHydraulicProfile() {
  var flow = document.getElementById('hydr_flow').value;
  var outfall = document.getElementById('hydr_outfall').value;

  var csv = 'WWTP Hydraulic Profile\nDesign Flow (MGD),' + flow + '\nOutfall WSE (ft),' + outfall + '\n\n';
  csv += 'Unit Process,Head Loss (ft)\n';

  var inputs = ['hl_barscreen','hl_grit','hl_parshall','hl_prim_in','hl_prim','hl_prim_weir','hl_aer_in','hl_aeration','hl_sec_in','hl_secondary','hl_sec_weir','hl_filters','hl_disinfect','hl_eff_pipe','hl_cascade'];
  var names = ['Bar Screen','Grit Chamber','Flow Measurement','Primary Inlet','Primary Clarifier','Primary Weir','Aeration Inlet','Aeration Basin','Secondary Inlet','Secondary Clarifier','Secondary Weir','Filters','UV/Disinfection','Effluent Piping','Cascade Aerator'];

  for (var i = 0; i < inputs.length; i++) {
    var val = document.getElementById(inputs[i]).value;
    csv += names[i] + ',' + val + '\n';
  }

  var blob = new Blob([csv], {type: 'text/csv'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'hydraulic_profile.csv';
  a.click();
  showToast('Hydraulic Profile exported to CSV', 'success');
}

function resetHydraulicProfile() {
  var defaults = {
    'hydr_flow': '5.0', 'hydr_peak': '2.5', 'hydr_outfall': '100.00',
    'hl_barscreen': '0.50', 'hl_grit': '0.25', 'hl_parshall': '0.30',
    'hl_prim_in': '0.20', 'hl_prim': '0.50', 'hl_prim_weir': '0.15',
    'hl_aer_in': '0.25', 'hl_aeration': '0.50', 'hl_sec_in': '0.30',
    'hl_secondary': '0.50', 'hl_sec_weir': '0.20', 'hl_filters': '0.00',
    'hl_disinfect': '0.25', 'hl_eff_pipe': '0.50', 'hl_cascade': '0.00'
  };
  for (var id in defaults) {
    document.getElementById(id).value = defaults[id];
  }
  document.getElementById('hydraulic_results').innerHTML = '';
  document.getElementById('hydraulic_chart_container').style.display = 'none';
}

// Pipe Headloss (Hazen-Williams)
function calcPipeHeadloss() {
  var Q = parseFloat(document.getElementById('pipe_flow').value) || 0; // GPM
  var D = parseFloat(document.getElementById('pipe_dia').value) || 8; // inches
  var L = parseFloat(document.getElementById('pipe_length').value) || 100; // ft
  var C = parseFloat(document.getElementById('pipe_c').value) || 130;
  var K = parseFloat(document.getElementById('pipe_k').value) || 0;

  // Convert to CFS
  var Qcfs = Q / 448.831;
  var Dft = D / 12;
  var A = Math.PI * Math.pow(Dft, 2) / 4;
  var V = Qcfs / A;

  // Hazen-Williams: hf = 10.67 * L * Q^1.852 / (C^1.852 * D^4.87)
  // Q in CFS, D in ft, L in ft
  var hf = 10.67 * L * Math.pow(Qcfs, 1.852) / (Math.pow(C, 1.852) * Math.pow(Dft, 4.87));

  // Minor losses: hm = K * V^2 / (2g)
  var hm = K * Math.pow(V, 2) / (2 * 32.2);
  var hTotal = hf + hm;
  var hPer100 = (hf / L) * 100;

  document.getElementById('r_pipe_vel').textContent = V.toFixed(2);
  document.getElementById('r_pipe_friction').textContent = hf.toFixed(3);
  document.getElementById('r_pipe_fittings').textContent = hm.toFixed(3);
  document.getElementById('r_pipe_total').textContent = hTotal.toFixed(3);
  document.getElementById('r_pipe_per100').textContent = hPer100.toFixed(3);

  // Velocity check
  var velStatus = V < 2 ? '‚ö†Ô∏è Low velocity' : V > 10 ? '‚ö†Ô∏è High velocity' : '‚úì OK';
  showToast('Pipe headloss calculated. Velocity: ' + velStatus, V >= 2 && V <= 10 ? 'success' : 'warning');
}

function resetPipeHeadloss() {
  document.getElementById('pipe_flow').value = '1000';
  document.getElementById('pipe_dia').value = '8';
  document.getElementById('pipe_length').value = '500';
  document.getElementById('pipe_c').value = '130';
  document.getElementById('pipe_k').value = '2.5';
  ['r_pipe_vel','r_pipe_friction','r_pipe_fittings','r_pipe_total','r_pipe_per100'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}

// Weir Head Calculation
function calcWeir() {
  var Q = parseFloat(document.getElementById('weir_flow').value) || 0; // MGD
  var L = parseFloat(document.getElementById('weir_length').value) || 1; // ft
  var C = parseFloat(document.getElementById('weir_coef').value) || 3.33;

  // Convert MGD to CFS
  var Qcfs = Q * 1.547;

  // Q = C * L * H^1.5 => H = (Q / (C * L))^(2/3)
  var H = Math.pow(Qcfs / (C * L), 2/3);

  document.getElementById('r_weir_head').textContent = H.toFixed(3);
}

// Orifice Head Calculation
function calcOrifice() {
  var Q = parseFloat(document.getElementById('orif_flow').value) || 0; // GPM
  var D = parseFloat(document.getElementById('orif_dia').value) || 6; // inches
  var Cd = parseFloat(document.getElementById('orif_cd').value) || 0.62;

  // Convert to CFS
  var Qcfs = Q / 448.831;
  var A = Math.PI * Math.pow(D/12, 2) / 4; // sq ft

  // Q = Cd * A * sqrt(2 * g * H) => H = (Q / (Cd * A))^2 / (2 * g)
  var H = Math.pow(Qcfs / (Cd * A), 2) / (2 * 32.2);

  document.getElementById('r_orif_head').textContent = H.toFixed(3);
}

// Open Channel Flow (Manning's)
function calcChannelFlow() {
  var Q = parseFloat(document.getElementById('chan_flow').value) || 0; // MGD
  var b = parseFloat(document.getElementById('chan_width').value) || 4; // ft
  var S = parseFloat(document.getElementById('chan_slope').value) || 0.001;
  var n = parseFloat(document.getElementById('chan_n').value) || 0.015;
  var z = parseFloat(document.getElementById('chan_ss').value) || 0; // side slope

  // Convert MGD to CFS
  var Qcfs = Q * 1.547;

  // Iteratively solve for normal depth using Manning's equation
  // Q = (1.49/n) * A * R^(2/3) * S^(1/2)
  // For trapezoidal: A = (b + z*y) * y, P = b + 2*y*sqrt(1+z^2), R = A/P

  var y = 1.0; // initial guess
  for (var i = 0; i < 50; i++) {
    var A = (b + z * y) * y;
    var P = b + 2 * y * Math.sqrt(1 + z * z);
    var R = A / P;
    var Qcalc = (1.49 / n) * A * Math.pow(R, 2/3) * Math.sqrt(S);

    var error = Qcfs - Qcalc;
    if (Math.abs(error) < 0.001) break;

    // Newton-Raphson adjustment
    var dA_dy = b + 2 * z * y;
    var dP_dy = 2 * Math.sqrt(1 + z * z);
    var dR_dy = (dA_dy * P - A * dP_dy) / (P * P);
    var dQ_dy = (1.49 / n) * Math.sqrt(S) * (dA_dy * Math.pow(R, 2/3) + A * (2/3) * Math.pow(R, -1/3) * dR_dy);

    y = y + error / dQ_dy;
    if (y < 0.01) y = 0.01;
  }

  var A = (b + z * y) * y;
  var P = b + 2 * y * Math.sqrt(1 + z * z);
  var R = A / P;
  var V = Qcfs / A;
  var Fr = V / Math.sqrt(32.2 * (A / (b + 2 * z * y))); // Froude number

  document.getElementById('r_chan_depth').textContent = y.toFixed(3);
  document.getElementById('r_chan_area').textContent = A.toFixed(2);
  document.getElementById('r_chan_wp').textContent = P.toFixed(2);
  document.getElementById('r_chan_rh').textContent = R.toFixed(3);
  document.getElementById('r_chan_vel').textContent = V.toFixed(2);
  document.getElementById('r_chan_froude').textContent = Fr.toFixed(3) + (Fr < 1 ? ' (Subcritical)' : ' (Supercritical)');

  showToast('Channel flow calculated', 'success');
}

function resetChannelFlow() {
  document.getElementById('chan_flow').value = '5.0';
  document.getElementById('chan_width').value = '4';
  document.getElementById('chan_slope').value = '0.001';
  document.getElementById('chan_n').value = '0.015';
  document.getElementById('chan_ss').value = '0';
  ['r_chan_depth','r_chan_area','r_chan_wp','r_chan_rh','r_chan_vel','r_chan_froude'].forEach(function(id) {
    document.getElementById(id).textContent = '-';
  });
}
// Business section switcher
function showBusinessSection(section) {
  document.getElementById('biz-clients').style.display = section === 'clients' ? 'block' : 'none';
  document.getElementById('biz-proposals').style.display = section === 'proposals' ? 'block' : 'none';
  document.getElementById('biz-roi').style.display = section === 'roi' ? 'block' : 'none';
  document.getElementById('biz-timetracking').style.display = section === 'timetracking' ? 'block' : 'none';
  document.getElementById('biz-ai-enhance').style.display = section === 'ai-enhance' ? 'block' : 'none';
  var costCalc = document.getElementById('biz-costcalc');
  if (costCalc) costCalc.style.display = section === 'costcalc' ? 'block' : 'none';
  var sheetsSync = document.getElementById('biz-sheets');
  if (sheetsSync) sheetsSync.style.display = section === 'sheets' ? 'block' : 'none';
  var serviceProp = document.getElementById('biz-serviceprop');
  if (serviceProp) serviceProp.style.display = section === 'serviceprop' ? 'block' : 'none';

  // Initialize cost calculator when opened
  if (section === 'costcalc') {
    calculateAllCosts();
  }
}

// ==================== COST CALCULATOR FUNCTIONS v9.5.0 ====================

function calculateAllCosts() {
  var flowMGD = parseFloat(document.getElementById('cost_flow_mgd').value) || 0;
  var opDays = parseFloat(document.getElementById('cost_op_days').value) || 365;
  var kwhRate = parseFloat(document.getElementById('cost_kwh_rate').value) || 0;

  // Calculate chemical costs
  var chemDailyTotal = 0;
  var chemRows = document.querySelectorAll('#chemCostTable tbody tr');
  chemRows.forEach(function(row) {
    var dose = parseFloat(row.querySelector('.chem-dose').value) || 0;
    var price = parseFloat(row.querySelector('.chem-price').value) || 0;

    // lb/day = mg/L * MGD * 8.34
    var dailyUse = dose * flowMGD * 8.34;
    var dailyCost = dailyUse * price;
    var monthlyCost = dailyCost * 30;

    row.querySelector('.chem-daily-use').textContent = dailyUse.toFixed(1);
    row.querySelector('.chem-daily-cost').textContent = '$' + dailyCost.toFixed(2);
    row.querySelector('.chem-monthly-cost').textContent = '$' + monthlyCost.toFixed(2);

    chemDailyTotal += dailyCost;
  });

  document.getElementById('chem_daily_total').textContent = '$' + chemDailyTotal.toFixed(2);
  document.getElementById('chem_monthly_total').textContent = '$' + (chemDailyTotal * 30).toFixed(2);

  // Calculate energy costs
  var energyDailyKwh = 0;
  var energyDailyCost = 0;
  var equipRows = document.querySelectorAll('#energyCostTable tbody tr');
  equipRows.forEach(function(row) {
    var hp = parseFloat(row.querySelector('.equip-hp').value) || 0;
    var qty = parseFloat(row.querySelector('.equip-qty').value) || 0;
    var hrs = parseFloat(row.querySelector('.equip-hrs').value) || 0;

    // kW = HP * 0.746, daily kWh = kW * hours * qty
    var kw = hp * 0.746;
    var dailyKwh = kw * hrs * qty;
    var dailyCost = dailyKwh * kwhRate;
    var monthlyCost = dailyCost * 30;

    row.querySelector('.equip-daily-kwh').textContent = dailyKwh.toFixed(0);
    row.querySelector('.equip-daily-cost').textContent = '$' + dailyCost.toFixed(2);
    row.querySelector('.equip-monthly-cost').textContent = '$' + monthlyCost.toFixed(2);

    energyDailyKwh += dailyKwh;
    energyDailyCost += dailyCost;
  });

  document.getElementById('energy_daily_kwh').textContent = energyDailyKwh.toFixed(0);
  document.getElementById('energy_daily_total').textContent = '$' + energyDailyCost.toFixed(2);
  document.getElementById('energy_monthly_total').textContent = '$' + (energyDailyCost * 30).toFixed(2);

  // Calculate solids disposal costs
  var dryTons = parseFloat(document.getElementById('cost_sludge_tons').value) || 0;
  var disposalRate = parseFloat(document.getElementById('cost_disposal_rate').value) || 0;
  var cakeSolids = parseFloat(document.getElementById('cost_cake_solids').value) || 0;
  var haulingCost = parseFloat(document.getElementById('cost_hauling').value) || 0;
  var tonsPerLoad = parseFloat(document.getElementById('cost_tons_per_load').value) || 1;

  var wetTons = (cakeSolids > 0) ? (dryTons / (cakeSolids / 100)) : 0;
  var loadsPerMonth = (tonsPerLoad > 0) ? (wetTons * 30 / tonsPerLoad) : 0;
  var disposalCostMonth = wetTons * 30 * disposalRate;
  var haulingCostMonth = loadsPerMonth * haulingCost;
  var solidsTotalMonth = disposalCostMonth + haulingCostMonth;

  document.getElementById('solids_wet_tons').textContent = wetTons.toFixed(1);
  document.getElementById('solids_loads_month').textContent = loadsPerMonth.toFixed(1);
  document.getElementById('solids_disposal_cost').textContent = '$' + disposalCostMonth.toFixed(2);
  document.getElementById('solids_hauling_cost').textContent = '$' + haulingCostMonth.toFixed(2);
  document.getElementById('solids_monthly_total').textContent = '$' + solidsTotalMonth.toFixed(2);

  // Calculate totals
  var chemMonthly = chemDailyTotal * 30;
  var energyMonthly = energyDailyCost * 30;
  var solidsMonthly = solidsTotalMonth;

  var totalDaily = chemDailyTotal + energyDailyCost + (solidsTotalMonth / 30);
  var totalMonthly = chemMonthly + energyMonthly + solidsMonthly;
  var totalAnnual = totalMonthly * 12;

  var mgPerYear = flowMGD * opDays;
  var costPerMG = (mgPerYear > 0) ? (totalAnnual / mgPerYear) : 0;

  // Update KPI cards
  document.getElementById('cost_daily').textContent = '$' + totalDaily.toFixed(2);
  document.getElementById('cost_monthly').textContent = '$' + totalMonthly.toFixed(2);
  document.getElementById('cost_annual').textContent = '$' + totalAnnual.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('cost_per_mg').textContent = '$' + costPerMG.toFixed(2);

  // Update summary table
  document.getElementById('sum_chem_monthly').textContent = '$' + chemMonthly.toFixed(2);
  document.getElementById('sum_chem_annual').textContent = '$' + (chemMonthly * 12).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sum_energy_monthly').textContent = '$' + energyMonthly.toFixed(2);
  document.getElementById('sum_energy_annual').textContent = '$' + (energyMonthly * 12).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sum_solids_monthly').textContent = '$' + solidsMonthly.toFixed(2);
  document.getElementById('sum_solids_annual').textContent = '$' + (solidsMonthly * 12).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  document.getElementById('sum_total_monthly').innerHTML = '<strong>$' + totalMonthly.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</strong>';
  document.getElementById('sum_total_annual').innerHTML = '<strong>$' + totalAnnual.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</strong>';
  document.getElementById('sum_cost_per_mg').innerHTML = '<strong>$' + costPerMG.toFixed(2) + '/MG</strong>';

}

function addChemicalRow() {
  var tbody = document.querySelector('#chemCostTable tbody');
  var newRow = document.createElement('tr');
  newRow.innerHTML = '<td><input type="text" value="New Chemical" style="width:100px" class="chem-name"></td>' +
    '<td><input type="number" value="0" step="0.1" class="chem-dose" onchange="calculateAllCosts()"></td>' +
    '<td><input type="number" value="0.00" step="0.01" class="chem-price" onchange="calculateAllCosts()"></td>' +
    '<td class="chem-daily-use">-</td>' +
    '<td class="chem-daily-cost">-</td>' +
    '<td class="chem-monthly-cost">-</td>';
  tbody.appendChild(newRow);
}

function addEquipmentRow() {
  var tbody = document.querySelector('#energyCostTable tbody');
  var newRow = document.createElement('tr');
  newRow.innerHTML = '<td><input type="text" value="New Equipment" style="width:100px" class="equip-name"></td>' +
    '<td><input type="number" value="0" step="1" class="equip-hp" onchange="calculateAllCosts()"></td>' +
    '<td><input type="number" value="1" step="1" class="equip-qty" onchange="calculateAllCosts()"></td>' +
    '<td><input type="number" value="24" step="0.5" class="equip-hrs" onchange="calculateAllCosts()"></td>' +
    '<td class="equip-daily-kwh">-</td>' +
    '<td class="equip-daily-cost">-</td>' +
    '<td class="equip-monthly-cost">-</td>';
  tbody.appendChild(newRow);
}

function saveCostData() {
  var data = {
    flow: document.getElementById('cost_flow_mgd').value,
    opDays: document.getElementById('cost_op_days').value,
    kwhRate: document.getElementById('cost_kwh_rate').value,
    demandRate: document.getElementById('cost_demand_rate').value,
    sludgeTons: document.getElementById('cost_sludge_tons').value,
    disposalRate: document.getElementById('cost_disposal_rate').value,
    cakeSolids: document.getElementById('cost_cake_solids').value,
    hauling: document.getElementById('cost_hauling').value,
    tonsPerLoad: document.getElementById('cost_tons_per_load').value,
    chemicals: [],
    equipment: []
  };

  document.querySelectorAll('#chemCostTable tbody tr').forEach(function(row) {
    data.chemicals.push({
      name: row.querySelector('.chem-name').value,
      dose: row.querySelector('.chem-dose').value,
      price: row.querySelector('.chem-price').value
    });
  });

  document.querySelectorAll('#energyCostTable tbody tr').forEach(function(row) {
    data.equipment.push({
      name: row.querySelector('.equip-name').value,
      hp: row.querySelector('.equip-hp').value,
      qty: row.querySelector('.equip-qty').value,
      hrs: row.querySelector('.equip-hrs').value
    });
  });

  localStorage.setItem('wwtp_cost_data', JSON.stringify(data));
  showToast('üíæ Cost data saved!', 'success');
}

function loadCostData() {
  var saved = localStorage.getItem('wwtp_cost_data');
  if (!saved) return;

  try {
    var data = JSON.parse(saved);
    document.getElementById('cost_flow_mgd').value = data.flow || 5;
    document.getElementById('cost_op_days').value = data.opDays || 365;
    document.getElementById('cost_kwh_rate').value = data.kwhRate || 0.08;
    document.getElementById('cost_demand_rate').value = data.demandRate || 10;
    document.getElementById('cost_sludge_tons').value = data.sludgeTons || 2.5;
    document.getElementById('cost_disposal_rate').value = data.disposalRate || 45;
    document.getElementById('cost_cake_solids').value = data.cakeSolids || 22;
    document.getElementById('cost_hauling').value = data.hauling || 350;
    document.getElementById('cost_tons_per_load').value = data.tonsPerLoad || 20;

  } catch(e) {
    console.error('Error loading cost data:', e);
  }
}

function exportCostReport() {
  var flow = document.getElementById('cost_flow_mgd').value;
  var daily = document.getElementById('cost_daily').textContent;
  var monthly = document.getElementById('cost_monthly').textContent;
  var annual = document.getElementById('cost_annual').textContent;
  var perMG = document.getElementById('cost_per_mg').textContent;

  var report = 'WWTP OPERATIONS COST REPORT\\n';
  report += '============================\\n\\n';
  report += 'Plant Flow: ' + flow + ' MGD\\n\\n';
  report += 'COST SUMMARY\\n';
  report += '------------\\n';
  report += 'Daily Cost: ' + daily + '\\n';
  report += 'Monthly Cost: ' + monthly + '\\n';
  report += 'Annual Cost: ' + annual + '\\n';
  report += 'Cost per MG: ' + perMG + '\\n\\n';
  report += 'Generated: ' + new Date().toLocaleString() + '\\n';
  report += 'WWTP Command Center v9.5.0';

  alert(report);
  showToast('üìÑ Report generated!', 'success');
}

// Load saved cost data on page load
document.addEventListener('DOMContentLoaded', function() {
  loadCostData();
});

// ==================== END COST CALCULATOR FUNCTIONS ====================

// Reactor section switcher
function showReactorSection(section) {

  // Get all reactor content divs
  var sbrDiv = document.getElementById('reactor-sbr');
  var mbrDiv = document.getElementById('reactor-mbr');
  var mbbrDiv = document.getElementById('reactor-mbbr');

  // Hide all sections
  if (sbrDiv) sbrDiv.style.display = 'none';
  if (mbrDiv) mbrDiv.style.display = 'none';
  if (mbbrDiv) mbbrDiv.style.display = 'none';

  // Show selected section
  if (section === 'sbr' && sbrDiv) sbrDiv.style.display = 'block';
  if (section === 'mbr' && mbrDiv) mbrDiv.style.display = 'block';
  if (section === 'mbbr' && mbbrDiv) mbbrDiv.style.display = 'block';

  // Update button active states
  var btnSbr = document.getElementById('btn-sbr');
  var btnMbr = document.getElementById('btn-mbr');
  var btnMbbr = document.getElementById('btn-mbbr');

  if (btnSbr) {
    btnSbr.className = section === 'sbr' ? 'btn gradient active' : 'btn gray';
  }
  if (btnMbr) {
    btnMbr.className = section === 'mbr' ? 'btn blue active' : 'btn gray';
  }
  if (btnMbbr) {
    btnMbbr.className = section === 'mbbr' ? 'btn purple active' : 'btn gray';
  }

}

// ==================== AERATION & ENERGY CALCULATORS ====================
function calcAOTR() {
  var sotr = parseFloat(document.getElementById('aer_sotr').value) || 150;
  var temp = parseFloat(document.getElementById('aer_temp').value) || 20;
  var opDO = parseFloat(document.getElementById('aer_do').value) || 2.0;
  var satDO = parseFloat(document.getElementById('aer_do_sat').value) || 9.1;
  var alpha = parseFloat(document.getElementById('aer_alpha').value) || 0.85;
  var beta = parseFloat(document.getElementById('aer_beta').value) || 0.95;

  // Theta correction for temperature
  var theta = Math.pow(1.024, temp - 20);

  // DO saturation at field conditions
  var csField = beta * satDO;

  // AOTR calculation
  var aotr = sotr * alpha * theta * ((csField - opDO) / 9.17);

  // Transfer efficiency
  var eff = (aotr / sotr) * 100;

  document.getElementById('r_aer_theta').textContent = theta.toFixed(3);
  document.getElementById('r_aer_aotr').textContent = aotr.toFixed(1);
  document.getElementById('r_aer_eff').textContent = eff.toFixed(1);
}

function calcBlowerPower() {
  var scfm = parseFloat(document.getElementById('aer_scfm').value) || 5000;
  var psi = parseFloat(document.getElementById('aer_psi').value) || 8;
  var inletTemp = parseFloat(document.getElementById('aer_inlet_temp').value) || 70;
  var eff = parseFloat(document.getElementById('aer_blower_eff').value) / 100 || 0.70;

  // Convert to absolute values
  var p1 = 14.7; // atmospheric psia
  var p2 = p1 + psi;
  var t1 = inletTemp + 460; // Rankine

  // Adiabatic head (simplified)
  var k = 1.4; // specific heat ratio for air
  var head = (k / (k - 1)) * (t1 / 1) * (Math.pow(p2 / p1, (k - 1) / k) - 1);

  // Brake horsepower
  var bhp = (scfm * head) / (33000 * eff);
  var motorHP = bhp * 1.15; // 15% service factor
  var kw = motorHP * 0.746;

  document.getElementById('r_blower_bhp').textContent = bhp.toFixed(1);
  document.getElementById('r_blower_motor').textContent = Math.ceil(motorHP / 5) * 5; // Round to nearest 5 HP
  document.getElementById('r_blower_kw').textContent = kw.toFixed(1);
}

function calcEnergyUse() {
  var blowerHP = parseFloat(document.getElementById('eng_blower_hp').value) || 200;
  var pumpHP = parseFloat(document.getElementById('eng_pump_hp').value) || 100;
  var otherHP = parseFloat(document.getElementById('eng_other_hp').value) || 50;
  var hours = parseFloat(document.getElementById('eng_hours').value) || 24;
  var rate = parseFloat(document.getElementById('eng_rate').value) || 0.12;

  var totalHP = blowerHP + pumpHP + otherHP;
  var totalKW = totalHP * 0.746;
  var dailyKWH = totalKW * hours;
  var monthlyCost = dailyKWH * 30 * rate;
  var annualCost = dailyKWH * 365 * rate;

  // Intensity assuming 5 MGD
  var intensity = dailyKWH / 5;

  document.getElementById('r_eng_daily').textContent = dailyKWH.toFixed(0);
  document.getElementById('r_eng_monthly').textContent = '$' + monthlyCost.toFixed(0);
  document.getElementById('r_eng_annual').textContent = '$' + annualCost.toFixed(0);
  document.getElementById('r_eng_intensity').textContent = intensity.toFixed(0);
}

// ==================== CHEMICAL SYSTEMS CALCULATORS ====================
function calcChemFeed() {
  var flow = parseFloat(document.getElementById('chem_flow').value) || 5;
  var pIn = parseFloat(document.getElementById('chem_p_in').value) || 6;
  var pTarget = parseFloat(document.getElementById('chem_p_target').value) || 1;
  var chemType = document.getElementById('chem_type').value;
  var strength = parseFloat(document.getElementById('chem_strength').value) / 100 || 0.48;
  var cost = parseFloat(document.getElementById('chem_cost').value) || 2.50;

  var pRemoval = pIn - pTarget;

  // Me:P ratios vary by chemical
  var meP, meWeight;
  switch(chemType) {
    case 'alum': meP = 2.5; meWeight = 27; break; // Al
    case 'ferric': meP = 2.0; meWeight = 56; break; // Fe
    case 'pac': meP = 1.5; meWeight = 27; break; // Al in PAC
    default: meP = 2.0; meWeight = 56;
  }

  // Calculate dose
  var meDose = pRemoval * meP * (meWeight / 31); // mg/L as metal
  var chemDose = meDose / strength; // Adjust for solution strength

  // Feed rate
  var gpd = (flow * chemDose * 8.34) / (8.34 * strength);
  var dailyCost = (gpd / 1000) * cost * 1000; // Simplified

  document.getElementById('r_chem_ratio').textContent = meP.toFixed(1) + ':1';
  document.getElementById('r_chem_dose').textContent = chemDose.toFixed(1);
  document.getElementById('r_chem_gpd').textContent = gpd.toFixed(0);
  document.getElementById('r_chem_daily_cost').textContent = '$' + dailyCost.toFixed(0);
}

function calcChlorine() {
  var flow = parseFloat(document.getElementById('cl_flow').value) || 5;
  var dose = parseFloat(document.getElementById('cl_dose').value) || 5;
  var strength = parseFloat(document.getElementById('cl_strength').value) / 100 || 0.125;
  var contact = parseFloat(document.getElementById('cl_contact').value) || 30;

  var lbDay = flow * dose * 8.34;
  var gpd = lbDay / (8.34 * strength);
  var ct = dose * contact;

  document.getElementById('r_cl_lb').textContent = lbDay.toFixed(1);
  document.getElementById('r_cl_gpd').textContent = gpd.toFixed(0);
  document.getElementById('r_cl_ct').textContent = ct.toFixed(0);
}

function calcPolymer() {
  var flow = parseFloat(document.getElementById('poly_flow').value) || 50;
  var solids = parseFloat(document.getElementById('poly_solids').value) / 100 || 0.03;
  var dose = parseFloat(document.getElementById('poly_dose').value) || 12;
  var conc = parseFloat(document.getElementById('poly_conc').value) / 100 || 0.005;

  var gpd = flow * 60 * 24;
  var lbSolids = gpd * 8.34 * solids;
  var dryTons = lbSolids / 2000;
  var polyLb = dryTons * dose;
  var solnGPM = (polyLb / 24 / 60) / (8.34 * conc);

  document.getElementById('r_poly_dt').textContent = dryTons.toFixed(2);
  document.getElementById('r_poly_lb').textContent = polyLb.toFixed(1);
  document.getElementById('r_poly_gpm').textContent = solnGPM.toFixed(2);
}

function calcAlkalinity() {
  var flow = parseFloat(document.getElementById('alk_flow').value) || 5;
  var current = parseFloat(document.getElementById('alk_current').value) || 120;
  var target = parseFloat(document.getElementById('alk_target').value) || 200;
  var chem = document.getElementById('alk_chem').value;

  var increase = target - current;

  // Equivalent weights
  var factor, density;
  switch(chem) {
    case 'naoh': factor = 0.8; density = 12.5; break; // 50% NaOH
    case 'lime': factor = 0.74; density = 6; break; // Ca(OH)2
    case 'soda': factor = 1.06; density = 8; break; // Na2CO3
    default: factor = 0.8; density = 12.5;
  }

  var lbDay = flow * increase * 8.34 * factor;
  var gpd = lbDay / density;

  document.getElementById('r_alk_increase').textContent = increase.toFixed(0);
  document.getElementById('r_alk_lb').textContent = lbDay.toFixed(0);
  document.getElementById('r_alk_gpd').textContent = gpd.toFixed(0);
}

// ==================== SOLIDS HANDLING CALCULATORS ====================
function calcSludgeProduction() {
  var flow = parseFloat(document.getElementById('sp_flow').value) || 5;
  var tssIn = parseFloat(document.getElementById('sp_tss_in').value) || 220;
  var primRem = parseFloat(document.getElementById('sp_prim_rem').value) / 100 || 0.6;
  var bodIn = parseFloat(document.getElementById('sp_bod_in').value) || 200;
  var yieldCoef = parseFloat(document.getElementById('sp_yield').value) || 0.6;
  var vssTss = parseFloat(document.getElementById('sp_vss_tss').value) || 0.75;

  var conv = flow * 8.34;

  // Primary sludge
  var primTSS = tssIn * primRem * conv;
  var primVol4pct = primTSS / (8.34 * 0.04);

  // Secondary (biological) sludge
  var secBOD = bodIn * (1 - primRem * 0.3) * 0.90; // BOD removed in secondary
  var bioVSS = secBOD * conv * yieldCoef;
  var bioTSS = bioVSS / vssTss;
  var wasVol1pct = bioTSS / (8.34 * 0.01);

  var totalSludge = primTSS + bioTSS;

  var html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">';
  html += '<div style="background:#1a2744;padding:15px;border-radius:8px">';
  html += '<h4 style="color:#ffd166;margin:0 0 15px 0">üî∂ Primary Sludge</h4>';
  html += '<div>TSS Captured: <strong>' + primTSS.toFixed(0) + '</strong> lb/day</div>';
  html += '<div>Volume @ 4%: <strong>' + primVol4pct.toFixed(0) + '</strong> gpd</div>';
  html += '</div>';
  html += '<div style="background:#1a2744;padding:15px;border-radius:8px">';
  html += '<h4 style="color:#a78bfa;margin:0 0 15px 0">üî∑ WAS (Secondary)</h4>';
  html += '<div>VSS Produced: <strong>' + bioVSS.toFixed(0) + '</strong> lb/day</div>';
  html += '<div>TSS Produced: <strong>' + bioTSS.toFixed(0) + '</strong> lb/day</div>';
  html += '<div>Volume @ 1%: <strong>' + wasVol1pct.toFixed(0) + '</strong> gpd</div>';
  html += '</div></div>';
  html += '<div style="background:#059669;padding:15px;border-radius:8px;margin-top:15px;color:white;text-align:center">';
  html += '<div style="font-size:12px">Total Daily Sludge Production</div>';
  html += '<div style="font-size:20px;font-weight:bold">' + totalSludge.toFixed(0) + ' lb/day</div>';
  html += '</div>';

  document.getElementById('sp_results').innerHTML = html;
}

function resetSludgeProduction() {
  document.getElementById('sp_flow').value = '5.0';
  document.getElementById('sp_tss_in').value = '220';
  document.getElementById('sp_results').innerHTML = '';
}

function calcWASRate() {
  var vol = parseFloat(document.getElementById('was_vol').value) || 1.5;
  var mlss = parseFloat(document.getElementById('was_mlss').value) || 3000;
  var srt = parseFloat(document.getElementById('was_srt').value) || 10;
  var conc = parseFloat(document.getElementById('was_conc').value) || 8000;

  var inventory = vol * mlss * 8.34;
  var wasMass = inventory / srt;
  var wasGPD = wasMass / (conc * 8.34 / 1000000);
  var wasGPM = wasGPD / 1440;

  document.getElementById('r_was_inv').textContent = inventory.toFixed(0);
  document.getElementById('r_was_mass').textContent = wasMass.toFixed(0);
  document.getElementById('r_was_gpd').textContent = wasGPD.toFixed(0);
  document.getElementById('r_was_gpm').textContent = wasGPM.toFixed(1);
}

function calcThickenerLoading() {
  var flow = parseFloat(document.getElementById('gt_flow').value) || 50000;
  var feedTSS = parseFloat(document.getElementById('gt_feed_tss').value) / 100 || 0.01;
  var dia = parseFloat(document.getElementById('gt_dia').value) || 30;

  var area = Math.PI * Math.pow(dia/2, 2);
  var hydLoad = flow / area;
  var solLoad = (flow * 8.34 * feedTSS) / area;

  var status = solLoad <= 10 ? 'Excellent' : solLoad <= 20 ? 'Good' : solLoad <= 30 ? 'Acceptable' : 'Overloaded';
  var statusClass = solLoad <= 10 ? 'good' : solLoad <= 20 ? 'good' : solLoad <= 30 ? 'warn' : 'bad';

  document.getElementById('r_gt_area').textContent = area.toFixed(0);
  document.getElementById('r_gt_hyd').textContent = hydLoad.toFixed(0);
  document.getElementById('r_gt_sol').textContent = solLoad.toFixed(1);
  document.getElementById('r_gt_status').textContent = status;
  document.getElementById('r_gt_status').className = 'status ' + statusClass;
}

function calcDewatering() {
  var feed = parseFloat(document.getElementById('dw_feed').value) || 50;
  var feedPct = parseFloat(document.getElementById('dw_feed_pct').value) / 100 || 0.03;
  var cakePct = parseFloat(document.getElementById('dw_cake_pct').value) / 100 || 0.20;
  var polyDose = parseFloat(document.getElementById('dw_poly').value) || 12;
  var polyCost = parseFloat(document.getElementById('dw_poly_cost').value) || 2.50;

  var feedGPD = feed * 60 * 24;
  var feedLb = feedGPD * 8.34 * feedPct;
  var dryTons = feedLb / 2000;
  var cakeLb = feedLb; // solids in = solids out (conservation)
  var cakeWet = cakeLb / cakePct;
  var cakeTons = cakeWet / 2000;
  var polyLb = dryTons * polyDose;
  var polyCostDay = polyLb * polyCost;
  var captureEff = 95; // typical

  var html = '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Feed Solids</div>';
  html += '<div style="color:#4ade80;font-size:20px;font-weight:bold">' + feedLb.toFixed(0) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">lb/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Dry Tons/Day</div>';
  html += '<div style="color:#60a5fa;font-size:20px;font-weight:bold">' + dryTons.toFixed(1) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">DT/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Wet Cake</div>';
  html += '<div style="color:#ffd166;font-size:20px;font-weight:bold">' + cakeTons.toFixed(1) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">wet tons/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Polymer Cost</div>';
  html += '<div style="color:#a78bfa;font-size:20px;font-weight:bold">$' + polyCostDay.toFixed(0) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">per day</div></div>';
  html += '</div>';

  document.getElementById('dw_results').innerHTML = html;
}

// ==================== TCEQ COMPLIANCE MODULE ====================

// ==================== CHEMICAL FEED OPTIMIZER ====================
function optimizeChemFeed() {
  var flow = parseFloat(document.getElementById('cfo_flow').value) || 5;
  var pIn = parseFloat(document.getElementById('cfo_p_in').value) || 6;
  var pTarget = parseFloat(document.getElementById('cfo_p_target').value) || 1;
  var ph = parseFloat(document.getElementById('cfo_ph').value) || 7;
  var alk = parseFloat(document.getElementById('cfo_alk').value) || 200;
  var chem = document.getElementById('cfo_chem1').value;
  var strength = parseFloat(document.getElementById('cfo_strength').value) || 48;
  var sg = parseFloat(document.getElementById('cfo_sg').value) || 1.33;
  var cost = parseFloat(document.getElementById('cfo_cost').value) || 0.15;
  var targetRatio = parseFloat(document.getElementById('cfo_ratio').value) || 2;

  var pRemoval = pIn - pTarget;
  var pLoad = pRemoval * flow * 8.34; // lb P/day

  // Chemical properties
  var chemProps = {
    alum: { mw: 594, me_mw: 27, me_per_mol: 2, name: 'Alum', optimal_ph: [6.0, 7.0] },
    ferric: { mw: 162.2, me_mw: 55.85, me_per_mol: 1, name: 'Ferric Chloride', optimal_ph: [4.5, 5.5] },
    ferrous: { mw: 278, me_mw: 55.85, me_per_mol: 1, name: 'Ferrous Sulfate', optimal_ph: [7.0, 8.0] },
    pac: { mw: 174, me_mw: 27, me_per_mol: 1.5, name: 'PAC', optimal_ph: [6.5, 7.5] }
  };

  var props = chemProps[chem];
  var meRequired = pLoad * targetRatio / 31; // moles of metal
  var chemRequired = meRequired * props.mw / props.me_per_mol; // lb chemical/day

  var solutionLbGal = sg * 8.34 * (strength / 100);
  var solutionGPD = chemRequired / solutionLbGal;
  var solutionGPH = solutionGPD / 24;
  var mlMin = solutionGPH * 3785.41 / 60;

  // Alkalinity consumption (approx 0.5 mg/L alk per mg/L alum)
  var alkConsumed = (chemRequired / (flow * 8.34)) * 0.5;
  var alkRemaining = alk - alkConsumed;

  // pH impact assessment
  var phOptimal = ph >= props.optimal_ph[0] && ph <= props.optimal_ph[1];

  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 20px 0">üéØ Optimized Chemical Feed - ' + props.name + '</h4>';

  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">P to Remove</div>';
  html += '<div style="color:#4ade80;font-size:20px;font-weight:bold">' + pRemoval.toFixed(1) + ' mg/L</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">P Load</div>';
  html += '<div style="color:#60a5fa;font-size:20px;font-weight:bold">' + pLoad.toFixed(1) + ' lb/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Me:P Ratio</div>';
  html += '<div style="color:#ffd166;font-size:20px;font-weight:bold">' + targetRatio.toFixed(1) + ':1</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Chemical Dose</div>';
  html += '<div style="color:#a78bfa;font-size:20px;font-weight:bold">' + (chemRequired / (flow * 8.34)).toFixed(0) + ' mg/L</div></div>';
  html += '</div>';

  html += '<table class="table"><tbody>';
  html += '<tr><td>Chemical Feed Rate</td><td><strong>' + chemRequired.toFixed(1) + '</strong></td><td>lb/day</td></tr>';
  html += '<tr><td>Solution Feed Rate</td><td><strong>' + solutionGPD.toFixed(1) + '</strong></td><td>gpd</td></tr>';
  html += '<tr><td>Hourly Feed Rate</td><td><strong>' + solutionGPH.toFixed(2) + '</strong></td><td>gph</td></tr>';
  html += '<tr><td>Feed Rate</td><td><strong>' + mlMin.toFixed(1) + '</strong></td><td>mL/min</td></tr>';
  html += '<tr><td>Alk Remaining</td><td><strong>' + alkRemaining.toFixed(0) + '</strong></td><td>mg/L as CaCO3</td></tr>';
  html += '</tbody></table>';

  // pH optimization note
  if (!phOptimal) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Current pH (' + ph + ') is outside optimal range (' + props.optimal_ph[0] + '-' + props.optimal_ph[1] + ') for ' + props.name + '. Consider pH adjustment for better performance.</div>';
  }

  if (alkRemaining < 50) {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è Low residual alkalinity may cause pH depression. Consider supplemental alkalinity (lime/soda ash).</div>';
  }

  html += '</div>';
  document.getElementById('cfo_results').innerHTML = html;
  showToast('Chemical feed optimized', 'success');
}

function calcChemCost() {
  var flow = parseFloat(document.getElementById('cfo_flow').value) || 5;
  var pIn = parseFloat(document.getElementById('cfo_p_in').value) || 6;
  var pTarget = parseFloat(document.getElementById('cfo_p_target').value) || 1;
  var cost = parseFloat(document.getElementById('cfo_cost').value) || 0.15;
  var strength = parseFloat(document.getElementById('cfo_strength').value) || 48;
  var sg = parseFloat(document.getElementById('cfo_sg').value) || 1.33;
  var targetRatio = parseFloat(document.getElementById('cfo_ratio').value) || 2;

  var pRemoval = pIn - pTarget;
  var pLoad = pRemoval * flow * 8.34;
  var chemRequired = pLoad * targetRatio * 5.4; // Approx for alum

  var dailyCost = chemRequired * cost;
  var monthlyCost = dailyCost * 30;
  var annualCost = dailyCost * 365;
  var costPerMG = dailyCost / flow;

  var html = '<div style="background:linear-gradient(135deg,#059669,#06d6a0);padding:20px;border-radius:12px;margin-top:15px">';
  html += '<h4 style="margin:0 0 15px 0">üí∞ Cost Analysis</h4>';
  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px">';
  html += '<div><div style="opacity:0.9;font-size:12px">Daily</div><div style="font-size:18px;font-weight:bold">$' + dailyCost.toFixed(0) + '</div></div>';
  html += '<div><div style="opacity:0.9;font-size:12px">Monthly</div><div style="font-size:18px;font-weight:bold">$' + monthlyCost.toFixed(0) + '</div></div>';
  html += '<div><div style="opacity:0.9;font-size:12px">Annual</div><div style="font-size:18px;font-weight:bold">$' + annualCost.toLocaleString() + '</div></div>';
  html += '<div><div style="opacity:0.9;font-size:12px">Per MG</div><div style="font-size:18px;font-weight:bold">$' + costPerMG.toFixed(2) + '</div></div>';
  html += '</div></div>';

  document.getElementById('cfo_results').innerHTML += html;
}

function resetChemOptimizer() {
  document.getElementById('cfo_flow').value = '5.0';
  document.getElementById('cfo_p_in').value = '6.0';
  document.getElementById('cfo_p_target').value = '1.0';
  document.getElementById('cfo_results').innerHTML = '';
}

// ==================== EQUALIZATION BASIN SIZING ====================
function calcEQBasin() {
  var avgFlow = parseFloat(document.getElementById('eq_avg_flow').value) || 5;
  var peakFlow = parseFloat(document.getElementById('eq_peak_flow').value) || 8;
  var minFlow = parseFloat(document.getElementById('eq_min_flow').value) || 2.5;
  var targetFlow = parseFloat(document.getElementById('eq_target').value) || 5.5;
  var depth = parseFloat(document.getElementById('eq_depth').value) || 12;
  var freeboard = parseFloat(document.getElementById('eq_freeboard').value) || 2;
  var sf = parseFloat(document.getElementById('eq_sf').value) || 1.25;

  // Get hourly pattern
  var pattern = [];
  for (var h = 0; h < 24; h += 2) {
    var pct = parseFloat(document.getElementById('eq_h' + h).value) || 100;
    pattern.push(pct / 100);
    pattern.push(pct / 100); // Duplicate for odd hours
  }

  // Calculate cumulative volume difference
  var hourlyAvg = avgFlow / 24;
  var hourlyTarget = targetFlow / 24;
  var cumulative = 0;
  var maxStorage = 0;
  var minStorage = 0;

  for (var i = 0; i < 24; i++) {
    var hourlyIn = hourlyAvg * pattern[i];
    var diff = hourlyIn - hourlyTarget;
    cumulative += diff;
    maxStorage = Math.max(maxStorage, cumulative);
    minStorage = Math.min(minStorage, cumulative);
  }

  var requiredVolMG = (maxStorage - minStorage) * sf;
  var requiredVolGal = requiredVolMG * 1000000;
  var requiredVolCF = requiredVolGal / 7.48;
  var surfaceArea = requiredVolCF / depth;
  var sideDim = Math.sqrt(surfaceArea);

  var totalDepth = depth + freeboard;
  var detentionTime = (requiredVolMG / avgFlow) * 24 * 60; // minutes

  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 20px 0">üåä Equalization Basin Design</h4>';

  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Peak Factor</div>';
  html += '<div style="color:#ffd166;font-size:18px;font-weight:bold">' + (peakFlow/avgFlow).toFixed(2) + '</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Required Volume</div>';
  html += '<div style="color:#4ade80;font-size:18px;font-weight:bold">' + requiredVolMG.toFixed(2) + ' MG</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Detention Time</div>';
  html += '<div style="color:#60a5fa;font-size:18px;font-weight:bold">' + detentionTime.toFixed(0) + ' min</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Surface Area</div>';
  html += '<div style="color:#a78bfa;font-size:18px;font-weight:bold">' + surfaceArea.toFixed(0) + ' sf</div></div>';
  html += '</div>';

  html += '<table class="table"><tbody>';
  html += '<tr><td>Required Volume</td><td><strong>' + requiredVolGal.toLocaleString() + '</strong></td><td>gallons</td></tr>';
  html += '<tr><td>Operating Depth</td><td><strong>' + depth + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Total Depth (w/ freeboard)</td><td><strong>' + totalDepth + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Basin Dimensions (square)</td><td><strong>' + sideDim.toFixed(0) + ' √ó ' + sideDim.toFixed(0) + '</strong></td><td>ft</td></tr>';
  html += '<tr><td>Safety Factor Applied</td><td><strong>' + sf + '</strong></td><td></td></tr>';
  html += '</tbody></table>';

  html += '<div class="note info" style="margin-top:15px">üí° <strong>Design Notes:</strong> Provide mixing (10-20 HP/MG), odor control for >4 hr detention, and consider aeration if detention >30 minutes.</div>';
  html += '</div>';

  document.getElementById('eq_results').innerHTML = html;
  showToast('EQ basin sized', 'success');
}

function loadTypicalPattern() {
  var typical = {50:0, 40:2, 45:4, 80:6, 130:8, 120:10, 115:12, 110:14, 105:16, 125:18, 110:20, 70:22};
  for (var h in typical) {
    document.getElementById('eq_h' + typical[h]).value = h;
  }
  // Fix the mapping
  document.getElementById('eq_h0').value = '50';
  document.getElementById('eq_h2').value = '40';
  document.getElementById('eq_h4').value = '45';
  document.getElementById('eq_h6').value = '80';
  document.getElementById('eq_h8').value = '130';
  document.getElementById('eq_h10').value = '120';
  document.getElementById('eq_h12').value = '115';
  document.getElementById('eq_h14').value = '110';
  document.getElementById('eq_h16').value = '105';
  document.getElementById('eq_h18').value = '125';
  document.getElementById('eq_h20').value = '110';
  document.getElementById('eq_h22').value = '70';
  showToast('Typical diurnal pattern loaded', 'success');
}

function resetEQBasin() {
  document.getElementById('eq_avg_flow').value = '5.0';
  document.getElementById('eq_peak_flow').value = '8.0';
  document.getElementById('eq_results').innerHTML = '';
  loadTypicalPattern();
}

// ==================== VIOLATION RISK PREDICTOR ====================
function predictViolationRisk() {
  var bodLimit = parseFloat(document.getElementById('vr_bod_limit').value) || 45;
  var bodMonthly = parseFloat(document.getElementById('vr_bod_monthly').value) || 30;
  var tssLimit = parseFloat(document.getElementById('vr_tss_limit').value) || 45;
  var tssMonthly = parseFloat(document.getElementById('vr_tss_monthly').value) || 30;
  var nh3Limit = parseFloat(document.getElementById('vr_nh3_limit').value) || 4;

  var bodAvg = parseFloat(document.getElementById('vr_bod_avg').value) || 18;
  var bodStd = parseFloat(document.getElementById('vr_bod_std').value) || 5;
  var tssAvg = parseFloat(document.getElementById('vr_tss_avg').value) || 15;
  var tssStd = parseFloat(document.getElementById('vr_tss_std').value) || 4;
  var nh3Avg = parseFloat(document.getElementById('vr_nh3_avg').value) || 1.5;
  var nh3Std = parseFloat(document.getElementById('vr_nh3_std').value) || 0.8;

  // Calculate Z-scores and probabilities using normal distribution
  function calcRisk(avg, std, limit) {
    var z = (limit - avg) / std;
    // Approximate normal CDF
    var risk = 1 - normalCDF(z);
    return Math.max(0, Math.min(100, risk * 100));
  }

  function normalCDF(z) {
    var a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;
    var a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;
    var sign = z < 0 ? -1 : 1;
    z = Math.abs(z) / Math.sqrt(2);
    var t = 1.0 / (1.0 + p * z);
    var y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-z * z);
    return 0.5 * (1.0 + sign * y);
  }

  var bodDailyRisk = calcRisk(bodAvg, bodStd, bodLimit);
  var bodMonthlyRisk = calcRisk(bodAvg, bodStd / Math.sqrt(30), bodMonthly);
  var tssDailyRisk = calcRisk(tssAvg, tssStd, tssLimit);
  var tssMonthlyRisk = calcRisk(tssAvg, tssStd / Math.sqrt(30), tssMonthly);
  var nh3Risk = calcRisk(nh3Avg, nh3Std, nh3Limit);

  var overallRisk = Math.max(bodDailyRisk, bodMonthlyRisk, tssDailyRisk, tssMonthlyRisk, nh3Risk);

  function riskColor(risk) {
    if (risk < 5) return '#06d6a0';
    if (risk < 15) return '#ffd166';
    return '#ef4444';
  }

  function riskLevel(risk) {
    if (risk < 5) return 'LOW';
    if (risk < 15) return 'MODERATE';
    return 'HIGH';
  }

  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 20px 0">‚ö†Ô∏è Violation Risk Assessment</h4>';

  // Overall risk gauge
  html += '<div style="text-align:center;margin-bottom:25px">';
  html += '<div style="font-size:14px;color:#94a3b8;margin-bottom:10px">Overall Violation Risk</div>';
  html += '<div style="font-size:48px;font-weight:bold;color:' + riskColor(overallRisk) + '">' + overallRisk.toFixed(1) + '%</div>';
  html += '<div style="font-size:18px;color:' + riskColor(overallRisk) + '">' + riskLevel(overallRisk) + ' RISK</div>';
  html += '</div>';

  html += '<table class="table"><thead><tr><th>Parameter</th><th>Limit</th><th>Avg ¬± œÉ</th><th>Risk %</th><th>Status</th></tr></thead><tbody>';

  html += '<tr><td>BOD (Daily Max)</td><td>' + bodLimit + ' mg/L</td><td>' + bodAvg + ' ¬± ' + bodStd + '</td>';
  html += '<td style="color:' + riskColor(bodDailyRisk) + ';font-weight:bold">' + bodDailyRisk.toFixed(1) + '%</td>';
  html += '<td><span style="color:' + riskColor(bodDailyRisk) + '">' + riskLevel(bodDailyRisk) + '</span></td></tr>';

  html += '<tr><td>BOD (Monthly Avg)</td><td>' + bodMonthly + ' mg/L</td><td>' + bodAvg + ' ¬± ' + (bodStd/Math.sqrt(30)).toFixed(1) + '</td>';
  html += '<td style="color:' + riskColor(bodMonthlyRisk) + ';font-weight:bold">' + bodMonthlyRisk.toFixed(1) + '%</td>';
  html += '<td><span style="color:' + riskColor(bodMonthlyRisk) + '">' + riskLevel(bodMonthlyRisk) + '</span></td></tr>';

  html += '<tr><td>TSS (Daily Max)</td><td>' + tssLimit + ' mg/L</td><td>' + tssAvg + ' ¬± ' + tssStd + '</td>';
  html += '<td style="color:' + riskColor(tssDailyRisk) + ';font-weight:bold">' + tssDailyRisk.toFixed(1) + '%</td>';
  html += '<td><span style="color:' + riskColor(tssDailyRisk) + '">' + riskLevel(tssDailyRisk) + '</span></td></tr>';

  html += '<tr><td>TSS (Monthly Avg)</td><td>' + tssMonthly + ' mg/L</td><td>' + tssAvg + ' ¬± ' + (tssStd/Math.sqrt(30)).toFixed(1) + '</td>';
  html += '<td style="color:' + riskColor(tssMonthlyRisk) + ';font-weight:bold">' + tssMonthlyRisk.toFixed(1) + '%</td>';
  html += '<td><span style="color:' + riskColor(tssMonthlyRisk) + '">' + riskLevel(tssMonthlyRisk) + '</span></td></tr>';

  html += '<tr><td>NH3-N (Daily Max)</td><td>' + nh3Limit + ' mg/L</td><td>' + nh3Avg + ' ¬± ' + nh3Std + '</td>';
  html += '<td style="color:' + riskColor(nh3Risk) + ';font-weight:bold">' + nh3Risk.toFixed(1) + '%</td>';
  html += '<td><span style="color:' + riskColor(nh3Risk) + '">' + riskLevel(nh3Risk) + '</span></td></tr>';

  html += '</tbody></table>';

  // Recommendations
  if (overallRisk > 15) {
    html += '<div class="note warning" style="margin-top:15px"><strong>‚ö†Ô∏è High Risk Recommendations:</strong><ul style="margin:10px 0 0 20px">';
    if (bodDailyRisk > 15 || bodMonthlyRisk > 15) html += '<li>Increase MLSS or SRT to improve BOD removal</li>';
    if (tssDailyRisk > 15 || tssMonthlyRisk > 15) html += '<li>Check clarifier performance and RAS rates</li>';
    if (nh3Risk > 15) html += '<li>Increase SRT for nitrification, verify DO > 2.0 mg/L</li>';
    html += '</ul></div>';
  } else if (overallRisk > 5) {
    html += '<div class="note info" style="margin-top:15px"><strong>üí° Moderate Risk:</strong> Continue monitoring. Consider operational adjustments to increase safety margin.</div>';
  } else {
    html += '<div class="note success" style="margin-top:15px"><strong>‚úÖ Low Risk:</strong> Current operations provide adequate safety margin against violations.</div>';
  }

  html += '</div>';
  document.getElementById('vr_results').innerHTML = html;
  showToast('Risk assessment complete', 'success');
}

function showRiskTrend() {
  showToast('Risk trending feature - coming soon!', 'info');
}

function resetViolationRisk() {
  document.getElementById('vr_bod_avg').value = '18';
  document.getElementById('vr_bod_std').value = '5';
  document.getElementById('vr_tss_avg').value = '15';
  document.getElementById('vr_tss_std').value = '4';
  document.getElementById('vr_nh3_avg').value = '1.5';
  document.getElementById('vr_nh3_std').value = '0.8';
  document.getElementById('vr_results').innerHTML = '';
}

// ==================== SOP LIBRARY ====================
var sopLibrary = {
  startup: {
    title: 'Plant Startup Procedure',
    category: 'Operations',
    steps: [
      'Verify all electrical systems are operational',
      'Check chemical tank levels and calibrate pumps',
      'Inspect all mechanical equipment (blowers, pumps, drives)',
      'Open inlet gates/valves slowly to allow gradual flow increase',
      'Start RAS pumps at minimum speed',
      'Start blowers and verify diffuser operation',
      'Monitor DO levels - target 2.0-4.0 mg/L',
      'Start WAS pumps based on MLSS targets',
      'Enable chemical feed systems (disinfection, nutrients)',
      'Begin sampling program within 24 hours',
      'Document all startup parameters in logbook'
    ],
    warnings: ['Never start blowers without open discharge', 'Verify clarifier mechanisms before flow introduction'],
    references: 'WEF MOP 11, Chapter 15'
  },
  shutdown: {
    title: 'Emergency Shutdown Procedure',
    category: 'Emergency',
    steps: [
      'NOTIFY: Alert supervisor and on-call personnel immediately',
      'ISOLATE: Close influent gates/valves if safe to do so',
      'STOP: Shut down non-essential equipment in reverse startup order',
      'SECURE: De-energize electrical panels if flooding risk',
      'PROTECT: Ensure chemical systems are safely isolated',
      'DOCUMENT: Record time, reason, and actions taken',
      'COMMUNICATE: Notify regulatory agency if required (>24hr bypass)',
      'ASSESS: Evaluate damage and develop restart plan',
      'RESTART: Follow startup procedure when safe'
    ],
    warnings: ['Personnel safety is priority #1', 'Follow LOTO procedures for all equipment', 'Do not enter confined spaces without proper procedures'],
    references: 'Plant Emergency Response Plan, OSHA 29 CFR 1910.147'
  },
  wasting: {
    title: 'Sludge Wasting (WAS) Procedure',
    category: 'Process Control',
    steps: [
      'Review current MLSS, SVI, and target SRT',
      'Calculate WAS volume: WAS (gal) = (Aeration Vol √ó MLSS) / (SRT √ó WAS Conc √ó 8.34)',
      'Or use mass-based: WAS (lb/day) = Aeration Inventory / Target SRT',
      'Verify WAS pump calibration',
      'Record initial totalizer reading',
      'Start WAS pump at calculated rate',
      'Waste during peak biological activity (typically 8AM-4PM)',
      'Monitor settleometer and adjust if SVI changes',
      'Record final totalizer and actual volume wasted',
      'Update process control spreadsheet'
    ],
    warnings: ['Do not waste during storm events', 'Verify thickener/digester capacity before wasting'],
    references: 'WEF MOP 11, Chapter 11; Plant Process Control Plan'
  },
  clarifier: {
    title: 'Clarifier Operations',
    category: 'Operations',
    steps: [
      'Daily: Check effluent clarity and weir condition',
      'Daily: Record sludge blanket depth (target 1-3 ft)',
      'Daily: Observe scum trough and remove accumulated material',
      'Weekly: Check mechanism torque and alarm setpoints',
      'Weekly: Inspect weirs for algae growth, clean as needed',
      'Monthly: Verify drive unit oil level',
      'Quarterly: Inspect underwater components during dewatering',
      'Calculate SOR = Flow (gpd) / Surface Area (sf) - target <800 gpd/sf',
      'Calculate WOR = Flow (gpd) / Weir Length (ft) - target <20,000 gpd/ft',
      'Adjust RAS rate to maintain target blanket depth'
    ],
    warnings: ['Never walk on clarifier without safety harness', 'High torque alarm indicates possible debris or mechanical failure'],
    references: 'WEF MOP 11, Chapter 8'
  },
  disinfection: {
    title: 'Disinfection Operations',
    category: 'Operations',
    steps: [
      'CHLORINATION:',
      '- Verify chlorine residual target (typically 0.5-2.0 mg/L)',
      '- Calculate dose: lb/day = Flow (MGD) √ó Dose (mg/L) √ó 8.34',
      '- Check chlorinator/feed pump operation',
      '- Monitor contact time (CT) requirements',
      '- Sample for residual at end of contact chamber',
      'UV DISINFECTION:',
      '- Record UV intensity and transmittance daily',
      '- Clean quartz sleeves weekly or per manufacturer',
      '- Replace lamps at end of rated life or when intensity drops',
      '- Verify UVT > 55% for adequate disinfection',
      '- Calculate delivered dose based on flow and intensity'
    ],
    warnings: ['Chlorine gas is extremely hazardous - follow safety protocols', 'UV exposure can cause eye/skin damage - never look at operating lamps'],
    references: 'WEF MOP 11, Chapter 12; EPA Disinfection Guidance Manual'
  },
  sampling: {
    title: 'Sampling & Testing Procedures',
    category: 'Laboratory',
    steps: [
      'Review permit requirements for sampling locations/frequency',
      'Prepare clean sample containers (appropriate for parameter)',
      'Composite samples: Program autosampler for 24-hr composite',
      'Grab samples: Collect at same time daily, document time',
      'Fill containers completely for BOD/DO (no headspace)',
      'Preserve samples per method requirements (acid, cooling)',
      'Label all samples: Location, Date, Time, Preservative, Analyst',
      'Maintain chain of custody for compliance samples',
      'Transport to lab within holding time requirements',
      'Document field measurements (pH, temp, DO) immediately',
      'Enter results in LIMS within 24 hours'
    ],
    warnings: ['Never exceed holding times', 'Use appropriate PPE when sampling'],
    references: '40 CFR 136; Standard Methods for Water and Wastewater'
  },
  chemical: {
    title: 'Chemical Handling Safety',
    category: 'Safety',
    steps: [
      'Review SDS before handling any chemical',
      'Wear appropriate PPE: gloves, goggles, apron minimum',
      'Verify ventilation in chemical storage areas',
      'Never mix incompatible chemicals (acids/bases, oxidizers/reducers)',
      'Use dedicated equipment for each chemical',
      'Secondary containment required for all bulk storage',
      'Inspect tanks and piping for leaks daily',
      'Calibrate chemical feed pumps weekly',
      'Document all chemical deliveries and usage',
      'Maintain spill response equipment nearby',
      'Train all personnel on emergency response procedures'
    ],
    warnings: ['NEVER add water to acid - always add acid to water', 'Chlorine gas requires SCBA and specific response procedures'],
    references: 'OSHA 29 CFR 1910.1200; Plant Chemical Hygiene Plan'
  },
  blower: {
    title: 'Blower Operations',
    category: 'Mechanical',
    steps: [
      'Pre-start checks: Oil level, filter condition, coupling alignment',
      'Verify discharge valve is OPEN before starting',
      'Start blower per manufacturer sequence',
      'Monitor discharge pressure and temperature',
      'Check for unusual noise or vibration',
      'Record amp draw and compare to baseline',
      'Adjust VFD speed to meet DO setpoint',
      'Rotate lead/lag blowers weekly',
      'Daily: Check oil level, inlet filter ŒîP, bearing temps',
      'Weekly: Inspect belt tension (if applicable)',
      'Monthly: Check/change oil per manufacturer schedule',
      'Annually: Professional vibration analysis'
    ],
    warnings: ['Never start with closed discharge - causes surge', 'Hot surfaces - allow cooldown before maintenance'],
    references: 'Manufacturer O&M Manual; WEF MOP 11, Chapter 5'
  },
  dewatering: {
    title: 'Dewatering Operations',
    category: 'Solids Handling',
    steps: [
      'BELT FILTER PRESS:',
      '- Pre-condition sludge with polymer (typical 8-15 lb/DT)',
      '- Adjust belt speed based on solids loading',
      '- Monitor cake dryness - target 18-22% solids',
      '- Wash belts continuously, deep clean at shutdown',
      '- Track polymer usage and cake solids daily',
      'CENTRIFUGE:',
      '- Start per manufacturer sequence',
      '- Adjust scroll speed differential for cake dryness',
      '- Monitor torque and vibration',
      '- Typical cake: 20-28% solids',
      '- Flush before and after each run',
      'Both: Jar test weekly to optimize polymer dose'
    ],
    warnings: ['Rotating equipment hazards - follow LOTO', 'Polymer is slippery - clean spills immediately'],
    references: 'WEF MOP 11, Chapter 16; Equipment O&M Manuals'
  }
};

function showSOP(sopKey) {
  var sop = sopLibrary[sopKey];
  if (!sop) return;

  var html = '<div style="background:var(--bg-section);padding:25px;border-radius:12px">';
  html += '<div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:20px">';
  html += '<div><h3 style="color:#4ade80;margin:0">' + sop.title + '</h3>';
  html += '<span style="background:var(--bg-tabs);padding:4px 12px;border-radius:15px;font-size:12px;margin-top:8px;display:inline-block">' + sop.category + '</span></div>';
  html += '<button onclick="printSOP(\'' + sopKey + '\')" class="btn small blue">üñ®Ô∏è Print</button>';
  html += '</div>';

  html += '<div style="background:var(--bg-tabs);padding:20px;border-radius:8px;margin-bottom:20px">';
  html += '<h4 style="color:#60a5fa;margin:0 0 15px 0">üìã Procedure Steps</h4>';
  html += '<ol style="margin:0;padding-left:25px;line-height:2">';
  sop.steps.forEach(function(step) {
    if (step.includes(':') && !step.includes('mg/L') && !step.includes('gpd')) {
      html += '<li style="font-weight:bold;color:#fbbf24;margin-top:10px">' + step + '</li>';
    } else if (step.startsWith('-')) {
      html += '<li style="list-style:none;margin-left:20px;color:var(--text-secondary)">' + step + '</li>';
    } else {
      html += '<li>' + step + '</li>';
    }
  });
  html += '</ol></div>';

  if (sop.warnings && sop.warnings.length > 0) {
    html += '<div style="background:#7f1d1d;padding:15px;border-radius:8px;margin-bottom:20px">';
    html += '<h4 style="color:#fca5a5;margin:0 0 10px 0">‚ö†Ô∏è Warnings</h4>';
    html += '<ul style="margin:0;padding-left:20px;color:#fecaca">';
    sop.warnings.forEach(function(w) { html += '<li>' + w + '</li>'; });
    html += '</ul></div>';
  }

  html += '<div style="color:var(--text-secondary);font-size:13px"><strong>References:</strong> ' + sop.references + '</div>';
  html += '</div>';

  // Display in Quick Reference modal if open, otherwise fallback
  var qrefDisplay = document.getElementById('qref_sop_display');
  var sopDisplay = document.getElementById('sop_display');

  if (qrefDisplay) {
    qrefDisplay.innerHTML = html;
  }
  if (sopDisplay) {
    sopDisplay.innerHTML = html;
  }
}

function searchSOPs() {
  var query = document.getElementById('sop_search').value.toLowerCase();
  var cards = document.querySelectorAll('.sop-card');
  cards.forEach(function(card) {
    var text = card.textContent.toLowerCase();
    card.style.display = text.includes(query) ? 'block' : 'none';
  });
}

function showAllSOPs() {
  document.getElementById('sop_search').value = '';
  var cards = document.querySelectorAll('.sop-card');
  cards.forEach(function(card) { card.style.display = 'block'; });
}

function printSOP(sopKey) {
  var sop = sopLibrary[sopKey];
  var printWindow = window.open('', '_blank');
  printWindow.document.write('<html><head><title>WWTP Command Center v9.6.0</title>');
  printWindow.document.write('<style>body{font-family:Arial;padding:20px}h1{color:#023e8a}ol{line-height:2}li{margin:5px 0}.warning{background:#fef3c7;padding:10px;border-radius:5px;margin:15px 0}</style>');
  printWindow.document.write('</head><body>');
  printWindow.document.write('<h1>' + sop.title + '</h1>');
  printWindow.document.write('<p><strong>Category:</strong> ' + sop.category + '</p>');
  printWindow.document.write('<h2>Procedure</h2><ol>');
  sop.steps.forEach(function(s) { printWindow.document.write('<li>' + s + '</li>'); });
  printWindow.document.write('</ol>');
  if (sop.warnings) {
    printWindow.document.write('<div class="warning"><h3>‚ö†Ô∏è Warnings</h3><ul>');
    sop.warnings.forEach(function(w) { printWindow.document.write('<li>' + w + '</li>'); });
    printWindow.document.write('</ul></div>');
  }
  printWindow.document.write('<p><strong>References:</strong> ' + sop.references + '</p>');
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
}

// ==================== MASS BALANCE CALCULATOR ====================
function calcMassBalance() {
  var flow = parseFloat(document.getElementById('mb_flow').value) || 5;
  var bodIn = parseFloat(document.getElementById('mb_bod_in').value) || 200;
  var tssIn = parseFloat(document.getElementById('mb_tss_in').value) || 220;
  var tknIn = parseFloat(document.getElementById('mb_tkn_in').value) || 40;
  var tpIn = parseFloat(document.getElementById('mb_tp_in').value) || 7;

  var primBOD = parseFloat(document.getElementById('mb_prim_bod').value) / 100 || 0.30;
  var primTSS = parseFloat(document.getElementById('mb_prim_tss').value) / 100 || 0.60;
  var secBOD = parseFloat(document.getElementById('mb_sec_bod').value) / 100 || 0.90;
  var secTSS = parseFloat(document.getElementById('mb_sec_tss').value) / 100 || 0.85;
  var secTKN = parseFloat(document.getElementById('mb_sec_tkn').value) / 100 || 0.80;
  var tertTP = parseFloat(document.getElementById('mb_tert_tp').value) / 100 || 0.85;
  var tertTSS = parseFloat(document.getElementById('mb_tert_tss').value) / 100 || 0.50;

  var yield_coef = parseFloat(document.getElementById('mb_yield').value) || 0.6;
  var vssTss = parseFloat(document.getElementById('mb_vss_tss').value) || 0.75;
  var primPct = parseFloat(document.getElementById('mb_prim_pct').value) || 4;
  var wasPct = parseFloat(document.getElementById('mb_was_pct').value) || 0.8;

  // Calculate loads (lb/day)
  var conv = flow * 8.34;

  var infBOD = bodIn * conv;
  var infTSS = tssIn * conv;
  var infTKN = tknIn * conv;
  var infTP = tpIn * conv;

  // After primary
  var primEffBOD = bodIn * (1 - primBOD);
  var primEffTSS = tssIn * (1 - primTSS);
  var primSludgeTSS = tssIn * primTSS * conv;

  // After secondary
  var secEffBOD = primEffBOD * (1 - secBOD);
  var secEffTSS = primEffTSS * (1 - secTSS);
  var secEffTKN = tknIn * (1 - secTKN);

  // Biological sludge production
  var bodRemoved = (bodIn - secEffBOD) * conv;
  var bioSludgeVSS = bodRemoved * yield_coef;
  var bioSludgeTSS = bioSludgeVSS / vssTss;

  // After tertiary
  var finalTSS = secEffTSS * (1 - tertTSS);
  var finalTP = tpIn * (1 - tertTP);

  // Sludge volumes
  var primSludgeGPD = primSludgeTSS / (8.34 * (primPct / 100));
  var wasGPD = bioSludgeTSS / (8.34 * (wasPct / 100));

  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 20px 0">‚öñÔ∏è Mass Balance Results</h4>';

  // Summary boxes
  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Influent BOD Load</div>';
  html += '<div style="color:#4ade80;font-size:20px;font-weight:bold">' + infBOD.toFixed(0) + ' lb/d</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Effluent BOD</div>';
  html += '<div style="color:#60a5fa;font-size:20px;font-weight:bold">' + secEffBOD.toFixed(1) + ' mg/L</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">Primary Sludge</div>';
  html += '<div style="color:#ffd166;font-size:20px;font-weight:bold">' + primSludgeGPD.toFixed(0) + ' gpd</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">WAS Production</div>';
  html += '<div style="color:#a78bfa;font-size:20px;font-weight:bold">' + wasGPD.toFixed(0) + ' gpd</div></div>';
  html += '</div>';

  html += '<table class="table"><thead><tr><th>Location</th><th>BOD</th><th>TSS</th><th>TKN</th><th>TP</th></tr></thead><tbody>';
  html += '<tr style="background:#374151"><td><strong>Influent</strong></td>';
  html += '<td>' + bodIn + ' mg/L<br><small>' + infBOD.toFixed(0) + ' lb/d</small></td>';
  html += '<td>' + tssIn + ' mg/L<br><small>' + infTSS.toFixed(0) + ' lb/d</small></td>';
  html += '<td>' + tknIn + ' mg/L<br><small>' + infTKN.toFixed(0) + ' lb/d</small></td>';
  html += '<td>' + tpIn + ' mg/L<br><small>' + infTP.toFixed(0) + ' lb/d</small></td></tr>';

  html += '<tr><td>Primary Effluent</td>';
  html += '<td>' + primEffBOD.toFixed(0) + ' mg/L</td>';
  html += '<td>' + primEffTSS.toFixed(0) + ' mg/L</td>';
  html += '<td>' + tknIn + ' mg/L</td>';
  html += '<td>' + tpIn + ' mg/L</td></tr>';

  html += '<tr><td>Secondary Effluent</td>';
  html += '<td>' + secEffBOD.toFixed(1) + ' mg/L</td>';
  html += '<td>' + secEffTSS.toFixed(1) + ' mg/L</td>';
  html += '<td>' + secEffTKN.toFixed(1) + ' mg/L</td>';
  html += '<td>' + tpIn + ' mg/L</td></tr>';

  html += '<tr style="background:#374151"><td><strong>Final Effluent</strong></td>';
  html += '<td><strong>' + secEffBOD.toFixed(1) + '</strong> mg/L</td>';
  html += '<td><strong>' + finalTSS.toFixed(1) + '</strong> mg/L</td>';
  html += '<td><strong>' + secEffTKN.toFixed(1) + '</strong> mg/L</td>';
  html += '<td><strong>' + finalTP.toFixed(1) + '</strong> mg/L</td></tr>';

  html += '</tbody></table>';

  html += '<div style="margin-top:20px;display:grid;grid-template-columns:1fr 1fr;gap:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px">';
  html += '<h5 style="color:#fbbf24;margin:0 0 10px 0">üî∂ Primary Sludge</h5>';
  html += '<div>TSS Removed: ' + primSludgeTSS.toFixed(0) + ' lb/day</div>';
  html += '<div>Volume @ ' + primPct + '% solids: ' + primSludgeGPD.toFixed(0) + ' gpd</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px">';
  html += '<h5 style="color:#a78bfa;margin:0 0 10px 0">üî∑ Waste Activated Sludge</h5>';
  html += '<div>VSS Produced: ' + bioSludgeVSS.toFixed(0) + ' lb/day</div>';
  html += '<div>TSS Produced: ' + bioSludgeTSS.toFixed(0) + ' lb/day</div>';
  html += '<div>Volume @ ' + wasPct + '% solids: ' + wasGPD.toFixed(0) + ' gpd</div></div>';
  html += '</div></div>';

  document.getElementById('mb_results').innerHTML = html;
  showToast('Mass balance calculated', 'success');
}

function showMassBalanceDiagram() {
  showToast('Process flow diagram - coming soon!', 'info');
}

function resetMassBalance() {
  document.getElementById('mb_flow').value = '5.0';
  document.getElementById('mb_bod_in').value = '200';
  document.getElementById('mb_tss_in').value = '220';
  document.getElementById('mb_results').innerHTML = '';
}

// ==================== OXYGEN TRANSFER EFFICIENCY ====================
function calcOTE() {
  var diffuser = document.getElementById('ote_diffuser').value;
  var sote = parseFloat(document.getElementById('ote_sote').value) || 28;
  var depth = parseFloat(document.getElementById('ote_depth').value) || 15;
  var airflow = parseFloat(document.getElementById('ote_airflow').value) || 3000;
  var numDiff = parseFloat(document.getElementById('ote_num_diff').value) || 500;

  var temp = parseFloat(document.getElementById('ote_temp').value) || 20;
  var doOp = parseFloat(document.getElementById('ote_do').value) || 2;
  var altitude = parseFloat(document.getElementById('ote_altitude').value) || 500;
  var alpha = parseFloat(document.getElementById('ote_alpha').value) || 0.5;
  var beta = parseFloat(document.getElementById('ote_beta').value) || 0.95;
  var fouling = parseFloat(document.getElementById('ote_fouling').value) || 0.9;

  var o2Req = parseFloat(document.getElementById('ote_o2_req').value) || 5000;
  var blowerEff = parseFloat(document.getElementById('ote_blower_eff').value) / 100 || 0.70;
  var motorEff = parseFloat(document.getElementById('ote_motor_eff').value) / 100 || 0.95;
  var elecCost = parseFloat(document.getElementById('ote_elec_cost').value) || 0.10;

  // Saturation DO at temp and altitude
  var csStd = 9.09; // mg/L at 20¬∞C, sea level
  var cs = csStd * Math.exp(-0.0001 * altitude) * (1 - 0.02 * (temp - 20));
  var csMid = cs * (1 + depth / 42); // Mid-depth pressure correction

  // Temperature correction factor
  var theta = Math.pow(1.024, temp - 20);

  // Calculate AOTR from SOTR
  // SOTR = Airflow (SCFM) √ó 0.0173 √ó SOTE √ó depth/15
  var sotr = airflow * 0.0173 * (sote / 100) * (depth / 15); // lb O2/hr
  var sotrDaily = sotr * 24; // lb O2/day

  // AOTR = SOTR √ó alpha √ó F √ó ((beta √ó csMid - doOp) / csStd) √ó theta
  var aotr = sotr * alpha * fouling * ((beta * csMid - doOp) / csStd) * theta;
  var aotrDaily = aotr * 24;

  // Aeration Efficiency (SAE and AE)
  // Power calculation
  var pressurePsi = depth * 0.433 + 1; // gauge + losses
  var bhp = (airflow * pressurePsi) / (17.1 * blowerEff);
  var kw = bhp * 0.746 / motorEff;

  var sae = sotrDaily / (kw * 24); // lb O2/kWh (standard)
  var ae = aotrDaily / (kw * 24); // lb O2/kWh (actual)

  // Air per diffuser
  var airPerDiff = airflow / numDiff;

  // Cost analysis
  var kwhDay = kw * 24;
  var costDay = kwhDay * elecCost;
  var costMonth = costDay * 30;
  var costYear = costDay * 365;
  var costPerLbO2 = costDay / aotrDaily;

  // Check if AOTR meets requirement
  var surplus = aotrDaily - o2Req;
  var meetReq = surplus >= 0;

  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 20px 0">üí® Oxygen Transfer Analysis</h4>';

  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;margin-bottom:20px">';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">SOTR</div>';
  html += '<div style="color:#60a5fa;font-size:20px;font-weight:bold">' + sotrDaily.toFixed(0) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">lb O‚ÇÇ/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">AOTR</div>';
  html += '<div style="color:#4ade80;font-size:20px;font-weight:bold">' + aotrDaily.toFixed(0) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">lb O‚ÇÇ/day</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">SAE</div>';
  html += '<div style="color:#ffd166;font-size:20px;font-weight:bold">' + sae.toFixed(2) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">lb O‚ÇÇ/kWh</div></div>';
  html += '<div style="background:#374151;padding:15px;border-radius:8px;text-align:center">';
  html += '<div style="color:#94a3b8;font-size:12px">AE (Actual)</div>';
  html += '<div style="color:#a78bfa;font-size:20px;font-weight:bold">' + ae.toFixed(2) + '</div>';
  html += '<div style="color:#94a3b8;font-size:11px">lb O‚ÇÇ/kWh</div></div>';
  html += '</div>';

  html += '<table class="table"><tbody>';
  html += '<tr><td>Saturated DO (Cs at ' + temp + '¬∞C)</td><td><strong>' + cs.toFixed(2) + '</strong></td><td>mg/L</td></tr>';
  html += '<tr><td>Mid-depth Cs (pressure corrected)</td><td><strong>' + csMid.toFixed(2) + '</strong></td><td>mg/L</td></tr>';
  html += '<tr><td>Temperature Factor (Œ∏)</td><td><strong>' + theta.toFixed(3) + '</strong></td><td></td></tr>';
  html += '<tr><td>Air per Diffuser</td><td><strong>' + airPerDiff.toFixed(1) + '</strong></td><td>SCFM/diff</td></tr>';
  html += '<tr><td>Blower Power Required</td><td><strong>' + kw.toFixed(1) + '</strong></td><td>kW</td></tr>';
  html += '<tr><td>Daily Energy Use</td><td><strong>' + kwhDay.toFixed(0) + '</strong></td><td>kWh/day</td></tr>';
  html += '</tbody></table>';

  // Oxygen requirement check
  if (meetReq) {
    html += '<div class="note success" style="margin-top:15px">‚úÖ <strong>Oxygen Supply Adequate</strong> - AOTR (' + aotrDaily.toFixed(0) + ' lb/d) exceeds requirement (' + o2Req + ' lb/d) by ' + surplus.toFixed(0) + ' lb/d (' + ((surplus/o2Req)*100).toFixed(0) + '% margin)</div>';
  } else {
    html += '<div class="note warning" style="margin-top:15px">‚ö†Ô∏è <strong>Oxygen Supply Deficit</strong> - AOTR (' + aotrDaily.toFixed(0) + ' lb/d) is ' + Math.abs(surplus).toFixed(0) + ' lb/d SHORT of requirement (' + o2Req + ' lb/d). Increase airflow or add diffusers.</div>';
  }

  // Cost summary
  html += '<div style="background:linear-gradient(135deg,#059669,#06d6a0);padding:15px;border-radius:8px;margin-top:15px;color:white">';
  html += '<h5 style="margin:0 0 10px 0">üí∞ Operating Cost</h5>';
  html += '<div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:10px;text-align:center">';
  html += '<div><div style="opacity:0.9;font-size:11px">Daily</div><strong>$' + costDay.toFixed(0) + '</strong></div>';
  html += '<div><div style="opacity:0.9;font-size:11px">Monthly</div><strong>$' + costMonth.toFixed(0) + '</strong></div>';
  html += '<div><div style="opacity:0.9;font-size:11px">Annual</div><strong>$' + costYear.toLocaleString() + '</strong></div>';
  html += '<div><div style="opacity:0.9;font-size:11px">Per lb O‚ÇÇ</div><strong>$' + costPerLbO2.toFixed(3) + '</strong></div>';
  html += '</div></div>';

  html += '</div>';
  document.getElementById('ote_results').innerHTML = html;
  showToast('OTE calculated', 'success');
}

function compareAerators() {
  showToast('Aerator comparison tool - coming soon!', 'info');
}

function resetOTE() {
  document.getElementById('ote_sote').value = '28';
  document.getElementById('ote_airflow').value = '3000';
  document.getElementById('ote_temp').value = '20';
  document.getElementById('ote_do').value = '2.0';
  document.getElementById('ote_results').innerHTML = '';
}

// Simple OTE Calculator (for quick reference panel)
function calcOTESimple() {
  var airflow = parseFloat(document.getElementById('ote_air').value) || 2000;
  var depth = parseFloat(document.getElementById('ote_depth').value) || 15;
  var oteSTP = parseFloat(document.getElementById('ote_stp').value) || 25;
  var temp = parseFloat(document.getElementById('ote_temp').value) || 20;

  // Temperature correction factor (theta = 1.024)
  var theta = Math.pow(1.024, temp - 20);

  // Depth correction (approx 2% per foot of submergence)
  var depthFactor = 1 + (depth * 0.02);

  // Field OTE
  var fieldOTE = oteSTP * theta * depthFactor;

  // O2 delivered (lb/hr) = Airflow (scfm) √ó 60 √ó 0.075 √ó 0.232 √ó OTE
  var o2Delivered = airflow * 60 * 0.075 * 0.232 * (fieldOTE / 100);

  // Standard Oxygen Transfer Rate (SOTR)
  var sotr = airflow * 60 * 0.075 * 0.232 * (oteSTP / 100);

  document.getElementById('r_ote_field').textContent = fieldOTE.toFixed(1);
  document.getElementById('r_ote_o2').textContent = o2Delivered.toFixed(1);
  document.getElementById('r_ote_sotr').textContent = sotr.toFixed(1);

  showToast('OTE calculated', 'success');
}

function resetOTESimple() {
  document.getElementById('ote_air').value = '2000';
  document.getElementById('ote_depth').value = '15';
  document.getElementById('ote_stp').value = '25';
  document.getElementById('r_ote_field').textContent = '-';
  document.getElementById('r_ote_o2').textContent = '-';
  document.getElementById('r_ote_sotr').textContent = '-';
}

function checkCompliance() {
  var params = ['bod', 'tss', 'nh3', 'ecoli', 'tp'];
  var violations = 0;
  var warnings = 0;

  params.forEach(function(p) {
    var cur = parseFloat(document.getElementById('cur_' + p).value) || 0;
    var daily = parseFloat(document.getElementById('lim_' + p + '_daily').value) || 999;
    var monthly = parseFloat(document.getElementById('lim_' + p + '_monthly').value) || 999;
    var statEl = document.getElementById('stat_' + p);

    if (cur > daily) {
      statEl.innerHTML = '‚ùå VIOLATION';
      statEl.className = 'status bad';
      violations++;
    } else if (cur > monthly * 0.9) {
      statEl.innerHTML = '‚ö†Ô∏è Warning';
      statEl.className = 'status warn';
      warnings++;
    } else {
      statEl.innerHTML = '‚úì OK';
      statEl.className = 'status ok';
    }
  });

  // Check DO (minimum)
  var curDO = parseFloat(document.getElementById('cur_do').value) || 0;
  var minDO = parseFloat(document.getElementById('lim_do_min').value) || 4;
  var statDO = document.getElementById('stat_do');
  if (curDO < minDO) {
    statDO.innerHTML = '‚ùå VIOLATION';
    statDO.className = 'status bad';
    violations++;
  } else if (curDO < minDO * 1.1) {
    statDO.innerHTML = '‚ö†Ô∏è Warning';
    statDO.className = 'status warn';
    warnings++;
  } else {
    statDO.innerHTML = '‚úì OK';
    statDO.className = 'status ok';
  }

  // Check pH (range)
  var curPH = parseFloat(document.getElementById('cur_ph').value) || 7;
  var minPH = parseFloat(document.getElementById('lim_ph_min').value) || 6;
  var maxPH = parseFloat(document.getElementById('lim_ph_max').value) || 9;
  var statPH = document.getElementById('stat_ph');
  if (curPH < minPH || curPH > maxPH) {
    statPH.innerHTML = '‚ùå VIOLATION';
    statPH.className = 'status bad';
    violations++;
  } else {
    statPH.innerHTML = '‚úì OK';
    statPH.className = 'status ok';
  }

  if (violations > 0) {
    showToast('‚ö†Ô∏è ' + violations + ' Permit Violation(s) Detected!', 'error');
  } else if (warnings > 0) {
    showToast('‚ö†Ô∏è ' + warnings + ' Parameter(s) Approaching Limits', 'warning');
  } else {
    showToast('‚úÖ All Parameters In Compliance', 'success');
  }
}

function savePermitInfo() {
  var permitData = {
    permit_num: document.getElementById('tceq_permit_num').value,
    facility: document.getElementById('tceq_facility').value,
    permitted_flow: document.getElementById('tceq_permitted_flow').value,
    eff_date: document.getElementById('tceq_eff_date').value,
    exp_date: document.getElementById('tceq_exp_date').value,
    outfall: document.getElementById('tceq_outfall').value
  };
  localStorage.setItem('tceq_permit_info', JSON.stringify(permitData));
  showToast('Permit info saved!', 'success');
}

function loadPermitInfo() {
  var saved = localStorage.getItem('tceq_permit_info');
  if (saved) {
    var data = JSON.parse(saved);
    document.getElementById('tceq_permit_num').value = data.permit_num || '';
    document.getElementById('tceq_facility').value = data.facility || '';
    document.getElementById('tceq_permitted_flow').value = data.permitted_flow || '';
    document.getElementById('tceq_eff_date').value = data.eff_date || '';
    document.getElementById('tceq_exp_date').value = data.exp_date || '';
    document.getElementById('tceq_outfall').value = data.outfall || '';
    showToast('Permit info loaded!', 'success');
  } else {
    showToast('No saved permit info found', 'warning');
  }
}

function saveLimits() {
  var limits = {};
  var inputs = document.querySelectorAll('#tceq_limits_table input');
  inputs.forEach(function(inp) {
    limits[inp.id] = inp.value;
  });
  localStorage.setItem('tceq_limits', JSON.stringify(limits));
  showToast('Permit limits saved!', 'success');
}

function generateDMRTable() {
  var month = parseInt(document.getElementById('dmr_month').value);
  var year = parseInt(document.getElementById('dmr_year').value);
  var daysInMonth = new Date(year, month, 0).getDate();

  var html = '';
  for (var d = 1; d <= daysInMonth; d++) {
    html += '<tr>';
    html += '<td>' + month + '/' + d + '/' + year + '</td>';
    html += '<td><input type="number" class="dmr-input" step="0.01" style="width:60px"></td>';
    html += '<td><input type="number" class="dmr-input" style="width:60px"></td>';
    html += '<td><input type="number" class="dmr-input" style="width:60px"></td>';
    html += '<td><input type="number" class="dmr-input" step="0.1" style="width:60px"></td>';
    html += '<td><input type="number" class="dmr-input" step="0.1" style="width:60px"></td>';
    html += '<td><input type="number" class="dmr-input" step="0.1" style="width:60px"></td>';
    html += '</tr>';
  }
  document.getElementById('dmr_daily_body').innerHTML = html;
  showToast('DMR table generated for ' + daysInMonth + ' days', 'success');
}

function calculateDMRStats() {
  var rows = document.querySelectorAll('#dmr_daily_body tr');
  var stats = {flow: [], bod: [], tss: [], nh3: [], ph: [], do_val: []};

  rows.forEach(function(row) {
    var inputs = row.querySelectorAll('input');
    if (inputs[0].value) stats.flow.push(parseFloat(inputs[0].value));
    if (inputs[1].value) stats.bod.push(parseFloat(inputs[1].value));
    if (inputs[2].value) stats.tss.push(parseFloat(inputs[2].value));
    if (inputs[3].value) stats.nh3.push(parseFloat(inputs[3].value));
    if (inputs[4].value) stats.ph.push(parseFloat(inputs[4].value));
    if (inputs[5].value) stats.do_val.push(parseFloat(inputs[5].value));
  });

  function calcStats(arr) {
    if (arr.length === 0) return {avg: '-', max: '-', min: '-'};
    var sum = arr.reduce(function(a,b) { return a + b; }, 0);
    return {
      avg: (sum / arr.length).toFixed(2),
      max: Math.max.apply(null, arr).toFixed(2),
      min: Math.min.apply(null, arr).toFixed(2)
    };
  }

  var html = '<div style="background:#1a2744;padding:20px;border-radius:12px">';
  html += '<h4 style="color:#4ade80;margin:0 0 15px 0">üìä DMR Statistics Summary</h4>';
  html += '<table class="table"><thead><tr><th>Parameter</th><th>Average</th><th>Maximum</th><th>Minimum</th><th>Sample Count</th></tr></thead><tbody>';

  var flowStats = calcStats(stats.flow);
  html += '<tr><td>Flow (MGD)</td><td>' + flowStats.avg + '</td><td>' + flowStats.max + '</td><td>' + flowStats.min + '</td><td>' + stats.flow.length + '</td></tr>';

  var bodStats = calcStats(stats.bod);
  html += '<tr><td>BOD (mg/L)</td><td>' + bodStats.avg + '</td><td>' + bodStats.max + '</td><td>' + bodStats.min + '</td><td>' + stats.bod.length + '</td></tr>';

  var tssStats = calcStats(stats.tss);
  html += '<tr><td>TSS (mg/L)</td><td>' + tssStats.avg + '</td><td>' + tssStats.max + '</td><td>' + tssStats.min + '</td><td>' + stats.tss.length + '</td></tr>';

  var nh3Stats = calcStats(stats.nh3);
  html += '<tr><td>NH3-N (mg/L)</td><td>' + nh3Stats.avg + '</td><td>' + nh3Stats.max + '</td><td>' + nh3Stats.min + '</td><td>' + stats.nh3.length + '</td></tr>';

  html += '</tbody></table></div>';
  document.getElementById('dmr_results').innerHTML = html;
  showToast('DMR statistics calculated', 'success');
}

function exportDMR() {
  var rows = document.querySelectorAll('#dmr_daily_body tr');
  var csv = 'Date,Flow (MGD),BOD (mg/L),TSS (mg/L),NH3 (mg/L),pH,DO (mg/L)\n';

  rows.forEach(function(row) {
    var date = row.cells[0].textContent;
    var inputs = row.querySelectorAll('input');
    csv += date + ',' + inputs[0].value + ',' + inputs[1].value + ',' + inputs[2].value + ',' + inputs[3].value + ',' + inputs[4].value + ',' + inputs[5].value + '\n';
  });

  var blob = new Blob([csv], {type: 'text/csv'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'DMR_Data_' + document.getElementById('dmr_month').value + '_' + document.getElementById('dmr_year').value + '.csv';
  a.click();
  showToast('DMR data exported to CSV', 'success');
}

// ==================== CLIENT MANAGEMENT ====================
var clients = JSON.parse(localStorage.getItem('wwtp_clients') || '[]');
var projects = JSON.parse(localStorage.getItem('wwtp_projects') || '[]');

function addClient() {
  var name = document.getElementById('client_name').value;
  if (!name) {
    showToast('Please enter client name', 'error');
    return;
  }

  var client = {
    id: Date.now(),
    name: name,
    contact: document.getElementById('client_contact').value,
    email: document.getElementById('client_email').value,
    phone: document.getElementById('client_phone').value,
    city: document.getElementById('client_city').value,
    type: document.getElementById('client_type').value,
    notes: document.getElementById('client_notes').value,
    created: new Date().toISOString(),
    plants: []
  };

  clients.push(client);
  localStorage.setItem('wwtp_clients', JSON.stringify(clients));
  renderClients();
  clearClientForm();
  updateClientStats();
  showToast('Client added successfully!', 'success');
}

function clearClientForm() {
  document.getElementById('client_name').value = '';
  document.getElementById('client_contact').value = '';
  document.getElementById('client_email').value = '';
  document.getElementById('client_phone').value = '';
  document.getElementById('client_city').value = '';
  document.getElementById('client_type').value = 'municipal';
  document.getElementById('client_notes').value = '';
}

function renderClients() {
  var container = document.getElementById('client_list');
  if (clients.length === 0) {
    container.innerHTML = '<div class="note">No clients added yet. Add your first client above!</div>';
    return;
  }

  var html = '';
  clients.forEach(function(c) {
    html += '<div class="client-card" style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:10px;border-left:4px solid #00b4d8">';
    html += '<div style="display:flex;justify-content:space-between;align-items:start">';
    html += '<div>';
    html += '<strong style="font-size:16px">' + c.name + '</strong>';
    html += '<span style="background:#374151;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:10px">' + c.type.toUpperCase() + '</span>';
    html += '<div style="color:#94a3b8;font-size:14px;margin-top:5px">';
    if (c.contact) html += 'üë§ ' + c.contact + ' &nbsp;';
    if (c.city) html += 'üìç ' + c.city;
    html += '</div>';
    if (c.email) html += '<div style="color:#60a5fa;font-size:13px">‚úâÔ∏è ' + c.email + '</div>';
    if (c.phone) html += '<div style="color:#94a3b8;font-size:13px">üìû ' + c.phone + '</div>';
    html += '</div>';
    html += '<div style="display:flex;gap:5px">';
    html += '<button class="btn small blue" onclick="editClient(' + c.id + ')">Edit</button>';
    html += '<button class="btn small red" onclick="deleteClient(' + c.id + ')">Delete</button>';
    html += '</div></div></div>';
  });
  container.innerHTML = html;
}

function deleteClient(id) {
  if (confirm('Delete this client?')) {
    clients = clients.filter(function(c) { return c.id !== id; });
    localStorage.setItem('wwtp_clients', JSON.stringify(clients));
    renderClients();
    updateClientStats();
    showToast('Client deleted', 'success');
  }
}

function editClient(id) {
  var client = clients.find(function(c) { return c.id === id; });
  if (client) {
    document.getElementById('client_name').value = client.name;
    document.getElementById('client_contact').value = client.contact;
    document.getElementById('client_email').value = client.email;
    document.getElementById('client_phone').value = client.phone;
    document.getElementById('client_city').value = client.city;
    document.getElementById('client_type').value = client.type;
    document.getElementById('client_notes').value = client.notes;
    deleteClient(id);
  }
}

function filterClients() {
  var search = document.getElementById('client_search').value.toLowerCase();
  var filtered = clients.filter(function(c) {
    return c.name.toLowerCase().includes(search) ||
           (c.city && c.city.toLowerCase().includes(search)) ||
           (c.contact && c.contact.toLowerCase().includes(search));
  });

  var container = document.getElementById('client_list');
  if (filtered.length === 0) {
    container.innerHTML = '<div class="note">No clients match your search.</div>';
    return;
  }

  var temp = clients;
  clients = filtered;
  renderClients();
  clients = temp;
}

function exportClients() {
  var csv = 'Name,Contact,Email,Phone,City,Type,Notes,Created\n';
  clients.forEach(function(c) {
    csv += '"' + c.name + '","' + c.contact + '","' + c.email + '","' + c.phone + '","' + c.city + '","' + c.type + '","' + c.notes + '","' + c.created + '"\n';
  });

  var blob = new Blob([csv], {type: 'text/csv'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'clients_export.csv';
  a.click();
  showToast('Clients exported to CSV', 'success');
}

function updateClientStats() {
  document.getElementById('stat_total_clients').textContent = clients.length;
  document.getElementById('stat_active_projects').textContent = projects.filter(function(p) { return p.status === 'active'; }).length;
  document.getElementById('stat_plants_managed').textContent = clients.reduce(function(sum, c) { return sum + (c.plants ? c.plants.length : 0); }, 0);
}

function showAddProjectModal() {
  showToast('Project management coming soon!', 'info');
}

function filterProjects(filter) {
  showToast('Projects filtered: ' + filter, 'info');
}

// ==================== PROPOSAL GENERATOR ====================
function updateProposalTotal() {
  var subtotal = 0;

  var services = ['assessment', 'compliance', 'training', 'energy', 'capacity', 'troubleshoot', 'monthly'];
  services.forEach(function(svc) {
    var checked = document.getElementById('svc_' + svc).checked;
    var price = parseFloat(document.getElementById('price_' + svc).value) || 0;
    if (checked) subtotal += price;
  });

  var discount = parseFloat(document.getElementById('prop_discount').value) || 0;
  var expenses = parseFloat(document.getElementById('prop_expenses').value) || 0;

  var discountAmount = subtotal * (discount / 100);
  var total = subtotal - discountAmount + expenses;

  document.getElementById('prop_subtotal').textContent = '$' + subtotal.toLocaleString('en-US', {minimumFractionDigits: 2});
  document.getElementById('prop_total').textContent = '$' + total.toLocaleString('en-US', {minimumFractionDigits: 2});
}

function generateProposal() {
  var client = document.getElementById('prop_client').value;
  var project = document.getElementById('prop_project').value;

  if (!client || !project) {
    showToast('Please enter client and project name', 'error');
    return;
  }

  var services = [];
  var serviceList = ['assessment', 'compliance', 'training', 'energy', 'capacity', 'troubleshoot', 'monthly'];
  serviceList.forEach(function(svc) {
    if (document.getElementById('svc_' + svc).checked) {
      services.push({
        name: document.querySelector('label[for="svc_' + svc + '"] strong, label:has(#svc_' + svc + ') strong').textContent,
        price: parseFloat(document.getElementById('price_' + svc).value)
      });
    }
  });

  var proposal = {
    id: Date.now(),
    number: document.getElementById('prop_number').value,
    date: document.getElementById('prop_date').value,
    valid_until: document.getElementById('prop_valid').value,
    client: client,
    project: project,
    facility: document.getElementById('prop_facility').value,
    capacity: document.getElementById('prop_capacity').value,
    services: services,
    discount: parseFloat(document.getElementById('prop_discount').value) || 0,
    expenses: parseFloat(document.getElementById('prop_expenses').value) || 0,
    total: document.getElementById('prop_total').textContent,
    created: new Date().toISOString()
  };

  // Generate HTML preview
  var html = '<div style="background:white;color:#1a2744;padding:30px;border-radius:12px;max-height:600px;overflow-y:auto">';
  html += '<div style="text-align:center;margin-bottom:30px">';
  html += '<h1 style="color:#023e8a;margin:0">CONSULTING PROPOSAL</h1>';
  html += '<p style="color:#64748b">Proposal #' + proposal.number + '</p>';
  html += '</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px">';
  html += '<div><strong>Prepared For:</strong><br>' + proposal.client + '<br>' + proposal.facility + '</div>';
  html += '<div style="text-align:right"><strong>Date:</strong> ' + proposal.date + '<br><strong>Valid Until:</strong> ' + proposal.valid_until + '</div>';
  html += '</div>';
  html += '<h3 style="border-bottom:2px solid #023e8a;padding-bottom:10px">Scope of Services</h3>';
  html += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px">';
  services.forEach(function(s) {
    html += '<tr style="border-bottom:1px solid #e0f2fe"><td style="padding:10px">' + s.name + '</td><td style="text-align:right;padding:10px">$' + s.price.toLocaleString() + '</td></tr>';
  });
  html += '</table>';
  html += '<div style="text-align:right;font-size:18px;color:#059669"><strong>Total: ' + proposal.total + '</strong></div>';
  html += '</div>';

  showModal('Generated Proposal', html);
  saveProposalToStorage(proposal);
  showToast('Proposal generated!', 'success');
}

function saveProposalToStorage(proposal) {
  var saved = JSON.parse(localStorage.getItem('wwtp_proposals') || '[]');
  saved.push(proposal);
  localStorage.setItem('wwtp_proposals', JSON.stringify(saved));
  renderSavedProposals();
}

function renderSavedProposals() {
  var saved = JSON.parse(localStorage.getItem('wwtp_proposals') || '[]');
  var container = document.getElementById('saved_proposals');

  if (saved.length === 0) {
    container.innerHTML = '<div class="note">No saved proposals yet.</div>';
    return;
  }

  var html = '';
  saved.slice().reverse().forEach(function(p) {
    html += '<div style="background:#1a2744;padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center">';
    html += '<div>';
    html += '<strong>' + p.number + '</strong> - ' + p.client;
    html += '<div style="color:#94a3b8;font-size:13px">' + p.project + ' | ' + p.total + '</div>';
    html += '</div>';
    html += '<button class="btn small red" onclick="deleteProposal(' + p.id + ')">Delete</button>';
    html += '</div>';
  });
  container.innerHTML = html;
}

function deleteProposal(id) {
  var saved = JSON.parse(localStorage.getItem('wwtp_proposals') || '[]');
  saved = saved.filter(function(p) { return p.id !== id; });
  localStorage.setItem('wwtp_proposals', JSON.stringify(saved));
  renderSavedProposals();
  showToast('Proposal deleted', 'success');
}

function saveProposal() {
  generateProposal();
}

function emailProposal() {
  showToast('Email functionality - integrate with your email service', 'info');
}

function clearProposal() {
  document.getElementById('prop_client').value = '';
  document.getElementById('prop_project').value = '';
  document.getElementById('prop_facility').value = '';
  var services = ['assessment', 'compliance', 'training', 'energy', 'capacity', 'troubleshoot', 'monthly'];
  services.forEach(function(svc) {
    document.getElementById('svc_' + svc).checked = false;
  });
  updateProposalTotal();
}

// ==================== ROI CALCULATOR ====================
function calculateROI() {
  // Current costs (annual)
  var energyCurrent = parseFloat(document.getElementById('roi_energy_current').value) * 12;
  var chemCurrent = parseFloat(document.getElementById('roi_chem_current').value) * 12;
  var sludgeCurrent = parseFloat(document.getElementById('roi_sludge_current').value) * 12;
  var maintCurrent = parseFloat(document.getElementById('roi_maint_current').value) * 12;
  var laborHrsCurrent = parseFloat(document.getElementById('roi_labor_current').value) * 52;
  var finesCurrent = parseFloat(document.getElementById('roi_fines_current').value);
  var laborRate = parseFloat(document.getElementById('roi_labor_rate').value);
  var laborCostCurrent = laborHrsCurrent * laborRate;
  var totalCurrent = energyCurrent + chemCurrent + sludgeCurrent + maintCurrent + laborCostCurrent + finesCurrent;

  // Proposed costs (annual)
  var energyProposed = parseFloat(document.getElementById('roi_energy_proposed').value) * 12;
  var chemProposed = parseFloat(document.getElementById('roi_chem_proposed').value) * 12;
  var sludgeProposed = parseFloat(document.getElementById('roi_sludge_proposed').value) * 12;
  var maintProposed = parseFloat(document.getElementById('roi_maint_proposed').value) * 12;
  var laborHrsProposed = parseFloat(document.getElementById('roi_labor_proposed').value) * 52;
  var finesProposed = parseFloat(document.getElementById('roi_fines_proposed').value);
  var laborCostProposed = laborHrsProposed * laborRate;
  var totalProposed = energyProposed + chemProposed + sludgeProposed + maintProposed + laborCostProposed + finesProposed;

  // Investment
  var consulting = parseFloat(document.getElementById('roi_consulting').value);
  var capital = parseFloat(document.getElementById('roi_capital').value);
  var implementation = parseFloat(document.getElementById('roi_implementation').value);
  var totalInvestment = consulting + capital + implementation;

  // Savings & ROI
  var annualSavings = totalCurrent - totalProposed;
  var paybackMonths = (annualSavings > 0) ? (totalInvestment / annualSavings) * 12 : 0;
  var roiPercent = (annualSavings > 0) ? ((annualSavings / totalInvestment) * 100) : 0;
  var fiveYearSavings = (annualSavings * 5) - totalInvestment;

  // Update displays
  document.getElementById('roi_current_total').textContent = '$' + totalCurrent.toLocaleString();
  document.getElementById('roi_proposed_total').textContent = '$' + totalProposed.toLocaleString();

  // Results HTML
  var html = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px">';

  html += '<div style="background:linear-gradient(135deg,#059669,#06d6a0);padding:20px;border-radius:12px;text-align:center">';
  html += '<div style="font-size:32px;font-weight:bold">$' + annualSavings.toLocaleString() + '</div>';
  html += '<div style="opacity:0.9">Annual Savings</div></div>';

  html += '<div style="background:linear-gradient(135deg,#0077b6,#0077b6);padding:20px;border-radius:12px;text-align:center">';
  html += '<div style="font-size:32px;font-weight:bold">' + paybackMonths.toFixed(1) + '</div>';
  html += '<div style="opacity:0.9">Months to Payback</div></div>';

  html += '<div style="background:linear-gradient(135deg,#0096c7,#48cae4);padding:20px;border-radius:12px;text-align:center">';
  html += '<div style="font-size:32px;font-weight:bold">' + roiPercent.toFixed(0) + '%</div>';
  html += '<div style="opacity:0.9">Annual ROI</div></div>';

  html += '<div style="background:linear-gradient(135deg,#dc2626,#ffd166);padding:20px;border-radius:12px;text-align:center">';
  html += '<div style="font-size:32px;font-weight:bold">$' + fiveYearSavings.toLocaleString() + '</div>';
  html += '<div style="opacity:0.9">5-Year Net Benefit</div></div>';

  html += '</div>';

  // Savings breakdown
  html += '<div style="background:#1a2744;padding:20px;border-radius:12px;margin-top:20px">';
  html += '<h4 style="color:#4ade80;margin:0 0 15px 0">üí∞ Savings Breakdown (Annual)</h4>';
  html += '<table class="table"><tbody>';
  html += '<tr><td>Energy Savings</td><td style="color:#4ade80"><strong>$' + (energyCurrent - energyProposed).toLocaleString() + '</strong></td></tr>';
  html += '<tr><td>Chemical Savings</td><td style="color:#4ade80"><strong>$' + (chemCurrent - chemProposed).toLocaleString() + '</strong></td></tr>';
  html += '<tr><td>Sludge Disposal Savings</td><td style="color:#4ade80"><strong>$' + (sludgeCurrent - sludgeProposed).toLocaleString() + '</strong></td></tr>';
  html += '<tr><td>Maintenance Savings</td><td style="color:#4ade80"><strong>$' + (maintCurrent - maintProposed).toLocaleString() + '</strong></td></tr>';
  html += '<tr><td>Labor Overtime Savings</td><td style="color:#4ade80"><strong>$' + (laborCostCurrent - laborCostProposed).toLocaleString() + '</strong></td></tr>';
  html += '<tr><td>Compliance Fine Avoidance</td><td style="color:#4ade80"><strong>$' + (finesCurrent - finesProposed).toLocaleString() + '</strong></td></tr>';
  html += '</tbody></table></div>';

  document.getElementById('roi_results').innerHTML = html;

  // Update chart
  updateROIChart(energyCurrent - energyProposed, chemCurrent - chemProposed, sludgeCurrent - sludgeProposed, maintCurrent - maintProposed, laborCostCurrent - laborCostProposed, finesCurrent - finesProposed);

  showToast('ROI calculated!', 'success');
}

function updateROIChart(energy, chem, sludge, maint, labor, fines) {
  var ctx = document.getElementById('roiChart');
  if (!ctx) return;

  if (window.roiChartInstance) {
    window.roiChartInstance.destroy();
  }

  window.roiChartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Energy', 'Chemical', 'Sludge', 'Maintenance', 'Labor', 'Fines'],
      datasets: [{
        label: 'Annual Savings ($)',
        data: [energy, chem, sludge, maint, labor, fines],
        backgroundColor: ['#0077b6', '#06d6a0', '#ffd166', '#00b4d8', '#ec4899', '#ef4444']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) { return '$' + value.toLocaleString(); }
          }
        }
      }
    }
  });
}

function resetROI() {
  document.getElementById('roi_energy_current').value = '25000';
  document.getElementById('roi_chem_current').value = '8000';
  document.getElementById('roi_sludge_current').value = '12000';
  document.getElementById('roi_maint_current').value = '5000';
  document.getElementById('roi_labor_current').value = '20';
  document.getElementById('roi_fines_current').value = '5000';
  document.getElementById('roi_energy_proposed').value = '18000';
  document.getElementById('roi_chem_proposed').value = '6500';
  document.getElementById('roi_sludge_proposed').value = '10000';
  document.getElementById('roi_maint_proposed').value = '4000';
  document.getElementById('roi_labor_proposed').value = '8';
  document.getElementById('roi_fines_proposed').value = '0';
  document.getElementById('roi_results').innerHTML = '<div class="note">Enter current and proposed values, then click "Calculate ROI" to see results.</div>';
}

function generateROIReport() {
  showToast('ROI Report generation - coming soon!', 'info');
}

function exportROIData() {
  var data = {
    current: {
      energy: document.getElementById('roi_energy_current').value,
      chemical: document.getElementById('roi_chem_current').value,
      sludge: document.getElementById('roi_sludge_current').value,
      maintenance: document.getElementById('roi_maint_current').value,
      labor_hours: document.getElementById('roi_labor_current').value,
      fines: document.getElementById('roi_fines_current').value
    },
    proposed: {
      energy: document.getElementById('roi_energy_proposed').value,
      chemical: document.getElementById('roi_chem_proposed').value,
      sludge: document.getElementById('roi_sludge_proposed').value,
      maintenance: document.getElementById('roi_maint_proposed').value,
      labor_hours: document.getElementById('roi_labor_proposed').value,
      fines: document.getElementById('roi_fines_proposed').value
    }
  };

  var blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'roi_analysis.json';
  a.click();
  showToast('ROI data exported', 'success');
}

function addToProposal() {
  switchPanel('proposals');
  showToast('Navigate to Proposals tab to include ROI analysis', 'info');
}

function showModal(title, content) {
  var modal = document.createElement('div');
  modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;justify-content:center;align-items:center';
  modal.innerHTML = '<div style="background:#1a2744;padding:30px;border-radius:16px;max-width:800px;width:90%;max-height:90vh;overflow-y:auto"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h3 style="margin:0">' + title + '</h3><button onclick="this.closest(\'div\').parentElement.remove()" style="background:#ef4444;color:white;border:none;padding:8px 16px;border-radius:8px;cursor:pointer">Close</button></div>' + content + '</div>';
  document.body.appendChild(modal);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  renderClients();
  updateClientStats();
  renderSavedProposals();
  updateProposalTotal();

  // Set default dates
  var today = new Date().toISOString().split('T')[0];
  if (document.getElementById('prop_date')) document.getElementById('prop_date').value = today;
  var validDate = new Date();
  validDate.setDate(validDate.getDate() + 30);
  if (document.getElementById('prop_valid')) document.getElementById('prop_valid').value = validDate.toISOString().split('T')[0];
});

</script>

<div id="fab-menu" style="position:fixed;bottom:20px;right:20px;z-index:1000">
<button onclick="document.getElementById('fab-options').style.display=document.getElementById('fab-options').style.display==='none'?'flex':'none'" style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;border:none;font-size:18px;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.3)">‚öôÔ∏è</button>
<div id="fab-options" style="display:none;flex-direction:column;gap:8px;position:absolute;bottom:65px;right:0">
<button onclick="calculateAll();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#06d6a0;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">‚ö° Calculate All</button>
<button onclick="exportResults();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#0077b6;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üì§ Export Results</button>
<button onclick="quickStatus();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#ffd166;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üìä Quick Status</button>
<button onclick="printPanel();document.getElementById('fab-options').style.display='none'" style="padding:10px 16px;border-radius:25px;background:#00b4d8;color:white;border:none;cursor:pointer;white-space:nowrap;box-shadow:0 2px 10px rgba(0,0,0,0.2)">üñ®Ô∏è Print Panel</button>
</div>
</div>

<button id="voiceBtn" class="voice-btn" onclick="toggleVoice()" title="Voice Commands">üé§</button>
<div id="voiceFeedback" class="voice-feedback"></div>

<nav id="mobileNav" class="mobile-bottom-nav">
  <button id="quickNav1" onclick="quickNavClick(0)" class="mobile-nav-btn active">
    <span class="mobile-nav-icon">üìä</span>
    <span class="mobile-nav-label">Dashboard</span>
  </button>
  <button id="quickNav2" onclick="quickNavClick(1)" class="mobile-nav-btn">
    <span class="mobile-nav-icon">‚öôÔ∏è</span>
    <span class="mobile-nav-label">Process</span>
  </button>
  <button id="quickNav3" onclick="quickNavClick(2)" class="mobile-nav-btn">
    <span class="mobile-nav-icon">ü©∫</span>
    <span class="mobile-nav-label">Diagnose</span>
  </button>
  <button onclick="openQuickNavModal()" class="mobile-nav-btn" style="background:linear-gradient(135deg,#f59e0b,#d97706)" title="Customize Quick Nav">
    <span class="mobile-nav-icon">‚úèÔ∏è</span>
    <span class="mobile-nav-label">Edit</span>
  </button>
  <button onclick="toggleMobileMenu()" class="mobile-nav-btn mobile-menu-trigger">
    <span class="mobile-nav-icon">‚ò∞</span>
    <span class="mobile-nav-label">More</span>
  </button>
</nav>

<div id="quickNavModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:100000;padding:20px;overflow-y:auto">
<div style="max-width:400px;margin:20px auto;background:linear-gradient(135deg,#1e3a5f,#2d4a6f);border-radius:16px;padding:20px;border:2px solid #f59e0b">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
<h3 style="margin:0;color:#f59e0b">‚ö° Customize Quick Nav</h3>
<button onclick="closeQuickNavModal()" style="background:#ef4444;border:none;color:white;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:18px">‚úï</button>
</div>
<p style="color:#94a3b8;font-size:14px;margin-bottom:20px">Choose panels for your 3 quick access buttons. Tap a slot to select it, then tap a panel to assign.</p>

<div id="quickNavSlots" style="display:flex;gap:10px;margin-bottom:20px">
<div class="quick-nav-slot" data-slot="0" style="flex:1;background:#374151;padding:15px;border-radius:10px;text-align:center;border:2px solid #4ade80">
<div style="font-size:18px" id="slot0Icon">üìä</div>
<div style="font-size:12px;margin-top:5px" id="slot0Label">Dashboard</div>
</div>
<div class="quick-nav-slot" data-slot="1" style="flex:1;background:#374151;padding:15px;border-radius:10px;text-align:center;border:2px solid #60a5fa">
<div style="font-size:18px" id="slot1Icon">‚öôÔ∏è</div>
<div style="font-size:12px;margin-top:5px" id="slot1Label">Process</div>
</div>
<div class="quick-nav-slot" data-slot="2" style="flex:1;background:#374151;padding:15px;border-radius:10px;text-align:center;border:2px solid #a78bfa">
<div style="font-size:18px" id="slot2Icon">ü©∫</div>
<div style="font-size:12px;margin-top:5px" id="slot2Label">Diagnose</div>
</div>
</div>

<div style="color:#94a3b8;font-size:13px;margin-bottom:10px">Tap a panel to assign it to the selected slot:</div>
<div id="quickNavPanelGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-height:300px;overflow-y:auto">
</div>

<div style="margin-top:20px;display:flex;gap:10px">
<button onclick="saveQuickNav()" class="btn gradient" style="flex:1">üíæ Save</button>
<button onclick="resetQuickNav()" class="btn gray" style="flex:1">üîÑ Reset Default</button>
</div>
</div>
</div>

<div id="mobileMenuOverlay" class="mobile-menu-overlay">
  <div class="mobile-menu-header">
    <h3>üè≠ WWTP Command Center</h3>
    <button onclick="toggleMobileMenu()" class="mobile-menu-close">‚úï</button>
  </div>
  <div class="mobile-menu-grid">
    <button onclick="switchPanel('dashboard');toggleMobileMenu()" class="mobile-menu-item">
      <span>üìä</span><span>Dashboard</span>
    </button>
    <button onclick="switchPanel('daily-ops');toggleMobileMenu()" class="mobile-menu-item">
      <span>üë∑</span><span>Daily Ops</span>
    </button>
    <button onclick="switchPanel('process-control');toggleMobileMenu()" class="mobile-menu-item">
      <span>‚öôÔ∏è</span><span>Process</span>
    </button>
    <button onclick="switchPanel('reactors');toggleMobileMenu()" class="mobile-menu-item">
      <span>üîÑ</span><span>Reactors</span>
    </button>
    <button onclick="switchPanel('hydraulics');toggleMobileMenu()" class="mobile-menu-item">
      <span>üìê</span><span>Hydraulics</span>
    </button>
    <button onclick="switchPanel('aeration');toggleMobileMenu()" class="mobile-menu-item">
      <span>üí®</span><span>Aeration</span>
    </button>
    <button onclick="switchPanel('chemicals');toggleMobileMenu()" class="mobile-menu-item">
      <span>‚öóÔ∏è</span><span>Chemicals</span>
    </button>
    <button onclick="switchPanel('solids');toggleMobileMenu()" class="mobile-menu-item">
      <span>üóëÔ∏è</span><span>Solids</span>
    </button>
    <button onclick="switchPanel('compliance');toggleMobileMenu()" class="mobile-menu-item">
      <span>üî¨</span><span>Lab</span>
    </button>
    <button onclick="switchPanel('compliance');toggleMobileMenu()" class="mobile-menu-item">
      <span>üìã</span><span>Compliance</span>
    </button>
    <button onclick="switchPanel('wizards');toggleMobileMenu()" class="mobile-menu-item">
      <span>ü©∫</span><span>Diagnostics</span>
    </button>
    <button onclick="switchPanel('wizards');toggleMobileMenu()" class="mobile-menu-item">
      <span>üß≠</span><span>Wizards</span>
    </button>
    <button onclick="switchPanel('maintenance');toggleMobileMenu()" class="mobile-menu-item">
      <span>üîß</span><span>Maintenance</span>
    </button>
    <button onclick="switchPanel('reports');toggleMobileMenu()" class="mobile-menu-item">
      <span>üìë</span><span>Reports</span>
    </button>
    <button onclick="switchPanel('profiles');toggleMobileMenu()" class="mobile-menu-item">
      <span>üè≠</span><span>Profiles</span>
    </button>
    <button onclick="switchPanel('business');toggleMobileMenu()" class="mobile-menu-item">
      <span>üíº</span><span>Business</span>
    </button>
    <button onclick="switchPanel('multiplant');toggleMobileMenu()" class="mobile-menu-item">
      <span>üè≠</span><span>Multi-Plant</span>
    </button>
  </div>
  <div style="padding:15px;border-top:1px solid #374151;margin-top:10px">
    <button onclick="toggleMobileMenu();openQuickNavModal()" style="width:100%;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;padding:15px;border-radius:10px;color:white;font-weight:bold;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px">
      <span>‚ö°</span> Customize Quick Nav Buttons
    </button>
  </div>
</div>

<style>
/* Mobile Bottom Navigation Bar */
.mobile-bottom-nav{
  display:none;
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:linear-gradient(to top,#0c1929,#1a2744);
  border-top:1px solid #023e8a;
  padding:8px 0 calc(8px + env(safe-area-inset-bottom));
  z-index:1000;
  justify-content:space-around;
  align-items:center;
  box-shadow:0 -4px 20px rgba(30,58,138,0.4)
}

.mobile-nav-btn{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  background:none;
  border:none;
  color:#94a3b8;
  padding:8px 16px;
  cursor:pointer;
  transition:all 0.2s;
  border-radius:12px
}

.mobile-nav-btn.active,.mobile-nav-btn:active{
  color:#90e0ef;
  background:rgba(99,102,241,0.2)
}

.mobile-nav-icon{font-size:22px}
.mobile-nav-label{font-size:10px;font-weight:600}

/* Mobile Menu Overlay */
.mobile-menu-overlay{
  display:none;
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(15,23,42,0.98);
  z-index:2000;
  flex-direction:column;
  animation:fadeIn 0.2s
}

.mobile-menu-overlay.active{display:flex}

.mobile-menu-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px;
  border-bottom:1px solid #023e8a
}

.mobile-menu-header h3{
  color:#90e0ef;
  font-size:18px;
  margin:0
}

.mobile-menu-close{
  background:none;
  border:none;
  color:#94a3b8;
  font-size:18px;
  cursor:pointer;
  padding:8px;
  border-radius:8px
}

.mobile-menu-close:hover{background:#243b55}

.mobile-menu-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
  padding:20px;
  overflow-y:auto;
  flex:1
}

.mobile-menu-item{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
  padding:20px 12px;
  background:#1a2744;
  border:1px solid #475569;
  border-radius:12px;
  color:#e0f2fe;
  cursor:pointer;
  transition:all 0.2s
}

.mobile-menu-item:active{
  background:#023e8a;
  transform:scale(0.95)
}

.mobile-menu-item span:first-child{font-size:20px}
.mobile-menu-item span:last-child{font-size:11px;font-weight:600;text-align:center}

/* Show mobile nav on small screens */
@media(max-width:767px){
  .mobile-bottom-nav{display:flex}
  .tabs{display:none}
  .voice-btn{bottom:90px}
  .panel{padding-bottom:100px}
}

/* Tablet: show tabs, hide mobile nav */
@media(min-width:768px){
  .mobile-bottom-nav{display:none !important}
  .mobile-menu-overlay{display:none !important}
}
</style>

<script>
// Mobile menu toggle
function toggleMobileMenu() {
  var overlay = document.getElementById('mobileMenuOverlay');
  overlay.classList.toggle('active');
  document.body.style.overflow = overlay.classList.contains('active') ? 'hidden' : '';
}

// ========== CUSTOMIZABLE QUICK NAV ==========
var quickNavPanels = [
  { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
  { id: 'daily-ops', icon: 'üë∑', label: 'Daily Ops' },
  { id: 'process-control', icon: '‚öôÔ∏è', label: 'Process' },
  { id: 'reactors', icon: 'üîÑ', label: 'Reactors' },
  { id: 'hydraulics', icon: 'üìê', label: 'Hydraulics' },
  { id: 'aeration', icon: 'üí®', label: 'Aeration' },
  { id: 'chemicals', icon: '‚öóÔ∏è', label: 'Chemicals' },
  { id: 'solids', icon: 'üóëÔ∏è', label: 'Solids' },
  { id: 'compliance', icon: 'üìã', label: 'Compliance' },
  { id: 'wizards', icon: 'ü©∫', label: 'Diagnose' },
  { id: 'maintenance', icon: 'üîß', label: 'Maintenance' },
  { id: 'reports', icon: 'üìë', label: 'Reports' },
  { id: 'profiles', icon: 'üè≠', label: 'Profiles' },
  { id: 'business', icon: 'üíº', label: 'Business' },
  { id: 'multiplant', icon: 'üåê', label: 'Multi-Plant' }
];

var quickNavConfig = [
  { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
  { id: 'process-control', icon: '‚öôÔ∏è', label: 'Process' },
  { id: 'wizards', icon: 'ü©∫', label: 'Diagnose' }
];

var selectedQuickNavSlot = 0;

function initQuickNav() {
  // Load saved config
  var saved = localStorage.getItem('wwtp_quick_nav');
  if (saved) {
    try {
      quickNavConfig = JSON.parse(saved);
    } catch(e) {}
  }
  updateQuickNavButtons();
}

function updateQuickNavButtons() {
  for (var i = 0; i < 3; i++) {
    var btn = document.getElementById('quickNav' + (i + 1));
    if (btn && quickNavConfig[i]) {
      btn.querySelector('.mobile-nav-icon').textContent = quickNavConfig[i].icon;
      btn.querySelector('.mobile-nav-label').textContent = quickNavConfig[i].label;
      btn.setAttribute('data-panel', quickNavConfig[i].id);
    }
  }
}

function quickNavClick(index) {
  if (quickNavConfig[index]) {
    switchPanel(quickNavConfig[index].id);
    // Update active state
    var btns = document.querySelectorAll('.mobile-nav-btn');
    btns.forEach(function(b, i) {
      b.classList.toggle('active', i === index);
    });
  }
}

function openQuickNavModal() {
  selectedQuickNavSlot = 0;
  updateQuickNavModalSlots();
  buildQuickNavPanelGrid();
  document.getElementById('quickNavModal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeQuickNavModal() {
  document.getElementById('quickNavModal').style.display = 'none';
  document.body.style.overflow = '';
}

function updateQuickNavModalSlots() {
  for (var i = 0; i < 3; i++) {
    document.getElementById('slot' + i + 'Icon').textContent = quickNavConfig[i].icon;
    document.getElementById('slot' + i + 'Label').textContent = quickNavConfig[i].label;

    // Highlight selected slot
    var slot = document.querySelectorAll('.quick-nav-slot')[i];
    if (slot) {
      slot.style.borderColor = (i === selectedQuickNavSlot) ? '#f59e0b' : ['#4ade80', '#60a5fa', '#a78bfa'][i];
      slot.style.transform = (i === selectedQuickNavSlot) ? 'scale(1.05)' : 'scale(1)';
    }
  }
}

function buildQuickNavPanelGrid() {
  var html = '';
  quickNavPanels.forEach(function(panel) {
    var isSelected = quickNavConfig.some(function(c) { return c.id === panel.id; });
    html += '<button onclick="selectQuickNavPanel(\'' + panel.id + '\')" style="background:' + (isSelected ? '#059669' : '#374151') + ';border:none;padding:12px 8px;border-radius:8px;cursor:pointer;text-align:center">';
    html += '<div style="font-size:20px">' + panel.icon + '</div>';
    html += '<div style="font-size:10px;color:white;margin-top:4px">' + panel.label + '</div>';
    html += '</button>';
  });
  document.getElementById('quickNavPanelGrid').innerHTML = html;

  // Add slot click handlers
  document.querySelectorAll('.quick-nav-slot').forEach(function(slot, i) {
    slot.onclick = function() {
      selectedQuickNavSlot = i;
      updateQuickNavModalSlots();
    };
  });
}

function selectQuickNavPanel(panelId) {
  var panel = quickNavPanels.find(function(p) { return p.id === panelId; });
  if (panel) {
    quickNavConfig[selectedQuickNavSlot] = { id: panel.id, icon: panel.icon, label: panel.label };
    updateQuickNavModalSlots();
    buildQuickNavPanelGrid();

    // Auto-advance to next slot
    if (selectedQuickNavSlot < 2) {
      selectedQuickNavSlot++;
      updateQuickNavModalSlots();
    }
  }
}

function saveQuickNav() {
  localStorage.setItem('wwtp_quick_nav', JSON.stringify(quickNavConfig));
  updateQuickNavButtons();
  closeQuickNavModal();
  showToast('‚ö° Quick Nav saved!', 'success');
}

function resetQuickNav() {
  quickNavConfig = [
    { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
    { id: 'process-control', icon: '‚öôÔ∏è', label: 'Process' },
    { id: 'wizards', icon: 'ü©∫', label: 'Diagnose' }
  ];
  updateQuickNavModalSlots();
  buildQuickNavPanelGrid();
}

// Initialize quick nav on load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initQuickNav, 500);
});
// ========== END CUSTOMIZABLE QUICK NAV ==========

// Update mobile nav active state - DISABLED FOR DEBUGGING
// // DISABLED: var originalSwitchPanel = window.switchPanel;
// window.switchPanel = function(panelId) {
//   originalSwitchPanel(panelId);
//
//   // Update mobile bottom nav
//   var mobileNavBtns = document.querySelectorAll('.mobile-nav-btn[data-panel]');
//   mobileNavBtns.forEach(function(btn) {
//     btn.classList.toggle('active', btn.dataset.panel === panelId);
//   });
// };

// Swipe gesture support for tabs
(function() {
  var startX, startY, distX, distY;
  var threshold = 100;
  var restraint = 100;
  var panels = ['dashboard','daily-ops','process-control','reactors','hydraulics','aeration','chemicals','solids','compliance','maintenance','reports','business','multiplant'];

  document.addEventListener('touchstart', function(e) {
    var touch = e.changedTouches[0];
    startX = touch.pageX;
    startY = touch.pageY;
  }, {passive: true});

  document.addEventListener('touchend', function(e) {
    var touch = e.changedTouches[0];
    distX = touch.pageX - startX;
    distY = touch.pageY - startY;

    if (Math.abs(distX) >= threshold && Math.abs(distY) <= restraint) {
      var currentPanel = document.querySelector('.panel.active');
      if (!currentPanel) return;

      var currentId = currentPanel.id;
      var currentIndex = panels.indexOf(currentId);
      if (currentIndex === -1) return;

      var newIndex;
      if (distX > 0) {
        // Swipe right - go to previous
        newIndex = currentIndex > 0 ? currentIndex - 1 : panels.length - 1;
      } else {
        // Swipe left - go to next
        newIndex = currentIndex < panels.length - 1 ? currentIndex + 1 : 0;
      }

      switchPanel(panels[newIndex]);
    }
  }, {passive: true});
})();

// Viewport height fix for mobile browsers
function setVH() {
  var vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', vh + 'px');
}
setVH();
window.addEventListener('resize', setVH);
</script>

<div id="unitConverterWidget" style="display:none;position:fixed;bottom:100px;right:20px;width:320px;background:linear-gradient(135deg,#1a2744,#0c1929);border:2px solid #023e8a;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,0.5);z-index:1500;overflow:hidden">
  <div style="background:linear-gradient(135deg,#0077b6,#00b4d8);padding:12px 16px;display:flex;justify-content:space-between;align-items:center">
    <span style="color:white;font-weight:bold;font-size:14px">üîÑ Unit Converter</span>
    <button onclick="toggleUnitConverter()" style="background:none;border:none;color:white;font-size:20px;cursor:pointer">√ó</button>
  </div>
  <div style="padding:16px">
    <select id="ucType" onchange="updateUnitConverter()" style="width:100%;padding:10px;border-radius:8px;border:1px solid #475569;background:#1a2744;color:#e0f2fe;margin-bottom:12px;font-size:14px">
      <option value="flow">Flow: MGD ‚Üî GPM ‚Üî m¬≥/day</option>
      <option value="mass">Mass Load: mg/L ‚Üî lb/day</option>
      <option value="temp">Temperature: ¬∞C ‚Üî ¬∞F</option>
      <option value="pressure">Pressure: PSI ‚Üî ft H‚ÇÇO ‚Üî kPa</option>
      <option value="length">Length: ft ‚Üî m ‚Üî in</option>
      <option value="volume">Volume: gal ‚Üî L ‚Üî ft¬≥</option>
      <option value="conc">Concentration: mg/L ‚Üî % ‚Üî lb/MG</option>
    </select>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
      <input type="number" id="ucInput" value="1" step="any" oninput="convertUnits()" style="flex:1;padding:10px;border-radius:8px;border:1px solid #475569;background:#0c1929;color:#4ade80;font-size:16px;font-weight:bold">
      <select id="ucFrom" onchange="convertUnits()" style="flex:1;padding:10px;border-radius:8px;border:1px solid #475569;background:#1a2744;color:#e0f2fe;font-size:12px"></select>
    </div>
    <div style="text-align:center;color:#64748b;margin:8px 0">‚¨áÔ∏è</div>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="text" id="ucOutput" readonly style="flex:1;padding:10px;border-radius:8px;border:1px solid #023e8a;background:#023e8a;color:#90e0ef;font-size:16px;font-weight:bold;text-align:center">
      <select id="ucTo" onchange="convertUnits()" style="flex:1;padding:10px;border-radius:8px;border:1px solid #475569;background:#1a2744;color:#e0f2fe;font-size:12px"></select>
    </div>
    <div id="ucFormula" style="margin-top:12px;padding:10px;background:#0c1929;border-radius:8px;color:#94a3b8;font-size:11px;text-align:center"></div>
  </div>
</div>

<div id="fabMenu" style="position:fixed;bottom:20px;right:20px;z-index:1400;display:flex;flex-direction:column;align-items:flex-end;gap:10px">
  <button id="fabUnitConv" onclick="toggleUnitConverter()" title="Unit Converter" style="display:none;width:50px;height:50px;border-radius:50%;border:none;background:linear-gradient(135deg,#0077b6,#00b4d8);color:white;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(59,130,246,0.4);transition:transform 0.2s">üîÑ</button>
  <button id="fabPDF" onclick="exportToPDF()" title="Export to PDF" style="display:none;width:50px;height:50px;border-radius:50%;border:none;background:linear-gradient(135deg,#ef4444,#dc2626);color:white;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(239,68,68,0.4);transition:transform 0.2s">üìÑ</button>
  <button id="fabTheme" onclick="toggleThemeWithMemory()" title="Toggle Dark/Light" style="display:none;width:50px;height:50px;border-radius:50%;border:none;background:linear-gradient(135deg,#ffd166,#d97706);color:white;font-size:20px;cursor:pointer;box-shadow:0 4px 15px rgba(245,158,11,0.4);transition:transform 0.2s">üåì</button>
  <button id="fabMain" onclick="toggleFabMenu()" style="width:60px;height:60px;border-radius:50%;border:none;background:linear-gradient(135deg,#00b4d8,#0096c7);color:white;font-size:18px;cursor:pointer;box-shadow:0 6px 20px rgba(139,92,246,0.5);transition:transform 0.3s">‚ö°</button>
</div>

<div id="offlineIndicator" style="display:none;position:fixed;top:0;left:0;right:0;background:linear-gradient(90deg,#ffd166,#d97706);color:white;text-align:center;padding:8px;font-size:13px;font-weight:600;z-index:2000">
  üì¥ Offline Mode - Data saved locally
</div>

<div id="pdfModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:2000;justify-content:center;align-items:center">
  <div style="background:#1a2744;border-radius:16px;padding:24px;max-width:400px;width:90%;border:2px solid #023e8a">
    <h3 style="color:#90e0ef;margin:0 0 16px 0;font-size:18px">üìÑ Export to PDF</h3>
    <div style="margin-bottom:16px">
      <label style="color:#94a3b8;font-size:13px;display:block;margin-bottom:6px">Report Title</label>
      <input type="text" id="pdfTitle" value="WWTP Analysis Report" style="width:100%;padding:10px;border-radius:8px;border:1px solid #475569;background:#0c1929;color:#e0f2fe;box-sizing:border-box">
    </div>
    <div style="margin-bottom:16px">
      <label style="color:#94a3b8;font-size:13px;display:block;margin-bottom:6px">Include Sections</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <label style="color:#e0f2fe;font-size:12px;display:flex;align-items:center;gap:6px"><input type="checkbox" id="pdfCalcs" checked> Calculations</label>
        <label style="color:#e0f2fe;font-size:12px;display:flex;align-items:center;gap:6px"><input type="checkbox" id="pdfKPIs" checked> KPI Summary</label>
        <label style="color:#e0f2fe;font-size:12px;display:flex;align-items:center;gap:6px"><input type="checkbox" id="pdfTimestamp" checked> Timestamp</label>
        <label style="color:#e0f2fe;font-size:12px;display:flex;align-items:center;gap:6px"><input type="checkbox" id="pdfNotes"> Notes</label>
      </div>
    </div>
    <div style="margin-bottom:16px" id="pdfNotesSection" style="display:none">
      <label style="color:#94a3b8;font-size:13px;display:block;margin-bottom:6px">Notes</label>
      <textarea id="pdfNotesText" rows="3" style="width:100%;padding:10px;border-radius:8px;border:1px solid #475569;background:#0c1929;color:#e0f2fe;resize:none;box-sizing:border-box" placeholder="Add notes to include in report..."></textarea>
    </div>
    <div style="display:flex;gap:10px">
      <button onclick="generatePDF()" style="flex:1;padding:12px;border-radius:8px;border:none;background:linear-gradient(135deg,#0077b6,#00b4d8);color:white;font-weight:600;cursor:pointer">üìÑ Generate PDF</button>
      <button onclick="closePDFModal()" style="padding:12px 20px;border-radius:8px;border:1px solid #475569;background:transparent;color:#94a3b8;cursor:pointer">Cancel</button>
    </div>
  </div>
</div>

<script>
// ==================== 1. DATA PERSISTENCE ====================
const STORAGE_KEY = 'wwtp_v7_data';
const PREFS_KEY = 'wwtp_v7_prefs';

// Save all input values
function saveAllData() {
  const data = {};
  document.querySelectorAll('input[id], select[id]').forEach(el => {
    if (el.type === 'checkbox') {
      data[el.id] = el.checked;
    } else if (el.type !== 'button' && el.type !== 'submit') {
      data[el.id] = el.value;
    }
  });
  data._timestamp = new Date().toISOString();
  data._version = 'v8.0.0';
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

// Load all saved data
function loadAllData() {
  try {
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (!data) return;
    let count = 0;
    Object.keys(data).forEach(id => {
      if (id.startsWith('_')) return;
      const el = document.getElementById(id);
      if (el) {
        if (el.type === 'checkbox') {
          el.checked = data[id];
        } else {
          el.value = data[id];
        }
        count++;
      }
    });
    showToast('üìÇ Previous data restored', 'info');
  } catch (e) {
  }
}

// Auto-save on input change
function initAutoSave() {
  document.addEventListener('change', (e) => {
    if (e.target.matches('input, select')) {
      saveAllData();
    }
  });
  document.addEventListener('input', debounce((e) => {
    if (e.target.matches('input[type="number"], input[type="text"], textarea')) {
      saveAllData();
    }
  }, 1000));
}

function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

// ==================== 2. DARK/LIGHT TOGGLE WITH MEMORY ====================
function toggleThemeWithMemory() {
  const html = document.documentElement;
  const isCurrentlyDark = html.classList.contains('dark');

  // Add transition class for smooth animation
  document.body.style.transition = 'background 0.5s ease';

  if (isCurrentlyDark) {
    html.classList.remove('dark');
    localStorage.setItem('theme', 'light');
    showToast('‚òÄÔ∏è Light mode activated', 'info');
  } else {
    html.classList.add('dark');
    localStorage.setItem('theme', 'dark');
    showToast('üåô Dark mode activated', 'info');
  }

  updateThemeIcon();
  updateThemeButtonStyle();
}

function loadThemePreference() {
  const saved = localStorage.getItem('theme');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

  if (saved === 'light') {
    document.documentElement.classList.remove('dark');
  } else if (saved === 'dark' || prefersDark) {
    document.documentElement.classList.add('dark');
  }

  updateThemeIcon();
  updateThemeButtonStyle();
}

function updateThemeIcon() {
  const isDark = document.documentElement.classList.contains('dark');

  // Update FAB button
  const fabBtn = document.getElementById('fabTheme');
  if (fabBtn) {
    fabBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    fabBtn.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
  }

  // Update header button
  const headerBtn = document.getElementById('themeBtn');
  if (headerBtn) {
    headerBtn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    headerBtn.title = isDark ? 'Switch to Light Mode' : 'Switch to Dark Mode';
  }
}

function updateThemeButtonStyle() {
  const isDark = document.documentElement.classList.contains('dark');
  const headerBtn = document.getElementById('themeBtn');

  if (headerBtn) {
    if (isDark) {
      headerBtn.style.background = 'linear-gradient(135deg, #3b82f6, #1d4ed8)';
    } else {
      headerBtn.style.background = 'linear-gradient(135deg, #fbbf24, #f59e0b)';
    }
  }
}

// Listen for system theme changes
if (window.matchMedia) {
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
    if (!localStorage.getItem('theme')) {
      if (e.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
      updateThemeIcon();
      updateThemeButtonStyle();
    }
  });
}

// ==================== 3. UNIT CONVERTER ====================
const unitConfigs = {
  flow: {
    units: ['MGD', 'GPM', 'GPD', 'm¬≥/day', 'L/s'],
    conversions: {
      'MGD': 1,
      'GPM': 694.44,
      'GPD': 1000000,
      'm¬≥/day': 3785.41,
      'L/s': 43.8126
    }
  },
  mass: {
    units: ['lb/day', 'kg/day', 'mg/L√óMGD'],
    conversions: {
      'lb/day': 1,
      'kg/day': 0.453592,
      'mg/L√óMGD': 0.1198 // approximate, needs flow
    },
    note: 'lb/day = mg/L √ó MGD √ó 8.34'
  },
  temp: {
    units: ['¬∞C', '¬∞F', 'K'],
    special: true
  },
  pressure: {
    units: ['PSI', 'ft H‚ÇÇO', 'kPa', 'bar', 'atm'],
    conversions: {
      'PSI': 1,
      'ft H‚ÇÇO': 2.31,
      'kPa': 6.89476,
      'bar': 0.0689476,
      'atm': 0.068046
    }
  },
  length: {
    units: ['ft', 'm', 'in', 'cm'],
    conversions: {
      'ft': 1,
      'm': 0.3048,
      'in': 12,
      'cm': 30.48
    }
  },
  volume: {
    units: ['gal', 'L', 'ft¬≥', 'm¬≥', 'MG'],
    conversions: {
      'gal': 1,
      'L': 3.78541,
      'ft¬≥': 0.133681,
      'm¬≥': 0.00378541,
      'MG': 0.000001
    }
  },
  conc: {
    units: ['mg/L', 'ppm', '%', 'lb/MG', 'g/L'],
    conversions: {
      'mg/L': 1,
      'ppm': 1,
      '%': 0.0001,
      'lb/MG': 8.34,
      'g/L': 0.001
    }
  }
};

function toggleUnitConverter() {
  const widget = document.getElementById('unitConverterWidget');
  widget.style.display = widget.style.display === 'none' ? 'block' : 'none';
  if (widget.style.display === 'block') updateUnitConverter();
}

function updateUnitConverter() {
  const type = document.getElementById('ucType').value;
  const config = unitConfigs[type];
  const fromSelect = document.getElementById('ucFrom');
  const toSelect = document.getElementById('ucTo');

  fromSelect.innerHTML = config.units.map((u, i) => `<option value="${u}" ${i===0?'selected':''}>${u}</option>`).join('');
  toSelect.innerHTML = config.units.map((u, i) => `<option value="${u}" ${i===1?'selected':''}>${u}</option>`).join('');

  convertUnits();
}

function convertUnits() {
  const type = document.getElementById('ucType').value;
  const config = unitConfigs[type];
  const input = parseFloat(document.getElementById('ucInput').value) || 0;
  const from = document.getElementById('ucFrom').value;
  const to = document.getElementById('ucTo').value;
  let result;
  let formula = '';

  if (type === 'temp') {
    // Temperature special handling
    if (from === '¬∞C' && to === '¬∞F') {
      result = (input * 9/5) + 32;
      formula = '¬∞F = (¬∞C √ó 9/5) + 32';
    } else if (from === '¬∞F' && to === '¬∞C') {
      result = (input - 32) * 5/9;
      formula = '¬∞C = (¬∞F - 32) √ó 5/9';
    } else if (from === '¬∞C' && to === 'K') {
      result = input + 273.15;
      formula = 'K = ¬∞C + 273.15';
    } else if (from === 'K' && to === '¬∞C') {
      result = input - 273.15;
      formula = '¬∞C = K - 273.15';
    } else if (from === '¬∞F' && to === 'K') {
      result = (input - 32) * 5/9 + 273.15;
      formula = 'K = (¬∞F - 32) √ó 5/9 + 273.15';
    } else if (from === 'K' && to === '¬∞F') {
      result = (input - 273.15) * 9/5 + 32;
      formula = '¬∞F = (K - 273.15) √ó 9/5 + 32';
    } else {
      result = input;
      formula = 'Same unit';
    }
  } else {
    // Standard conversion
    const baseValue = input / config.conversions[from];
    result = baseValue * config.conversions[to];
    formula = `${from} ‚Üí base ‚Üí ${to}`;
  }

  document.getElementById('ucOutput').value = result.toPrecision(6);
  document.getElementById('ucFormula').textContent = formula + (config.note ? ' | ' + config.note : '');
}

// ==================== 4. PDF EXPORT ====================
function exportToPDF() {
  document.getElementById('pdfModal').style.display = 'flex';
}

function closePDFModal() {
  document.getElementById('pdfModal').style.display = 'none';
}

function generatePDF() {
  const title = document.getElementById('pdfTitle').value || 'WWTP Report';
  const includeCalcs = document.getElementById('pdfCalcs').checked;
  const includeKPIs = document.getElementById('pdfKPIs').checked;
  const includeTimestamp = document.getElementById('pdfTimestamp').checked;
  const includeNotes = document.getElementById('pdfNotes').checked;
  const notes = document.getElementById('pdfNotesText').value;

  // Collect current panel data
  const activePanel = document.querySelector('.panel.active') || document.querySelector('.panel');
  const panelName = activePanel ? activePanel.id : 'Dashboard';

  // Collect all results from active panel
  const results = [];
  if (activePanel && includeCalcs) {
    activePanel.querySelectorAll('.result, [id^="r_"]').forEach(el => {
      const value = el.textContent.trim();
      if (value && value !== '-') {
        const row = el.closest('tr');
        const label = row ? row.querySelector('.rowh, td:first-child')?.textContent : el.id;
        const unit = row ? row.querySelector('td:last-child')?.textContent : '';
        results.push({ label: label || el.id, value, unit: unit || '' });
      }
    });
  }

  // Collect KPIs
  const kpis = [];
  if (includeKPIs) {
    document.querySelectorAll('.kpi-card').forEach(card => {
      const label = card.querySelector('h4')?.textContent || '';
      const value = card.querySelector('p')?.textContent || '';
      if (value && value !== '-') {
        kpis.push({ label, value });
      }
    });
  }

  // Generate HTML for print
  const printContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>WWTP Command Center v9.6.0</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 40px; color: #1a2744; }
        h1 { color: #023e8a; border-bottom: 3px solid #0077b6; padding-bottom: 10px; }
        h2 { color: #0077b6; margin-top: 30px; }
        .meta { color: #64748b; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #e0f2fe; padding: 10px; text-align: left; }
        th { background: #f0f9ff; color: #475569; }
        .value { font-weight: bold; color: #023e8a; }
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .kpi { background: #f8fafc; border: 1px solid #e0f2fe; border-radius: 8px; padding: 15px; text-align: center; }
        .kpi-label { font-size: 12px; color: #64748b; }
        .kpi-value { font-size: 24px; font-weight: bold; color: #023e8a; }
        .notes { background: #fefce8; border-left: 4px solid #ffd166; padding: 15px; margin: 20px 0; }
        .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #e0f2fe; color: #94a3b8; font-size: 12px; }
        @media print { body { padding: 20px; } }
      </style>
    </head>
    <body>
      <h1>üìä ${title}</h1>
      <div class="meta">
        <strong>Panel:</strong> ${panelName.charAt(0).toUpperCase() + panelName.slice(1).replace(/-/g, ' ')}<br>
        ${includeTimestamp ? `<strong>Generated:</strong> ${new Date().toLocaleString()}<br>` : ''}
        <strong>App Version:</strong> v9.6.0
      </div>

      ${kpis.length > 0 ? `
        <h2>üìà Key Performance Indicators</h2>
        <div class="kpi-grid">
          ${kpis.slice(0, 8).map(k => `
            <div class="kpi">
              <div class="kpi-label">${k.label}</div>
              <div class="kpi-value">${k.value}</div>
            </div>
          `).join('')}
        </div>
      ` : ''}

      ${results.length > 0 ? `
        <h2>üî¨ Calculation Results</h2>
        <table>
          <thead>
            <tr><th>Parameter</th><th>Value</th><th>Unit</th></tr>
          </thead>
          <tbody>
            ${results.map(r => `
              <tr>
                <td>${r.label}</td>
                <td class="value">${r.value}</td>
                <td>${r.unit}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      ` : '<p>No calculation results to display. Run calculations first.</p>'}

      ${includeNotes && notes ? `
        <h2>üìù Notes</h2>
        <div class="notes">${notes.replace(/\n/g, '<br>')}</div>
      ` : ''}

      <div class="footer">
        Generated by WWTP Command Center v8.0.0 | ${new Date().toLocaleDateString()}
      </div>
    </body>
    </html>
  `;

  // Open print window
  const printWindow = window.open('', '_blank');
  printWindow.document.write(printContent);
  printWindow.document.close();
  printWindow.onload = function() {
    printWindow.print();
  };

  closePDFModal();
  showToast('üìÑ PDF generated - use Print dialog to save', 'success');
}

// ==================== 5. OFFLINE MODE (SERVICE WORKER) ====================
const SW_CODE = `
const CACHE_NAME = 'wwtp-v8.0.0';
const ASSETS = ['/'];

self.addEventListener('install', e => {
  e.waitUntil(
    caches.open(CACHE_NAME).then(cache => {
      return cache.addAll(ASSETS);
    })
  );
  self.skipWaiting();
});

self.addEventListener('activate', e => {
  e.waitUntil(
    caches.keys().then(keys => {
      return Promise.all(
        keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))
      );
    })
  );
  self.clients.claim();
});

self.addEventListener('fetch', e => {
  e.respondWith(
    caches.match(e.request).then(cached => {
      return cached || fetch(e.request).then(response => {
        return caches.open(CACHE_NAME).then(cache => {
          cache.put(e.request, response.clone());
          return response;
        });
      });
    }).catch(() => {
      return new Response('<h1>Offline</h1><p>Please reconnect to the internet.</p>', {
        headers: { 'Content-Type': 'text/html' }
      });
    })
  );
});
`;

function registerServiceWorker() {
  // Service worker registration handled by consolidated init above
}

// Online/Offline detection
function initOfflineDetection() {
  const indicator = document.getElementById('offlineIndicator');

  function updateOnlineStatus() {
    if (!navigator.onLine) {
      indicator.style.display = 'block';
      document.body.style.paddingTop = '40px';
    } else {
      indicator.style.display = 'none';
      document.body.style.paddingTop = '0';
    }
  }

  window.addEventListener('online', () => {
    updateOnlineStatus();
    showToast('üì∂ Back online!', 'success');
  });

  window.addEventListener('offline', () => {
    updateOnlineStatus();
    showToast('üì¥ Offline - data saved locally', 'warning');
  });

  updateOnlineStatus();
}

// ==================== FAB MENU ====================
let fabOpen = false;
function toggleFabMenu() {
  fabOpen = !fabOpen;
  const main = document.getElementById('fabMain');
  const buttons = ['fabUnitConv', 'fabPDF', 'fabTheme'];

  main.style.transform = fabOpen ? 'rotate(45deg)' : 'rotate(0deg)';

  buttons.forEach((id, i) => {
    const btn = document.getElementById(id);
    if (fabOpen) {
      setTimeout(() => {
        btn.style.display = 'flex';
        btn.style.opacity = '1';
        btn.style.transform = 'scale(1)';
      }, i * 50);
    } else {
      btn.style.opacity = '0';
      btn.style.transform = 'scale(0.5)';
      setTimeout(() => btn.style.display = 'none', 150);
    }
  });
}

// ==================== TOAST NOTIFICATION ====================
function showToast(message, type = 'info') {
  const colors = {
    info: '#0077b6',
    success: '#06d6a0',
    warning: '#ffd166',
    error: '#ef4444'
  };

  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${colors[type]};
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    z-index: 3000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    animation: slideDown 0.3s ease;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.style.animation = 'slideUp 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

// Add toast animations and mobile FAB positioning
const toastStyles = document.createElement('style');
toastStyles.textContent = `
  @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
  @keyframes slideUp { from { opacity: 1; transform: translateX(-50%) translateY(0); } to { opacity: 0; transform: translateX(-50%) translateY(-20px); } }
  #fabUnitConv, #fabPDF, #fabTheme { opacity: 0; transform: scale(0.5); transition: all 0.15s ease; display: flex; align-items: center; justify-content: center; }
  #fabMain:hover, #fabUnitConv:hover, #fabPDF:hover, #fabTheme:hover { transform: scale(1.1); }
  @media(max-width:767px) {
    #fabMenu { bottom: 90px !important; right: 15px !important; }
    #unitConverterWidget { bottom: 160px !important; right: 15px !important; width: 290px !important; }
    #pdfModal > div { width: 95% !important; max-height: 90vh; overflow-y: auto; }
  }
`;
document.head.appendChild(toastStyles);

// ========== KEYBOARD SHORTCUTS ==========

var keyboardShortcutsEnabled = true;

document.addEventListener('keydown', function(e) {
  if (!keyboardShortcutsEnabled) return;

  // Don't trigger when typing in inputs
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

  // Ctrl/Cmd + key combinations
  if (e.ctrlKey || e.metaKey) {
    switch(e.key.toLowerCase()) {
      case 's':
        e.preventDefault();
        if (typeof saveAllData === 'function') saveAllData();
        showToast('üíæ Data saved', 'success');
        break;
      case 'p':
        e.preventDefault();
        switchPanel('profiles');
        break;
      case 'r':
        e.preventDefault();
        switchPanel('reports');
        break;
      case 'd':
        e.preventDefault();
        switchPanel('dashboard');
        break;
      case '/':
        e.preventDefault();
        showKeyboardHelp();
        break;
    }
    return;
  }

  // Single key shortcuts (when not in input)
  switch(e.key) {
    case '1':
      switchPanel('dashboard');
      break;
    case '2':
      switchPanel('daily-ops');
      break;
    case '3':
      switchPanel('process-control');
      break;
    case '4':
      switchPanel('wizards');
      break;
    case '5':
      switchPanel('reports');
      break;
    case '6':
      switchPanel('profiles');
      break;
    case '?':
      showKeyboardHelp();
      break;
    case 'Escape':
      closeAllModals();
      break;
  }
});

function showKeyboardHelp() {
  var helpHtml = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center" onclick="this.remove()">
      <div style="background:#1e3a5f;padding:30px;border-radius:16px;max-width:500px;color:white" onclick="event.stopPropagation()">
        <h3 style="margin:0 0 20px 0;color:#4ade80">‚å®Ô∏è Keyboard Shortcuts</h3>
        <div style="display:grid;grid-template-columns:auto 1fr;gap:10px 20px;font-size:14px">
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">1</kbd><span>Dashboard</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">2</kbd><span>Daily Operations</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">3</kbd><span>Process Control</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">4</kbd><span>Wizards</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">5</kbd><span>Reports</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">6</kbd><span>Profiles</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">Ctrl+S</kbd><span>Save All Data</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">Ctrl+D</kbd><span>Go to Dashboard</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">Ctrl+P</kbd><span>Go to Profiles</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">Ctrl+R</kbd><span>Go to Reports</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">?</kbd><span>Show this help</span>
          <kbd style="background:#374151;padding:4px 8px;border-radius:4px">Esc</kbd><span>Close modals</span>
        </div>
        <button onclick="this.parentElement.parentElement.remove()" style="margin-top:20px;background:#4ade80;color:#1e3a5f;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:bold">Got it!</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', helpHtml);
}

function closeAllModals() {
  // Close any open modals
  document.querySelectorAll('[style*="position:fixed"]').forEach(function(el) {
    if (el.style.zIndex > 9000) el.remove();
  });
  // Close alert panels
  var alertSettings = document.getElementById('alertSettings');
  var alertHistory = document.getElementById('alertHistory');
  if (alertSettings) alertSettings.style.display = 'none';
  if (alertHistory) alertHistory.style.display = 'none';
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
  // Load saved theme
  loadThemePreference();

  // Load saved data
  setTimeout(loadAllData, 500);

  // Initialize auto-save
  initAutoSave();

  // Initialize unit converter
  updateUnitConverter();

  // Initialize offline detection
  initOfflineDetection();

  // Register service worker
  registerServiceWorker();

  // Sync Master Settings to all calculators
  setTimeout(function() {
    if (typeof syncMasterToAll === 'function') syncMasterToAll();
  }, 1000);

  // Show notes field toggle
  document.getElementById('pdfNotes')?.addEventListener('change', function() {
    document.getElementById('pdfNotesSection').style.display = this.checked ? 'block' : 'none';
  });

  // Check for first visit or version update
  checkFirstVisit();

});

// First visit / tutorial
function checkFirstVisit() {
  var lastVersion = localStorage.getItem('wwtp_version');
  var currentVersion = '9.5.0';

  if (!lastVersion) {
    // First time user - show welcome
    setTimeout(showWelcomeTutorial, 1500);
  } else if (lastVersion !== currentVersion) {
    // Version update - show what's new
    setTimeout(showWhatsNew, 1500);
  }

  localStorage.setItem('wwtp_version', currentVersion);
}

function showWelcomeTutorial() {
  var html = `
    <div id="welcomeModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px">
      <div style="background:linear-gradient(135deg,#1e3a5f,#243b55);padding:30px;border-radius:20px;max-width:600px;color:white;text-align:center;animation:fadeIn 0.5s">
        <div style="font-size:60px;margin-bottom:15px">üè≠</div>
        <h2 style="margin:0 0 10px 0;color:#4ade80">Welcome to WWTP Command Center!</h2>
        <p style="opacity:0.9;margin-bottom:20px">Your comprehensive wastewater treatment analysis platform</p>

        <div style="text-align:left;background:rgba(0,0,0,0.3);padding:20px;border-radius:12px;margin-bottom:20px">
          <h4 style="color:#60a5fa;margin:0 0 15px 0">üöÄ Quick Start Guide:</h4>
          <div style="margin-bottom:12px"><span style="color:#4ade80">1.</span> Go to <strong>‚öôÔ∏è Process Control</strong> ‚Üí Set Master Settings</div>
          <div style="margin-bottom:12px"><span style="color:#4ade80">2.</span> Save your plant as a <strong>üè≠ Profile</strong></div>
          <div style="margin-bottom:12px"><span style="color:#4ade80">3.</span> Use <strong>üß≠ Wizards</strong> for troubleshooting</div>
          <div style="margin-bottom:12px"><span style="color:#4ade80">4.</span> Generate <strong>üìë Reports</strong> for clients</div>
          <div><span style="color:#4ade80">5.</span> Press <kbd style="background:#374151;padding:2px 6px;border-radius:4px">?</kbd> anytime for keyboard shortcuts</div>
        </div>

        <div style="display:flex;gap:10px;justify-content:center">
          <button onclick="document.getElementById('welcomeModal').remove();switchPanel('process-control')" style="background:#4ade80;color:#1e3a5f;border:none;padding:12px 24px;border-radius:10px;cursor:pointer;font-weight:bold;font-size:16px">üöÄ Get Started</button>
          <button onclick="document.getElementById('welcomeModal').remove()" style="background:#64748b;color:white;border:none;padding:12px 24px;border-radius:10px;cursor:pointer;font-weight:bold">Skip</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
}

function showWhatsNew() {
  var html = `
    <div id="whatsNewModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10001;display:flex;align-items:center;justify-content:center;padding:20px">
      <div style="background:linear-gradient(135deg,#1e3a5f,#243b55);padding:30px;border-radius:20px;max-width:550px;color:white;animation:fadeIn 0.5s">
        <div style="font-size:40px;margin-bottom:10px">üéâ</div>
        <h2 style="margin:0 0 5px 0;color:#fbbf24">What's New in v9.6.0</h2>
        <p style="opacity:0.7;margin-bottom:20px;font-size:14px">App has been updated!</p>

        <div style="text-align:left;max-height:300px;overflow-y:auto">
          <div style="background:rgba(16,185,129,0.2);padding:12px;border-radius:8px;margin-bottom:10px;border-left:4px solid #10b981">
            <strong style="color:#4ade80">‚ö†Ô∏è Alarm System</strong><br>
            <span style="font-size:13px;opacity:0.9">Set thresholds, get alerts when values exceed limits</span>
          </div>
          <div style="background:rgba(96,165,250,0.2);padding:12px;border-radius:8px;margin-bottom:10px;border-left:4px solid #60a5fa">
            <strong style="color:#60a5fa">üìë PDF Reports</strong><br>
            <span style="font-size:13px;opacity:0.9">4 report types with branding & export</span>
          </div>
          <div style="background:rgba(167,139,250,0.2);padding:12px;border-radius:8px;margin-bottom:10px;border-left:4px solid #a78bfa">
            <strong style="color:#a78bfa">üß≠ 10 Wizards</strong><br>
            <span style="font-size:13px;opacity:0.9">Interactive troubleshooting for common issues</span>
          </div>
          <div style="background:rgba(251,191,36,0.2);padding:12px;border-radius:8px;margin-bottom:10px;border-left:4px solid #fbbf24">
            <strong style="color:#fbbf24">‚å®Ô∏è Keyboard Shortcuts</strong><br>
            <span style="font-size:13px;opacity:0.9">Press ? for shortcuts</span>
          </div>
          <div style="background:rgba(239,68,68,0.2);padding:12px;border-radius:8px;border-left:4px solid #ef4444">
            <strong style="color:#f87171">üßπ Cleaner Interface</strong><br>
            <span style="font-size:13px;opacity:0.9">17 ‚Üí 14 panels, faster loading</span>
          </div>
        </div>

        <button onclick="document.getElementById('whatsNewModal').remove()" style="margin-top:20px;background:#fbbf24;color:#1e3a5f;border:none;padding:12px 30px;border-radius:10px;cursor:pointer;font-weight:bold;font-size:16px">Got it!</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
}
// PDF Generator Functions
function saveBrandingSettings(){
  localStorage.setItem('wwtp_branding',JSON.stringify({
    company:document.getElementById('pdf_company')?.value||'',
    consultant:document.getElementById('pdf_consultant')?.value||'',
    phone:document.getElementById('pdf_phone')?.value||'',
    email:document.getElementById('pdf_email')?.value||''
  }));
  alert('Branding saved!');
}
function loadBrandingSettings(){
  var s=localStorage.getItem('wwtp_branding');
  if(s){var b=JSON.parse(s);
    document.getElementById('pdf_company').value=b.company||'';
    document.getElementById('pdf_consultant').value=b.consultant||'';
    document.getElementById('pdf_phone').value=b.phone||'';
    document.getElementById('pdf_email').value=b.email||'';
    alert('Branding loaded!');
  }
}
function generateProfessionalPDF(preview){
  var c=document.getElementById('pdf_company')?.value||'WWTP Consulting';
  var p=document.getElementById('pdf_plant')?.value||'Treatment Plant';
  var d=document.getElementById('pdf_date')?.value||new Date().toLocaleDateString();
  var h='<!DOCTYPE html><html><head><style>body{font-family:Arial;margin:40px}'+
    '.header{background:linear-gradient(135deg,#0077b6,#023e8a);color:white;padding:30px;border-radius:8px}'+
    'table{width:100%;border-collapse:collapse;margin:20px 0}th,td{border:1px solid #ddd;padding:12px}'+
    'th{background:#0077b6;color:white}.good{color:#059669}</style></head><body>'+
    '<div class="header"><h1>'+c+'</h1><h2>Operations Report</h2></div>'+
    '<p><strong>Facility:</strong> '+p+'<br><strong>Date:</strong> '+d+'</p>'+
    '<h3>Process Parameters</h3><table><tr><th>Parameter</th><th>Value</th><th>Status</th></tr>'+
    '<tr><td>Flow Rate</td><td>3.5 MGD</td><td class="good">Normal</td></tr>'+
    '<tr><td>DO Level</td><td>2.1 mg/L</td><td class="good">Normal</td></tr>'+
    '<tr><td>MLSS</td><td>3,200 mg/L</td><td class="good">Normal</td></tr></table>'+
    '<h3>Compliance Status</h3><table><tr><th>Parameter</th><th>Result</th><th>Limit</th><th>Status</th></tr>'+
    '<tr><td>BOD</td><td>12 mg/L</td><td>30 mg/L</td><td class="good">Compliant</td></tr>'+
    '<tr><td>TSS</td><td>15 mg/L</td><td>30 mg/L</td><td class="good">Compliant</td></tr></table>'+
    '<p style="margin-top:40px;font-size:12px;color:#666">Generated by WWTP Command Center v9.6.0</p></body></html>';
  var w=window.open('','_blank');w.document.write(h);w.document.close();
  if(!preview)setTimeout(function(){w.print();},500);
}

// ==================== v9.5.0 ENHANCEMENT FUNCTIONS ====================

// ==================== TIME TRACKING ====================
let timerInterval = null;
let timerSeconds = 0;
let timerRunning = false;
let timeEntries = JSON.parse(localStorage.getItem('wwtp_time_entries') || '[]');

function startTimer() {
  if (timerRunning) return;

  const client = document.getElementById('timer_client')?.value;
  const task = document.getElementById('timer_task')?.value;

  if (!task) {
    showToast('Please enter a task description', 'warning');
    return;
  }

  timerRunning = true;
  document.getElementById('timer_start').style.display = 'none';
  document.getElementById('timer_pause').style.display = 'inline-block';
  document.getElementById('timer_stop').style.display = 'inline-block';

  timerInterval = setInterval(() => {
    timerSeconds++;
    updateTimerDisplay();
  }, 1000);

  showToast('‚è±Ô∏è Timer started', 'success');
}

function pauseTimer() {
  if (!timerRunning) return;

  timerRunning = false;
  clearInterval(timerInterval);

  document.getElementById('timer_pause').textContent = '‚ñ∂ Resume';
  document.getElementById('timer_pause').onclick = resumeTimer;

  showToast('‚è∏Ô∏è Timer paused', 'info');
}

function resumeTimer() {
  timerRunning = true;
  timerInterval = setInterval(() => {
    timerSeconds++;
    updateTimerDisplay();
  }, 1000);

  document.getElementById('timer_pause').textContent = '‚è∏ Pause';
  document.getElementById('timer_pause').onclick = pauseTimer;

  showToast('‚ñ∂ Timer resumed', 'info');
}

function stopTimer() {
  clearInterval(timerInterval);
  timerRunning = false;

  const hours = (timerSeconds / 3600).toFixed(2);
  const client = document.getElementById('timer_client')?.value || 'Unassigned';
  const project = document.getElementById('timer_project')?.value || '';
  const task = document.getElementById('timer_task')?.value || 'General';
  const type = document.getElementById('timer_type')?.value || 'consulting';

  const entry = {
    id: Date.now(),
    date: new Date().toISOString(),
    client: client,
    project: project,
    task: task,
    type: type,
    hours: parseFloat(hours),
    seconds: timerSeconds,
    rate: 150,
    billed: false
  };

  timeEntries.unshift(entry);
  saveTimeEntries();
  updateTimeStats();
  renderTimeEntries();

  // Reset timer
  timerSeconds = 0;
  updateTimerDisplay();
  document.getElementById('timer_start').style.display = 'inline-block';
  document.getElementById('timer_pause').style.display = 'none';
  document.getElementById('timer_stop').style.display = 'none';
  document.getElementById('timer_task').value = '';

  showToast(`‚è±Ô∏è ${hours} hours logged`, 'success');
}

function updateTimerDisplay() {
  const hours = Math.floor(timerSeconds / 3600);
  const minutes = Math.floor((timerSeconds % 3600) / 60);
  const seconds = timerSeconds % 60;

  const display = [
    hours.toString().padStart(2, '0'),
    minutes.toString().padStart(2, '0'),
    seconds.toString().padStart(2, '0')
  ].join(':');

  document.getElementById('timer_display').textContent = display;
}

function addManualTime() {
  const date = document.getElementById('manual_date')?.value || new Date().toISOString().split('T')[0];
  const hours = parseFloat(document.getElementById('manual_hours')?.value || 1);
  const rate = parseFloat(document.getElementById('manual_rate')?.value || 150);
  const desc = document.getElementById('manual_desc')?.value || '';
  const client = document.getElementById('timer_client')?.value || 'Unassigned';

  if (!desc) {
    showToast('Please enter a description', 'warning');
    return;
  }

  const entry = {
    id: Date.now(),
    date: new Date(date).toISOString(),
    client: client,
    project: '',
    task: desc,
    type: 'manual',
    hours: hours,
    seconds: hours * 3600,
    rate: rate,
    billed: false
  };

  timeEntries.unshift(entry);
  saveTimeEntries();
  updateTimeStats();
  renderTimeEntries();
  clearTimeForm();

  showToast(`‚ûï ${hours} hours added`, 'success');
}

function clearTimeForm() {
  document.getElementById('manual_desc').value = '';
  document.getElementById('manual_hours').value = '1.0';
}

function saveTimeEntries() {
  localStorage.setItem('wwtp_time_entries', JSON.stringify(timeEntries));
}

function updateTimeStats() {
  const now = new Date();
  const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
  weekStart.setHours(0, 0, 0, 0);

  const weekEntries = timeEntries.filter(e => new Date(e.date) >= weekStart);

  const totalHours = timeEntries.reduce((sum, e) => sum + e.hours, 0);
  const billableHours = timeEntries.filter(e => !e.billed).reduce((sum, e) => sum + e.hours, 0);
  const unbilled = timeEntries.filter(e => !e.billed).reduce((sum, e) => sum + (e.hours * e.rate), 0);

  document.getElementById('time_total_hours').textContent = totalHours.toFixed(1);
  document.getElementById('time_billable_hours').textContent = billableHours.toFixed(1);
  document.getElementById('time_unbilled').textContent = '$' + unbilled.toLocaleString();
  document.getElementById('time_avg_daily').textContent = (totalHours / 7).toFixed(1);

  // Update weekly display
  const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
  days.forEach(day => {
    document.getElementById('week_' + day).textContent = '0';
  });

  weekEntries.forEach(entry => {
    const dayIndex = new Date(entry.date).getDay();
    const dayId = 'week_' + days[dayIndex];
    const el = document.getElementById(dayId);
    if (el) {
      el.textContent = (parseFloat(el.textContent) + entry.hours).toFixed(1);
    }
  });
}

function renderTimeEntries() {
  const container = document.getElementById('time_entries_list');
  if (!container) return;

  if (timeEntries.length === 0) {
    container.innerHTML = '<div class="note">No time entries yet. Start the timer or add manual entries above.</div>';
    return;
  }

  const html = timeEntries.slice(0, 20).map(entry => `
    <div class="time-entry">
      <div class="time-entry-hours">${entry.hours.toFixed(2)}h</div>
      <div style="flex:1">
        <div style="font-weight:600;color:var(--text-accent)">${entry.task}</div>
        <div style="font-size:12px;color:var(--text-unit)">${entry.client} ‚Ä¢ ${new Date(entry.date).toLocaleDateString()}</div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:600;color:${entry.billed ? 'var(--ok)' : 'var(--warn)'}">$${(entry.hours * entry.rate).toFixed(0)}</div>
        <div style="font-size:11px;color:var(--text-unit)">${entry.billed ? '‚úì Billed' : 'Unbilled'}</div>
      </div>
      <button onclick="deleteTimeEntry(${entry.id})" style="background:none;border:none;color:var(--bad);cursor:pointer;font-size:18px">√ó</button>
    </div>
  `).join('');

  container.innerHTML = html;
}

function deleteTimeEntry(id) {
  if (confirm('Delete this time entry?')) {
    timeEntries = timeEntries.filter(e => e.id !== id);
    saveTimeEntries();
    updateTimeStats();
    renderTimeEntries();
    showToast('Entry deleted', 'info');
  }
}

function filterTimeLog() {
  // Implement time log filtering
  showToast('Filtering time log...', 'info');
  renderTimeEntries();
}

function exportTimeLog() {
  const csv = ['Date,Client,Project,Task,Hours,Rate,Amount,Status'];
  timeEntries.forEach(e => {
    csv.push(`${new Date(e.date).toLocaleDateString()},${e.client},${e.project},${e.task},${e.hours},${e.rate},${e.hours * e.rate},${e.billed ? 'Billed' : 'Unbilled'}`);
  });

  const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'time_log_' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);

  showToast('üì§ Time log exported', 'success');
}

function generateTimesheet() {
  showToast('üìÑ Generating timesheet...', 'info');
  // Would generate a professional timesheet PDF
  setTimeout(() => showToast('Timesheet generated!', 'success'), 1000);
}

function generateInvoice() {
  const unbilledEntries = timeEntries.filter(e => !e.billed);
  if (unbilledEntries.length === 0) {
    showToast('No unbilled entries', 'warning');
    return;
  }

  showToast('üí∞ Generating invoice...', 'info');
  setTimeout(() => showToast('Invoice generated!', 'success'), 1000);
}

function toggleTimeTracker() {
  switchPanel('business');
  setTimeout(() => showBusinessSection('timetracking'), 100);
  showToast('‚è±Ô∏è Time Tracker opened', 'info');
}

// ==================== CLIENT PORTAL MODE ====================
let portalActive = false;

function toggleClientPortal() {
  portalActive = !portalActive;

  if (portalActive) {
    showClientPortal();
  } else {
    closeClientPortal();
  }
}

function showClientPortal() {
  const portalHTML = `
    <div class="portal-mode" id="clientPortal">
      <div class="portal-header">
        <div class="portal-logo">üè≠</div>
        <h1 style="margin:0;font-size:20px">Client Portal</h1>
        <p style="opacity:0.9;margin:10px 0 0 0">Wastewater Treatment Performance Dashboard</p>
        <button onclick="closeClientPortal()" style="position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.2);border:none;color:white;padding:10px 20px;border-radius:8px;cursor:pointer">‚Üê Exit Portal</button>
      </div>

      <div style="max-width:1200px;margin:0 auto;padding:20px">

        <div class="portal-card">
          <h3 style="margin:0 0 20px 0;color:var(--text-accent)">üìä Plant Status Overview</h3>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px">
            <div class="portal-stat">
              <div class="portal-stat-value">‚úì</div>
              <div class="portal-stat-label">Compliance Status</div>
            </div>
            <div class="portal-stat">
              <div class="portal-stat-value">3.5</div>
              <div class="portal-stat-label">Flow (MGD)</div>
            </div>
            <div class="portal-stat">
              <div class="portal-stat-value">97%</div>
              <div class="portal-stat-label">Efficiency</div>
            </div>
            <div class="portal-stat">
              <div class="portal-stat-value">0</div>
              <div class="portal-stat-label">Active Alerts</div>
            </div>
          </div>
        </div>

        <div class="portal-card">
          <h3 style="margin:0 0 20px 0;color:var(--text-accent)">üìã Compliance Summary</h3>
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="background:var(--bg-section)">
                <th style="padding:12px;text-align:left">Parameter</th>
                <th style="padding:12px;text-align:center">Result</th>
                <th style="padding:12px;text-align:center">Limit</th>
                <th style="padding:12px;text-align:center">Status</th>
              </tr>
            </thead>
            <tbody>
              <tr><td style="padding:12px">BOD</td><td style="text-align:center">12 mg/L</td><td style="text-align:center">30 mg/L</td><td style="text-align:center;color:#06d6a0">‚úì Pass</td></tr>
              <tr><td style="padding:12px">TSS</td><td style="text-align:center">15 mg/L</td><td style="text-align:center">30 mg/L</td><td style="text-align:center;color:#06d6a0">‚úì Pass</td></tr>
              <tr><td style="padding:12px">NH3-N</td><td style="text-align:center">1.2 mg/L</td><td style="text-align:center">3.0 mg/L</td><td style="text-align:center;color:#06d6a0">‚úì Pass</td></tr>
              <tr><td style="padding:12px">E. coli</td><td style="text-align:center">45 CFU</td><td style="text-align:center">126 CFU</td><td style="text-align:center;color:#06d6a0">‚úì Pass</td></tr>
            </tbody>
          </table>
        </div>

        <div class="portal-card">
          <h3 style="margin:0 0 20px 0;color:var(--text-accent)">üìÖ Recent Activity</h3>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="padding:15px;background:var(--bg-section);border-radius:8px;border-left:4px solid var(--ok)">
              <strong>Site Visit Completed</strong>
              <p style="margin:5px 0 0 0;color:var(--text-unit);font-size:14px">Process evaluation and operator training - Dec 10, 2024</p>
            </div>
            <div style="padding:15px;background:var(--bg-section);border-radius:8px;border-left:4px solid var(--info)">
              <strong>Monthly Report Submitted</strong>
              <p style="margin:5px 0 0 0;color:var(--text-unit);font-size:14px">November 2024 DMR submitted to TCEQ - Dec 5, 2024</p>
            </div>
            <div style="padding:15px;background:var(--bg-section);border-radius:8px;border-left:4px solid var(--ok)">
              <strong>Energy Audit Completed</strong>
              <p style="margin:5px 0 0 0;color:var(--text-unit);font-size:14px">Identified $3,200/month potential savings - Nov 28, 2024</p>
            </div>
          </div>
        </div>

        <div class="portal-card" style="text-align:center">
          <h3 style="margin:0 0 15px 0;color:var(--text-accent)">üìû Contact Your Consultant</h3>
          <p style="color:var(--text-unit)">For questions or support, reach out anytime</p>
          <div style="display:flex;gap:15px;justify-content:center;margin-top:15px">
            <button class="btn gradient" onclick="showToast('Opening email...', 'info')">üìß Email</button>
            <button class="btn blue" onclick="showToast('Scheduling call...', 'info')">üìÖ Schedule Call</button>
          </div>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', portalHTML);
  document.getElementById('portalBtn').classList.add('active');
  showToast('üëÅÔ∏è Client Portal Mode activated', 'success');
}

function closeClientPortal() {
  const portal = document.getElementById('clientPortal');
  if (portal) {
    portal.remove();
  }
  portalActive = false;
  document.getElementById('portalBtn').classList.remove('active');
  showToast('Client Portal closed', 'info');
}

// ==================== AI ENHANCEMENT ====================
function runAIAnalysis(type) {
  showToast('ü§ñ Running AI analysis...', 'info');

  // Show loading state
  const results = document.getElementById('ai_results');
  results.innerHTML = '<div class="ai-suggestion"><div class="ai-suggestion-title">üîÑ Analyzing...</div><p style="color:white;opacity:0.9">Processing plant data and generating insights...</p></div>';

  setTimeout(() => {
    let suggestions = [];

    if (type === 'process') {
      suggestions = [
        { title: 'üí° F/M Ratio Optimization', confidence: 92, text: 'Current F/M of 0.35 is within optimal range. Consider slight increase to 0.38 for improved settling.' },
        { title: 'üîÑ SRT Adjustment', confidence: 87, text: 'SRT of 12 days is adequate. During winter, extend to 15 days to maintain nitrification.' },
        { title: 'üìä MLSS Management', confidence: 94, text: 'MLSS at 3,200 mg/L is optimal. Maintain WAS rate to keep within 2,800-3,500 mg/L range.' }
      ];
    } else if (type === 'energy') {
      suggestions = [
        { title: '‚ö° Blower Optimization', confidence: 89, text: 'DO levels averaging 2.8 mg/L - reduce to 2.0 mg/L setpoint. Potential savings: $2,100/month.' },
        { title: 'üåô Off-Peak Operation', confidence: 85, text: 'Shift non-critical loads to off-peak hours (10PM-6AM). Estimated savings: $850/month.' },
        { title: 'üîß VFD Installation', confidence: 91, text: 'Installing VFDs on RAS pumps could reduce energy by 25%. ROI: 18 months.' }
      ];
    } else if (type === 'compliance') {
      suggestions = [
        { title: '‚úÖ Permit Status', confidence: 98, text: 'All parameters within permit limits. Current compliance rate: 100%.' },
        { title: 'üìã DMR Reminder', confidence: 100, text: 'December DMR due by January 28th. All data collection on track.' },
        { title: '‚ö†Ô∏è Upcoming Permit Renewal', confidence: 95, text: 'TPDES permit expires March 2025. Begin renewal process by January 2025.' }
      ];
    } else if (type === 'troubleshoot') {
      suggestions = [
        { title: 'üîç Potential Issue Detected', confidence: 78, text: 'SVI trending upward (from 120 to 145). Monitor for filamentous bulking.' },
        { title: 'üí° Recommended Action', confidence: 85, text: 'Increase RAS chlorination to 2-3 mg/L or adjust nutrient ratios (BOD:N:P).' },
        { title: 'üìà Trend Analysis', confidence: 82, text: 'Effluent TSS showing slight upward trend. Check secondary clarifier performance.' }
      ];
    }

    const html = suggestions.map((s, i) => `
      <div class="ai-suggestion" id="ai_suggestion_${i}" style="display:block">
        <div class="ai-suggestion-title">
          ${s.title}
          <span class="ai-confidence">${s.confidence}% Confidence</span>
        </div>
        <p style="color:white;opacity:0.9">${s.text}</p>
      </div>
    `).join('');

    results.innerHTML = html;
    showToast('‚úÖ AI analysis complete', 'success');
  }, 1500);
}

function showAITool(tool) {
  let title = '';
  let content = '';

  if (tool === 'report-writer') {
    title = 'üìù AI Report Writer';
    content = `
      <div class="input-group"><label>Report Type</label>
        <select id="ai_report_type">
          <option value="daily">Daily Operations Summary</option>
          <option value="monthly">Monthly Performance Report</option>
          <option value="compliance">Compliance Assessment</option>
          <option value="troubleshoot">Troubleshooting Report</option>
        </select>
      </div>
      <div class="input-group"><label>Additional Notes</label>
        <textarea id="ai_report_notes" rows="3" placeholder="Any specific items to include..."></textarea>
      </div>
      <div class="btns">
        <button class="btn gradient" onclick="generateAIReport()">ü§ñ Generate Report</button>
      </div>
    `;
  } else if (tool === 'troubleshoot') {
    title = 'üîç Smart Troubleshooter';
    content = `
      <div class="input-group"><label>What issue are you experiencing?</label>
        <select id="ai_issue_type">
          <option value="">Select issue type...</option>
          <option value="settling">Poor settling / High SVI</option>
          <option value="foam">Excessive foaming</option>
          <option value="odor">Odor issues</option>
          <option value="effluent">High effluent BOD/TSS</option>
          <option value="nitrification">Nitrification problems</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="input-group"><label>Describe the symptoms</label>
        <textarea id="ai_symptoms" rows="3" placeholder="Describe what you're observing..."></textarea>
      </div>
      <div class="btns">
        <button class="btn gradient" onclick="diagnoseIssue()">üîç Diagnose</button>
      </div>
    `;
  } else if (tool === 'optimizer') {
    title = 'üìà Process Optimizer';
    content = `
      <p style="color:var(--text-unit);margin-bottom:15px">The optimizer will analyze current conditions and suggest optimal setpoints.</p>
      <div class="kpi-grid" style="margin-bottom:15px">
        <div class="kpi-card"><h4>Current F/M</h4><p>0.35</p></div>
        <div class="kpi-card"><h4>Optimal F/M</h4><p>0.32-0.38</p></div>
        <div class="kpi-card"><h4>Current DO</h4><p>2.1</p></div>
        <div class="kpi-card"><h4>Optimal DO</h4><p>1.5-2.0</p></div>
      </div>
      <div class="btns">
        <button class="btn gradient" onclick="runFullOptimization()">‚ö° Run Full Optimization</button>
      </div>
    `;
  } else if (tool === 'compliance') {
    title = '‚úÖ Compliance Advisor';
    content = `
      <div class="note success" style="margin-bottom:15px">All parameters currently within permit limits</div>
      <div class="input-group"><label>What do you need help with?</label>
        <select id="ai_compliance_topic">
          <option value="dmr">DMR Preparation</option>
          <option value="permit">Permit Interpretation</option>
          <option value="exceedance">Handling Exceedances</option>
          <option value="reporting">Reporting Requirements</option>
        </select>
      </div>
      <div class="btns">
        <button class="btn gradient" onclick="getComplianceAdvice()">üìã Get Guidance</button>
      </div>
    `;
  }

  showModal(title, content);
}

function sendAIMessage() {
  const input = document.getElementById('ai_chat_input');
  const message = input.value.trim();

  if (!message) return;

  const messagesContainer = document.getElementById('ai_chat_messages');

  // Add user message
  messagesContainer.innerHTML += `<div class="ai-message user">${message}</div>`;
  input.value = '';

  // Show thinking indicator
  document.getElementById('ai_thinking').classList.add('active');

  // Scroll to bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;

  // Simulate AI response
  setTimeout(() => {
    document.getElementById('ai_thinking').classList.remove('active');

    let response = generateAIResponse(message);
    messagesContainer.innerHTML += `<div class="ai-message assistant">${response}</div>`;
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }, 1500);
}

function generateAIResponse(message) {
  const lower = message.toLowerCase();

  if (lower.includes('f/m') || lower.includes('food to microorganism')) {
    return 'The Food-to-Microorganism (F/M) ratio is a key process control parameter. For conventional activated sludge, optimal F/M is typically 0.2-0.5 lb BOD/lb MLVSS/day. Lower F/M (0.05-0.15) favors extended aeration, while higher F/M (0.5-1.0) is typical for high-rate systems. Would you like me to calculate your current F/M ratio?';
  }

  if (lower.includes('svi') || lower.includes('settling')) {
    return 'Sludge Volume Index (SVI) indicates settling characteristics. Normal SVI is 80-150 mL/g. High SVI (>150) suggests bulking, often caused by filamentous organisms, low DO, or nutrient deficiency. Would you like troubleshooting steps for settling issues?';
  }

  if (lower.includes('do') || lower.includes('dissolved oxygen')) {
    return 'Dissolved Oxygen (DO) is critical for aerobic treatment. Target 1.5-2.5 mg/L in the aeration basin. Too low (<1.0) causes filamentous growth; too high (>4.0) wastes energy. Current best practice is to maintain 2.0 mg/L with automated DO control.';
  }

  if (lower.includes('tceq') || lower.includes('permit') || lower.includes('compliance')) {
    return 'For TCEQ compliance, key requirements include: monthly DMR submissions by the 28th, 5-day BOD and TSS monitoring, proper record retention (3-5 years), and annual self-audits. Is there a specific compliance question I can help with?';
  }

  return 'I can help with process optimization, troubleshooting, compliance questions, and calculations. Try asking about F/M ratios, SVI, DO control, chemical dosing, or TCEQ requirements. What specific topic would you like to explore?';
}

function generateAIReport() {
  showToast('üìù Generating AI report...', 'info');
  setTimeout(() => {
    closeModal();
    showToast('‚úÖ Report generated!', 'success');
  }, 2000);
}

function diagnoseIssue() {
  showToast('üîç Analyzing issue...', 'info');
  setTimeout(() => {
    closeModal();
    runAIAnalysis('troubleshoot');
  }, 1500);
}

function runFullOptimization() {
  showToast('‚ö° Running optimization...', 'info');
  setTimeout(() => {
    closeModal();
    runAIAnalysis('process');
  }, 1500);
}

function getComplianceAdvice() {
  showToast('üìã Generating guidance...', 'info');
  setTimeout(() => {
    closeModal();
    runAIAnalysis('compliance');
  }, 1500);
}

// ==================== ENHANCED OFFLINE MODE ====================
let isOffline = false;
let pendingSync = [];

function enhancedOfflineInit() {
  // Create offline indicator
  if (!document.getElementById('offlineIndicator')) {
    const indicator = document.createElement('div');
    indicator.id = 'offlineIndicator';
    indicator.className = 'offline-indicator';
    indicator.innerHTML = 'üì¥ You are offline - Changes will sync when connection is restored';
    document.body.prepend(indicator);
  }

  // Enhanced online/offline handlers
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);

  // Check initial status
  if (!navigator.onLine) {
    handleOffline();
  }
}

function handleOnline() {
  isOffline = false;
  document.getElementById('offlineIndicator').classList.remove('visible');
  showToast('üì∂ Back online!', 'success');

  // Sync pending data
  if (pendingSync.length > 0) {
    syncPendingData();
  }
}

function handleOffline() {
  isOffline = true;
  document.getElementById('offlineIndicator').classList.add('visible');
  showToast('üì¥ Working offline - Data saved locally', 'warning');
}

function syncPendingData() {
  showToast('üîÑ Syncing pending data...', 'info');
  // Implement actual sync logic here
  setTimeout(() => {
    pendingSync = [];
    showToast('‚úÖ All data synced', 'success');
  }, 2000);
}

function queueForSync(data) {
  pendingSync.push({
    timestamp: new Date().toISOString(),
    data: data
  });
  localStorage.setItem('wwtp_pending_sync', JSON.stringify(pendingSync));
}

// ==================== ENHANCED PROPOSAL GENERATOR ====================
function generateProposalPreview() {
  const client = document.getElementById('prop_client')?.value || 'Client Name';
  const project = document.getElementById('prop_project')?.value || 'Project Name';
  const facility = document.getElementById('prop_facility')?.value || 'Facility';
  const date = document.getElementById('prop_date')?.value || new Date().toLocaleDateString();
  const propNum = document.getElementById('prop_number')?.value || 'PROP-2025-001';

  // Calculate totals from selected services
  let services = [];
  let total = 0;

  const serviceMap = {
    'svc_assessment': { name: 'Process Assessment & Evaluation', id: 'price_assessment' },
    'svc_compliance': { name: 'Compliance Review & Support', id: 'price_compliance' },
    'svc_training': { name: 'Operator Training (On-site)', id: 'price_training' },
    'svc_energy': { name: 'Energy Optimization Study', id: 'price_energy' },
    'svc_capacity': { name: 'Capacity Analysis & Planning', id: 'price_capacity' }
  };

  Object.keys(serviceMap).forEach(key => {
    const checkbox = document.getElementById(key);
    if (checkbox && checkbox.checked) {
      const price = parseFloat(document.getElementById(serviceMap[key].id)?.value || 0);
      services.push({ name: serviceMap[key].name, price: price });
      total += price;
    }
  });

  const html = `
    <div class="proposal-preview">
      <div class="proposal-header-logo">
        <h1 style="margin:0;color:#0077b6">Frazier Environmental Consulting</h1>
        <p style="margin:5px 0;color:#64748b">Professional Wastewater Treatment Services</p>
      </div>

      <h2 style="color:#023e8a">Service Proposal</h2>
      <p><strong>Proposal #:</strong> ${propNum}<br>
      <strong>Date:</strong> ${date}<br>
      <strong>Client:</strong> ${client}<br>
      <strong>Project:</strong> ${project}<br>
      <strong>Facility:</strong> ${facility}</p>

      <div class="proposal-section-title">Scope of Services</div>
      <table class="proposal-table">
        <thead>
          <tr><th>Service</th><th style="text-align:right">Fee</th></tr>
        </thead>
        <tbody>
          ${services.map(s => `<tr><td>${s.name}</td><td style="text-align:right">$${s.price.toLocaleString()}</td></tr>`).join('')}
          <tr class="proposal-total-row">
            <td><strong>Total Investment</strong></td>
            <td style="text-align:right"><strong>$${total.toLocaleString()}</strong></td>
          </tr>
        </tbody>
      </table>

      <div class="proposal-section-title">Terms & Conditions</div>
      <ul style="color:#475569">
        <li>50% due upon acceptance, 50% upon completion</li>
        <li>This proposal is valid for 30 days</li>
        <li>Travel expenses billed separately if applicable</li>
      </ul>

      <div style="margin-top:40px;border-top:2px solid #e2e8f0;padding-top:20px">
        <p><strong>Accepted By:</strong> _______________________</p>
        <p><strong>Date:</strong> _______________________</p>
      </div>
    </div>
  `;

  showModal('üìÑ Proposal Preview', html);
}

// Initialize new features on load
document.addEventListener('DOMContentLoaded', function() {
  // FORCE ALL SECTIONS OPEN
  document.querySelectorAll('.section-content').forEach(function(content) {
    content.style.display = 'block';
    content.style.maxHeight = 'none';
    content.style.overflow = 'visible';
    content.style.visibility = 'visible';
    content.style.height = 'auto';
  });

  // Initialize time entries display
  setTimeout(() => {
    updateTimeStats();
    renderTimeEntries();
    enhancedOfflineInit();

    // Set default date for time entry
    const dateInput = document.getElementById('manual_date');
    if (dateInput) {
      dateInput.value = new Date().toISOString().split('T')[0];
    }

    // Initialize mobile/tablet optimizations
    initMobileOptimizations();
  }, 1000);
});

// ==================== MOBILE & TABLET OPTIMIZATION v9.5.0 ====================

function initMobileOptimizations() {
  // Detect device type
  const isMobile = window.innerWidth <= 767;
  const isTablet = window.innerWidth >= 768 && window.innerWidth <= 1024;
  const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  // Add device class to body
  document.body.classList.remove('is-mobile', 'is-tablet', 'is-desktop', 'is-touch');
  if (isMobile) document.body.classList.add('is-mobile');
  else if (isTablet) document.body.classList.add('is-tablet');
  else document.body.classList.add('is-desktop');
  if (isTouch) document.body.classList.add('is-touch');

  // Initialize touch gestures for panels
  if (isTouch) {
    initSwipeNavigation();
    initPullToRefresh();
  }

  // Prevent zoom on double-tap for iOS
  preventDoubleTapZoom();

  // Handle orientation changes
  handleOrientationChange();

  // Optimize scroll performance
  optimizeScrollPerformance();

  // Log device info
}

// Swipe Navigation Between Panels
function initSwipeNavigation() {
  let touchStartX = 0;
  let touchStartY = 0;
  let touchEndX = 0;
  let touchEndY = 0;
  const minSwipeDistance = 80;
  const maxVerticalDistance = 100;

  const content = document.querySelector('.content');
  if (!content) return;

  content.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
  }, { passive: true });

  content.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    touchEndY = e.changedTouches[0].screenY;
    handleSwipe();
  }, { passive: true });

  function handleSwipe() {
    const deltaX = touchEndX - touchStartX;
    const deltaY = Math.abs(touchEndY - touchStartY);

    // Only trigger if horizontal swipe and not too much vertical movement
    if (Math.abs(deltaX) > minSwipeDistance && deltaY < maxVerticalDistance) {
      const panels = ['dashboard', 'daily-ops', 'process-control', 'reactors', 'hydraulics',
                      'aeration', 'chemicals', 'solids',  'scenarios',
                      'reports', 'tools', 'settings', 'help'];

      // Find current panel
      const activePanel = document.querySelector('.panel.active');
      if (!activePanel) return;

      const currentId = activePanel.id;
      const currentIndex = panels.indexOf(currentId);

      if (currentIndex === -1) return;

      let newIndex;
      if (deltaX > 0) {
        // Swipe right - go to previous panel
        newIndex = currentIndex > 0 ? currentIndex - 1 : panels.length - 1;
      } else {
        // Swipe left - go to next panel
        newIndex = currentIndex < panels.length - 1 ? currentIndex + 1 : 0;
      }

      // Navigate to new panel
      if (typeof switchPanel === 'function') {
        switchPanel(panels[newIndex]);
        showToast('üì± ' + panels[newIndex].replace('-', ' ').toUpperCase(), 'info');
      }
    }
  }
}

// Pull to Refresh (visual feedback only)
function initPullToRefresh() {
  let startY = 0;
  let pullDistance = 0;
  const threshold = 80;

  document.addEventListener('touchstart', (e) => {
    if (window.scrollY === 0) {
      startY = e.touches[0].pageY;
    }
  }, { passive: true });

  document.addEventListener('touchmove', (e) => {
    if (startY && window.scrollY === 0) {
      pullDistance = e.touches[0].pageY - startY;
      if (pullDistance > 0 && pullDistance < threshold * 2) {
        // Visual feedback could be added here
      }
    }
  }, { passive: true });

  document.addEventListener('touchend', () => {
    if (pullDistance > threshold) {
      // Trigger refresh action
      showToast('üîÑ Refreshing...', 'info');
      setTimeout(() => {
        if (typeof loadAllCalculations === 'function') {
          loadAllCalculations();
        }
        showToast('‚úì Data refreshed', 'success');
      }, 500);
    }
    startY = 0;
    pullDistance = 0;
  }, { passive: true });
}

// Prevent double-tap zoom on iOS
function preventDoubleTapZoom() {
  let lastTouchEnd = 0;

  document.addEventListener('touchend', (e) => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      e.preventDefault();
    }
    lastTouchEnd = now;
  }, { passive: false });
}

// Handle orientation changes
function handleOrientationChange() {
  window.addEventListener('orientationchange', () => {
    // Small delay to let the browser settle
    setTimeout(() => {
      // Reinitialize any size-dependent features
      const charts = document.querySelectorAll('canvas');
      charts.forEach(canvas => {
        if (canvas.chart) {
          canvas.chart.resize();
        }
      });

      // Update device class
      const isLandscape = window.innerWidth > window.innerHeight;
      document.body.classList.toggle('landscape', isLandscape);
      document.body.classList.toggle('portrait', !isLandscape);

      showToast(isLandscape ? 'üì± Landscape mode' : 'üì± Portrait mode', 'info');
    }, 100);
  });

  // Also listen for resize events
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      initMobileOptimizations();
    }, 250);
  });
}

// Optimize scroll performance
function optimizeScrollPerformance() {
  // Add passive listeners for scroll
  const scrollElements = document.querySelectorAll('.tabs, .table, .modal-body, .qref-body');
  scrollElements.forEach(el => {
    el.style.webkitOverflowScrolling = 'touch';
  });

  // Debounced scroll handler
  let scrollTimeout;
  window.addEventListener('scroll', () => {
    if (!document.body.classList.contains('is-scrolling')) {
      document.body.classList.add('is-scrolling');
    }

    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(() => {
      document.body.classList.remove('is-scrolling');
    }, 150);
  }, { passive: true });
}

// Touch-friendly input helpers
function enhanceInputsForTouch() {
  const inputs = document.querySelectorAll('input[type="number"], input[type="text"]');

  inputs.forEach(input => {
    // Add clear button functionality
    input.addEventListener('focus', function() {
      this.select(); // Select all text on focus for easy editing
    });

    // Prevent scroll when input is focused (iOS fix)
    input.addEventListener('touchmove', (e) => {
      if (document.activeElement === input) {
        e.stopPropagation();
      }
    }, { passive: true });
  });
}

// Initialize on load
document.addEventListener('DOMContentLoaded', enhanceInputsForTouch);

// Haptic feedback helper (if supported)
function hapticFeedback(type = 'light') {
  if ('vibrate' in navigator) {
    switch(type) {
      case 'light':
        navigator.vibrate(10);
        break;
      case 'medium':
        navigator.vibrate(25);
        break;
      case 'heavy':
        navigator.vibrate(50);
        break;
      case 'success':
        navigator.vibrate([10, 50, 10]);
        break;
      case 'error':
        navigator.vibrate([50, 30, 50, 30, 50]);
        break;
    }
  }
}

// Add haptic feedback to buttons
document.querySelectorAll('.btn, .tab, .mobile-nav-btn').forEach(btn => {
  btn.addEventListener('touchstart', () => hapticFeedback('light'), { passive: true });
});

</script>

<div id="quickRefModal" class="qref-modal" onclick="if(event.target===this)closeQuickRef()">
<div class="qref-content">
<div class="qref-header">
<h2>üìö Quick Reference Library</h2>
<button class="qref-close" onclick="closeQuickRef()">&times;</button>
</div>
<div class="qref-search">
<input type="text" id="qrefSearch" placeholder="üîç Search parameters, issues, limits..." oninput="filterQuickRef(this.value)">
</div>
<div class="qref-tabs">
<button class="qref-tab active" onclick="showQrefTab('parameters')">üìä Parameters</button>
<button class="qref-tab" onclick="showQrefTab('troubleshoot')">üîß Troubleshooting</button>
<button class="qref-tab" onclick="showQrefTab('regulatory')">üìã TCEQ Limits</button>
<button class="qref-tab" onclick="showQrefTab('formulas')">üßÆ Formulas</button>
<button class="qref-tab" onclick="showQrefTab('sops')">üìö SOPs</button>
</div>
<div class="qref-body">

<div id="qref-parameters" class="qref-tab-content">
<div class="qref-section" data-search="mlss mixed liquor suspended solids biomass">
<h3>üß´ MLSS (Mixed Liquor Suspended Solids)</h3>
<table class="qref-table">
<tr><th>Process Type</th><th>Typical Range</th><th>Optimal</th></tr>
<tr><td>Conventional Activated Sludge</td><td>1,500 - 3,500 mg/L</td><td><span class="qref-range optimal">2,000 - 3,000 mg/L</span></td></tr>
<tr><td>Extended Aeration</td><td>3,000 - 6,000 mg/L</td><td><span class="qref-range optimal">4,000 - 5,000 mg/L</span></td></tr>
<tr><td>MBR Systems</td><td>8,000 - 15,000 mg/L</td><td><span class="qref-range optimal">10,000 - 12,000 mg/L</span></td></tr>
<tr><td>SBR Systems</td><td>2,000 - 5,000 mg/L</td><td><span class="qref-range optimal">3,000 - 4,000 mg/L</span></td></tr>
<tr><td>MBBR Systems</td><td>2,000 - 4,000 mg/L</td><td><span class="qref-range optimal">2,500 - 3,500 mg/L</span></td></tr>
</table>
</div>

<div class="qref-section" data-search="srt sludge retention time mcrt mean cell">
<h3>‚è±Ô∏è SRT (Sludge Retention Time)</h3>
<table class="qref-table">
<tr><th>Treatment Goal</th><th>Typical SRT</th><th>Notes</th></tr>
<tr><td>BOD Removal Only</td><td>3 - 5 days</td><td>Minimum for stable operation</td></tr>
<tr><td>Nitrification</td><td>8 - 15 days</td><td>Temperature dependent</td></tr>
<tr><td>Extended Aeration</td><td>20 - 30 days</td><td>Low sludge production</td></tr>
<tr><td>Cold Weather (&lt;15¬∞C)</td><td>15 - 25 days</td><td>Slower nitrifier growth</td></tr>
<tr><td>Warm Weather (&gt;20¬∞C)</td><td>8 - 12 days</td><td>Faster kinetics</td></tr>
</table>
</div>

<div class="qref-section" data-search="fm f/m food microorganism ratio loading">
<h3>‚öñÔ∏è F/M Ratio (Food to Microorganism)</h3>
<table class="qref-table">
<tr><th>Process Type</th><th>F/M Range</th><th>Optimal</th></tr>
<tr><td>Conventional</td><td>0.2 - 0.5</td><td><span class="qref-range optimal">0.3 - 0.4</span></td></tr>
<tr><td>Extended Aeration</td><td>0.05 - 0.15</td><td><span class="qref-range optimal">0.08 - 0.12</span></td></tr>
<tr><td>High Rate</td><td>0.5 - 1.0</td><td><span class="qref-range optimal">0.6 - 0.8</span></td></tr>
<tr><td>Contact Stabilization</td><td>0.2 - 0.6</td><td><span class="qref-range optimal">0.3 - 0.5</span></td></tr>
</table>
</div>

<div class="qref-section" data-search="svi sludge volume index settling">
<h3>üìâ SVI (Sludge Volume Index)</h3>
<table class="qref-table">
<tr><th>SVI Range</th><th>Condition</th><th>Action</th></tr>
<tr><td><span class="qref-range optimal">&lt; 100 mL/g</span></td><td>Excellent settling</td><td>Optimal operation</td></tr>
<tr><td><span class="qref-range warning">100 - 150 mL/g</span></td><td>Good settling</td><td>Monitor closely</td></tr>
<tr><td><span class="qref-range warning">150 - 200 mL/g</span></td><td>Fair settling</td><td>Investigate causes</td></tr>
<tr><td><span class="qref-range critical">&gt; 200 mL/g</span></td><td>Bulking sludge</td><td>Immediate action needed</td></tr>
</table>
</div>

<div class="qref-section" data-search="do dissolved oxygen aeration">
<h3>üí® Dissolved Oxygen (DO)</h3>
<table class="qref-table">
<tr><th>Location/Process</th><th>Target DO</th><th>Notes</th></tr>
<tr><td>Aeration Basin</td><td>1.5 - 2.5 mg/L</td><td>Minimum 1.0 for nitrification</td></tr>
<tr><td>Anoxic Zone</td><td>&lt; 0.5 mg/L</td><td>Required for denitrification</td></tr>
<tr><td>Anaerobic Zone</td><td>&lt; 0.2 mg/L</td><td>Bio-P removal</td></tr>
<tr><td>Final Effluent</td><td>&gt; 4.0 mg/L</td><td>Permit requirement typical</td></tr>
</table>
</div>

<div class="qref-section" data-search="ph alkalinity acid base">
<h3>üß™ pH & Alkalinity</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>Optimal Range</th><th>Critical Limits</th></tr>
<tr><td>Aeration Basin pH</td><td>6.8 - 7.5</td><td>&lt; 6.5 or &gt; 8.5 inhibits nitrification</td></tr>
<tr><td>Alkalinity (as CaCO‚ÇÉ)</td><td>100 - 200 mg/L</td><td>&lt; 50 mg/L causes pH crash</td></tr>
<tr><td>Alkalinity for Nitrification</td><td>7.1 mg/L per mg NH‚ÇÉ-N</td><td>Consumed during nitrification</td></tr>
</table>
</div>
</div>

<div id="qref-troubleshoot" class="qref-tab-content qref-hidden">
<div class="qref-trouble" data-search="bulking filamentous settling svi high">
<h4>üö® Bulking Sludge (High SVI)</h4>
<p><strong>Symptoms:</strong> SVI &gt; 150, poor settling, rising sludge blanket</p>
<ul>
<li><strong>Low DO:</strong> Increase aeration, check diffusers</li>
<li><strong>Low F/M:</strong> Reduce MLSS, increase wasting</li>
<li><strong>Nutrient deficiency:</strong> Check N:P ratio (100:5:1 BOD:N:P)</li>
<li><strong>Septicity:</strong> Check collection system, reduce detention time</li>
<li><strong>Low pH:</strong> Add alkalinity (lime, soda ash)</li>
</ul>
</div>

<div class="qref-trouble" data-search="foaming nocardia microthrix brown white">
<h4>ü´ß Foaming Problems</h4>
<p><strong>Brown/Tan Foam (Nocardia):</strong></p>
<ul>
<li>Reduce SRT to 8-10 days</li>
<li>Increase wasting rate</li>
<li>Add chlorine to RAS (2-5 mg/L)</li>
<li>Spray water to break foam</li>
</ul>
<p><strong>White Foam:</strong></p>
<ul>
<li>Young sludge - reduce wasting</li>
<li>Low MLSS - reduce wasting, increase SRT</li>
<li>Surfactants - check industrial inputs</li>
</ul>
</div>

<div class="qref-trouble" data-search="nitrification ammonia high effluent">
<h4>‚ö†Ô∏è Poor Nitrification</h4>
<p><strong>Symptoms:</strong> High effluent ammonia, low nitrate</p>
<ul>
<li><strong>Low DO:</strong> Maintain &gt; 2.0 mg/L in aeration</li>
<li><strong>Low SRT:</strong> Increase to 12-15 days minimum</li>
<li><strong>Low pH:</strong> Maintain pH &gt; 6.8, add alkalinity</li>
<li><strong>Cold temperature:</strong> Increase SRT in winter</li>
<li><strong>Toxicity:</strong> Check for industrial discharge</li>
<li><strong>Insufficient alkalinity:</strong> Need 7.1 mg/L alk per mg/L NH‚ÇÉ-N</li>
</ul>
</div>

<div class="qref-trouble" data-search="rising sludge denitrification clarifier floating">
<h4>üîÑ Rising Sludge in Clarifier</h4>
<p><strong>Symptoms:</strong> Clumps of sludge floating, gas bubbles</p>
<ul>
<li><strong>Denitrification:</strong> Reduce sludge blanket depth</li>
<li>Increase RAS rate</li>
<li>Reduce SRT if over-nitrifying</li>
<li>Add anoxic zone before clarifier</li>
<li>Check for septic conditions</li>
</ul>
</div>

<div class="qref-trouble" data-search="pin floc dispersed turbid effluent cloudy">
<h4>üî¨ Pin Floc / Dispersed Growth</h4>
<p><strong>Symptoms:</strong> Turbid effluent, small floc particles</p>
<ul>
<li><strong>Over-aeration:</strong> Reduce DO to 2.0 mg/L</li>
<li><strong>Toxicity:</strong> Check industrial inputs</li>
<li><strong>Low SRT:</strong> Increase SRT, reduce wasting</li>
<li><strong>Hydraulic washout:</strong> Check for I&I during storms</li>
<li>Add polymer to clarifier</li>
</ul>
</div>

<div class="qref-trouble" data-search="phosphorus high effluent bio-p">
<h4>üß´ High Effluent Phosphorus</h4>
<p><strong>Symptoms:</strong> Effluent TP &gt; permit limit</p>
<ul>
<li><strong>Chemical addition:</strong> Alum, ferric, or ferrous</li>
<li>Dose ratio: 1.5-2.5 mol Fe/mol P or 1.5-2.0 mol Al/mol P</li>
<li><strong>Bio-P issues:</strong> Check anaerobic zone DO (&lt; 0.2 mg/L)</li>
<li>Ensure VFAs available in anaerobic zone</li>
<li>Check for nitrate recycle to anaerobic zone</li>
</ul>
</div>
</div>

<div id="qref-regulatory" class="qref-tab-content qref-hidden">
<div class="qref-section" data-search="tceq texas effluent limits permit">
<h3>üìã TCEQ Typical Effluent Limits</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>Daily Avg</th><th>Daily Max</th><th>Units</th></tr>
<tr><td>BOD‚ÇÖ</td><td>10 - 20</td><td>25 - 40</td><td>mg/L</td></tr>
<tr><td>TSS</td><td>15 - 20</td><td>30 - 45</td><td>mg/L</td></tr>
<tr><td>Ammonia-N (Summer)</td><td>2 - 5</td><td>4 - 10</td><td>mg/L</td></tr>
<tr><td>Ammonia-N (Winter)</td><td>3 - 10</td><td>6 - 20</td><td>mg/L</td></tr>
<tr><td>Total Phosphorus</td><td>0.5 - 1.0</td><td>1.0 - 2.0</td><td>mg/L</td></tr>
<tr><td>E. coli</td><td>126</td><td>399</td><td>CFU/100mL</td></tr>
<tr><td>DO (Minimum)</td><td>4.0 - 6.0</td><td>-</td><td>mg/L</td></tr>
<tr><td>pH</td><td colspan="2">6.0 - 9.0</td><td>S.U.</td></tr>
</table>
</div>

<div class="qref-section" data-search="cbod carbonaceous bod limits">
<h3>üìä CBOD‚ÇÖ vs BOD‚ÇÖ</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>When Required</th><th>Typical Limit</th></tr>
<tr><td>BOD‚ÇÖ (Total)</td><td>Standard permits</td><td>20 mg/L avg, 40 mg/L max</td></tr>
<tr><td>CBOD‚ÇÖ</td><td>Nitrifying plants</td><td>10 mg/L avg, 25 mg/L max</td></tr>
<tr><td>Note:</td><td colspan="2">CBOD ‚âà 0.8-0.9 √ó BOD for nitrifying plants</td></tr>
</table>
</div>

<div class="qref-section" data-search="monitoring frequency sampling">
<h3>üìÖ Typical Monitoring Frequency</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>Small (&lt;1 MGD)</th><th>Medium (1-5 MGD)</th><th>Large (&gt;5 MGD)</th></tr>
<tr><td>Flow</td><td>Daily</td><td>Continuous</td><td>Continuous</td></tr>
<tr><td>pH, DO, Temp</td><td>Daily</td><td>Daily</td><td>Continuous</td></tr>
<tr><td>BOD, TSS</td><td>Weekly</td><td>2x/week</td><td>Daily</td></tr>
<tr><td>Ammonia</td><td>Weekly</td><td>2x/week</td><td>Daily</td></tr>
<tr><td>E. coli</td><td>Weekly</td><td>2x/week</td><td>Daily</td></tr>
<tr><td>Phosphorus</td><td>Monthly</td><td>Weekly</td><td>2x/week</td></tr>
</table>
</div>
</div>

<div id="qref-formulas" class="qref-tab-content qref-hidden">
<div class="qref-section" data-search="formula calculation equation">
<h3>üßÆ Common Formulas</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>Formula</th></tr>
<tr><td><strong>F/M Ratio</strong></td><td>F/M = (Q √ó BOD √ó 8.34) / (V √ó MLSS √ó 8.34) = Q √ó BOD / (V √ó MLSS)</td></tr>
<tr><td><strong>SRT (days)</strong></td><td>SRT = (V √ó MLSS) / [(Qw √ó MLSS_ras) + (Qe √ó TSS_eff)]</td></tr>
<tr><td><strong>MLSS (mg/L)</strong></td><td>MLSS = (SRT √ó Q √ó BOD √ó Y) / [V √ó (1 + kd √ó SRT)]</td></tr>
<tr><td><strong>OLR</strong></td><td>OLR = (Q √ó BOD √ó 8.34) / (V √ó 1000) lb BOD/1000 cf/day</td></tr>
<tr><td><strong>SVI (mL/g)</strong></td><td>SVI = (Settled Volume mL/L √ó 1000) / MLSS mg/L</td></tr>
<tr><td><strong>WAS Flow</strong></td><td>Qw = V / SRT - Qe √ó (TSS_eff / MLSS_ras)</td></tr>
<tr><td><strong>RAS Rate</strong></td><td>RAS% = MLSS / (MLSS_ras - MLSS) √ó 100</td></tr>
<tr><td><strong>Detention Time</strong></td><td>DT (hr) = V (gal) √ó 24 / Q (GPD)</td></tr>
<tr><td><strong>Surface Loading</strong></td><td>SLR = Q (GPD) / Area (sf)</td></tr>
<tr><td><strong>Weir Loading</strong></td><td>WLR = Q (GPD) / Weir Length (ft)</td></tr>
</table>
</div>

<div class="qref-section" data-search="conversion factors units">
<h3>üìê Conversion Factors</h3>
<table class="qref-table">
<tr><th>Convert From</th><th>To</th><th>Multiply By</th></tr>
<tr><td>MGD</td><td>GPM</td><td>694.4</td></tr>
<tr><td>MGD</td><td>m¬≥/day</td><td>3,785</td></tr>
<tr><td>lb/day</td><td>kg/day</td><td>0.4536</td></tr>
<tr><td>mg/L √ó MGD √ó 8.34</td><td>lb/day</td><td>-</td></tr>
<tr><td>ft</td><td>m</td><td>0.3048</td></tr>
<tr><td>sf</td><td>m¬≤</td><td>0.0929</td></tr>
<tr><td>cf</td><td>gal</td><td>7.48</td></tr>
<tr><td>psi</td><td>ft head</td><td>2.31</td></tr>
<tr><td>HP</td><td>kW</td><td>0.746</td></tr>
</table>
</div>

<div class="qref-section" data-search="constants coefficients kinetic">
<h3>üìä Typical Design Constants</h3>
<table class="qref-table">
<tr><th>Parameter</th><th>Symbol</th><th>Typical Value</th></tr>
<tr><td>Yield Coefficient</td><td>Y</td><td>0.4 - 0.6 lb VSS/lb BOD</td></tr>
<tr><td>Decay Coefficient</td><td>kd</td><td>0.05 - 0.1 day‚Åª¬π</td></tr>
<tr><td>MLVSS/MLSS Ratio</td><td>-</td><td>0.70 - 0.85</td></tr>
<tr><td>BOD:N:P Ratio</td><td>-</td><td>100:5:1</td></tr>
<tr><td>O‚ÇÇ for Carbonaceous</td><td>-</td><td>1.1 - 1.5 lb O‚ÇÇ/lb BOD</td></tr>
<tr><td>O‚ÇÇ for Nitrification</td><td>-</td><td>4.6 lb O‚ÇÇ/lb NH‚ÇÉ-N</td></tr>
<tr><td>Alkalinity for Nitrif.</td><td>-</td><td>7.1 mg/L alk per mg/L NH‚ÇÉ-N</td></tr>
</table>
</div>
</div>

<div id="qref-sops" class="qref-tab-content qref-hidden">
<div class="note info" style="margin-bottom:20px">Quick reference SOPs for common wastewater operations. Click any card to view the full procedure.</div>

<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:15px" id="qref_sop_grid">

<div class="sop-card" onclick="showSOP('startup')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #06d6a0;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#4ade80;margin:0 0 8px 0">üöÄ Plant Startup</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Procedures for starting treatment processes after shutdown</p>
</div>

<div class="sop-card" onclick="showSOP('shutdown')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #ffd166;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#fbbf24;margin:0 0 8px 0">üõë Emergency Shutdown</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Emergency procedures for plant shutdown</p>
</div>

<div class="sop-card" onclick="showSOP('wasting')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #0077b6;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#60a5fa;margin:0 0 8px 0">üîÑ Sludge Wasting</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">WAS calculation and wasting procedures</p>
</div>

<div class="sop-card" onclick="showSOP('clarifier')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #a78bfa;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#a78bfa;margin:0 0 8px 0">‚öôÔ∏è Clarifier Operations</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Primary and secondary clarifier operation</p>
</div>

<div class="sop-card" onclick="showSOP('disinfection')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #ec4899;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#f472b6;margin:0 0 8px 0">‚ò¢Ô∏è Disinfection</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Chlorination and UV disinfection procedures</p>
</div>

<div class="sop-card" onclick="showSOP('sampling')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #00b4d8;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#48cae4;margin:0 0 8px 0">üß™ Sampling & Testing</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Sample collection and lab testing procedures</p>
</div>

<div class="sop-card" onclick="showSOP('chemical')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #84cc16;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#a3e635;margin:0 0 8px 0">‚öóÔ∏è Chemical Handling</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Safe chemical storage and handling</p>
</div>

<div class="sop-card" onclick="showSOP('blower')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #f97316;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#fb923c;margin:0 0 8px 0">üí® Blower Operations</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Aeration blower startup and maintenance</p>
</div>

<div class="sop-card" onclick="showSOP('dewatering')" style="background:var(--bg-section);padding:15px;border-radius:8px;cursor:pointer;border-left:4px solid #14b8a6;transition:all 0.2s" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform=''">
<h5 style="color:#2dd4bf;margin:0 0 8px 0">üóúÔ∏è Dewatering</h5>
<p style="color:var(--text-secondary);font-size:13px;margin:0">Belt press and centrifuge operation</p>
</div>

</div>

<div id="qref_sop_display" style="margin-top:20px"></div>
</div>

</div>
</div>
</div>
<div id="pwaStatus" class="pwa-status online">
<span class="status-dot"></span>
<span id="pwaStatusText">Online</span>
</div>

<div id="installModal" class="install-modal" onclick="if(event.target===this)closeInstallModal()">
<div class="install-modal-content">
<h3>üì≤ Install WWTP Command Center</h3>
<p style="color:var(--text-secondary);margin-bottom:16px">Add this app to your home screen for quick access and offline use.</p>

<div id="installAndroid" class="install-steps">
<strong>üì± Android (Chrome/Samsung):</strong>
<ol>
<li>Tap the <strong>‚ãÆ menu</strong> (3 dots) in browser</li>
<li>Select <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong></li>
<li>Tap <strong>Add/Install</strong> to confirm</li>
</ol>
</div>

<div id="installIOS" class="install-steps">
<strong>üçé iPhone/iPad (Safari):</strong>
<ol>
<li>Tap the <strong>Share button</strong> (‚ñ°‚Üë)</li>
<li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
<li>Tap <strong>Add</strong> to confirm</li>
</ol>
</div>

<div id="installDesktop" class="install-steps">
<strong>üíª Desktop (Chrome/Edge):</strong>
<ol>
<li>Click the <strong>install icon</strong> (‚äï) in the address bar</li>
<li>Or click <strong>‚ãÆ menu ‚Üí Install WWTP...</strong></li>
<li>Click <strong>Install</strong> to confirm</li>
</ol>
</div>

<button id="autoInstallBtn" class="btn gradient" style="margin-top:16px;display:none" onclick="installPWA()">
‚ö° Quick Install
</button>

<button class="close-btn" onclick="closeInstallModal()">Got it!</button>
</div>
</div>

<div id="pwaUpdateBanner" class="pwa-update-banner">
<span>üîÑ New version available!</span>
<button onclick="updatePWA()">Update Now</button>
<button onclick="dismissUpdate()" style="background:transparent;color:white;text-decoration:underline">Later</button>
</div>

<script>
// ==================== PWA ENHANCEMENT v9.5.0 ====================

// PWA Install Prompt (uses deferredPrompt from earlier script)

window.addEventListener('beforeinstallprompt', function(e) {
  e.preventDefault();
  deferredPrompt = e;
  // Show quick install button in modal
  var autoBtn = document.getElementById('autoInstallBtn');
  if (autoBtn) autoBtn.style.display = 'block';
});

function showInstallModal() {
  var modal = document.getElementById('installModal');
  modal.classList.add('show');

  // Detect device and show relevant instructions
  var ua = navigator.userAgent.toLowerCase();
  var isIOS = /iphone|ipad|ipod/.test(ua);
  var isAndroid = /android/.test(ua);
  var isSamsung = /samsung/.test(ua);

  document.getElementById('installAndroid').style.display = (isAndroid || isSamsung) ? 'block' : 'none';
  document.getElementById('installIOS').style.display = isIOS ? 'block' : 'none';
  document.getElementById('installDesktop').style.display = (!isIOS && !isAndroid) ? 'block' : 'none';

  // Show all on desktop for reference
  if (!isIOS && !isAndroid && !isSamsung) {
    document.getElementById('installAndroid').style.display = 'block';
    document.getElementById('installIOS').style.display = 'block';
  }

}

function closeInstallModal() {
  document.getElementById('installModal').classList.remove('show');
}

function installPWA() {
  if (!deferredPrompt) {
    showToast('üì≤ Use manual install instructions above', 'info');
    return;
  }

  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(function(result) {
    if (result.outcome === 'accepted') {
      showToast('‚úÖ App installed successfully!', 'success');
      closeInstallModal();
      // Install button removed
    }
    deferredPrompt = null;
    document.getElementById('autoInstallBtn').style.display = 'none';
  });
}

window.addEventListener('appinstalled', function() {
  // Install button removed
  closeInstallModal();
  showToast('‚úÖ WWTP Command Center installed!', 'success');
});

// Log standalone status but don't auto-hide button (user may want to see instructions)
if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
}

// Online/Offline Detection
function updateOnlineStatus() {
  var statusEl = document.getElementById('pwaStatus');
  var textEl = document.getElementById('pwaStatusText');
  var headerStatus = document.getElementById('headerOnlineStatus');

  if (navigator.onLine) {
    statusEl.classList.remove('offline');
    statusEl.classList.add('online');
    textEl.textContent = 'Online';
    if (headerStatus) {
      headerStatus.style.background = '#06d6a0';
      headerStatus.textContent = '‚óè Online';
    }
    syncPendingData();
  } else {
    statusEl.classList.remove('online');
    statusEl.classList.add('offline');
    textEl.textContent = 'Offline Mode';
    if (headerStatus) {
      headerStatus.style.background = '#ef4444';
      headerStatus.textContent = '‚óã Offline';
    }
    showToast('üì¥ Working offline - data saved locally', 'warning');
  }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// Initialize status on load
document.addEventListener('DOMContentLoaded', function() {
  updateOnlineStatus();

  // Hide status after 5 seconds if online
  setTimeout(function() {
    if (navigator.onLine) {
      var statusEl = document.getElementById('pwaStatus');
      statusEl.style.opacity = '0.3';
      statusEl.addEventListener('mouseenter', function() { this.style.opacity = '1'; });
      statusEl.addEventListener('mouseleave', function() { if(navigator.onLine) this.style.opacity = '0.3'; });
    }
  }, 5000);
});

// Offline Data Storage
var OFFLINE_STORAGE_KEY = 'wwtp_offline_data';

function saveOfflineData(key, data) {
  try {
    var stored = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '{}');
    stored[key] = {
      data: data,
      timestamp: Date.now(),
      synced: navigator.onLine
    };
    localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(stored));

    if (!navigator.onLine) {
    }
    return true;
  } catch(e) {
    console.error('[PWA] Offline save error:', e);
    return false;
  }
}

function getOfflineData(key) {
  try {
    var stored = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '{}');
    return stored[key] ? stored[key].data : null;
  } catch(e) {
    return null;
  }
}

function syncPendingData() {
  try {
    var stored = JSON.parse(localStorage.getItem(OFFLINE_STORAGE_KEY) || '{}');
    var pendingCount = 0;

    for (var key in stored) {
      if (!stored[key].synced) {
        stored[key].synced = true;
        pendingCount++;
      }
    }

    if (pendingCount > 0) {
      localStorage.setItem(OFFLINE_STORAGE_KEY, JSON.stringify(stored));
      showToast('‚òÅÔ∏è ' + pendingCount + ' item(s) synced', 'success');
    }
  } catch(e) {
    console.error('[PWA] Sync error:', e);
  }
}

// Cache Management
function getCacheSize() {
  var total = 0;
  for (var key in localStorage) {
    if (localStorage.hasOwnProperty(key)) {
      total += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
    }
  }
  return (total / 1024).toFixed(2) + ' KB';
}

function clearOfflineCache() {
  if (confirm('Clear all offline data? This cannot be undone.')) {
    localStorage.removeItem(OFFLINE_STORAGE_KEY);
    showToast('üóëÔ∏è Offline cache cleared', 'success');
  }
}

// PWA Update Handling
var newWorkerWaiting = null;

function updatePWA() {
  if (newWorkerWaiting) {
    newWorkerWaiting.postMessage({ type: 'SKIP_WAITING' });
  }
  window.location.reload();
}

function dismissUpdate() {
  document.getElementById('pwaUpdateBanner').classList.remove('show');
}

// ============================================================================
// CONSOLIDATED SERVICE WORKER REGISTRATION - GitHub Pages Compatible
// ============================================================================
(function initPWA() {
  if ('serviceWorker' in navigator) {
    // Detect base path for GitHub Pages
    const basePath = window.location.pathname.includes('/wwtp-app') ? '/wwtp-app/' : '/';

    window.addEventListener('load', () => {
      // Try to register external service worker first (best offline support)
      navigator.serviceWorker.register(basePath + 'sw.js')
        .then(registration => {

          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // Show update banner if it exists
                const banner = document.getElementById('pwaUpdateBanner');
                if (banner) banner.classList.add('show');
              }
            });
          });
        })
        .catch(err => {
          // External SW failed, app still works fine without it
        });
    });
  }
})();

// Auto-save form data for offline resilience
function enableOfflineFormSave() {
  document.querySelectorAll('input, select, textarea').forEach(function(el) {
    if (el.id) {
      // Load saved value
      var saved = getOfflineData('form_' + el.id);
      if (saved !== null && !el.value) {
        el.value = saved;
      }

      // Save on change
      el.addEventListener('change', function() {
        saveOfflineData('form_' + this.id, this.value);
      });
    }
  });
}

// Initialize offline form saving after DOM ready
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(enableOfflineFormSave, 1000);
});

// PWA Diagnostic Info
function getPWAInfo() {
  return {
    online: navigator.onLine,
    standalone: window.matchMedia('(display-mode: standalone)').matches,
    cacheSize: getCacheSize(),
    serviceWorker: 'serviceWorker' in navigator,
    installable: deferredPrompt !== null
  };
}
// ==================== END PWA ENHANCEMENT ====================
</script>

<div id="favoritesFloatingBtn" onclick="toggleFavoritesPanel()" style="position:fixed;bottom:90px;left:20px;width:56px;height:56px;background:linear-gradient(135deg,#f59e0b,#fbbf24);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:9998;box-shadow:0 4px 15px rgba(245,158,11,0.4);transition:all 0.3s;border:3px solid #fcd34d">
  <span style="font-size:20px">‚≠ê</span>
</div>

<div id="favoritesPanel" style="display:none;position:fixed;bottom:160px;left:20px;width:320px;max-height:60vh;background:linear-gradient(135deg,#1e1b4b,#312e81);border-radius:16px;z-index:9999;box-shadow:0 10px 40px rgba(0,0,0,0.5);border:3px solid #f59e0b;overflow:hidden">
  <div style="background:linear-gradient(135deg,#f59e0b,#fbbf24);padding:15px;display:flex;justify-content:space-between;align-items:center">
    <span style="font-weight:bold;font-size:18px;color:#1e1b4b">‚≠ê Favorites</span>
    <button onclick="toggleFavoritesPanel()" style="background:rgba(0,0,0,0.2);border:none;color:#1e1b4b;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:18px">‚úï</button>
  </div>
  <div id="favoritesList" style="padding:15px;max-height:calc(60vh - 60px);overflow-y:auto">
    <p style="color:#a5b4fc;text-align:center;margin:20px 0">No favorites yet.<br><br>Tap the ‚≠ê icon on any section to add it here.</p>
  </div>
</div>

<script>
// ========== FAVORITES SYSTEM ==========

var userFavorites = [];

// Favorite items available to star
var favoriteItems = [
  { id: 'fav_dashboard', name: 'üìä Dashboard', panel: 'dashboard', section: null },
  { id: 'fav_dailyops', name: 'üë∑ Daily Operations', panel: 'daily-ops', section: null },
  { id: 'fav_master', name: 'üéõÔ∏è Master Settings', panel: 'process-control', section: 'masterSettingsSection' },
  { id: 'fav_checklist', name: 'üìã Daily Checklist', panel: 'daily-ops', section: 'dailyChecklist' },
  { id: 'fav_process', name: '‚öôÔ∏è Process Control', panel: 'process-control', section: null },
  { id: 'fav_reactors', name: 'üîÑ Reactors', panel: 'reactors', section: null },
  { id: 'fav_hydraulics', name: 'üìê Hydraulics', panel: 'hydraulics', section: null },
  { id: 'fav_aeration', name: 'üí® Aeration', panel: 'aeration', section: null },
  { id: 'fav_chemicals', name: '‚öóÔ∏è Chemicals', panel: 'chemicals', section: null },
  { id: 'fav_solids', name: 'üóëÔ∏è Solids', panel: 'solids', section: null },
  { id: 'fav_compliance', name: 'üìã Compliance & Lab', panel: 'compliance', section: null },
  { id: 'fav_diagnostics', name: 'ü©∫ Diagnostics', panel: 'wizards', section: null },
  { id: 'fav_wizards', name: 'üß≠ Wizards', panel: 'wizards', section: null },
  { id: 'fav_maintenance', name: 'üîß Maintenance', panel: 'maintenance', section: null },
  { id: 'fav_reports', name: 'üìë Reports', panel: 'reports', section: null },
  { id: 'fav_profiles', name: 'üè≠ Profiles', panel: 'profiles', section: null },
  { id: 'fav_business', name: 'üíº Business', panel: 'business', section: null },
  { id: 'fav_multiplant', name: 'üè≠ Multi-Plant', panel: 'multiplant', section: null },
  // Calculators - Process Control
  { id: 'fav_svi', name: 'üß™ SVI Calculator', panel: 'process-control', section: 'sviCalcSection' },
  { id: 'fav_fm', name: 'üìä F/M Calculator', panel: 'process-control', section: 'fmCalcSection' },
  { id: 'fav_olr', name: 'üß´ OLR Calculator', panel: 'process-control', section: 'olrCalcSection' },
  { id: 'fav_mlss', name: 'üî¨ MLSS/MLVSS Calculator', panel: 'process-control', section: 'mlssCalcSection' },
  { id: 'fav_sludge_age', name: 'üìÖ Sludge Age (5 Methods)', panel: 'process-control', section: 'sludgeAgeCalculator' },
  // Calculators - Chemicals
  { id: 'fav_chlorine', name: 'üß¥ Chlorine Dosing', panel: 'chemicals', section: 'chlorineCalcSection' },
  { id: 'fav_polymer', name: 'üß™ Polymer Dosing', panel: 'chemicals', section: 'polymerCalcSection' },
  { id: 'fav_jar_test', name: 'üß´ Jar Test Optimizer', panel: 'chemicals', section: 'jarTestSection' },
  // Calculators - Hydraulics
  { id: 'fav_mass_balance', name: '‚öñÔ∏è Mass Balance', panel: 'hydraulics', section: 'massBalanceSection' },
  { id: 'fav_ote', name: 'üí® Oxygen Transfer (OTE)', panel: 'hydraulics', section: 'oteCalcSection' },
  // NEW - Solids Handling Calculators
  { id: 'fav_was_calc', name: 'üöø WAS Calculator', panel: 'solids', section: 'advancedWasCalculator' },
  { id: 'fav_ras_calc', name: 'üîÑ RAS Calculator', panel: 'solids', section: 'rasCalculatorSection' },
  { id: 'fav_clarifier_slr', name: 'üèä Clarifier SLR', panel: 'solids', section: 'clarifierSlrCalculator' },
  { id: 'fav_sludge_judge', name: 'üß™ Sludge Judge/Settleometer', panel: 'solids', section: 'sludgeJudgeCalculator' },
  { id: 'fav_thickener', name: 'üîÑ Thickener Loading', panel: 'solids', section: 'thickenerCalcSection' },
  { id: 'fav_biogas', name: 'üî• Biogas/Digester', panel: 'solids', section: 'biogasCalculator' },
  { id: 'fav_uv', name: '‚òÄÔ∏è UV Disinfection', panel: 'hydraulics', section: 'uvDisinfectionCalculator' },
  { id: 'fav_nutrient', name: 'üåø Nutrient Balance', panel: 'process-control', section: 'nutrientBalanceCalculator' },
  { id: 'fav_wetweather', name: 'üåßÔ∏è Wet Weather/I&I', panel: 'hydraulics', section: 'wetWeatherCalculator' },
  { id: 'fav_septage', name: 'üöõ Septage Receiving', panel: 'solids', section: 'septageCalculator' },
  { id: 'fav_dewatering', name: 'üóúÔ∏è Belt Press/Centrifuge', panel: 'hydraulics', section: 'dewateringCalculator' },
  { id: 'fav_sludgebox', name: 'üì¶ Sludge Box Hauling', panel: 'solids', section: 'sludgeBoxCalculator' },
  { id: 'fav_pumpstation', name: 'üîÑ Pump Station', panel: 'hydraulics', section: 'pumpStationCalculator' },
  { id: 'fav_membrane', name: 'üî¨ Membrane MBR/RO', panel: 'hydraulics', section: 'membraneCalculator' },
  { id: 'fav_daf', name: 'ü´ß DAF Flotation', panel: 'hydraulics', section: 'dafCalculator' },
  // Wizards
  { id: 'fav_tss_wizard', name: 'üî¥ TSS Wizard', panel: 'wizards', section: null, action: "startWizard('tss')" },
  { id: 'fav_bulking_wizard', name: 'üü† Bulking Wizard', panel: 'wizards', section: null, action: "startWizard('bulking')" },
  { id: 'fav_ammonia_wizard', name: 'üîµ Ammonia Wizard', panel: 'wizards', section: null, action: "startWizard('ammonia')" },
  { id: 'fav_do_wizard', name: 'üü¢ Low DO Wizard', panel: 'wizards', section: null, action: "startWizard('lowdo')" },
  { id: 'fav_foam_wizard', name: 'üü§ Foam/Scum Wizard', panel: 'wizards', section: null, action: "startWizard('foam')" },
  { id: 'fav_odor_wizard', name: 'üëÉ Odor Wizard', panel: 'wizards', section: null, action: "startWizard('odor')" },
  { id: 'fav_nutrient_wizard', name: 'üü£ Nutrient Wizard', panel: 'wizards', section: null, action: "startWizard('nutrient')" },
  { id: 'fav_blower_wizard', name: '‚ö° Blower Wizard', panel: 'wizards', section: null, action: "startWizard('blower')" },
  { id: 'fav_clarifier_wizard', name: 'üîß Clarifier Wizard', panel: 'wizards', section: null, action: "startWizard('clarifier')" },
  { id: 'fav_raswas_wizard', name: 'üíß RAS/WAS Wizard', panel: 'wizards', section: null, action: "startWizard('raswas')" }
];

function initFavorites() {
  try {
    var saved = localStorage.getItem('wwtp_favorites');
    if (saved) {
      userFavorites = JSON.parse(saved);
    }
    updateFavoritesList();
    addStarIcons();
  } catch(e) {
    console.error('Error loading favorites:', e);
    userFavorites = [];
  }
}

function saveFavorites() {
  try {
    localStorage.setItem('wwtp_favorites', JSON.stringify(userFavorites));
  } catch(e) {
    console.error('Error saving favorites:', e);
  }
}

function toggleFavoritesPanel() {
  var panel = document.getElementById('favoritesPanel');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
    updateFavoritesList();
  } else {
    panel.style.display = 'none';
  }
}

function toggleFavorite(itemId) {
  var index = userFavorites.indexOf(itemId);
  if (index === -1) {
    userFavorites.push(itemId);
    showToast('‚≠ê Added to favorites', 'success');
  } else {
    userFavorites.splice(index, 1);
    showToast('Removed from favorites', 'info');
  }
  saveFavorites();
  updateFavoritesList();
  updateStarIcon(itemId);
}

function updateFavoritesList() {
  var container = document.getElementById('favoritesList');
  if (!container) return;

  var html = '';

  if (userFavorites.length === 0) {
    html += '<p style="color:#a5b4fc;text-align:center;margin:20px 0">No favorites yet.</p>';
  } else {
    html += '<div style="display:flex;flex-direction:column;gap:8px">';

    userFavorites.forEach(function(favId) {
      var item = favoriteItems.find(function(i) { return i.id === favId; });
      if (item) {
        html += '<button onclick="goToFavorite(\'' + item.id + '\')" style="background:rgba(255,255,255,0.1);border:2px solid rgba(255,255,255,0.2);color:white;padding:12px 15px;border-radius:10px;text-align:left;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all 0.2s">';
        html += '<span style="font-size:15px">' + item.name + '</span>';
        html += '<span style="opacity:0.5">‚Üí</span>';
        html += '</button>';
      }
    });

    html += '</div>';
  }

  // Always show Manage Favorites button
  html += '<div style="margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1);text-align:center">';
  html += '<button onclick="manageFavorites()" style="background:#6366f1;border:none;color:white;padding:12px 25px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:bold">‚öôÔ∏è Manage Favorites</button>';
  html += '</div>';

  container.innerHTML = html;
}

function goToFavorite(itemId) {
  var item = favoriteItems.find(function(i) { return i.id === itemId; });
  if (!item) return;

  // Close favorites panel
  document.getElementById('favoritesPanel').style.display = 'none';

  // Switch to panel
  if (typeof switchPanel === 'function') {
    switchPanel(item.panel);
  }

  // Execute action if defined
  if (item.action) {
    setTimeout(function() {
      eval(item.action);
    }, 300);
  }

  // Scroll to section if defined
  if (item.section) {
    setTimeout(function() {
      var section = document.getElementById(item.section);
      if (section) {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }, 300);
  }
}

function manageFavorites() {
  var modal = document.createElement('div');
  modal.id = 'manageFavoritesModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:99999;padding:20px';

  var html = '<div style="background:linear-gradient(135deg,#1e1b4b,#312e81);padding:25px;border-radius:16px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;border:3px solid #f59e0b">';
  html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">';
  html += '<h3 style="margin:0;color:white">‚≠ê Manage Favorites</h3>';
  html += '<button onclick="document.getElementById(\'manageFavoritesModal\').remove()" style="background:#ef4444;border:none;color:white;width:35px;height:35px;border-radius:50%;cursor:pointer;font-size:18px">‚úï</button>';
  html += '</div>';

  html += '<div style="display:flex;flex-direction:column;gap:8px">';

  favoriteItems.forEach(function(item) {
    var isActive = userFavorites.indexOf(item.id) !== -1;
    html += '<label style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer">';
    html += '<input type="checkbox" ' + (isActive ? 'checked' : '') + ' onchange="toggleFavorite(\'' + item.id + '\')" style="width:20px;height:20px;cursor:pointer">';
    html += '<span style="color:white;font-size:15px">' + item.name + '</span>';
    html += '</label>';
  });

  html += '</div>';

  html += '<div style="margin-top:20px;text-align:center">';
  html += '<button onclick="document.getElementById(\'manageFavoritesModal\').remove();updateFavoritesList()" style="background:#10b981;border:none;color:white;padding:12px 30px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:bold">‚úì Done</button>';
  html += '</div>';

  html += '</div>';

  modal.innerHTML = html;
  document.body.appendChild(modal);
}

function addStarIcons() {
  // Add star icons to section headers where applicable
  // This can be expanded to add inline star buttons
}

function updateStarIcon(itemId) {
  // Update individual star icon state
}

// Initialize favorites on page load
document.addEventListener('DOMContentLoaded', initFavorites);
if (document.readyState !== 'loading') {
  initFavorites();
}

// ========== END FAVORITES SYSTEM ==========

// ============================================================================
// v9.6.0 NEW FEATURES - 5a, 5b, 5c
// ============================================================================

// ========== 5a) TRENDING CHARTS OVER TIME ==========
const TrendingData = {
  key: 'wwtp_trending_data',
  maxDays: 30,
  
  add(param, value) {
    const data = this.getAll();
    const today = new Date().toISOString().split('T')[0];
    if (!data[param]) data[param] = [];
    
    // Check if today already has entry
    const existing = data[param].find(d => d.date === today);
    if (existing) {
      existing.value = value;
    } else {
      data[param].push({ date: today, value: value });
    }
    
    // Keep only last 30 days
    data[param] = data[param].slice(-this.maxDays);
    localStorage.setItem(this.key, JSON.stringify(data));
  },
  
  getAll() {
    try {
      return JSON.parse(localStorage.getItem(this.key)) || {};
    } catch { return {}; }
  },
  
  get(param) {
    return this.getAll()[param] || [];
  },
  
  clear() {
    localStorage.removeItem(this.key);
  }
};

function showTrendChart(param, title) {
  const data = TrendingData.get(param);
  if (data.length < 2) {
    showToast('Need at least 2 data points for trend', 'warning');
    return;
  }
  
  const labels = data.map(d => d.date.slice(5)); // MM-DD
  const values = data.map(d => d.value);
  
  const html = `
    <div style="padding:20px">
      <canvas id="trendCanvas" width="500" height="300"></canvas>
      <div style="margin-top:15px;display:flex;gap:10px;justify-content:center">
        <button onclick="TrendingData.clear();this.closest('.modal-overlay').remove();showToast('Trend data cleared','info')" class="btn" style="background:#ef4444;color:white">üóëÔ∏è Clear Data</button>
        <button onclick="exportTrendCSV('${param}')" class="btn" style="background:#10b981;color:white">üì§ Export CSV</button>
      </div>
    </div>
  `;
  
  showModal('üìà ' + title + ' Trend (Last ' + data.length + ' days)', html);
  
  setTimeout(() => {
    const ctx = document.getElementById('trendCanvas');
    if (ctx && typeof Chart !== 'undefined') {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: title,
            data: values,
            borderColor: '#4ade80',
            backgroundColor: 'rgba(74, 222, 128, 0.1)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: false, grid: { color: 'rgba(255,255,255,0.1)' } },
            x: { grid: { color: 'rgba(255,255,255,0.1)' } }
          }
        }
      });
    }
  }, 100);
}

function exportTrendCSV(param) {
  const data = TrendingData.get(param);
  let csv = 'Date,Value\n';
  data.forEach(d => csv += d.date + ',' + d.value + '\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp-trend-' + param + '-' + Date.now() + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  showToast('üì§ Trend exported!', 'success');
}

// Auto-save KPI values for trending
function saveDailyTrends() {
  const flow = parseFloat(document.getElementById('kpi-flow')?.textContent) || 0;
  const doLevel = parseFloat(document.getElementById('kpi-do')?.textContent) || 0;
  const mlss = parseFloat(document.getElementById('kpi-mlss')?.textContent) || 0;
  
  if (flow > 0) TrendingData.add('flow', flow);
  if (doLevel > 0) TrendingData.add('do', doLevel);
  if (mlss > 0) TrendingData.add('mlss', mlss);
}

// ========== 5b) CALCULATOR CHAINING ==========
const CalcChain = {
  chains: {
    'full-analysis': {
      name: 'Full Plant Analysis',
      steps: ['calcLoading', 'calcFM', 'calcSRTmain', 'calcSVI', 'calcOxygen', 'calcEnergy'],
      description: 'Run loading ‚Üí F/M ‚Üí SRT ‚Üí SVI ‚Üí Oxygen ‚Üí Energy'
    },
    'solids-chain': {
      name: 'Solids Management',
      steps: ['calcSRTmain', 'calcWAS', 'calcSludge'],
      description: 'Run SRT ‚Üí WAS ‚Üí Sludge calculations'
    },
    'aeration-chain': {
      name: 'Aeration Analysis',
      steps: ['calcOxygen', 'calcEnergy', 'calcCosts'],
      description: 'Run Oxygen ‚Üí Energy ‚Üí Costs'
    }
  },
  
  run(chainId) {
    const chain = this.chains[chainId];
    if (!chain) return;
    
    let completed = 0;
    chain.steps.forEach((fn, idx) => {
      setTimeout(() => {
        if (typeof window[fn] === 'function') {
          window[fn]();
          completed++;
          showToast(`‚úÖ Step ${completed}/${chain.steps.length}: ${fn.replace('calc','')}`, 'success');
        }
      }, idx * 500);
    });
    
    setTimeout(() => {
      showToast(`üéâ ${chain.name} complete!`, 'success');
    }, chain.steps.length * 500 + 200);
  }
};

function showCalcChains() {
  let html = '<div style="display:grid;gap:15px">';
  
  for (const [id, chain] of Object.entries(CalcChain.chains)) {
    html += `
      <div style="background:rgba(255,255,255,0.05);padding:15px;border-radius:12px;border-left:4px solid #4ade80">
        <h4 style="margin:0 0 8px 0;color:#4ade80">${chain.name}</h4>
        <p style="margin:0 0 10px 0;font-size:13px;opacity:0.8">${chain.description}</p>
        <button onclick="CalcChain.run('${id}');this.closest('.modal-overlay').remove()" class="btn" style="background:#4ade80;color:#1a1a2e">‚ñ∂Ô∏è Run Chain</button>
      </div>
    `;
  }
  
  html += '</div>';
  showModal('üîó Calculator Chains', html);
}

// ========== 5c) EXCEL EXPORT ==========
function exportToExcel() {
  // Collect all visible data
  const data = {
    'Plant Overview': [],
    'Process Parameters': [],
    'Calculations': []
  };
  
  // KPIs
  const kpis = document.querySelectorAll('.kpi-card');
  kpis.forEach(kpi => {
    const label = kpi.querySelector('h4')?.textContent || '';
    const value = kpi.querySelector('p')?.textContent || '';
    const unit = kpi.querySelector('.small')?.textContent || '';
    data['Plant Overview'].push([label, value, unit]);
  });
  
  // Get calculation results
  const calcHistory = CalcHistory.getAll();
  calcHistory.forEach(calc => {
    data['Calculations'].push([calc.name, calc.result, new Date(calc.timestamp).toLocaleString()]);
  });
  
  // Generate CSV (Excel compatible)
  let csv = '\uFEFF'; // BOM for Excel UTF-8
  
  for (const [sheet, rows] of Object.entries(data)) {
    csv += '\n=== ' + sheet + ' ===\n';
    rows.forEach(row => {
      csv += row.join(',') + '\n';
    });
  }
  
  // Download
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'WWTP-Report-' + new Date().toISOString().split('T')[0] + '.csv';
  a.click();
  URL.revokeObjectURL(url);
  showToast('üìä Excel report exported!', 'success');
}

// Add trend buttons to KPI cards on load
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    saveDailyTrends(); // Auto-save today's values
  }, 3000);
});

// ============================================================================
// v9.6.0 ENHANCEMENTS - A through F
// ============================================================================

// ========== A) MOBILE/TABLET OPTIMIZATION ==========

// Touch-friendly: Ensure 48px minimum touch targets
(function initMobileOptimization() {
  const style = document.createElement('style');
  style.textContent = `
    /* A1: Minimum 48px touch targets */
    .toggle, .tab, button, .btn, [onclick] {
      min-height: 44px;
      min-width: 44px;
    }

    /* A2: Prevent zoom on input focus (16px min) */
    input, select, textarea {
      font-size: 16px !important;
    }

    /* A3: Tab bar scroll indicator */
    .tabs {
      position: relative;
    }
    .tabs::after {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 30px;
      background: linear-gradient(to right, transparent, rgba(30,58,95,0.9));
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tabs.has-scroll::after {
      opacity: 1;
    }

    /* A4: Better touch feedback */
    .toggle:active, .tab:active, button:active {
      transform: scale(0.95);
      opacity: 0.8;
    }

    /* A5: Smooth scrolling */
    .panel, .tabs, .section-content {
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }
  `;
  document.head.appendChild(style);

  // Check if tabs need scroll indicator
  function checkTabScroll() {
    const tabs = document.querySelector('.tabs');
    if (tabs) {
      tabs.classList.toggle('has-scroll', tabs.scrollWidth > tabs.clientWidth);
    }
  }
  window.addEventListener('resize', checkTabScroll);
  setTimeout(checkTabScroll, 500);
})();

// ========== B) NEW FEATURES ==========

// B1: Calculation History System
const CalcHistory = {
  key: 'wwtp_calc_history',
  max: 50,

  add(calcName, inputs, result) {
    const history = this.getAll();
    history.unshift({
      id: Date.now(),
      name: calcName,
      inputs: inputs,
      result: result,
      timestamp: new Date().toISOString()
    });
    if (history.length > this.max) history.pop();
    localStorage.setItem(this.key, JSON.stringify(history));
    this.updateWidget();
  },

  getAll() {
    try {
      return JSON.parse(localStorage.getItem(this.key)) || [];
    } catch { return []; }
  },

  clear() {
    localStorage.removeItem(this.key);
    this.updateWidget();
  },

  updateWidget() {
    const widget = document.getElementById('calcHistoryWidget');
    if (!widget) return;
    const history = this.getAll().slice(0, 5);
    if (history.length === 0) {
      widget.innerHTML = '<p style="opacity:0.6;font-size:12px">No calculations yet</p>';
      return;
    }
    widget.innerHTML = history.map(h => `
      <div style="padding:8px;background:rgba(255,255,255,0.05);border-radius:8px;margin-bottom:6px;font-size:12px">
        <div style="display:flex;justify-content:space-between">
          <strong>${h.name}</strong>
          <span style="opacity:0.6">${new Date(h.timestamp).toLocaleTimeString()}</span>
        </div>
        <div style="color:#4ade80;margin-top:4px">${h.result}</div>
      </div>
    `).join('');
  }
};

// B2: CSV Data Import
function importCSVData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const lines = evt.target.result.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        const data = lines[1].split(',').map(v => v.trim());

        // Map CSV columns to form fields
        const fieldMap = {
          'flow': ['flow', 'flowRate', 'influentFlow'],
          'bod': ['bod', 'bodIn', 'influentBOD'],
          'mlss': ['mlss', 'mlssConc'],
          'do': ['do', 'doLevel'],
          'ph': ['ph'],
          'tss': ['tss', 'tssIn'],
          'volume': ['volume', 'tankVolume', 'aerationVolume']
        };

        let imported = 0;
        headers.forEach((header, idx) => {
          for (const [key, aliases] of Object.entries(fieldMap)) {
            if (aliases.some(a => header.includes(a.toLowerCase()))) {
              const inputs = document.querySelectorAll(`input[id*="${key}" i]`);
              inputs.forEach(inp => {
                if (inp && data[idx]) {
                  inp.value = parseFloat(data[idx]) || data[idx];
                  imported++;
                }
              });
            }
          }
        });

        showToast(`‚úÖ Imported ${imported} values from CSV`, 'success');
      } catch (err) {
        showToast('‚ùå Error reading CSV file', 'error');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// B3: Quick Calculator Access Widget
function initRecentCalcsWidget() {
  const dashboard = document.getElementById('dashboard');
  if (!dashboard) return;

  // Check if widget already exists
  if (document.getElementById('calcHistoryWidget')) return;

  const widget = document.createElement('div');
  widget.className = 'section';
  widget.id = 'recentCalcsSection';
  widget.style.cssText = 'margin-top:16px';
  widget.innerHTML = `
    <div class="section-h" style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px">
      <span>üïê Recent Calculations</span>
      <button onclick="CalcHistory.clear();showToast('History cleared','info')" style="background:rgba(255,255,255,0.1);border:none;color:white;padding:4px 10px;border-radius:8px;font-size:11px;cursor:pointer">Clear</button>
    </div>
    <div class="section-content" id="calcHistoryWidget" style="padding:12px">
      <p style="opacity:0.6;font-size:12px;text-align:center">No calculations yet. Use any calculator to see history here.</p>
    </div>
  `;

  // Insert after KPI grid
  const kpiGrid = dashboard.querySelector('.kpi-grid');
  if (kpiGrid) {
    kpiGrid.after(widget);
  } else {
    dashboard.prepend(widget);
  }

  CalcHistory.updateWidget();
}

// ========== C) PERFORMANCE OPTIMIZATION ==========

// C1: Debounce calculations
function debounce(func, wait = 300) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}

// C2: DOM Query Cache
const DOMCache = {
  cache: new Map(),
  get(selector) {
    if (!this.cache.has(selector)) {
      this.cache.set(selector, document.querySelector(selector));
    }
    return this.cache.get(selector);
  },
  getAll(selector) {
    const key = 'all:' + selector;
    if (!this.cache.has(key)) {
      this.cache.set(key, document.querySelectorAll(selector));
    }
    return this.cache.get(key);
  },
  clear() {
    this.cache.clear();
  }
};

// C3: Lazy load heavy components
function lazyLoadCharts() {
  if (typeof Chart === 'undefined') {
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    document.head.appendChild(script);
  }
}

// ========== D) UI/UX POLISH ==========

// D1: Real-time input validation
function initInputValidation() {
  document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('input', function() {
      const val = parseFloat(this.value);
      const min = parseFloat(this.min);
      const max = parseFloat(this.max);

      this.style.borderColor = '';
      this.title = '';

      if (this.value && isNaN(val)) {
        this.style.borderColor = '#ef4444';
        this.title = 'Please enter a valid number';
      } else if (!isNaN(min) && val < min) {
        this.style.borderColor = '#f59e0b';
        this.title = `Value below minimum (${min})`;
      } else if (!isNaN(max) && val > max) {
        this.style.borderColor = '#f59e0b';
        this.title = `Value above maximum (${max})`;
      }
    });
  });
}

// D2: Better result highlighting
function highlightResult(elementId, value, unit = '') {
  const el = document.getElementById(elementId);
  if (!el) return;

  el.innerHTML = `<span class="result-value" style="font-size:1.5em;font-weight:bold;color:#4ade80">${value}</span> <span style="opacity:0.7">${unit}</span>`;
  el.style.animation = 'none';
  el.offsetHeight; // Trigger reflow
  el.style.animation = 'pulse 0.5s ease';
}

// D3: Add pulse animation
const pulseStyle = document.createElement('style');
pulseStyle.textContent = `
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  .result-highlight {
    animation: pulse 0.5s ease;
  }
`;
document.head.appendChild(pulseStyle);

// ========== E) AI GENIUS UPGRADES ==========

// E1: Conversation Export
function exportGeniusChat() {
  const chat = document.getElementById('genius-chat');
  if (!chat) return;

  const messages = chat.querySelectorAll('.genius-message');
  let text = 'WWTP Genius AI - Chat Export\n';
  text += 'Date: ' + new Date().toLocaleString() + '\n';
  text += '='.repeat(50) + '\n\n';

  messages.forEach(msg => {
    const isUser = msg.classList.contains('user');
    const content = msg.querySelector('.genius-content')?.textContent || '';
    text += (isUser ? 'YOU: ' : 'GENIUS: ') + content + '\n\n';
  });

  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'wwtp-genius-chat-' + Date.now() + '.txt';
  a.click();
  URL.revokeObjectURL(url);
  showToast('üíæ Chat exported!', 'success');
}

// E2: Add export button to Genius header
function upgradeGeniusUI() {
  setTimeout(() => {
    const header = document.querySelector('.genius-header > div:last-child');
    if (header && !document.getElementById('exportChatBtn')) {
      const btn = document.createElement('button');
      btn.id = 'exportChatBtn';
      btn.className = 'genius-btn';
      btn.innerHTML = 'üíæ';
      btn.title = 'Export Chat';
      btn.onclick = exportGeniusChat;
      header.insertBefore(btn, header.firstChild);
    }
  }, 2000);
}

// ========== INITIALIZE ALL ENHANCEMENTS ==========

document.addEventListener('DOMContentLoaded', function() {
  // Initialize all enhancements
  setTimeout(() => {
    initRecentCalcsWidget();
    initInputValidation();
    upgradeGeniusUI();
  }, 1000);
});

// Add CSV import button to dashboard
// CSV Import available via importCSVData() function - no floating button
// ============================================================================
// WWTP GENIUS AI ASSISTANT v1.0 - COMPLETE APP KNOWLEDGE
// ============================================================================

const WWTP_GENIUS = {
  version: '1.0.0',
  name: 'WWTP Genius',

  panels: {
    'dashboard': { name: 'Dashboard', icon: 'üìä', description: 'Overview of plant KPIs, AI recommendations, and alarm system', features: ['KPI cards', 'AI Recommendations', 'Alarm System'], keywords: ['home', 'overview', 'summary', 'kpi', 'status', 'alarms'] },
    'daily-ops': { name: 'Daily Operations', icon: 'üë∑', description: 'Daily rounds checklist, shift handoff, operator tools', features: ['Daily Checklist', 'Shift Notes', 'Operator Tools'], keywords: ['daily', 'rounds', 'checklist', 'shift', 'operations'] },
    'process-control': { name: 'Process Control', icon: '‚öôÔ∏è', description: 'All process calculators: F/M, SRT, SVI, loading rates', features: ['25+ Calculators', 'Process Summary', 'Optimization'], keywords: ['process', 'calculate', 'calculator', 'f/m', 'srt', 'svi', 'mcrt'] },
    'reactors': { name: 'Reactors', icon: 'üîÑ', description: 'SBR, MBR, and MBBR reactor calculators', features: ['SBR', 'MBR', 'MBBR', 'Master Settings'], keywords: ['sbr', 'mbr', 'mbbr', 'reactor', 'sequencing', 'membrane'] },
    'hydraulics': { name: 'Hydraulics', icon: 'üìê', description: 'Flow calculations, weir loading, head loss', features: ['Flow Calcs', 'Weir Loading', 'Head Loss', 'Pump Calcs'], keywords: ['hydraulic', 'flow', 'weir', 'pump', 'head', 'pipe'] },
    'aeration': { name: 'Aeration & Energy', icon: 'üí®', description: 'Oxygen requirements, blower sizing, energy tracking', features: ['O2 Requirements', 'Blower Calcs', 'Energy Tracking'], keywords: ['aeration', 'oxygen', 'do', 'blower', 'diffuser', 'energy'] },
    'chemicals': { name: 'Chemical Systems', icon: '‚öóÔ∏è', description: 'Chemical dosing, polymer, chlorine, pH adjustment', features: ['Dosing Calcs', 'Polymer', 'Chlorine/CT', 'pH'], keywords: ['chemical', 'dosing', 'polymer', 'chlorine', 'ferric', 'alum'] },
    'solids': { name: 'Solids Handling', icon: 'üóëÔ∏è', description: 'WAS, thickening, digestion, dewatering', features: ['WAS Calcs', 'Thickening', 'Digester', 'Dewatering'], keywords: ['solids', 'sludge', 'was', 'ras', 'digester', 'dewatering'] },
    'compliance': { name: 'Compliance & Lab', icon: 'üìã', description: 'Permit tracking, DMR data, TCEQ compliance', features: ['Permit Limits', 'DMR Tracking', 'Lab Data'], keywords: ['compliance', 'permit', 'dmr', 'tceq', 'epa', 'lab'] },
    'wizards': { name: 'Troubleshooting Wizards', icon: 'üß≠', description: '10 interactive diagnostic wizards', features: ['TSS', 'Bulking', 'Ammonia', 'Clarifier', 'Nutrients', 'Blowers'], keywords: ['wizard', 'troubleshoot', 'problem', 'diagnose', 'fix'] },
    'maintenance': { name: 'Maintenance', icon: 'üîß', description: 'Equipment tracking, PM schedules', features: ['Equipment', 'PM Schedule', 'Work Orders'], keywords: ['maintenance', 'equipment', 'pm', 'repair'] },
    'reports': { name: 'Reports', icon: 'üìë', description: 'Generate professional PDF reports', features: ['Daily', 'Process', 'Visit', 'Calculation Reports'], keywords: ['report', 'pdf', 'export', 'print', 'client'] },
    'profiles': { name: 'Plant Profiles', icon: 'üè≠', description: 'Save and load plant configurations', features: ['Save/Load Profiles', 'Client Management'], keywords: ['profile', 'plant', 'save', 'load', 'client'] },
    'business': { name: 'Business Tools', icon: 'üíº', description: 'Time tracking, invoicing, client portal', features: ['Time Tracker', 'Invoicing', 'Client Portal'], keywords: ['business', 'time', 'invoice', 'billing'] }
  },

  calculators: {
    'fm': { name: 'F/M Ratio', panel: 'process-control', formula: 'F/M = (BOD √ó Flow √ó 8.34) / (MLVSS √ó Volume √ó 8.34)', inputs: ['BOD (mg/L)', 'Flow (MGD)', 'MLVSS (mg/L)', 'Volume (MG)'], optimal: '0.2-0.5 conventional, 0.05-0.15 extended aeration', interpretation: { low: '<0.15 = Old sludge, good nitrification', optimal: '0.2-0.5 = Balanced system', high: '>0.5 = Young sludge, poor settling' }, troubleshooting: 'High F/M: increase MLSS or reduce WAS. Low F/M: increase WAS.' },
    'srt': { name: 'SRT (Solids Retention Time)', panel: 'process-control', formula: 'SRT = System Solids / Solids Wasted per Day', inputs: ['MLSS', 'Volume', 'WAS Flow', 'WAS TSS'], optimal: '5-15 days conventional, 20-30 extended, >10 for nitrification', interpretation: { low: '<5 days = Young sludge, lose nitrifiers', optimal: '8-15 days = Good balance', high: '>20 days = Old sludge, pin floc risk' }, troubleshooting: 'Increase WAS = decrease SRT' },
    'svi': { name: 'SVI (Sludge Volume Index)', panel: 'process-control', formula: 'SVI = (Settled Volume mL √ó 1000) / MLSS', inputs: ['30-min Settled Volume (mL/L)', 'MLSS (mg/L)'], optimal: '80-150 mL/g', interpretation: { excellent: '<80 = Pin floc risk', good: '80-150 = Good settling', bulking: '150-250 = Moderate bulking', severe: '>250 = Severe bulking' }, troubleshooting: 'High SVI: check DO, F/M, nutrients for filaments' },
    'mlss': { name: 'MLSS/MLVSS', panel: 'process-control', formula: 'MLVSS = MLSS √ó 0.7-0.85', optimal: '2000-4000 mg/L' },
    'detention': { name: 'Detention Time', panel: 'process-control', formula: 'DT (hrs) = Volume √ó 24 / Flow', optimal: '4-8 hrs aeration, 1.5-2.5 hrs clarifier' },
    'sor': { name: 'Surface Overflow Rate', panel: 'process-control', formula: 'SOR = Flow (GPD) / Area (sq ft)', optimal: '400-800 gpd/sf secondary, 800-1200 primary' },
    'weir': { name: 'Weir Overflow Rate', panel: 'hydraulics', formula: 'WOR = Flow (GPD) / Weir Length (ft)', optimal: '<10,000 gpd/ft secondary' },
    'ras': { name: 'RAS Rate', panel: 'process-control', formula: 'RAS % = MLSS / (RAS TSS - MLSS) √ó 100', optimal: '25-75% of influent' },
    'oxygen': { name: 'Oxygen Requirements', panel: 'aeration', formula: 'O2 = (BOD Removed √ó 1.5) + (NH3 √ó 4.6)', optimal: 'Varies by load' },
    'chlorine': { name: 'Chlorine Dosing', panel: 'chemicals', formula: 'Feed = (Flow √ó Dose √ó 8.34) / Strength', optimal: '2-10 mg/L typical dose' },
    'ct': { name: 'CT Disinfection', panel: 'chemicals', formula: 'CT = Cl‚ÇÇ Residual √ó Contact Time', optimal: '>15 mg¬∑min/L for bacteria' },
    'polymer': { name: 'Polymer Dosing', panel: 'chemicals', formula: 'lb/DT = Sludge √ó Solids% √ó Rate', optimal: '5-15 lb/DT typical' },
    'digester': { name: 'Digester Loading', panel: 'solids', formula: 'VLR = VS (lb/d) / Volume (CF)', optimal: '0.04-0.10 lb VS/CF/day' }
  },

  wizards: {
    'tss': { name: 'High TSS Troubleshooting', icon: 'üî¥', triggers: ['high tss', 'solids carryover', 'cloudy effluent', 'turbid'], causes: ['High blanket', 'Bulking', 'Hydraulic overload', 'Denitrification'] },
    'bulking': { name: 'Filamentous Bulking', icon: 'üü†', triggers: ['bulking', 'filamentous', 'poor settling', 'high svi'], causes: ['Low DO', 'Low F/M', 'Nutrient deficiency', 'Sulfide'] },
    'ammonia': { name: 'High Ammonia', icon: 'üü°', triggers: ['high ammonia', 'nh3', 'nitrification', 'not nitrifying'], causes: ['Low SRT', 'Low DO', 'Low pH', 'Cold temp', 'Toxicity'] },
    'clarifier': { name: 'Clarifier Issues', icon: 'üîµ', triggers: ['clarifier', 'settling', 'blanket', 'floating sludge'], causes: ['High blanket', 'Low RAS', 'Denitrification', 'Mechanical'] },
    'nutrients': { name: 'Nutrient Removal', icon: 'üü£', triggers: ['phosphorus', 'nitrogen', 'tn', 'tp', 'bnr'], causes: ['No anoxic zone', 'No anaerobic', 'Chemical dose', 'VFA'] },
    'blower': { name: 'Blower/Aeration', icon: 'üí®', triggers: ['blower', 'low do', 'air', 'diffuser'], causes: ['Clogged filter', 'Fouled diffusers', 'Mechanical', 'Undersized'] },
    'foaming': { name: 'Foaming', icon: 'ü´ß', triggers: ['foam', 'scum', 'nocardia', 'brown foam'], causes: ['Nocardia', 'High SRT', 'FOG', 'Surfactants'] },
    'odor': { name: 'Odor Control', icon: 'üëÉ', triggers: ['odor', 'smell', 'h2s', 'sulfide', 'rotten egg'], causes: ['Septicity', 'Low DO', 'Sulfide', 'Anaerobic'] },
    'ph': { name: 'pH Problems', icon: 'üß™', triggers: ['ph drop', 'ph swing', 'alkalinity'], causes: ['Nitrification', 'Industrial', 'Chemical feed', 'Low alk'] },
    'dewatering': { name: 'Dewatering', icon: 'üóúÔ∏è', triggers: ['dewatering', 'belt press', 'centrifuge', 'cake'], causes: ['Polymer dose', 'Conditioning', 'Sludge quality'] }
  },

  parameters: {
    'do': { name: 'Dissolved Oxygen', unit: 'mg/L', optimal: '2.0-4.0', low: '<1.5', high: '>5.0', importance: 'Critical for aerobic treatment. Low DO causes filaments.' },
    'mlss': { name: 'MLSS', unit: 'mg/L', optimal: '2000-4000', low: '<1500', high: '>5000', importance: 'Biomass concentration. Adjust via WAS.' },
    'ph': { name: 'pH', unit: 'SU', optimal: '6.5-8.5', importance: 'Affects bacteria. Nitrification needs >7.0' },
    'alkalinity': { name: 'Alkalinity', unit: 'mg/L CaCO3', optimal: '100-200', importance: 'Buffers pH. Nitrification consumes 7.1 lb/lb NH3.' },
    'temperature': { name: 'Temperature', unit: '¬∞C', optimal: '15-25', importance: 'Affects all biological rates.' },
    'svi': { name: 'SVI', unit: 'mL/g', optimal: '80-150', importance: 'Settling quality. >150 = bulking.' },
    'bod': { name: 'BOD', unit: 'mg/L', typical: '150-300 influent, <30 effluent', importance: 'Organic pollution measure.' },
    'tss': { name: 'TSS', unit: 'mg/L', typical: '150-350 influent, <30 effluent', importance: 'Particulate matter.' },
    'ammonia': { name: 'Ammonia-N', unit: 'mg/L', typical: '20-40 influent', importance: 'Needs SRT>10d, DO>2, pH>7, temp>10¬∞C.' }
  },

  technicalTerms: {
    'activated sludge': 'Biological treatment using aerated tanks with suspended microorganisms. Key: F/M, SRT, MLSS, DO.',
    'nitrification': 'Converts NH3 to NO3. Needs: SRT>10d, DO>2, pH>7, temp>10¬∞C. Consumes 7.1 lb alk/lb NH3.',
    'denitrification': 'Converts NO3 to N2 gas. Needs: anoxic zone, carbon source. Recovers 50% alkalinity.',
    'bnr': 'Biological Nutrient Removal - combines nitrification, denitrification, bio-P. Processes: A2O, Bardenpho, MLE.',
    'sbr': 'Sequencing Batch Reactor - fill-and-draw. Phases: Fill, React, Settle, Decant, Idle.',
    'mbr': 'Membrane Bioreactor - activated sludge + membranes. MLSS 8000-12000 mg/L. Excellent effluent.',
    'mbbr': 'Moving Bed Biofilm Reactor - plastic carriers for biofilm. Compact, load-resilient.'
  }
};

class WWTPGeniusAI {
  constructor() {
    this.history = [];
  }

  generateResponse(msg) {
    const q = msg.toLowerCase().trim();
    let response = '', action = null;

    // NAVIGATION
    for (const [id, panel] of Object.entries(WWTP_GENIUS.panels)) {
      if (panel.keywords.some(kw => q.includes(kw)) || q.includes(panel.name.toLowerCase())) {
        const isNav = ['go to', 'open', 'show', 'navigate', 'switch'].some(w => q.includes(w));
        response = `${panel.icon} **${panel.name}**\n\n${panel.description}\n\n**Features:** ${panel.features.join(', ')}`;
        if (isNav) { response += '\n\n_Opening now..._'; action = `switchPanel('${id}')`; }
        return this.respond(response, action);
      }
    }

    // CALCULATORS
    const calcWords = ['calculate', 'calc', 'compute', 'formula', 'what is my', 'how do i'];
    if (calcWords.some(w => q.includes(w))) {
      for (const [id, calc] of Object.entries(WWTP_GENIUS.calculators)) {
        if (q.includes(id) || q.includes(calc.name.toLowerCase())) {
          response = `üìä **${calc.name}**\n\n**Formula:** \`${calc.formula}\`\n\n**Inputs:** ${calc.inputs.join(', ')}\n\n**Optimal Range:** ${calc.optimal}`;
          if (calc.interpretation) {
            response += '\n\n**Interpretation:**\n';
            for (const [level, info] of Object.entries(calc.interpretation)) {
              response += `‚Ä¢ **${level}:** ${typeof info === 'string' ? info : info}\n`;
            }
          }
          if (calc.troubleshooting) response += `\n**Tip:** ${calc.troubleshooting}`;
          response += '\n\n_Opening calculator..._';
          action = `switchPanel('${calc.panel}'); showToast('Opening ${calc.name}', 'info');`;
          return this.respond(response, action);
        }
      }
      // List calculators
      response = 'üìä **Available Calculators:**\n\n';
      for (const calc of Object.values(WWTP_GENIUS.calculators)) {
        response += `‚Ä¢ **${calc.name}** - ${calc.optimal}\n`;
      }
      response += '\n_Ask me to calculate any of these!_';
      return this.respond(response, null);
    }

    // TROUBLESHOOTING
    const troubleWords = ['troubleshoot', 'problem', 'issue', 'wrong', 'help with', 'diagnose', 'fix', 'why'];
    if (troubleWords.some(w => q.includes(w))) {
      for (const [id, wiz] of Object.entries(WWTP_GENIUS.wizards)) {
        if (wiz.triggers.some(t => q.includes(t))) {
          response = `${wiz.icon} **${wiz.name}**\n\n**Common Causes:**\n`;
          wiz.causes.forEach(c => response += `‚Ä¢ ${c}\n`);
          response += '\n_Launching troubleshooting wizard..._';
          action = `switchPanel('wizards'); setTimeout(() => { if(typeof startWizard === 'function') startWizard('${id}'); }, 500);`;
          return this.respond(response, action);
        }
      }
      // List wizards
      response = 'üß≠ **Troubleshooting Wizards:**\n\n';
      for (const wiz of Object.values(WWTP_GENIUS.wizards)) {
        response += `${wiz.icon} **${wiz.name}**\n`;
      }
      response += '\n_Describe your problem and I\'ll guide you!_';
      return this.respond(response, null);
    }

    // PARAMETERS
    for (const [id, param] of Object.entries(WWTP_GENIUS.parameters)) {
      if (q.includes(id) || q.includes(param.name.toLowerCase())) {
        response = `üìã **${param.name}**\n\n**Unit:** ${param.unit}\n**Optimal:** ${param.optimal}`;
        if (param.low) response += `\n**Low:** ${param.low}`;
        if (param.high) response += `\n**High:** ${param.high}`;
        response += `\n\n**Importance:** ${param.importance}`;
        return this.respond(response, null);
      }
    }

    // TECHNICAL TERMS
    for (const [term, def] of Object.entries(WWTP_GENIUS.technicalTerms)) {
      if (q.includes(term)) {
        response = `üìò **${term.toUpperCase()}**\n\n${def}`;
        return this.respond(response, null);
      }
    }

    // GREETINGS
    if (/^(hi|hello|hey|good morning|good afternoon|good evening)/.test(q)) {
      response = `üëã **Hello! I'm WWTP Genius.**\n\nI know everything about this app:\n‚Ä¢ ${Object.keys(WWTP_GENIUS.calculators).length} calculators\n‚Ä¢ ${Object.keys(WWTP_GENIUS.wizards).length} troubleshooting wizards\n‚Ä¢ ${Object.keys(WWTP_GENIUS.panels).length} panels\n\n**Try asking:**\n‚Ä¢ "Calculate F/M ratio"\n‚Ä¢ "Help with high TSS"\n‚Ä¢ "What is SVI?"\n‚Ä¢ "Go to wizards"`;
      return this.respond(response, null);
    }

    // HELP
    if (q.includes('help') || q.includes('what can you do')) {
      response = `üß† **WWTP Genius Capabilities:**\n\n**üß≠ Navigate:** "Go to process control", "Open wizards"\n\n**üìä Calculate:** "Calculate SRT", "F/M formula"\n\n**üîß Troubleshoot:** "Help with bulking", "High ammonia"\n\n**üìö Explain:** "What is MLSS?", "Explain nitrification"\n\n**üìë Reports:** "Generate report", "Create PDF"`;
      return this.respond(response, null);
    }

    // CURRENT DATA
    if (q.includes('current') || q.includes('status') || q.includes('kpi')) {
      const vals = this.getCurrentValues();
      response = `üìä **Current Plant Status:**\n\n‚Ä¢ **Flow:** ${vals.flow} MGD\n‚Ä¢ **DO:** ${vals.do} mg/L\n‚Ä¢ **MLSS:** ${vals.mlss} mg/L\n‚Ä¢ **F/M:** ${vals.fm}\n‚Ä¢ **Energy:** ${vals.energy} kWh/MG`;
      return this.respond(response, null);
    }

    // DEFAULT
    response = `I'm not sure I understood. Try:\n\n‚Ä¢ **"Calculate [parameter]"**\n‚Ä¢ **"Troubleshoot [problem]"**\n‚Ä¢ **"Go to [section]"**\n‚Ä¢ **"What is [parameter]?"**\n‚Ä¢ **"Help"**`;
    return this.respond(response, null);
  }

  respond(text, action) {
    return text;
  }

  getCurrentValues() {
    return {
      flow: document.getElementById('kpi-flow')?.textContent || '3.50',
      do: document.getElementById('kpi-do')?.textContent || '2.1',
      mlss: document.getElementById('kpi-mlss')?.textContent || '2500',
      fm: document.getElementById('kpi-fm')?.textContent || '0.35',
      energy: document.getElementById('kpi-energy')?.textContent || '1850'
    };
  }
}

// ==================== UI ====================

function initGeniusAI() {
  window.geniusAI = new WWTPGeniusAI();

  // Remove old AI copilot if exists
  const old = document.getElementById('ai-copilot');
  if (old) old.remove();

  // Create Genius Panel
  const panel = document.createElement('div');
  panel.id = 'genius-panel';
  panel.innerHTML = `
    <div class="genius-header">
      <div class="genius-title"><span class="genius-avatar">üß†</span><div><div class="genius-name">WWTP Genius</div><div class="genius-status">‚óè Online</div></div></div>
      <div><button onclick="clearGeniusChat()" class="genius-btn">üóëÔ∏è</button><button onclick="toggleGeniusPanel()" class="genius-btn">‚úï</button></div>
    </div>
    <div class="genius-chat" id="genius-chat">
      <div class="genius-message bot"><div class="genius-content">üëã <b>Welcome! I'm WWTP Genius.</b><br><br>I know this entire app. Try:<div class="genius-suggestions"><button onclick="askGenius('Calculate F/M ratio')">üìä Calculate F/M</button><button onclick="askGenius('Help with high TSS')">üîß Troubleshoot TSS</button><button onclick="askGenius('What is SVI?')">üìö Explain SVI</button><button onclick="askGenius('Go to wizards')">üß≠ Open Wizards</button></div></div></div>
    </div>
    <div class="genius-input-area">
      <input type="text" id="genius-input" placeholder="Ask anything..." onkeypress="if(event.key==='Enter')sendGeniusMsg()">
      <button onclick="sendGeniusMsg()" class="genius-send">Send üöÄ</button>
    </div>
  `;
  document.body.appendChild(panel);

  // Styles (no floating button - using header button instead)
  const style = document.createElement('style');
  style.textContent = `
    #genius-panel{position:fixed;top:70px;right:25px;width:400px;max-width:calc(100vw - 50px);height:520px;max-height:calc(100vh - 100px);background:linear-gradient(180deg,#1e1b4b,#312e81);border-radius:20px;box-shadow:0 10px 50px rgba(0,0,0,0.5);z-index:10001;display:none;flex-direction:column;overflow:hidden;border:2px solid rgba(139,92,246,0.5)}
    #genius-panel.active{display:flex;animation:slideDown .3s}
    @keyframes slideDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
    .genius-header{background:linear-gradient(135deg,#8b5cf6,#6366f1);padding:14px 18px;display:flex;justify-content:space-between;align-items:center;color:#fff}
    .genius-title{display:flex;align-items:center;gap:10px}
    .genius-avatar{font-size:20px}
    .genius-name{font-size:16px;font-weight:700}
    .genius-status{font-size:11px;color:#a5f3fc}
    .genius-btn{background:rgba(255,255,255,0.2);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;margin-left:5px}
    .genius-btn:hover{background:rgba(255,255,255,0.3)}
    .genius-chat{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
    .genius-message{max-width:90%;animation:fadeIn .3s}
    .genius-message.user{align-self:flex-end}
    .genius-message.bot{align-self:flex-start}
    .genius-content{padding:12px 14px;border-radius:14px;font-size:13px;line-height:1.5}
    .genius-message.user .genius-content{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border-bottom-right-radius:4px}
    .genius-message.bot .genius-content{background:rgba(255,255,255,0.1);color:#e0e7ff;border-bottom-left-radius:4px}
    .genius-content b,.genius-content strong{color:#a5f3fc}
    .genius-content code{background:rgba(0,0,0,0.3);padding:2px 5px;border-radius:4px;color:#fde68a}
    .genius-suggestions{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .genius-suggestions button{background:rgba(139,92,246,0.3);border:1px solid rgba(139,92,246,0.5);color:#e0e7ff;padding:6px 10px;border-radius:16px;font-size:11px;cursor:pointer}
    .genius-suggestions button:hover{background:rgba(139,92,246,0.5)}
    .genius-input-area{padding:14px;background:rgba(0,0,0,0.2);display:flex;gap:8px}
    #genius-input{flex:1;padding:12px 14px;border:2px solid rgba(139,92,246,0.3);border-radius:20px;background:rgba(255,255,255,0.1);color:#fff;font-size:13px;outline:none}
    #genius-input:focus{border-color:#8b5cf6}
    #genius-input::placeholder{color:rgba(255,255,255,0.5)}
    .genius-send{background:linear-gradient(135deg,#8b5cf6,#6366f1);border:none;color:#fff;padding:0 16px;border-radius:20px;cursor:pointer;font-weight:600}
    .genius-send:hover{transform:scale(1.05)}
    #geniusBtn.active{box-shadow:0 0 15px #8b5cf6;transform:scale(1.1)}
    @media(max-width:768px){#genius-panel{right:10px;left:10px;width:auto;top:120px;height:calc(100vh - 140px)}}
  `;
  document.head.appendChild(style);

}

function toggleGeniusPanel() {
  const p = document.getElementById('genius-panel');
  const btn = document.getElementById('geniusBtn');
  p.classList.toggle('active');
  if (btn) btn.classList.toggle('active');
  if (p.classList.contains('active')) document.getElementById('genius-input').focus();
}

function askGenius(msg) {
  document.getElementById('genius-input').value = msg;
  sendGeniusMsg();
}

function sendGeniusMsg() {
  const input = document.getElementById('genius-input');
  const msg = input.value.trim();
  if (!msg) return;

  const chat = document.getElementById('genius-chat');

  // User message
  const userDiv = document.createElement('div');
  userDiv.className = 'genius-message user';
  userDiv.innerHTML = `<div class="genius-content">${escapeHtml(msg)}</div>`;
  chat.appendChild(userDiv);

  input.value = '';
  chat.scrollTop = chat.scrollHeight;

  // Bot response
  setTimeout(() => {
    const response = window.geniusAI.generateResponse(msg);
    const botDiv = document.createElement('div');
    botDiv.className = 'genius-message bot';
    botDiv.innerHTML = `<div class="genius-content">${formatGeniusResponse(response)}</div>`;
    chat.appendChild(botDiv);
    chat.scrollTop = chat.scrollHeight;
  }, 400);
}

function clearGeniusChat() {
  document.getElementById('genius-chat').innerHTML = '<div class="genius-message bot"><div class="genius-content">üóëÔ∏è Chat cleared. How can I help?</div></div>';
}

function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

function formatGeniusResponse(t) {
  return t.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>').replace(/`(.+?)`/g, '<code>$1</code>').replace(/\n/g, '<br>').replace(/‚Ä¢ /g, '&bull; ');
}

// Initialize on load
setTimeout(initGeniusAI, 1500);

</script>

</body>
</html>
